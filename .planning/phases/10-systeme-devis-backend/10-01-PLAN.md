---
phase: 10-systeme-devis-backend
plan: 1
type: execute
---

<objective>
Create database schema for quote management system with state machine support.

Purpose: Establish the foundational data model for quotes, quote items, and workflow state tracking. This enables the full quote lifecycle from draft to project conversion.
Output: Drizzle schema files, PostgreSQL migration, validated database structure for quotes system.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-systeme-devis-backend/DISCOVERY.md

**Existing schema patterns to follow:**
@packages/database/src/tenant/schema.ts

**Prior decisions affecting this phase:**
- Use Drizzle ORM with PostgreSQL (established in Phase 1)
- Database-per-tenant architecture (each organization has separate tenant DB)
- Follow invoice schema pattern for consistency (quotes mirror invoice financial structure)
- Calculated expiration pattern (no cron jobs - use timestamps + queries)

**From DISCOVERY.md:**
- State machine with 7 states: draft → sent → accepted/rejected/expired → converted_to_project
- Store `expiresAt` timestamp (not just validityDays) to lock expiration when quote sent
- Reuse invoice financial pattern (subtotal, taxRate, taxAmount, total)
- Quote items table separate from quotes (1-to-many relationship)
- Optional state_history table for audit trail (defer to future if not critical)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quotes and quote_items schema in Drizzle</name>
  <files>packages/database/src/tenant/schema.ts</files>
  <action>
Add two new tables to tenant schema following the pattern from DISCOVERY.md:

1. **quotes table:**
   - Fields: id, quoteNumber (unique), clientId (FK to clients)
   - Status & workflow: status (varchar 50, default "draft"), sentAt, respondedAt, expiresAt, validityDays (default 30)
   - Financial (mirror invoices): subtotal, taxRate (default 20.00), taxAmount, total (all decimal 10,2)
   - Quote-specific: terms (text), notes (text), internalNotes (text)
   - Conversion tracking: convertedToProjectId (nullable FK to projects), convertedAt
   - Timestamps: createdAt (defaultNow), updatedAt (defaultNow)
   - Use pgTable from drizzle-orm/pg-core
   - Add relations: belongsTo client, hasMany quote_items, belongsTo project (optional)

2. **quote_items table:**
   - Fields: id, quoteId (FK to quotes), description (varchar 500), quantity (decimal 10,2 default 1.00), unitPrice (decimal 10,2), amount (decimal 10,2)
   - Optional: serviceTemplateId (integer, nullable - for future templates)
   - Ordering: displayOrder (integer, default 0)
   - Timestamp: createdAt (defaultNow)
   - Add relations: belongsTo quote

Follow exact schema structure from DISCOVERY.md lines 48-104. Use existing invoice/invoiceItem pattern as reference. Export tables and relations at bottom of schema.ts file.
  </action>
  <verify>
1. TypeScript compiles without errors: `pnpm --filter database tsc --noEmit`
2. Schema exports quotes and quoteItems tables
3. Relations defined correctly (checked by reading schema.ts)
4. Status field allows all 7 states from state machine
  </verify>
  <done>
- quotes and quote_items tables added to packages/database/src/tenant/schema.ts
- All fields match DISCOVERY.md specification
- Relations defined (client, items, project)
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply Drizzle migration</name>
  <files>packages/database/drizzle/migrations/*.sql</files>
  <action>
Generate migration from new schema and apply to local database:

1. Generate migration:
   ```bash
   cd packages/database
   pnpm db:generate
   ```
   This creates new migration file in drizzle/migrations/ with CREATE TABLE statements for quotes and quote_items.

2. Review generated SQL to ensure:
   - Both tables created with correct columns
   - Foreign keys to clients and projects tables
   - Unique constraint on quoteNumber
   - Default values applied (status='draft', validityDays=30, taxRate=20.00)
   - Indexes on clientId, status, convertedToProjectId for query performance

3. Apply migration to local database:
   ```bash
   DATABASE_URL="postgresql://postgres:password@localhost:5432/rsm_master" pnpm db:migrate
   ```

4. Verify migration applied:
   ```bash
   psql -U postgres -d rsm_master -c "\dt quotes"
   psql -U postgres -d rsm_master -c "\d quotes"
   psql -U postgres -d rsm_master -c "\d quote_items"
   ```

Note: Migration applies to master DB for metadata, but actual quote tables exist in tenant databases (tenant_1, tenant_2, etc.). Tenant provisioning will auto-apply migrations when new organizations created.
  </action>
  <verify>
1. Migration file exists in drizzle/migrations/ with timestamp
2. Migration SQL contains CREATE TABLE quotes and CREATE TABLE quote_items
3. Local database has quotes and quote_items tables: `psql -U postgres -d rsm_master -c "\dt" | grep quotes`
4. Schema validation passes: `pnpm --filter database db:check`
  </verify>
  <done>
- Migration generated successfully
- SQL reviewed and correct
- Migration applied to local database
- Tables visible in PostgreSQL
- No errors in migration process
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compilation succeeds: `pnpm --filter database tsc --noEmit`
- [ ] Migration file exists and contains both tables
- [ ] Local database has quotes and quote_items tables
- [ ] Schema validation passes: `pnpm --filter database db:check`
- [ ] No console errors or warnings
</verification>

<success_criteria>
- quotes and quote_items tables defined in Drizzle schema
- Migration generated and applied successfully
- Database structure matches DISCOVERY.md specification
- All TypeScript types inferred correctly
- Schema ready for tRPC router implementation (Plan 2)
</success_criteria>

<output>
After completion, create `.planning/phases/10-systeme-devis-backend/10-01-SUMMARY.md`:

# Phase 10 Plan 1: Database Schema & Migrations Summary

**Database schema created for quote management system with state machine support**

## Accomplishments

- Created quotes table with 7-state workflow (draft/sent/accepted/rejected/expired/cancelled/converted_to_project)
- Created quote_items table for line item management
- Generated and applied Drizzle migration
- Established quote-to-project conversion tracking (convertedToProjectId FK)
- Followed invoice schema pattern for financial consistency

## Files Created/Modified

- `packages/database/src/tenant/schema.ts` - Added quotes and quote_items tables with relations
- `packages/database/drizzle/migrations/XXXX_*.sql` - Migration for quote tables

## Decisions Made

[Document any deviations from DISCOVERY.md, optional field choices, or schema refinements]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 2 (10-02-PLAN.md): tRPC Router & State Machine implementation
</output>
