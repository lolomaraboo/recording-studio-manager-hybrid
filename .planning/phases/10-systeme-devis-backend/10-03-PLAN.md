---
phase: 10-systeme-devis-backend
plan: 3
type: execute
---

<objective>
Implement PDF generation service for quotes using PDFKit and comprehensive E2E testing for quote lifecycle.

Purpose: Enable quote PDF generation for client delivery and validate entire quote system with automated tests. This completes the backend implementation before frontend (Phase 11).
Output: PDF generation service, generatePDF tRPC endpoint, E2E test suite covering full quote workflow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-systeme-devis-backend/DISCOVERY.md
@.planning/phases/10-systeme-devis-backend/10-01-SUMMARY.md
@.planning/phases/10-systeme-devis-backend/10-02-SUMMARY.md

**Existing service patterns to follow:**
@packages/server/src/utils/vcard-service.ts
@packages/server/src/utils/excel-service.ts

**Existing test patterns:**
@e2e/crud/clients-enriched.spec.ts
@packages/database/__tests__/connection.test.ts

**Prior decisions affecting this phase:**
- PDFKit chosen over Puppeteer/react-pdf (lightweight, server-side, TypeScript support)
- PDF structure mirrors invoice template (header, client info, line items, totals, terms)
- Return PDF as Buffer for flexibility (save to file, email attachment, HTTP response)
- Follow invoice generator patterns from @zed378/invoice-pdfkit (DISCOVERY.md references)

**From DISCOVERY.md:**
- PDFKit score 8/10 (mature, TypeScript types, no browser overhead)
- Template layout: Organization info header, client details, items table, subtotal/tax/total, terms/notes
- No need to store PDF in database (regenerate on-demand from quote data)
- Testing should cover: create → send → accept → convert → verify project
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PDFKit and create quote PDF generation service</name>
  <files>packages/server/package.json, packages/server/src/utils/quote-pdf-service.ts</files>
  <action>
1. **Install dependencies:**
   ```bash
   cd packages/server
   pnpm add pdfkit
   pnpm add -D @types/pdfkit
   ```

2. **Create PDF service** `packages/server/src/utils/quote-pdf-service.ts`:

```typescript
import PDFDocument from 'pdfkit';
import { getTenantDb } from '@rsm/database/connection';
import { quotes } from '@rsm/database/tenant';
import { eq } from 'drizzle-orm';

export const generateQuotePDF = async (quoteId: number, organizationId: number): Promise<Buffer> => {
  const tenantDb = await getTenantDb(organizationId);

  // Fetch quote with items and client
  const quote = await tenantDb.query.quotes.findFirst({
    where: eq(quotes.id, quoteId),
    with: { items: true, client: true }
  });

  if (!quote) {
    throw new Error('Quote not found');
  }

  return new Promise((resolve, reject) => {
    const doc = new PDFDocument({ margin: 50 });
    const buffers: Buffer[] = [];

    doc.on('data', buffers.push.bind(buffers));
    doc.on('end', () => resolve(Buffer.concat(buffers)));
    doc.on('error', reject);

    // Header
    doc.fontSize(20).text('QUOTE', { align: 'center' });
    doc.moveDown();
    doc.fontSize(10).text(`Quote Number: ${quote.quoteNumber}`);
    doc.text(`Date: ${quote.createdAt.toLocaleDateString()}`);
    if (quote.expiresAt) {
      doc.text(`Valid Until: ${quote.expiresAt.toLocaleDateString()}`);
    }
    doc.moveDown();

    // Client info
    doc.fontSize(12).text('Bill To:', { underline: true });
    doc.fontSize(10).text(quote.client.name);
    if (quote.client.email) doc.text(quote.client.email);
    if (quote.client.phone) doc.text(quote.client.phone);
    doc.moveDown();

    // Items table
    const tableTop = doc.y;
    doc.fontSize(10).text('Description', 50, tableTop, { width: 250 });
    doc.text('Qty', 300, tableTop, { width: 50 });
    doc.text('Price', 350, tableTop, { width: 75, align: 'right' });
    doc.text('Amount', 425, tableTop, { width: 75, align: 'right' });
    doc.moveTo(50, tableTop + 15).lineTo(500, tableTop + 15).stroke();

    let position = tableTop + 20;
    quote.items.forEach((item) => {
      doc.text(item.description, 50, position, { width: 250 });
      doc.text(item.quantity.toString(), 300, position, { width: 50 });
      doc.text(`€${item.unitPrice}`, 350, position, { width: 75, align: 'right' });
      doc.text(`€${item.amount}`, 425, position, { width: 75, align: 'right' });
      position += 20;
    });

    // Totals
    doc.moveDown();
    position = doc.y;
    doc.text('Subtotal:', 350, position, { width: 75, align: 'right' });
    doc.text(`€${quote.subtotal}`, 425, position, { width: 75, align: 'right' });
    position += 15;
    doc.text(`Tax (${quote.taxRate}%):`, 350, position, { width: 75, align: 'right' });
    doc.text(`€${quote.taxAmount}`, 425, position, { width: 75, align: 'right' });
    position += 15;
    doc.fontSize(12).text('Total:', 350, position, { width: 75, align: 'right' });
    doc.text(`€${quote.total}`, 425, position, { width: 75, align: 'right' });

    // Terms & notes
    if (quote.terms) {
      doc.moveDown();
      doc.fontSize(10).text('Terms & Conditions:', { underline: true });
      doc.text(quote.terms);
    }

    if (quote.notes) {
      doc.moveDown();
      doc.text('Notes:', { underline: true });
      doc.text(quote.notes);
    }

    doc.end();
  });
};
```

Follow pattern from DISCOVERY.md PDF examples (lines 206-216). Keep layout simple and professional. Use EUR currency symbol (€) for consistency with invoices.
  </action>
  <verify>
1. Dependencies installed: `pnpm list pdfkit @types/pdfkit` shows versions
2. TypeScript compiles: `pnpm --filter server tsc --noEmit`
3. Service exports generateQuotePDF function
4. Test PDF generation: Create test quote, call service, verify Buffer returned
5. PDF content readable: Save buffer to test.pdf file, open and verify structure
  </verify>
  <done>
- pdfkit and @types/pdfkit installed
- quote-pdf-service.ts created with generateQuotePDF function
- PDF template includes: header, client info, items table, totals, terms
- Returns Buffer for flexible usage
- TypeScript compilation successful
  </done>
</task>

<task type="auto">
  <name>Task 2: Add generatePDF endpoint to quotes router</name>
  <files>packages/server/src/routers/quotes.ts</files>
  <action>
Add PDF generation endpoint to quotes router:

```typescript
import { generateQuotePDF } from '../utils/quote-pdf-service';

// In quotesRouter:
generatePDF: protectedProcedure
  .input(z.object({ quoteId: z.number() }))
  .mutation(async ({ ctx, input }) => {
    const tenantDb = await ctx.getTenantDb();

    // Verify quote exists and user has access
    const quote = await tenantDb.query.quotes.findFirst({
      where: eq(quotes.id, input.quoteId)
    });

    if (!quote) {
      throw new TRPCError({ code: 'NOT_FOUND', message: 'Quote not found' });
    }

    // Generate PDF
    const pdfBuffer = await generateQuotePDF(input.quoteId, ctx.organizationId);

    // Return as base64 for transport over tRPC
    return {
      filename: `quote-${quote.quoteNumber}.pdf`,
      data: pdfBuffer.toString('base64'),
      mimeType: 'application/pdf'
    };
  })
```

Frontend can decode base64 and create download link or display in iframe. Alternative: Return URL if PDFs saved to file storage (defer to Phase 11).
  </action>
  <verify>
1. Endpoint added to quotes router
2. TypeScript compiles: `pnpm --filter server tsc --noEmit`
3. Test endpoint: Call generatePDF for test quote, verify base64 returned
4. Decode base64: Convert back to Buffer, save as PDF, verify readable
5. Security check: Verify endpoint only returns quotes from user's organization (tenant isolation)
  </verify>
  <done>
- generatePDF endpoint added to quotes router
- Returns base64-encoded PDF with filename and mimeType
- Security validated (tenant isolation)
- PDF generation working end-to-end
  </done>
</task>

<task type="auto">
  <name>Task 3: Write E2E tests for complete quote lifecycle</name>
  <files>e2e/crud/quotes.spec.ts</files>
  <action>
Create Playwright E2E test covering full quote workflow:

```typescript
import { test, expect } from '@playwright/test';
import { trpc } from '../helpers/trpc-client'; // Use existing tRPC test client pattern

test.describe('Quotes Management', () => {
  test('complete quote lifecycle: create → send → accept → convert to project', async ({ page }) => {
    // 1. Create quote with 2 items
    const quote = await trpc.quotes.create.mutate({
      clientId: 1, // Assumes test client exists
      validityDays: 30,
      taxRate: '20.00',
      notes: 'Test quote for E2E',
      items: [
        { description: 'Recording Session (4 hours)', quantity: '4.00', unitPrice: '75.00', amount: '300.00' },
        { description: 'Mixing Service', quantity: '1.00', unitPrice: '200.00', amount: '200.00' }
      ]
    });

    expect(quote.status).toBe('draft');
    expect(quote.quoteNumber).toMatch(/^Q-\d{4}-\d{4}$/);
    expect(quote.total).toBe('600.00'); // 500 + 20% tax

    // 2. Send quote (draft → sent)
    const sentQuote = await trpc.quotes.send.mutate({ quoteId: quote.id });
    expect(sentQuote.status).toBe('sent');
    expect(sentQuote.sentAt).toBeTruthy();
    expect(sentQuote.expiresAt).toBeTruthy();

    // 3. Accept quote (sent → accepted)
    const acceptedQuote = await trpc.quotes.accept.mutate({ quoteId: quote.id });
    expect(acceptedQuote.status).toBe('accepted');
    expect(acceptedQuote.respondedAt).toBeTruthy();

    // 4. Convert to project
    const { project, quote: convertedQuote } = await trpc.quotes.convertToProject.mutate({
      quoteId: quote.id
    });

    expect(convertedQuote.status).toBe('converted_to_project');
    expect(convertedQuote.convertedToProjectId).toBe(project.id);
    expect(project.budget).toBe(quote.total);
    expect(project.clientId).toBe(quote.clientId);
    expect(project.status).toBe('pre_production');

    // 5. Verify project exists
    const fetchedProject = await trpc.projects.get.query({ projectId: project.id });
    expect(fetchedProject.name).toContain(quote.quoteNumber);
  });

  test('state machine validation: prevent invalid transitions', async () => {
    const quote = await trpc.quotes.create.mutate({ /* ... */ });

    // Cannot accept draft quote
    await expect(
      trpc.quotes.accept.mutate({ quoteId: quote.id })
    ).rejects.toThrow('Only sent quotes can be accepted');

    // Cannot convert non-accepted quote
    await expect(
      trpc.quotes.convertToProject.mutate({ quoteId: quote.id })
    ).rejects.toThrow('Only accepted quotes can be converted');
  });

  test('PDF generation', async () => {
    const quote = await trpc.quotes.create.mutate({ /* ... */ });

    const pdf = await trpc.quotes.generatePDF.mutate({ quoteId: quote.id });

    expect(pdf.filename).toBe(`quote-${quote.quoteNumber}.pdf`);
    expect(pdf.mimeType).toBe('application/pdf');
    expect(pdf.data).toBeTruthy(); // base64 string

    // Verify PDF is valid base64
    const buffer = Buffer.from(pdf.data, 'base64');
    expect(buffer.toString('utf-8', 0, 4)).toBe('%PDF'); // PDF magic number
  });
});
```

Follow existing E2E test pattern from clients-enriched.spec.ts. Use test database with known test data (client ID 1). Clean up created quotes after tests.
  </action>
  <verify>
1. Tests pass: `npx playwright test e2e/crud/quotes.spec.ts`
2. All 3 test cases pass: full lifecycle, state validation, PDF generation
3. Test database cleaned up after execution
4. Code coverage includes: all endpoints, state transitions, conversion, PDF generation
5. No flaky tests (run 3 times, all pass)
  </verify>
  <done>
- E2E test suite created in e2e/crud/quotes.spec.ts
- 3 test cases covering: full workflow, state machine, PDF generation
- All tests passing
- Test data cleanup implemented
- Quote system fully validated
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] PDFKit installed and TypeScript types available
- [ ] PDF service generates valid PDFs (magic number %PDF verified)
- [ ] generatePDF endpoint returns base64-encoded PDF
- [ ] E2E tests pass: `npx playwright test e2e/crud/quotes.spec.ts`
- [ ] All 3 test cases passing (lifecycle, validation, PDF)
- [ ] No console errors or warnings
- [ ] TypeScript compilation succeeds: `pnpm check`
</verification>

<success_criteria>
- PDF generation service implemented using PDFKit
- Quote PDFs include all required sections (header, items, totals, terms)
- generatePDF endpoint returns base64-encoded PDF for transport
- E2E test suite covers complete quote lifecycle
- State machine validation tested (invalid transitions rejected)
- PDF generation validated (base64, magic number check)
- Phase 10 complete - backend ready for Phase 11 (Frontend UI)
</success_criteria>

<output>
After completion, create `.planning/phases/10-systeme-devis-backend/10-03-SUMMARY.md`:

# Phase 10 Plan 3: PDF Generation & Testing Summary

**PDF generation service and comprehensive E2E testing for quote system**

## Accomplishments

- Installed PDFKit and created quote PDF generation service
- Implemented professional PDF template (header, client info, items table, totals, terms)
- Added generatePDF tRPC endpoint returning base64-encoded PDFs
- Created E2E test suite with 3 comprehensive test cases
- Validated full quote lifecycle: create → send → accept → convert to project
- Tested state machine transitions and invalid transition prevention
- Verified PDF generation and base64 encoding

## Files Created/Modified

- `packages/server/package.json` - Added pdfkit and @types/pdfkit dependencies
- `packages/server/src/utils/quote-pdf-service.ts` - PDF generation service using PDFKit
- `packages/server/src/routers/quotes.ts` - Added generatePDF endpoint
- `e2e/crud/quotes.spec.ts` - Comprehensive E2E test suite for quotes

## Decisions Made

- PDF returned as base64 for tRPC transport (frontend decodes for download/display)
- PDFs generated on-demand (not stored in database or file storage)
- EUR currency symbol (€) for consistency with invoices
- Test database uses client ID 1 for predictable test data

## Issues Encountered

[Problems and resolutions, or "None"]

## Phase 10 Complete

**Backend quote system fully implemented:**
- ✅ Database schema (quotes, quote_items)
- ✅ tRPC router (CRUD, state machine, conversion)
- ✅ PDF generation service
- ✅ E2E testing (full lifecycle validated)

**Ready for Phase 11:** Frontend UI implementation (quote creation form, quote list, PDF preview, client acceptance flow)
</output>
