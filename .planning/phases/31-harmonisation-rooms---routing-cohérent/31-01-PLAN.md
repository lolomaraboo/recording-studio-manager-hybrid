---
phase: 31-harmonisation-rooms---routing-cohérent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/pages/RoomCreate.tsx
  - packages/client/src/components/RoomEditForm.tsx
  - packages/client/src/pages/Rooms.tsx
  - packages/client/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /rooms/new from Rooms list page"
    - "User can create room via dedicated page (not Dialog modal)"
    - "RoomCreate page uses accordion-based form (consistent with 11 other resources)"
    - "Form state persists in localStorage across sessions"
    - "Alt+Click toggles all accordions (power-user feature)"
    - "Creating room returns to /rooms list page with success toast"
  artifacts:
    - path: "packages/client/src/pages/RoomCreate.tsx"
      provides: "Dedicated create page for rooms"
      min_lines: 100
    - path: "packages/client/src/components/RoomEditForm.tsx"
      provides: "Accordion-based form component (4 sections)"
      min_lines: 280
      exports: ["RoomEditForm"]
    - path: "packages/client/src/App.tsx"
      provides: "Route registration for /rooms/new"
      contains: 'path="rooms/new"'
    - path: "packages/client/src/pages/Rooms.tsx"
      provides: "Updated button navigation (Link not onClick)"
      pattern: 'Button asChild.*Link to="/rooms/new"'
  key_links:
    - from: "packages/client/src/pages/Rooms.tsx"
      to: "/rooms/new"
      via: "Button with asChild + Link"
      pattern: '<Button asChild>.*<Link to="/rooms/new">'
    - from: "packages/client/src/pages/RoomCreate.tsx"
      to: "RoomEditForm"
      via: "Import and render"
      pattern: 'import.*RoomEditForm.*from.*@/components/RoomEditForm'
    - from: "packages/client/src/components/RoomEditForm.tsx"
      to: "localStorage"
      via: "Accordion state persistence"
      pattern: "localStorage\\.(get|set)Item\\('roomEditAccordions'"
---

<objective>
Apply the established harmonization pattern (Phases 22-29) to Rooms by creating a dedicated `/rooms/new` page with accordion-based form, replacing the existing inline form in RoomCreate.tsx.

Purpose: Achieve routing consistency across all 12 resources (clients, sessions, invoices, equipment, rooms, projects, quotes, contracts, expenses, talents, tracks, services). This enables bookmarkable URLs, shareable links, and eliminates cognitive friction from mixed interaction patterns.

Output: RoomCreate.tsx page (110 lines), RoomEditForm component (300 lines), updated Rooms.tsx button navigation (if needed), route already exists in App.tsx. Zero new dependencies—all patterns copied from TalentEditForm (Phase 28).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern references (established in Phases 26-28)
@packages/client/src/pages/TalentCreate.tsx
@packages/client/src/components/TalentEditForm.tsx

# Current implementation (inline form to refactor)
@packages/client/src/pages/RoomCreate.tsx
@packages/client/src/pages/Rooms.tsx

# Routing structure
@packages/client/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RoomEditForm accordion component</name>
  <files>packages/client/src/components/RoomEditForm.tsx</files>
  <action>
Create accordion-based form component at packages/client/src/components/RoomEditForm.tsx.

**Copy TalentEditForm.tsx structure (lines 1-299) with adaptations:**

1. **Imports:** Same as TalentEditForm (useState, useEffect, Card, Accordion components, icons)

2. **Interface:**
```typescript
interface RoomEditFormProps {
  formData: any;
  setFormData: (data: any) => void;
}
```

3. **Accordion state with localStorage (lines 36-52 from TalentEditForm):**
   - Key: 'roomEditAccordions' (unique to rooms)
   - Default open: ["identite", "tarification", "configuration", "details"] (4 accordions)
   - useEffect to save state on change

4. **Alt+Click toggle handler (lines 54-69 from TalentEditForm):**
   - allAccordions = ["identite", "tarification", "configuration", "details"]
   - Toggle all open/closed logic

5. **Accordion structure (4 sections):**

**Accordion 1: Identité de la Salle**
- Icon: Building
- Fields (3):
  - name: Input (maxLength 255, required asterisk)
  - type: Select (recording/mixing/mastering/rehearsal/live, required asterisk)
  - description: Textarea (rows 3, optional)

**Accordion 2: Tarification**
- Icon: DollarSign
- Fields (3):
  - hourlyRate: Input type="number" step="0.01" min="0" (label: "Tarif horaire (€)")
  - halfDayRate: Input type="number" step="0.01" min="0" (label: "Demi-journée (€)")
  - fullDayRate: Input type="number" step="0.01" min="0" (label: "Journée complète (€)")

**Accordion 3: Configuration**
- Icon: Settings
- Fields (5):
  - capacity: Input type="number" min="1" (label: "Capacité (personnes)")
  - size: Input type="number" step="0.01" min="0" (label: "Superficie (m²)")
  - Checkboxes (3): hasIsolationBooth, hasLiveRoom, hasControlRoom
    - Use <input type="checkbox"> with labels
    - Labels: "Cabine d'isolation", "Live room", "Régie"

**Accordion 4: Détails Additionnels**
- Icon: FileText
- Fields (4):
  - equipmentList: Textarea (rows 2, label: "Liste d'équipements (JSON)")
  - color: Input (optional, label: "Couleur")
  - imageUrl: Input type="url" (optional, label: "URL de l'image")
  - Switches (2): isActive, isAvailableForBooking
    - Use shadcn Switch component
    - Labels: "Salle active", "Disponible à la réservation"

6. **Card wrapper:** Each AccordionItem wrapped in <Card> for visual consistency

7. **Trigger onClick:** Pass handleAccordionTriggerClick to enable Alt+Click

**Pattern source:** TalentEditForm.tsx lines 1-299 (Phase 28), adapted to 4 accordions for room fields

**Expected output:** ~300 lines (more than TalentEditForm due to checkboxes + switches)

**Field mapping reference from RoomCreate.tsx (lines 28-45):**
- All field IDs, labels, placeholders already defined
- Copy exact validation patterns (required asterisk on name, type)
  </action>
  <verify>
File exists at packages/client/src/components/RoomEditForm.tsx with:
- Export: export function RoomEditForm
- localStorage key: 'roomEditAccordions'
- 4 accordion sections: "identite", "tarification", "configuration", "details"
- Accordion 1 contains: name Input, type Select, description Textarea
- Accordion 2 contains: hourlyRate, halfDayRate, fullDayRate Inputs
- Accordion 3 contains: capacity, size Inputs + 3 checkboxes
- Accordion 4 contains: equipmentList Textarea + color/imageUrl Inputs + 2 Switches
- Alt+Click handler implemented (allAccordions array)
- Card wrapper on each AccordionItem

Run: grep -E "(roomEditAccordions|AccordionItem value=\"identite\"|AccordionItem value=\"tarification\"|AccordionItem value=\"configuration\"|AccordionItem value=\"details\")" packages/client/src/components/RoomEditForm.tsx
Expected: 5+ matches (localStorage key + 4 accordion values)
  </verify>
  <done>
RoomEditForm.tsx exists with 4-accordion structure (Identity + Pricing + Configuration + Details). All 14 room fields present. localStorage persistence configured. Alt+Click toggle handler implemented. Component exports RoomEditForm function. TypeScript compiles with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update RoomCreate.tsx to use accordion component</name>
  <files>packages/client/src/pages/RoomCreate.tsx</files>
  <action>
Refactor RoomCreate.tsx to use RoomEditForm accordion component instead of inline form.

**Step 1: Update imports (lines 1-11):**
```typescript
// ADD this import after line 10:
import { RoomEditForm } from "@/components/RoomEditForm";

// REMOVE unused imports (after refactor):
// - Card, CardContent, CardDescription, CardHeader, CardTitle
// - Input, Label, Textarea, Select (moved to RoomEditForm)
```

**Step 2: Keep existing state and mutation (lines 16-46):**
- Keep createMutation exactly as is (lines 17-25)
- Keep formData state exactly as is (lines 28-45)
- Keep handleSubmit exactly as is (lines 47-75)

**Step 3: Simplify JSX (lines 77-299):**

Replace entire form body (lines 98-295) with:

```typescript
return (
  <div className="container pt-2 pb-4 px-2">
    <div className="space-y-2">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Link to="/rooms">
            <Button variant="ghost" size="icon">
              <ArrowLeft className="h-5 w-5" />
            </Button>
          </Link>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <Building className="h-8 w-8 text-primary" />
              Nouvelle Salle
            </h1>
          </div>
        </div>
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit}>
        <RoomEditForm
          formData={formData}
          setFormData={setFormData}
        />

        {/* Submit button */}
        <div className="mt-4 flex justify-end gap-2">
          <Button type="button" variant="outline" asChild>
            <Link to="/rooms">
              <X className="h-4 w-4 mr-2" />
              Annuler
            </Link>
          </Button>
          <Button type="submit" disabled={createMutation.isPending}>
            <Save className="h-4 w-4 mr-2" />
            {createMutation.isPending ? "Création..." : "Créer la salle"}
          </Button>
        </div>
      </form>
    </div>
  </div>
);
```

**Step 4: Add missing X icon import:**
```typescript
// Line 10 - add X to imports:
import { ArrowLeft, Save, Building, X } from "lucide-react";
```

**Pattern reference:** TalentCreate.tsx (Phase 28) - same structure, component-based form

**Expected output:** Reduce from 300 lines to ~110 lines (same as TalentCreate)
  </action>
  <verify>
RoomCreate.tsx changes verified:
1. Import added: import { RoomEditForm } from "@/components/RoomEditForm"
2. Import added: X icon from lucide-react
3. Inline form removed (lines 98-295 replaced with RoomEditForm component)
4. Header structure preserved (lines 77-95)
5. handleSubmit and formData state preserved
6. Submit buttons match TalentCreate pattern (Cancel with X icon, Submit with Save icon)
7. File reduced to ~110 lines

Run: grep "RoomEditForm" packages/client/src/pages/RoomCreate.tsx
Expected: 2 matches (import + component usage)

Run: wc -l packages/client/src/pages/RoomCreate.tsx
Expected: ~105-115 lines (down from 300)
  </verify>
  <done>
RoomCreate.tsx updated: Inline form replaced with RoomEditForm accordion component. File reduced from 300 lines to ~110 lines. Header and submit logic preserved. TypeScript compiles successfully. Navigation to /rooms/new already works (route exists).
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Rooms.tsx button navigation (ensure Link pattern)</name>
  <files>packages/client/src/pages/Rooms.tsx</files>
  <action>
Verify Rooms.tsx button uses Link navigation pattern.

**IMPORTANT:** RoomCreate.tsx already exists as a dedicated page (not Dialog modal). This task verifies that Rooms.tsx button uses the correct Link pattern.

**Step 1: Check button navigation (likely around line 50-100):**

Expected pattern:
```typescript
<Button asChild>
  <Link to="/rooms/new">
    <Plus className="mr-2 h-4 w-4" />
    Nouvelle salle
  </Link>
</Button>
```

**Step 2: If button uses onClick instead:**

Find code like:
```typescript
<Button onClick={() => navigate("/rooms/new")}>
```

Replace with:
```typescript
<Button asChild>
  <Link to="/rooms/new">
    <Plus className="mr-2 h-4 w-4" />
    Nouvelle salle
  </Link>
</Button>
```

**Step 3: Ensure Link is imported:**
Verify imports include: `import { Link } from "react-router-dom";`

**Pattern reference:** Services.tsx (Phase 29), Talents.tsx (Phase 28) - both use asChild + Link

**Note:** Rooms.tsx may already have Dialog code for edit/delete operations - DO NOT touch those. Only verify CREATE button navigation.
  </action>
  <verify>
Rooms.tsx verification:
1. Button for "Nouvelle salle" uses asChild + Link pattern
2. Link imports from react-router-dom
3. No Dialog modal for CREATE flow (edit/delete Dialogs OK to keep)

Run: grep -A 3 'to="/rooms/new"' packages/client/src/pages/Rooms.tsx
Expected: Button asChild pattern visible

Run: grep 'import.*Link.*react-router-dom' packages/client/src/pages/Rooms.tsx
Expected: 1 match
  </verify>
  <done>
Rooms.tsx verified: "Nouvelle salle" button uses asChild + Link navigation pattern. No Dialog modal for create flow. Link properly imported. Navigation to /rooms/new works correctly.
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify /rooms/new route exists in App.tsx</name>
  <files>packages/client/src/App.tsx</files>
  <action>
Verify route for /rooms/new exists in App.tsx.

**IMPORTANT:** RoomCreate.tsx already exists, so route likely already registered. This task verifies route exists and is correctly configured.

**Step 1: Check for RoomCreate import:**
Expected: `import RoomCreate from './pages/RoomCreate';`

**Step 2: Check for /rooms/new route:**
Expected pattern (near line 150-170):
```typescript
<Route path="rooms" element={<Rooms />} />
<Route path="rooms/new" element={<RoomCreate />} />
```

**Step 3: If route missing, add it:**
Find existing rooms route and add /rooms/new route immediately after:
```typescript
// Find line with:
<Route path="rooms" element={<Rooms />} />

// Add after it:
<Route path="rooms/new" element={<RoomCreate />} />
```

**Step 4: If import missing, add it:**
Find: `import Rooms from './pages/Rooms';`
Add after: `import RoomCreate from './pages/RoomCreate';`

**Pattern reference:** Talents routes (Phase 28), Services routes (Phase 29)
  </action>
  <verify>
App.tsx changes verified:
1. Import exists: import RoomCreate from './pages/RoomCreate'
2. Route exists: <Route path="rooms/new" element={<RoomCreate />} />
3. Route is sibling to <Route path="rooms" element={<Rooms />} />
4. Both routes inside same parent (ProtectedRoute > Layout)

Run: grep -A 1 'path="rooms"' packages/client/src/App.tsx
Expected: 2 matches (rooms list route + rooms/new route)

Run: grep 'RoomCreate' packages/client/src/App.tsx
Expected: 2 matches (import + route element)
  </verify>
  <done>
App.tsx verified: /rooms/new route exists. RoomCreate component imported. Route registered as sibling to /rooms list route. TypeScript compiles with 0 errors. Navigation flow complete: Rooms list → /rooms/new → RoomCreate page.
  </done>
</task>

<task type="auto">
  <name>Task 5: Build verification and type checking</name>
  <files>N/A</files>
  <action>
Verify all changes compile successfully and maintain type safety.

**Step 1: Type check all packages**
Run: `pnpm check`
Expected: 0 TypeScript errors across all packages

**Step 2: Build client package**
Run: `pnpm --filter client build`
Expected: Build succeeds with 0 errors, dist/ directory created

**Step 3: Verify imports resolve**
Check that RoomEditForm is imported correctly in RoomCreate:
Run: `grep "RoomEditForm" packages/client/src/pages/RoomCreate.tsx`
Expected: Import statement matches export from RoomEditForm.tsx

**Step 4: Verify route exists**
Run: `grep -C 2 "rooms/new" packages/client/src/App.tsx`
Expected: Route with RoomCreate element visible

**If errors occur:**
- Import path issues: Verify @/components alias works
- Type errors: Check formData interface matches between RoomCreate and RoomEditForm
- Build errors: Run `pnpm install` if missing dependencies

**Pattern verification checklist:**
- [ ] RoomCreate page structure matches TalentCreate (header, form, buttons)
- [ ] RoomEditForm has 4 accordions (Identity, Pricing, Configuration, Details)
- [ ] localStorage key is unique ('roomEditAccordions')
- [ ] Alt+Click handler present in RoomEditForm
- [ ] Rooms.tsx button uses asChild + Link pattern
- [ ] Route exists in App.tsx
  </action>
  <verify>
Run: pnpm check
Expected: "✓ Checked N files in Xms" with 0 errors

Run: pnpm --filter client build
Expected: "dist/index.html" created, build size reported, 0 errors

Run: ls packages/client/dist/
Expected: index.html, assets/ directory exist
  </verify>
  <done>
All TypeScript checks pass (0 errors). Client builds successfully. RoomCreate page, RoomEditForm component, and routing changes compile without issues. Pattern verification complete: Rooms harmonization matches established pattern from Phases 22-29. Ready for manual testing.
  </done>
</task>

</tasks>

<verification>
**Automated verification:**
1. `pnpm check` passes with 0 TypeScript errors
2. `pnpm --filter client build` succeeds
3. RoomCreate.tsx reduced to 100-120 lines (from 300)
4. RoomEditForm.tsx exists with 280+ lines
5. Rooms.tsx uses Link navigation (not Dialog for create)
6. App.tsx contains route for /rooms/new

**Manual verification (user testing):**
1. Navigate to /rooms page
2. Click "Nouvelle salle" button
3. Verify navigation to /rooms/new (URL changes)
4. Verify RoomCreate page renders with:
   - Header: "Nouvelle Salle" with Building icon
   - Back button to /rooms
   - 4 accordion sections (Identity, Pricing, Configuration, Details)
   - All 14 fields present
   - Cancel button (returns to /rooms)
   - "Créer la salle" submit button
5. Test accordion interactions:
   - Click accordion headers to expand/collapse
   - Alt+Click on any header to toggle all accordions
6. Fill form with valid data and submit
7. Verify success toast appears
8. Verify navigation returns to /rooms list
9. Verify new room appears in table
10. Refresh page and return to /rooms/new
11. Verify accordion state persisted (same accordions open as before)

**Goal-backward verification (must_haves):**
- ✓ User can navigate to /rooms/new from list page (button + route exist)
- ✓ User can create room via dedicated page (RoomCreate page exists)
- ✓ Form uses accordion pattern (RoomEditForm has 4 AccordionItems)
- ✓ localStorage persistence (roomEditAccordions key used)
- ✓ Alt+Click toggle (handleAccordionTriggerClick handler present)
- ✓ Success flow returns to list (navigate("/rooms") exists)
</verification>

<success_criteria>
**Code artifacts:**
- [x] RoomEditForm.tsx created (280-320 lines)
- [x] RoomCreate.tsx refactored (reduced from 300 to ~110 lines)
- [x] Rooms.tsx verified (Link navigation pattern)
- [x] App.tsx verified (route exists)

**Functional requirements:**
- [x] /rooms/new route accessible
- [x] RoomCreate page renders correctly
- [x] Form has 4 accordion sections (Identity + Pricing + Configuration + Details)
- [x] All 14 room fields present and functional
- [x] Validation works (required fields checked)
- [x] Submit creates room via tRPC mutation
- [x] Success returns to /rooms list with toast
- [x] Error shows toast with message
- [x] Accordion state persists in localStorage
- [x] Alt+Click toggles all accordions

**Pattern consistency:**
- [x] Matches TalentCreate/TalentEditForm structure (Phase 28)
- [x] Consistent with 11 other harmonized resources (Phases 22-29)
- [x] Uses accordion-based form (not inline Card form)
- [x] Bookmarkable URL (/rooms/new)
- [x] TypeScript strict mode passes (0 errors)

**Code improvement:**
- [x] Reduced RoomCreate.tsx from 300 to ~110 lines (63% reduction)
- [x] Separated concerns (page logic vs form UI)
- [x] Reusable RoomEditForm component (can be used for edit flows later)

**Documentation:**
- Phase 31 harmonization complete
- Rooms now consistent with clients, sessions, invoices, equipment, projects, quotes, contracts, expenses, talents, tracks, services
- All 12 resources use dedicated `/resource/new` pages with accordion forms
- Pattern fully established for entire application
</success_criteria>

<output>
After completion, create `.planning/phases/31-harmonisation-rooms---routing-cohérent/31-01-SUMMARY.md` with:

**Frontmatter:**
- phase: 31-harmonisation-rooms---routing-cohérent
- plan: 01
- subsystem: ui-harmonization
- tags: [rooms, routing, accordion-form, ui-consistency]
- requires: Phase 28 (TalentEditForm pattern)
- provides: RoomEditForm component, refactored RoomCreate page
- affects: All future UI harmonization phases (pattern fully established)
- tech-stack.added: [] (zero new dependencies)
- tech-stack.patterns: [Accordion forms, localStorage persistence, Link navigation]
- key-files.created: [RoomEditForm.tsx]
- key-files.modified: [RoomCreate.tsx, Rooms.tsx verified, App.tsx verified]
- decisions: [Use 4 accordions for room fields, Refactor existing page not create new, Reduce RoomCreate from 300 to 110 lines]
- metrics: duration, completed date, tasks 5/5, commits 1

**Summary sections:**
1. **What Was Built:** RoomEditForm accordion component, RoomCreate refactored to use component
2. **Key Changes:** List 5 tasks with files modified and line counts
3. **Pattern Application:** How TalentEditForm pattern was adapted to Rooms (4 accordions for 14 fields)
4. **Technical Decisions:** Why 4 accordions, why refactor existing page, verification strategy
5. **Verification Results:** TypeScript 0 errors, build success, manual testing outcomes
6. **Next Steps:** All 12 resources harmonized - pattern complete

**Include in summary:**
- Total lines added: ~300 (RoomEditForm component)
- Total lines removed: ~190 (inline form from RoomCreate)
- Net change: +110 lines
- Code improvement: 63% reduction in RoomCreate.tsx (300 → 110 lines)
- Pattern consistency: 12/12 resources now harmonized
- Zero technical debt: All resources use same accordion pattern
</output>
