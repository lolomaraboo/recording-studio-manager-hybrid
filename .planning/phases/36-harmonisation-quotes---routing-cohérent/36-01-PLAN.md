---
phase: 36-harmonisation-quotes---routing-cohérent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/components/QuoteEditForm.tsx (new file)
  - packages/client/src/pages/QuoteCreate.tsx
autonomous: true

must_haves:
  truths:
    - "Quote creation uses accordion pattern like ClientEditForm"
    - "Inline form eliminated, replaced with reusable QuoteEditForm"
    - "Accordions open by default for immediate field access"
    - "Form structure matches quote context (client, items, terms, notes)"
    - "Line items builder integrated in accordion section"
  artifacts:
    - path: "packages/client/src/components/QuoteEditForm.tsx"
      provides: "Accordion-based edit form for quotes"
      min_lines: 500
      exports: ["QuoteEditForm"]
    - path: "packages/client/src/pages/QuoteCreate.tsx"
      provides: "Simplified creation page using QuoteEditForm"
      min_lines: 150
      contains: "QuoteEditForm"
  key_links:
    - from: "QuoteCreate.tsx"
      to: "QuoteEditForm"
      via: "reusable component for creation"
      pattern: "QuoteEditForm"
    - from: "QuoteEditForm"
      to: "line items state"
      via: "items array management"
      pattern: "items.*setItems"
---

<objective>
Create accordion-based QuoteEditForm component and refactor QuoteCreate page to use it, matching Phase 28 TalentEditForm pattern.

Purpose: Complete Phase 36 harmonization by providing consistent edit UX for quotes
Output: QuoteEditForm component and refactored QuoteCreate page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference implementations
@.planning/phases/28-harmonisation-ui-talents/28-05-PLAN.md (accordion pattern reference)
@packages/client/src/components/TalentEditForm.tsx (accordion pattern implementation)

# Current quote implementation
@packages/client/src/pages/QuoteCreate.tsx (inline form - to be refactored)
@packages/database/src/tenant/schema.ts (quote schema - lines 564-623)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuoteEditForm component with accordions</name>
  <files>packages/client/src/components/QuoteEditForm.tsx</files>
  <action>
**Pattern reference:** TalentEditForm.tsx (accordions, all open by default, organized sections)

**Create accordion-based edit form for quotes:**

1. **Component structure (adapt from TalentEditForm):**
   ```typescript
   import { useState, useEffect } from "react";
   import { Button } from "@/components/ui/button";
   import { Card } from "@/components/ui/card";
   import { Input } from "@/components/ui/input";
   import { Label } from "@/components/ui/label";
   import { Textarea } from "@/components/ui/textarea";
   import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
   import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
   import { Command, CommandEmpty, CommandGroup, CommandItem, CommandList } from "@/components/ui/command";
   import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from "@/components/ui/dialog";
   import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
   import { Badge } from "@/components/ui/badge";
   import {
     Accordion,
     AccordionContent,
     AccordionItem,
     AccordionTrigger,
   } from "@/components/ui/accordion";
   import {
     FileText,
     Receipt,
     ListOrdered,
     Package,
     Plus,
     Trash2,
   } from "lucide-react";
   import { trpc } from "@/lib/trpc";

   type LineItem = {
     description: string;
     quantity: string;
     unitPrice: string;
     amount: string;
     displayOrder: number;
     taxRate?: string; // Per-line tax rate override
   };

   interface QuoteEditFormProps {
     formData: {
       clientId: number | undefined;
       projectId: number | undefined;
       title: string;
       terms: string;
       notes: string;
       internalNotes: string;
     };
     setFormData: (data: any) => void;
     items: LineItem[];
     setItems: (items: LineItem[]) => void;
     taxRate: string;
     setTaxRate: (rate: string) => void;
     clients?: any[];
     projects?: any[];
   }

   export function QuoteEditForm({
     formData,
     setFormData,
     items,
     setItems,
     taxRate,
     setTaxRate,
     clients = [],
     projects = [],
   }: QuoteEditFormProps) {
     // State for open accordions (all open by default)
     const [openItems, setOpenItems] = useState<string[]>(() => {
       try {
         const saved = localStorage.getItem('quoteEditAccordions');
         return saved ? JSON.parse(saved) : ["informations", "prestations", "conditions", "notes"];
       } catch {
         return ["informations", "prestations", "conditions", "notes"];
       }
     });

     // Save accordion state to localStorage
     useEffect(() => {
       try {
         localStorage.setItem('quoteEditAccordions', JSON.stringify(openItems));
       } catch (error) {
         console.error('Failed to save accordion state:', error);
       }
     }, [openItems]);

     // Alt key handler to toggle all accordions
     const handleAccordionTriggerClick = (event: React.MouseEvent) => {
       if (event.altKey) {
         event.preventDefault();
         event.stopPropagation();

         const allAccordions = ["informations", "prestations", "conditions", "notes"];
         if (openItems.length < allAccordions.length) {
           setOpenItems(allAccordions);
         } else {
           setOpenItems([]);
         }
       }
     };

     // Line items logic (from QuoteCreate.tsx)
     const [autocompleteOpen, setAutocompleteOpen] = useState<number | null>(null);
     const [searchQuery, setSearchQuery] = useState<{ [index: number]: string }>({});
     const [debouncedSearch, setDebouncedSearch] = useState("");
     const [currentSearchIndex, setCurrentSearchIndex] = useState<number | null>(null);
     const [catalogModalOpen, setCatalogModalOpen] = useState(false);
     const [catalogCategory, setCatalogCategory] = useState<string>("all");

     // Service catalog queries
     const { data: autocompleteServices } = trpc.serviceCatalog.list.useQuery(
       {
         search: debouncedSearch,
         activeOnly: true,
       },
       {
         enabled: debouncedSearch.length >= 2,
       }
     );

     const { data: catalogServices } = trpc.serviceCatalog.list.useQuery({
       category: catalogCategory === "all" ? undefined : (catalogCategory as any),
       activeOnly: true,
     });

     // Debounce search
     useEffect(() => {
       if (currentSearchIndex !== null && searchQuery[currentSearchIndex]) {
         const timer = setTimeout(() => {
           setDebouncedSearch(searchQuery[currentSearchIndex]);
         }, 200);
         return () => clearTimeout(timer);
       } else {
         setDebouncedSearch("");
       }
     }, [searchQuery, currentSearchIndex]);

     // Line item handlers
     const handleAddItem = () => {
       setItems([
         ...items,
         { description: "", quantity: "1.00", unitPrice: "0.00", amount: "0.00", displayOrder: items.length }
       ]);
     };

     const handleRemoveItem = (index: number) => {
       const newItems = items.filter((_, i) => i !== index);
       const reorderedItems = newItems.map((item, i) => ({ ...item, displayOrder: i }));
       setItems(reorderedItems);
     };

     const handleItemChange = (index: number, field: keyof LineItem, value: string) => {
       const newItems = [...items];
       newItems[index] = { ...newItems[index], [field]: value };

       if (field === "quantity" || field === "unitPrice") {
         const quantity = parseFloat(newItems[index].quantity) || 0;
         const unitPrice = parseFloat(newItems[index].unitPrice) || 0;
         newItems[index].amount = (quantity * unitPrice).toFixed(2);
       }

       if (field === "description") {
         setSearchQuery({ ...searchQuery, [index]: value });
         setCurrentSearchIndex(index);
       }

       setItems(newItems);
     };

     const handleServiceSelect = (index: number, service: any) => {
       const newItems = [...items];
       newItems[index] = {
         ...newItems[index],
         description: service.name,
         quantity: service.defaultQuantity.toString(),
         unitPrice: service.unitPrice.toString(),
         amount: (service.defaultQuantity * service.unitPrice).toFixed(2),
         taxRate: service.taxRate.toString() !== taxRate ? service.taxRate.toString() : undefined,
       };
       setItems(newItems);
       setAutocompleteOpen(null);
       setSearchQuery({ ...searchQuery, [index]: service.name });
     };

     const handleCatalogServiceSelect = (service: any) => {
       const newItem: LineItem = {
         description: service.name,
         quantity: service.defaultQuantity.toString(),
         unitPrice: service.unitPrice.toString(),
         amount: (service.defaultQuantity * service.unitPrice).toFixed(2),
         displayOrder: items.length,
         taxRate: service.taxRate.toString() !== taxRate ? service.taxRate.toString() : undefined,
       };
       setItems([...items, newItem]);
       setCatalogModalOpen(false);
     };

     // Calculate totals
     const subtotal = items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
     const taxAmount = items.reduce((sum, item) => {
       const itemAmount = parseFloat(item.amount) || 0;
       const itemTaxRate = item.taxRate ? parseFloat(item.taxRate) : parseFloat(taxRate);
       return sum + (itemAmount * itemTaxRate) / 100;
     }, 0);
     const total = subtotal + taxAmount;

     return (
       <>
         <Accordion
           type="multiple"
           value={openItems}
           onValueChange={setOpenItems}
           className="space-y-2"
         >
           {/* Accordion 1: Informations */}
           <AccordionItem value="informations">
             <Card>
               <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
                 <h3 className="text-lg font-semibold flex items-center gap-2">
                   <FileText className="h-5 w-5 text-primary" />
                   Informations du devis
                 </h3>
               </AccordionTrigger>
               <AccordionContent>
                 <div className="px-4 pb-3 space-y-3">
                   <div className="grid md:grid-cols-2 gap-3">
                     <div>
                       <Label htmlFor="clientId">
                         Client <span className="text-destructive">*</span>
                       </Label>
                       <Select
                         value={formData.clientId?.toString() ?? ""}
                         onValueChange={(value) => setFormData({ ...formData, clientId: parseInt(value) })}
                       >
                         <SelectTrigger id="clientId">
                           <SelectValue placeholder="Sélectionner un client" />
                         </SelectTrigger>
                         <SelectContent>
                           {clients.map((client) => (
                             <SelectItem key={client.id} value={client.id.toString()}>
                               {client.name}
                             </SelectItem>
                           ))}
                         </SelectContent>
                       </Select>
                     </div>
                     <div>
                       <Label htmlFor="projectId">Projet (optionnel)</Label>
                       <Select
                         value={formData.projectId?.toString() ?? "0"}
                         onValueChange={(value) => setFormData({ ...formData, projectId: parseInt(value) })}
                       >
                         <SelectTrigger id="projectId">
                           <SelectValue placeholder="Aucun" />
                         </SelectTrigger>
                         <SelectContent>
                           <SelectItem value="0">Aucun</SelectItem>
                           {projects.map((project) => (
                             <SelectItem key={project.id} value={project.id.toString()}>
                               {project.name}
                             </SelectItem>
                           ))}
                         </SelectContent>
                       </Select>
                     </div>
                   </div>
                   <div>
                     <Label htmlFor="title">Titre</Label>
                     <Input
                       id="title"
                       value={formData.title}
                       onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                       placeholder="Ex: Enregistrement album"
                     />
                   </div>
                 </div>
               </AccordionContent>
             </Card>
           </AccordionItem>

           {/* Accordion 2: Prestations (Line Items) */}
           <AccordionItem value="prestations">
             <Card>
               <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
                 <h3 className="text-lg font-semibold flex items-center gap-2">
                   <ListOrdered className="h-5 w-5 text-primary" />
                   Prestations
                 </h3>
               </AccordionTrigger>
               <AccordionContent>
                 <div className="px-4 pb-3 space-y-4">
                   <div className="flex justify-end gap-2">
                     <Button type="button" size="sm" variant="secondary" onClick={() => setCatalogModalOpen(true)}>
                       <Package className="h-4 w-4 mr-2" />
                       Du catalogue
                     </Button>
                     <Button type="button" size="sm" variant="outline" onClick={handleAddItem}>
                       <Plus className="h-4 w-4 mr-2" />
                       Ajouter une ligne
                     </Button>
                   </div>

                   {items.map((item, index) => (
                     <div key={index} className="grid grid-cols-12 gap-2 items-start border p-3 rounded-md">
                       {/* Description - 5 cols with autocomplete */}
                       <div className="col-span-5 space-y-1">
                         <Label className="text-xs">Description</Label>
                         <Popover open={autocompleteOpen === index} onOpenChange={(open) => setAutocompleteOpen(open ? index : null)}>
                           <PopoverTrigger asChild>
                             <Input
                               value={item.description}
                               onChange={(e) => handleItemChange(index, "description", e.target.value)}
                               onFocus={() => {
                                 setCurrentSearchIndex(index);
                                 if (item.description.length >= 2) {
                                   setAutocompleteOpen(index);
                                 }
                               }}
                               onBlur={() => {
                                 setTimeout(() => setAutocompleteOpen(null), 200);
                               }}
                               placeholder="Tapez pour rechercher..."
                             />
                           </PopoverTrigger>
                           <PopoverContent className="w-[400px] p-0" align="start">
                             <Command>
                               <CommandList>
                                 {!autocompleteServices || autocompleteServices.length === 0 ? (
                                   <CommandEmpty>
                                     {searchQuery[index]?.length >= 2 ? "Aucun service trouvé" : "Tapez au moins 2 caractères"}
                                   </CommandEmpty>
                                 ) : (
                                   <CommandGroup>
                                     {autocompleteServices.slice(0, 10).map((service) => (
                                       <CommandItem
                                         key={service.id}
                                         onSelect={() => handleServiceSelect(index, service)}
                                         className="flex items-center justify-between cursor-pointer"
                                       >
                                         <div className="flex-1">
                                           <div className="font-medium">{service.name}</div>
                                           <div className="text-xs text-muted-foreground">{service.category}</div>
                                         </div>
                                         <div className="text-sm font-medium">{parseFloat(service.unitPrice).toFixed(2)} €</div>
                                       </CommandItem>
                                     ))}
                                   </CommandGroup>
                                 )}
                               </CommandList>
                             </Command>
                           </PopoverContent>
                         </Popover>
                       </div>

                       {/* Quantity - 2 cols */}
                       <div className="col-span-2 space-y-1">
                         <Label className="text-xs">Quantité</Label>
                         <Input
                           type="number"
                           step="0.01"
                           value={item.quantity}
                           onChange={(e) => handleItemChange(index, "quantity", e.target.value)}
                         />
                       </div>

                       {/* Unit Price - 2 cols */}
                       <div className="col-span-2 space-y-1">
                         <Label className="text-xs">Prix unit. (€)</Label>
                         <Input
                           type="number"
                           step="0.01"
                           value={item.unitPrice}
                           onChange={(e) => handleItemChange(index, "unitPrice", e.target.value)}
                         />
                       </div>

                       {/* Amount - 2 cols (read-only calculated) */}
                       <div className="col-span-2 space-y-1">
                         <Label className="text-xs">Montant (€)</Label>
                         <div className="flex flex-col gap-1">
                           <Input value={item.amount} readOnly className="bg-muted" />
                           {item.taxRate && item.taxRate !== taxRate && (
                             <Badge variant="secondary" className="text-xs px-1 py-0">
                               TVA {item.taxRate}%
                             </Badge>
                           )}
                         </div>
                       </div>

                       {/* Remove button - 1 col */}
                       <div className="col-span-1 flex items-end">
                         <Button
                           type="button"
                           variant="ghost"
                           size="sm"
                           onClick={() => handleRemoveItem(index)}
                           disabled={items.length === 1}
                         >
                           <Trash2 className="h-4 w-4 text-destructive" />
                         </Button>
                       </div>
                     </div>
                   ))}

                   {/* Totals Display */}
                   <div className="flex justify-end">
                     <div className="w-64 space-y-2 border-t pt-3">
                       <div className="flex justify-between text-sm">
                         <span className="text-muted-foreground">Sous-total:</span>
                         <span className="font-medium">{subtotal.toFixed(2)} €</span>
                       </div>
                       <div className="flex justify-between text-sm items-center gap-2">
                         <Label htmlFor="taxRate" className="text-muted-foreground">TVA (%):</Label>
                         <Input
                           id="taxRate"
                           type="number"
                           step="0.01"
                           value={taxRate}
                           onChange={(e) => setTaxRate(e.target.value)}
                           className="w-20 h-8"
                         />
                       </div>
                       <div className="flex justify-between text-sm">
                         <span className="text-muted-foreground">TVA:</span>
                         <span className="font-medium">{taxAmount.toFixed(2)} €</span>
                       </div>
                       <div className="flex justify-between text-lg font-bold border-t pt-2">
                         <span>Total TTC:</span>
                         <span>{total.toFixed(2)} €</span>
                       </div>
                     </div>
                   </div>
                 </div>
               </AccordionContent>
             </Card>
           </AccordionItem>

           {/* Accordion 3: Conditions */}
           <AccordionItem value="conditions">
             <Card>
               <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
                 <h3 className="text-lg font-semibold flex items-center gap-2">
                   <Receipt className="h-5 w-5 text-primary" />
                   Conditions
                 </h3>
               </AccordionTrigger>
               <AccordionContent>
                 <div className="px-4 pb-3 space-y-3">
                   <div>
                     <Label htmlFor="terms">Conditions générales</Label>
                     <Textarea
                       id="terms"
                       value={formData.terms}
                       onChange={(e) => setFormData({ ...formData, terms: e.target.value })}
                       placeholder="Conditions générales du devis..."
                       rows={3}
                     />
                   </div>
                 </div>
               </AccordionContent>
             </Card>
           </AccordionItem>

           {/* Accordion 4: Notes */}
           <AccordionItem value="notes">
             <Card>
               <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
                 <h3 className="text-lg font-semibold flex items-center gap-2">
                   <FileText className="h-5 w-5 text-primary" />
                   Notes
                 </h3>
               </AccordionTrigger>
               <AccordionContent>
                 <div className="px-4 pb-3 space-y-3">
                   <div>
                     <Label htmlFor="notes">Notes (visibles client)</Label>
                     <Textarea
                       id="notes"
                       value={formData.notes}
                       onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                       placeholder="Notes visibles sur le devis..."
                       rows={2}
                     />
                   </div>
                   <div>
                     <Label htmlFor="internalNotes">Notes internes</Label>
                     <Textarea
                       id="internalNotes"
                       value={formData.internalNotes}
                       onChange={(e) => setFormData({ ...formData, internalNotes: e.target.value })}
                       placeholder="Notes internes (non visibles client)..."
                       rows={2}
                     />
                   </div>
                 </div>
               </AccordionContent>
             </Card>
           </AccordionItem>
         </Accordion>

         {/* Catalog Modal */}
         <Dialog open={catalogModalOpen} onOpenChange={setCatalogModalOpen}>
           <DialogContent className="max-w-4xl">
             <DialogHeader>
               <DialogTitle>Sélectionner un service du catalogue</DialogTitle>
               <DialogDescription>
                 Choisissez un service pré-défini pour l'ajouter au devis
               </DialogDescription>
             </DialogHeader>
             <div className="space-y-4">
               {/* Category Filter */}
               <div className="flex items-center gap-4">
                 <Label>Catégorie:</Label>
                 <Select value={catalogCategory} onValueChange={setCatalogCategory}>
                   <SelectTrigger className="w-64">
                     <SelectValue />
                   </SelectTrigger>
                   <SelectContent>
                     <SelectItem value="all">Toutes les catégories</SelectItem>
                     <SelectItem value="Studio">Studio</SelectItem>
                     <SelectItem value="Post-production">Post-production</SelectItem>
                     <SelectItem value="Location matériel">Location matériel</SelectItem>
                     <SelectItem value="Autre">Autre</SelectItem>
                   </SelectContent>
                 </Select>
               </div>

               {/* Services Table */}
               {!catalogServices || catalogServices.length === 0 ? (
                 <div className="py-8 text-center">
                   <Package className="mx-auto h-12 w-12 text-muted-foreground mb-3" />
                   <p className="text-muted-foreground">Aucun service dans le catalogue.</p>
                 </div>
               ) : (
                 <div className="border rounded-lg overflow-hidden max-h-[400px] overflow-y-auto">
                   <Table>
                     <TableHeader>
                       <TableRow>
                         <TableHead>Nom</TableHead>
                         <TableHead>Catégorie</TableHead>
                         <TableHead className="text-right">Prix unitaire</TableHead>
                         <TableHead className="text-right">TVA</TableHead>
                         <TableHead className="text-right">Qté défaut</TableHead>
                       </TableRow>
                     </TableHeader>
                     <TableBody>
                       {catalogServices.map((service) => (
                         <TableRow
                           key={service.id}
                           className="cursor-pointer hover:bg-accent"
                           onClick={() => handleCatalogServiceSelect(service)}
                         >
                           <TableCell>
                             <div>
                               <div className="font-medium">{service.name}</div>
                               {service.description && (
                                 <div className="text-sm text-muted-foreground line-clamp-1">
                                   {service.description}
                                 </div>
                               )}
                             </div>
                           </TableCell>
                           <TableCell>{service.category}</TableCell>
                           <TableCell className="text-right">{parseFloat(service.unitPrice).toFixed(2)} €</TableCell>
                           <TableCell className="text-right">{service.taxRate}%</TableCell>
                           <TableCell className="text-right">{service.defaultQuantity}</TableCell>
                         </TableRow>
                       ))}
                     </TableBody>
                   </Table>
                 </div>
               )}
             </div>
           </DialogContent>
         </Dialog>
       </>
     );
   }
   ```

2. **Key accordion sections:**
   - **Informations** (client, project, title)
   - **Prestations** (line items builder with autocomplete and catalog)
   - **Conditions** (terms)
   - **Notes** (client-visible notes + internal notes)

3. **Unique quote features preserved:**
   - Line items array with autocomplete
   - Service catalog modal
   - Per-line tax rate overrides
   - Real-time totals calculation
   - Description search (debounced)

**Why accordion pattern:** Matches TalentEditForm Phase 28, eliminates Card overhead, all fields accessible, localStorage persistence

**Differences from QuoteCreate inline form:**
- Organized into 4 accordion sections
- All accordions open by default
- Alt+Click toggles all
- Line items builder stays in Prestations accordion
- Totals calculation preserved
  </action>
  <verify>
1. Component exports QuoteEditForm
2. TypeScript 0 errors on component definition
3. All 4 accordions render correctly
4. localStorage persistence works (quoteEditAccordions key)
5. Alt+Click toggles all accordions
6. Line items autocomplete functional
7. Service catalog modal opens and selects services
8. Totals calculation accurate
  </verify>
  <done>
- QuoteEditForm.tsx created with 4 accordions
- Informations, Prestations, Conditions, Notes sections
- All accordions open by default
- localStorage persistence for accordion state
- Alt+Click toggle all feature
- Line items builder with autocomplete integrated
- Service catalog modal functional
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor QuoteCreate.tsx to use QuoteEditForm</name>
  <files>packages/client/src/pages/QuoteCreate.tsx</files>
  <action>
**Pattern reference:** TalentCreate.tsx after Phase 28 refactor - reusable form component

**Simplify creation page:**

1. **Import QuoteEditForm:**
   ```typescript
   import { QuoteEditForm } from "@/components/QuoteEditForm";
   ```

2. **Keep existing state** (formData, items, taxRate, createMutation - all good)

3. **Replace inline Card form with QuoteEditForm:**
   ```typescript
   return (
     <div className="container pt-2 pb-4 px-2">
       <div className="space-y-2">
         {/* Header */}
         <div className="flex items-center justify-between">
           <div className="flex items-center gap-4">
             <Link to="/quotes">
               <Button variant="ghost" size="icon">
                 <ArrowLeft className="h-5 w-5" />
               </Button>
             </Link>
             <div>
               <h1 className="text-3xl font-bold">Nouveau Devis</h1>
               <p className="text-muted-foreground">Créer un nouveau devis client</p>
             </div>
           </div>
         </div>

         {/* Form */}
         <form onSubmit={handleSubmit}>
           <QuoteEditForm
             formData={formData}
             setFormData={setFormData}
             items={items}
             setItems={setItems}
             taxRate={taxRate}
             setTaxRate={setTaxRate}
             clients={clients}
             projects={projects}
           />

           {/* Submit button */}
           <div className="mt-4 flex justify-end gap-2">
             <Button type="button" variant="outline" onClick={() => navigate("/quotes")}>
               Annuler
             </Button>
             <Button type="submit" disabled={createMutation.isPending}>
               <Save className="h-4 w-4 mr-2" />
               {createMutation.isPending ? "Création..." : "Créer le devis"}
             </Button>
           </div>
         </form>
       </div>
     </div>
   );
   ```

4. **Remove all inline form elements** (lines ~230-481 in current file - replaced by QuoteEditForm)

5. **Keep handleSubmit logic** (validation and mutation - unchanged)

**Result:** QuoteCreate.tsx reduces from ~565 lines to ~150 lines, reuses QuoteEditForm component

**Benefits:**
- DRY principle (single form component for create + edit)
- Consistency (same UI for creation and editing)
- Maintainability (form changes only in QuoteEditForm.tsx)
- Accordion pattern adopted (matches Phase 28 TalentEditForm)
  </action>
  <verify>
1. Navigate to /quotes/new
2. QuoteEditForm renders with 4 accordions
3. Fill client (required), add line items
4. Click "Créer le devis" - createMutation fires
5. Successful creation redirects to /quotes
6. TypeScript 0 errors
7. Line items autocomplete functional
8. Service catalog modal works
  </verify>
  <done>
- QuoteCreate.tsx refactored to use QuoteEditForm
- Page simplified to ~150 lines (from ~565)
- Reusable form component for create + edit
- Submit button with validation
- All quote creation features preserved
- TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and verify harmonization complete</name>
  <files>packages/client/src/components/QuoteEditForm.tsx, packages/client/src/pages/QuoteCreate.tsx</files>
  <action>
**Final verification steps:**

1. **TypeScript check:**
   ```bash
   pnpm --filter client check
   ```

2. **Build test:**
   ```bash
   pnpm --filter client build
   ```

3. **Test complete workflow:**
   - Visit /quotes/new → create quote with QuoteEditForm
   - Fill client, add line items via autocomplete or catalog
   - Verify totals calculation
   - Submit and verify redirect to /quotes

4. **Document completion in commit:**
   ```bash
   git add packages/client/src/components/QuoteEditForm.tsx packages/client/src/pages/QuoteCreate.tsx
   git commit -m "feat(36-01): create accordion-based QuoteEditForm

Phase 36: Quote Harmonization with Accordion Pattern
- Created QuoteEditForm component (4 accordions: Informations, Prestations, Conditions, Notes)
- Refactored QuoteCreate.tsx to use QuoteEditForm (~150 lines from ~565)
- Inline form eliminated, accordion pattern adopted
- All accordions open by default (Alt+Click toggle all)
- localStorage persistence for accordion state
- Line items builder preserved with autocomplete and catalog modal
- Service catalog integration functional
- Per-line tax rate overrides supported
- Real-time totals calculation maintained

Pattern reference: TalentEditForm Phase 28 (accordion-based reusable form)
Architecture: DRY principle, reusable component for create + edit
Goal achieved: Quote creation UI harmonized with Client/Talent/Service patterns

Phase 36 COMPLETE: Quotes UI harmonized with accordion pattern

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
   ```

**Success indicators:**
- ✓ Build successful (zero errors)
- ✓ TypeScript passes
- ✓ Create workflow functional
- ✓ Line items builder working
- ✓ Accordion pattern adopted
- ✓ Phase 36 complete
  </action>
  <verify>
1. TypeScript check passes (0 errors)
2. Build completes successfully
3. No console errors in create workflow
4. All 4 accordions functional
5. Line items autocomplete working
6. Service catalog modal functional
7. Totals calculation accurate
8. Git commit created with Phase 36 completion message
  </verify>
  <done>
- TypeScript 0 errors confirmed
- Production build successful
- QuoteEditForm harmonized with TalentEditForm patterns
- Inline form eliminated (Phase 28 goal achieved for quotes)
- Phase 36 complete
- Quote creation UI harmonized with Client/Talent/Service accordion patterns
  </done>
</task>

</tasks>

<verification>
**Phase 36 Complete Verification:**

1. **QuoteEditForm component:**
   - [x] 4 accordions (Informations, Prestations, Conditions, Notes)
   - [x] All open by default
   - [x] localStorage persistence
   - [x] Alt+Click toggles all
   - [x] Line items builder integrated in Prestations accordion

2. **QuoteCreate page:**
   - [x] Uses QuoteEditForm component
   - [x] Simplified to ~150 lines (from ~565)
   - [x] Submit workflow functional
   - [x] Validation working

3. **Features preserved:**
   - [x] Line items autocomplete
   - [x] Service catalog modal
   - [x] Per-line tax rates
   - [x] Real-time totals calculation
   - [x] Client/project selection

**Harmonization verification:**
- [x] Matches TalentEditForm accordion pattern (Phase 28)
- [x] Consistent with ClientEditForm (Phase 26)
- [x] DRY principle (reusable component)
- [x] All fields accessible immediately
</verification>

<success_criteria>
- [ ] QuoteEditForm component created with 4 accordions
- [ ] All accordions open by default with localStorage persistence
- [ ] Alt+Click toggles all accordions
- [ ] Line items builder integrated with autocomplete
- [ ] Service catalog modal functional
- [ ] QuoteCreate.tsx refactored to use QuoteEditForm (~150 lines)
- [ ] Inline form eliminated from creation flow
- [ ] TypeScript 0 errors
- [ ] Client builds successfully
- [ ] Create workflow functional
- [ ] Totals calculation accurate
- [ ] Phase 36 complete: Quote creation UI harmonized with accordion pattern
</success_criteria>

<output>
After completion, create `.planning/phases/36-harmonisation-quotes---routing-cohérent/36-01-SUMMARY.md`
</output>
