---
phase: 22-refonte-ui-client-hub-relationnel-complet
plan: 09
type: execute
wave: 5
depends_on: ["22-01", "22-02"]
files_modified:
  - packages/client/src/pages/ClientDetail.tsx
  - packages/client/src/components/ClientFormWizard.tsx
  - packages/server/src/routers/clients.ts
autonomous: true

must_haves:
  truths:
    - Edit mode uses ClientFormWizard component
    - Edit mode hydrates all ~60 fields from client data
    - Wizard submission updates client via clients.update mutation
    - Cancel button exits edit mode without saving
    - clients.update mutation accepts all music profile fields
  artifacts:
    - path: packages/client/src/pages/ClientDetail.tsx
      provides: Edit mode using wizard
      contains: "ClientFormWizard mode=\"edit\""
    - path: packages/server/src/routers/clients.ts
      provides: Updated clients.update mutation with music fields
      contains: "update.*genres.*instruments"
  key_links:
    - from: packages/client/src/pages/ClientDetail.tsx
      to: packages/client/src/components/ClientFormWizard.tsx
      via: "render wizard in edit mode"
      pattern: "<ClientFormWizard mode=\"edit\""
    - from: packages/client/src/components/ClientFormWizard.tsx
      to: "@/lib/trpc"
      via: "clients.update mutation"
      pattern: "trpc\\.clients\\.update"
---

<objective>
Integrate ClientFormWizard into ClientDetail edit mode and extend clients.update mutation for music fields.

Purpose: Reuse wizard component for both creation and modification
Output: Edit mode uses wizard, backend accepts all fields including music profile
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-CONTEXT.md
@packages/client/src/pages/ClientDetail.tsx
@packages/client/src/components/ClientFormWizard.tsx
@packages/server/src/routers/clients.ts
</context>

<tasks>

<task type="auto">
  <name>Extend clients.update mutation for music fields</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
    Update clients.update mutation input schema to accept all fields:

    ```typescript
    update: protectedProcedure
      .input(z.object({
        id: z.number(),
        // Basic fields
        name: z.string().min(1).optional(),
        type: z.enum(["individual", "company"]).optional(),
        // ... existing fields ...

        // Music profile fields (22 fields from Phase 18.4)
        genres: z.array(z.string()).optional(),
        instruments: z.array(z.string()).optional(),
        vocalRange: z.string().optional(),
        skillLevel: z.string().optional(),
        yearsExperience: z.number().optional(),
        spotifyUrl: z.string().optional(),
        appleMusicUrl: z.string().optional(),
        soundcloudUrl: z.string().optional(),
        youtubeUrl: z.string().optional(),
        bandcampUrl: z.string().optional(),
        deezerUrl: z.string().optional(),
        tidalUrl: z.string().optional(),
        audiomackUrl: z.string().optional(),
        napsterUrl: z.string().optional(),
        pandoraUrl: z.string().optional(),
        itunesUrl: z.string().optional(),
        recordLabel: z.string().optional(),
        distributor: z.string().optional(),
        manager: z.string().optional(),
        publisher: z.string().optional(),
        performanceRightsSociety: z.string().optional(),
      }))
      .mutation(async ({ ctx, input }) => {
        const tenantDb = await ctx.getTenantDb();

        const { id, ...updateData } = input;

        const [updated] = await tenantDb
          .update(clients)
          .set({
            ...updateData,
            updatedAt: new Date(),
          })
          .where(eq(clients.id, id))
          .returning();

        return updated;
      }),
    ```

    Ensure all 22 music fields from Phase 18.4 schema are accepted.
  </action>
  <verify>
    Mutation compiles without TypeScript errors
    Input schema accepts all music profile fields
    `pnpm --filter server check` passes
  </verify>
  <done>
    clients.update mutation accepts all ~60 client fields including music profile
  </done>
</task>

<task type="auto">
  <name>Refactor ClientDetail edit mode to use wizard</name>
  <files>packages/client/src/pages/ClientDetail.tsx</files>
  <action>
    Replace inline edit form with ClientFormWizard:

    **Current state:** Edit mode shows inline form fields
    **New state:** Edit mode renders ClientFormWizard component

    **Changes:**

    1. Import wizard:
    ```typescript
    import { ClientFormWizard } from "@/components/ClientFormWizard";
    ```

    2. Conditional rendering based on edit mode:
    ```tsx
    {isEditing ? (
      <ClientFormWizard
        mode="edit"
        initialData={client}
        onSubmit={handleUpdate}
        onCancel={() => toggleEditMode(false)}
      />
    ) : (
      <ClientDetailTabs
        clientId={client.id}
        activeTab={activeTab}
        onTabChange={setActiveTab}
      />
    )}
    ```

    3. handleUpdate function:
    ```typescript
    const handleUpdate = (data: any) => {
      updateMutation.mutate(
        { id: Number(id), ...data },
        {
          onSuccess: () => {
            toast.success("Client mis à jour");
            toggleEditMode(false);
            refetch();
          },
          onError: (error) => {
            toast.error(`Erreur: ${error.message}`);
          },
        }
      );
    };
    ```

    4. Remove old inline form state/fields:
    - Remove formData state for edit mode
    - Remove inline Input/Textarea components in edit mode
    - Remove handleChange handlers
    - Keep updateMutation (used by handleUpdate)

    **Preserve:**
    - Breadcrumb navigation
    - Header with Edit/Delete buttons (hide when isEditing true)
    - View mode toggle functionality
    - Delete dialog
    - Notes section (always visible, even in edit mode - render AFTER wizard)
  </action>
  <verify>
    Edit mode renders ClientFormWizard component
    Wizard hydrates with client data (all fields)
    Submitting wizard updates client successfully
    Cancel button exits edit mode
    Notes section still visible in edit mode
    `pnpm --filter client dev` runs without errors
  </verify>
  <done>
    ClientDetail edit mode uses ClientFormWizard, all fields hydrated, update works
  </done>
</task>

<task type="auto">
  <name>Update ClientFormWizard to handle edit mode</name>
  <files>packages/client/src/components/ClientFormWizard.tsx</files>
  <action>
    Ensure wizard works for both create and edit modes:

    **1. Hydrate initialData in edit mode:**
    ```typescript
    const [formData, setFormData] = useState(() => {
      if (props.mode === "edit" && props.initialData) {
        return {
          ...DEFAULT_FORM_DATA,
          ...props.initialData,
        };
      }
      return DEFAULT_FORM_DATA;
    });
    ```

    **2. Conditional submit button text:**
    ```tsx
    <Button type="submit">
      {props.mode === "edit" ? "Mettre à jour" : "Créer"}
    </Button>
    ```

    **3. Handle arrays hydration:**
    If initialData has phones/emails/websites/customFields arrays, hydrate them:
    ```typescript
    const [phones, setPhones] = useState(() =>
      props.initialData?.phones || []
    );
    ```

    **4. Music profile fields:**
    Ensure Step 3 (MusicProfileSection) receives initialData and hydrates genres/instruments/etc.
  </action>
  <verify>
    Wizard hydrates all fields in edit mode
    Arrays (phones, emails, etc.) populate correctly
    Music profile fields (genres, instruments) populate
    Submit calls onSubmit(formData) with complete data
    `pnpm --filter client check` passes
  </verify>
  <done>
    ClientFormWizard handles edit mode, hydrates all ~60 fields, submits updates correctly
  </done>
</task>

<task type="auto">
  <name>Build and validate edit mode</name>
  <files>packages/client/, packages/server/</files>
  <action>
    Run build to validate:

    ```bash
    pnpm --filter server check
    pnpm --filter client check
    pnpm --filter client build
    ```

    Fix any TypeScript errors.
    Test edit flow:
    1. Navigate to client detail
    2. Click Edit button
    3. Wizard renders with hydrated data
    4. Modify fields in all 3 steps
    5. Submit
    6. Verify client updated in database
  </action>
  <verify>
    `pnpm check` exits 0 for both server and client
    `pnpm --filter client build` succeeds
    Edit mode wizard hydrates correctly
    Updating client works end-to-end
  </verify>
  <done>
    Edit mode fully functional with wizard, all packages build successfully
  </done>
</task>

</tasks>

<verification>
Overall checks:
- clients.update mutation accepts all fields (basic + enriched + music)
- ClientDetail edit mode renders ClientFormWizard
- Wizard hydrates all ~60 fields in edit mode
- Arrays (phones, emails, websites) hydrate correctly
- Music profile fields (genres, instruments, streaming URLs) hydrate
- Submitting wizard updates client successfully
- Cancel button exits edit mode
- Notes section visible in edit mode
- TypeScript compilation passes
</verification>

<success_criteria>
- clients.update mutation input schema includes all 22 music fields
- ClientDetail edit mode uses ClientFormWizard component
- Wizard hydrates with client data (all fields populated)
- Edit flow works: Edit button → wizard → modify → submit → client updated
- Cancel button exits edit mode without saving
- Notes section always visible (even in edit mode)
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-09-SUMMARY.md`
</output>
