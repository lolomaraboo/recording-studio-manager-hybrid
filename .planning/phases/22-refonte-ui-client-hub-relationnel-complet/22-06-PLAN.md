---
phase: 22-refonte-ui-client-hub-relationnel-complet
plan: 06
type: execute
wave: 2
depends_on: ["22-02"]
files_modified:
  - packages/server/src/routers/clients.ts
  - packages/client/src/components/tabs/FinancesTab.tsx
  - packages/client/src/components/ClientDetailTabs.tsx
autonomous: true

must_haves:
  truths:
    - Backend returns financial stats (total paid, pending, quotes open, projection)
    - Finances tab shows 3 sections: Stats cards, Factures table, Quotes table
    - Factures and Quotes each have 4 view modes: Table, Cards, Timeline, Kanban
    - Toggle buttons switch between modes independently for each section
    - Empty states show illustrations + CTA buttons
  artifacts:
    - path: packages/server/src/routers/clients.ts
      provides: getFinancialStats endpoint
      contains: "getFinancialStats"
    - path: packages/client/src/components/tabs/FinancesTab.tsx
      provides: Finances tab with stats + 2 tables (Factures/Quotes)
      min_lines: 250
      exports: ["FinancesTab"]
  key_links:
    - from: packages/client/src/components/tabs/FinancesTab.tsx
      to: "@/lib/trpc"
      via: "clients.getFinancialStats query"
      pattern: "trpc\\.clients\\.getFinancialStats"
---

<objective>
Implement Finances tab with stats cards + Factures/Quotes tables (each with 4 view modes).

Purpose: Provide comprehensive financial overview for client
Output: Financial dashboard with stats + dual tables with view mode toggles
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-CONTEXT.md
@packages/server/src/routers/invoices.ts
@packages/server/src/routers/quotes.ts
</context>

<tasks>

<task type="auto">
  <name>Add getFinancialStats endpoint to clients router</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
    Add new procedure to clients router:

    ```typescript
    getFinancialStats: protectedProcedure
      .input(z.object({ clientId: z.number() }))
      .query(async ({ ctx, input }) => {
        const tenantDb = await ctx.getTenantDb();

        // Get all invoices for this client
        const invoices = await tenantDb.query.invoices.findMany({
          where: eq(invoices.clientId, input.clientId),
        });

        // Get all quotes for this client
        const quotes = await tenantDb.query.quotes.findMany({
          where: eq(quotes.clientId, input.clientId),
        });

        // Calculate stats
        const totalPaid = invoices
          .filter(inv => inv.status === "paid")
          .reduce((sum, inv) => sum + parseFloat(inv.total || "0"), 0);

        const pending = invoices
          .filter(inv => inv.status === "sent" || inv.status === "overdue")
          .reduce((sum, inv) => sum + parseFloat(inv.total || "0"), 0);

        const quotesOpen = quotes
          .filter(q => q.status === "sent")
          .reduce((sum, q) => sum + parseFloat(q.total || "0"), 0);

        const projection = quotesOpen + pending; // Simplified projection

        return {
          totalPaid,
          pending,
          quotesOpen,
          projection,
        };
      }),
    ```

    Calculate: total paid (invoices), pending (sent/overdue invoices), quotes open (sent quotes), projection (quotes + pending).
  </action>
  <verify>
    Endpoint compiles without TypeScript errors
    `pnpm --filter server check` passes
    Query returns financial stats
  </verify>
  <done>
    clients.getFinancialStats endpoint exists and returns stats (totalPaid, pending, quotesOpen, projection)
  </done>
</task>

<task type="auto">
  <name>Create FinancesTab component with stats + dual tables</name>
  <files>packages/client/src/components/tabs/FinancesTab.tsx</files>
  <action>
    Create component with 3 sections:

    **Props:**
    - clientId: number
    - invoices: Invoice[] (passed from parent, already filtered)
    - quotes: Quote[] (passed from parent, filtered)

    **Query financial stats:**
    `const { data: stats } = trpc.clients.getFinancialStats.useQuery({ clientId })`

    **Section 1 - Stats Cards (top):**
    4 cards in grid (2x2 or 4x1):
    - Total payé: {stats.totalPaid}€ (green)
    - En attente: {stats.pending}€ (orange)
    - Quotes ouverts: {stats.quotesOpen}€ (blue)
    - Projection revenus: {stats.projection}€ (purple)

    **Section 2 - Factures Table:**
    **State:** invoicesViewMode: "table" | "cards" | "timeline" | "kanban" (default: "table")
    **Toggle:** 4 buttons for view mode
    **4 modes:**
    1. Table: Numéro | Date | Montant | Statut | Actions
    2. Cards: Card with large numero, montant XXX€, status badge, date
    3. Timeline: Chronological by date d'émission
    4. Kanban: Columns [Brouillon] [Envoyé] [Payé] [En retard] [Annulé]

    **Section 3 - Quotes Table:**
    **State:** quotesViewMode: "table" | "cards" | "timeline" | "kanban" (default: "table")
    **Toggle:** 4 buttons for view mode
    **4 modes:** Same structure as Factures
    1. Table: Numéro | Date | Montant | Statut | Actions
    2. Cards: Similar to invoices
    3. Timeline: Chronological
    4. Kanban: Columns by status

    **Empty States:**
    If no invoices: "Aucune facture pour ce client" + [Créer une facture]
    If no quotes: "Aucun devis pour ce client" + [Créer un devis]

    Use localStorage for persistence: `invoices-view-mode`, `quotes-view-mode`
  </action>
  <verify>
    Component renders 3 sections
    Stats cards display financial metrics
    Factures table shows 4 view modes
    Quotes table shows 4 view modes independently
    localStorage persists both view modes
    Empty states show CTA buttons
    `pnpm --filter client check` passes
  </verify>
  <done>
    FinancesTab component exists with stats cards + Factures/Quotes tables (each with 4 modes)
  </done>
</task>

<task type="auto">
  <name>Integrate FinancesTab into ClientDetailTabs</name>
  <files>packages/client/src/components/ClientDetailTabs.tsx</files>
  <action>
    Replace existing invoices table with FinancesTab component:

    ```tsx
    import { FinancesTab } from "./tabs/FinancesTab";

    // In TabsContent for "finances":
    <TabsContent value="finances">
      <FinancesTab
        clientId={clientId}
        invoices={clientInvoices}
        quotes={clientQuotes}
      />
    </TabsContent>
    ```

    Pass already-filtered invoices and quotes from parent (ClientDetail.tsx).
    Add quotes query in ClientDetail if not already present:
    `const { data: quotes } = trpc.quotes.list.useQuery({ limit: 100 })`
  </action>
  <verify>
    Finances tab shows FinancesTab component
    Stats cards render with financial metrics
    Factures view modes toggle correctly
    Quotes view modes toggle independently
    No console errors
    `pnpm --filter client dev` runs without errors
  </verify>
  <done>
    ClientDetailTabs renders functional FinancesTab component on finances tab with stats + dual tables
  </done>
</task>

</tasks>

<verification>
Overall checks:
- Backend returns financial stats (totalPaid, pending, quotesOpen, projection)
- Finances tab shows 3 sections: stats cards, Factures table, Quotes table
- Stats cards display 4 metrics
- Factures table has 4 view mode buttons (Table, Cards, Timeline, Kanban)
- Quotes table has 4 view mode buttons (independent of Factures)
- Both view modes persisted in localStorage separately
- Empty states show illustrations + CTA buttons
- Clicking invoice/quote navigates to detail page
- TypeScript compilation passes
</verification>

<success_criteria>
- clients.getFinancialStats endpoint returns financial metrics
- FinancesTab component has stats cards + 2 tables
- Factures table has 4 view modes (Table, Cards, Timeline, Kanban)
- Quotes table has 4 view modes (independent toggle)
- Both view modes persisted in localStorage
- Empty states show illustrations + CTA buttons
- Clicking invoice navigates to /invoices/{id}
- Clicking quote navigates to /quotes/{id}
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-06-SUMMARY.md`
</output>
