---
phase: 22-refonte-ui-client-hub-relationnel-complet
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/components/ClientFormSections.tsx
  - packages/client/src/pages/ClientCreate.tsx
autonomous: true

must_haves:
  truths:
    - "Client creation form organized into logical sections (Base/Contact/Music/Address)"
    - "Music profile fields visible and editable during creation"
    - "Form validation works for all 22+ fields"
    - "Form data persists correctly to database"
  artifacts:
    - path: "packages/client/src/components/ClientFormSections.tsx"
      provides: "Reusable form sections component"
      min_lines: 200
      exports: ["ClientFormSections"]
    - path: "packages/client/src/pages/ClientCreate.tsx"
      provides: "Updated creation page using new sections"
      contains: "ClientFormSections"
  key_links:
    - from: "ClientFormSections.tsx"
      to: "music-presets.ts"
      via: "import genres/instruments"
      pattern: "import.*music-presets"
    - from: "ClientCreate.tsx"
      to: "clients.create mutation"
      via: "trpc mutation with music fields"
      pattern: "trpc\\.clients\\.create"
---

<objective>
Create reusable ClientFormSections component with organized layout for all 22+ music profile fields

Purpose: Improve UX for client creation/modification by grouping related fields into collapsible sections (Base Info, Contact, Music Profile, Address, Additional)

Output: ClientFormSections component that can be used in both ClientCreate.tsx and future ClientDetail edit mode
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18.4-music-profile-for-artists/18.4-02-SUMMARY.md
@packages/client/src/pages/ClientCreate.tsx
@packages/client/src/components/MusicProfileSection.tsx
@packages/client/src/lib/music-presets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClientFormSections component with organized layout</name>
  <files>packages/client/src/components/ClientFormSections.tsx</files>
  <action>
Create new ClientFormSections.tsx component that organizes client form fields into collapsible sections:

**Component structure:**
- Props: formData (object), setFormData (setter), phones/emails/websites/customFields arrays + setters, errors (validation object)
- Sections using Collapsible component from shadcn:
  1. **Section "Identité"** (always open by default):
     - Type selector (individual/company)
     - For individual: firstName, lastName, middleName, prefix, suffix, artistName
     - For company: companyName, industry, registrationNumber
  2. **Section "Contact"**:
     - Email, phone (simple fields for backward compat)
     - Phones array (type + number) with add/remove
     - Emails array (type + email) with add/remove
     - Websites array (type + url) with add/remove
  3. **Section "Profil Musical"** (use MusicProfileSection pattern):
     - Genres multi-select (from FLAT_GENRES)
     - Instruments multi-select (from FLAT_INSTRUMENTS)
     - Streaming platforms (11 URL fields: Spotify, Apple Music, YouTube, SoundCloud, Bandcamp, Deezer, Tidal, Amazon Music, Napster, Qobuz, Custom)
     - Industry contacts: label, distributor, manager, publisher, performanceRightsSociety
     - Career fields: yearsActive, majorReleases, awardsRecognition
  4. **Section "Adresse"**:
     - street, city, postalCode, region, country
  5. **Section "Informations Additionnelles"**:
     - birthday, gender, notes
     - customFields array (label + value) with add/remove

**Key patterns:**
- Use localStorage to persist section open/closed state (pattern: `client-form-section-{name}-state`)
- Follow EnrichedClientInfo/MusicProfileSection patterns for controlled inputs
- Validation errors displayed inline with Input error state
- Empty state helpers for array fields (e.g., "Ajouter un téléphone" button)

**Import MultiSelect from existing component:**
```typescript
import { MultiSelect } from "@/components/ui/multi-select";
import { FLAT_GENRES, FLAT_INSTRUMENTS } from "@/lib/music-presets";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
```

**Why organized sections:** Phase 18.4 added 22 music fields but creation form became overwhelming (single page, 60+ fields visible). Collapsible sections reduce cognitive load while keeping all fields accessible.
  </action>
  <verify>
```bash
# TypeScript compilation passes
cd packages/client && npx tsc --noEmit

# Component exports correctly
grep -q "export.*ClientFormSections" packages/client/src/components/ClientFormSections.tsx
```
  </verify>
  <done>ClientFormSections.tsx created with 5 collapsible sections, localStorage state persistence, validation error display, ~250+ lines</done>
</task>

<task type="auto">
  <name>Task 2: Refactor ClientCreate.tsx to use ClientFormSections</name>
  <files>packages/client/src/pages/ClientCreate.tsx</files>
  <action>
Update ClientCreate.tsx to use new ClientFormSections component:

**Changes required:**
1. Import ClientFormSections component
2. Remove individual form field JSX (currently 4-tab structure lines 69-600+)
3. Replace with single `<ClientFormSections>` component call
4. Pass formData, setFormData, array state, and validation errors as props
5. Keep existing mutation logic and handleSubmit unchanged
6. Remove Tabs component (no longer needed - sections handle organization)
7. Update page title from 4 tabs to single "Créer un Client" header

**Result structure:**
```tsx
<div className="container pt-2 pb-4 px-2">
  <div className="flex items-center gap-2 mb-4">
    <ArrowLeft />
    <h1>Créer un Client</h1>
  </div>
  <Card>
    <CardHeader>
      <CardTitle>Informations Client</CardTitle>
    </CardHeader>
    <CardContent>
      <ClientFormSections
        formData={formData}
        setFormData={setFormData}
        phones={phones}
        setPhones={setPhones}
        emails={emails}
        setEmails={setEmails}
        websites={websites}
        setWebsites={setWebsites}
        customFields={customFields}
        setCustomFields={setCustomFields}
        errors={{}}
      />
      <div className="mt-6 flex gap-2">
        <Button onClick={handleSubmit}>Créer</Button>
        <Button variant="outline" onClick={() => navigate("/clients")}>Annuler</Button>
      </div>
    </CardContent>
  </Card>
</div>
```

**Why this refactor:** Removes 500+ lines of duplicated form JSX, makes form reusable for future ClientDetail edit mode (Plan 22-03), maintains all existing functionality with cleaner architecture.
  </action>
  <verify>
```bash
# Build passes
cd packages/client && pnpm build

# No TypeScript errors
pnpm check

# Test creation flow manually:
# 1. Start dev server
# 2. Navigate to /clients/new
# 3. All 5 sections visible and collapsible
# 4. Fill minimal fields (firstName, lastName OR companyName)
# 5. Submit → client created successfully
```
  </verify>
  <done>ClientCreate.tsx refactored to use ClientFormSections, ~200 lines removed, form still functional, build passes with 0 errors</done>
</task>

<task type="auto">
  <name>Task 3: Add music fields to clients.create mutation payload</name>
  <files>packages/client/src/pages/ClientCreate.tsx</files>
  <action>
Update handleSubmit function in ClientCreate.tsx to include music profile fields in mutation payload:

**Current payload:** Basic fields (name, email, phone, address, etc.)

**Add to payload:**
```typescript
const createMutation = trpc.clients.create.useMutation({
  onSuccess: (data) => {
    toast.success("Client créé avec succès");
    navigate(`/clients/${data.id}`);
  },
});

const handleSubmit = () => {
  createMutation.mutate({
    // Existing fields...
    name: formData.name,
    type: formData.type,
    email: formData.email,
    phone: formData.phone,
    // ... other existing fields ...

    // NEW: Music profile fields
    genres: formData.genres || [], // JSONB array
    instruments: formData.instruments || [], // JSONB array
    vocalRange: formData.vocalRange || null,
    skillLevel: formData.skillLevel || null,

    // NEW: Streaming platforms (11 fields)
    spotifyUrl: formData.spotifyUrl || null,
    appleMusicUrl: formData.appleMusicUrl || null,
    youtubeUrl: formData.youtubeUrl || null,
    soundcloudUrl: formData.soundcloudUrl || null,
    bandcampUrl: formData.bandcampUrl || null,
    deezerUrl: formData.deezerUrl || null,
    tidalUrl: formData.tidalUrl || null,
    amazonMusicUrl: formData.amazonMusicUrl || null,
    napsterUrl: formData.napsterUrl || null,
    qobuzUrl: formData.qobuzUrl || null,
    customStreamingUrl: formData.customStreamingUrl || null,

    // NEW: Industry contacts (5 fields)
    label: formData.label || null,
    distributor: formData.distributor || null,
    manager: formData.manager || null,
    publisher: formData.publisher || null,
    performanceRightsSociety: formData.performanceRightsSociety || null,

    // NEW: Career info (3 fields)
    yearsActive: formData.yearsActive || null,
    majorReleases: formData.majorReleases || null,
    awardsRecognition: formData.awardsRecognition || null,
  });
};
```

**Also update formData initial state:** Add all 22 music fields to initial useState (lines 27-60) with empty/null defaults.

**Why include in creation:** Users should be able to populate music fields immediately during client creation, not forced to create → edit → add music data. Single workflow improves UX.
  </action>
  <verify>
```bash
# Test creation with music fields:
# 1. Fill form including genres ["Rock", "Pop"], instruments ["Guitar", "Piano"]
# 2. Add Spotify URL: https://spotify.com/artist/test
# 3. Submit form
# 4. Navigate to created client detail page
# 5. Verify music profile tab shows entered data

# Backend logs should show mutation received all fields
# Database should store JSONB arrays correctly
```
  </verify>
  <done>Music fields added to mutation payload, formData state updated, clients can be created with complete music profiles in single step</done>
</task>

</tasks>

<verification>
**Functional checks:**
- [ ] ClientFormSections component renders 5 collapsible sections
- [ ] Section state persists in localStorage across page refreshes
- [ ] ClientCreate.tsx imports and uses ClientFormSections successfully
- [ ] Music profile fields (genres, instruments, streaming URLs) visible in creation form
- [ ] Form submission includes all 22 music fields in payload
- [ ] Created client record includes music data in database

**Code quality:**
- [ ] TypeScript compilation passes with 0 errors
- [ ] Client package builds successfully
- [ ] No console errors during form interaction
- [ ] Component follows established patterns (EnrichedClientInfo, MusicProfileSection)

**Regression testing:**
- [ ] Minimal client creation still works (firstName + lastName only)
- [ ] Company creation works (type=company fields)
- [ ] Existing non-music fields still submit correctly
</verification>

<success_criteria>
- ClientFormSections component created with organized collapsible sections
- ClientCreate.tsx refactored to use new component (~200 lines removed)
- Music profile fields fully integrated into creation workflow
- Form validation works for all fields
- Client creation with music data works end-to-end
- Build passes, TypeScript has 0 errors
- Zero regressions on existing creation functionality
</success_criteria>

<output>
After completion, create `.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-01-SUMMARY.md`
</output>
