---
phase: 22-refonte-ui-client-hub-relationnel-complet
plan: 08
type: execute
wave: 4
depends_on: ["22-03", "22-04", "22-05", "22-06", "22-07"]
files_modified:
  - packages/client/src/components/tabs/ProjectsTab.tsx
  - packages/client/src/components/tabs/TracksTab.tsx
  - packages/client/src/components/tabs/SessionsTab.tsx
  - packages/client/src/components/tabs/FinancesTab.tsx
  - packages/client/src/hooks/useTabPreferences.ts
autonomous: true

must_haves:
  truths:
    - Each tab loads preferences from database on mount
    - View mode saved to database when changed
    - Columns visibility toggled via UI (checkboxes/dropdown)
    - Column order changed via drag & drop
    - Preferences persist across devices (same user)
    - Reset button restores default preferences
  artifacts:
    - path: packages/client/src/hooks/useTabPreferences.ts
      provides: Reusable hook for tab preferences
      min_lines: 50
      exports: ["useTabPreferences"]
    - path: packages/client/src/components/tabs/ProjectsTab.tsx
      provides: Projects tab with customization UI
      contains: "useTabPreferences"
  key_links:
    - from: packages/client/src/hooks/useTabPreferences.ts
      to: "@/lib/trpc"
      via: "preferences.get and preferences.save mutations"
      pattern: "trpc\\.preferences\\.(get|save)"
---

<objective>
Implement frontend customization UI for all tabs: columns visibility toggle, drag & drop reordering, database sync.

Purpose: Enable user customization with cross-device persistence
Output: Customization controls in all 4 tabs (Projets, Tracks, Sessions, Finances)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-CONTEXT.md
@packages/client/src/components/tabs/ProjectsTab.tsx
@packages/client/src/components/tabs/TracksTab.tsx
@packages/client/src/components/tabs/SessionsTab.tsx
@packages/client/src/components/tabs/FinancesTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Create useTabPreferences hook</name>
  <files>packages/client/src/hooks/useTabPreferences.ts</files>
  <action>
    Create reusable hook for tab preferences:

    ```typescript
    import { useState, useEffect } from "react";
    import { trpc } from "@/lib/trpc";

    interface TabPreferences {
      viewMode: string;
      visibleColumns: string[];
      columnOrder: string[];
      sortBy?: string;
      sortOrder?: "asc" | "desc";
    }

    export function useTabPreferences(scope: string, defaults: TabPreferences) {
      const [preferences, setPreferences] = useState<TabPreferences>(defaults);
      const [isLoading, setIsLoading] = useState(true);

      // Load preferences from database
      const { data: savedPrefs } = trpc.preferences.get.useQuery({ scope });

      useEffect(() => {
        if (savedPrefs) {
          setPreferences({ ...defaults, ...savedPrefs });
        }
        setIsLoading(false);
      }, [savedPrefs]);

      // Save preferences mutation
      const saveMutation = trpc.preferences.save.useMutation();

      const updatePreferences = (updates: Partial<TabPreferences>) => {
        const newPrefs = { ...preferences, ...updates };
        setPreferences(newPrefs);
        saveMutation.mutate({ scope, preferences: newPrefs });
      };

      const resetPreferences = () => {
        setPreferences(defaults);
        saveMutation.mutate({ scope, preferences: defaults });
      };

      return {
        preferences,
        updatePreferences,
        resetPreferences,
        isLoading,
      };
    }
    ```

    Hook handles:
    - Loading preferences from database
    - Local state management
    - Saving changes to database
    - Resetting to defaults
  </action>
  <verify>
    Hook compiles without TypeScript errors
    `pnpm --filter client check` passes
  </verify>
  <done>
    useTabPreferences hook exists and provides preferences, updatePreferences, resetPreferences
  </done>
</task>

<task type="auto">
  <name>Add customization UI to all tabs</name>
  <files>
    packages/client/src/components/tabs/ProjectsTab.tsx
    packages/client/src/components/tabs/TracksTab.tsx
    packages/client/src/components/tabs/SessionsTab.tsx
    packages/client/src/components/tabs/FinancesTab.tsx
  </files>
  <action>
    For EACH tab component, add customization UI:

    **1. Replace localStorage with useTabPreferences:**
    ```typescript
    // OLD:
    const [viewMode, setViewMode] = useState(localStorage.getItem("...") || "cards");

    // NEW:
    const { preferences, updatePreferences, resetPreferences } = useTabPreferences(
      "client-detail-projects", // scope
      {
        viewMode: "cards",
        visibleColumns: ["title", "status", "budget", "date"],
        columnOrder: ["title", "status", "budget", "date"],
      }
    );
    ```

    **2. Add Customization Dropdown (above view mode toggle):**
    Use shadcn/ui DropdownMenu:
    ```tsx
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" size="sm">
          <Settings className="h-4 w-4" /> Personnaliser
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-56">
        <DropdownMenuLabel>Colonnes visibles</DropdownMenuLabel>
        <DropdownMenuSeparator />
        {ALL_COLUMNS.map(col => (
          <DropdownMenuCheckboxItem
            key={col}
            checked={preferences.visibleColumns.includes(col)}
            onCheckedChange={(checked) => {
              const updated = checked
                ? [...preferences.visibleColumns, col]
                : preferences.visibleColumns.filter(c => c !== col);
              updatePreferences({ visibleColumns: updated });
            }}
          >
            {col}
          </DropdownMenuCheckboxItem>
        ))}
        <DropdownMenuSeparator />
        <DropdownMenuItem onClick={resetPreferences}>
          RÃ©initialiser
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
    ```

    **3. Column drag & drop (Table mode only):**
    Use @dnd-kit/core library (install if needed):
    ```bash
    pnpm --filter client add @dnd-kit/core @dnd-kit/sortable
    ```

    Wrap table headers in DndContext and SortableContext:
    ```tsx
    import { DndContext, closestCenter } from "@dnd-kit/core";
    import { SortableContext, horizontalListSortingStrategy, useSortable } from "@dnd-kit/sortable";

    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      <SortableContext items={preferences.columnOrder} strategy={horizontalListSortingStrategy}>
        <TableRow>
          {preferences.columnOrder.map(col => (
            <SortableTableHeader key={col} id={col}>
              {col}
            </SortableTableHeader>
          ))}
        </TableRow>
      </SortableContext>
    </DndContext>

    function handleDragEnd(event) {
      const { active, over } = event;
      if (active.id !== over.id) {
        const oldIndex = preferences.columnOrder.indexOf(active.id);
        const newIndex = preferences.columnOrder.indexOf(over.id);
        const newOrder = arrayMove(preferences.columnOrder, oldIndex, newIndex);
        updatePreferences({ columnOrder: newOrder });
      }
    }
    ```

    **4. Update view mode toggle to use preferences:**
    ```typescript
    onClick={() => updatePreferences({ viewMode: "cards" })}
    ```

    Apply changes to ALL 4 tabs:
    - ProjectsTab.tsx (scope: "client-detail-projects")
    - TracksTab.tsx (scope: "client-detail-tracks")
    - SessionsTab.tsx (scope: "client-detail-sessions")
    - FinancesTab.tsx (2 scopes: "client-detail-finances-invoices", "client-detail-finances-quotes")

    **Note:** FinancesTab has 2 tables, so use useTabPreferences twice with different scopes.
  </action>
  <verify>
    All tabs use useTabPreferences hook
    Customization dropdown renders correctly
    Toggling column visibility works
    Drag & drop reorders columns (Table mode)
    Reset button restores defaults
    Preferences persist across page refresh
    `pnpm --filter client check` passes
  </verify>
  <done>
    All 4 tabs have customization UI (columns toggle, drag & drop, reset), preferences saved to database
  </done>
</task>

<task type="auto">
  <name>Build and validate customization</name>
  <files>packages/client/</files>
  <action>
    Run build to validate:

    ```bash
    pnpm --filter client check
    pnpm --filter client build
    ```

    Fix any TypeScript errors.
    Test drag & drop functionality in dev mode.
  </action>
  <verify>
    `pnpm --filter client check` exits 0
    `pnpm --filter client build` succeeds
    Drag & drop works smoothly
    Preferences sync to database
  </verify>
  <done>
    Client package builds with customization UI, drag & drop functional
  </done>
</task>

</tasks>

<verification>
Overall checks:
- useTabPreferences hook loads/saves preferences from database
- All tabs (Projets, Tracks, Sessions, Finances) have customization dropdown
- Columns visibility toggled via checkboxes
- Column order changed via drag & drop (Table mode)
- Reset button restores default preferences
- View mode saved to database when changed
- Preferences persist across devices (database-backed)
- TypeScript compilation passes
</verification>

<success_criteria>
- useTabPreferences hook exists and manages preferences state
- All 4 tabs use hook with appropriate scope
- Customization dropdown shows columns checkboxes
- Toggling columns updates visibility and saves to database
- Drag & drop reorders columns (Table mode)
- Reset button works and saves defaults to database
- Preferences load from database on mount
- Cross-device synchronization works (same user sees same preferences)
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-08-SUMMARY.md`
</output>
