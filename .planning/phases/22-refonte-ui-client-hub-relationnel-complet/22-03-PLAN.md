---
phase: 22-refonte-ui-client-hub-relationnel-complet
plan: 03
type: execute
wave: 2
depends_on: ["22-02"]
files_modified:
  - packages/server/src/routers/clients.ts
  - packages/client/src/components/tabs/ProjectsTab.tsx
  - packages/client/src/components/ClientDetailTabs.tsx
autonomous: true

must_haves:
  truths:
    - Backend returns client's projects with stats (tracks count, hours, budget)
    - Projects tab shows 4 view modes: Cards, Liste, Table, Kanban
    - Toggle buttons switch between modes
    - Default mode is Cards
    - Empty state shows illustration + CTA button
  artifacts:
    - path: packages/server/src/routers/clients.ts
      provides: getProjects endpoint
      contains: "getProjects"
    - path: packages/client/src/components/tabs/ProjectsTab.tsx
      provides: Projects tab with 4 view modes
      min_lines: 150
      exports: ["ProjectsTab"]
  key_links:
    - from: packages/client/src/components/tabs/ProjectsTab.tsx
      to: "@/lib/trpc"
      via: "clients.getProjects query"
      pattern: "trpc\\.clients\\.getProjects"
---

<objective>
Implement Projets tab with 4 display modes (Cards, Liste, Table, Kanban) and backend query.

Purpose: Display client's projects with multiple viewing options
Output: Functional projects tab with view mode toggle + empty state CTA
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-CONTEXT.md
@packages/server/src/routers/projects.ts
</context>

<tasks>

<task type="auto">
  <name>Add getProjects endpoint to clients router</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
    Add new procedure to clients router:

    ```typescript
    getProjects: protectedProcedure
      .input(z.object({ clientId: z.number() }))
      .query(async ({ ctx, input }) => {
        const tenantDb = await ctx.getTenantDb();

        // Query projects for this client with aggregated stats
        const projects = await tenantDb.query.projects.findMany({
          where: eq(projects.clientId, input.clientId),
          with: {
            tracks: true, // For counting tracks
            sessions: true, // For counting hours
          },
        });

        // Calculate stats per project
        return projects.map(project => ({
          ...project,
          tracksCount: project.tracks?.length || 0,
          hoursRecorded: project.sessions?.reduce((sum, s) => sum + (s.duration || 0), 0) || 0,
        }));
      }),
    ```

    Reuse existing projects table schema. Add aggregated stats (tracksCount, hoursRecorded) in response.
  </action>
  <verify>
    Endpoint compiles without TypeScript errors
    `pnpm --filter server check` passes
    Query returns projects with stats
  </verify>
  <done>
    clients.getProjects endpoint exists and returns projects with aggregated stats
  </done>
</task>

<task type="auto">
  <name>Create ProjectsTab component with 4 view modes</name>
  <files>packages/client/src/components/tabs/ProjectsTab.tsx</files>
  <action>
    Create component with 4 display modes:

    **Props:** clientId: number

    **State:**
    - viewMode: "cards" | "liste" | "table" | "kanban" (default: "cards")
    - Use localStorage for persistence: `localStorage.getItem("projects-view-mode")`

    **View Mode Toggle:**
    Button group with 4 buttons (lucide icons: LayoutGrid, List, Table2, Trello)

    **Mode 1 - Cards (default):**
    Grid layout (2-3 cols) with project cards:
    - Title (h3)
    - Status badge (colored: Planifié/En cours/Mixing/Mastering/Livré)
    - Stats: "{tracksCount} tracks • {hoursRecorded}h • {budget}€/{spent}€"
    - Click → navigate to `/projects/${id}`

    **Mode 2 - Liste:**
    Simple list:
    - Title | Status badge | Date | Link "Voir"

    **Mode 3 - Table:**
    Full table with columns: Titre | Statut | Tracks | Sessions | Budget | Genre | Date | Actions

    **Mode 4 - Kanban:**
    Columns by status: [Planifié] [En cours] [Mixing] [Mastering] [Livré]
    Drag & drop NOT required (nice-to-have for future)

    **Empty State:**
    If no projects:
    ```tsx
    <div className="py-6 text-center">
      <FolderOpen className="h-12 w-12 mx-auto text-muted-foreground" />
      <p>Aucun projet pour ce client</p>
      <Button onClick={() => navigate(`/projects/new?clientId=${clientId}`)}>
        Créer un projet
      </Button>
    </div>
    ```

    Use: trpc.clients.getProjects.useQuery({ clientId })
  </action>
  <verify>
    Component renders 4 view modes
    Toggle buttons switch modes correctly
    localStorage persists view mode selection
    Empty state shows CTA button
    `pnpm --filter client check` passes
  </verify>
  <done>
    ProjectsTab component exists with 4 modes, toggle, empty state, navigation to project detail
  </done>
</task>

<task type="auto">
  <name>Integrate ProjectsTab into ClientDetailTabs</name>
  <files>packages/client/src/components/ClientDetailTabs.tsx</files>
  <action>
    Replace "projets" tab placeholder with actual component:

    ```tsx
    import { ProjectsTab } from "./tabs/ProjectsTab";

    // In TabsContent for "projets":
    <TabsContent value="projets">
      <ProjectsTab clientId={clientId} />
    </TabsContent>
    ```

    Remove placeholder text "Onglet Projets - À implémenter".
  </action>
  <verify>
    Projets tab shows ProjectsTab component
    View modes toggle correctly
    No console errors
    `pnpm --filter client dev` runs without errors
  </verify>
  <done>
    ClientDetailTabs renders functional ProjectsTab component on projets tab
  </done>
</task>

</tasks>

<verification>
Overall checks:
- Backend returns projects with stats (tracks count, hours)
- Projets tab shows 4 view mode buttons
- Cards mode (default) displays project cards with stats
- Liste/Table/Kanban modes render correctly
- Empty state shows folder icon + "Créer un projet" button
- View mode persisted in localStorage
- Clicking project card navigates to project detail
- TypeScript compilation passes
</verification>

<success_criteria>
- clients.getProjects endpoint returns projects with aggregated stats
- ProjectsTab component has 4 view modes (Cards, Liste, Table, Kanban)
- Toggle buttons switch between modes, selection persisted in localStorage
- Empty state shows illustration + CTA button that navigates to project creation
- Clicking project navigates to /projects/{id}
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-03-SUMMARY.md`
</output>
