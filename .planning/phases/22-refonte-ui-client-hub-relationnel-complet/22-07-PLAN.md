---
phase: 22-refonte-ui-client-hub-relationnel-complet
plan: 07
type: execute
wave: 3
depends_on: ["22-03", "22-04", "22-05", "22-06"]
files_modified:
  - packages/database/src/tenant/schema.ts
  - packages/database/drizzle/migrations/tenant/
  - packages/server/src/routers/preferences.ts
  - packages/server/src/routers/index.ts
autonomous: true

must_haves:
  truths:
    - User preferences stored in database (not localStorage)
    - Preferences synchronized cross-device
    - Each tab has customizable column visibility
    - Each tab has customizable column order (drag & drop)
    - Preferences saved per user per tab
  artifacts:
    - path: packages/database/src/tenant/schema.ts
      provides: user_preferences table
      contains: "user_preferences"
    - path: packages/server/src/routers/preferences.ts
      provides: Preferences tRPC router
      min_lines: 50
      exports: ["preferencesRouter"]
  key_links:
    - from: packages/server/src/routers/preferences.ts
      to: packages/database/src/tenant/schema.ts
      via: "query user_preferences table"
      pattern: "user_preferences"
---

<objective>
Implement database-backed user preferences storage for tab customization (columns visibility, order).

Purpose: Enable cross-device synchronization of view preferences
Output: Preferences backend infrastructure with tRPC router
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-CONTEXT.md
@packages/database/src/tenant/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Create user_preferences table schema</name>
  <files>packages/database/src/tenant/schema.ts</files>
  <action>
    Add new table to tenant schema:

    ```typescript
    export const userPreferences = pgTable("user_preferences", {
      id: serial("id").primaryKey(),
      userId: integer("user_id").notNull().references(() => users.id, { onDelete: "cascade" }),
      scope: varchar("scope", { length: 100 }).notNull(), // e.g., "client-detail-projects", "client-detail-tracks"
      preferences: jsonb("preferences").notNull(), // { viewMode: "cards", columns: [...], columnOrder: [...] }
      createdAt: timestamp("created_at").notNull().defaultNow(),
      updatedAt: timestamp("updated_at").notNull().defaultNow(),
    });

    // Add unique constraint: one preference row per user per scope
    // In table definition:
    // .unique("user_scope_unique", ["userId", "scope"])
    ```

    **JSONB structure example:**
    ```json
    {
      "viewMode": "cards",
      "visibleColumns": ["title", "status", "budget", "date"],
      "columnOrder": ["title", "status", "budget", "date"],
      "sortBy": "date",
      "sortOrder": "desc"
    }
    ```

    Scopes: "client-detail-projects", "client-detail-tracks", "client-detail-sessions", "client-detail-finances-invoices", "client-detail-finances-quotes"
  </action>
  <verify>
    Schema compiles without TypeScript errors
    Table definition includes unique constraint on (userId, scope)
    JSONB column can store preferences object
    `pnpm --filter database check` passes
  </verify>
  <done>
    user_preferences table exists in tenant schema with userId, scope, preferences JSONB column
  </done>
</task>

<task type="auto">
  <name>Generate migration for user_preferences</name>
  <files>packages/database/drizzle/migrations/tenant/</files>
  <action>
    Generate migration:

    ```bash
    pnpm --filter database db:generate
    ```

    This creates new migration file for user_preferences table.
    Review migration SQL to ensure:
    - Table created with correct columns
    - Unique constraint on (user_id, scope)
    - JSONB column type
    - Foreign key to users table with CASCADE delete

    If migration looks correct, commit it.
  </action>
  <verify>
    Migration file exists in drizzle/migrations/tenant/
    SQL creates user_preferences table
    Unique constraint present
    `pnpm --filter database db:migrate` applies migration successfully (test on tenant_1)
  </verify>
  <done>
    Migration generated and applied to tenant database
  </done>
</task>

<task type="auto">
  <name>Create preferences tRPC router</name>
  <files>packages/server/src/routers/preferences.ts, packages/server/src/routers/index.ts</files>
  <action>
    Create new router with CRUD operations:

    ```typescript
    import { router, protectedProcedure } from "../trpc";
    import { z } from "zod";
    import { eq, and } from "drizzle-orm";
    import { userPreferences } from "@rsm/database/tenant/schema";

    export const preferencesRouter = router({
      get: protectedProcedure
        .input(z.object({ scope: z.string() }))
        .query(async ({ ctx, input }) => {
          const tenantDb = await ctx.getTenantDb();
          const pref = await tenantDb.query.userPreferences.findFirst({
            where: and(
              eq(userPreferences.userId, ctx.userId),
              eq(userPreferences.scope, input.scope)
            ),
          });
          return pref?.preferences || null;
        }),

      save: protectedProcedure
        .input(z.object({
          scope: z.string(),
          preferences: z.any(), // JSONB object
        }))
        .mutation(async ({ ctx, input }) => {
          const tenantDb = await ctx.getTenantDb();

          // Upsert: update if exists, insert if not
          const existing = await tenantDb.query.userPreferences.findFirst({
            where: and(
              eq(userPreferences.userId, ctx.userId),
              eq(userPreferences.scope, input.scope)
            ),
          });

          if (existing) {
            await tenantDb
              .update(userPreferences)
              .set({
                preferences: input.preferences,
                updatedAt: new Date(),
              })
              .where(eq(userPreferences.id, existing.id));
          } else {
            await tenantDb.insert(userPreferences).values({
              userId: ctx.userId,
              scope: input.scope,
              preferences: input.preferences,
            });
          }

          return { success: true };
        }),

      reset: protectedProcedure
        .input(z.object({ scope: z.string() }))
        .mutation(async ({ ctx, input }) => {
          const tenantDb = await ctx.getTenantDb();
          await tenantDb
            .delete(userPreferences)
            .where(and(
              eq(userPreferences.userId, ctx.userId),
              eq(userPreferences.scope, input.scope)
            ));
          return { success: true };
        }),
    });
    ```

    **Add to main router:**
    In `packages/server/src/routers/index.ts`:
    ```typescript
    import { preferencesRouter } from "./preferences";

    export const appRouter = router({
      // ... existing routers
      preferences: preferencesRouter,
    });
    ```
  </action>
  <verify>
    Router compiles without TypeScript errors
    `pnpm --filter server check` passes
    GET endpoint returns preferences or null
    SAVE endpoint upserts preferences
    RESET endpoint deletes preferences
  </verify>
  <done>
    preferencesRouter exists with get, save, reset procedures, integrated into main router
  </done>
</task>

</tasks>

<verification>
Overall checks:
- user_preferences table exists in tenant database
- Migration applied successfully
- preferencesRouter integrated into tRPC app
- GET endpoint returns preferences by scope
- SAVE endpoint upserts preferences
- RESET endpoint deletes preferences
- Unique constraint on (userId, scope) prevents duplicates
- TypeScript compilation passes
</verification>

<success_criteria>
- user_preferences table in tenant schema with JSONB column
- Migration generated and applied
- preferencesRouter with get, save, reset procedures
- Preferences stored per user per scope
- Cross-device synchronization ready (backend infrastructure complete)
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-07-SUMMARY.md`
</output>
