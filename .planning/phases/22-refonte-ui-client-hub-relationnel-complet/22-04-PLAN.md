---
phase: 22-refonte-ui-client-hub-relationnel-complet
plan: 04
type: execute
wave: 2
depends_on: ["22-02"]
files_modified:
  - packages/server/src/routers/clients.ts
  - packages/client/src/components/tabs/TracksTab.tsx
  - packages/client/src/components/ClientDetailTabs.tsx
autonomous: true

must_haves:
  truths:
    - Backend returns client's tracks from all client projects
    - Tracks tab shows 3 view modes: Liste avec player, Cards visuelles, Table metadata
    - Toggle buttons switch between modes
    - Default mode is Liste avec player
    - Audio player works inline (play/pause)
    - Empty state shows illustration + CTA button
  artifacts:
    - path: packages/server/src/routers/clients.ts
      provides: getTracks endpoint
      contains: "getTracks"
    - path: packages/client/src/components/tabs/TracksTab.tsx
      provides: Tracks tab with 3 view modes + audio player
      min_lines: 150
      exports: ["TracksTab"]
  key_links:
    - from: packages/client/src/components/tabs/TracksTab.tsx
      to: "@/lib/trpc"
      via: "clients.getTracks query"
      pattern: "trpc\\.clients\\.getTracks"
---

<objective>
Implement Tracks tab with 3 display modes (Liste avec player, Cards, Table) and inline audio playback.

Purpose: Display client's tracks from all projects with audio preview
Output: Functional tracks tab with view mode toggle + audio player + empty state CTA
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-CONTEXT.md
@packages/server/src/routers/tracks.ts
@packages/client/src/components/AudioPlayer.tsx
</context>

<tasks>

<task type="auto">
  <name>Add getTracks endpoint to clients router</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
    Add new procedure to clients router:

    ```typescript
    getTracks: protectedProcedure
      .input(z.object({ clientId: z.number() }))
      .query(async ({ ctx, input }) => {
        const tenantDb = await ctx.getTenantDb();

        // Get all projects for this client
        const clientProjects = await tenantDb.query.projects.findMany({
          where: eq(projects.clientId, input.clientId),
        });

        if (clientProjects.length === 0) return [];

        const projectIds = clientProjects.map(p => p.id);

        // Get all tracks from these projects
        const tracks = await tenantDb.query.tracks.findMany({
          where: inArray(tracks.projectId, projectIds),
          with: {
            project: {
              columns: { title: true },
            },
            musicians: true, // For artist names
          },
        });

        return tracks.map(track => ({
          ...track,
          projectTitle: track.project?.title || "Sans projet",
          artistNames: track.musicians?.map(m => m.name).join(", ") || "Inconnu",
        }));
      }),
    ```

    Reuse existing tracks table schema. Return tracks with project title and artist names.
  </action>
  <verify>
    Endpoint compiles without TypeScript errors
    `pnpm --filter server check` passes
    Query returns tracks with project info
  </verify>
  <done>
    clients.getTracks endpoint exists and returns tracks with project title and artists
  </done>
</task>

<task type="auto">
  <name>Create TracksTab component with 3 view modes</name>
  <files>packages/client/src/components/tabs/TracksTab.tsx</files>
  <action>
    Create component with 3 display modes:

    **Props:** clientId: number

    **State:**
    - viewMode: "liste" | "cards" | "table" (default: "liste")
    - Use localStorage for persistence: `localStorage.getItem("tracks-view-mode")`

    **View Mode Toggle:**
    Button group with 3 buttons (lucide icons: ListMusic, LayoutGrid, Table2)

    **Mode 1 - Liste avec audio player (default):**
    List layout with inline player:
    ```tsx
    {tracks.map(track => (
      <div key={track.id} className="border-b py-2 flex items-center gap-4">
        <AudioPlayer audioUrl={track.fileUrl} /> {/* Mini player */}
        <div className="flex-1">
          <p className="font-medium">{track.title}</p>
          <p className="text-sm text-muted-foreground">
            {track.projectTitle} • {track.artistNames} • {track.duration}
          </p>
        </div>
        <Badge>{track.status}</Badge>
      </div>
    ))}
    ```

    **Mode 2 - Cards visuelles:**
    Grid layout (2-3 cols) with cards:
    - Artwork/Cover image (if available, else placeholder)
    - Title (h3)
    - Artists
    - Duration
    - Audio player + waveform (use existing AudioPlayer component)
    - Project parent link

    **Mode 3 - Table simple:**
    Table with columns: Titre | Projet | Artistes | Durée | Statut | Version | Actions
    No inline player (keep it simple)

    **Empty State:**
    If no tracks:
    ```tsx
    <div className="py-6 text-center">
      <Music className="h-12 w-12 mx-auto text-muted-foreground" />
      <p>Aucune track pour ce client</p>
      <Button onClick={() => navigate(`/tracks/new?clientId=${clientId}`)}>
        Créer une track
      </Button>
    </div>
    ```

    Use: trpc.clients.getTracks.useQuery({ clientId })
    Import AudioPlayer component from @/components/AudioPlayer
  </action>
  <verify>
    Component renders 3 view modes
    Toggle buttons switch modes correctly
    Audio player works (play/pause)
    localStorage persists view mode selection
    Empty state shows CTA button
    `pnpm --filter client check` passes
  </verify>
  <done>
    TracksTab component exists with 3 modes, audio player, toggle, empty state, navigation to track detail
  </done>
</task>

<task type="auto">
  <name>Integrate TracksTab into ClientDetailTabs</name>
  <files>packages/client/src/components/ClientDetailTabs.tsx</files>
  <action>
    Replace "tracks" tab placeholder with actual component:

    ```tsx
    import { TracksTab } from "./tabs/TracksTab";

    // In TabsContent for "tracks":
    <TabsContent value="tracks">
      <TracksTab clientId={clientId} />
    </TabsContent>
    ```

    Remove placeholder text "Onglet Tracks - À implémenter".
  </action>
  <verify>
    Tracks tab shows TracksTab component
    View modes toggle correctly
    Audio player plays tracks
    No console errors
    `pnpm --filter client dev` runs without errors
  </verify>
  <done>
    ClientDetailTabs renders functional TracksTab component on tracks tab with audio playback
  </done>
</task>

</tasks>

<verification>
Overall checks:
- Backend returns tracks from all client projects
- Tracks tab shows 3 view mode buttons
- Liste mode (default) displays tracks with inline audio player
- Cards mode shows artwork + player
- Table mode shows metadata without player
- Audio player works (play/pause functionality)
- Empty state shows music icon + "Créer une track" button
- View mode persisted in localStorage
- Clicking track navigates to track detail
- TypeScript compilation passes
</verification>

<success_criteria>
- clients.getTracks endpoint returns tracks with project title and artists
- TracksTab component has 3 view modes (Liste, Cards, Table)
- Toggle buttons switch between modes, selection persisted in localStorage
- Audio player works inline in Liste and Cards modes
- Empty state shows illustration + CTA button that navigates to track creation
- Clicking track navigates to /tracks/{id}
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-04-SUMMARY.md`
</output>
