---
phase: 22-refonte-ui-client-hub-relationnel-complet
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/pages/ClientDetail.tsx
  - packages/server/src/routers/clients.ts
autonomous: true

must_haves:
  truths:
    - "ClientDetail shows relational data tabs (Projets, Tracks, Finances)"
    - "Projects tab lists all client projects with status and dates"
    - "Tracks tab shows all tracks from client's projects with audio player"
    - "Finances tab displays invoices + quotes + consolidated stats"
    - "Navigation between tabs is smooth with proper loading states"
  artifacts:
    - path: "packages/client/src/pages/ClientDetail.tsx"
      provides: "Enhanced ClientDetail with relational tabs"
      contains: "TabsContent.*projects"
      min_lines: 600
    - path: "packages/server/src/routers/clients.ts"
      provides: "Backend query for client relational data"
      exports: ["getRelationalData"]
  key_links:
    - from: "ClientDetail.tsx"
      to: "clients.getRelationalData query"
      via: "trpc.clients.getRelationalData.useQuery"
      pattern: "trpc\\.clients\\.getRelationalData"
    - from: "clients.ts"
      to: "projects table"
      via: "JOIN on clientId"
      pattern: "projects.*clientId"
    - from: "ClientDetail.tsx"
      to: "AudioPlayer component"
      via: "Track playback in Tracks tab"
      pattern: "AudioPlayer.*track"
---

<objective>
Add relational data tabs to ClientDetail page showing Projects, Tracks, and Finances for complete client hub

Purpose: Give studio managers a consolidated view of all client-related data (projects → tracks → finances) without navigating multiple pages

Output: Enhanced ClientDetail.tsx with 3 new tabs and backend query for relational data loading
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/client/src/pages/ClientDetail.tsx
@packages/server/src/routers/clients.ts
@packages/server/src/routers/projects.ts
@packages/server/src/routers/invoices.ts
@packages/client/src/components/AudioPlayer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend query for client relational data</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
Add new tRPC procedure `getRelationalData` to clients router that fetches:

**Query structure:**
```typescript
// Add to clients router
getRelationalData: protectedProcedure
  .input(z.object({ clientId: z.number() }))
  .query(async ({ ctx, input }) => {
    const tenantDb = await ctx.getTenantDb();

    // Fetch projects for this client
    const projects = await tenantDb.query.projects.findMany({
      where: eq(projects.clientId, input.clientId),
      orderBy: [desc(projects.createdAt)],
      with: {
        tracks: true, // Include tracks for each project
      },
    });

    // Fetch invoices for this client
    const invoices = await tenantDb.query.invoices.findMany({
      where: eq(invoices.clientId, input.clientId),
      orderBy: [desc(invoices.createdAt)],
      with: {
        items: true, // Include line items
      },
    });

    // Fetch quotes for this client
    const quotes = await tenantDb.query.quotes.findMany({
      where: eq(quotes.clientId, input.clientId),
      orderBy: [desc(quotes.createdAt)],
      with: {
        items: true,
      },
    });

    // Calculate financial stats
    const totalInvoiced = invoices.reduce((sum, inv) => sum + parseFloat(inv.total || "0"), 0);
    const totalPaid = invoices
      .filter(inv => inv.status === "paid")
      .reduce((sum, inv) => sum + parseFloat(inv.total || "0"), 0);
    const totalPending = invoices
      .filter(inv => inv.status === "sent" || inv.status === "overdue")
      .reduce((sum, inv) => sum + parseFloat(inv.total || "0"), 0);
    const totalQuoted = quotes
      .filter(q => q.status === "sent" || q.status === "draft")
      .reduce((sum, q) => sum + parseFloat(q.total || "0"), 0);

    // Flatten tracks from all projects
    const allTracks = projects.flatMap(p =>
      p.tracks.map(t => ({ ...t, projectTitle: p.title }))
    );

    return {
      projects,
      tracks: allTracks,
      invoices,
      quotes,
      stats: {
        totalInvoiced,
        totalPaid,
        totalPending,
        totalQuoted,
        projectCount: projects.length,
        trackCount: allTracks.length,
        invoiceCount: invoices.length,
        quoteCount: quotes.length,
      },
    };
  }),
```

**Why single query:** Loading projects, tracks, invoices, quotes separately = 4 round trips. Single query with all data = 1 round trip, better UX (single loading state, faster tab switches).

**Import required:**
```typescript
import { eq, desc } from "drizzle-orm";
import { projects } from "../../../database/src/tenant/schema";
import { invoices } from "../../../database/src/tenant/schema";
import { quotes } from "../../../database/src/tenant/schema";
```
  </action>
  <verify>
```bash
# TypeScript compilation passes
cd packages/server && npx tsc --noEmit

# Test query with existing client:
# 1. Start server
# 2. Call query via tRPC playground or test:
curl -X POST http://localhost:3001/api/trpc/clients.getRelationalData \
  -H "Content-Type: application/json" \
  -d '{"clientId": 1}'

# Should return object with projects, tracks, invoices, quotes, stats
```
  </verify>
  <done>Backend query `getRelationalData` created, returns consolidated client data with stats, TypeScript passes</done>
</task>

<task type="auto">
  <name>Task 2: Add Projects tab to ClientDetail</name>
  <files>packages/client/src/pages/ClientDetail.tsx</files>
  <action>
Add new "Projets" tab to ClientDetail.tsx Tabs component:

**Current tabs:** Informations, Informations Enrichies, Profil Musical, Historique

**Add new tab after Profil Musical:**

```tsx
<TabsList>
  <TabsTrigger value="info">Informations</TabsTrigger>
  <TabsTrigger value="enriched">Informations Enrichies</TabsTrigger>
  <TabsTrigger value="music">Profil Musical</TabsTrigger>
  <TabsTrigger value="projects">Projets</TabsTrigger>  {/* NEW */}
  <TabsTrigger value="tracks">Tracks</TabsTrigger>    {/* NEW */}
  <TabsTrigger value="finances">Finances</TabsTrigger> {/* NEW */}
  <TabsTrigger value="history">Historique</TabsTrigger>
</TabsList>

<TabsContent value="projects">
  <Card className="pb-3">
    <CardHeader>
      <div className="flex items-center justify-between">
        <CardTitle className="text-base flex items-center gap-2">
          <FileText className="h-8 w-8 text-primary" />
          Projets ({relationalData?.projects.length || 0})
        </CardTitle>
        <Button asChild size="sm">
          <Link to="/projects/new">Nouveau Projet</Link>
        </Button>
      </div>
    </CardHeader>
    <CardContent>
      {!relationalData?.projects.length ? (
        <div className="text-center py-6 text-muted-foreground">
          Aucun projet pour ce client
        </div>
      ) : (
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Titre</TableHead>
              <TableHead>Statut</TableHead>
              <TableHead>Tracks</TableHead>
              <TableHead>Créé le</TableHead>
              <TableHead>Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {relationalData.projects.map((project) => (
              <TableRow key={project.id}>
                <TableCell className="font-medium">{project.title}</TableCell>
                <TableCell>
                  <Badge variant={project.status === "completed" ? "success" : "default"}>
                    {project.status}
                  </Badge>
                </TableCell>
                <TableCell>{project.tracks?.length || 0} track(s)</TableCell>
                <TableCell>
                  {format(new Date(project.createdAt), "dd MMM yyyy", { locale: fr })}
                </TableCell>
                <TableCell>
                  <Button asChild variant="outline" size="sm">
                    <Link to={`/projects/${project.id}`}>Voir</Link>
                  </Button>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      )}
    </CardContent>
  </Card>
</TabsContent>
```

**Add query for relational data at top of component:**
```typescript
const { data: relationalData, isLoading: isLoadingRelational } = trpc.clients.getRelationalData.useQuery(
  { clientId: Number(id) },
  { enabled: !!id }
);
```

**Why Projects tab:** Studios manage client work through projects (albums, EPs, singles). Tab shows all projects at a glance with status, track count, and quick navigation.
  </action>
  <verify>
```bash
# Manual test:
# 1. Navigate to client with projects (e.g., /clients/1)
# 2. Click "Projets" tab
# 3. Verify table shows all client projects
# 4. Click "Voir" button → navigates to project detail
# 5. Verify empty state shows for client with 0 projects
```
  </verify>
  <done>Projects tab added to ClientDetail, displays project table with status/track count/dates, links to project detail pages</done>
</task>

<task type="auto">
  <name>Task 3: Add Tracks and Finances tabs to ClientDetail</name>
  <files>packages/client/src/pages/ClientDetail.tsx</files>
  <action>
Add Tracks and Finances tabs to complete relational hub:

**Tracks tab:**
```tsx
<TabsContent value="tracks">
  <Card className="pb-3">
    <CardHeader>
      <CardTitle className="text-base flex items-center gap-2">
        <Music className="h-8 w-8 text-primary" />
        Tracks ({relationalData?.tracks.length || 0})
      </CardTitle>
    </CardHeader>
    <CardContent>
      {!relationalData?.tracks.length ? (
        <div className="text-center py-6 text-muted-foreground">
          Aucune track pour ce client
        </div>
      ) : (
        <div className="space-y-3">
          {relationalData.tracks.map((track) => (
            <Card key={track.id} className="p-3">
              <div className="flex items-center justify-between">
                <div className="flex-1">
                  <p className="font-medium">{track.title}</p>
                  <p className="text-sm text-muted-foreground">
                    Projet: {track.projectTitle}
                  </p>
                  {track.genre && <Badge variant="outline">{track.genre}</Badge>}
                </div>
                {track.demoUrl && (
                  <AudioPlayer
                    url={track.demoUrl}
                    title={track.title}
                    version="demo"
                  />
                )}
              </div>
            </Card>
          ))}
        </div>
      )}
    </CardContent>
  </Card>
</TabsContent>
```

**Finances tab:**
```tsx
<TabsContent value="finances">
  <div className="space-y-4">
    {/* Stats Cards */}
    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
      <Card className="pb-3">
        <CardHeader>
          <CardTitle className="text-sm">Total Facturé</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-2xl font-bold">
            {relationalData?.stats.totalInvoiced.toFixed(2)}€
          </p>
        </CardContent>
      </Card>
      <Card className="pb-3">
        <CardHeader>
          <CardTitle className="text-sm">Payé</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-2xl font-bold text-green-600">
            {relationalData?.stats.totalPaid.toFixed(2)}€
          </p>
        </CardContent>
      </Card>
      <Card className="pb-3">
        <CardHeader>
          <CardTitle className="text-sm">En Attente</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-2xl font-bold text-orange-600">
            {relationalData?.stats.totalPending.toFixed(2)}€
          </p>
        </CardContent>
      </Card>
      <Card className="pb-3">
        <CardHeader>
          <CardTitle className="text-sm">Devis Actifs</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-2xl font-bold text-blue-600">
            {relationalData?.stats.totalQuoted.toFixed(2)}€
          </p>
        </CardContent>
      </Card>
    </div>

    {/* Invoices Table */}
    <Card className="pb-3">
      <CardHeader>
        <CardTitle className="text-base">Factures</CardTitle>
      </CardHeader>
      <CardContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Numéro</TableHead>
              <TableHead>Date</TableHead>
              <TableHead>Montant</TableHead>
              <TableHead>Statut</TableHead>
              <TableHead>Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {relationalData?.invoices.map((invoice) => (
              <TableRow key={invoice.id}>
                <TableCell>{invoice.invoiceNumber}</TableCell>
                <TableCell>
                  {format(new Date(invoice.createdAt), "dd MMM yyyy", { locale: fr })}
                </TableCell>
                <TableCell>{parseFloat(invoice.total || "0").toFixed(2)}€</TableCell>
                <TableCell>
                  <Badge variant={invoice.status === "paid" ? "success" : "default"}>
                    {invoice.status}
                  </Badge>
                </TableCell>
                <TableCell>
                  <Button asChild variant="outline" size="sm">
                    <Link to={`/invoices/${invoice.id}`}>Voir</Link>
                  </Button>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
    </Card>

    {/* Quotes Table */}
    <Card className="pb-3">
      <CardHeader>
        <CardTitle className="text-base">Devis</CardTitle>
      </CardHeader>
      <CardContent>
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Numéro</TableHead>
              <TableHead>Date</TableHead>
              <TableHead>Montant</TableHead>
              <TableHead>Statut</TableHead>
              <TableHead>Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {relationalData?.quotes.map((quote) => (
              <TableRow key={quote.id}>
                <TableCell>{quote.quoteNumber}</TableCell>
                <TableCell>
                  {format(new Date(quote.createdAt), "dd MMM yyyy", { locale: fr })}
                </TableCell>
                <TableCell>{parseFloat(quote.total || "0").toFixed(2)}€</TableCell>
                <TableCell>
                  <Badge>{quote.status}</Badge>
                </TableCell>
                <TableCell>
                  <Button asChild variant="outline" size="sm">
                    <Link to={`/quotes/${quote.id}`}>Voir</Link>
                  </Button>
                </TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
    </Card>
  </div>
</TabsContent>
```

**Import AudioPlayer:**
```typescript
import { AudioPlayer } from "@/components/AudioPlayer";
```

**Why Tracks tab:** Studios want to see all audio from a client in one place. Tab shows tracks across all projects with inline audio player for quick review.

**Why Finances tab:** Consolidated financial view (invoices + quotes + stats) helps studio managers track receivables and revenue per client without navigating multiple pages.
  </action>
  <verify>
```bash
# Manual test Tracks tab:
# 1. Navigate to client with projects containing tracks
# 2. Click "Tracks" tab
# 3. Verify all tracks displayed with project name
# 4. Click audio player → track plays
# 5. Verify genre badges displayed

# Manual test Finances tab:
# 1. Navigate to client with invoices and quotes
# 2. Click "Finances" tab
# 3. Verify 4 stat cards show correct totals
# 4. Verify invoices table populated
# 5. Verify quotes table populated
# 6. Click "Voir" buttons → navigate to invoice/quote detail
```
  </verify>
  <done>Tracks and Finances tabs added to ClientDetail, audio playback works, financial stats calculated correctly, links to detail pages functional</done>
</task>

</tasks>

<verification>
**Functional checks:**
- [ ] getRelationalData query returns projects, tracks, invoices, quotes, stats
- [ ] Projects tab displays client projects with status and track counts
- [ ] Tracks tab shows all tracks from client projects with audio player
- [ ] Finances tab displays 4 stat cards + invoices table + quotes table
- [ ] Navigation from tabs to detail pages works (project/invoice/quote)
- [ ] Empty states display correctly for clients with no data
- [ ] Loading states show while relational data fetching

**Code quality:**
- [ ] TypeScript compilation passes with 0 errors
- [ ] Client and server packages build successfully
- [ ] No console errors during tab navigation
- [ ] Query optimization: single backend call loads all relational data

**Regression testing:**
- [ ] Existing tabs (Informations, Enriched, Music, History) still work
- [ ] ClientDetail page loads without errors
- [ ] Sessions and Invoices in History tab still display
</verification>

<success_criteria>
- Backend query getRelationalData returns consolidated client data
- ClientDetail has 3 new tabs (Projects, Tracks, Finances)
- Projects tab shows client projects with status and counts
- Tracks tab displays tracks with audio playback
- Finances tab shows stats + invoices + quotes with totals
- Navigation between tabs smooth with proper loading states
- Build passes, TypeScript has 0 errors
- Zero regressions on existing ClientDetail functionality
</success_criteria>

<output>
After completion, create `.planning/phases/22-refonte-ui-client-hub-relationnel-complet/22-02-SUMMARY.md`
</output>
