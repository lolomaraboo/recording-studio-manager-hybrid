---
phase: 15-architecture-session-project-flexible-ui
plan: 1
type: execute
---

<objective>
Adapter l'UI pour supporter les sessions standalone ET les sessions liées à un projet via le champ projectId (nullable).

Purpose: Compléter l'architecture flexible Phase 14 (backend) avec l'UI correspondante. Permettre aux studios de choisir leur workflow: sessions autonomes (location horaire) OU sessions liées à un projet (enregistrement album).
Output: SessionCreate, SessionDetail, Sessions.tsx modifiés avec selector de projet optionnel.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase précédente (14-01):**
@.planning/phases/14-architecture-session-project-flexible-backend/14-01-SUMMARY.md

**Codebase constraints:**
- Stack: React 19, TypeScript strict, tRPC 11, shadcn/ui
- UI harmonization (Phase 3.14): `pt-2 pb-4 px-2` containers, `text-primary` icons, `pb-3` cards
- Existing patterns: SessionCreate.tsx utilise Select pour client/room - répliquer pour projectId

**Backend ready (Phase 14):**
- Schema: `projectId: integer().references(() => projects.id, { onDelete: "set null" })`
- Router: `sessions.create/update` acceptent `projectId?: number | undefined`
- Migration: 0008_add_project_id_to_sessions.sql appliquée

**Fichiers UI à modifier:**
@packages/client/src/pages/SessionCreate.tsx
@packages/client/src/pages/SessionDetail.tsx
@packages/client/src/pages/Sessions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ajouter selector de projet optionnel dans SessionCreate.tsx</name>
  <files>packages/client/src/pages/SessionCreate.tsx</files>
  <action>
Ajouter un champ Select "Projet associé (optionnel)" après les champs Client/Room (ligne ~174).

**Implémentation:**
1. Ajouter query: `const { data: projects } = trpc.projects.list.useQuery();`
2. Ajouter au formData: `projectId: 0` (0 = aucun projet)
3. Ajouter Select après la Row 2 (Client & Room):
   ```tsx
   <div className="space-y-2">
     <Label htmlFor="projectId">Projet associé (optionnel)</Label>
     <Select
       value={formData.projectId.toString()}
       onValueChange={(value) => setFormData({ ...formData, projectId: parseInt(value) })}
     >
       <SelectTrigger id="projectId">
         <SelectValue placeholder="Aucun projet (session standalone)" />
       </SelectTrigger>
       <SelectContent>
         <SelectItem value="0">Aucun projet</SelectItem>
         {projects?.map((project) => (
           <SelectItem key={project.id} value={project.id.toString()}>
             {project.title}
           </SelectItem>
         ))}
       </SelectContent>
     </Select>
   </div>
   ```
4. Modifier handleSubmit (ligne ~78): ajouter `projectId: formData.projectId || undefined` dans mutation

**Ce qu'il NE FAUT PAS faire:**
- Ne pas rendre le champ obligatoire (NOT NULL) - projectId est nullable par design
- Ne pas créer de validation XOR (session OU projet) - architecture supporte les deux
- Ne pas modifier le backend - Phase 14 déjà prête
  </action>
  <verify>
1. `pnpm check` passe (0 erreurs TypeScript)
2. UI compile sans erreurs: `pnpm --filter client build`
3. Tester création:
   - Session standalone (projectId=0) → projectId = NULL en DB
   - Session liée (projectId=3) → projectId = 3 en DB
  </verify>
  <done>
SessionCreate.tsx affiche selector de projet optionnel, création fonctionne avec/sans projet, données correctement envoyées au backend (projectId: undefined ou number).
  </done>
</task>

<task type="auto">
  <name>Task 2: Afficher projet associé dans SessionDetail.tsx et Sessions.tsx</name>
  <files>packages/client/src/pages/SessionDetail.tsx, packages/client/src/pages/Sessions.tsx</files>
  <action>
**SessionDetail.tsx:**
1. Vérifier si session.projectId existe dans query response
2. Si projectId présent, ajouter une Card "Projet associé" après la Card "Informations générales":
   ```tsx
   {session.projectId && (
     <Card>
       <CardHeader className="pb-3">
         <CardTitle className="text-base">Projet associé</CardTitle>
       </CardHeader>
       <CardContent className="pt-0">
         <div className="flex items-center gap-2">
           <FolderKanban className="h-4 w-4 text-muted-foreground" />
           <Link
             to={`/projects/${session.projectId}`}
             className="text-primary hover:underline"
           >
             Voir le projet
           </Link>
         </div>
       </CardContent>
     </Card>
   )}
   ```
3. Importer FolderKanban depuis lucide-react si nécessaire

**Sessions.tsx (liste):**
1. Ajouter colonne "Projet" dans la table (après colonne "Salle"):
   ```tsx
   <TableHead>Projet</TableHead>
   ```
2. Afficher le nom du projet ou "—" si null:
   ```tsx
   <TableCell>
     {session.projectId ? (
       <Link
         to={`/projects/${session.projectId}`}
         className="text-primary hover:underline"
       >
         {/* Note: Besoin de joindre projects ou afficher ID uniquement */}
         Projet #{session.projectId}
       </Link>
     ) : (
       <span className="text-muted-foreground">—</span>
     )}
   </TableCell>
   ```

**Note sur la jointure:**
- Si sessions.list ne retourne pas project.title, afficher temporairement "Projet #{id}"
- Alternative: Modifier backend sessions.list pour inclure project (LEFT JOIN) → mais hors scope Phase 15
- Décision: Afficher ID pour l'instant, amélioration jointure = Phase future

**Ce qu'il NE FAUT PAS faire:**
- Ne pas modifier le router backend (sessions.list) - hors scope UI
- Ne pas créer de dépendance circulaire (project → sessions → project)
  </action>
  <verify>
1. `pnpm check` passe (0 erreurs TypeScript)
2. SessionDetail.tsx affiche Card "Projet associé" si projectId présent
3. Sessions.tsx affiche colonne "Projet" avec lien ou "—"
4. Clics sur liens redirigent correctement vers /projects/{id}
  </verify>
  <done>
SessionDetail et Sessions affichent le projet associé quand présent, liens fonctionnels, rendu cohérent avec design system (text-primary, hover:underline).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>UI adaptation Session/Project flexible complete - sessions peuvent être standalone ou liées à un projet</what-built>
  <how-to-verify>
1. Lancer dev: `cd packages/client && pnpm dev`
2. Naviguer vers /sessions/new
3. Vérifier:
   - Champ "Projet associé (optionnel)" visible après Client/Room
   - Option "Aucun projet" dans selector
   - Liste des projets disponibles
4. Créer session standalone (Aucun projet):
   - Titre: "Test Standalone Session"
   - Client/Room: sélectionner
   - Projet: "Aucun projet"
   - Enregistrer → Vérifier DB: projectId = NULL
5. Créer session liée:
   - Titre: "Test Project-Linked Session"
   - Client/Room: sélectionner
   - Projet: sélectionner un projet existant
   - Enregistrer → Vérifier DB: projectId = [id]
6. Naviguer vers /sessions (liste):
   - Colonne "Projet" affiche "Projet #X" ou "—"
7. Cliquer sur session liée → SessionDetail:
   - Card "Projet associé" visible avec lien
   - Clic sur lien → redirige vers /projects/{id}
  </how-to-verify>
  <resume-signal>Type "approved" si workflow fonctionne (création standalone/liée + affichage), ou décrit issues à corriger</resume-signal>
</task>

</tasks>

<verification>
Avant de déclarer phase complète:
- [ ] `pnpm check` passe (0 erreurs TypeScript)
- [ ] SessionCreate.tsx: selector de projet optionnel fonctionnel
- [ ] SessionDetail.tsx: affiche projet associé si présent
- [ ] Sessions.tsx: colonne "Projet" affiche ID ou "—"
- [ ] Tests manuels validés (checkpoint)
- [ ] Backward compatibility: sessions existantes (projectId=NULL) ne cassent rien
</verification>

<success_criteria>
- Tous les tasks complétés
- Toutes les vérifications passent
- UI supporte dual workflow: standalone sessions ET project-linked sessions
- Design system respecté (harmonization Phase 3.14)
- Aucune régression sur sessions existantes
</success_criteria>

<output>
After completion, create `.planning/phases/15-architecture-session-project-flexible-ui/15-01-SUMMARY.md`:

# Phase 15 Plan 1: Architecture Session/Project Flexible - UI Adaptation Summary

**UI flexible complétée: sessions standalone OU liées à projet via selector optionnel**

## Accomplishments

- SessionCreate.tsx: ajout selector "Projet associé (optionnel)" avec option "Aucun projet"
- SessionDetail.tsx: Card "Projet associé" affichée quand projectId présent + lien vers projet
- Sessions.tsx: colonne "Projet" affiche "Projet #{id}" ou "—" pour standalone
- Backward compatible: sessions existantes (projectId=NULL) fonctionnent sans modification

## Files Created/Modified

- `packages/client/src/pages/SessionCreate.tsx` - Ajout query projects.list + selector projectId optionnel
- `packages/client/src/pages/SessionDetail.tsx` - Card "Projet associé" avec lien conditionnel
- `packages/client/src/pages/Sessions.tsx` - Colonne "Projet" avec affichage ID ou "—"

## Decisions Made

**Affichage ID temporaire:**
- Sessions.tsx affiche "Projet #{id}" au lieu du titre complet
- Raison: sessions.list backend ne joint pas projects actuellement
- Amélioration future: Modifier sessions.list pour LEFT JOIN projects et retourner project.title
- Trade-off: Simplicité Phase 15 (UI only) vs perfectionnisme (modifier backend hors scope)

## Issues Encountered

None (ou documenter si problèmes rencontrés)

## Next Step

Phase 15 complete - UI adaptation terminée. Ready for Phase 16 (Facturation Automatique - Backend Integration).
</output>
