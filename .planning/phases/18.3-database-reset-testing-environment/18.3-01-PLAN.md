---
phase: 18.3-database-reset-testing-environment
plan: 01
type: execute
---

<objective>
Nuclear database reset: Drop ALL tenant databases, rebuild rsm_master clean, create ONE fresh tenant with test data.

Purpose: Eliminate database chaos blocking Phase 18-02 testing - user spent entire previous session debugging instead of testing.
Output: Clean testing environment with single tenant, documented credentials, validated login - ready for Phase 18-02 in <5 minutes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Accumulated Decisions:**
- Phase 18.1: PostgreSQL 17 added to PATH, master migrations generated (subscription_plans + ai_credits)
- Phase 18.2: Tenant migrations applied (sessions + invoices columns synchronized)
- **Problem:** Multiple orgs (3, 16), inconsistent mappings, invalid credentials, missing tables = chaos
- **User frustrated:** "on a passé la journée sur la db" - entire session wasted on DB issues

**User Request:** "ON REPART SUR DU NEUF!!!!" - Complete fresh start, simple configuration

**Database State Before Reset:**
- rsm_master: 7 tables (organizations, users, tenant_databases, etc.)
- tenant_1: 30 tenant-only tables
- tenant_3: Unknown state (created at some point)
- tenant_16: 30 tenant-only tables (test data from Phase 3.14)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Drop all tenant databases</name>
  <files>N/A (PostgreSQL operations)</files>
  <action>
    Drop tenant databases using psql:
    ```bash
    psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS tenant_1;"
    psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS tenant_3;"
    psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS tenant_16;"
    ```

    Verify dropped with: `psql -U postgres -d postgres -c "\l" | grep tenant_`
    Should return nothing (all tenant DBs gone).
  </action>
  <verify>psql lists NO tenant databases (0 results from grep tenant_)</verify>
  <done>All tenant databases dropped - clean slate for tenant creation</done>
</task>

<task type="auto">
  <name>Task 2: Reset rsm_master completely</name>
  <files>N/A (PostgreSQL operations)</files>
  <action>
    Drop and recreate rsm_master:
    ```bash
    psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS rsm_master;"
    psql -U postgres -d postgres -c "CREATE DATABASE rsm_master;"
    ```

    Apply master migrations:
    ```bash
    cd packages/database
    pnpm db:migrate
    ```

    Expected output: 7 master tables created (organizations, users, tenant_databases, organization_members, invitations, subscription_plans, ai_credits).

    Verify with: `psql -U postgres -d rsm_master -c "\dt"`
    Should show exactly 7 tables.
  </action>
  <verify>psql shows 7 master tables, 0 errors from migrations</verify>
  <done>rsm_master rebuilt clean with latest schema</done>
</task>

<task type="auto">
  <name>Task 3: Initialize with ONE tenant + test data</name>
  <files>N/A (database seeding script)</files>
  <action>
    Run initialization script to create:
    - ONE organization (ID 1)
    - ONE admin user
    - ONE tenant database (tenant_1)
    - Test data (5 clients, 4 rooms, 8 sessions, 4 projects, etc.)

    ```bash
    cd packages/database
    pnpm db:init
    ```

    Expected outcome:
    - Organization 1 created
    - User 1 created (admin@test-studio.com)
    - tenant_1 database created with 30 tables
    - Test data seeded

    Verify tenant created:
    ```bash
    psql -U postgres -d postgres -c "\l" | grep tenant_1
    ```

    Should show tenant_1 database exists.

    Verify test data:
    ```bash
    psql -U postgres -d tenant_1 -c "SELECT COUNT(*) FROM clients;"
    ```

    Should return >0 clients.
  </action>
  <verify>tenant_1 exists with 30 tables, clients table has >0 rows</verify>
  <done>Single tenant created with test data - ready for testing</done>
</task>

<task type="auto">
  <name>Task 4: Document credentials in .continue-here.md</name>
  <files>.planning/phases/18.3-database-reset-testing-environment/.continue-here.md</files>
  <action>
    Create .continue-here.md with CLEAR credentials and testing instructions:

    ```markdown
    # Phase 18-02 Ready to Resume

    ## Database Reset Complete ✅

    **Clean slate achieved:**
    - ✅ All old tenant databases dropped (tenant_1, tenant_3, tenant_16)
    - ✅ rsm_master rebuilt with 7 tables
    - ✅ ONE tenant created (tenant_1)
    - ✅ Test data seeded

    ## Login Credentials

    **Email:** admin@test-studio.com
    **Password:** [GET FROM DB INIT SCRIPT OUTPUT]
    **Organization:** Test Studio (ID: 1)
    **Tenant Database:** tenant_1

    ## Validate Login Works

    1. Start dev server: `./start.sh`
    2. Visit: http://localhost:5174
    3. Login with credentials above
    4. Confirm dashboard loads without errors

    ## Next: Phase 18-02 Testing

    Ready to test 58 pages systematically. Start with Clients section (page 3/58).

    **Test Matrix:** .planning/phases/18-audit-complet-toutes-pages-zero-bug/TEST-MATRIX.md

    **Expected:** Testing begins within 5 minutes of session start.
    ```

    Write this file to phase directory.
  </action>
  <verify>.continue-here.md exists with credentials documented</verify>
  <done>Testing instructions documented - next session can start immediately</done>
</task>

<task type="auto">
  <name>Task 5: Validate login works end-to-end</name>
  <files>N/A (manual validation)</files>
  <action>
    Start dev server and test login:

    1. Start server: `./start.sh` (runs both backend + frontend)
    2. Wait 10 seconds for server startup
    3. Check health: `curl http://localhost:3001/health`
       - Should return: {"status":"ok"}

    4. Verify frontend accessible: `curl -I http://localhost:5174`
       - Should return: HTTP 200

    5. Check database connection from backend:
       ```bash
       psql -U postgres -d rsm_master -c "SELECT COUNT(*) FROM users;"
       ```
       - Should return: 1 (admin user created)

    If all checks pass, environment is ready.
    If any check fails, debug before proceeding.
  </action>
  <verify>Health endpoint returns 200, frontend accessible, database has 1 user</verify>
  <done>Environment validated - login guaranteed to work</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `psql -c "\l" | grep tenant_` returns 0 results (all old tenants gone)
- [ ] `psql -d rsm_master -c "\dt"` shows exactly 7 master tables
- [ ] `psql -c "\l" | grep tenant_1` shows tenant_1 exists
- [ ] `psql -d tenant_1 -c "SELECT COUNT(*) FROM clients;"` returns >0
- [ ] `.continue-here.md` exists with credentials documented
- [ ] `curl http://localhost:3001/health` returns {"status":"ok"}
- [ ] `curl -I http://localhost:5174` returns HTTP 200
</verification>

<success_criteria>

- All tenant databases dropped (tenant_1, tenant_3, tenant_16)
- rsm_master rebuilt with 7 tables (0 migration errors)
- ONE tenant created (tenant_1) with 30 tables
- Test data seeded (>0 clients)
- Credentials documented in .continue-here.md
- Login validated (health check + frontend accessible + DB query works)
- Phase 18-02 unblocked - testing can start in <5 minutes
  </success_criteria>

<output>
After completion, create `.planning/phases/18.3-database-reset-testing-environment/18.3-01-SUMMARY.md`:

# Phase 18.3 Plan 1: Database Reset for Testing Environment Summary

**Nuclear reset complete - clean testing environment established**

## Accomplishments

- Dropped all old tenant databases (tenant_1, tenant_3, tenant_16)
- Rebuilt rsm_master with 7 master tables
- Created fresh tenant_1 with 30 tenant tables
- Seeded test data (clients, rooms, sessions, projects)
- Documented credentials in .continue-here.md
- Validated login works end-to-end

## Files Created/Modified

- `.planning/phases/18.3-database-reset-testing-environment/.continue-here.md` - Testing resume instructions with credentials
- `rsm_master` database - Rebuilt clean
- `tenant_1` database - Fresh tenant with test data

## Decisions Made

- **Nuclear approach:** Complete wipe instead of attempting to fix inconsistencies (user frustrated, faster to rebuild)
- **Single tenant:** Create only tenant_1 to avoid confusion (no tenant_3, no tenant_16)
- **Validation before completion:** Health checks + DB queries confirm environment ready

## Issues Encountered

[Document any issues during execution]

## Next Step

**Phase 18-02 unblocked - ready to resume manual testing**

- Test Matrix: `.planning/phases/18-audit-complet-toutes-pages-zero-bug/TEST-MATRIX.md`
- Start with: Clients section (page 3/58)
- Expected: Testing begins within 5 minutes
</output>
