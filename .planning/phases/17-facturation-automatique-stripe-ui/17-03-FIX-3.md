---
phase: 17-facturation-automatique-stripe-ui
plan: 17-03-FIX-3
type: fix
---

<objective>
Fix invoice rendering issue preventing E2E test validation and complete Phase 17 UAT.

**Root Cause:** Invoice list returns 0 invoices despite test invoice creation in beforeAll hook

**Impact:** 7/8 E2E tests failing (87.5% failure rate)
- Tests 2-6: Invoice UI rendering (invoice count = 0)
- Tests 7-8: Protected route redirect to login
- Blocks Phase 17 UAT completion

**Priority:** Critical - Phase 17 cannot be validated without passing E2E tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Previous fixes:**
@.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-SUMMARY.md
@.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-2-SUMMARY.md

**Test file:**
@e2e/test-phase17-invoice-payment.spec.ts

**Backend files:**
@packages/server/src/routers/clientPortalInvoices.ts
@packages/database/src/tenant/schema.ts

**Frontend files:**
@packages/client/src/pages/ClientPortal/Invoices.tsx
@packages/client/src/pages/ClientPortal/InvoiceDetail.tsx
@packages/client/src/lib/ProtectedClientRoute.tsx

**Evidence from 17-03-FIX-2:**
- ✅ Authentication fixed: Login returns 200 OK
- ✅ localStorage persists: Token and client data saved correctly
- ❌ Invoice list empty: `invoiceCount = 0` (expected > 0)
- ❌ Tests 7-8 redirect: Success/cancel pages require auth
</context>

<tasks>
<task type="auto">
  <name>Investigate test invoice creation</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts
  </files>
  <action>
Read the test file and analyze the `beforeAll` hook:

1. **Check invoice creation SQL:**
   - Is invoice inserted into correct tenant database?
   - Verify `client_id` matches the test client ID
   - Check `status` is set to 'SENT' (not 'DRAFT' or 'PAID')
   - Verify invoice_number format
   - Check subtotal, tax_amount, total are non-zero

2. **Verify foreign key relationships:**
   - Does test client (id=8) exist before invoice creation?
   - Are client_id and organization_id correct?
   - Check if invoice_items are created with valid line items

3. **Database inspection:**
   - Add debug query after invoice creation to verify it exists
   - Log: `SELECT id, invoice_number, client_id, status, total FROM invoices WHERE client_id = ${clientId}`

**Hypothesis to test:**
- Invoice creation SQL might be failing silently
- Client ID might not match between portal_accounts and invoices
- Invoice might be in wrong status (DRAFT instead of SENT)
  </action>
  <verify>
Add debug SQL query, re-run test to see if invoice actually exists in database
  </verify>
  <done>
Understand whether test invoice exists and why it's not being queried
  </done>
</task>

<task type="auto">
  <name>Investigate clientPortalInvoices.list query</name>
  <files>
    - packages/server/src/routers/clientPortalInvoices.ts
  </files>
  <action>
Read the backend router and analyze the `list` query:

1. **Check query logic:**
   - How does it determine which client is logged in?
   - Does it use `ctx.clientId` from auth context?
   - What filters are applied (client_id, status, etc.)?
   - Is there a WHERE clause that might exclude test invoices?

2. **Verify authentication context:**
   - Check if `ctx.clientId` is populated correctly after login
   - Verify Client Portal auth context provides clientId
   - Ensure it's not using organizationId filter instead

3. **Check query structure:**
   ```typescript
   // Expected pattern
   const invoices = await tenantDb.query.invoices.findMany({
     where: eq(invoices.clientId, ctx.clientId),
     // ... other filters
   });
   ```

**Hypothesis to test:**
- Query might be filtering by wrong client_id
- Auth context might not provide clientId correctly
- Query might exclude SENT status invoices
  </action>
  <verify>
Document query logic and identify potential filtering issues
  </verify>
  <done>
Understand why query returns empty array for test client
  </done>
</task>

<task type="auto">
  <name>Fix invoice list query or test data</name>
  <files>
    - packages/server/src/routers/clientPortalInvoices.ts OR
    - e2e/test-phase17-invoice-payment.spec.ts OR
    - packages/server/src/context.ts
  </files>
  <action>
Based on investigation findings, apply appropriate fix:

**Scenario A: Query uses wrong client_id**
If backend queries by wrong ID:
- Fix clientPortalAuth router to return clientId in session
- Update context to populate ctx.clientId from portal session
- Ensure clientPortalInvoices.list uses ctx.clientId correctly

**Scenario B: Test data client_id mismatch**
If invoice has different client_id than logged-in client:
- Fix test invoice creation to use correct client_id
- Match client_id between portal_accounts and invoices tables
- Verify with SQL: `SELECT id FROM clients WHERE email = 'test@example.com'`

**Scenario C: Query filters out test invoices**
If query excludes SENT status or has wrong WHERE clause:
- Remove or fix status filter in list query
- Adjust test invoice status to match query expectations
- Ensure no date/organization filters exclude test data

**Scenario D: Auth context missing clientId**
If ctx.clientId is null/undefined:
- Fix ClientPortalAuth context to store clientId in session
- Update middleware to populate ctx.clientId from localStorage/cookie
- Add validation to ensure clientId exists before query

**Implementation steps:**
1. Apply minimal, targeted fix
2. Add comments explaining the change
3. Verify query returns test invoices
  </action>
  <verify>
Code compiles, fix targets root cause identified in investigation
  </verify>
  <done>
Fix implemented, ready for test verification
  </done>
</task>

<task type="auto">
  <name>Fix success/cancel page authentication</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts OR
    - packages/client/src/lib/ProtectedClientRoute.tsx OR
    - packages/client/src/App.tsx
  </files>
  <action>
Fix Tests 7-8 which redirect to login instead of showing success/cancel pages.

**Option A: Add login to tests (Recommended)**
Update Tests 7-8 to login before navigating:
```typescript
test("should display success page after payment", async ({ page }) => {
  // Login first
  await page.goto('https://recording-studio-manager.com/client-portal/login');
  await page.fill('input[type="email"]', 'test@example.com');
  await page.fill('input[type="password"]', 'password123');
  await page.click('button[type="submit"]');
  await page.waitForURL(/\/client-portal\/?$/, { timeout: 5000 });

  // Then navigate to success page
  await page.goto('https://recording-studio-manager.com/client-portal/invoices/success');
  const url = page.url();
  expect(url).toContain('/invoices/success');
});
```

**Option B: Make success/cancel pages public**
Update App.tsx routes to not require ProtectedClientRoute:
```typescript
// Remove ProtectedClientRoute wrapper from success/cancel routes
<Route path="/client-portal/invoices/success" component={InvoicePaymentSuccess} />
<Route path="/client-portal/invoices/cancel" component={InvoicePaymentCancel} />
```

**Recommendation:** Option A (add login to tests)
- More realistic test scenario
- Maintains security (success page should be protected)
- Consistent with other protected route tests

**Implementation:**
1. Add login flow helper or duplicate from Test 1
2. Apply to Tests 7 and 8
3. Keep existing assertions unchanged
  </action>
  <verify>
Tests 7-8 no longer redirect to login page
  </verify>
  <done>
Success/cancel page tests updated and ready for verification
  </done>
</task>

<task type="auto">
  <name>Re-run E2E tests to verify all fixes</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts (test execution)
  </files>
  <action>
Execute full test suite in headless mode:

```bash
npx playwright test e2e/test-phase17-invoice-payment.spec.ts
```

**Expected results after all fixes:**
- ✅ Test 1: Login successful (already passing)
- ✅ Test 2: Invoice list displays with invoiceCount > 0 (FIXED)
- ✅ Test 3: Invoice detail page accessible (FIXED)
- ✅ Test 4: Pay Now button displayed for SENT invoice (FIXED)
- ✅ Test 5: Download PDF button exists (FIXED)
- ✅ Test 6: Stripe Checkout redirect attempted (FIXED)
- ✅ Test 7: Success page accessible after login (FIXED)
- ✅ Test 8: Cancel page accessible after login (FIXED)

**Pass criteria:** 8/8 tests passing (100%)

**If any tests still fail:**
- Review error messages and screenshots
- Check browser console for tRPC errors
- Verify database state with SQL queries
- May need to iterate on fixes
  </action>
  <verify>
Playwright output shows "8 passed (100%)" with no failures
  </verify>
  <done>
All 8 E2E tests passing, Phase 17 invoice payment flow fully validated
  </done>
</task>

<task type="auto">
  <name>Remove debug logging and finalize</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts
  </files>
  <action>
Clean up test file for production:

1. **Remove debug SQL queries:**
   - Remove any `SELECT` queries added for investigation
   - Remove console.log statements for invoice inspection

2. **Keep only essential logging:**
   - Success confirmation logs (✅ Test N: ...)
   - Test setup logging (if helpful for CI/CD)

3. **Document test data requirements:**
   - Add comment explaining test invoice structure
   - Note client_id must match portal_accounts

4. **Verify test independence:**
   - Ensure tests don't depend on execution order
   - Check that beforeAll creates all required data
  </action>
  <verify>
Test file is clean, maintainable, and production-ready
  </verify>
  <done>
Test file finalized, ready for CI/CD integration
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Root cause of invoice rendering issue identified and documented
- [ ] Invoice list query returns test invoices correctly
- [ ] All 8 Playwright tests passing (100% pass rate)
- [ ] Success/cancel pages accessible after authentication
- [ ] Debug logging removed from test file
- [ ] Screenshots show correct Client Portal pages with invoice data
</verification>

<success_criteria>
- All 7 previously failing tests now pass
- Test pass rate: 8/8 (100%)
- Invoice list displays test invoice(s) correctly
- Invoice detail page shows invoice data and payment buttons
- Success/cancel pages accessible without redirect loops
- No regression in previously passing Test 1 (Login)
- Phase 17 UAT validation complete
- v4.0 milestone ready for completion
</success_criteria>

<output>
After completion, create `.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-3-SUMMARY.md`

Include in SUMMARY:
- Root cause analysis (why invoice list was empty)
- Fixes applied (query, test data, or auth context)
- Test results (8/8 passing)
- Phase 17 completion confirmation
- Recommendation for v4.0 milestone completion
</output>
