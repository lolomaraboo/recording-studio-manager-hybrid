---
phase: 17-facturation-automatique-stripe-ui
plan: 17-03-FIX-2
task: 0
total_tasks: 5
status: ready_to_start
last_updated: 2026-01-10T10:58:00Z
---

<current_state>
**Phase 17 UAT - Authentication persistence bug blocking E2E validation**

Just completed 17-03-FIX (route path corrections) which exposed a deeper authentication issue. Created 17-03-FIX-2 plan but haven't started execution yet.

**Test Results:** 2/8 passing (25%)
- Test 1 (Login) ✅ - auth.login works
- Tests 2-7 ❌ - All redirect to login after successful authentication
- Test 8 (Cancel) ✅ - Unauthenticated route works

**Root Issue:** Session doesn't persist after login in Playwright tests. Login succeeds, but subsequent `page.goto()` calls redirect back to `/client-portal/login` instead of showing invoice pages.
</current_state>

<completed_work>
**Plan 17-03-FIX (Complete):**
- ✅ Task 1: Fixed all route paths from `/client/` to `/client-portal/` (22 occurrences)
- ✅ Task 2: Re-ran tests, discovered auth persistence bug
- ✅ Committed: `55de23d` (fix) + `4677618` (docs)
- ✅ Created 17-03-FIX-SUMMARY.md documenting findings

**Plan 17-03-FIX-2 (Created, not started):**
- ✅ Plan file written: `.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-2.md`
- ⏸️ Ready to execute but paused before starting Task 1
</completed_work>

<remaining_work>
**Plan 17-03-FIX-2 - All 5 tasks pending:**

- **Task 1:** Investigate ProtectedClientRoute authentication check
  - Read ProtectedClientRoute.tsx and ClientAuthContext.tsx
  - Understand how auth check works and what triggers redirect
  - Document findings

- **Task 2:** Investigate session cookie handling in Playwright
  - Check if cookies persist between page.goto() calls
  - Verify tRPC client includes credentials
  - Add debug logging to inspect cookie behavior

- **Task 3:** Fix authentication persistence issue
  - Apply fix based on investigation (likely: credentials config or cookie handling)
  - Most probable: Add `credentials: 'include'` to tRPC httpBatchLink
  - Alternative: Configure Playwright storageState or explicit cookie management

- **Task 4:** Re-run E2E tests to verify fix
  - Execute: `npx playwright test e2e/test-phase17-invoice-payment.spec.ts`
  - Expected: 8/8 passing (100%)
  - Verify all invoice pages accessible after login

- **Task 5:** Clean up debug logging
  - Remove console.log statements added during investigation
  - Ensure test file is production-ready
</remaining_work>

<decisions_made>
**17-03-FIX Decision: Stop at architectural boundary (Rule 4)**
- Rationale: Route fix was narrow scope, auth bug is architectural
- Created separate fix plan (17-03-FIX-2) rather than expanding scope
- Followed GSD best practice: defer discovered issues to new plans

**Investigation Strategy (17-03-FIX-2):**
- Prioritize cookie/credentials as most likely cause
- Test pattern analysis shows difference between redirect (works) vs explicit goto (fails)
- Debugging approach: Add logging → identify issue → minimal fix → verify
</decisions_made>

<blockers>
**Active Blocker:**
- Phase 17 UAT validation blocked until auth persistence bug fixed
- 6/8 E2E tests failing (invoice list, detail, buttons all inaccessible)
- Cannot validate invoice payment flow end-to-end

**Impact:**
- v4.0 milestone technically complete (all code implemented)
- But UAT validation incomplete (can't test Client Portal invoice features)
- Marketing launch should wait for 100% E2E test pass rate
</blockers>

<context>
**Mental Model:**

The route path fix (17-03-FIX) was straightforward - simple find/replace of incorrect paths. But when tests re-ran, they exposed a **hidden bug** that was masked by the wrong routes.

**Pattern observed:**
- Test 1: Login → wait for redirect → ✅ works (Playwright follows automatic redirect)
- Test 2: Login → explicit `page.goto('/client-portal/invoices')` → ❌ fails (session lost)

This suggests the issue is with **cookie handling between explicit navigations**, not the login flow itself.

**Hypothesis Priority:**
1. **Most likely (80%):** tRPC client missing `credentials: 'include'` - cookies not sent with requests
2. **Likely (15%):** Playwright context not persisting cookies between page.goto() calls
3. **Possible (5%):** ProtectedClientRoute race condition (checks auth before session loaded)

**Debugging Strategy:**
Start with Task 1-2 (investigation), add strategic console.logs to see cookies, then apply minimal targeted fix in Task 3.

**Vibe Check:**
This is a classic "integration test exposed what manual testing missed" scenario. The auth code probably works fine in browser (manual testing passed), but Playwright's programmatic navigation has different cookie behavior. Quick fix once we identify the issue.
</context>

<next_action>
**Resume with:**

```bash
/gsd:execute-plan .planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-2.md
```

**What will happen:**
1. Task 1: Read ProtectedClientRoute.tsx and ClientAuthContext.tsx
2. Task 2: Inspect cookie handling, add debug logging to test
3. Task 3: Apply fix (likely 1-2 line change in tRPC client config)
4. Task 4: Re-run tests, expect 8/8 passing
5. Task 5: Clean up debug logs

**Time estimate:** 30-60 min (mostly investigation, fix should be quick once identified)

**Alternative:** If you want to just investigate first without committing to full execution, spawn an Explore agent to read the auth files and provide analysis.
</next_action>

<files_modified_uncommitted>
None - All work committed:
- `55de23d`: fix(17-03-FIX): correct route paths in E2E test file
- `4677618`: docs(17-03-FIX): complete E2E test route path fix plan

Working tree clean, ready to start 17-03-FIX-2.
</files_modified_uncommitted>

<evidence_artifacts>
**Test Results Location:**
- Last test run: `npx playwright test e2e/test-phase17-invoice-payment.spec.ts`
- Screenshots: `test-results/test-phase17-invoice-payme-*/test-failed-*.png`
- Videos: `test-results/test-phase17-invoice-payme-*/video.webm`
- Error contexts: `test-results/test-phase17-invoice-payme-*/error-context.md`

**Key Files:**
- Test: `e2e/test-phase17-invoice-payment.spec.ts`
- Auth Guard: `packages/client/src/lib/ProtectedClientRoute.tsx`
- Auth Context: `packages/client/src/contexts/ClientAuthContext.tsx`
- tRPC Client: `packages/client/src/lib/trpc.ts`
- Backend Auth: `packages/server/src/routers/clientPortalAuth.ts`

**Fix Plan:**
- `.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-2.md`
</evidence_artifacts>
