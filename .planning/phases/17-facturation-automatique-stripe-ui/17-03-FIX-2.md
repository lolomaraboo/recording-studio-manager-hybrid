---
phase: 17-facturation-automatique-stripe-ui
plan: 17-03-FIX-2
type: fix
---

<objective>
Debug and fix Client Portal authentication persistence bug preventing E2E test validation.

**Root Cause:** Session not persisting after login in Playwright tests, causing redirects to login page

**Impact:** 6/8 E2E tests failing (75% failure rate)
- All invoice-related tests redirect to login after successful authentication
- Blocks Phase 17 UAT validation
- Invoice payment UI code correct but untestable

**Priority:** Critical - Phase 17 cannot be validated without working E2E tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Previous fix:**
@.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-SUMMARY.md

**Test file:**
@e2e/test-phase17-invoice-payment.spec.ts

**Authentication system files:**
@packages/client/src/lib/ProtectedClientRoute.tsx
@packages/client/src/contexts/ClientAuthContext.tsx
@packages/server/src/routers/clientPortalAuth.ts
@packages/client/src/lib/trpc.ts

**Evidence:**
- Test 1 (Login) passes - auth.login endpoint works
- Tests 2-7 fail - All redirect to /client-portal/login after login
- Test 8 (Cancel page) passes - Unauthenticated route accessible
- Screenshot artifacts show login page instead of invoice pages
</context>

<tasks>
<task type="auto">
  <name>Investigate ProtectedClientRoute authentication check</name>
  <files>
    - packages/client/src/lib/ProtectedClientRoute.tsx
    - packages/client/src/contexts/ClientAuthContext.tsx
  </files>
  <action>
Read ProtectedClientRoute component to understand authentication flow:

1. How does it check if user is authenticated?
2. What triggers redirect to /client-portal/login?
3. Does it use ClientAuthContext or direct tRPC query?
4. How does it handle loading states?

Read ClientAuthContext to understand session loading:

1. How does it fetch current user (auth.me)?
2. When does it run this query?
3. Does it have proper error handling?
4. Could there be race conditions?

**Hypothesis to verify:**
- ProtectedClientRoute might be checking auth before ClientAuthContext loads
- Session cookie might not be included in Playwright tRPC requests
- auth.me query might be failing silently
  </action>
  <verify>
Document findings: What controls the redirect? What could cause it to redirect valid sessions?
  </verify>
  <done>
Authentication flow understood, redirect trigger identified
  </done>
</task>

<task type="auto">
  <name>Investigate session cookie handling in Playwright</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts
    - packages/client/src/lib/trpc.ts
  </files>
  <action>
Check how session cookies are handled:

1. **In test file:**
   - Does Playwright have storageState configured?
   - Are cookies persisted between page.goto() calls?
   - Check if page.context() shares cookies

2. **In tRPC client:**
   - Does it include credentials in requests?
   - Check if httpBatchLink has credentials: 'include'
   - Verify cookie domain matches

3. **Test pattern analysis:**
   - Test 1: Login + waitForURL = works
   - Test 2: Login + goto('/invoices') = fails
   - Difference: Test 1 waits for redirect, Test 2 does explicit goto()

**Hypothesis to test:**
- Explicit page.goto() might not send cookies
- Need to use page.context().cookies() to inspect what's saved
- May need playwright config storageState or explicit cookie management

**Debugging steps:**
1. Add console.log in test to print cookies after login
2. Check if session cookie exists after successful login
3. Verify cookie is sent on subsequent page.goto() calls
  </action>
  <verify>
Add debug logging to tests, re-run to see cookie behavior
  </verify>
  <done>
Session cookie behavior understood, issue identified
  </done>
</task>

<task type="auto">
  <name>Fix authentication persistence issue</name>
  <files>
    - packages/client/src/lib/ProtectedClientRoute.tsx OR
    - packages/client/src/contexts/ClientAuthContext.tsx OR
    - e2e/test-phase17-invoice-payment.spec.ts OR
    - packages/client/src/lib/trpc.ts
  </files>
  <action>
Based on investigation findings, apply appropriate fix:

**Scenario A: Cookie not being sent (likely)**
If cookies aren't included in requests after page.goto():
- Add credentials: 'include' to tRPC httpBatchLink if missing
- OR configure Playwright to persist cookies via storageState
- OR use page.context().addCookies() after login

**Scenario B: ProtectedClientRoute redirect logic**
If ProtectedClientRoute redirects before auth check completes:
- Add loading state handling (don't redirect while loading)
- Ensure ClientAuthContext initializes before render
- Add retry logic for auth.me query

**Scenario C: Session validation issue**
If backend rejects valid session cookies:
- Check clientPortalAuth.me query validation
- Verify cookie domain/path configuration
- Check if session is expired immediately after creation

**Scenario D: Race condition**
If auth.me runs before session cookie is set:
- Add await page.waitForTimeout() after login
- OR wait for specific auth state before navigation
- OR use page.waitForFunction() for auth cookie

**Implementation steps:**
1. Apply fix based on investigation
2. Add comments explaining the fix
3. Keep fix minimal and targeted
  </action>
  <verify>
Code compiles without errors, changes are minimal and targeted
  </verify>
  <done>
Fix implemented, ready for test verification
  </done>
</task>

<task type="auto">
  <name>Re-run E2E tests to verify fix</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts (test execution)
  </files>
  <action>
Execute full test suite in headless mode:

```bash
npx playwright test e2e/test-phase17-invoice-payment.spec.ts
```

**Expected results after fix:**
- ✅ Test 1: Login successful (already passing)
- ✅ Test 2: Invoice list displays correctly (FIXED)
- ✅ Test 3: Invoice detail page works (FIXED)
- ✅ Test 4: Pay Now button displayed for SENT invoice (FIXED)
- ✅ Test 5: Download PDF button exists (FIXED)
- ✅ Test 6: Stripe Checkout redirect attempted (FIXED)
- ✅ Test 7: Success page route exists (already passing)
- ✅ Test 8: Cancel page route exists (already passing)

**Pass criteria:** 8/8 tests passing (100%)

**If tests still fail:**
- Check error messages for new patterns
- Review screenshots in test-results/ directory
- May need to iterate on fix
  </action>
  <verify>
Playwright output shows "8 passed" with no failures
  </verify>
  <done>
All 8 E2E tests passing, Phase 17 invoice payment flow fully validated
  </done>
</task>

<task type="auto">
  <name>Clean up debug logging</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts
  </files>
  <action>
Remove any debug console.log statements added during investigation:

- Remove cookie inspection logs
- Remove auth state debugging
- Keep only the success confirmation logs (✅ Test N: ...)

Ensure test file is production-ready.
  </action>
  <verify>
No debug logging remains, tests are clean and maintainable
  </verify>
  <done>
Test file cleaned, ready for CI/CD
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Authentication flow fully understood and documented
- [ ] Root cause of session persistence bug identified
- [ ] Fix applied and committed
- [ ] All 8 Playwright tests passing (100% pass rate)
- [ ] Debug logging removed from test file
- [ ] Screenshots show correct Client Portal pages (not login redirects)
</verification>

<success_criteria>
- All 6 previously failing tests now pass
- Test pass rate: 8/8 (100%)
- Session persists after login in Playwright tests
- Invoice list, detail, and payment pages accessible after authentication
- No regression in previously passing tests
- Phase 17 UAT validation complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-2-SUMMARY.md`
</output>
