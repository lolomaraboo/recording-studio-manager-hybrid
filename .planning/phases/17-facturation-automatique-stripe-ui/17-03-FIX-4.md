---
phase: 17-facturation-automatique-stripe-ui
plan: 17-03-FIX-4
type: fix
---

<objective>
Fix localStorage persistence issue in E2E tests preventing Tests 2-6 from passing.

**Root Cause:** After login, `page.goto()` navigation clears or doesn't wait for localStorage to be saved, causing `ProtectedClientRoute` to redirect to login.

**Current Status:** 3/8 tests passing (Tests 1, 7, 8 pass; Tests 2-6 fail with redirect to login)

**Target:** 8/8 tests passing (100%)
</objective>

<context>
@.planning/STATE.md
@e2e/test-phase17-invoice-payment.spec.ts
@packages/client/src/contexts/ClientPortalAuthContext.tsx
@packages/client/src/App.tsx

**Previous investigation (17-03-FIX-3):**
- Fixed tRPC router: trpc.invoices â†’ trpc.clientPortalDashboard
- Identified ProtectedClientRoute checks isAuthenticated = !!sessionToken && !!client
- sessionToken and client loaded from localStorage on mount
- Tests 2-6 fail because localStorage not persisting between navigations
</context>

<tasks>
<task type="auto">
  <name>Investigate localStorage persistence in Playwright</name>
  <action>
Add debug logging to test to verify localStorage state:

1. After login success, log localStorage:
```typescript
await page.waitForURL(/\/client-portal/, { timeout: 5000 });

// Debug: Check localStorage after login
const storageState = await page.evaluate(() => {
  return {
    token: localStorage.getItem('client_portal_session_token'),
    client: localStorage.getItem('client_portal_client_data')
  };
});
console.log('ðŸ“¦ localStorage after login:', storageState);
```

2. Before navigating to invoices, check localStorage again:
```typescript
await page.goto('http://localhost:5174/client-portal/invoices');

// Debug: Check localStorage before page loads
const storageBeforeLoad = await page.evaluate(() => {
  return {
    token: localStorage.getItem('client_portal_session_token'),
    client: localStorage.getItem('client_portal_client_data')
  };
});
console.log('ðŸ“¦ localStorage before invoices page:', storageBeforeLoad);
```

**Goal:** Determine if localStorage is cleared or timing issue
  </action>
  <verify>
Debug logs show localStorage state at each step
  </verify>
  <done>
Understand whether localStorage persists or is cleared
  </done>
</task>

<task type="auto">
  <name>Fix localStorage persistence issue</name>
  <action>
Based on investigation findings:

**Scenario A: localStorage cleared on navigation**
If localStorage is null after page.goto:
- Use Playwright's `context.addInitScript()` to preserve storage
- Or use `page.context().storageState()` to capture and restore

**Scenario B: Timing race condition**
If localStorage exists but page loads before React hydrates:
- Add explicit wait after login:
```typescript
await page.waitForURL(/\/client-portal/, { timeout: 5000 });

// Wait for localStorage to be written
await page.waitForFunction(() => {
  return localStorage.getItem('client_portal_session_token') !== null;
}, { timeout: 2000 });

console.log('âœ… localStorage ready');
```

**Scenario C: Page reload clears state**
If page.goto() causes hard reload:
- Use `page.click()` navigation instead of `page.goto()`
- Or add `waitUntil: 'networkidle'` to page.goto

**Implementation:**
Apply minimal fix to Test 2 first, verify it passes, then apply to Tests 3-6.
  </action>
  <verify>
Test 2 passes after fix applied
  </verify>
  <done>
Fix identified and applied to one test successfully
  </done>
</task>

<task type="auto">
  <name>Apply fix to all failing tests (Tests 2-6)</name>
  <action>
Once fix verified in Test 2, apply same pattern to Tests 3-6:

- Test 3: Invoice detail navigation (line 153)
- Test 4: Pay Now button (line 192)
- Test 5: Download PDF (line 226)
- Test 6: Stripe redirect (line 253)

**Pattern to replicate:**
```typescript
// Login
await page.goto('http://localhost:5174/client-portal/login');
await page.fill('input[type="email"]', TEST_CLIENT_EMAIL);
await page.fill('input[type="password"]', TEST_CLIENT_PASSWORD);
await page.click('button[type="submit"]');
await page.waitForURL(/\/client-portal/, { timeout: 5000 });

// [FIX APPLIED HERE - wait for localStorage]

// Navigate to protected page
await page.goto('http://localhost:5174/client-portal/invoices');
```
  </action>
  <verify>
All Tests 2-6 apply same localStorage fix pattern
  </verify>
  <done>
Fix replicated across all failing tests
  </done>
</task>

<task type="auto">
  <name>Run E2E tests to verify 8/8 passing</name>
  <action>
Execute full test suite:

```bash
npx playwright test e2e/test-phase17-invoice-payment.spec.ts
```

**Expected results:**
- âœ… Test 1: Login successful (already passing)
- âœ… Test 2: Invoice list displays (FIXED)
- âœ… Test 3: Invoice detail accessible (FIXED)
- âœ… Test 4: Pay Now button displayed (FIXED)
- âœ… Test 5: Download PDF exists (FIXED)
- âœ… Test 6: Stripe redirect attempted (FIXED)
- âœ… Test 7: Success page accessible (already passing)
- âœ… Test 8: Cancel page accessible (already passing)

**Pass criteria:** 8/8 tests passing (100%)

If any tests still fail, review debug logs and iterate.
  </action>
  <verify>
Playwright output shows "8 passed (100%)" with no failures
  </verify>
  <done>
All 8 E2E tests passing, Phase 17 UAT complete
  </done>
</task>

<task type="auto">
  <name>Clean up debug logging</name>
  <action>
Remove debug console.log statements added for investigation:

1. Remove localStorage debug logs from tests
2. Keep only essential test confirmation logs (âœ… Test N: ...)
3. Ensure code is production-ready

Leave helpful comments explaining the localStorage wait if needed.
  </action>
  <verify>
Test file clean, no debug logging, maintainable
  </verify>
  <done>
Test file production-ready
  </done>
</task>
</tasks>

<verification>
- [ ] localStorage persistence issue root cause identified
- [ ] Fix applied and verified in Test 2
- [ ] Fix replicated to Tests 3-6
- [ ] All 8 Playwright tests passing (100%)
- [ ] Debug logging removed
- [ ] Test file clean and production-ready
</verification>

<success_criteria>
- 8/8 tests passing (up from 3/8)
- Test pass rate: 100%
- Phase 17 UAT validation complete
- v4.0 milestone ready for completion
</success_criteria>

<output>
After completion, create `.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-4-SUMMARY.md`

Include:
- Root cause of localStorage persistence issue
- Solution applied (timing, storage preservation, or navigation fix)
- Test results before/after (3/8 â†’ 8/8)
- Phase 17 completion confirmation
</output>
