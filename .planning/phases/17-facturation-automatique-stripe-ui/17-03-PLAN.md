---
phase: 17-facturation-automatique-stripe-ui
plan: 03
type: execute
---

<objective>
Implémenter UI de paiement d'invoices dans Client Portal avec Stripe Checkout integration.

Purpose: Permettre aux clients de voir leurs invoices, télécharger PDF, et payer via Stripe Checkout en un clic.
Output: Invoices list page avec statuts, Invoice detail page avec payment button, Stripe Checkout redirect, success/cancel pages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-facturation-automatique-stripe-ui/DISCOVERY.md
@.planning/phases/17-facturation-automatique-stripe-ui/17-01-SUMMARY.md
@.planning/phases/17-facturation-automatique-stripe-ui/17-02-SUMMARY.md

**Phase 17-01 Complete:**
- Stripe Checkout Sessions API (invoices.createPaymentSession tRPC mutation)
- Webhook handler avec idempotency (checkout.session.completed)
- Invoice status transitions (SENT → PAID/PARTIALLY_PAID)

**Phase 17-02 Complete:**
- Email notifications (Resend + React Email)
- PDF generation (PDFKit <100ms)
- S3 storage (upload + signed URLs via invoices.downloadPDF query)

**Client Portal Existing Pages (Phase 3.9.1):**
- Dashboard (packages/client/src/pages/client-portal/Dashboard.tsx)
- Profile (packages/client/src/pages/client-portal/Profile.tsx)
- Sessions (packages/client/src/pages/client-portal/Sessions.tsx)

**UI Patterns to Follow:**
- shadcn/ui components (Card, Badge, Button, Table)
- TailwindCSS 4 for styling
- Wouter for routing
- tRPC hooks: `trpc.invoices.list.useQuery()`, `trpc.invoices.createPaymentSession.useMutation()`

**Prior UI Decisions (Phase 3.14):**
- Container spacing: `pt-2 pb-4 px-2` (Client Portal section)
- Icons: `text-primary` color (h-8 w-8)
- Cards: `pb-3` headers, `text-base` titles
</context>

<tasks>

<task type="auto">
  <name>Task 1: Client Portal Invoices List Page</name>
  <files>
    packages/client/src/pages/client-portal/Invoices.tsx,
    packages/client/src/App.tsx (add route)
  </files>
  <action>
    **1. Create Invoices List Page - packages/client/src/pages/client-portal/Invoices.tsx:**

    ```tsx
    import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
    import { Badge } from '@/components/ui/badge';
    import { Button } from '@/components/ui/button';
    import { FileText } from 'lucide-react';
    import { trpc } from '@/lib/trpc';
    import { Link } from 'wouter';

    export default function Invoices() {
      const { data: invoices, isLoading } = trpc.invoices.list.useQuery();

      const getStatusBadge = (status: string) => {
        const variants = {
          DRAFT: 'secondary',
          SENT: 'default',
          PAID: 'success',
          PARTIALLY_PAID: 'warning',
          PAYMENT_FAILED: 'destructive',
        };
        return <Badge variant={variants[status]}>{status}</Badge>;
      };

      return (
        <div className="pt-2 pb-4 px-2">
          <div className="flex items-center gap-3 mb-4">
            <FileText className="h-8 w-8 text-primary" />
            <h1 className="text-2xl font-semibold">My Invoices</h1>
          </div>

          <Card>
            <CardHeader className="pb-3">
              <CardTitle className="text-base">All Invoices</CardTitle>
            </CardHeader>
            <CardContent>
              {isLoading ? (
                <div>Loading...</div>
              ) : invoices?.length === 0 ? (
                <div className="text-center py-6 text-muted-foreground">
                  No invoices yet.
                </div>
              ) : (
                <div className="divide-y">
                  {invoices?.map((invoice) => (
                    <Link key={invoice.id} href={`/client/invoices/${invoice.id}`}>
                      <div className="py-3 hover:bg-accent cursor-pointer flex items-center justify-between">
                        <div>
                          <div className="font-medium">Invoice #{invoice.invoiceNumber}</div>
                          <div className="text-sm text-muted-foreground">
                            Due {new Date(invoice.dueDate).toLocaleDateString('fr-FR')}
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          <span className="text-lg font-semibold">{invoice.total}€</span>
                          {getStatusBadge(invoice.status)}
                        </div>
                      </div>
                    </Link>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>
        </div>
      );
    }
    ```

    **2. Add Route to App.tsx:**
    ```tsx
    // In Client Portal Routes section
    <Route path="/client/invoices" component={Invoices} />
    ```

    **3. Add Navigation Link (Client Portal Layout):**
    Update `packages/client/src/components/layouts/ClientPortalLayout.tsx`:
    ```tsx
    <Link href="/client/invoices">
      <FileText className="h-5 w-5" />
      <span>Invoices</span>
    </Link>
    ```

    **IMPORTANT:**
    - Follow Phase 3.14 UI guidelines (pt-2 pb-4 px-2, text-primary icons)
    - Utiliser existing shadcn/ui components (Card, Badge, Button)
    - Status badges: PAID = success (green), SENT = default (blue), PAYMENT_FAILED = destructive (red)
    - Click on invoice → Navigate to detail page
  </action>
  <verify>
    - Page compilable: `pnpm --filter client check`
    - Navigation link visible dans Client Portal sidebar
    - Invoices list affichée avec statuts corrects (badges colorés)
    - Click on invoice → Redirige vers /client/invoices/:id
  </verify>
  <done>
    - Invoices.tsx page créée avec list view
    - Route ajoutée dans App.tsx
    - Navigation link dans ClientPortalLayout
    - Status badges avec couleurs appropriées
    - Responsive design (fonctionne sur mobile)
  </done>
</task>

<task type="auto">
  <name>Task 2: Invoice Detail Page avec Payment Button</name>
  <files>
    packages/client/src/pages/client-portal/InvoiceDetail.tsx,
    packages/client/src/App.tsx (add route)
  </files>
  <action>
    **1. Create Invoice Detail Page - packages/client/src/pages/client-portal/InvoiceDetail.tsx:**

    ```tsx
    import { useParams } from 'wouter';
    import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
    import { Badge } from '@/components/ui/badge';
    import { Button } from '@/components/ui/button';
    import { FileText, Download, CreditCard, ArrowLeft } from 'lucide-react';
    import { trpc } from '@/lib/trpc';
    import { Link } from 'wouter';
    import { toast } from '@/hooks/use-toast';

    export default function InvoiceDetail() {
      const params = useParams();
      const invoiceId = Number(params.id);

      const { data: invoice, isLoading } = trpc.invoices.getById.useQuery({ id: invoiceId });
      const { mutateAsync: createPaymentSession } = trpc.invoices.createPaymentSession.useMutation();
      const { mutateAsync: downloadPDF } = trpc.invoices.downloadPDF.useMutation();

      const handlePayNow = async () => {
        try {
          const { checkoutUrl } = await createPaymentSession({ invoiceId });
          window.location.href = checkoutUrl; // Redirect to Stripe Checkout
        } catch (error) {
          toast({ title: 'Error', description: 'Failed to create payment session', variant: 'destructive' });
        }
      };

      const handleDownloadPDF = async () => {
        try {
          const { downloadUrl } = await downloadPDF({ invoiceId });
          window.open(downloadUrl, '_blank'); // Open signed URL in new tab
        } catch (error) {
          toast({ title: 'Error', description: 'Failed to download PDF', variant: 'destructive' });
        }
      };

      if (isLoading) return <div>Loading...</div>;
      if (!invoice) return <div>Invoice not found</div>;

      const canPay = invoice.status === 'SENT' || invoice.status === 'PARTIALLY_PAID';

      return (
        <div className="pt-2 pb-4 px-2">
          <div className="flex items-center gap-3 mb-4">
            <Link href="/client/invoices">
              <Button variant="ghost" size="sm">
                <ArrowLeft className="h-4 w-4" />
              </Button>
            </Link>
            <FileText className="h-8 w-8 text-primary" />
            <h1 className="text-2xl font-semibold">Invoice #{invoice.invoiceNumber}</h1>
            <Badge variant={invoice.status === 'PAID' ? 'success' : 'default'}>
              {invoice.status}
            </Badge>
          </div>

          <div className="grid gap-4">
            {/* Invoice Summary Card */}
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="text-base">Invoice Details</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                <div className="flex justify-between">
                  <span>Issue Date:</span>
                  <span>{new Date(invoice.issueDate).toLocaleDateString('fr-FR')}</span>
                </div>
                <div className="flex justify-between">
                  <span>Due Date:</span>
                  <span>{new Date(invoice.dueDate).toLocaleDateString('fr-FR')}</span>
                </div>
                {invoice.status === 'PAID' && (
                  <div className="flex justify-between">
                    <span>Paid On:</span>
                    <span>{new Date(invoice.paidAt).toLocaleDateString('fr-FR')}</span>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Line Items Card */}
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="text-base">Line Items</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  {invoice.lineItems.map((item) => (
                    <div key={item.id} className="flex justify-between">
                      <div>
                        <div className="font-medium">{item.description}</div>
                        <div className="text-sm text-muted-foreground">
                          {item.quantity} × {item.unitPrice}€
                        </div>
                      </div>
                      <span className="font-semibold">{item.amount}€</span>
                    </div>
                  ))}
                </div>

                <div className="mt-4 pt-4 border-t space-y-1">
                  <div className="flex justify-between">
                    <span>Subtotal:</span>
                    <span>{invoice.subtotal}€</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Tax ({invoice.taxRate}%):</span>
                    <span>{invoice.taxAmount}€</span>
                  </div>
                  <div className="flex justify-between text-lg font-bold">
                    <span>Total:</span>
                    <span>{invoice.total}€</span>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Actions Card */}
            <Card>
              <CardContent className="pt-6">
                <div className="flex gap-3">
                  <Button
                    onClick={handleDownloadPDF}
                    variant="outline"
                    className="flex-1"
                  >
                    <Download className="h-4 w-4 mr-2" />
                    Download PDF
                  </Button>

                  {canPay && (
                    <Button
                      onClick={handlePayNow}
                      className="flex-1"
                    >
                      <CreditCard className="h-4 w-4 mr-2" />
                      Pay Now
                    </Button>
                  )}
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      );
    }
    ```

    **2. Add Route to App.tsx:**
    ```tsx
    <Route path="/client/invoices/:id" component={InvoiceDetail} />
    ```

    **IMPORTANT:**
    - Pay Now button: Visible seulement si status = SENT ou PARTIALLY_PAID
    - Redirect to Stripe Checkout: `window.location.href = checkoutUrl`
    - Download PDF: Open signed URL in new tab (expires after 1 hour)
    - Back button: Navigate to /client/invoices
  </action>
  <verify>
    - Page compilable: `pnpm --filter client check`
    - Invoice details affichés (dates, line items, totals)
    - Pay Now button visible pour status SENT/PARTIALLY_PAID
    - Pay Now button hidden pour status PAID
    - Click Pay Now → Redirect to Stripe Checkout (external page)
    - Download PDF → Opens PDF in new tab
  </verify>
  <done>
    - InvoiceDetail.tsx page créée avec full invoice info
    - Route ajoutée dans App.tsx
    - Pay Now button avec Stripe Checkout redirect
    - Download PDF button avec signed URLs
    - Back navigation to invoices list
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Client Portal Invoice Payment UI avec Stripe Checkout integration</what-built>
  <how-to-verify>
    1. Run: `pnpm dev` (both client and server)
    2. Login as client: http://localhost:5174/client/login
    3. Navigate: Client Portal → Invoices (new menu item)
    4. Invoices List Page:
       - Verify: List of invoices affichée
       - Verify: Status badges avec couleurs correctes (PAID=green, SENT=blue, PAYMENT_FAILED=red)
       - Click: On an invoice → Redirects to detail page
    5. Invoice Detail Page:
       - Verify: Invoice number, dates, line items, totals affichés
       - Verify: Download PDF button → Opens PDF in new tab (signed URL)
       - Verify: Pay Now button visible pour status SENT/PARTIALLY_PAID
       - Verify: Pay Now button hidden pour status PAID
       - Click: Pay Now → Redirects to Stripe Checkout (external hosted page)
    6. Stripe Checkout Flow (Test Mode):
       - Use test card: 4242 4242 4242 4242, exp 12/34, CVC 123
       - Complete payment → Redirected to success page
       - Verify: Invoice status updated to PAID (check in database or reload invoice page)
    7. Responsive Design:
       - Resize browser to mobile width (375px)
       - Verify: Layout adapts correctly, buttons stackable, cards responsive
  </how-to-verify>
  <resume-signal>Type "approved" to continue to final validation, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Stripe Checkout Success & Cancel Pages</name>
  <files>
    packages/client/src/pages/client-portal/InvoicePaymentSuccess.tsx,
    packages/client/src/pages/client-portal/InvoicePaymentCanceled.tsx,
    packages/client/src/App.tsx (add routes)
  </files>
  <action>
    **1. Success Page - packages/client/src/pages/client-portal/InvoicePaymentSuccess.tsx:**

    ```tsx
    import { Card, CardContent } from '@/components/ui/card';
    import { Button } from '@/components/ui/button';
    import { CheckCircle } from 'lucide-react';
    import { Link, useSearch } from 'wouter';

    export default function InvoicePaymentSuccess() {
      const search = useSearch();
      const sessionId = new URLSearchParams(search).get('session_id');

      return (
        <div className="pt-2 pb-4 px-2">
          <div className="max-w-md mx-auto mt-12">
            <Card>
              <CardContent className="pt-6 text-center space-y-4">
                <CheckCircle className="h-16 w-16 text-green-500 mx-auto" />
                <h1 className="text-2xl font-semibold">Payment Successful!</h1>
                <p className="text-muted-foreground">
                  Your invoice payment has been processed successfully.
                  You will receive a confirmation email shortly.
                </p>
                {sessionId && (
                  <p className="text-xs text-muted-foreground">
                    Session ID: {sessionId}
                  </p>
                )}
                <Link href="/client/invoices">
                  <Button className="w-full mt-4">
                    View All Invoices
                  </Button>
                </Link>
              </CardContent>
            </Card>
          </div>
        </div>
      );
    }
    ```

    **2. Cancel Page - packages/client/src/pages/client-portal/InvoicePaymentCanceled.tsx:**

    ```tsx
    import { Card, CardContent } from '@/components/ui/card';
    import { Button } from '@/components/ui/button';
    import { XCircle } from 'lucide-react';
    import { Link } from 'wouter';

    export default function InvoicePaymentCanceled() {
      return (
        <div className="pt-2 pb-4 px-2">
          <div className="max-w-md mx-auto mt-12">
            <Card>
              <CardContent className="pt-6 text-center space-y-4">
                <XCircle className="h-16 w-16 text-orange-500 mx-auto" />
                <h1 className="text-2xl font-semibold">Payment Canceled</h1>
                <p className="text-muted-foreground">
                  Your payment was canceled. You can try again anytime.
                </p>
                <Link href="/client/invoices">
                  <Button variant="outline" className="w-full mt-4">
                    Back to Invoices
                  </Button>
                </Link>
              </CardContent>
            </Card>
          </div>
        </div>
      );
    }
    ```

    **3. Add Routes to App.tsx:**
    ```tsx
    <Route path="/client/invoices/success" component={InvoicePaymentSuccess} />
    <Route path="/client/invoices/canceled" component={InvoicePaymentCanceled} />
    ```

    **IMPORTANT:**
    - Success page extracts `session_id` from query params (Stripe includes it)
    - Invoice status automatically updated by webhook (pas besoin query manuelle ici)
    - Cancel page permet retry en revenant à /client/invoices
  </action>
  <verify>
    - Pages compilables: `pnpm --filter client check`
    - Success page affichée après Stripe Checkout payment
    - session_id query param affiché si présent
    - Cancel page affichée si user cancels Stripe Checkout
    - Back button navigate to /client/invoices
  </verify>
  <done>
    - InvoicePaymentSuccess.tsx créée avec confirmation message
    - InvoicePaymentCanceled.tsx créée avec retry option
    - Routes ajoutées dans App.tsx
    - Query params extraction (session_id)
    - Navigation back to invoices list
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm check` passes (0 TypeScript errors)
- [ ] Client Portal navigation: Invoices menu item visible
- [ ] Invoices list page affiche tous invoices avec status badges
- [ ] Invoice detail page affiche full info (dates, line items, totals)
- [ ] Pay Now button redirect to Stripe Checkout
- [ ] Download PDF button opens PDF in new tab
- [ ] Stripe Checkout success → Redirected to success page
- [ ] Invoice status updated to PAID after payment (webhook works)
- [ ] Responsive design: Fonctionne sur mobile (375px width)
</verification>

<success_criteria>
- All 4 tasks completed
- Client Portal Invoice UI opérationnel
- Stripe Checkout integration fonctionnelle (redirect + payment)
- PDF download avec signed URLs
- Success/Cancel pages implemented
- Human verification passed (checkpoint approved)
- 0 TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-facturation-automatique-stripe-ui/17-03-SUMMARY.md`:

# Phase 17 Plan 3: Client Portal Invoice Payment UI Summary

**Invoice payment UI avec Stripe Checkout integration complete**

## Accomplishments

- Client Portal Invoices list page (status badges, navigation)
- Invoice detail page avec Pay Now button
- Stripe Checkout redirect integration
- PDF download avec signed URLs
- Success/Cancel pages après payment

## Files Created/Modified

- `packages/client/src/pages/client-portal/Invoices.tsx` - List page
- `packages/client/src/pages/client-portal/InvoiceDetail.tsx` - Detail page avec payment
- `packages/client/src/pages/client-portal/InvoicePaymentSuccess.tsx` - Success page
- `packages/client/src/pages/client-portal/InvoicePaymentCanceled.tsx` - Cancel page
- `packages/client/src/components/layouts/ClientPortalLayout.tsx` - Navigation link
- `packages/client/src/App.tsx` - Routes ajoutées

## Decisions Made

- Stripe Checkout redirect (pas embedded Payment Element) - consistent avec backend choice
- Signed URLs pour PDF download (expires 1h) - security best practice
- Success/Cancel pages simples (pas complex order history) - MVP approach
- Status badges color-coded: PAID=green, SENT=blue, PAYMENT_FAILED=red

## Issues Encountered

[Document any issues and resolutions, or "None"]

## Next Step

**Phase 17 COMPLETE** ✅ - Invoice payment workflow end-to-end fonctionnel:
1. Auto-invoice generation (Phase 16)
2. Stripe Checkout Sessions (Phase 17-01)
3. Email + PDF + S3 (Phase 17-02)
4. Client Portal UI (Phase 17-03)

Ready for Phase 18 or return to v4.0 Milestone review.
</output>
