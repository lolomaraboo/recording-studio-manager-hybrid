---
phase: 17-facturation-automatique-stripe-ui
plan: 17-03-FIX
type: fix
---

<objective>
Fix 5 UAT failures in Phase 17-03 E2E tests caused by incorrect route paths.

**Root Cause:** Test file uses `/client/*` paths but actual routes are `/client-portal/*`

**Impact:** 5/8 tests failing (62% failure rate)
- Invoice List Display
- Invoice Detail Navigation
- Pay Now Button visibility
- Download PDF Button visibility
- Stripe Checkout Redirect

**Priority:** Critical - All Client Portal invoice features untested
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Original plan:**
@.planning/phases/17-facturation-automatique-stripe-ui/17-03-PLAN.md

**UAT Report:**
@.planning/phases/17-facturation-automatique-stripe-ui/17-UAT-REPORT.md

**Test file with errors:**
@e2e/test-phase17-invoice-payment.spec.ts

**Routing configuration:**
@packages/client/src/App.tsx (lines 107-125)

**Actual component:**
@packages/client/src/pages/client-portal/ClientInvoices.tsx
</context>

<tasks>
<task type="auto">
  <name>Fix route paths in E2E test file</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts
  </files>
  <action>
Update all incorrect route references from `/client/` to `/client-portal/`:

**Lines to fix:**
1. Line 115: `await page.waitForURL(/\/client/, { timeout: 5000 });`
   - Change to: `/\/client-portal/`

2. Line 118: `expect(page.url()).toMatch(/\/client/);`
   - Change to: `/\/client-portal/`

3. Line 129: `await page.waitForURL(/\/client/, { timeout: 5000 });`
   - Change to: `/\/client-portal/`

4. Line 132: `await page.goto('http://localhost:5174/client/invoices');`
   - Change to: `http://localhost:5174/client-portal/invoices`

5. Line 158: `await page.waitForURL(/\/client/, { timeout: 5000 });`
   - Change to: `/\/client-portal/`

6. Line 161: `await page.goto('http://localhost:5174/client/invoices');`
   - Change to: `http://localhost:5174/client-portal/invoices`

7. Line 169: `await page.waitForURL(/\/client\/invoices\/\d+/, { timeout: 5000 });`
   - Change to: `/\/client-portal\/invoices\/\d+/`

8. Line 194: `await page.waitForURL(/\/client/, { timeout: 5000 });`
   - Change to: `/\/client-portal/`

9. Line 196: `await page.goto('http://localhost:5174/client/invoices');`
   - Change to: `http://localhost:5174/client-portal/invoices`

10. Line 205: `await page.waitForURL(/\/client\/invoices\/\d+/, { timeout: 5000 });`
    - Change to: `/\/client-portal\/invoices\/\d+/`

11. Line 225: `await page.waitForURL(/\/client/, { timeout: 5000 });`
    - Change to: `/\/client-portal/`

12. Line 227: `await page.goto('http://localhost:5174/client/invoices');`
    - Change to: `http://localhost:5174/client-portal/invoices`

13. Line 232: `await page.waitForURL(/\/client\/invoices\/\d+/, { timeout: 5000 });`
    - Change to: `/\/client-portal\/invoices\/\d+/`

14. Line 249: `await page.waitForURL(/\/client/, { timeout: 5000 });`
    - Change to: `/\/client-portal/`

15. Line 251: `await page.goto('http://localhost:5174/client/invoices');`
    - Change to: `http://localhost:5174/client-portal/invoices`

16. Line 259: `await page.waitForURL(/\/client\/invoices\/\d+/, { timeout: 5000 });`
    - Change to: `/\/client-portal\/invoices\/\d+/`

17. Line 288: `await page.goto('http://localhost:5174/client/invoices/success?session_id=test_session_123');`
    - Change to: `http://localhost:5174/client-portal/invoices/success?session_id=test_session_123`

18. Line 295: `expect(url).toContain('/client/invoices/success');`
    - Change to: `'/client-portal/invoices/success'`

19. Line 302: `await page.goto('http://localhost:5174/client/invoices/canceled');`
    - Change to: `http://localhost:5174/client-portal/invoices/canceled`

20. Line 309: `expect(url).toContain('/client/invoices/canceled');`
    - Change to: `'/client-portal/invoices/canceled'`

Also update line 142 for consistency:
21. Line 142: `const invoiceCount = await page.locator('[href*="/client/invoices/"]').count();`
    - Change to: `'[href*="/client-portal/invoices/"]'`

22. Lines 165, 230, 257: `const firstInvoice = page.locator('[href*="/client/invoices/"]').first();`
    - Change to: `'[href*="/client-portal/invoices/"]'`

**Search and replace pattern:**
- Find: `/client/`
- Replace: `/client-portal/`
- Context: URLs, route patterns, and href selectors
  </action>
  <verify>
Run `grep -n "/client/" e2e/test-phase17-invoice-payment.spec.ts` to ensure no incorrect paths remain
  </verify>
  <done>
All route references updated to use correct `/client-portal/` prefix
  </done>
</task>

<task type="auto">
  <name>Re-run E2E tests to verify all pass</name>
  <files>
    - e2e/test-phase17-invoice-payment.spec.ts (test execution)
  </files>
  <action>
Execute the full test suite in headless mode:

```bash
npx playwright test e2e/test-phase17-invoice-payment.spec.ts
```

**Expected results:**
- ✅ Test 1: Login successful (already passing)
- ✅ Test 2: Invoice list displays correctly (FIXED)
- ✅ Test 3: Invoice detail page works (FIXED)
- ✅ Test 4: Pay Now button displayed for SENT invoice (FIXED)
- ✅ Test 5: Download PDF button exists (FIXED)
- ✅ Test 6: Stripe Checkout redirect attempted (FIXED)
- ✅ Test 7: Success page route exists (already passing)
- ✅ Test 8: Cancel page route exists (already passing)

**Pass criteria:** 8/8 tests passing (100%)
  </action>
  <verify>
Check Playwright output shows "8 passed" with no failures
  </verify>
  <done>
All 8 E2E tests passing, Phase 17 invoice payment flow fully validated
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] All `/client/` references replaced with `/client-portal/`
- [ ] No remaining incorrect route paths in test file
- [ ] All 8 Playwright tests passing (100% pass rate)
- [ ] Test results show successful navigation to invoice pages
- [ ] Screenshots/traces show correct Client Portal UI (not admin dashboard)
</verification>

<success_criteria>
- All 5 previously failing tests now pass
- Test pass rate: 8/8 (100%)
- Invoice list page displays "My Invoices" heading
- Navigation to invoice detail pages works
- Pay Now and Download PDF buttons visible
- Success/Cancel page routes accessible
</success_criteria>

<output>
After completion, create `.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-SUMMARY.md`
</output>
