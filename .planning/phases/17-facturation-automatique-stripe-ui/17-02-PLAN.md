---
phase: 17-facturation-automatique-stripe-ui
plan: 02
type: execute
---

<objective>
Implémenter email notifications (Resend) et génération PDF (PDFKit) avec stockage S3.

Purpose: Envoyer emails automatiques avec invoice PDF en pièce jointe (created, paid, failed), stocker PDFs de façon scalable.
Output: Service email configuré, génération PDF programmatique, stockage S3 avec signed URLs, déclenchement automatique via webhooks.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-facturation-automatique-stripe-ui/DISCOVERY.md
@.planning/phases/17-facturation-automatique-stripe-ui/17-01-SUMMARY.md

**Phase 17-01 Complete:**
- Stripe Checkout Sessions création (tRPC mutation)
- Webhook handler avec idempotency (stripe_webhook_events table)
- Invoice status updates atomiques (SENT → PAID/PARTIALLY_PAID)

**Technical Decisions (from DISCOVERY.md):**
- Email: Resend (React Email, 3k gratuits/mois)
- PDF: PDFKit (programmatique, <100ms, 20MB RAM)
- Storage: AWS S3 (scalable, signed URLs, encryption at rest)

**Email Triggers:**
- Invoice created (manual send) → `invoices/send-invoice` procedure
- Payment succeeded → Webhook `checkout.session.completed`
- Payment failed → Webhook `payment_intent.payment_failed`
- Deposit paid → Webhook avec metadata.isDeposit = true

**Codebase Constraints:**
- Cloudinary déjà intégré (Phase 5 audio uploads) - réutiliser pattern upload
- tRPC procedures: `ctx.getTenantDb()` pour tenant-specific queries
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Resend Email Service & React Email Template</name>
  <files>
    packages/server/src/services/email/resend-service.ts,
    packages/server/src/emails/InvoiceEmail.tsx,
    packages/server/package.json
  </files>
  <action>
    **1. Install Dependencies:**
    ```bash
    cd packages/server
    pnpm add resend react-email
    pnpm add -D @react-email/components
    ```

    **2. Resend Service - packages/server/src/services/email/resend-service.ts:**
    ```typescript
    import { Resend } from 'resend';
    import { InvoiceEmail } from '../../emails/InvoiceEmail';

    const resend = new Resend(process.env.RESEND_API_KEY);

    export async function sendInvoiceEmail(params: {
      to: string;
      subject: string;
      invoiceData: InvoiceWithLineItems;
      pdfBuffer?: Buffer; // Optional PDF attachment
    }) {
      const { data, error } = await resend.emails.send({
        from: `${process.env.STUDIO_NAME} <invoices@${process.env.EMAIL_DOMAIN}>`,
        to: params.to,
        subject: params.subject,
        react: InvoiceEmail({ invoice: params.invoiceData }),
        attachments: params.pdfBuffer ? [
          {
            filename: `invoice-${params.invoiceData.invoiceNumber}.pdf`,
            content: params.pdfBuffer,
          },
        ] : [],
      });

      if (error) throw new Error(`Email send failed: ${error.message}`);
      return data;
    }
    ```

    **3. React Email Template - packages/server/src/emails/InvoiceEmail.tsx:**
    ```tsx
    import { Html, Head, Body, Container, Text, Section, Hr } from '@react-email/components';

    export function InvoiceEmail({ invoice }: { invoice: InvoiceWithLineItems }) {
      return (
        <Html>
          <Head />
          <Body style={{ backgroundColor: '#f6f9fc', fontFamily: 'sans-serif' }}>
            <Container style={{ margin: '0 auto', padding: '20px 0' }}>
              <Section style={{ backgroundColor: '#ffffff', padding: '24px', borderRadius: '8px' }}>
                <Text style={{ fontSize: '24px', fontWeight: 'bold' }}>
                  Invoice #{invoice.invoiceNumber}
                </Text>
                <Hr />
                <Text>Amount Due: {invoice.total}€</Text>
                <Text>Due Date: {new Date(invoice.dueDate).toLocaleDateString('fr-FR')}</Text>
                {/* Line items, payment link, footer... */}
              </Section>
            </Container>
          </Body>
        </Html>
      );
    }
    ```

    **4. Environment Variables (.env.example):**
    ```bash
    RESEND_API_KEY=re_...
    EMAIL_DOMAIN=recording-studio-manager.com
    STUDIO_NAME=Your Studio Name
    ```

    **IMPORTANT:**
    - Resend free tier: 3,000 emails/month, 100 emails/day
    - Email domain must be verified in Resend dashboard (add DNS records)
    - React Email permet réutiliser components React pour cohérence branding
  </action>
  <verify>
    - Dependencies installed: `pnpm list resend react-email`
    - Service compilable: `pnpm --filter server check`
    - Test email manual (await sendInvoiceEmail({ to: 'test@example.com', ... }))
  </verify>
  <done>
    - Resend service configuré (resend-service.ts)
    - React Email template créé (InvoiceEmail.tsx)
    - Environment variables documentées
    - Test email envoyé avec succès
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate Invoice PDF with PDFKit</name>
  <files>
    packages/server/src/services/pdf/invoice-pdf-generator.ts,
    packages/server/package.json
  </files>
  <action>
    **1. Install PDFKit:**
    ```bash
    cd packages/server
    pnpm add pdfkit @types/pdfkit
    ```

    **2. PDF Generator Service - packages/server/src/services/pdf/invoice-pdf-generator.ts:**
    ```typescript
    import PDFDocument from 'pdfkit';

    export async function generateInvoicePDF(invoice: InvoiceWithLineItems): Promise<Buffer> {
      return new Promise((resolve, reject) => {
        const chunks: Buffer[] = [];
        const doc = new PDFDocument({ size: 'A4', margin: 50 });

        // Collect PDF data
        doc.on('data', (chunk) => chunks.push(chunk));
        doc.on('end', () => resolve(Buffer.concat(chunks)));
        doc.on('error', reject);

        // Header
        doc.fontSize(20).text('INVOICE', { align: 'right' });
        doc.fontSize(10).text(`#${invoice.invoiceNumber}`, { align: 'right' });
        doc.moveDown();

        // Organization Info
        doc.fontSize(12).text(process.env.STUDIO_NAME || 'Your Studio', { align: 'left' });
        doc.fontSize(10).text('Address, City, Country');
        doc.text('Email: invoices@yourstudio.com');
        doc.moveDown();

        // Client Info
        doc.text(`Bill To: ${invoice.client.name}`);
        doc.text(`Email: ${invoice.client.email}`);
        doc.moveDown();

        // Invoice Details
        doc.text(`Issue Date: ${new Date(invoice.issueDate).toLocaleDateString('fr-FR')}`);
        doc.text(`Due Date: ${new Date(invoice.dueDate).toLocaleDateString('fr-FR')}`);
        doc.text(`Status: ${invoice.status}`);
        doc.moveDown(2);

        // Line Items Table
        doc.fontSize(12).text('Description', 50, doc.y, { continued: true, width: 250 });
        doc.text('Qty', { continued: true, width: 50, align: 'center' });
        doc.text('Rate', { continued: true, width: 80, align: 'right' });
        doc.text('Amount', { width: 80, align: 'right' });
        doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();
        doc.moveDown();

        invoice.lineItems.forEach((item) => {
          doc.fontSize(10)
            .text(item.description, 50, doc.y, { continued: true, width: 250 })
            .text(item.quantity.toString(), { continued: true, width: 50, align: 'center' })
            .text(`${item.unitPrice}€`, { continued: true, width: 80, align: 'right' })
            .text(`${item.amount}€`, { width: 80, align: 'right' });
          doc.moveDown(0.5);
        });

        // Totals
        doc.moveDown();
        doc.text(`Subtotal: ${invoice.subtotal}€`, { align: 'right' });
        doc.text(`Tax (${invoice.taxRate}%): ${invoice.taxAmount}€`, { align: 'right' });
        doc.fontSize(12).text(`Total: ${invoice.total}€`, { align: 'right' });

        // Footer
        doc.fontSize(8).text('Thank you for your business!', 50, 750, { align: 'center' });

        doc.end();
      });
    }
    ```

    **IMPORTANT:**
    - PDFKit génère programmatiquement (pas HTML/CSS) → rapide <100ms
    - Coordonnées x/y pour layout (doc.y = position verticale courante)
    - Utiliser doc.moveDown() pour espacement vertical
    - Buffer résultat → pass to S3 upload OR email attachment
  </action>
  <verify>
    - PDFKit installed: `pnpm list pdfkit`
    - Service compilable: `pnpm --filter server check`
    - Test PDF generation: const buffer = await generateInvoicePDF(invoice); fs.writeFileSync('test.pdf', buffer);
    - PDF ouvert visuellement → layout correct, line items visible, totals calculés
  </verify>
  <done>
    - invoice-pdf-generator.ts créé avec PDFKit
    - Génération PDF <100ms (testé)
    - Layout professionnel: header, client info, line items table, totals, footer
    - Buffer retourné pour upload S3 ou email attachment
  </done>
</task>

<task type="auto">
  <name>Task 3: AWS S3 Integration - Upload PDF & Generate Signed URLs</name>
  <files>
    packages/server/src/services/storage/s3-service.ts,
    packages/database/src/tenant/schema.ts (add pdfS3Key to invoices),
    packages/database/migrations/[timestamp]_invoice_pdf_s3.ts,
    packages/server/package.json
  </files>
  <action>
    **1. Install AWS SDK:**
    ```bash
    cd packages/server
    pnpm add @aws-sdk/client-s3 @aws-sdk/s3-request-presigner
    ```

    **2. S3 Service - packages/server/src/services/storage/s3-service.ts:**
    ```typescript
    import { S3Client, PutObjectCommand, GetObjectCommand } from '@aws-sdk/client-s3';
    import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

    const s3Client = new S3Client({
      region: process.env.AWS_REGION || 'eu-west-3',
      credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
      },
    });

    export async function uploadInvoicePDF(params: {
      invoiceId: number;
      organizationId: number;
      pdfBuffer: Buffer;
      filename: string;
    }): Promise<string> {
      const key = `invoices/${params.organizationId}/${params.invoiceId}/${Date.now()}-${params.filename}`;

      await s3Client.send(new PutObjectCommand({
        Bucket: process.env.S3_BUCKET_NAME!,
        Key: key,
        Body: params.pdfBuffer,
        ContentType: 'application/pdf',
        ServerSideEncryption: 'AES256', // Encrypt at rest
      }));

      return key; // Store in database
    }

    export async function getInvoicePDFUrl(s3Key: string): Promise<string> {
      const command = new GetObjectCommand({
        Bucket: process.env.S3_BUCKET_NAME!,
        Key: s3Key,
      });

      return getSignedUrl(s3Client, command, { expiresIn: 3600 }); // 1 hour expiry
    }
    ```

    **3. Migration - Add pdfS3Key to invoices table:**
    ```sql
    ALTER TABLE invoices ADD COLUMN pdf_s3_key TEXT;
    ```

    **4. Update invoices.ts tRPC router:**
    - Ajouter query `invoices.downloadPDF`:
      - Input: z.object({ invoiceId: z.number() })
      - Load invoice.pdfS3Key
      - Generate signed URL: `await getInvoicePDFUrl(invoice.pdfS3Key)`
      - Retourner: { downloadUrl }

    **5. Environment Variables (.env.example):**
    ```bash
    AWS_ACCESS_KEY_ID=AKIA...
    AWS_SECRET_ACCESS_KEY=...
    AWS_REGION=eu-west-3
    S3_BUCKET_NAME=rsm-invoices-prod
    ```

    **IMPORTANT:**
    - S3 bucket must be created manually (AWS Console or Terraform)
    - Enable versioning on bucket for audit trail
    - Lifecycle policy: Delete objects >7 years old (tax retention period)
    - IAM permissions: s3:PutObject, s3:GetObject on bucket
  </action>
  <verify>
    - AWS SDK installed: `pnpm list @aws-sdk/client-s3`
    - Migration applied: `pnpm db:migrate`
    - S3 bucket créé et accessible (test upload manual)
    - Signed URL generated → PDF downloadable via URL (expires after 1h)
  </verify>
  <done>
    - s3-service.ts créé (uploadInvoicePDF, getInvoicePDFUrl)
    - Migration pdfS3Key ajouté à invoices table
    - tRPC query downloadPDF avec signed URLs
    - Environment variables S3 documentées
    - Test: Upload PDF → Generate signed URL → Download works
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate Email + PDF in Webhook & Invoice Send</name>
  <files>
    packages/server/src/routes/webhooks-stripe.ts,
    packages/server/src/routers/invoices.ts
  </files>
  <action>
    **1. Update Webhook Handler (webhooks-stripe.ts):**

    Dans `checkout.session.completed` handler:
    ```typescript
    // After updating invoice status to PAID
    const invoice = await tenantDb.query.invoices.findFirst({
      where: eq(invoices.id, invoiceId),
      with: { client: true, lineItems: true },
    });

    // Generate PDF
    const pdfBuffer = await generateInvoicePDF(invoice);

    // Upload to S3
    const pdfS3Key = await uploadInvoicePDF({
      invoiceId: invoice.id,
      organizationId,
      pdfBuffer,
      filename: `invoice-${invoice.invoiceNumber}.pdf`,
    });

    // Update invoice with S3 key
    await tenantDb.update(invoices)
      .set({ pdfS3Key })
      .where(eq(invoices.id, invoiceId));

    // Send email with PDF attachment
    await sendInvoiceEmail({
      to: invoice.client.email,
      subject: `Payment Received - Invoice #${invoice.invoiceNumber}`,
      invoiceData: invoice,
      pdfBuffer, // Attach PDF to email
    });
    ```

    Dans `payment_intent.payment_failed` handler:
    ```typescript
    await sendInvoiceEmail({
      to: invoice.client.email,
      subject: `Payment Failed - Invoice #${invoice.invoiceNumber}`,
      invoiceData: invoice,
      // NO PDF attachment for failed payments
    });
    ```

    **2. New tRPC Mutation: invoices.sendInvoice (Manual Send):**
    ```typescript
    sendInvoice: protectedProcedure
      .input(z.object({ invoiceId: z.number() }))
      .mutation(async ({ ctx, input }) => {
        const tenantDb = await ctx.getTenantDb();

        // Load invoice
        const invoice = await tenantDb.query.invoices.findFirst({
          where: eq(invoices.id, input.invoiceId),
          with: { client: true, lineItems: true },
        });

        if (!invoice) throw new Error('Invoice not found');

        // Generate PDF
        const pdfBuffer = await generateInvoicePDF(invoice);

        // Upload to S3
        const pdfS3Key = await uploadInvoicePDF({
          invoiceId: invoice.id,
          organizationId: ctx.organizationId,
          pdfBuffer,
          filename: `invoice-${invoice.invoiceNumber}.pdf`,
        });

        // Update invoice status & S3 key
        await tenantDb.update(invoices)
          .set({ status: 'SENT', pdfS3Key, sentAt: new Date() })
          .where(eq(invoices.id, input.invoiceId));

        // Send email with PDF
        await sendInvoiceEmail({
          to: invoice.client.email,
          subject: `Invoice #${invoice.invoiceNumber} from ${process.env.STUDIO_NAME}`,
          invoiceData: invoice,
          pdfBuffer,
        });

        return { success: true };
      }),
    ```

    **IMPORTANT:**
    - Toujours générer PDF + upload S3 AVANT envoyer email (garantit attachment disponible)
    - Tous les webhooks doivent respond 200 OK rapidement → Async email send si long (>5s)
    - Gérer erreurs email gracefully: Logger error mais pas throw (sinon webhook retry infiniment)
  </action>
  <verify>
    - Webhook `checkout.session.completed` → Email sent with PDF attachment
    - Manual send: `invoices.sendInvoice` mutation → Client receives email + PDF
    - S3 storage: pdfS3Key sauvegardé dans database after upload
    - Error handling: Email failure logged mais pas crash webhook
  </verify>
  <done>
    - Webhook handlers intégrés avec email + PDF
    - New mutation `invoices.sendInvoice` pour envoi manuel
    - PDF uploaded to S3 before email send
    - Email attachments fonctionnels (PDF visible dans inbox)
    - Error handling graceful pour email failures
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm check` passes (0 TypeScript errors)
- [ ] Resend email service opérationnel (test email reçu)
- [ ] PDF generation works (PDFKit génère layout professionnel)
- [ ] S3 upload successful (PDF accessible via signed URL)
- [ ] Webhook `checkout.session.completed` → Email avec PDF attachment
- [ ] Manual send `invoices.sendInvoice` → Email + PDF envoyés
- [ ] Error handling: Email failures logged, pas crash
</verification>

<success_criteria>
- All 4 tasks completed
- Resend email service configuré avec React Email templates
- PDFKit génération PDF opérationnelle (<100ms)
- S3 storage intégré avec signed URLs
- Email notifications automatiques via webhooks
- Manual invoice send mutation fonctionnelle
- 0 TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-facturation-automatique-stripe-ui/17-02-SUMMARY.md`:

# Phase 17 Plan 2: Email Notifications & PDF Generation Summary

**Resend + PDFKit + S3 integration complete**

## Accomplishments

- Resend email service configured (React Email templates)
- PDFKit invoice PDF generation (<100ms, programmatic layout)
- AWS S3 storage integration (upload + signed URLs)
- Email notifications automatiques (webhook triggered)
- Manual invoice send mutation (invoices.sendInvoice)

## Files Created/Modified

- `packages/server/src/services/email/resend-service.ts` - Resend wrapper
- `packages/server/src/emails/InvoiceEmail.tsx` - React Email template
- `packages/server/src/services/pdf/invoice-pdf-generator.ts` - PDFKit generator
- `packages/server/src/services/storage/s3-service.ts` - S3 upload + signed URLs
- `packages/server/src/routes/webhooks-stripe.ts` - Intégration email + PDF
- `packages/server/src/routers/invoices.ts` - sendInvoice mutation + downloadPDF query
- `packages/database/src/tenant/schema.ts` - pdfS3Key column
- `packages/database/migrations/[timestamp]_invoice_pdf_s3.ts` - Migration
- `packages/server/.env.example` - Resend + AWS environment variables

## Decisions Made

- Resend over SendGrid (React Email integration, simpler API)
- PDFKit over Puppeteer (MVP speed <100ms, lightweight 20MB RAM)
- S3 over filesystem (scalable, cloud-native, required for Docker/Heroku)
- PDF uploaded before email send (guarantees attachment availability)

## Issues Encountered

[Document any issues and resolutions, or "None"]

## Next Step

Ready for **17-03-PLAN.md**: Client Portal Invoice Payment UI (React frontend)
</output>
