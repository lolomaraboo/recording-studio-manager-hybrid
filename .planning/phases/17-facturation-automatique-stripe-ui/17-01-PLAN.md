---
phase: 17-facturation-automatique-stripe-ui
plan: 01
type: execute
---

<objective>
Intégrer Stripe Checkout Sessions pour paiements d'invoices et webhooks avec idempotency.

Purpose: Permettre aux clients de payer les invoices via Stripe Checkout avec tracking automatique du statut de paiement.
Output: Stripe Checkout Session creation, webhook endpoint avec event tracking, invoice status updates atomiques.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-facturation-automatique-stripe-ui/DISCOVERY.md

**Phase 16 Complete (Backend):**
- Auto-invoice generation service (`packages/server/src/services/invoices/auto-invoice-generator.ts`)
- Stripe Payment Intent pour deposits (`packages/server/src/services/payments/stripe-payment-service.ts`)
- Tax calculator avec multi-rate French VAT (`packages/server/src/utils/tax-calculator.ts`)

**Codebase Constraints:**
- Stripe déjà intégré pour subscriptions (Phase 3)
- tRPC routers utilisent `ctx.getTenantDb()` pour accès tenant-specific
- Database-per-Tenant architecture active

**Technical Decisions (from DISCOVERY.md):**
- Stripe Checkout Sessions (mode: 'payment', invoice_creation: enabled)
- Webhooks: `checkout.session.completed` + `payment_intent.succeeded`
- Idempotency: Event ID tracking table (stripe_webhook_events)
- Signature verification obligatoire (express.raw() middleware)

**Prior Decisions Affecting This Phase:**
- Phase 3: Stripe SDK installed, webhooks infrastructure existe
- Phase 16-02: Payment Intent patterns établis (réutiliser structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stripe Checkout Session Creation - tRPC Procedure</name>
  <files>packages/server/src/routers/invoices.ts, packages/shared/types/invoices.ts</files>
  <action>
    Créer tRPC mutation `invoices.createPaymentSession`:
    - Input: z.object({ invoiceId: z.number() })
    - Validation: invoice existe, status = SENT (pas déjà PAID)
    - Appeler Stripe API: `stripe.checkout.sessions.create()`
      - mode: 'payment'
      - line_items: Mapper depuis invoice line items (description, quantity, unit_amount en centimes)
      - metadata: { invoiceId, organizationId }
      - invoice_creation: { enabled: true } (auto-génère Stripe invoice PDF)
      - success_url: `${process.env.APP_URL}/invoices/success?session_id={CHECKOUT_SESSION_ID}`
      - cancel_url: `${process.env.APP_URL}/invoices?canceled=true`
    - Retourner: { sessionId, checkoutUrl }

    **Partial Payments (Deposits):**
    Si invoice.depositAmount existe et > 0:
    - Utiliser line_item avec montant = depositAmount au lieu du total
    - Ajouter metadata.isDeposit = 'true' pour webhook handler
    - Stripe tracke automatiquement le balance restant

    **IMPORTANT:** Utiliser structure Stripe existante (voir Phase 3 subscriptions routers)
    NE PAS créer custom payment intents - Checkout Sessions gère tout nativement
  </action>
  <verify>
    - `pnpm --filter server check` (0 TypeScript errors)
    - tRPC procedure callable depuis client
    - Test manuel: créer session, vérifier checkoutUrl valide
  </verify>
  <done>
    - Mutation `invoices.createPaymentSession` définie
    - Input/output types dans shared package
    - Checkout URL redirige vers Stripe hosted page
  </done>
</task>

<task type="auto">
  <name>Task 2: Webhook Handler avec Idempotency Event Tracking</name>
  <files>
    packages/server/src/routes/webhooks-stripe.ts,
    packages/database/src/tenant/schema.ts,
    packages/database/migrations/[timestamp]_webhook_events.ts
  </files>
  <action>
    **1. Migration - Table stripe_webhook_events:**
    ```sql
    CREATE TABLE stripe_webhook_events (
      id SERIAL PRIMARY KEY,
      event_id TEXT UNIQUE NOT NULL,
      event_type TEXT NOT NULL,
      processed_at TIMESTAMP NOT NULL DEFAULT NOW(),
      invoice_id INTEGER REFERENCES invoices(id) ON DELETE SET NULL,
      created_at TIMESTAMP NOT NULL DEFAULT NOW()
    );
    CREATE INDEX idx_webhook_events_event_id ON stripe_webhook_events(event_id);
    ```

    **2. Webhook Endpoint - POST /api/webhooks/stripe:**
    - Express route (PAS tRPC - Stripe envoie raw body)
    - Middleware: express.raw({ type: 'application/json' }) pour signature verification
    - Vérifier stripe-signature header: `stripe.webhooks.constructEvent(body, signature, webhookSecret)`
    - Pattern idempotency:
      ```typescript
      const existingEvent = await tenantDb.query.stripeWebhookEvents.findFirst({
        where: eq(stripeWebhookEvents.eventId, event.id)
      });
      if (existingEvent) return res.json({ received: true });
      ```

    **3. Event Handlers:**
    - `checkout.session.completed`:
      - Extraire metadata: invoiceId, organizationId, isDeposit
      - Si isDeposit = true: UPDATE invoices SET status = 'PARTIALLY_PAID', paid_amount = depositAmount
      - Si full payment: UPDATE invoices SET status = 'PAID', paid_at = NOW()
      - Enregistrer event_id dans stripe_webhook_events

    - `payment_intent.succeeded`:
      - Cas delayed payments (SEPA, bank transfer)
      - Même logique que checkout.session.completed mais via payment_intent metadata

    - `payment_intent.payment_failed`:
      - UPDATE invoices SET status = 'PAYMENT_FAILED'
      - (Email notification sera Phase 17-02)

    **Transaction Database:**
    Wrapper tout dans `tenantDb.transaction()` pour garantir atomicité (status update + event tracking).

    **IMPORTANT:**
    - Webhook secret dans .env: STRIPE_WEBHOOK_SECRET (obtenir via `stripe listen --print-secret`)
    - Toujours respond 200 OK dans 5 secondes (Stripe retry sinon)
    - Logger tous events pour debugging: console.log(`[Stripe Webhook] ${event.type}`, event.id)
  </action>
  <verify>
    - Migration appliquée: `pnpm db:migrate`
    - Stripe CLI test: `stripe trigger checkout.session.completed` → invoice status updated
    - Stripe CLI test: `stripe trigger payment_intent.payment_failed` → status = PAYMENT_FAILED
    - Idempotency: Envoyer même event 2x → processed une seule fois
  </verify>
  <done>
    - Table stripe_webhook_events créée avec migration
    - Endpoint /api/webhooks/stripe opérationnel
    - 3 event handlers implemented (checkout.session.completed, payment_intent.succeeded, payment_intent.payment_failed)
    - Idempotency garantie par event_id tracking
    - Transactions database pour atomicité
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Stripe Environment Variables & Test Local Webhook</name>
  <files>
    packages/server/.env.example,
    packages/server/README.md (update setup steps)
  </files>
  <action>
    **1. Update .env.example:**
    ```bash
    # Stripe Keys (from dashboard.stripe.com/apikeys)
    STRIPE_SECRET_KEY=sk_test_...
    STRIPE_PUBLISHABLE_KEY=pk_test_...
    STRIPE_WEBHOOK_SECRET=whsec_... # Run: stripe listen --print-secret

    # App URL (for Checkout redirect URLs)
    APP_URL=http://localhost:5174
    ```

    **2. Document Setup Steps in README:**
    ```markdown
    ### Stripe Webhooks Local Testing

    1. Install Stripe CLI: `brew install stripe/stripe-cli/stripe`
    2. Login: `stripe login`
    3. Forward webhooks to local: `stripe listen --forward-to http://localhost:3001/api/webhooks/stripe`
    4. Copy webhook secret: `whsec_...` → Add to .env as STRIPE_WEBHOOK_SECRET
    5. Test events:
       - `stripe trigger checkout.session.completed`
       - `stripe trigger payment_intent.succeeded`
    ```

    **3. Test Cycle (Manuel):**
    - Start backend: `pnpm --filter server dev`
    - Start Stripe CLI: `stripe listen --forward-to http://localhost:3001/api/webhooks/stripe`
    - Trigger event: `stripe trigger checkout.session.completed`
    - Vérifier logs: "[Stripe Webhook] checkout.session.completed" + invoice status updated
  </action>
  <verify>
    - .env.example contient toutes Stripe vars
    - README documente Stripe CLI setup
    - Test manuel: Trigger event → Invoice status change confirmed
  </verify>
  <done>
    - Environment variables documentées
    - README avec instructions Stripe CLI
    - Test local webhook validé (event → status update)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm check` passes (0 TypeScript errors)
- [ ] Stripe Checkout Session créée via tRPC mutation
- [ ] Webhook endpoint répond 200 OK to Stripe events
- [ ] Idempotency: Duplicate events ignorés (event_id tracking works)
- [ ] Invoice status transitions: SENT → PAID (ou PARTIALLY_PAID pour deposits)
- [ ] Stripe CLI test cycle complet (trigger events → DB updates)
</verification>

<success_criteria>
- All 3 tasks completed
- Stripe Checkout integration opérationnelle
- Webhook idempotency garantie (event tracking table)
- Invoice status updates atomiques (database transactions)
- Local testing validé avec Stripe CLI
- 0 TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-facturation-automatique-stripe-ui/17-01-SUMMARY.md`:

# Phase 17 Plan 1: Stripe Checkout & Webhooks Summary

**Stripe Checkout Sessions + Webhook idempotency implemented**

## Accomplishments

- Stripe Checkout Session creation via tRPC (invoices.createPaymentSession)
- Webhook endpoint avec signature verification
- Idempotency event tracking (stripe_webhook_events table)
- Invoice status updates atomiques (SENT → PAID/PARTIALLY_PAID)

## Files Created/Modified

- `packages/server/src/routers/invoices.ts` - createPaymentSession mutation
- `packages/server/src/routes/webhooks-stripe.ts` - Webhook handler avec 3 events
- `packages/database/src/tenant/schema.ts` - stripe_webhook_events table
- `packages/database/migrations/[timestamp]_webhook_events.ts` - Migration
- `packages/server/.env.example` - Stripe environment variables
- `packages/server/README.md` - Stripe CLI setup documentation

## Decisions Made

- Checkout Sessions (mode: 'payment') over Payment Element (embedded)
- Event tracking table for idempotency (industry standard pattern)
- express.raw() middleware for webhook signature verification
- Database transactions for atomic status updates

## Issues Encountered

[Document any issues and resolutions, or "None"]

## Next Step

Ready for **17-02-PLAN.md**: Email Notifications & PDF Generation (Resend + PDFKit + S3)
</output>
