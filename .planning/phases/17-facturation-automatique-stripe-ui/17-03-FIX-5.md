---
phase: 17-facturation-automatique-stripe-ui
plan: 17-03-FIX-5
type: fix
---

<objective>
Rewrite E2E test setup to use API-based approach instead of direct database manipulation, fixing session persistence issue.

**Root Cause:** Direct SQL INSERT bypasses backend logic, preventing session creation in `client_portal_sessions` table.

**Solution:** Use tRPC APIs (register/login) to create test data, ensuring proper session management.

**Expected Outcome:** 8/8 tests passing (100%)
</objective>

<context>
@.planning/STATE.md
@.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-4-SUMMARY.md
@e2e/test-phase17-invoice-payment.spec.ts
@packages/server/src/routers/client-portal-auth.ts
@packages/server/src/routers/invoices.ts

**Current Status:** 3/8 tests passing due to session persistence issue
**Investigation Finding:** localStorage works, but no session exists in DB after direct INSERT
**Recommendation:** API-based test setup to match production code paths
</context>

<tasks>
<task type="auto">
  <name>Analyze required API endpoints for test setup</name>
  <action>
Identify which APIs are needed to replace direct SQL INSERTs:

**Current test setup (SQL-based):**
1. Create client (clients table) → SQL INSERT
2. Create portal account (portal_accounts table) → SQL INSERT
3. Create invoice (invoices table) → SQL INSERT
4. Login via UI form → Works but no session persists

**New test setup (API-based):**
1. ~~Register new client~~ (may not exist for client portal)
2. **Admin creates client** via `trpc.clients.create` (admin API)
3. **Admin creates invoice** via `trpc.invoices.create` (admin API)
4. **Client logs in** via Playwright UI (already works)

**Alternative if no admin APIs available:**
- Use SQL for client/invoice creation (keep existing)
- Focus ONLY on fixing login to create proper session
- Investigate why `clientPortalAuth.login` doesn't create session row

**Research:**
- Check if `trpc.clients.create` exists and is accessible
- Check if `trpc.invoices.create` exists for test use
- Review `client-portal-auth.ts` login endpoint session creation logic

Document which APIs exist and can be used for test setup.
  </action>
  <verify>
List of available APIs documented with parameters
  </verify>
  <done>
Clear plan for which APIs to use in test setup
  </done>
</task>

<task type="auto">
  <name>Rewrite beforeAll hook with API-based setup</name>
  <action>
Replace direct SQL manipulation with API calls in `beforeAll` hook.

**Approach 1: Full API-based (if admin APIs exist)**

```typescript
beforeAll(async () => {
  try {
    // Use admin tRPC client to create test data
    const adminClient = createTRPCProxyClient<AppRouter>({
      links: [
        httpBatchLink({
          url: 'http://localhost:3001/api/trpc',
          headers: {
            'x-test-user-id': '1', // Admin user
            'x-test-org-id': '1'
          }
        })
      ],
      transformer: superjson
    });

    // 1. Create test client
    const client = await adminClient.clients.create.mutate({
      name: 'Playwright Test Client',
      email: TEST_CLIENT_EMAIL,
      type: 'individual'
    });

    // 2. Create portal account for client
    // (May need to be done via SQL if no admin API exists)

    // 3. Create test invoice
    const invoice = await adminClient.invoices.create.mutate({
      clientId: client.id,
      invoiceNumber: `TEST-${Date.now()}`,
      status: 'SENT',
      subtotal: 150.00,
      taxAmount: 30.00,
      total: 180.00,
      items: [
        { description: 'Test Service', quantity: 1, unitPrice: 150.00 }
      ]
    });

    console.log('✅ Test data created via APIs:', { client, invoice });
  } catch (error) {
    console.error('❌ API setup failed:', error);
    throw error;
  }
});
```

**Approach 2: Hybrid (if some APIs don't exist)**

Keep SQL for client/invoice creation, but ensure login creates session:

```typescript
beforeAll(async () => {
  // SQL for client/invoice (keep existing)
  await sql`INSERT INTO clients ...`;
  await sql`INSERT INTO portal_accounts ...`;
  await sql`INSERT INTO invoices ...`;

  // But add session creation manually OR
  // Fix the login endpoint to create session properly
});
```

**Approach 3: Fix login endpoint session creation**

If login endpoint doesn't create session, fix the backend:

Review `packages/server/src/routers/client-portal-auth.ts` login mutation:
- Does it INSERT into `client_portal_sessions` table?
- If not, add session creation logic
- Ensure transaction commits properly

Choose the approach that works best based on Task 1 findings.
  </action>
  <verify>
beforeAll hook rewritten, test data creation uses APIs
  </verify>
  <done>
Test setup code ready for verification
  </done>
</task>

<task type="auto">
  <name>Update test login flow if needed</name>
  <action>
Based on new setup approach, update login flow in tests:

**If using full API setup:**
- Tests already use Playwright UI login (keep as-is)
- API setup just creates the data
- Login should now create proper session

**If fixing login endpoint:**
- May need to adjust test expectations
- Add verification that session is created

**Add session verification after login:**

```typescript
test('should login successfully', async ({ page }) => {
  await page.goto('http://localhost:5174/client-portal/login');
  await page.fill('input[type="email"]', TEST_CLIENT_EMAIL);
  await page.fill('input[type="password"]', TEST_CLIENT_PASSWORD);
  await page.click('button[type="submit"]');
  await page.waitForURL(/\/client-portal/, { timeout: 5000 });

  // Verify localStorage
  await page.waitForFunction(() => {
    return localStorage.getItem('client_portal_session_token') !== null;
  }, { timeout: 3000 });

  // NEW: Verify session exists in database
  const token = await page.evaluate(() =>
    localStorage.getItem('client_portal_session_token')
  );

  // Could add API call to verify session exists
  console.log('✅ Login successful, token:', token?.substring(0, 8));
});
```

Keep the localStorage waitForFunction fix from FIX-4.
  </action>
  <verify>
Login flow updated to work with new setup
  </verify>
  <done>
Test login properly creates and persists session
  </done>
</task>

<task type="auto">
  <name>Run E2E tests and verify 8/8 passing</name>
  <action>
Execute full test suite with new API-based setup:

```bash
npx playwright test e2e/test-phase17-invoice-payment.spec.ts
```

**Expected results:**
- ✅ Test 1: Login successful (should still pass)
- ✅ Test 2: Invoice list displays (FIXED - session exists)
- ✅ Test 3: Invoice detail accessible (FIXED)
- ✅ Test 4: Pay Now button displayed (FIXED)
- ✅ Test 5: Download PDF exists (FIXED)
- ✅ Test 6: Stripe redirect attempted (FIXED)
- ✅ Test 7: Success page accessible (should still pass)
- ✅ Test 8: Cancel page accessible (should still pass)

**Pass criteria:** 8/8 tests passing (100%)

**If tests still fail:**
- Review error messages carefully
- Check if session actually exists in DB
- Verify invoice data was created correctly
- May need to debug specific endpoint responses
  </action>
  <verify>
Playwright output shows "8 passed (100%)" with no failures
  </verify>
  <done>
All 8 E2E tests passing, Phase 17 UAT validated
  </done>
</task>

<task type="auto">
  <name>Clean up and document test setup</name>
  <action>
Finalize test file for production:

1. **Remove debug logging** from FIX-4 investigation
2. **Document API-based approach** in comments:
```typescript
/**
 * Phase 17: Invoice Payment Flow E2E Tests
 *
 * Test Setup Strategy:
 * - Uses API-based approach for data creation (not direct SQL)
 * - Ensures proper session management via backend code paths
 * - localStorage persistence verified with waitForFunction
 *
 * Test Flow:
 * 1. beforeAll creates test client + invoice via admin APIs
 * 2. Each test logs in via UI (creates proper session)
 * 3. Tests verify invoice payment workflow end-to-end
 */
```

3. **Keep localStorage fix** from FIX-4:
```typescript
// Wait for localStorage to be written (prevents race condition)
await page.waitForFunction(() => {
  return localStorage.getItem('client_portal_session_token') !== null;
}, { timeout: 3000 });
```

4. **Verify test independence** - tests don't depend on execution order
5. **Production-ready** - no temporary hacks or workarounds
  </action>
  <verify>
Test file clean, well-documented, maintainable
  </verify>
  <done>
Test file production-ready for CI/CD
  </done>
</task>
</tasks>

<verification>
- [ ] API endpoints identified and documented
- [ ] beforeAll hook rewritten with API-based setup
- [ ] Login flow updated to work with new setup
- [ ] All 8 Playwright tests passing (100%)
- [ ] Test file clean and production-ready
- [ ] Session persistence issue resolved
</verification>

<success_criteria>
- 8/8 tests passing (up from 3/8)
- Test pass rate: 100%
- Session properly created via backend APIs
- Phase 17 UAT validation complete
- v4.0 milestone ready for completion
</success_criteria>

<output>
After completion, create `.planning/phases/17-facturation-automatique-stripe-ui/17-03-FIX-5-SUMMARY.md`

Include:
- API-based setup approach chosen
- Which APIs were used (admin tRPC, SQL hybrid, or login fix)
- Test results before/after (3/8 → 8/8)
- Benefits of API-based approach
- Phase 17 completion confirmation
</output>
