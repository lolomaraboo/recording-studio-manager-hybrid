---
phase: 03-billing-infrastructure
plan: 3
type: execute
---

<objective>
Implement Stripe Customer Portal integration and subscription management UI in frontend.

Purpose: Enable self-service billing (update payment method, view invoices, cancel subscription) + show usage dashboard.
Output: Customer Portal endpoint, billing settings page, usage meters, upgrade/cancel flows.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing-infrastructure/DISCOVERY.md
@.planning/phases/03-billing-infrastructure/03-01-SUMMARY.md
@.planning/phases/03-billing-infrastructure/03-02-SUMMARY.md

**Prior decisions from Plans 1-2:**
- Subscription checkout creates subscriptions with trials
- Usage limits enforced at API level
- Organizations router has upgrade/downgrade/cancel endpoints
- Stripe Customer ID stored in organizations table

**Codebase constraints:**
- Client uses React 19 + shadcn/ui components
- tRPC client already configured (packages/client/src/lib/trpc.ts)
- Settings pages follow pattern: packages/client/src/app/settings/

**Integration points:**
- Settings sidebar: Add "Billing" menu item
- Dashboard: Show usage meters if approaching limits
- Sessions/Projects creation: Show upgrade modal on limit error
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Customer Portal endpoint to subscriptions router</name>
  <files>packages/server/src/routers/subscriptions.ts</files>
  <action>
Add Customer Portal session creation to existing subscriptions router.

Port from Python billing_routes.py lines 301-343.

Add procedure:

**createPortalSession** (mutation):
  - Input: none (uses authenticated organization from context)
  - Get organizations.stripe_customer_id from master DB
  - Throw if no Stripe customer (shouldn't happen - created during checkout)
  - Create Stripe billing portal session:
    ```typescript
    const session = await stripe.billingPortal.sessions.create({
      customer: stripeCustomerId,
      return_url: `${process.env.CLIENT_URL}/settings/billing`
    })
    ```
  - Return { portalUrl: session.url }

Customer Portal must be configured in Stripe Dashboard first:
- Enable customer cancellation
- Enable payment method updates
- Enable invoice history
- Set business information (name, support email)

Configuration is one-time in Stripe Dashboard, not via API.
</action>
  <verify>
- tRPC procedure returns valid portal URL (https://billing.stripe.com/session/...)
- Visiting portal URL shows Stripe Customer Portal with correct org name
- Portal allows updating payment method
  </verify>
  <done>Customer Portal endpoint returns session URL, portal shows subscription details and self-service options</done>
</task>

<task type="auto">
  <name>Task 2: Create billing settings page UI</name>
  <files>packages/client/src/app/settings/billing/page.tsx (create)</files>
  <action>
Create billing management page following existing settings pages pattern.

Port UI structure from Python templates/settings/billing.html (if exists) or design from scratch.

Create packages/client/src/app/settings/billing/page.tsx with sections:

**1. Current Plan section:**
- Display current plan name (Starter/Pro/Enterprise)
- Show billing period (Monthly/Yearly)
- Display price (€29/month or €299/year)
- Show next billing date from subscriptionInfo.currentPeriodEnd
- If trial: Show "Trial ends in X days" badge
- If canceling: Show "Subscription ends on [date]" warning

**2. Usage Meters section:**
- Fetch usage stats from getUsageStats()
- Display progress bars:
  - Sessions: "120 / 500 sessions this month (24%)" with progress bar
  - Storage: "8 / 10 GB used (80%)" with progress bar
- Warning badge at 80%, danger badge at 100%
- "Upgrade to Pro" button if at/near limits

**3. Actions section:**
- "Manage Billing" button → calls createPortalSession() and redirects to portal
- "Upgrade Plan" button → shows plan selection modal
- "Cancel Subscription" button → shows confirmation dialog

**4. Payment Method section:**
- Display card brand + last4 from subscriptionInfo.paymentMethod
- "Update Payment Method" → opens Customer Portal

Use shadcn/ui components: Card, Button, Progress, Badge, Dialog.
Use tRPC hooks: trpc.subscriptions.getSubscriptionInfo.useQuery(), trpc.subscriptions.createPortalSession.useMutation().

Follow pattern from packages/client/src/app/settings/profile/page.tsx.
</action>
  <verify>
- /settings/billing page loads without errors
- Current plan displays correct tier and price
- Usage meters show session count and storage used
- "Manage Billing" button redirects to Stripe Customer Portal
  </verify>
  <done>Billing settings page shows subscription details, usage stats, and portal redirect button</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stripe Customer Portal integration and billing settings UI</what-built>
  <how-to-verify>
    1. Start dev server: npm run dev
    2. Login to app as organization owner
    3. Navigate to Settings > Billing
    4. Verify current plan shows correct tier (Starter/Pro/Enterprise)
    5. Check usage meters display session count and storage
    6. Click "Manage Billing" button
    7. Confirm redirect to Stripe Customer Portal (billing.stripe.com)
    8. In portal: Verify can update payment method
    9. In portal: Verify can view invoice history
    10. Return to app via portal's "Return to [App Name]" link
    11. Confirm lands back on /settings/billing
  </how-to-verify>
  <resume-signal>Type "approved" if portal works, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Add upgrade modal component for limit errors</name>
  <files>packages/client/src/components/UpgradeModal.tsx (create)</files>
  <action>
Create reusable upgrade modal shown when hitting usage limits.

Create packages/client/src/components/UpgradeModal.tsx:

**Component props:**
- limitType: "sessions" | "storage"
- currentPlan: string
- onClose: () => void

**UI:**
- Dialog with error icon
- Headline: "Monthly Session Limit Reached" (or storage variant)
- Body: "You've used all 50 sessions included in your Starter plan. Upgrade to Pro for unlimited sessions."
- Pricing comparison table: Current plan vs recommended upgrade
- CTA buttons: "Upgrade to Pro (€99/mo)" and "View All Plans"
- Close button

On "Upgrade to Pro":
- Call trpc.subscriptions.upgradeSubscription.mutate({ planId: 2, billingPeriod: "monthly" })
- Redirect to Stripe Checkout
- Show loading spinner during API call

On "View All Plans":
- Navigate to /settings/billing

Use shadcn/ui Dialog, Button, Table components.

Import in Sessions and Projects pages to show on limit TRPCError.
</action>
  <verify>
- UpgradeModal renders with correct limit type message
- "Upgrade to Pro" button triggers subscription upgrade mutation
- Modal closes on "X" button click
  </verify>
  <done>Upgrade modal component displays actionable upgrade path when limits hit, triggers Stripe checkout on upgrade</done>
</task>

<task type="auto">
  <name>Task 5: Integrate upgrade modal in sessions and projects pages</name>
  <files>packages/client/src/app/sessions/page.tsx, packages/client/src/app/projects/[id]/page.tsx</files>
  <action>
Add error handling to show UpgradeModal on limit errors.

**In sessions/page.tsx (create session form):**
```typescript
const createSession = trpc.sessions.createSession.useMutation({
  onError: (error) => {
    if (error.data?.code === "LIMIT_EXCEEDED") {
      setShowUpgradeModal(true);
      setLimitType("sessions");
    } else {
      toast.error(error.message);
    }
  }
});

{showUpgradeModal && (
  <UpgradeModal
    limitType={limitType}
    currentPlan={currentPlan}
    onClose={() => setShowUpgradeModal(false)}
  />
)}
```

**In projects/[id]/page.tsx (track upload):**
```typescript
const uploadTrack = trpc.projects.uploadTrack.useMutation({
  onError: (error) => {
    if (error.data?.code === "LIMIT_EXCEEDED") {
      setShowUpgradeModal(true);
      setLimitType("storage");
    } else {
      toast.error(error.message);
    }
  }
});
```

Import UpgradeModal component.
Add state: const [showUpgradeModal, setShowUpgradeModal] = useState(false);

This intercepts limit errors and shows upgrade flow instead of generic error toast.
</action>
  <verify>
- Creating session when at limit shows UpgradeModal with sessions message
- Uploading track when storage full shows UpgradeModal with storage message
- Modal "Upgrade to Pro" triggers checkout and redirects to Stripe
  </verify>
  <done>Sessions and projects pages show contextual upgrade modals on limit errors, seamless upgrade flow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] /settings/billing page displays current subscription details
- [ ] Usage meters show accurate session count and storage
- [ ] "Manage Billing" redirects to Stripe Customer Portal
- [ ] Customer Portal allows updating payment method and viewing invoices
- [ ] UpgradeModal appears when hitting session limit
- [ ] UpgradeModal "Upgrade" button creates checkout and redirects to Stripe
- [ ] All tRPC endpoints return expected data
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Billing settings page shows subscription and usage information
- Customer Portal integration works (redirect and return)
- Upgrade flow triggers from limit errors
- Users can self-serve billing without support tickets
- Manual verification confirms portal shows correct data
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing-infrastructure/03-03-SUMMARY.md`
</output>
