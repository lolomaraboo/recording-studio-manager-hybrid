---
phase: 03-billing-infrastructure
plan: 1
type: execute
---

<objective>
Implement Stripe Subscriptions with 3 pricing tiers (Starter/Pro/Enterprise) and 14-day trial period.

Purpose: Enable recurring revenue billing model for SaaS. Replace one-time bookmark payments with subscription-based access.
Output: Working subscription checkout flow with trial periods, tRPC endpoints, webhook handlers for subscription lifecycle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing-infrastructure/DISCOVERY.md

**Prior decisions affecting this phase:**
- Stripe SDK v20.1.0 already installed, API version 2025-12-15.clover configured
- One-time payments already working (booking deposits) - keep that separate
- Database-per-Tenant architecture means subscription is in master DB (organizations table)
- Python version has complete implementation to port (stripe_subscriptions.py, billing_routes.py)

**Codebase constraints:**
- Use existing stripe-client.ts pattern (singleton, utility functions)
- Webhook signature verification already exists (verifyWebhookSignature)
- Master DB schema already has subscriptionPlans table and subscriptionTier field on organizations

**Integration with existing code:**
- stripe-client.ts: Add subscription helpers (createSubscriptionCheckout, getSubscription, cancelSubscription)
- stripe-webhook.ts: Add subscription event handlers alongside existing payment handlers
- organizations router: Will add subscription management endpoints in Plan 2
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stripe Price IDs to subscription plans seed data</name>
  <files>packages/database/src/scripts/seed-subscription-plans.ts (create), packages/database/src/master/schema.ts</files>
  <action>
Create seed script for subscription plans matching Python implementation:

1. Create packages/database/src/scripts/seed-subscription-plans.ts
2. Define 3 plans: Starter (€29/€299), Pro (€99/€999), Enterprise (€299/€2999)
3. Create Stripe Products + Prices via API (monthly & yearly for each tier)
4. Store stripe_price_id_monthly and stripe_price_id_yearly in subscriptionPlans table
5. Add features JSON: Starter (50 sessions/month, 10GB), Pro (unlimited sessions, 100GB), Enterprise (unlimited everything)

Use existing master DB connection from packages/database/src/connection.ts.
Verify subscriptionPlans table schema has fields: stripe_price_id_monthly, stripe_price_id_yearly (add if missing).

Port from Python models_platform.py Plan model (lines 200-250).
</action>
  <verify>
- npm run seed:plans creates 3 Stripe Products + 6 Prices
- Query subscriptionPlans table shows 3 plans with Stripe IDs populated
- Stripe Dashboard shows products: "Starter", "Pro", "Enterprise"
  </verify>
  <done>3 subscription plans seeded with valid Stripe Price IDs, features JSON matches PROJECT.md pricing tiers</done>
</task>

<task type="auto">
  <name>Task 2: Create subscription checkout tRPC router</name>
  <files>packages/server/src/routers/subscriptions.ts (create), packages/server/src/routers/index.ts</files>
  <action>
Port Python billing_routes.py create_checkout_session() to TypeScript tRPC router.

Create packages/server/src/routers/subscriptions.ts with procedures:

1. **createCheckoutSession** (mutation):
   - Input: { planId: number, billingPeriod: "monthly" | "yearly" }
   - Get organization from context (require auth)
   - Fetch plan from master DB subscriptionPlans table
   - Get or create Stripe customer (store stripe_customer_id in organizations table)
   - Create Stripe Checkout Session with mode: "subscription"
   - Set subscription_data.trial_period_days: 14
   - Add metadata: organization_id, plan_id, billing_period
   - Return { checkoutUrl, sessionId }

2. **getAvailablePlans** (query):
   - Fetch all active plans from subscriptionPlans table
   - Return array with pricing, features, limits

Use existing patterns from client-portal-stripe.ts for Stripe API calls.
Use getMasterDb() from @rsm/database/connection for master DB queries.

Port from Python billing_routes.py lines 39-138 and stripe_subscriptions.py lines 147-199.
</action>
  <verify>
- tsc compiles without errors
- tRPC procedure shows in router export
- Postman test createCheckoutSession returns valid Stripe Checkout URL
  </verify>
  <done>Subscription router exposes createCheckoutSession and getAvailablePlans, Stripe creates checkout with 14-day trial</done>
</task>

<task type="auto">
  <name>Task 3: Add subscription webhook handlers to stripe-webhook.ts</name>
  <files>packages/server/src/webhooks/stripe-webhook.ts</files>
  <action>
Add subscription lifecycle webhook handlers to existing stripe-webhook.ts.

Add new event handlers in switch statement (after existing payment handlers):

1. **customer.subscription.created**:
   - Extract metadata: organization_id, plan_id, billing_period
   - Update organizations table: set subscriptionTier, stripe_subscription_id, trial_ends_at
   - Log subscription creation activity

2. **invoice.payment_succeeded**:
   - Check metadata.type: if "subscription" (not one-time payment)
   - Update organizations table: set status ACTIVE, current_period_end
   - Reset usage counters (sessions_used_this_month = 0)
   - Send subscription confirmation email (if trial conversion)

3. **invoice.payment_failed**:
   - Set organization status PAST_DUE
   - Send dunning email warning payment failed
   - Log payment failure

4. **customer.subscription.deleted**:
   - Set organization status SUSPENDED
   - Send cancellation confirmation email
   - Log subscription deleted

Reuse existing verifyWebhookSignature() and getMasterDb().
Add subscription-specific email templates (simple text for now).

Port from Python stripe_subscriptions.py lines 500-660 (handle_webhook method).
IMPORTANT: invoice.payment_succeeded already exists for booking payments - add condition to check subscription vs one-time payment metadata.
</action>
  <verify>
- curl webhook endpoint with Stripe test events returns 200
- Test event customer.subscription.created updates organizations table
- Test event invoice.payment_succeeded sets status ACTIVE and updates period
  </verify>
  <done>Webhook handlers process subscription lifecycle events, update organizations table, send emails on status changes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without TypeScript errors
- [ ] Subscription plans seeded in master DB with Stripe Price IDs
- [ ] Create checkout session returns valid Stripe URL with trial_period_days: 14
- [ ] Webhook signature verification passes for subscription events
- [ ] Test subscription creation updates organizations.subscriptionTier
- [ ] Test invoice.payment_succeeded sets organizations.status = ACTIVE
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors or runtime crashes
- Stripe Checkout Session creates subscription with 14-day trial
- Webhook events sync subscription state to organizations table
- Organizations can start trial subscriptions via tRPC endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing-infrastructure/03-01-SUMMARY.md`
</output>
