---
phase: 11-systeme-devis-frontend
plan: 1
type: execute
---

<objective>
Complete quote management frontend UI with line items builder, PDF download, and state transition workflow.

Purpose: Enable users to create, manage, and send professional quotes to clients via UI
Output: Fully functional quote creation form with dynamic line items, PDF generation in detail view, and complete state machine workflow buttons (Send/Accept/Reject/Cancel/Convert)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase 10 Backend Complete:**
- ✅ Database schema (quotes, quote_items tables)
- ✅ tRPC router (7-state FSM: draft/sent/accepted/rejected/expired/cancelled/converted_to_project)
- ✅ PDF generation service (returns base64-encoded PDFs)
- ✅ Automatic quote numbering (Q-YYYY-NNNN)
- ✅ E2E tests (full lifecycle validated)

**Current Frontend State:**
- ✅ Basic pages exist: Quotes.tsx (list), QuoteCreate.tsx (form), QuoteDetail.tsx (detail view)
- ❌ QuoteCreate.tsx missing line items builder (currently single subtotal field)
- ❌ QuoteDetail.tsx has placeholders for PDF download and state transitions
- ❌ No convert-to-project functionality

**Backend API Signature (from Phase 10-02-SUMMARY.md):**
```typescript
// quotes.create mutation
{
  clientId: number,
  items: Array<{
    description: string,
    quantity: string,
    unitPrice: string,
    amount: string,
    displayOrder: number
  }>,
  validityDays: number,
  terms?: string,
  notes?: string,
  internalNotes?: string,
  taxRate: string
}

// quotes.generatePDF mutation
{
  quoteId: number
}
// Returns: { filename: string, data: string (base64), mimeType: string }

// State transition mutations
quotes.send({ id: number })
quotes.accept({ id: number })
quotes.reject({ id: number })
quotes.cancel({ id: number })

// Conversion
quotes.convertToProject({ id: number })
// Returns project ID
```

**UI Patterns from Existing Pages:**
- CardHeader with pb-3, CardTitle with text-base
- Container: pt-2 pb-4 px-2
- Icons: text-primary (h-8 w-8 for page headers)
- Breadcrumb navigation with ArrowLeft
- Toast notifications for mutations (sonner)
- Date formatting with date-fns fr locale

**Relevant Files:**
@packages/client/src/pages/Quotes.tsx (list view - already complete)
@packages/client/src/pages/QuoteCreate.tsx (missing line items builder)
@packages/client/src/pages/QuoteDetail.tsx (missing PDF and state buttons)
@packages/server/src/routers/quotes.ts (backend API reference)
@packages/database/src/tenant/schema.ts (schema reference - quoteItems table)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add line items builder to QuoteCreate.tsx</name>
  <files>packages/client/src/pages/QuoteCreate.tsx</files>
  <action>
Transform QuoteCreate.tsx from simple subtotal form to dynamic line items builder:

1. **Remove** simple subtotal/taxRate/total fields (lines 199-235)

2. **Add state** for line items array:
```typescript
const [items, setItems] = useState<Array<{
  description: string;
  quantity: string;
  unitPrice: string;
  amount: string;
  displayOrder: number;
}>>([{ description: "", quantity: "1.00", unitPrice: "0.00", amount: "0.00", displayOrder: 0 }]);
const [taxRate, setTaxRate] = useState("20.00");
```

3. **Add handlers**:
- `handleAddItem()`: Push new empty item to array with displayOrder = items.length
- `handleRemoveItem(index)`: Filter out item at index, recompute displayOrder for remaining
- `handleItemChange(index, field, value)`: Update specific item field
- Auto-calculate `amount` when quantity or unitPrice changes: `amount = (parseFloat(quantity) * parseFloat(unitPrice)).toFixed(2)`

4. **Calculate totals** from items array:
```typescript
const subtotal = items.reduce((sum, item) => sum + parseFloat(item.amount || "0"), 0);
const taxAmount = (subtotal * parseFloat(taxRate)) / 100;
const total = subtotal + taxAmount;
```

5. **UI Section: Line Items Builder**
After client/project selectors, add:
```tsx
<div className="space-y-4">
  <div className="flex items-center justify-between">
    <Label className="text-base font-semibold">Prestations</Label>
    <Button type="button" size="sm" variant="outline" onClick={handleAddItem}>
      <Plus className="h-4 w-4 mr-2" />
      Ajouter une ligne
    </Button>
  </div>

  {items.map((item, index) => (
    <div key={index} className="grid grid-cols-12 gap-2 items-start border p-3 rounded-md">
      {/* Description - 5 cols */}
      <div className="col-span-5 space-y-1">
        <Label className="text-xs">Description</Label>
        <Input
          value={item.description}
          onChange={(e) => handleItemChange(index, "description", e.target.value)}
          placeholder="Ex: Enregistrement (4h)"
        />
      </div>

      {/* Quantity - 2 cols */}
      <div className="col-span-2 space-y-1">
        <Label className="text-xs">Quantité</Label>
        <Input
          type="number"
          step="0.01"
          value={item.quantity}
          onChange={(e) => handleItemChange(index, "quantity", e.target.value)}
        />
      </div>

      {/* Unit Price - 2 cols */}
      <div className="col-span-2 space-y-1">
        <Label className="text-xs">Prix unit. (€)</Label>
        <Input
          type="number"
          step="0.01"
          value={item.unitPrice}
          onChange={(e) => handleItemChange(index, "unitPrice", e.target.value)}
        />
      </div>

      {/* Amount - 2 cols (read-only calculated) */}
      <div className="col-span-2 space-y-1">
        <Label className="text-xs">Montant (€)</Label>
        <Input value={item.amount} readOnly className="bg-muted" />
      </div>

      {/* Remove button - 1 col */}
      <div className="col-span-1 flex items-end">
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => handleRemoveItem(index)}
          disabled={items.length === 1}
        >
          <Trash2 className="h-4 w-4 text-destructive" />
        </Button>
      </div>
    </div>
  ))}
</div>
```

6. **Totals Display** (after line items):
```tsx
<div className="flex justify-end">
  <div className="w-64 space-y-2 border-t pt-3">
    <div className="flex justify-between text-sm">
      <span className="text-muted-foreground">Sous-total:</span>
      <span className="font-medium">{subtotal.toFixed(2)} €</span>
    </div>
    <div className="flex justify-between text-sm items-center gap-2">
      <Label htmlFor="taxRate" className="text-muted-foreground">TVA (%):</Label>
      <Input
        id="taxRate"
        type="number"
        step="0.01"
        value={taxRate}
        onChange={(e) => setTaxRate(e.target.value)}
        className="w-20 h-8"
      />
    </div>
    <div className="flex justify-between text-sm">
      <span className="text-muted-foreground">TVA:</span>
      <span className="font-medium">{taxAmount.toFixed(2)} €</span>
    </div>
    <div className="flex justify-between text-lg font-bold border-t pt-2">
      <span>Total TTC:</span>
      <span>{total.toFixed(2)} €</span>
    </div>
  </div>
</div>
```

7. **Update handleSubmit** validation and mutation:
```typescript
// Validate at least 1 item with description
if (items.length === 0 || !items[0].description.trim()) {
  toast.error("Au moins une prestation est requise");
  return;
}

// Submit with items array
createMutation.mutate({
  clientId: formData.clientId,
  items: items.map((item, index) => ({
    description: item.description,
    quantity: item.quantity,
    unitPrice: item.unitPrice,
    amount: item.amount,
    displayOrder: index,
  })),
  validityDays: 30, // 30 days default
  terms: formData.terms || undefined,
  notes: formData.notes || undefined,
  taxRate: taxRate,
});
```

**Pattern Source:** Similar to invoice line items pattern (standard CRUD array management).

**Why this approach:**
- Matches backend API signature from Phase 10
- Standard pattern for line item management
- Real-time amount calculation improves UX
- Minimum 1 item prevents empty quotes
  </action>
  <verify>
1. QuoteCreate page loads without TypeScript errors
2. Default has 1 empty line item
3. "Ajouter une ligne" button adds new item
4. Trash icon removes item (disabled when only 1 item)
5. Changing quantity or unitPrice auto-calculates amount
6. Totals display updates in real-time
7. Form submission sends items array to backend
  </verify>
  <done>
- QuoteCreate.tsx transformed from simple form to line items builder
- Dynamic add/remove items functionality working
- Auto-calculation of amounts and totals
- Form validation prevents empty items submission
- Backend mutation receives correctly formatted items array
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement PDF download in QuoteDetail.tsx</name>
  <files>packages/client/src/pages/QuoteDetail.tsx</files>
  <action>
Replace placeholder `handleDownloadPDF` function (line 133-135) with real implementation:

```typescript
// Add mutation at top with other mutations
const generatePDFMutation = trpc.quotes.generatePDF.useMutation({
  onSuccess: (result) => {
    // Decode base64 to binary
    const binaryString = atob(result.data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }

    // Create blob and download
    const blob = new Blob([bytes], { type: result.mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = result.filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    toast.success(`PDF téléchargé: ${result.filename}`);
  },
  onError: (error) => {
    toast.error(`Erreur PDF: ${error.message}`);
  },
});

const handleDownloadPDF = () => {
  if (!quote) return;
  generatePDFMutation.mutate({ quoteId: quote.id });
};
```

**Update Download button** to show loading state:
```tsx
<Button
  variant="outline"
  size="sm"
  onClick={handleDownloadPDF}
  disabled={generatePDFMutation.isPending}
>
  <Download className="h-4 w-4 mr-2" />
  {generatePDFMutation.isPending ? "Génération..." : "Télécharger PDF"}
</Button>
```

**Why base64 decoding:** Backend returns PDF as base64 string for tRPC transport (Phase 10-03). Frontend must decode to binary before creating Blob for download.

**Security:** tRPC mutation verifies quote ownership via tenant isolation before generating PDF.
  </action>
  <verify>
1. Download PDF button triggers mutation
2. Button shows "Génération..." during loading
3. PDF file downloads to browser downloads folder
4. Filename format: quote-Q-2026-NNNN.pdf
5. PDF opens correctly in PDF viewer
6. Toast success message appears
  </verify>
  <done>
- PDF download functionality implemented with base64 decoding
- Loading state on download button
- Automatic file download with correct filename
- Error handling with toast notifications
  </done>
</task>

<task type="auto">
  <name>Task 3: Add state transition buttons to QuoteDetail.tsx</name>
  <files>packages/client/src/pages/QuoteDetail.tsx</files>
  <action>
Add state transition mutations and buttons:

1. **Add mutations** at top with other mutations:
```typescript
const sendMutation = trpc.quotes.send.useMutation({
  onSuccess: () => {
    toast.success("Devis envoyé au client");
    refetch();
  },
  onError: (error) => {
    toast.error(`Erreur: ${error.message}`);
  },
});

const acceptMutation = trpc.quotes.accept.useMutation({
  onSuccess: () => {
    toast.success("Devis accepté");
    refetch();
  },
  onError: (error) => {
    toast.error(`Erreur: ${error.message}`);
  },
});

const rejectMutation = trpc.quotes.reject.useMutation({
  onSuccess: () => {
    toast.success("Devis refusé");
    refetch();
  },
  onError: (error) => {
    toast.error(`Erreur: ${error.message}`);
  },
});

const cancelMutation = trpc.quotes.cancel.useMutation({
  onSuccess: () => {
    toast.success("Devis annulé");
    refetch();
  },
  onError: (error) => {
    toast.error(`Erreur: ${error.message}`);
  },
});

const convertMutation = trpc.quotes.convertToProject.useMutation({
  onSuccess: (projectId) => {
    toast.success("Projet créé à partir du devis");
    navigate(`/projects/${projectId}`);
  },
  onError: (error) => {
    toast.error(`Erreur: ${error.message}`);
  },
});
```

2. **Add handlers** (replace placeholders):
```typescript
const handleSend = () => {
  if (!quote) return;
  sendMutation.mutate({ id: quote.id });
};

const handleAccept = () => {
  if (!quote) return;
  acceptMutation.mutate({ id: quote.id });
};

const handleReject = () => {
  if (!quote) return;
  rejectMutation.mutate({ id: quote.id });
};

const handleCancel = () => {
  if (!quote) return;
  cancelMutation.mutate({ id: quote.id });
};

const handleConvertToProject = () => {
  if (!quote) return;
  convertMutation.mutate({ id: quote.id });
};
```

3. **Add action buttons section** in detail view based on status:
After the quote details card, add:
```tsx
{!isEditing && (
  <Card>
    <CardHeader className="pb-3">
      <CardTitle className="text-base">Actions</CardTitle>
    </CardHeader>
    <CardContent className="pt-0">
      <div className="flex flex-wrap gap-2">
        {/* DRAFT: Can send or cancel */}
        {quote.status === "draft" && (
          <>
            <Button onClick={handleSend} disabled={sendMutation.isPending}>
              <Send className="h-4 w-4 mr-2" />
              {sendMutation.isPending ? "Envoi..." : "Envoyer au client"}
            </Button>
            <Button variant="destructive" onClick={handleCancel} disabled={cancelMutation.isPending}>
              <XCircle className="h-4 w-4 mr-2" />
              Annuler
            </Button>
          </>
        )}

        {/* SENT: Can accept, reject, or cancel */}
        {quote.status === "sent" && !quote.isExpired && (
          <>
            <Button onClick={handleAccept} disabled={acceptMutation.isPending}>
              <CheckCircle className="h-4 w-4 mr-2" />
              Accepter
            </Button>
            <Button variant="outline" onClick={handleReject} disabled={rejectMutation.isPending}>
              <XCircle className="h-4 w-4 mr-2" />
              Refuser
            </Button>
            <Button variant="destructive" onClick={handleCancel} disabled={cancelMutation.isPending}>
              Annuler
            </Button>
          </>
        )}

        {/* ACCEPTED: Can convert to project */}
        {quote.status === "accepted" && (
          <Button onClick={handleConvertToProject} disabled={convertMutation.isPending}>
            <FileText className="h-4 w-4 mr-2" />
            {convertMutation.isPending ? "Conversion..." : "Convertir en projet"}
          </Button>
        )}

        {/* EXPIRED: Show message */}
        {quote.isExpired && (
          <div className="text-sm text-muted-foreground">
            Ce devis a expiré. Créez un nouveau devis si nécessaire.
          </div>
        )}
      </div>
    </CardContent>
  </Card>
)}
```

**State Machine Rules (from Phase 10-02):**
- draft → send → sent
- sent → accept → accepted (can convert to project)
- sent → reject → rejected (terminal)
- draft/sent → cancel → cancelled (terminal)
- sent + date > validUntil → expired (calculated, not mutation)

**Why conditional rendering:** Different actions available based on current status. Backend enforces state machine, UI prevents invalid transitions.
  </action>
  <verify>
1. Draft quote shows "Envoyer au client" and "Annuler" buttons
2. Sent quote shows "Accepter", "Refuser", "Annuler" buttons
3. Accepted quote shows "Convertir en projet" button
4. Expired quote shows informational message (no actions)
5. Buttons show loading state during mutations
6. Quote status badge updates after transition
7. Converting to project navigates to /projects/:id
  </verify>
  <done>
- State transition buttons implemented with conditional rendering
- All 7 states handled correctly (draft/sent/accepted/rejected/expired/cancelled/converted_to_project)
- Loading states on all action buttons
- Navigation to created project after conversion
- Toast notifications for all transitions
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete quote management UI - line items builder, PDF generation, state transitions</what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev` (or `./start.sh`)
2. Visit: http://localhost:5174/quotes
3. **Test Quote Creation with Line Items:**
   - Click "Nouveau devis" button
   - Select a client from dropdown
   - Add 3 line items (use "Ajouter une ligne" button):
     - Line 1: "Enregistrement (4h)", Qty: 4, Prix: 75.00 → Amount: 300.00
     - Line 2: "Mixage", Qty: 1, Prix: 200.00 → Amount: 200.00
     - Line 3: "Mastering", Qty: 1, Prix: 150.00 → Amount: 150.00
   - Verify totals: Sous-total: 650.00 €, TVA (20%): 130.00 €, Total TTC: 780.00 €
   - Fill optional fields: title, terms, notes
   - Click "Créer le devis"
   - Verify toast success and redirect to /quotes
4. **Test Quote Detail View:**
   - Click on created quote from list
   - Verify all quote details display correctly
   - Verify 3 line items display in table/list
   - Verify status badge shows "Brouillon" (draft)
5. **Test PDF Generation:**
   - Click "Télécharger PDF" button
   - Verify button shows "Génération..." during loading
   - Verify PDF file downloads (quote-Q-2026-NNNN.pdf)
   - Open PDF and check:
     - Header with quote number, date, validity
     - Client billing info
     - 3 line items with quantities, prices, amounts
     - Totals (subtotal, tax, grand total)
     - Terms & conditions section
     - Notes section
6. **Test State Transitions:**
   - From draft status:
     - Click "Envoyer au client" → Status changes to "Envoyé" (sent)
     - Verify new action buttons: "Accepter", "Refuser", "Annuler"
   - From sent status:
     - Click "Accepter" → Status changes to "Accepté" (accepted)
     - Verify new action button: "Convertir en projet"
   - From accepted status:
     - Click "Convertir en projet" → Redirects to /projects/:id
     - Verify project created with quote data
7. **Test Edge Cases:**
   - Try creating quote with no line items → Validation error
   - Try removing all line items → Trash button disabled on last item
   - Change quantity/unitPrice → Amount recalculates instantly
   - Try clicking state button rapidly → Loading state prevents double-click
8. **Confirm responsiveness:**
   - Resize browser to mobile width (375px)
   - Verify line items builder adapts to small screen
   - Verify action buttons wrap correctly

**Expected Results:**
- ✅ Line items builder adds/removes items dynamically
- ✅ Amounts calculate automatically
- ✅ PDF downloads with professional formatting
- ✅ State transitions work (draft → sent → accepted → converted)
- ✅ Project creation from quote successful
- ✅ All toast notifications appear correctly
- ✅ No console errors
- ✅ TypeScript compilation: 0 errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe UI issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm check` passes (0 TypeScript errors)
- [ ] Quote creation with line items works end-to-end
- [ ] PDF generation downloads correctly formatted PDF
- [ ] All state transitions functional (draft/sent/accepted/converted)
- [ ] Convert to project creates project successfully
- [ ] UI harmonization follows Phase 3.14 patterns (container spacing, icons, cards)
</verification>

<success_criteria>
- All 3 tasks completed
- Quote creation UI supports multiple line items with dynamic add/remove
- PDF download generates and downloads professional PDF
- State transition buttons work for all 7 states
- Convert to project creates project and navigates to detail view
- Human verification checkpoint approved
- No TypeScript errors introduced
- Phase 11 goal achieved: Complete quote management frontend
</success_criteria>

<output>
After completion, create `.planning/phases/11-systeme-devis-frontend/11-01-SUMMARY.md`:

# Phase 11 Plan 1: Quote Management Frontend UI Summary

**Complete quote creation, PDF generation, and state workflow UI**

## Accomplishments

- Line items builder with dynamic add/remove functionality
- Auto-calculation of amounts and totals
- PDF download with base64 decoding
- State transition buttons for 7-state workflow
- Convert accepted quotes to projects
- Professional UI following Phase 3.14 harmonization patterns

## Files Created/Modified

- `packages/client/src/pages/QuoteCreate.tsx` - Added line items builder
- `packages/client/src/pages/QuoteDetail.tsx` - Added PDF download and state buttons

## Decisions Made

[Document any deviations from plan, UI/UX choices, or architectural decisions]

## Issues Encountered

[Document any bugs found, integration challenges, or unexpected behaviors]

## Next Step

Phase 11 complete. Ready for Phase 12: Tasks Chronométrées - Timer & Database
</output>
