# Phase 3.7 Plan 1: Fix AI Chatbot Cache Invalidation

## Objective

Fix the AI chatbot so that when it creates/updates/deletes resources (clients, sessions, invoices, etc.), the UI updates automatically without requiring a page refresh.

Purpose: Better UX - changes made via chatbot should appear immediately in the UI
Output: AIAssistant.tsx modified to invalidate relevant tRPC caches after chatbot actions

## Execution Context

@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current behavior:**
- User asks chatbot: "Crée un client avec email test@example.com"
- Chatbot creates client successfully via `ai.chat` mutation
- Client is created in database
- UI doesn't update - user must refresh page to see new client
- **Root cause**: No tRPC cache invalidation after chatbot mutations

**Expected behavior:**
- Chatbot creates client
- UI automatically refreshes to show new client
- No page refresh required

**Technical context:**
- Chatbot is in `packages/client/src/components/AIAssistant.tsx`
- Uses `trpc.ai.chat.useMutation()` to send messages
- Backend handles actions in `packages/server/src/routers/ai.ts`
- Backend returns action results in response (e.g., `{action: "create_client", clientId: 123}`)
- Frontend needs to invalidate appropriate tRPC queries based on action type

**Pattern to follow:**
Other components that use mutations properly invalidate caches:
```tsx
const utils = trpc.useUtils();
const createMutation = trpc.clients.create.useMutation({
  onSuccess: () => {
    utils.clients.list.invalidate();
  }
});
```

## Tasks

<task type="auto">
  <name>Task 1: Add tRPC utils and cache invalidation to AIAssistant</name>
  <files>packages/client/src/components/AIAssistant.tsx</files>
  <action>
    1. Import `trpc` from `@/lib/trpc` (already imported as `trpc`)
    2. Add `const utils = trpc.useUtils();` at component top (after mutations)
    3. After successful chatbot response (in handleSendMessage try block, after setMessages):
       - Parse response to detect action type (check if response contains action metadata)
       - Based on action type, invalidate relevant queries:
         - If client created/updated/deleted → `utils.clients.list.invalidate()`
         - If session created/updated/deleted → `utils.sessions.list.invalidate()`
         - If invoice created/updated/deleted → `utils.invoices.list.invalidate()`
         - If room created/updated/deleted → `utils.rooms.list.invalidate()`
         - If equipment created/updated/deleted → `utils.equipment.list.invalidate()`
         - If project created/updated/deleted → `utils.projects.list.invalidate()`
       - Add conservative fallback: invalidate all common queries if action unknown
    4. Keep existing error handling unchanged
  </action>
  <verify>
    - TypeScript compilation succeeds (`pnpm build` in packages/client)
    - No console errors when chatbot is used
    - Code follows existing tRPC invalidation patterns
  </verify>
  <done>
    - AIAssistant.tsx imports trpc.useUtils()
    - Cache invalidation logic added after chatbot response
    - Action detection and appropriate query invalidation implemented
    - Build succeeds without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy and verify cache invalidation works</name>
  <files>packages/client/src/components/AIAssistant.tsx</files>
  <action>
    1. Build client Docker image locally: `docker compose build --no-cache client`
    2. Deploy modified file to VPS: `rsync -avz packages/client/src/components/AIAssistant.tsx vps-n8n:/root/recording-studio-manager-hybrid/packages/client/src/components/`
    3. Rebuild client on VPS: `ssh vps-n8n "cd /root/recording-studio-manager-hybrid && docker compose build --no-cache client && docker compose restart client"`
    4. Wait for container to be healthy (check with docker compose ps)
  </action>
  <verify>
    - rsync completes successfully
    - Docker build succeeds on VPS
    - Client container restarts and becomes healthy
    - No build errors in logs
  </verify>
  <done>
    - Changes deployed to production
    - Client container running with updated code
    - Container status shows "healthy"
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>AI chatbot with automatic cache invalidation after mutations</what-built>
  <how-to-verify>
    1. Visit: https://recording-studio-manager.com/clients
    2. Note the current number of clients in the list
    3. Open AI Assistant (bottom right)
    4. Send message: "Crée un nouveau client avec email cache-test@example.com et nom Cache Test"
    5. Wait for chatbot response confirming client creation
    6. WITHOUT refreshing the page, check if the new client appears in the list automatically
    7. Expected: Client appears immediately without refresh
    8. Test with other resources if possible (sessions, invoices)
  </how-to-verify>
  <resume-signal>Type "approved" if cache invalidation works (list updates automatically), or describe issues</resume-signal>
</task>

## Verification

Before declaring phase complete:
- [ ] TypeScript build succeeds without errors
- [ ] AIAssistant.tsx uses trpc.useUtils() for cache invalidation
- [ ] Chatbot creates client → UI updates automatically
- [ ] No page refresh required to see changes
- [ ] Container deployed and healthy in production

## Success Criteria

- All tasks completed
- Cache invalidation logic added to AIAssistant.tsx
- Changes deployed to production
- Manual testing confirms: creating client via chatbot → list updates automatically
- No regression: chatbot still works for all other actions

## Output

After completion, create `.planning/phases/3.7-ai-chatbot-cache-invalidation/3.7-01-SUMMARY.md`:

# Phase 3.7 Plan 1: AI Chatbot Cache Invalidation - SUMMARY

**AI chatbot now invalidates tRPC caches after mutations - UI updates automatically**

## Accomplishments

- Added trpc.useUtils() to AIAssistant component
- Implemented action-based cache invalidation after chatbot responses
- Deployed to production and verified automatic UI updates

## Files Modified

- `packages/client/src/components/AIAssistant.tsx` - Added cache invalidation logic

## Decisions Made

[Document approach for action detection and which queries to invalidate]

## Issues Encountered

[Any deployment or implementation issues, or "None"]

## Next Step

Phase 3.7 complete - Ready for Phase 4 (Marketing Foundation)
