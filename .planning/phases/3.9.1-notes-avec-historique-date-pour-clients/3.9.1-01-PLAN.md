---
phase: 3.9.1-notes-avec-historique-date-pour-clients
plan: 01
type: execute
---

<objective>
Create backend infrastructure for dated client notes history - database schema, migrations, and tRPC API.

Purpose: Transform single notes field into professional timestamped history system for better client relationship management.
Output: New client_notes table, migration, tRPC router with CRUD operations, type-safe API endpoints ready for frontend consumption.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current Implementation:**
- Single `notes` text field in clients table (packages/database/src/tenant/schema.ts:28)
- Simple textarea overwrites previous notes on each save
- No timestamps, no history, no audit trail
- ClientDetail.tsx displays basic textarea

**Established Patterns:**
- Database migrations: `packages/database/drizzle/tenant/` directory
- Schema definitions: `packages/database/src/tenant/schema.ts`
- tRPC routers: `packages/server/src/routers/` with standard CRUD patterns
- Type inference: `typeof table.$inferSelect` for type safety

**Prior Decisions:**
- Database-per-Tenant architecture (Phase Init) - client_notes table goes in tenant schema
- Drizzle ORM (Phase Init) - use pgTable, relations for type-safe queries
- tRPC 11 (Phase Init) - protectedProcedure for authenticated endpoints

**From Phase 3.9:**
- SuperAdmin dashboard pattern established
- Database management UI operational
- Production deployment workflow validated
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client_notes table migration</name>
  <files>packages/database/drizzle/tenant/XXXX_add_client_notes.sql, packages/database/src/tenant/schema.ts</files>
  <action>
    1. Add client_notes table definition to schema.ts after clients table:
       - id: serial primary key
       - clientId: integer FK to clients(id) with onDelete cascade
       - note: text (not null)
       - createdAt: timestamp (not null, defaultNow)
       - createdBy: integer (optional FK to master.users for future multi-user)

    2. Add Drizzle relations:
       - clientsRelations: clients hasMany client_notes
       - clientNotesRelations: client_notes belongsTo clients

    3. Export types: ClientNote, InsertClientNote

    4. Generate migration: `cd packages/database && pnpm drizzle-kit generate`

    5. Apply migration to production:
       - Connect to VPS: `ssh vps-n8n`
       - Run migration: `docker exec -it rsm-postgres psql -U postgres -d tenant_6 -f /path/to/migration.sql`
       - Verify: `\d client_notes` shows correct schema

    Note: Keep existing clients.notes field for backward compatibility during transition.
  </action>
  <verify>
    - Schema file compiles without TypeScript errors
    - Migration file generated in drizzle/tenant/
    - Production database has client_notes table
    - `SELECT * FROM client_notes LIMIT 1` returns no rows (empty table)
  </verify>
  <done>
    - client_notes table exists in tenant schema
    - Migration applied to production
    - TypeScript types exported
    - Relations defined for joins
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client notes tRPC router</name>
  <files>packages/server/src/routers/clientNotes.ts, packages/server/src/routers/index.ts</files>
  <action>
    Create new router packages/server/src/routers/clientNotes.ts with procedures:

    1. **list** (query):
       - Input: { clientId: number }
       - Query: SELECT * FROM client_notes WHERE clientId = ? ORDER BY createdAt DESC
       - Returns: Array of ClientNote with client relation
       - Use protectedProcedure for auth

    2. **create** (mutation):
       - Input: { clientId: number, note: string }
       - Validate: note.trim().length > 0
       - Insert with createdBy = ctx.session.userId
       - Return: Created ClientNote

    3. **delete** (mutation):
       - Input: { id: number }
       - Validate: Note belongs to current organization (via clientId FK)
       - Delete: WHERE id = ?
       - Return: { success: boolean }

    4. Register router in packages/server/src/routers/index.ts:
       - Add: clientNotes: clientNotesRouter

    Follow established patterns from packages/server/src/routers/clients.ts for consistency.
  </action>
  <verify>
    - `pnpm build` succeeds in packages/server
    - TypeScript infers correct types for all procedures
    - tRPC router exports correctly from index.ts
  </verify>
  <done>
    - clientNotes router created with 3 procedures
    - Registered in main router export
    - Type-safe inputs/outputs
    - Protected by session auth
  </done>
</task>

<task type="auto">
  <name>Task 3: Update clients router to include notes relation</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
    Enhance clients router queries to include notes metadata:

    1. In `list` query:
       - Add notes count: `SELECT clients.*, COUNT(client_notes.id) as notesCount`
       - Add latest note preview: `MAX(client_notes.createdAt) as lastNoteDate`
       - Use LEFT JOIN for clients without notes

    2. In `getById` query:
       - Include full client_notes relation
       - Order notes by createdAt DESC
       - Limit to 10 most recent for performance

    3. Keep existing `create`, `update`, `delete` mutations unchanged

    Pattern reference: Similar to how sessions include client relation in packages/server/src/routers/sessions.ts
  </action>
  <verify>
    - `pnpm build` succeeds
    - Client list query returns notesCount field
    - Client detail query includes client_notes array
  </verify>
  <done>
    - Clients queries enhanced with notes metadata
    - Backward compatible (existing queries still work)
    - Type-safe with inferred types
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds in packages/database and packages/server
- [ ] Migration applied to production database
- [ ] tRPC API endpoints type-check correctly
- [ ] No TypeScript errors introduced
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- client_notes table operational in production
- tRPC API ready for frontend consumption
- No breaking changes to existing client functionality
</success_criteria>

<output>
After completion, create `.planning/phases/3.9.1-notes-avec-historique-date-pour-clients/3.9.1-01-SUMMARY.md`:

# Phase 3.9.1 Plan 1: Backend Infrastructure Summary

**Backend API and database schema for dated client notes history**

## Accomplishments

- Created client_notes table with timestamps and audit trail
- Built tRPC router with create/list/delete operations
- Enhanced clients router to include notes metadata
- Applied migration to production database

## Files Created/Modified

- `packages/database/src/tenant/schema.ts` - Added client_notes table + relations
- `packages/database/drizzle/tenant/XXXX_add_client_notes.sql` - Migration
- `packages/server/src/routers/clientNotes.ts` - New tRPC router
- `packages/server/src/routers/clients.ts` - Enhanced with notes metadata
- `packages/server/src/routers/index.ts` - Registered clientNotes router

## Decisions Made

- Kept existing clients.notes field for backward compatibility during transition
- Used createdBy field for future multi-user audit trail
- Cascade delete on client deletion (orphaned notes auto-removed)
- Default ordering by createdAt DESC (newest first)

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 3.9.1-02-PLAN.md (Frontend UI Implementation)
</output>
