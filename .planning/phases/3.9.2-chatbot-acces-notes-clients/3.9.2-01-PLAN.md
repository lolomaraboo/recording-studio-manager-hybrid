---
phase: 3.9.2-chatbot-acces-notes-clients
plan: 1
type: execute
---

<objective>
Add client notes access to AI chatbot - enable chatbot to read and manage dated notes history for clients

Purpose: Enable chatbot to provide context-aware responses about client interactions and manage notes via natural language
Output: AI chatbot can access notes when discussing clients, add notes, and answer questions about client history
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase context:**
Phase 3.9.1 implemented dated notes history for clients (client_notes table with timestamps, UI timeline), but the AI chatbot cannot access these notes.

**Current limitation:**
- AI chatbot uses `AIActionExecutor.get_client_info()` which does SELECT from clients table only
- Client notes are NOT included in chatbot's client data
- Chatbot cannot answer questions like "What did we discuss with Alice last week?"
- Chatbot cannot add notes via natural language commands

**Prior work:**
@.planning/phases/3.9.1-notes-avec-historique-date-pour-clients/3.9.1-01-SUMMARY.md - Backend infrastructure (client_notes table, tRPC router)
@.planning/phases/3.9.1-notes-avec-historique-date-pour-clients/3.9.1-02-SUMMARY.md - Frontend UI (NotesHistory component)

**Relevant source files:**
@packages/server/src/lib/aiTools.ts - AI tool definitions (37 tools currently)
@packages/server/src/lib/aiActions.ts - AI action executor implementations
@packages/server/src/routers/clientNotes.ts - Client notes tRPC router (list, create, delete)
@packages/database/tenant/src/schema.ts - client_notes table schema
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client notes tools to AI chatbot (3 new tools)</name>
  <files>packages/server/src/lib/aiTools.ts</files>
  <action>
Add 3 new tools to AI_TOOLS array in CLIENTS TOOLS section (after delete_client):

1. **get_client_notes** - Récupère l'historique des notes d'un client
   - Input: client_id (number, required), limit (number, optional, default 10)
   - Description: "Récupère l'historique daté des notes pour un client spécifique. Retourne les notes en ordre chronologique inversé (plus récentes d'abord)."

2. **add_client_note** - Ajoute une note datée à un client
   - Input: client_id (number, required), note (string, required, max 2000 chars)
   - Description: "Ajoute une nouvelle note datée pour un client. La note sera horodatée automatiquement."

3. **delete_client_note** - Supprime une note client
   - Input: note_id (number, required)
   - Description: "Supprime une note spécifique par son ID."

Follow existing tool schema pattern (see get_client_info, create_client for reference).
Update CLIENTS TOOLS comment from "(5)" to "(8)".
  </action>
  <verify>
grep -A 5 "get_client_notes\|add_client_note\|delete_client_note" packages/server/src/lib/aiTools.ts shows 3 new tool definitions
grep "CLIENTS TOOLS (8)" packages/server/src/lib/aiTools.ts confirms updated count
  </verify>
  <done>3 client notes tools defined with proper schemas, CLIENTS TOOLS count updated to 8</done>
</task>

<task type="auto">
  <name>Task 2: Implement client notes actions in AIActionExecutor</name>
  <files>packages/server/src/lib/aiActions.ts</files>
  <action>
Add 3 new action implementations to AIActionExecutor class:

**1. Import clientNotes table** (top of file, line ~13):
```typescript
import {
  sessions,
  clients,
  clientNotes, // ADD THIS
  invoices,
  // ...
} from "@rsm/database/tenant";
```

**2. Add switch cases** (in execute() method, after delete_client case ~line 91):
```typescript
case "get_client_notes":
  result = await this.get_client_notes(params as any);
  break;
case "add_client_note":
  result = await this.add_client_note(params as any);
  break;
case "delete_client_note":
  result = await this.delete_client_note(params as any);
  break;
```

**3. Implement methods** (in CLIENTS section, after delete_client method):

```typescript
/**
 * Get client notes history
 */
async get_client_notes(params: { client_id: number; limit?: number }) {
  const { client_id, limit = 10 } = params;

  const notes = await this.db
    .select()
    .from(clientNotes)
    .where(eq(clientNotes.clientId, client_id))
    .orderBy(desc(clientNotes.createdAt))
    .limit(limit);

  return notes;
}

/**
 * Add client note
 */
async add_client_note(params: { client_id: number; note: string }) {
  const { client_id, note } = params;

  const [newNote] = await this.db
    .insert(clientNotes)
    .values({
      clientId: client_id,
      note: note,
      createdAt: new Date(),
    })
    .returning();

  return newNote;
}

/**
 * Delete client note
 */
async delete_client_note(params: { note_id: number }) {
  const { note_id } = params;

  await this.db
    .delete(clientNotes)
    .where(eq(clientNotes.id, note_id));

  return { success: true, id: note_id };
}
```

Use existing pattern from get_client_info, create_client for consistency.
Import desc from drizzle-orm if not already present.
  </action>
  <verify>
grep "import.*clientNotes" packages/server/src/lib/aiActions.ts shows import added
grep "case \"get_client_notes\"" packages/server/src/lib/aiActions.ts shows switch cases added
grep -A 10 "async get_client_notes" packages/server/src/lib/aiActions.ts shows method implementation
  </verify>
  <done>3 client notes actions implemented with DB queries, properly integrated into executor</done>
</task>

<task type="auto">
  <name>Task 3: Update AI system prompt to mention notes capability</name>
  <files>packages/server/src/lib/aiSystemPrompt.ts</files>
  <action>
Update system prompt to inform Claude it can now access and manage client notes.

Find the section describing client management capabilities (likely in "AVAILABLE ACTIONS" or "CLIENT MANAGEMENT" section), and add notes capability:

Example addition:
```
**Client Notes:**
- Consulter l'historique des notes d'un client (get_client_notes)
- Ajouter une note datée à un client (add_client_note)
- Supprimer une note (delete_client_note)
- Les notes sont horodatées automatiquement et affichées en ordre chronologique inversé
```

Also update total actions count from 37 to 40 if mentioned in prompt.
  </action>
  <verify>
grep -i "notes" packages/server/src/lib/aiSystemPrompt.ts shows notes capability documented
grep "40" packages/server/src/lib/aiSystemPrompt.ts OR grep "37" shows action count (verify if mentioned)
  </verify>
  <done>System prompt updated to reflect notes access capability, chatbot knows it can manage client notes</done>
</task>

<task type="auto">
  <name>Task 4: Test chatbot notes access in production</name>
  <files>None (testing task)</files>
  <action>
Deploy changes to production and test chatbot notes functionality:

1. **Commit changes:**
```bash
cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid
git add packages/server/src/lib/aiTools.ts packages/server/src/lib/aiActions.ts packages/server/src/lib/aiSystemPrompt.ts
git commit -m "feat(3.9.2): add client notes access to AI chatbot (40 tools total)

- Add 3 new AI tools: get_client_notes, add_client_note, delete_client_note
- Implement actions in AIActionExecutor with clientNotes table queries
- Update system prompt to document notes capability
- Enables chatbot to read/write dated client notes history

Phase 3.9.2-01 complete"
```

2. **Deploy to production:**
```bash
ssh vps-n8n "cd /root/recording-studio-manager-hybrid && git pull && docker-compose restart rsm-server"
```

3. **Test with existing test account** (test-notes@example.com has Test Client Notes with 4 notes):
   - Test query: "Quelles sont les notes sur le client Test Client Notes ?"
   - Test add: "Ajoute une note pour Test Client Notes : Appelé aujourd'hui pour discuter du nouveau projet"
   - Test recall: "Qu'est-ce qu'on a discuté avec Test Client Notes récemment ?"
   - Verify chatbot can see and manage notes

4. **Check AI action logs:**
```bash
ssh vps-n8n "docker exec rsm-postgres psql -U postgres -d tenant_org_6 -c \"SELECT * FROM ai_action_logs WHERE action_name LIKE '%client_note%' ORDER BY created_at DESC LIMIT 5;\""
```
  </action>
  <verify>
- git log shows commit for Phase 3.9.2
- ssh vps-n8n "docker ps" shows rsm-server container restarted recently
- Chatbot responds with client notes when asked
- Chatbot can add notes via natural language
- ai_action_logs table shows get_client_notes, add_client_note actions executed successfully
  </verify>
  <done>Chatbot deployed to production, successfully accessing and managing client notes, verified with test account</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] 3 new tools added to aiTools.ts (get_client_notes, add_client_note, delete_client_note)
- [ ] 3 new actions implemented in aiActions.ts with proper DB queries
- [ ] System prompt updated to document notes capability
- [ ] Changes committed and deployed to production
- [ ] Chatbot can read client notes when asked about client history
- [ ] Chatbot can add notes via natural language commands
- [ ] ai_action_logs shows successful notes operations
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Chatbot can access client notes history (Phase 3.9.1 feature) via natural language
- Total AI tools count increased from 37 to 40
- No TypeScript errors
- Production deployment successful
- Test account verification shows chatbot notes access working
</success_criteria>

<output>
After completion, create `.planning/phases/3.9.2-chatbot-acces-notes-clients/3.9.2-01-SUMMARY.md`:

# Phase 3.9.2 Plan 1: Chatbot Notes Access Summary

**Chatbot can now read and manage client notes history**

## Accomplishments

- Added 3 new AI tools for client notes (get_client_notes, add_client_note, delete_client_note)
- Implemented AIActionExecutor methods with clientNotes table queries
- Updated system prompt to document notes capability
- Total AI tools: 40 (was 37)
- Deployed to production and verified with test account

## Files Created/Modified

- `packages/server/src/lib/aiTools.ts` - Added 3 client notes tool definitions
- `packages/server/src/lib/aiActions.ts` - Implemented 3 client notes actions with DB queries
- `packages/server/src/lib/aiSystemPrompt.ts` - Updated to mention notes capability

## Decisions Made

- Reused existing clientNotes table/router from Phase 3.9.1 (no new tables needed)
- Default limit 10 notes for get_client_notes (prevents overwhelming chatbot context)
- Notes displayed in reverse chronological order (same as UI timeline)
- Delete action requires note_id (not client_id + index) for precision

## Issues Encountered

[Document any deployment or testing issues]

## Next Phase Readiness

✅ **Phase 3.9.2 Complete** - Chatbot fully integrated with client notes history

**Ready for:** Phase 4.0 - Marketing Foundation
</output>
