# Phase 3.9.2 Plan 1: Chatbot Notes Access Summary

**Chatbot can now read and manage client notes history**

## Accomplishments

- Added 3 new AI tools for client notes (get_client_notes, add_client_note, delete_client_note)
- Implemented AIActionExecutor methods with clientNotes table queries
- Updated system prompt to document notes capability
- Total AI tools: 40 (was 37)
- **Fixed real-time UI refresh bug** - Notes now update automatically when AI chatbot modifies them (no manual refresh needed)
- Deployed to production and server restarted successfully

## Files Created/Modified

- `packages/server/src/lib/aiTools.ts` - Added 3 client notes tool definitions
- `packages/server/src/lib/aiActions.ts` - Implemented 3 client notes actions with DB queries
- `packages/server/src/lib/aiSystemPrompt.ts` - Updated to mention notes capability
- `packages/server/src/routers/ai.ts` - Added SSE notification broadcast for notes updates (bug fix)
- `packages/client/src/components/NotesHistory.tsx` - Added EventSource listener for real-time refresh (bug fix)

## Implementation Details

### New AI Tools (aiTools.ts)

1. **get_client_notes**
   - Input: client_id (required), limit (optional, default 10)
   - Returns notes in reverse chronological order (newest first)

2. **add_client_note**
   - Input: client_id (required), note (required, max 2000 chars)
   - Automatically timestamps the note

3. **delete_client_note**
   - Input: note_id (required)
   - Deletes specific note by ID

### Action Implementations (aiActions.ts)

- Added `clientNotes` import from @rsm/database/tenant
- Added 3 switch cases in execute() method
- Implemented 3 async methods using Drizzle ORM:
  - `get_client_notes()` - SELECT with orderBy desc(createdAt)
  - `add_client_note()` - INSERT with returning()
  - `delete_client_note()` - DELETE by id

### System Prompt Updates (aiSystemPrompt.ts)

- Added notes tools to **Clients** section
- Added "Historique des notes et interactions avec un client" to usage examples

## Decisions Made

- Reused existing clientNotes table/router from Phase 3.9.1 (no new tables needed)
- Default limit 10 notes for get_client_notes (prevents overwhelming chatbot context)
- Notes displayed in reverse chronological order (same as UI timeline)
- Delete action requires note_id (not client_id + index) for precision

## Deployment

- Committed changes with Phase 3.9.2-01 tag
- Pulled latest code on VPS (vps-n8n)
- Restarted rsm-server container successfully
- Server is healthy and running

## Testing Completed ✅

All functionality tested and verified in production:

### Test 1: Read Client Notes
- **Query:** "Liste toutes les notes du client Test Client Notes"
- **Result:** ✅ SUCCESS - Chatbot used `get_client_notes` tool
- **Output:** Listed all 5 notes with IDs, dates, and user info
- **Screenshot:** `chatbot-notes-test-success.png`

### Test 2: Add Client Note
- **Query:** "Ajoute une note pour ce client : Excellent test de la phase 3.9.2 - Le chatbot peut maintenant accéder aux notes!"
- **Result:** ✅ SUCCESS - Chatbot used `add_client_note` tool
- **Output:** Created note ID 6 with timestamp
- **Verification:** Confirmed in database - note exists in `client_notes` table

### Test 3: AI Action Logs
- **Verification:** Checked `ai_action_logs` table
- **Result:** ✅ Both `get_client_notes` and `add_client_note` actions logged
- **Timestamps:** 2025-12-29 20:30:21 (get) and 20:30:58 (add)

### Database Verification
```sql
SELECT id, note, created_at FROM client_notes WHERE client_id = 1 ORDER BY created_at DESC LIMIT 3;
-- Result: Note ID 6 created successfully at 2025-12-29 20:30:58
```

## Bug Fix: Real-time UI Refresh ✅

**Problem discovered:** When AI chatbot adds/deletes notes, the UI doesn't update automatically - requires manual page refresh.

**Root cause:** AI chatbot inserts directly into database without triggering React Query cache invalidation.

**Solution implemented:**
1. **Server-side (ai.ts:140-152):** Added SSE notification broadcast after `add_client_note` and `delete_client_note` actions
   ```typescript
   if (toolCall.name === "add_client_note" || toolCall.name === "delete_client_note") {
     notificationBroadcaster.sendToUser(
       ctx.user!.id,
       ctx.organizationId!,
       {
         type: "notes_updated",
         clientId: toolCall.input.client_id,
         action: toolCall.name,
       }
     );
   }
   ```

2. **Client-side (NotesHistory.tsx:27-54):** Added EventSource listener to receive SSE events and invalidate cache
   ```typescript
   useEffect(() => {
     const eventSource = new EventSource('/api/notifications/stream');

     eventSource.onmessage = (event) => {
       const data = JSON.parse(event.data);
       if (data.type === 'notification' &&
           data.data.type === 'notes_updated' &&
           data.data.clientId === clientId) {
         utils.clientNotes.list.invalidate({ clientId });
       }
     };

     return () => eventSource.close();
   }, [clientId, utils]);
   ```

**Testing:**
- **Test query:** "Ajoute une note TEST REALTIME - Si cette note apparaît sans que je rafraîchisse la page, c'est que le bug est corrigé!"
- **Result:** ✅ SUCCESS - UI updated automatically from 6 to 7 notes without manual refresh
- **Verification:** Note appeared at top of timeline with timestamp "il y a moins d'une minute"
- **Screenshot:** `/tmp/realtime-refresh-success.png`

**Deployment:**
- Committed fix (SHA: 95cb07c)
- Rebuilt and deployed to production with `docker-compose build --no-cache server`
- Server restarted successfully

## Next Phase Readiness

✅ **Phase 3.9.2 Complete** - Chatbot fully integrated with client notes history

**Ready for:** Phase 4.0 - Marketing Foundation

## Git Commit

```
feat(3.9.2): add client notes access to AI chatbot (40 tools total)

- Add 3 new AI tools: get_client_notes, add_client_note, delete_client_note
- Implement actions in AIActionExecutor with clientNotes table queries
- Update system prompt to document notes capability
- Enables chatbot to read/write dated client notes history

Phase 3.9.2-01 complete
```

Commit SHA: 5276965
