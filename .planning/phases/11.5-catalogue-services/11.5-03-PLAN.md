---
phase: 11.5-catalogue-services
plan: 03
type: execute
---

<objective>
Integrate service catalog into quote creation workflow with autocomplete in description field and "From Catalog" button with modal selector.

Purpose: Enable quick addition of pre-defined services to quotes via two complementary methods: fuzzy autocomplete for power users and visual catalog modal for discovery.
Output: Enhanced QuoteCreate.tsx with service catalog integration, auto-filling line item fields when service selected.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.5-catalogue-services/11.5-CONTEXT.md
@.planning/phases/11.5-catalogue-services/11.5-01-SUMMARY.md
@.planning/phases/11.5-catalogue-services/11.5-02-SUMMARY.md

**Quote creation current implementation:**
@packages/client/src/pages/QuoteCreate.tsx # Line items builder, manual entry

**Autocomplete patterns:**
@packages/client/src/components/GlobalSearch.tsx # Fuzzy search with dropdown, keyboard navigation
@packages/client/src/components/CommandPalette.tsx # Autocomplete UX patterns

**Modal patterns:**
@packages/client/src/pages/Services.tsx # Dialog/modal structure just created

**Integration requirements from CONTEXT.md:**
- **Autocomplete**: Type in description field → dropdown suggests matching services → select = auto-fill quantity/price/TVA
- **"From Catalog" button**: Opens modal with category-filtered list → click service = add new line item with all fields filled
- **Flexibility preserved**: Users can still manually edit all fields after selection, or add completely custom line items
- **Per-line tax override**: When service selected, if its taxRate differs from quote default (20%), override that specific line's tax calculation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add autocomplete to description field with service suggestions</name>
  <files>packages/client/src/pages/QuoteCreate.tsx</files>
  <action>
Transform description Input into autocomplete component (pattern from GlobalSearch):

**Implementation approach:**
1. **Replace description Input with Popover + Command structure:**
   - Wrap description input in Popover (shadcn/ui)
   - On input focus + typing: show Command dropdown with suggestions
   - Query: `trpc.serviceCatalog.list.useQuery({ search: descriptionQuery, activeOnly: true })`
   - Debounce search by 200ms (avoid excessive queries)

2. **Dropdown rendering:**
   - Show up to 10 matching services
   - Each item displays: `{service.name}` (bold) | `{service.category}` (muted) | `{service.unitPrice}€`
   - Group by category if >5 results (optional polish)
   - Keyboard navigation: Arrow up/down, Enter to select, Escape to close

3. **Selection behavior:**
   - On service selection (click or Enter):
     - Set description to service.name
     - Set quantity to service.defaultQuantity
     - Set unitPrice to service.unitPrice
     - Calculate amount (quantity * unitPrice)
     - Store service.taxRate for this line item (see Task 2)
     - Close dropdown
     - Auto-focus on next field (quantity or next line)

4. **Preserve manual entry:**
   - If user types and doesn't select from dropdown: treat as free-form description (current behavior)
   - User can edit any field after autocomplete selection

**UX considerations:**
- Only show dropdown if search query length >= 2 characters
- Show "Aucun service trouvé" if no matches
- Show "Tapez pour rechercher..." as placeholder
- Dropdown closes on: selection, click outside, Escape, blur (with 100ms delay for click handling)
  </action>
  <verify>
- Type 2+ characters in description field: dropdown appears with matching services
- Services display with name, category, and price
- Arrow keys navigate suggestions
- Enter key selects highlighted service
- Selected service auto-fills description, quantity, unitPrice, amount
- Manual typing (no selection) still works for custom descriptions
- Dropdown closes appropriately on selection/blur/escape
  </verify>
  <done>Autocomplete functional in description field with fuzzy search, keyboard navigation, and auto-fill on selection</done>
</task>

<task type="auto">
  <name>Task 2: Implement per-line tax rate override for catalog services</name>
  <files>packages/client/src/pages/QuoteCreate.tsx</files>
  <action>
Enhance line item state to support per-line tax rates (currently quote has single global taxRate):

**State changes:**
1. Extend LineItem type to include optional taxRate:
```typescript
type LineItem = {
  description: string;
  quantity: string;
  unitPrice: string;
  amount: string;
  displayOrder: number;
  taxRate?: string; // NEW: per-line tax rate override (if different from quote default)
};
```

2. Modify tax calculation in subtotal/total computation:
   - Current: All items use global `taxRate` state
   - New: Each item uses `item.taxRate || taxRate` (line override or global default)
   - Calculate per-line tax: `lineAmount * (lineTaxRate / 100)`
   - Sum all line taxes for total taxAmount

3. Update autocomplete selection (from Task 1):
   - When service selected: `item.taxRate = service.taxRate`
   - If service.taxRate matches global taxRate: omit (use default)
   - If service.taxRate differs: store override

4. Update line item rendering:
   - Add small badge/indicator if line has custom taxRate (different from global)
   - Display: "TVA {lineTaxRate}%" in muted text next to amount
   - Allow manual override: small dropdown icon to change line-specific TVA

**Backend compatibility:**
- Current quoteItems schema has no taxRate column (uses quote.taxRate)
- This is UI-only calculation for now (Phase 11.5 scope)
- Future enhancement (Phase 11.6+): Add taxRate column to quoteItems table for persistence
- For Phase 11.5: Calculate correct totals in UI, backend stores aggregated taxAmount only

**Fallback:**
If implementing per-line tax is too complex for this phase, defer to Phase 11.6 and use global taxRate only. Document as known limitation: "Catalogue services with different TVA rates will use quote's global TVA rate until Phase 11.6."
  </action>
  <verify>
- Create quote with service that has 10% TVA (if global is 20%)
- Tax calculation uses 10% for that specific line item
- Total tax amount sums correctly (different rates per line)
- Badge/indicator shows which lines have custom TVA
- Manual entry lines use global taxRate (no override)
  </verify>
  <done>Per-line tax rate override implemented for catalog services with different TVA rates, or documented as Phase 11.6 enhancement if deferred</done>
</task>

<task type="auto">
  <name>Task 3: Add "From Catalog" button with category-filtered modal</name>
  <files>packages/client/src/pages/QuoteCreate.tsx</files>
  <action>
Add catalog browser modal next to "Ajouter une ligne" button:

**Button placement:**
- Position: Next to "Ajouter une ligne" button (same row)
- Text: "Du catalogue" (or icon: Package from lucide-react)
- Style: Secondary variant (not primary - "Ajouter" is primary action)

**Modal structure (Dialog component):**
- Title: "Sélectionner un service du catalogue"
- Width: lg (800px) - need space for table/cards
- Header: Category filter dropdown (All, Studio, Post-production, Location matériel, Autre)

**Service display (choose one approach):**

**Option A - Table view (recommended):**
- Table with columns: Nom | Catégorie | Prix | TVA | Qté défaut
- Rows clickable (hover highlight)
- Click row = select service
- Shows 10-15 services, scrollable if more

**Option B - Card grid:**
- Grid of service cards (2-3 columns)
- Each card: Name (h3), Category badge, Price (large), TVA (small), Default qty
- Click card = select service

Choose Option A (table) for consistency with Services management page.

**Selection behavior:**
- Click service in table:
  - Add new line item to items array (same as "Ajouter une ligne")
  - Pre-fill: description (service.name), quantity (service.defaultQuantity), unitPrice (service.unitPrice), taxRate (service.taxRate)
  - Calculate amount
  - Close modal
  - Focus new line's description field (for optional editing)

**Query:**
- Use same tRPC query as autocomplete: `trpc.serviceCatalog.list.useQuery({ category: selectedCategory, activeOnly: true })`
- Real-time category filter (no search needed - full list visible)

**Empty state:**
- If no services in catalog: "Aucun service dans le catalogue. Créez-en un dans la page Services."
- Link to /services page
  </action>
  <verify>
- "Du catalogue" button appears next to "Ajouter une ligne"
- Click button opens modal with service catalog table
- Category filter updates table content
- Clicking a service adds new line item with all fields pre-filled
- Modal closes after selection
- Focus moves to new line for editing
- Empty state shows when catalog is empty with link to /services
  </verify>
  <done>"From Catalog" button functional with modal selector, category filtering, and auto-populated line items</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Autocomplete shows suggestions when typing in description field (2+ chars)
- [ ] Selecting autocomplete suggestion fills all line item fields
- [ ] "Du catalogue" button opens modal with category-filtered services
- [ ] Selecting service from modal adds new line with pre-filled data
- [ ] Tax calculation accounts for per-line rates (or documented as Phase 11.6)
- [ ] Manual line entry (free-form) still works alongside catalog features
- [ ] No TypeScript errors: `pnpm --filter client tsc --noEmit`
- [ ] Build succeeds: `pnpm --filter client build`
</verification>

<success_criteria>
- Autocomplete functional in description field with fuzzy search and keyboard navigation
- Service selection auto-fills description, quantity, unitPrice, and calculates amount
- "From Catalog" modal provides visual service browser with category filter
- Both entry methods (autocomplete + modal) integrate seamlessly with existing line item builder
- Users can still manually edit all fields after catalog selection
- Tax rate handling addresses services with different TVA (implemented or documented for Phase 11.6)
- Complete Phase 11.5 objectives from CONTEXT.md achieved
</success_criteria>

<output>
After completion, create `.planning/phases/11.5-catalogue-services/11.5-03-SUMMARY.md`:

# Phase 11.5 Plan 03: Quote Builder Integration Summary

**Service catalog integrated into quote creation with dual access methods**

## Accomplishments

- Added autocomplete to description field with fuzzy service search
- Implemented "From Catalog" button with category-filtered modal
- Auto-fill line item fields (description, quantity, unitPrice, amount) on service selection
- Preserved manual entry flexibility - all fields editable after selection
- [If implemented] Per-line tax rate override for services with different TVA
- [If deferred] Documented per-line tax as Phase 11.6 enhancement

## Files Created/Modified

- `packages/client/src/pages/QuoteCreate.tsx` - Enhanced with autocomplete + catalog modal (200-300 lines added)

## Decisions Made

- Autocomplete triggers at 2+ characters (balance between UX and query load)
- 200ms debounce on autocomplete search (avoid excessive tRPC calls)
- Table view in catalog modal (consistency with Services management page)
- "Du catalogue" button secondary style (not competing with primary "Ajouter une ligne")
- [If per-line tax deferred] Global taxRate used for all lines, per-line override postponed to Phase 11.6

## Issues Encountered

[If per-line tax was complex] Per-line tax rate calculation required state restructuring - deferred to Phase 11.6 for proper persistence (quoteItems.taxRate column). UI uses global quote.taxRate for now.

## Next Step

Phase 11.5 complete - Service catalog fully functional. Ready to proceed with Phase 12 (Tasks Chronométrées) or return to Phase 11 remaining plans if any.

## Phase 11.5 Complete Summary

**Total implementation:** 3 plans, 8 tasks, ~105-130 minutes
- ✅ Backend infrastructure (database + tRPC)
- ✅ Service catalog management page (CRUD UI)
- ✅ Quote builder integration (autocomplete + modal)

**Business value:** Studios can now create quotes 3-5x faster by selecting pre-defined services instead of manually filling every line item. Catalog ensures pricing consistency and reduces data entry errors.
</output>
