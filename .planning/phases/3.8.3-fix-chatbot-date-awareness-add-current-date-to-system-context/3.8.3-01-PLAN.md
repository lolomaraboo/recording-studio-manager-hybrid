---
phase: 3.8.3-fix-chatbot-date-awareness-add-current-date-to-system-context
plan: 01
type: execute
---

<objective>
Add current date to chatbot system context so AI assistant knows today's date for scheduling and time-sensitive queries.

Purpose: Fix UX issue where chatbot cannot answer "schedule for tomorrow", "this week", or provide date-aware responses.
Output: Working chatbot that understands current date, validated in production with date-aware test queries.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3.8.2-persist-chatbot-sessionid-in-localstorage/3.8.2-01-SUMMARY.md

**User request context:**
User reported: "le chatbot ne connait pas la date"

**Current behavior:**
- SYSTEM_PROMPT in aiSystemPrompt.ts is static constant
- AI has no awareness of current date
- Cannot answer queries like "tomorrow", "this week", "next Monday"
- Cannot help with scheduling or time-sensitive tasks

**Desired behavior:**
- Chatbot knows current date when responding
- Can answer relative date queries ("tomorrow", "next week")
- Can help schedule sessions with date context

**Prior decisions affecting this phase:**
- Phase 3.8.1 established sessionId management pattern
- Phase 3.8.2 added localStorage persistence
- Phase 3.7 established Docker rebuild deployment pattern

**Files to modify:**
@packages/server/src/lib/aiSystemPrompt.ts
@packages/server/src/routers/ai.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add current date to system prompt</name>
  <files>packages/server/src/lib/aiSystemPrompt.ts, packages/server/src/routers/ai.ts</files>
  <action>
    Modify aiSystemPrompt.ts to inject current date dynamically:

    1. **Change from constant to function** (aiSystemPrompt.ts):
       - Change `export const SYSTEM_PROMPT = \`...\`` to `export function getSystemPrompt(): string`
       - At the beginning of the template string, add date context:
         ```
         Aujourd'hui nous sommes le ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.
         ```
       - Return the template string from the function

    2. **Update import and usage** (ai.ts around line 85):
       - Change import: `import { getSystemPrompt } from "../lib/aiSystemPrompt";`
       - Change usage: `systemPrompt: getSystemPrompt()` (add function call)

    **What to include in date context:**
    - Full date format: "lundi 29 décembre 2025"
    - This gives AI complete temporal context for relative queries

    **What NOT to do:**
    - Don't add timezone complexity (use server local time is fine)
    - Don't add time of day (date is sufficient for scheduling queries)
    - Don't modify any anti-hallucination rules (preserve existing SYSTEM_PROMPT content exactly)

    **Important notes:**
    - Preserve all existing SYSTEM_PROMPT content
    - Only add date line at the very beginning before existing text
    - Use French locale for date formatting (fr-FR) to match system prompt language
    - Function is called on every chat request, so date is always current
  </action>
  <verify>
    - TypeScript compilation succeeds: `pnpm --filter @rsm/server build`
    - No ESLint errors introduced
    - Code diff shows exactly 2 changes: getSystemPrompt function in aiSystemPrompt.ts, function call in ai.ts
  </verify>
  <done>
    - SYSTEM_PROMPT converted to getSystemPrompt() function
    - Current date injected at beginning of prompt
    - ai.ts updated to call getSystemPrompt()
    - Build succeeds without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy fix to production</name>
  <files>packages/server/src/lib/aiSystemPrompt.ts, packages/server/src/routers/ai.ts</files>
  <action>
    Deploy the date awareness fix to production using Docker rebuild workflow (established in Phase 3.8.1):

    1. **Transfer source files to VPS**:
       ```bash
       rsync -avz \
         packages/server/src/lib/aiSystemPrompt.ts \
         packages/server/src/routers/ai.ts \
         vps-n8n:/root/recording-studio-manager-hybrid/packages/server/src/lib/ \
         vps-n8n:/root/recording-studio-manager-hybrid/packages/server/src/routers/
       ```

    2. **Rebuild server Docker image**:
       ```bash
       ssh vps-n8n "cd /root/recording-studio-manager-hybrid && docker-compose build server --no-cache"
       ```

    3. **Restart server container**:
       ```bash
       ssh vps-n8n "cd /root/recording-studio-manager-hybrid && docker-compose up -d server"
       ```

    4. **Verify deployment**:
       ```bash
       curl -I https://recording-studio-manager.com/api/health
       ```
       Expected: HTTP 200, no errors

    **Deployment pattern from Phase 3.8.1:**
    Server container builds from source (tsx runtime, no build step), so rsync source files, rebuild Docker image, and restart container.

    **What NOT to do:**
    - Don't try to rsync dist/ folder (server uses tsx, no dist/)
    - Don't skip --no-cache flag (ensures fresh build with latest code)
    - Don't forget to restart container after rebuild
  </action>
  <verify>
    - Rsync transfer completes without errors for both files
    - Docker build succeeds (shows "Successfully built" message)
    - Container restart succeeds (docker ps shows rsm-server running)
    - curl returns HTTP 200
    - No server console errors on startup
  </verify>
  <done>
    - aiSystemPrompt.ts and ai.ts transferred to VPS
    - Server Docker image rebuilt with date awareness fix
    - Container restarted successfully
    - Production API accessible at https://recording-studio-manager.com
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Chatbot date awareness deployed to production</what-built>
  <how-to-verify>
    Test the chatbot's date awareness with time-sensitive queries:

    1. **Navigate to production dashboard**:
       - Visit: https://recording-studio-manager.com/dashboard
       - Log in if needed (test-validation-1766731401390@recording-studio-manager.com)

    2. **Open AI chatbot** (floating window on right side)

    3. **Test query 1 - Direct date question**:
       - Send message: "Quelle est la date aujourd'hui ?"
       - Expected: ✅ Chatbot responds with current date (e.g., "Aujourd'hui nous sommes le lundi 29 décembre 2025")
       - FAILURE if: ❌ Chatbot says "Je ne sais pas" or gives wrong date

    4. **Test query 2 - Relative date understanding**:
       - Send message: "Peux-tu me dire quel jour on sera demain ?"
       - Expected: ✅ Chatbot calculates correctly (e.g., "Demain nous serons le mardi 30 décembre 2025")
       - FAILURE if: ❌ Chatbot cannot calculate or gives wrong day

    5. **Test query 3 - Scheduling context**:
       - Send message: "Je veux planifier une session pour la semaine prochaine"
       - Expected: ✅ Chatbot understands "semaine prochaine" in context of current date
       - FAILURE if: ❌ Chatbot asks "quelle semaine ?" or shows no date awareness

    6. **Verify in server logs** (optional but recommended):
       - SSH to VPS: `ssh vps-n8n`
       - Check logs: `docker logs rsm-server --tail 50`
       - Confirm: getSystemPrompt() called successfully, no errors

    **Success criteria:**
    - Test 1 passes: Chatbot knows current date
    - Test 2 passes: Chatbot can calculate relative dates (tomorrow, next week)
    - Test 3 passes: Chatbot uses date context for scheduling queries
    - No "Je ne sais pas" responses about dates
    - Server logs show no errors related to system prompt
  </how-to-verify>
  <resume-signal>Type "approved" if chatbot demonstrates date awareness, or describe the date awareness failure if tests don't pass</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] aiSystemPrompt.ts exports getSystemPrompt() function with date
- [ ] ai.ts calls getSystemPrompt() instead of using constant
- [ ] Server builds without TypeScript errors
- [ ] Deployed to production successfully
- [ ] Chatbot responds to date queries accurately (3-query test passes)
- [ ] No server console errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Chatbot demonstrates date awareness in production
- Phase 3.8.3 complete - chatbot can now handle time-sensitive queries
- No errors or regressions introduced
</success_criteria>

<output>
After completion, create `.planning/phases/3.8.3-fix-chatbot-date-awareness-add-current-date-to-system-context/3.8.3-01-SUMMARY.md`:

# Phase 3.8.3 Plan 1: Fix Chatbot Date Awareness Summary

**Chatbot now knows current date - can answer time-sensitive queries and scheduling requests**

## Accomplishments

- Converted SYSTEM_PROMPT from static constant to dynamic function
- Current date injected at beginning of system prompt (French locale)
- ai.ts updated to call getSystemPrompt() function
- Deployed fix to production
- Validated date awareness with 3-query test

## Files Modified

- `packages/server/src/lib/aiSystemPrompt.ts` - Converted to getSystemPrompt() function with date injection
- `packages/server/src/routers/ai.ts` - Updated to call getSystemPrompt() instead of using constant

## Date Context Implementation Details

**Changes made:**

```typescript
// Before: Static constant
export const SYSTEM_PROMPT = `Tu es un assistant IA...`;

// After: Dynamic function with date
export function getSystemPrompt(): string {
  return `Aujourd'hui nous sommes le ${new Date().toLocaleDateString('fr-FR', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })}.

Tu es un assistant IA expert pour la gestion de studio d'enregistrement...`;
}
```

**Key benefits:**
- Simple, minimal code (function wrapper + date injection)
- No dependencies required
- Date always current (function called on every request)
- French locale matches system prompt language

## Production Validation

**3-Query Date Awareness Test:**

1. **Query 1:** "Quelle est la date aujourd'hui ?" → ✅ "[Current date in French]"
2. **Query 2:** "Quel jour on sera demain ?" → ✅ Correct calculation (tomorrow's date)
3. **Query 3:** "Planifier session semaine prochaine" → ✅ Date-aware scheduling response

**Verification:**
- Server logs: getSystemPrompt() called successfully
- No errors in console
- Date format correct: "lundi 29 décembre 2025" (example)

## Deployment Process

Followed Phase 3.8.1 Docker rebuild workflow:
1. Transfer source: `rsync aiSystemPrompt.ts + ai.ts vps-n8n:/root/.../packages/server/src/`
2. Rebuild image: `docker-compose build server --no-cache`
3. Restart container: `docker-compose up -d server`
4. Verify: `curl -I https://recording-studio-manager.com/api/health` → HTTP 200

## Issues Encountered

[None OR describe any deployment/testing issues]

## Next Step

Phase 3.8.3 complete - chatbot now date-aware for scheduling queries.

**Phase 3.8 series fully complete:**
- Phase 3.8: Memory verification (10-turn test) ✅
- Phase 3.8.1: SessionId state management ✅
- Phase 3.8.2: LocalStorage persistence ✅
- Phase 3.8.3: Date awareness ✅

**Chatbot is production-ready for marketing launch (Phase 4)** with full conversation memory, page refresh persistence, AND date awareness for scheduling.

---
*Phase: 3.8.3-fix-chatbot-date-awareness-add-current-date-to-system-context*
*Completed: [Date]*
</output>
