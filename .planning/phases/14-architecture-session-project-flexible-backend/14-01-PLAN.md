---
phase: 14-architecture-session-project-flexible-backend
plan: 01
type: execute
---

<objective>
Enable sessions to optionally link to projects by adding nullable projectId foreign key to sessions table, maintaining full backward compatibility with existing standalone sessions.

Purpose: Provide studios flexibility to organize sessions independently OR within project context (e.g., album recording sessions grouped under project).
Output: Database schema updated, migration created, tRPC router enhanced, backward compatibility validated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase Context:**
- Phase 13 complete: Time tracking supports sessions, projects, AND tracks (trackId architecture)
- Current architecture: Sessions standalone (no projectId), projects exist separately
- Goal: Add OPTIONAL link from session → project (many-to-one relationship)
- Backward compatibility critical: All existing sessions remain valid (projectId = NULL)

**Current Schema:**
- `sessions` table: clientId (NOT NULL), roomId (NOT NULL), no projectId
- `projects` table: clientId (NOT NULL), has many tracks
- `tracks` table: projectId (NOT NULL) - must belong to project
- `time_entries` table: sessionId | projectId | trackId (XOR constraint from Phase 13)

**Technical Context:**
- Database: PostgreSQL with Drizzle ORM
- Migration pattern: Manual SQL files in `drizzle/migrations/tenant/`
- Router: `packages/server/src/routers/sessions.ts` (create/update endpoints)
- Schema: `packages/database/src/tenant/schema.ts`

**Prior Decisions:**
- Phase 13: Multi-context time tracking (XOR sessionId/projectId/trackId)
- Database-per-tenant architecture (each org has own PostgreSQL DB)
- Nullable FK pattern for optional relationships (established pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add projectId to sessions schema</name>
  <files>packages/database/src/tenant/schema.ts</files>
  <action>
Add `projectId` nullable integer column to `sessions` table definition (around line 142 after roomId):

```typescript
projectId: integer("project_id").references(() => projects.id, { onDelete: "set null" }),
```

Add relation to `sessionsRelations` (create if not exists) for Drizzle query API:

```typescript
export const sessionsRelations = relations(sessions, ({ one }) => ({
  client: one(clients, {
    fields: [sessions.clientId],
    references: [clients.id],
  }),
  room: one(rooms, {
    fields: [sessions.roomId],
    references: [rooms.id],
  }),
  project: one(projects, {
    fields: [sessions.projectId],
    references: [projects.id],
  }),
}));
```

Also add reverse relation to `projectsRelations` (should exist around line 998):

```typescript
sessions: many(sessions),
```

Rationale: Nullable FK allows optional session-project linkage. ON DELETE SET NULL prevents cascading deletes (session survives project deletion). Relations enable type-safe queries.
  </action>
  <verify>TypeScript compiles: `pnpm --filter database check` (0 errors)</verify>
  <done>projectId column added to sessions, relations defined, TypeScript valid</done>
</task>

<task type="auto">
  <name>Task 2: Create database migration for projectId</name>
  <files>packages/database/drizzle/migrations/tenant/0008_add_project_id_to_sessions.sql</files>
  <action>
Create new migration file `0008_add_project_id_to_sessions.sql` with:

```sql
-- Add project_id column to sessions table (nullable - optional project linkage)
ALTER TABLE "sessions" ADD COLUMN "project_id" integer;

-- Add foreign key constraint with SET NULL on delete (sessions survive project deletion)
ALTER TABLE "sessions" ADD CONSTRAINT "sessions_project_id_projects_id_fk"
  FOREIGN KEY ("project_id") REFERENCES "public"."projects"("id") ON DELETE set null ON UPDATE no action;

-- Add index for query performance (common to filter sessions by project)
CREATE INDEX IF NOT EXISTS "sessions_project_id_idx" ON "sessions" ("project_id");
```

Rationale: Manual migration (not drizzle-kit generate) for tenant-only schema changes. Index improves performance for "get all sessions in project" queries. SET NULL ensures backward compatibility.
  </action>
  <verify>Migration file exists, SQL syntax valid (no postgres errors when applied)</verify>
  <done>Migration file created with ALTER TABLE, FK constraint, and index</done>
</task>

<task type="auto">
  <name>Task 3: Update sessions tRPC router for projectId</name>
  <files>packages/server/src/routers/sessions.ts</files>
  <action>
Update `create` mutation input schema (around line 73) to accept optional projectId:

```typescript
projectId: z.number().optional(),
```

Add to `.values()` in create mutation (around line 96):

```typescript
projectId: input.projectId,
```

Update `update` mutation input schema (around line 119) to accept optional projectId:

```typescript
projectId: z.number().optional(),
```

Rationale: Optional field allows sessions to be created/updated with OR without project link. Backward compatible - existing code not passing projectId continues working (NULL value).
  </action>
  <verify>
- TypeScript compiles: `pnpm --filter server check` (0 errors)
- API accepts projectId: Create session with `projectId: 1` returns success
- API accepts no projectId: Create session without projectId returns success (projectId = NULL in DB)
  </verify>
  <done>Sessions router accepts optional projectId in create/update, backward compatible</done>
</task>

<task type="auto">
  <name>Task 4: Validation & backward compatibility testing</name>
  <files>N/A (testing only)</files>
  <action>
Verify backward compatibility and new functionality:

1. **TypeScript validation:**
   - Run `pnpm check` (all packages) - expect 0 errors
   - Confirm sessions.projectId type is `number | null`

2. **Schema validation:**
   - Confirm `sessions` table has projectId column (nullable)
   - Confirm FK constraint exists: sessions.projectId → projects.id
   - Confirm ON DELETE SET NULL behavior (sessions survive project deletion)

3. **Logical validation:**
   - Existing sessions workflow unchanged (no breaking changes)
   - Sessions can be created WITHOUT projectId (standalone sessions)
   - Sessions can be created WITH projectId (project-linked sessions)
   - Sessions can be updated to add/remove/change projectId

4. **Migration readiness:**
   - Migration file exists at correct path
   - Migration is idempotent (can run multiple times safely)
   - Existing sessions will have projectId = NULL after migration

Document validation results in commit message.
  </action>
  <verify>
- `pnpm check` passes (0 TypeScript errors across all packages)
- Schema changes compile successfully
- Migration file syntax valid
- Backward compatibility confirmed (no breaking changes)
  </verify>
  <done>Phase 14-01 validated: sessions support optional project linkage, full backward compatibility maintained</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm check` passes with 0 errors
- [ ] Migration file created at `drizzle/migrations/tenant/0008_add_project_id_to_sessions.sql`
- [ ] sessions.ts router updated with optional projectId
- [ ] Schema has projectId nullable column with FK constraint
- [ ] Relations defined for sessions ↔ projects
- [ ] No breaking changes to existing sessions functionality
</verification>

<success_criteria>
- All tasks completed
- TypeScript compiles without errors
- Migration file ready to apply
- Sessions can be created with OR without projectId
- Existing sessions remain valid (projectId = NULL)
- Backend ready for Phase 15 (UI adaptation)
</success_criteria>

<output>
After completion, create `.planning/phases/14-architecture-session-project-flexible-backend/14-01-SUMMARY.md`:

# Phase 14-01: Architecture Session/Project Flexible - Backend

**[One-liner: What shipped - backend support for optional session-project linkage]**

## Accomplishments

- Added projectId nullable column to sessions table
- Created migration 0008 with FK constraint and index
- Updated sessions tRPC router (create/update accept optional projectId)
- Validated backward compatibility (existing sessions unaffected)

## Files Created/Modified

- `packages/database/src/tenant/schema.ts` - Added projectId column + relations
- `packages/database/drizzle/migrations/tenant/0008_add_project_id_to_sessions.sql` - Migration file
- `packages/server/src/routers/sessions.ts` - Optional projectId in create/update

## Decisions Made

**Decision: Nullable FK with SET NULL on delete**
**Rationale:** Sessions should survive project deletion (session data remains valid even if project archived). SET NULL prevents cascading deletes while maintaining data integrity.

**Decision: Index on sessions.project_id**
**Rationale:** Common query pattern "get all sessions for project" requires efficient filtering. Index improves performance for project detail pages showing linked sessions.

**Decision: Optional field (not required)**
**Rationale:** Studios use sessions in multiple ways - some organize by project (album recording), others track standalone sessions (hourly bookings). Optional field supports both workflows.

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 14-01 complete. Backend ready for Phase 15 (Architecture Session/Project Flexible - UI Adaptation).

**Migration Note:** Migration 0008 must be applied to all tenant databases before using projectId feature in production. Auto-applies on first deploy OR manual application via `pnpm db:migrate`.
</output>
