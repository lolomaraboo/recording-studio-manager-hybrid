---
phase: 18.1-fix-database-initialization
plan: 02
type: execute
---

<objective>
Migrate VPS production data from Docker PostgreSQL to Native PostgreSQL, adding Phase 10-17 tables.

Purpose: Simplify production architecture by removing Docker overhead for database, synchronize with Phase 17 schema.
Output: VPS native PostgreSQL with all production data + updated schema (7 master + 30 tenant tables), application running on native DB.
</objective>

<context>
@.planning/PROJECT.md
@.planning/DATABASE-INVENTORY.md
@.planning/MIGRATION-DOCKER-TO-NATIVE.md
@.planning/phases/18.1-fix-database-initialization/18.1-01-SUMMARY.md

**Current VPS State:**
- Native PostgreSQL 16 installed and running (systemd active)
- Docker rsm-postgres has production data (6 master + 24 tenant tables)
- 13 tenant databases: tenant_2, 3, 7-12, org_1, org_3, org_6, superadmin
- Application currently connected to Docker PostgreSQL

**Goal:**
Migrate all Docker data to native PostgreSQL, apply Phase 10-17 migrations, switch application to use native.
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>VPS production database backup created and validated</what-built>
  <how-to-verify>
I will create a complete backup of VPS Docker PostgreSQL before any changes.

**Backup command (I'll run):**
```bash
ssh root@recording-studio-manager.com "docker exec rsm-postgres pg_dumpall -U postgres > /root/backup_docker_$(date +%Y%m%d_%H%M%S).sql"
```

**Verify backup size:**
```bash
ssh root@recording-studio-manager.com "ls -lh /root/backup_docker_*.sql"
# Should be several MB (not 0 bytes)
```

**Verify backup contains data:**
```bash
ssh root@recording-studio-manager.com "head -50 /root/backup_docker_*.sql"
# Should show CREATE DATABASE statements
```

**Please verify:**
1. Backup file exists and has reasonable size (>1MB)
2. Contains CREATE DATABASE and CREATE TABLE statements
3. You're comfortable proceeding with migration

Type "approved" when ready to continue.
  </how-to-verify>
  <resume-signal>Type "approved" after verifying backup is valid</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Stop VPS application to prevent writes during migration</name>
  <files>VPS docker-compose services</files>
  <action>Stop server and client containers to prevent database writes during migration.

**Stop application containers:**
```bash
ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid && docker-compose stop server client"
```

**Verify stopped:**
```bash
ssh root@recording-studio-manager.com "docker ps --filter 'name=rsm-server' --filter 'name=rsm-client'"
# Should show: no containers (or STATUS = Exited)
```

**Keep rsm-postgres running** for data export:
```bash
ssh root@recording-studio-manager.com "docker ps --filter 'name=rsm-postgres'"
# Should show: rsm-postgres still Up
```

Note: Site will be DOWN during migration (15-30 minutes estimated). No production customers yet, acceptable downtime.
  </action>
  <verify>rsm-server and rsm-client containers stopped, rsm-postgres still running</verify>
  <done>Application stopped, database available for export</done>
</task>

<task type="auto">
  <name>Task 2: Export all Docker PostgreSQL databases</name>
  <files>/root/postgres_docker_export_[timestamp].sql</files>
  <action>Dump all databases from Docker PostgreSQL container.

**Create timestamped export:**
```bash
ssh root@recording-studio-manager.com "docker exec rsm-postgres pg_dumpall -U postgres > /root/postgres_docker_export_$(date +%Y%m%d_%H%M%S).sql"
```

**Verify export size:**
```bash
ssh root@recording-studio-manager.com "ls -lh /root/postgres_docker_export_*.sql | tail -1"
# Should show file size (expect 5-50MB depending on data)
```

**Verify export contents:**
```bash
ssh root@recording-studio-manager.com "grep -c 'CREATE DATABASE' /root/postgres_docker_export_*.sql | tail -1"
# Should show: 13+ (one line per tenant database + rsm_master)

ssh root@recording-studio-manager.com "grep -c 'CREATE TABLE' /root/postgres_docker_export_*.sql | tail -1"
# Should show: 200+ (all master + tenant tables across all DBs)
```

Export includes:
- rsm_master with 6 tables
- All 13 tenant databases with 24 tables each
- All data, users, permissions
  </action>
  <verify>Export file exists, contains CREATE DATABASE and CREATE TABLE statements for all databases</verify>
  <done>Complete database dump exported from Docker PostgreSQL</done>
</task>

<task type="auto">
  <name>Task 3: Import data into native PostgreSQL</name>
  <files>VPS native PostgreSQL databases</files>
  <action>Import Docker export into native PostgreSQL.

**Import to native PostgreSQL:**
```bash
ssh root@recording-studio-manager.com "sudo -u postgres psql < /root/postgres_docker_export_*.sql"
```

**Verify import success:**

1. **Check databases created:**
```bash
ssh root@recording-studio-manager.com "sudo -u postgres psql -l | grep -E '(rsm_|tenant_)'"
# Should show: rsm_master + 13 tenant databases
```

2. **Verify rsm_master tables:**
```bash
ssh root@recording-studio-manager.com "sudo -u postgres psql -d rsm_master -c '\dt' | grep -c 'public |'"
# Should show: 6 (organizations, users, tenant_databases, invitations, organization_members, subscription_plans)
```

3. **Verify tenant data (sample tenant_2):**
```bash
ssh root@recording-studio-manager.com "sudo -u postgres psql -d tenant_2 -c '\dt' | grep -c 'public |'"
# Should show: 24 (all tenant tables)

ssh root@recording-studio-manager.com "sudo -u postgres psql -d tenant_2 -c 'SELECT COUNT(*) FROM clients;'"
# Should show: number of clients (data preserved)
```

If import fails:
- Check PostgreSQL logs: `journalctl -u postgresql -n 100`
- Common issue: Role/user conflicts (safe to ignore role creation errors if users already exist)
- Data should still import successfully even with role warnings
  </action>
  <verify>All databases imported to native PostgreSQL, table counts match Docker, sample data queries work</verify>
  <done>Production data successfully imported into VPS native PostgreSQL</done>
</task>

<task type="auto">
  <name>Task 4: Apply Phase 10-17 migrations to native PostgreSQL</name>
  <files>VPS native PostgreSQL master and tenant databases</files>
  <action>Apply new migrations generated in Plan 18.1-01 to add missing tables.

**Upload migration files to VPS:**
```bash
# From local machine
cd packages/database
rsync -av drizzle/migrations/ root@recording-studio-manager.com:/var/www/recording-studio-manager-hybrid/packages/database/drizzle/migrations/
```

**Apply master migration (adds ai_credits table):**
```bash
ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid/packages/database && DATABASE_URL='postgresql://postgres:password@localhost:5432/rsm_master' pnpm db:migrate"
```

**Verify ai_credits table added:**
```bash
ssh root@recording-studio-manager.com "sudo -u postgres psql -d rsm_master -c '\dt' | grep ai_credits"
# Should show: ai_credits table

ssh root@recording-studio-manager.com "sudo -u postgres psql -d rsm_master -c '\dt' | grep -c 'public |'"
# Should show: 7 (was 6, now 7)
```

**Apply tenant migrations to ALL tenant databases:**

For each tenant database, run migration:
```bash
for TENANT in tenant_2 tenant_3 tenant_7 tenant_8 tenant_9 tenant_10 tenant_11 tenant_12 tenant_org_1 tenant_org_3 tenant_org_6 tenant_superadmin
do
  echo "Migrating $TENANT..."
  ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid/packages/database && DATABASE_URL='postgresql://postgres:password@localhost:5432/$TENANT' pnpm db:migrate"
done
```

**Verify tenant tables added (sample tenant_2):**
```bash
ssh root@recording-studio-manager.com "sudo -u postgres psql -d tenant_2 -c '\dt' | grep -c 'public |'"
# Should show: 30 (was 24, added 6: client_contacts, service_catalog, stripe_webhook_events, task_types, time_entries, track_comments)
```
  </action>
  <verify>rsm_master has 7 tables (ai_credits added), all tenant DBs have 30 tables (6 new tables added), migrations applied cleanly</verify>
  <done>Phase 10-17 tables added to VPS native PostgreSQL, schema fully synchronized</done>
</task>

<task type="auto">
  <name>Task 5: Update application configuration to use native PostgreSQL</name>
  <files>/var/www/recording-studio-manager-hybrid/docker-compose.yml</files>
  <action>Change DATABASE_URL from Docker container to localhost native PostgreSQL.

**Update docker-compose.yml:**

BEFORE:
```yaml
server:
  environment:
    - DATABASE_URL=postgresql://postgres:password@rsm-postgres:5432/rsm_master
```

AFTER:
```yaml
server:
  environment:
    - DATABASE_URL=postgresql://postgres:password@localhost:5432/rsm_master
  network_mode: host  # Allow container to access host's PostgreSQL
```

**Apply change via SSH:**
```bash
ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid && sed -i 's|@rsm-postgres:|@localhost:|g' docker-compose.yml && echo 'network_mode: host' >> docker-compose.yml"
```

**Verify change:**
```bash
ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid && grep DATABASE_URL docker-compose.yml"
# Should show: @localhost:5432

ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid && grep network_mode docker-compose.yml"
# Should show: network_mode: host
```

Alternative approach: Create .env file with DATABASE_URL instead of hardcoding in docker-compose.yml (more flexible).
  </action>
  <verify>docker-compose.yml updated with localhost DATABASE_URL, network_mode host configured</verify>
  <done>Application configured to use VPS native PostgreSQL instead of Docker</done>
</task>

<task type="auto">
  <name>Task 6: Restart application and verify connectivity</name>
  <files>None (command execution)</files>
  <action>Start application containers and test connection to native PostgreSQL.

**Start application:**
```bash
ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid && docker-compose up -d server client"
```

**Wait for startup (30 seconds):**
```bash
sleep 30
```

**Verify containers running:**
```bash
ssh root@recording-studio-manager.com "docker ps --filter 'name=rsm-server' --filter 'name=rsm-client'"
# Should show: rsm-server and rsm-client Up
```

**Check server logs for database connection:**
```bash
ssh root@recording-studio-manager.com "docker logs rsm-server 2>&1 | tail -20 | grep -E '(Connected|database|PostgreSQL|error)'"
# Should show: successful connection, no "ECONNREFUSED" or "connection refused" errors
```

**Test API health endpoint:**
```bash
curl https://recording-studio-manager.com/api/health
# Should return: {"status":"ok"}
```

If connection fails:
- Check PostgreSQL is accepting connections: `sudo -u postgres psql -l`
- Check pg_hba.conf allows localhost connections
- Verify network_mode: host allows container→host communication
  </action>
  <verify>Application starts successfully, connects to native PostgreSQL, health check passes, no database errors in logs</verify>
  <done>Application running on VPS native PostgreSQL, site accessible</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>VPS application migrated to native PostgreSQL and fully functional</what-built>
  <how-to-verify>
I've migrated the VPS production database from Docker to native PostgreSQL.

**Please verify the following:**

1. **Site is accessible:**
   - Visit https://recording-studio-manager.com
   - Should load without errors

2. **Test login:**
   - Try logging in with existing test account
   - Should work normally

3. **Test basic features:**
   - Navigate to dashboard
   - Check clients list (data should be intact)
   - Try creating a test item (new client, session, etc.)

4. **Check for errors:**
   - Open browser console (F12)
   - Should see no database connection errors
   - API calls should return 200 OK

**If anything fails:**
- I can rollback to Docker PostgreSQL immediately
- All Docker data preserved (not deleted yet)

Type "approved" if site works normally, or describe any issues found.
  </how-to-verify>
  <resume-signal>Type "approved" if migration successful, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] VPS Docker data backed up (2 copies: before migration + export file)
- [ ] All databases imported to VPS native PostgreSQL (13 tenant DBs + rsm_master)
- [ ] Phase 10-17 migrations applied (7 master + 30 tenant tables per DB)
- [ ] Application configuration updated (DATABASE_URL → localhost)
- [ ] Application connects successfully to native PostgreSQL
- [ ] Site accessible and functional (manual testing passed)
- [ ] No database errors in application logs
- [ ] Docker PostgreSQL container still running (rollback safety)
</verification>

<success_criteria>
- All tasks completed
- Production data migrated from Docker to native PostgreSQL
- Schema synchronized with Phase 17 (all tables present)
- Application running and functional on native database
- Site tested and verified working
- Rollback path available (Docker not deleted yet)
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-fix-database-initialization/18.1-02-SUMMARY.md`:

# Phase 18.1 Plan 02: VPS Migrated to Native PostgreSQL

**Production database migrated from Docker to native - architecture simplified**

## Accomplishments

- Backed up complete VPS Docker PostgreSQL (13 tenant DBs + master)
- Stopped application to prevent writes during migration
- Exported all Docker data (pg_dumpall)
- Imported to VPS native PostgreSQL successfully
- Applied Phase 10-17 migrations (added 7 missing tables)
- Updated application config (DATABASE_URL → localhost)
- Restarted application, verified functionality
- Site tested and working normally

## Files Created/Modified

- `/root/backup_docker_[timestamp].sql` - Pre-migration backup (safety)
- `/root/postgres_docker_export_[timestamp].sql` - Complete data export
- `docker-compose.yml` - Updated DATABASE_URL to localhost:5432
- VPS native PostgreSQL - Now has all production data + Phase 17 schema

## Decisions Made

- Kept Docker container running after migration - Provides instant rollback if issues found within 24-48h
- Used network_mode: host for container→host DB access - Simplest approach, avoids port mapping complexity
- Applied migrations to all 13 tenant DBs sequentially - Ensured consistency across all tenants

## Issues Encountered

[Document any issues during execution, or "None"]

## Next Step

Ready for 18.1-03: Cleanup Docker PostgreSQL containers (after 24-48h verification period)
</output>
