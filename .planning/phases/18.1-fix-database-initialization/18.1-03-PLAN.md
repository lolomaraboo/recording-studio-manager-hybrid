---
phase: 18.1-fix-database-initialization
plan: 03
type: execute
---

<objective>
Remove Docker PostgreSQL containers and cleanup architecture after successful migration to native.

Purpose: Complete architecture simplification by removing redundant Docker PostgreSQL containers.
Output: Clean architecture with only native PostgreSQL (local + VPS), Docker containers removed, documentation updated.
</objective>

<context>
@.planning/DATABASE-INVENTORY.md
@.planning/MIGRATION-DOCKER-TO-NATIVE.md
@.planning/phases/18.1-fix-database-initialization/18.1-01-SUMMARY.md
@.planning/phases/18.1-fix-database-initialization/18.1-02-SUMMARY.md

**Prerequisites:**
- Plan 18.1-01 complete: Local native PostgreSQL working
- Plan 18.1-02 complete: VPS native PostgreSQL working
- Application tested for 24-48h on native PostgreSQL
- No database issues reported

**Goal:**
Remove Docker PostgreSQL containers safely, update configurations, finalize architecture.
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Confirm ready to remove Docker PostgreSQL permanently</decision>
  <context>
Before removing Docker PostgreSQL containers, we should confirm:

1. **Local native PostgreSQL working** - Dev environment stable for 24-48h
2. **VPS native PostgreSQL working** - Production site stable since migration
3. **No database errors** - Application logs clean
4. **Backups exist** - Can restore from backups if needed later

**What gets deleted:**
- Docker rsm-postgres containers (local + VPS)
- Docker volumes with PostgreSQL data
- Cannot undo without restoring from backup

**Safety:**
- Backups preserved: `/root/backup_docker_*.sql` (VPS) and local dumps
- Can recreate Docker containers if absolutely needed
- Native PostgreSQL has all data + latest schema
  </context>
  <options>
    <option id="proceed"><name>Proceed with cleanup</name><pros>Simplifies architecture, removes redundancy, completes migration</pros><cons>Docker containers gone (but data backed up)</cons></option>
    <option id="wait"><name>Wait 1 more week</name><pros>Extra confidence, more testing time</pros><cons>Delays Phase 18 completion, Docker containers waste resources</cons></option>
    <option id="keep-docker"><name>Keep Docker as backup</name><pros>Extra safety net</pros><cons>Wastes resources, confusing architecture, defeats purpose of migration</cons></option>
  </options>
  <resume-signal>Select: proceed, wait, or keep-docker</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Stop and remove local Docker PostgreSQL</name>
  <files>Local Docker containers and volumes</files>
  <action>Remove local Docker rsm-postgres container now that native PostgreSQL is working.

**Stop local Docker PostgreSQL:**
```bash
docker-compose stop rsm-postgres
```

**Remove container (preserves volume):**
```bash
docker-compose rm -f rsm-postgres
```

**Verify container removed:**
```bash
docker ps -a | grep rsm-postgres
# Should show: nothing (container deleted)
```

**Optional: Remove volume (permanent data deletion):**

Only if 100% confident:
```bash
docker volume ls | grep postgres
# Shows volume name (e.g., rsm-postgres-data)

docker volume rm [volume-name]
# CAUTION: Deletes all Docker PostgreSQL data permanently
```

Recommendation: **Keep volume for 1-2 weeks** as extra safety, then delete.

**Verify native PostgreSQL still working:**
```bash
psql -l | grep -E "(rsm_|tenant_)"
# Should show: native databases still there

DATABASE_URL="postgresql://localhost:5432/rsm_master" pnpm --filter server dev
# Should start normally
```
  </action>
  <verify>Docker rsm-postgres container removed, native PostgreSQL accessible, application can still start</verify>
  <done>Local Docker PostgreSQL removed, native is now sole database</done>
</task>

<task type="auto">
  <name>Task 2: Stop and remove VPS Docker PostgreSQL</name>
  <files>VPS Docker containers and volumes</files>
  <action>Remove VPS Docker rsm-postgres container now that native PostgreSQL is working.

**Stop VPS Docker PostgreSQL:**
```bash
ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid && docker-compose stop rsm-postgres"
```

**Remove container (preserves volume):**
```bash
ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid && docker-compose rm -f rsm-postgres"
```

**Verify container removed:**
```bash
ssh root@recording-studio-manager.com "docker ps -a | grep rsm-postgres"
# Should show: nothing
```

**Verify application still running:**
```bash
ssh root@recording-studio-manager.com "docker ps --filter 'name=rsm-server'"
# Should show: rsm-server still Up

curl https://recording-studio-manager.com/api/health
# Should return: {"status":"ok"}
```

**Optional: Remove volume later (after 2-4 weeks confidence):**
```bash
ssh root@recording-studio-manager.com "docker volume ls | grep postgres"
# Note volume name for future deletion

# Later, when 100% confident:
# ssh root@recording-studio-manager.com "docker volume rm [volume-name]"
```
  </action>
  <verify>VPS Docker rsm-postgres container removed, application still running and accessible, native PostgreSQL serving requests</verify>
  <done>VPS Docker PostgreSQL removed, production runs on native only</done>
</task>

<task type="auto">
  <name>Task 3: Update docker-compose.yml to remove PostgreSQL service</name>
  <files>docker-compose.yml (local + VPS)</files>
  <action>Clean up docker-compose.yml files by removing PostgreSQL service definition.

**Local docker-compose.yml:**

Remove entire rsm-postgres service block:
```yaml
# DELETE THIS SECTION:
rsm-postgres:
  image: postgres:16
  container_name: rsm-postgres
  environment:
    - POSTGRES_PASSWORD=password
  volumes:
    - postgres-data:/var/lib/postgresql/data
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U postgres"]
    interval: 10s
    timeout: 5s
    retries: 5
```

**VPS docker-compose.yml (via SSH):**

Same removal - delete rsm-postgres service block.

**Verify syntax:**
```bash
# Local
docker-compose config
# Should show: valid config without postgres service

# VPS
ssh root@recording-studio-manager.com "cd /var/www/recording-studio-manager-hybrid && docker-compose config"
# Should show: valid config without postgres service
```

**Commit changes:**
```bash
git add docker-compose.yml
git commit -m "chore(18.1): remove PostgreSQL from docker-compose

Migrated to native PostgreSQL (Plans 18.1-01 and 18.1-02).
Docker PostgreSQL no longer needed."

git push origin main
```
  </action>
  <verify>docker-compose.yml files updated (local + VPS), postgres service removed, configs valid, changes committed</verify>
  <done>Docker Compose configurations cleaned up, PostgreSQL service removed</done>
</task>

<task type="auto">
  <name>Task 4: Update documentation and finalize architecture</name>
  <files>.planning/DATABASE-INVENTORY.md, CLAUDE.md, README.md</files>
  <action>Update project documentation to reflect new native-only PostgreSQL architecture.

**Update .planning/DATABASE-INVENTORY.md:**

Mark final state:
```markdown
## Final Architecture (Post-Migration)

**Local Development:**
- ✅ PostgreSQL 17.7 (native, Homebrew)
- ✅ Connection: postgresql://localhost:5432/rsm_master
- ✅ Databases: rsm_master (7 tables) + tenant_1 (30 tables)
- ❌ Docker PostgreSQL: REMOVED

**VPS Production:**
- ✅ PostgreSQL 16 (native, systemd)
- ✅ Connection: postgresql://localhost:5432/rsm_master
- ✅ Databases: rsm_master (7 tables) + 13 tenant DBs (30 tables each)
- ❌ Docker PostgreSQL: REMOVED

**Benefits Achieved:**
- Simpler architecture (one PostgreSQL per environment)
- Better performance (no Docker I/O overhead)
- Easier debugging (direct psql access)
- Lower resource usage (~200MB RAM saved per environment)
```

**Update CLAUDE.md (if mentions Docker PostgreSQL):**

Search for Docker PostgreSQL references and update or remove.

**Update README.md development setup:**

BEFORE:
```markdown
## Development Setup

docker-compose up -d
```

AFTER:
```markdown
## Development Setup

**Prerequisites:**
- PostgreSQL 17+ installed locally (Homebrew: `brew install postgresql@17`)
- Service running: `brew services start postgresql@17`

**Start application:**
```bash
DATABASE_URL="postgresql://localhost:5432/rsm_master" pnpm dev
```
```

**Commit documentation updates:**
```bash
git add .planning/DATABASE-INVENTORY.md CLAUDE.md README.md
git commit -m "docs(18.1): update architecture docs - native PostgreSQL only

Phase 18.1 complete: Migrated from Docker to native PostgreSQL.

Architecture changes:
- Local: Native PostgreSQL 17 (Homebrew)
- VPS: Native PostgreSQL 16 (systemd)
- Docker PostgreSQL removed (both environments)

Benefits: Simpler, faster, less overhead, easier debugging."

git push origin main
```
  </action>
  <verify>Documentation updated to reflect native-only architecture, changes committed and pushed</verify>
  <done>Documentation finalized, Phase 18.1 architecture migration complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Local Docker PostgreSQL container removed
- [ ] VPS Docker PostgreSQL container removed
- [ ] Local native PostgreSQL working (verified via pnpm dev)
- [ ] VPS native PostgreSQL working (site accessible, no errors)
- [ ] docker-compose.yml updated (postgres service removed)
- [ ] Documentation updated (DATABASE-INVENTORY, CLAUDE, README)
- [ ] Changes committed and pushed to git
- [ ] Backup files preserved (/root/backup_docker_*.sql on VPS)
</verification>

<success_criteria>
- All Docker PostgreSQL containers removed (local + VPS)
- Native PostgreSQL is sole database infrastructure
- Documentation reflects new architecture
- Both environments tested and working
- Phase 18.1 complete - ready for Phase 18-02 manual testing
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-fix-database-initialization/18.1-03-SUMMARY.md`:

# Phase 18.1 Plan 03: Docker PostgreSQL Cleanup Complete

**Architecture simplified - Docker PostgreSQL removed, native-only setup finalized**

## Accomplishments

- Removed local Docker rsm-postgres container
- Removed VPS Docker rsm-postgres container
- Cleaned up docker-compose.yml (removed postgres service)
- Updated project documentation (DATABASE-INVENTORY, CLAUDE, README)
- Preserved backups for safety (VPS: /root/backup_docker_*.sql)
- Verified both environments working on native PostgreSQL

## Files Created/Modified

- `docker-compose.yml` - Removed rsm-postgres service (local + VPS)
- `.planning/DATABASE-INVENTORY.md` - Documented final architecture state
- `CLAUDE.md` - Updated database setup instructions
- `README.md` - Updated development setup (native PostgreSQL)

## Decisions Made

- Kept Docker volumes for 2-4 weeks - Extra safety before permanent deletion
- Preserved backup files indefinitely - Can restore Docker setup if ever needed
- Updated development workflow - Native PostgreSQL now standard approach

## Phase 18.1 Complete

**Accomplished:**
✅ Local native PostgreSQL fixed (Plan 18.1-01)
✅ VPS migrated Docker → Native (Plan 18.1-02)
✅ Docker cleanup complete (Plan 18.1-03)

**Result:**
- Native PostgreSQL only (local + VPS)
- All databases synchronized with Phase 17 schema (7 master + 30 tenant tables)
- Simpler architecture, better performance, easier debugging
- Phase 18-02 manual testing ready to proceed

## Next Step

Resume Phase 18-02: Execute Manual Tests with MCP Chrome DevTools
</output>
