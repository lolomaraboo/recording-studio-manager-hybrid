---
phase: 18.1-fix-database-initialization
plan: 01
type: execute
---

<objective>
Fix local native PostgreSQL database schema and generate missing migrations for Phase 10-17 tables.

Purpose: Synchronize local development database with TypeScript schema definitions, enabling Phase 18-02 testing.
Output: Working local PostgreSQL with all 7 master tables + clean tenant_1 with 30 tenant-only tables, plus generated migrations for deployment.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/DATABASE-INVENTORY.md
@.planning/MIGRATION-DOCKER-TO-NATIVE.md
@packages/database/src/master/schema.ts
@packages/database/src/tenant/schema.ts

**Discovery:**
- PostgreSQL 17.7 already installed locally via Homebrew (✅ Running)
- Path: `/opt/homebrew/opt/postgresql@17/bin/psql` (not in PATH)
- rsm_master: Has 5/7 tables (missing subscription_plans + ai_credits)
- tenant_1: CORRUPTED (29 tables mixing master + tenant tables)
- No migrations generated since Dec 15, 2025 (Phase 3)

**Goal:**
Fix local native PostgreSQL to match schema.ts definitions (7 master + 30 tenant tables separated).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PostgreSQL to PATH for easier access</name>
  <files>~/.zshrc or ~/.bash_profile</files>
  <action>Add PostgreSQL 17 bin directory to PATH to avoid typing full path every time.

**Check current shell:**
```bash
echo $SHELL
```

**Add to appropriate rc file:**

For zsh (~/.zshrc):
```bash
echo 'export PATH="/opt/homebrew/opt/postgresql@17/bin:$PATH"' >> ~/.zshrc
source ~/.zshrc
```

For bash (~/.bash_profile):
```bash
echo 'export PATH="/opt/homebrew/opt/postgresql@17/bin:$PATH"' >> ~/.bash_profile
source ~/.bash_profile
```

**Verify:**
```bash
which psql
# Should show: /opt/homebrew/opt/postgresql@17/bin/psql

psql --version
# Should show: psql (PostgreSQL) 17.7 (Homebrew)
```
  </action>
  <verify>psql command works without full path, shows version 17.7</verify>
  <done>PostgreSQL 17 bin directory added to PATH, psql accessible globally</done>
</task>

<task type="auto">
  <name>Task 2: Generate Drizzle migrations for Phase 10-17 schema changes</name>
  <files>packages/database/drizzle/migrations/master/0001_*.sql, packages/database/drizzle/migrations/tenant/0001_*.sql</files>
  <action>Generate migrations for all schema changes since Dec 15, 2025.

**Navigate to database package:**
```bash
cd packages/database
```

**Generate migrations:**
```bash
pnpm db:generate
```

**Handle interactive prompts:**
- If asked about column renames: Choose "create column" (new tables, not renames)
- Review generated SQL files in drizzle/migrations/

**Expected migrations:**

**Master migration (0001_*.sql) should add:**
- ai_credits table (id, organization_id, credits_remaining, credits_used_this_month, plan, last_recharge_at, next_recharge_at, created_at, updated_at)

**Tenant migration (0001_*.sql) should add:**
- client_contacts table (Phase 3.9)
- service_catalog table (Phase 11.5)
- stripe_webhook_events table (Phase 17)
- task_types table (Phase 12)
- time_entries table (Phase 13)
- track_comments table (Phase 5)

**Review generated SQL:**
```bash
cat drizzle/migrations/master/0001_*.sql
cat drizzle/migrations/tenant/0001_*.sql
```

Ensure no DROP TABLE or destructive operations (should only be CREATE TABLE and ALTER TABLE ADD COLUMN).
  </action>
  <verify>Migration files exist in drizzle/migrations/, contain CREATE TABLE statements for missing tables, no destructive operations</verify>
  <done>Migrations generated for master (ai_credits) and tenant (6 new tables), reviewed and safe</done>
</task>

<task type="auto">
  <name>Task 3: Apply master migrations to add missing tables</name>
  <files>Local rsm_master database</files>
  <action>Apply new master migration to add subscription_plans and ai_credits tables.

**Check current state:**
```bash
psql rsm_master -c "\dt" | grep -E "(subscription_plans|ai_credits)"
# Should show: nothing (both tables missing)
```

**Apply migrations:**
```bash
cd packages/database
DATABASE_URL="postgresql://localhost:5432/rsm_master" pnpm db:migrate
```

**Verify tables created:**
```bash
psql rsm_master -c "\dt" | grep -c "public |"
# Should show: 7 (was 5, now 7 after adding 2 tables)

psql rsm_master -c "\d subscription_plans"
# Should show: table structure with id, name, price, features, etc.

psql rsm_master -c "\d ai_credits"
# Should show: table structure with id, organization_id, credits_remaining, etc.
```

**Seed subscription_plans if empty:**
```bash
psql rsm_master -c "SELECT COUNT(*) FROM subscription_plans;"
# If 0, run seed script:
pnpm --filter database tsx src/scripts/seed-subscription-plans.ts
```
  </action>
  <verify>rsm_master has 7 tables total, subscription_plans and ai_credits exist with correct columns, subscription_plans seeded with 3 plans</verify>
  <done>Master database updated with missing tables, subscriptions seeded</done>
</task>

<task type="auto">
  <name>Task 4: Rebuild tenant_1 database with clean schema</name>
  <files>Local tenant_1 database</files>
  <action>Drop corrupted tenant_1 and recreate with proper tenant-only tables.

**Backup tenant_1 (optional, if has important data):**
```bash
pg_dump tenant_1 > /tmp/tenant_1_backup_$(date +%Y%m%d).sql
# Note: This backup has corrupted schema, but preserves data if needed
```

**Drop corrupted database:**
```bash
dropdb tenant_1
```

**Recreate empty database:**
```bash
createdb tenant_1
```

**Apply tenant migrations:**

Since tenant databases are created by the application via `createTenantDatabase()` function, we need to use the init script approach:

```bash
# Option A: Use application's tenant creation (recommended)
cd packages/database
DATABASE_URL="postgresql://localhost:5432/rsm_master" tsx src/scripts/create-tenant.ts tenant_1

# Option B: Manual SQL (if script doesn't exist, create tenant schema manually)
psql tenant_1 -f drizzle/migrations/tenant/0000_*.sql
psql tenant_1 -f drizzle/migrations/tenant/0001_*.sql
```

**Verify clean schema:**
```bash
psql tenant_1 -c "\dt" | grep -c "public |"
# Should show: 30 (all tenant tables)

psql tenant_1 -c "\dt" | grep -E "(users|organizations|invitations)"
# Should show: nothing (no master tables in tenant DB)

psql tenant_1 -c "\dt" | grep -E "(clients|sessions|invoices)"
# Should show: these tables (tenant-only tables present)
```
  </action>
  <verify>tenant_1 recreated with 30 tenant-only tables, no master tables present, schema clean</verify>
  <done>tenant_1 database rebuilt with proper tenant-only schema, corruption fixed</done>
</task>

<task type="auto">
  <name>Task 5: Test local application with fixed database</name>
  <files>None (command execution)</files>
  <action>Verify application can connect and function with fixed local database.

**Update .env or start script with correct DATABASE_URL:**

Check if using Docker connection string, update to native:

BEFORE (Docker):
```bash
DATABASE_URL="postgresql://postgres:password@rsm-postgres:5432/rsm_master"
```

AFTER (Native):
```bash
DATABASE_URL="postgresql://localhost:5432/rsm_master"
```

**Start development server:**
```bash
cd ../..  # Back to project root
DATABASE_URL="postgresql://localhost:5432/rsm_master" pnpm dev
```

**Test basic operations:**

1. **Backend health check:**
```bash
curl http://localhost:3001/health
# Should return: {"status":"ok"}
```

2. **Access frontend:**
- Open http://localhost:5174
- Check console for errors (should be clean)

3. **Test database connection:**
- Try logging in (if test account exists)
- OR register new account
- Verify no "database connection" errors

4. **Check tenant DB creation:**
```bash
psql -l | grep tenant_
# Should show tenant_1 (and possibly tenant_2 if new org created during test)
```

If any errors occur:
- Check server logs for PostgreSQL connection issues
- Verify DATABASE_URL is correct
- Ensure PostgreSQL service is running: `brew services list | grep postgres`

**Stop server after verification (Ctrl+C).**
  </action>
  <verify>Application starts without errors, can connect to database, frontend loads, no database connection errors in console</verify>
  <done>Local development environment working with native PostgreSQL, Phase 18-02 testing unblocked</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] PostgreSQL 17 accessible via `psql` command (in PATH)
- [ ] Migration files generated (master 0001 + tenant 0001)
- [ ] rsm_master has 7 tables (subscription_plans + ai_credits added)
- [ ] tenant_1 has 30 tenant-only tables (no master tables)
- [ ] Application can start and connect to local native PostgreSQL
- [ ] No "column does not exist" or schema errors in logs
- [ ] Frontend loads without database connection errors
</verification>

<success_criteria>
- All tasks completed
- Local native PostgreSQL fully synchronized with schema.ts
- Migrations generated and ready for VPS deployment (Plan 18.1-02)
- Phase 18-02 manual testing can proceed on local environment
- No blocking database errors
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-fix-database-initialization/18.1-01-SUMMARY.md`:

# Phase 18.1 Plan 01: Local Native PostgreSQL Fixed

**Local development database synchronized with Phase 17 schema - testing unblocked**

## Accomplishments

- Added PostgreSQL 17 to PATH for easier CLI access
- Generated Drizzle migrations for Phase 10-17 (master + tenant)
- Added missing tables to rsm_master (subscription_plans, ai_credits)
- Rebuilt tenant_1 with clean tenant-only schema (corruption fixed)
- Verified application connects to local native PostgreSQL
- Phase 18-02 testing ready to proceed

## Files Created/Modified

- `~/.zshrc` or `~/.bash_profile` - Added PostgreSQL to PATH
- `packages/database/drizzle/migrations/master/0001_*.sql` - Master migration (ai_credits table)
- `packages/database/drizzle/migrations/tenant/0001_*.sql` - Tenant migration (6 new tables)
- Local rsm_master database - 5 → 7 tables
- Local tenant_1 database - Rebuilt from scratch (29 corrupted → 30 clean)

## Decisions Made

- Kept PostgreSQL 17 (Homebrew) instead of downgrading to 16 - Compatibility tested, works fine with Drizzle
- Used application's tenant creation flow instead of manual SQL - Ensures consistency with prod deployment
- Regenerated tenant_1 from scratch instead of cleaning corruption - Faster and guaranteed clean schema

## Issues Encountered

[Document any issues during execution, or "None"]

## Next Step

Ready for 18.1-02: Migrate VPS Docker data to VPS Native PostgreSQL
</output>
