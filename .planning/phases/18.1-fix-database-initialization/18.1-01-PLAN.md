---
phase: 18.1-fix-database-initialization
plan: 01
type: execute
---

<objective>
Fix schema/migrations desynchronization preventing local database initialization and blocking Phase 18 testing.

Purpose: Sync master database schema, migrations, and init script to match TypeScript definitions - enable fresh database setup for testing.
Output: Working database initialization that creates all required columns, allowing Phase 18-02 testing to proceed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/database/src/master/schema.ts
@packages/database/drizzle/migrations/master/0000_massive_zodiak.sql
@packages/database/src/scripts/init.ts

**Problem Context:**
- BUG-001 (P0): Cannot initialize local database for testing
- TypeScript schema includes Stripe billing columns (stripe_customer_id, stripe_subscription_id, subscription_status, current_period_end, logo_url)
- Migration file (0000_massive_zodiak.sql) missing these columns in organizations table
- Init script (init.ts lines 119-140) also missing Stripe columns
- ai_credits table defined in schema.ts but missing from migration and init script
- Blocks all Phase 18 testing locally

**Root Cause:**
Schema drift - TypeScript schema.ts updated with Stripe billing features (Phase 3) but migrations and init script not updated.

**Current State:**
- schema.ts: ✅ Has Stripe columns + ai_credits table
- 0000_massive_zodiak.sql: ❌ Missing Stripe columns, missing ai_credits table
- init.ts: ❌ Missing Stripe columns, missing ai_credits table + subscription_plans table
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate new migration for missing columns and tables</name>
  <files>packages/database/drizzle/migrations/master/0001_*.sql</files>
  <action>Generate a new Drizzle migration to add missing columns and tables:

1. Run: `cd packages/database && pnpm db:generate` to create migration file
2. Verify generated migration includes:
   - ALTER TABLE organizations ADD COLUMN stripe_customer_id VARCHAR(255)
   - ALTER TABLE organizations ADD COLUMN stripe_subscription_id VARCHAR(255)
   - ALTER TABLE organizations ADD COLUMN subscription_status VARCHAR(50) DEFAULT 'trial'
   - ALTER TABLE organizations ADD COLUMN current_period_end TIMESTAMP
   - CREATE TABLE ai_credits (with all columns from schema.ts lines 139-159)
   - CREATE TABLE subscription_plans (if missing - lines 115-133)
3. If subscription_plans already exists in migration 0000, only add ai_credits table
4. Review generated SQL - ensure no data loss, proper defaults, nullable where appropriate</action>
  <verify>Generated migration file exists in drizzle/migrations/master/ with correct ALTER TABLE and CREATE TABLE statements</verify>
  <done>New migration file created, reviewed, contains all missing schema elements</done>
</task>

<task type="auto">
  <name>Task 2: Update init.ts to include Stripe columns and ai_credits table</name>
  <files>packages/database/src/scripts/init.ts</files>
  <action>Update createMasterSchema() function to match schema.ts:

**Organizations table (lines 119-140):**
Add missing columns after line 135 (trial_ends_at):
```sql
stripe_customer_id VARCHAR(255),
stripe_subscription_id VARCHAR(255),
subscription_status VARCHAR(50) DEFAULT 'trial',
current_period_end TIMESTAMP,
```

**Add ai_credits table after organizations table:**
```sql
await sql`
  CREATE TABLE IF NOT EXISTS ai_credits (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL UNIQUE REFERENCES organizations(id),
    credits_remaining INTEGER NOT NULL DEFAULT 0,
    credits_used_this_month INTEGER NOT NULL DEFAULT 0,
    plan VARCHAR(50) NOT NULL DEFAULT 'trial',
    last_recharge_at TIMESTAMP,
    next_recharge_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
  )
`;
```

**Add subscription_plans table if missing** (check if already exists in init.ts, if not add):
Full CREATE TABLE statement matching schema.ts lines 115-133.

Maintain existing table creation order and structure, just add missing elements.</action>
  <verify>init.ts creates all tables matching schema.ts - organizations has Stripe columns, ai_credits table exists, subscription_plans table exists</verify>
  <done>init.ts updated, all schema elements present, matches TypeScript definitions</done>
</task>

<task type="auto">
  <name>Task 3: Apply migration and test fresh database initialization</name>
  <files>None (command execution)</files>
  <action>Test database initialization end-to-end:

1. **Backup existing data if production** (skip if local dev):
   ```bash
   pg_dump rsm_master > rsm_master_backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **Drop and recreate master database for clean test**:
   ```bash
   dropdb rsm_master
   createdb rsm_master
   ```

3. **Apply all migrations** (0000 + new 0001):
   ```bash
   cd packages/database
   DATABASE_URL="postgresql://postgres:password@localhost:5432/rsm_master" pnpm db:migrate
   ```

4. **Run init script**:
   ```bash
   DATABASE_URL="postgresql://postgres:password@localhost:5432/rsm_master" pnpm db:init
   ```

5. **Verify tables created**:
   ```bash
   psql rsm_master -c "\d organizations" | grep -E "(stripe_|subscription_status|current_period_end)"
   psql rsm_master -c "\dt" | grep -E "(ai_credits|subscription_plans)"
   ```

6. **Verify test data**:
   ```bash
   psql rsm_master -c "SELECT id, name, stripe_customer_id, subscription_status FROM organizations;"
   psql rsm_master -c "SELECT COUNT(*) FROM ai_credits;"
   ```

7. **Test application can connect**:
   ```bash
   DATABASE_URL="postgresql://postgres:password@localhost:5432/rsm_master" pnpm --filter server dev
   # Let server start, then Ctrl+C
   ```

If any step fails, document error, analyze root cause, fix and retry.</action>
  <verify>Fresh database initialization completes without errors, all tables created with correct schema, application connects successfully</verify>
  <done>Database initialized from scratch, schema matches TypeScript definitions, test data created, application connectable</done>
</task>

<task type="auto">
  <name>Task 4: Document fix and update database setup guide</name>
  <files>packages/database/README.md, .planning/STATE.md</files>
  <action>Document the schema sync fix:

**Update packages/database/README.md** (or create if missing):
Add troubleshooting section:
```markdown
## Troubleshooting

### Schema Drift Issues

If you encounter "column does not exist" errors during database initialization:

1. Ensure migrations are up to date: `pnpm db:migrate`
2. Check schema.ts matches migrations: `ls drizzle/migrations/master/`
3. For fresh setup: `dropdb rsm_master && createdb rsm_master && pnpm db:migrate && pnpm db:init`

**Migration History:**
- 0000_massive_zodiak.sql: Initial master schema
- 0001_add_stripe_billing.sql: Added Stripe billing columns + ai_credits table (Phase 18.1)
```

**Update .planning/STATE.md Decisions section:**
Add decision entry:
```markdown
| 18.1 | Schema sync via migration generation | Generated migration 0001 to add missing Stripe columns (stripe_customer_id, stripe_subscription_id, subscription_status, current_period_end) to organizations table and create ai_credits table. Updated init.ts to match. Alternative (manual ALTER TABLE) rejected - Drizzle ORM migration ensures type safety and version control. |
```

**Update .planning/STATE.md Blockers section:**
Mark BUG-001 as RESOLVED:
```markdown
**Resolved in Phase 18.1:**
- ✅ BUG-001 (P0): Database initialization fixed - schema/migrations synchronized via migration 0001
```</action>
  <verify>README.md has troubleshooting section, STATE.md updated with decision and resolved blocker</verify>
  <done>Documentation updated, fix recorded in project history, future developers have guidance</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Migration 0001 generated and reviewed (correct ALTER TABLE + CREATE TABLE)
- [ ] init.ts updated to include all schema elements
- [ ] Fresh database initialization succeeds (dropdb → createdb → migrate → init)
- [ ] All tables created with correct columns (verified via psql \d)
- [ ] Test data seeded successfully (3 orgs, tenant DBs, ai_credits records)
- [ ] Application can connect to database
- [ ] Documentation updated (README.md troubleshooting + STATE.md decision)
</verification>

<success_criteria>

- All tasks completed
- Fresh database initialization works end-to-end without errors
- Schema matches TypeScript definitions exactly
- No "column does not exist" errors
- Phase 18-02 testing can proceed (database ready)
- BUG-001 resolved and documented
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-fix-database-initialization/18.1-01-SUMMARY.md`:

# Phase 18.1 Plan 01: Fix Database Initialization Summary

**Database schema/migrations synchronized - Phase 18 testing unblocked**

## Accomplishments

- Generated migration 0001 adding Stripe billing columns to organizations table
- Created ai_credits table via migration
- Updated init.ts to match schema.ts (Stripe columns + ai_credits table)
- Tested fresh database initialization end-to-end
- Verified application connectivity
- Documented fix in README.md and STATE.md

## Files Created/Modified

- `packages/database/drizzle/migrations/master/0001_add_stripe_billing.sql` - New migration
- `packages/database/src/scripts/init.ts` - Updated organizations CREATE TABLE + added ai_credits table
- `packages/database/README.md` - Added troubleshooting section
- `.planning/STATE.md` - Documented decision and resolved BUG-001

## Decisions Made

Used Drizzle ORM migration generation (`pnpm db:generate`) instead of manual SQL to ensure:
- Type safety between schema.ts and migrations
- Version control for schema changes
- Consistent migration format with existing 0000 migration

## Issues Encountered

[Document any issues during execution, or "None"]

## Next Step

Ready to resume Phase 18-02: Execute Manual Tests with MCP Chrome (database initialization blocker resolved)
</output>
