---
phase: 16-facturation-automatique-backend
plan: 1
type: execute
---

<objective>
Implémenter la génération automatique d'invoices depuis time_entries avec support per-session OU global project invoicing.

Purpose: Transformer le temps tracé (Phase 12-13) en factures automatiques, éliminant la saisie manuelle des line items et assurant la cohérence entre temps travaillé et facturation.

Output: Service backend de génération d'invoices + endpoints tRPC + linkage time_entries ↔ invoices
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase patterns:**
@.planning/phases/10-systeme-devis-backend/10-01-SUMMARY.md  # Financial calculation patterns
@.planning/phases/12-tasks-chronometrees-timer/12-02-SUMMARY.md  # Time tracking architecture

**Codebase context:**
@packages/database/src/tenant/schema.ts  # invoices, timeEntries, taskTypes schemas
@packages/server/src/routers/invoices.ts  # Existing invoice router
@packages/server/src/routers/client-portal-booking.ts  # Stripe Payment Intent patterns

**Key constraints from prior phases:**
- Invoice schema uses `subtotal`, `taxRate`, `taxAmount`, `total` (Phase 10 pattern)
- Time entries have `hourlyRateSnapshot` field (captures rate at tracking time)
- Time entries link flexibly: `sessionId` | `projectId` | `trackId` (Phase 13-14)
- Task types have `category: "billable" | "non-billable"` (breaks not invoiced)

**Architecture decisions:**
- Follow invoice generation pattern from quotes (Phase 10)
- Group time entries by taskType for line item consolidation
- Support 2 modes: per-session invoicing (single session) OR global project invoicing (all project entries)
- Auto-increment invoice numbers like quote numbers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add invoice generation logic from time entries</name>
  <files>packages/server/src/utils/invoice-generator.ts, packages/server/src/routers/invoices.ts</files>
  <action>
Create new service file `packages/server/src/utils/invoice-generator.ts`:

1. **Function signature:**
```typescript
export async function generateInvoiceFromTimeEntries(
  db: TenantDb,
  options: {
    timeEntryIds: number[];
    clientId: number;
    mode: 'session' | 'project';
    taxRate?: number; // Optional, defaults to 20.00
    notes?: string;
  }
): Promise<{ invoice: Invoice; items: InvoiceItem[] }>
```

2. **Implementation logic:**
   - Query time_entries WHERE id IN (timeEntryIds) JOIN taskTypes
   - Validate: all entries belong to same session OR project (selon mode)
   - Filter out non-billable entries (taskTypes.category = "non-billable")
   - Group entries by taskTypeId: `Map<taskTypeId, { name, totalMinutes, hourlyRate, entries[] }>`
   - Calculate per-group: `amount = (totalMinutes / 60) * hourlyRate`
   - Format description: `"{taskTypeName} - {hours}h{minutes} @ {hourlyRate}€/h"`
   - Calculate financial: `subtotal = sum(amounts)`, `taxAmount = subtotal * (taxRate/100)`, `total = subtotal + taxAmount`
   - Generate invoice number: `INV-{YYYY}-{sequential}` (query max invoice number, increment)
   - Insert invoice record with `status: "draft"`, `issueDate: now()`, `dueDate: now() + 30 days`
   - Insert invoice_items records with calculated amounts
   - Return created invoice + items

3. **Error handling:**
   - Throw if timeEntryIds empty
   - Throw if entries belong to different sessions/projects when mode requires consistency
   - Throw if no billable entries found
   - Throw if client doesn't match entries' linked records

4. **DO NOT** create Stripe Payment Intent (that's Plan 16-02)
5. **DO NOT** implement deposit logic (that's Plan 16-02)
  </action>
  <verify>
Create test file `packages/server/src/utils/__tests__/invoice-generator.test.ts`:
- Mock db with sample timeEntries (3 entries: 2h Recording @ 50€/h, 1h Mixing @ 60€/h, 30min Break @ 0€/h)
- Call generateInvoiceFromTimeEntries with mode='session'
- Assert: 2 invoice items created (Break excluded)
- Assert: Line 1: "Recording - 2h00 @ 50.00€/h" amount=100.00
- Assert: Line 2: "Mixing - 1h00 @ 60.00€/h" amount=60.00
- Assert: subtotal=160.00, taxAmount=32.00, total=192.00
- Assert: invoice number format matches INV-{YYYY}-{N}

Run: `pnpm --filter server test invoice-generator`
  </verify>
  <done>
- Service generates invoices from time entries with correct grouping by task type
- Line items have descriptive format "{TaskType} - {duration} @ {rate}/h"
- Non-billable entries excluded from invoicing
- Financial calculations accurate (subtotal + tax = total)
- Invoice numbers auto-generated with sequential format
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tRPC endpoints for auto-invoice creation</name>
  <files>packages/server/src/routers/invoices.ts</files>
  <action>
Add 2 new procedures to invoices router:

1. **Procedure: `generateFromTimeEntries`**
```typescript
generateFromTimeEntries: protectedProcedure
  .input(z.object({
    timeEntryIds: z.array(z.number()).min(1),
    clientId: z.number(),
    mode: z.enum(['session', 'project']),
    taxRate: z.number().min(0).max(100).optional(),
    notes: z.string().optional(),
  }))
  .mutation(async ({ ctx, input }) => {
    const tenantDb = await ctx.getTenantDb();

    // Validate timeEntries exist and belong to organization
    const entries = await tenantDb.query.timeEntries.findMany({
      where: inArray(timeEntries.id, input.timeEntryIds),
      with: { taskType: true },
    });

    if (entries.length !== input.timeEntryIds.length) {
      throw new TRPCError({ code: 'NOT_FOUND', message: 'Some time entries not found' });
    }

    // Validate mode consistency
    if (input.mode === 'session') {
      const sessionIds = new Set(entries.map(e => e.sessionId).filter(Boolean));
      if (sessionIds.size !== 1) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'All time entries must belong to the same session for mode=session'
        });
      }
    }

    if (input.mode === 'project') {
      const projectIds = new Set(entries.map(e => e.projectId).filter(Boolean));
      if (projectIds.size !== 1) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: 'All time entries must belong to the same project for mode=project'
        });
      }
    }

    // Generate invoice
    const result = await generateInvoiceFromTimeEntries(tenantDb, input);

    // Link time entries to invoice (update invoiceId FK - Task 3)
    await tenantDb.update(timeEntries)
      .set({ invoiceId: result.invoice.id })
      .where(inArray(timeEntries.id, input.timeEntryIds));

    return result;
  })
```

2. **Procedure: `getUninvoicedTimeEntries`**
```typescript
getUninvoicedTimeEntries: protectedProcedure
  .input(z.object({
    sessionId: z.number().optional(),
    projectId: z.number().optional(),
  }))
  .query(async ({ ctx, input }) => {
    const tenantDb = await ctx.getTenantDb();

    // Query time entries where invoiceId IS NULL
    const entries = await tenantDb.query.timeEntries.findMany({
      where: and(
        eq(timeEntries.invoiceId, null),
        input.sessionId ? eq(timeEntries.sessionId, input.sessionId) : undefined,
        input.projectId ? eq(timeEntries.projectId, input.projectId) : undefined,
      ),
      with: {
        taskType: true,
        session: { with: { client: true } },
        project: { with: { client: true } },
      },
      orderBy: [desc(timeEntries.startTime)],
    });

    return entries;
  })
```

3. **Import statement:** `import { generateInvoiceFromTimeEntries } from '../utils/invoice-generator';`

4. **Add Drizzle imports:** `inArray`, `and`, `eq`, `desc` from 'drizzle-orm'
  </action>
  <verify>
Type check: `pnpm check` passes with no errors

Manual tRPC test in browser console:
```javascript
// Get uninvoiced entries
const entries = await trpc.invoices.getUninvoicedTimeEntries.query({ sessionId: 1 });
console.log('Uninvoiced entries:', entries);

// Generate invoice
const result = await trpc.invoices.generateFromTimeEntries.mutate({
  timeEntryIds: [1, 2, 3],
  clientId: 5,
  mode: 'session',
  taxRate: 20,
});
console.log('Generated invoice:', result);
```

Expected: Invoice created, returns invoice + items, no TypeScript errors
  </verify>
  <done>
- Endpoint `generateFromTimeEntries` creates invoices from time entries
- Validation ensures entries belong to same session/project per mode
- Endpoint `getUninvoicedTimeEntries` lists entries not yet invoiced
- Time entries linked to invoice after generation (via Task 3 FK)
- tRPC types exported correctly, frontend can call endpoints
  </done>
</task>

<task type="auto">
  <name>Task 3: Link time entries to invoices (schema + migration)</name>
  <files>packages/database/src/tenant/schema.ts, packages/database/drizzle/migrations/</files>
  <action>
1. **Update timeEntries schema** in `packages/database/src/tenant/schema.ts`:

Find the `timeEntries` table definition and add new field after line ~890 (after `manuallyAdjusted` field):

```typescript
// Invoicing
invoiceId: integer("invoice_id").references(() => invoices.id, { onDelete: "set null" }), // Links to invoice if time has been invoiced
```

2. **Update timeEntries relations** (around line ~1150):

Add invoices relation:
```typescript
invoice: one(invoices, {
  fields: [timeEntries.invoiceId],
  references: [invoices.id],
}),
```

3. **Update invoices relations** to include reverse relation:

Find `invoicesRelations` and add:
```typescript
timeEntries: many(timeEntries),
```

4. **Generate migration:**
```bash
cd packages/database
pnpm db:generate
```

When prompted, name migration: `0009_add_invoice_link_to_time_entries`

5. **Apply migration to master DB:**
```bash
docker exec -i rsm-postgres psql -U postgres -d rsm_master < drizzle/migrations/0009_add_invoice_link_to_time_entries.sql
```

6. **Verify migration applied:**
```bash
docker exec rsm-postgres psql -U postgres -d rsm_master -c "\d time_entries" | grep invoice_id
```

Expected output: Line showing `invoice_id | integer` with FK constraint
  </action>
  <verify>
1. TypeScript check: `pnpm check` passes (Drizzle types regenerated)
2. Schema exports: Check `timeEntries.$inferSelect` includes `invoiceId: number | null`
3. Migration file exists: `ls drizzle/migrations/ | grep 0009`
4. Database check:
```bash
docker exec rsm-postgres psql -U postgres -d rsm_master -c "SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name='time_entries' AND column_name='invoice_id';"
```
Expected: `invoice_id | integer | YES`

5. Foreign key constraint exists:
```bash
docker exec rsm-postgres psql -U postgres -d rsm_master -c "\d time_entries" | grep FOREIGN
```
Expected: FK constraint to invoices table with ON DELETE SET NULL
  </verify>
  <done>
- timeEntries table has `invoiceId` nullable FK column
- Migration applied to master database
- Drizzle types regenerated with invoiceId field
- Relations defined: timeEntries.invoice (one), invoices.timeEntries (many)
- ON DELETE SET NULL ensures time entries survive invoice deletion
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm check` passes with 0 TypeScript errors
- [ ] Unit tests for invoice-generator pass
- [ ] Migration 0009 applied to master DB
- [ ] timeEntries.invoiceId column exists with FK constraint
- [ ] Manual tRPC test: generateFromTimeEntries creates invoice with correct line items
- [ ] Manual tRPC test: getUninvoicedTimeEntries returns only entries where invoiceId IS NULL
</verification>

<success_criteria>
- Invoice generation service created and tested
- Time entries grouped by task type with proper calculations
- tRPC endpoints functional for invoice generation and querying uninvoiced entries
- Database schema updated with invoiceId FK in time_entries
- Migration applied successfully
- No TypeScript errors, all builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-facturation-automatique-backend/16-01-SUMMARY.md`:

# Phase 16 Plan 1: Auto-Invoice Generation from Time Entries Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- Created invoice generation service from time entries
- Implemented tRPC endpoints for auto-invoicing
- Added invoiceId FK to time_entries table

## Files Created/Modified

- `packages/server/src/utils/invoice-generator.ts` - Invoice generation logic
- `packages/server/src/routers/invoices.ts` - New tRPC endpoints
- `packages/database/src/tenant/schema.ts` - Added invoiceId field
- `packages/database/drizzle/migrations/0009_*.sql` - Migration file

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 2 (16-02-PLAN.md): Stripe Deposits & Advances
</output>
