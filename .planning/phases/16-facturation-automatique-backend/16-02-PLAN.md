---
phase: 16-facturation-automatique-backend
plan: 2
type: execute
---

<objective>
Ajouter support pour acomptes/avances via Stripe Payment Intents pour les invoices générées automatiquement.

Purpose: Permettre aux studios de demander un acompte (30-50%) avant de commencer le projet, puis facturer le solde restant après livraison. Réduit le risque financier pour les studios.

Output: Schema support deposits + Stripe Payment Intent integration + webhook handling
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/16-facturation-automatique-backend/16-01-SUMMARY.md  # Invoice generation patterns

**Codebase patterns:**
@packages/server/src/routers/client-portal-booking.ts  # Existing Stripe Payment Intent usage
@packages/server/src/webhooks/stripe-webhook.ts  # Webhook handler patterns
@packages/database/src/tenant/schema.ts  # Invoice schema

**Stripe integration established:**
- Stripe SDK already installed (Phase 3)
- Payment Intents used for booking deposits (client-portal-booking.ts)
- Webhook handler exists for payment_intent.succeeded events
- Pattern: create Payment Intent → return clientSecret → frontend Stripe Elements → webhook confirms

**Key constraints:**
- Follow existing Stripe Payment Intent pattern from client-portal-booking
- Use metadata to identify deposit vs full payment
- Store Stripe IDs for reconciliation and refunds
- Calculate remaining balance automatically (total - depositAmount)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deposit fields to invoices schema</name>
  <files>packages/database/src/tenant/schema.ts, packages/database/drizzle/migrations/</files>
  <action>
Update invoices table schema with deposit support fields:

1. **Add fields to invoices table** (after `total` field, around line ~650):

```typescript
// Deposit & Advance Payments
depositAmount: decimal("deposit_amount", { precision: 10, scale: 2 }), // Amount requested as deposit (nullable = no deposit)
depositPaidAt: timestamp("deposit_paid_at"), // When deposit was paid
stripeDepositPaymentIntentId: varchar("stripe_deposit_payment_intent_id", { length: 255 }), // Stripe PI for deposit
remainingBalance: decimal("remaining_balance", { precision: 10, scale: 2 }), // Calculated: total - depositAmount (or total if no deposit)
```

2. **Generate migration:**
```bash
cd packages/database
pnpm db:generate
```

Name: `0010_add_deposit_fields_to_invoices`

3. **Apply migration:**
```bash
docker exec -i rsm-postgres psql -U postgres -d rsm_master < drizzle/migrations/0010_add_deposit_fields_to_invoices.sql
```

4. **Verify migration:**
```bash
docker exec rsm-postgres psql -U postgres -d rsm_master -c "SELECT column_name FROM information_schema.columns WHERE table_name='invoices' AND column_name IN ('deposit_amount', 'deposit_paid_at', 'stripe_deposit_payment_intent_id', 'remaining_balance');"
```

Expected: 4 rows showing all deposit fields exist

5. **Update Invoice type exports:** Types auto-regenerated by Drizzle after migration
  </action>
  <verify>
1. TypeScript check: `pnpm check` passes
2. Schema inspection:
```bash
docker exec rsm-postgres psql -U postgres -d rsm_master -c "\d invoices" | grep -E "(deposit_amount|deposit_paid_at|stripe_deposit|remaining_balance)"
```
Expected: 4 columns visible

3. Type inference check in `packages/database/src/tenant/schema.ts`:
```typescript
// After migration, this should compile:
const invoice: Invoice = {
  // ... other fields
  depositAmount: "50.00",
  depositPaidAt: new Date(),
  stripeDepositPaymentIntentId: "pi_123",
  remainingBalance: "50.00",
};
```
  </verify>
  <done>
- invoices table has 4 new deposit fields
- Migration applied to master database
- Drizzle types include deposit fields as nullable
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Stripe Payment Intent for deposits</name>
  <files>packages/server/src/routers/invoices.ts, packages/server/src/webhooks/stripe-webhook.ts</files>
  <action>
**Part A: Add tRPC endpoint for deposit Payment Intent creation**

In `packages/server/src/routers/invoices.ts`:

```typescript
createDepositPaymentIntent: protectedProcedure
  .input(z.object({
    invoiceId: z.number(),
    depositAmount: z.number().positive(), // Amount in euros
  }))
  .mutation(async ({ ctx, input }) => {
    const tenantDb = await ctx.getTenantDb();

    // Get invoice
    const invoice = await tenantDb.query.invoices.findFirst({
      where: eq(invoices.id, input.invoiceId),
      with: { client: true },
    });

    if (!invoice) {
      throw new TRPCError({ code: 'NOT_FOUND', message: 'Invoice not found' });
    }

    if (input.depositAmount > parseFloat(invoice.total)) {
      throw new TRPCError({
        code: 'BAD_REQUEST',
        message: 'Deposit amount cannot exceed invoice total'
      });
    }

    // Create Stripe Payment Intent (follow client-portal-booking.ts pattern)
    const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

    const paymentIntent = await stripe.paymentIntents.create({
      amount: Math.round(input.depositAmount * 100), // Convert to cents
      currency: 'eur',
      metadata: {
        type: 'invoice_deposit',
        invoiceId: invoice.id.toString(),
        organizationId: ctx.organizationId.toString(),
        clientId: invoice.clientId.toString(),
      },
      description: `Acompte facture ${invoice.invoiceNumber} - ${invoice.client.name}`,
    });

    // Update invoice with deposit info
    await tenantDb.update(invoices)
      .set({
        depositAmount: input.depositAmount.toFixed(2),
        stripeDepositPaymentIntentId: paymentIntent.id,
        remainingBalance: (parseFloat(invoice.total) - input.depositAmount).toFixed(2),
      })
      .where(eq(invoices.id, input.invoiceId));

    return {
      clientSecret: paymentIntent.client_secret,
      paymentIntentId: paymentIntent.id,
    };
  })
```

**Part B: Add webhook handler for deposit payment success**

In `packages/server/src/webhooks/stripe-webhook.ts`:

Find the `handlePaymentIntentSucceeded` function and add deposit handling:

```typescript
async function handlePaymentIntentSucceeded(event: Stripe.Event) {
  const paymentIntent = event.data.object as Stripe.PaymentIntent;
  const metadata = paymentIntent.metadata;

  // Existing booking payment logic...
  // (keep existing code)

  // NEW: Handle invoice deposit payments
  if (metadata.type === 'invoice_deposit') {
    const organizationId = parseInt(metadata.organizationId);
    const invoiceId = parseInt(metadata.invoiceId);

    const tenantDb = await getTenantDbForOrganization(organizationId);

    await tenantDb.update(invoices)
      .set({
        depositPaidAt: new Date(),
        updatedAt: new Date(),
      })
      .where(eq(invoices.id, invoiceId));

    console.log(`✅ Deposit payment succeeded for invoice ${invoiceId}`);
  }
}
```

**Part C: Add Stripe import if missing:**
```typescript
import Stripe from 'stripe';
```
  </action>
  <verify>
Manual test sequence:

1. **Create test invoice via tRPC:**
```javascript
const invoice = await trpc.invoices.create.mutate({
  clientId: 1,
  subtotal: "100.00",
  taxRate: "20.00",
  taxAmount: "20.00",
  total: "120.00",
  // ... other fields
});
```

2. **Create deposit Payment Intent:**
```javascript
const { clientSecret, paymentIntentId } = await trpc.invoices.createDepositPaymentIntent.mutate({
  invoiceId: invoice.id,
  depositAmount: 60, // 50% deposit
});
console.log('Client Secret:', clientSecret);
```

3. **Verify invoice updated:**
```bash
docker exec rsm-postgres psql -U postgres -d rsm_master -c "SELECT deposit_amount, remaining_balance, stripe_deposit_payment_intent_id FROM invoices WHERE id=X;"
```
Expected: `deposit_amount=60.00`, `remaining_balance=60.00`, `stripe_deposit_payment_intent_id=pi_xxx`

4. **Simulate webhook (use Stripe CLI):**
```bash
stripe trigger payment_intent.succeeded --add payment_intent:metadata.type=invoice_deposit --add payment_intent:metadata.invoiceId=X --add payment_intent:metadata.organizationId=1
```

5. **Verify webhook updated invoice:**
```bash
docker exec rsm-postgres psql -U postgres -d rsm_master -c "SELECT deposit_paid_at FROM invoices WHERE id=X;"
```
Expected: `deposit_paid_at` has timestamp

6. TypeScript check: `pnpm check` passes
  </verify>
  <done>
- tRPC endpoint creates Stripe Payment Intent for deposits
- Payment Intent includes metadata for invoice tracking
- Invoice updated with deposit amount and remaining balance
- Webhook handler processes payment_intent.succeeded for deposits
- depositPaidAt timestamp set when payment confirmed
- Pattern consistent with existing booking payment flow
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm check` passes with 0 TypeScript errors
- [ ] Migration 0010 applied to master DB
- [ ] Deposit fields exist in invoices table
- [ ] tRPC endpoint createDepositPaymentIntent creates Payment Intent successfully
- [ ] Stripe webhook updates invoice.depositPaidAt when deposit paid
- [ ] remainingBalance calculated correctly (total - depositAmount)
- [ ] Stripe CLI test: payment_intent.succeeded triggers webhook handler
</verification>

<success_criteria>
- Schema supports deposit tracking with 4 new fields
- Stripe Payment Intent integration for deposits functional
- Webhook handler processes deposit payments
- Remaining balance calculated automatically
- No TypeScript errors, all builds pass
- Pattern consistent with existing Stripe integration
</success_criteria>

<output>
After completion, create `.planning/phases/16-facturation-automatique-backend/16-02-SUMMARY.md`:

# Phase 16 Plan 2: Stripe Deposits & Advances Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- Added deposit fields to invoices schema
- Created Stripe Payment Intent endpoint for deposits
- Implemented webhook handler for deposit payment confirmation

## Files Created/Modified

- `packages/database/src/tenant/schema.ts` - Added 4 deposit fields
- `packages/database/drizzle/migrations/0010_*.sql` - Migration file
- `packages/server/src/routers/invoices.ts` - New createDepositPaymentIntent endpoint
- `packages/server/src/webhooks/stripe-webhook.ts` - Deposit webhook handler

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Plan 3 (16-03-PLAN.md): Tax Calculation & Validation
</output>
