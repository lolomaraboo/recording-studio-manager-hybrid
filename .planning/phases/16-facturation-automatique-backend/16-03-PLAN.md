---
phase: 16-facturation-automatique-backend
plan: 3
type: execute
---

<objective>
Créer utilitaires de calcul de taxes robustes avec support multi-rate (TVA FR) et validation pour garantir précision financière.

Purpose: Centraliser la logique de calcul de taxes pour éviter erreurs d'arrondi, assurer cohérence entre quotes/invoices/deposits, et supporter les différents taux de TVA français (20%, 10%, 5.5%, 2.1%).

Output: Tax calculator utility + intégration dans invoice generation + tests unitaires
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/16-facturation-automatique-backend/16-01-SUMMARY.md  # Invoice generation
@.planning/phases/16-facturation-automatique-backend/16-02-SUMMARY.md  # Deposits

**Codebase patterns:**
@packages/server/src/utils/invoice-generator.ts  # Invoice calculation logic (from Plan 16-01)
@packages/database/src/tenant/schema.ts  # Financial field patterns (decimal precision)

**Tax calculation context:**
- France uses 4 TVA rates: 20% (normal), 10% (reduced), 5.5% (further reduced), 2.1% (super reduced)
- Default rate: 20% (most studio services)
- Reduced rates apply to specific services (books/publications, accessible housing)
- All calculations must use 2 decimal precision (no floating point errors)
- Pattern exists in quotes/invoices: `subtotal`, `taxRate`, `taxAmount`, `total`

**Key constraints:**
- Avoid floating point errors: use string arithmetic or integer cents internally
- Validate taxRate between 0% and 100%
- Round taxAmount to 2 decimals (standard accounting practice)
- Ensure: `total = subtotal + taxAmount` (exact equality)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tax calculation utility</name>
  <files>packages/server/src/utils/tax-calculator.ts</files>
  <action>
Create new utility file with comprehensive tax calculation logic:

```typescript
/**
 * Tax Calculator Utility
 *
 * Provides robust tax calculation with support for multiple tax rates
 * and proper decimal handling to avoid floating point errors.
 */

export interface TaxCalculationResult {
  subtotal: string;      // Original amount (2 decimals)
  taxRate: string;       // Tax rate percentage (2 decimals)
  taxAmount: string;     // Calculated tax (2 decimals)
  total: string;         // subtotal + taxAmount (2 decimals)
}

/**
 * Calculate tax amount and total from subtotal and tax rate
 *
 * @param subtotal - Amount before tax (number or string)
 * @param taxRate - Tax rate percentage (e.g., 20 for 20%)
 * @returns Calculation result with all values as strings (2 decimal precision)
 *
 * @example
 * calculateTax(100, 20) // => { subtotal: "100.00", taxRate: "20.00", taxAmount: "20.00", total: "120.00" }
 * calculateTax("99.99", 10) // => { subtotal: "99.99", taxRate: "10.00", taxAmount: "10.00", total: "109.99" }
 */
export function calculateTax(
  subtotal: number | string,
  taxRate: number | string
): TaxCalculationResult {
  // Validate inputs
  const subtotalNum = typeof subtotal === 'string' ? parseFloat(subtotal) : subtotal;
  const taxRateNum = typeof taxRate === 'string' ? parseFloat(taxRate) : taxRate;

  if (isNaN(subtotalNum) || subtotalNum < 0) {
    throw new Error(`Invalid subtotal: ${subtotal}. Must be a positive number.`);
  }

  if (isNaN(taxRateNum) || taxRateNum < 0 || taxRateNum > 100) {
    throw new Error(`Invalid tax rate: ${taxRate}. Must be between 0 and 100.`);
  }

  // Convert to integer cents to avoid floating point errors
  const subtotalCents = Math.round(subtotalNum * 100);
  const taxRateCents = Math.round(taxRateNum * 100);

  // Calculate tax in cents
  const taxAmountCents = Math.round((subtotalCents * taxRateCents) / 10000);

  // Calculate total in cents
  const totalCents = subtotalCents + taxAmountCents;

  // Convert back to euros with 2 decimal precision
  return {
    subtotal: (subtotalCents / 100).toFixed(2),
    taxRate: (taxRateCents / 100).toFixed(2),
    taxAmount: (taxAmountCents / 100).toFixed(2),
    total: (totalCents / 100).toFixed(2),
  };
}

/**
 * Validate tax calculation result (ensures total = subtotal + taxAmount)
 *
 * @param result - Tax calculation result
 * @throws Error if calculation is invalid
 */
export function validateTaxCalculation(result: TaxCalculationResult): void {
  const subtotal = parseFloat(result.subtotal);
  const taxAmount = parseFloat(result.taxAmount);
  const total = parseFloat(result.total);

  const calculatedTotal = subtotal + taxAmount;
  const difference = Math.abs(total - calculatedTotal);

  // Allow 0.01 difference due to rounding (but should be 0 with cents arithmetic)
  if (difference > 0.01) {
    throw new Error(
      `Tax calculation invalid: subtotal (${result.subtotal}) + taxAmount (${result.taxAmount}) != total (${result.total})`
    );
  }
}

/**
 * Common French VAT rates
 */
export const FRENCH_VAT_RATES = {
  NORMAL: 20.00,        // Taux normal (most services)
  REDUCED: 10.00,       // Taux réduit (restaurants, transport)
  FURTHER_REDUCED: 5.5, // Taux super réduit (books, food)
  SUPER_REDUCED: 2.1,   // Taux particulier (medicine, press)
} as const;

/**
 * Get default tax rate for organization (from env or constant)
 */
export function getDefaultTaxRate(): number {
  const envRate = process.env.DEFAULT_TAX_RATE;
  if (envRate) {
    const rate = parseFloat(envRate);
    if (!isNaN(rate) && rate >= 0 && rate <= 100) {
      return rate;
    }
  }
  return FRENCH_VAT_RATES.NORMAL; // Default to 20%
}
```

Save as: `packages/server/src/utils/tax-calculator.ts`
  </action>
  <verify>
Create test file: `packages/server/src/utils/__tests__/tax-calculator.test.ts`

```typescript
import { describe, it, expect } from 'vitest';
import { calculateTax, validateTaxCalculation, FRENCH_VAT_RATES, getDefaultTaxRate } from '../tax-calculator';

describe('Tax Calculator', () => {
  it('calculates tax correctly for 20% rate', () => {
    const result = calculateTax(100, 20);
    expect(result.subtotal).toBe('100.00');
    expect(result.taxRate).toBe('20.00');
    expect(result.taxAmount).toBe('20.00');
    expect(result.total).toBe('120.00');
  });

  it('calculates tax correctly for 10% rate', () => {
    const result = calculateTax(99.99, 10);
    expect(result.subtotal).toBe('99.99');
    expect(result.taxRate).toBe('10.00');
    expect(result.taxAmount).toBe('10.00');
    expect(result.total).toBe('109.99');
  });

  it('handles decimal subtotals correctly', () => {
    const result = calculateTax(123.45, 20);
    expect(result.taxAmount).toBe('24.69'); // 123.45 * 0.20 = 24.69
    expect(result.total).toBe('148.14');
  });

  it('handles string inputs', () => {
    const result = calculateTax('100.00', '20.00');
    expect(result.total).toBe('120.00');
  });

  it('throws error for negative subtotal', () => {
    expect(() => calculateTax(-10, 20)).toThrow('Invalid subtotal');
  });

  it('throws error for invalid tax rate', () => {
    expect(() => calculateTax(100, -5)).toThrow('Invalid tax rate');
    expect(() => calculateTax(100, 150)).toThrow('Invalid tax rate');
  });

  it('validates correct calculation', () => {
    const result = calculateTax(100, 20);
    expect(() => validateTaxCalculation(result)).not.toThrow();
  });

  it('detects invalid calculation', () => {
    const invalidResult = {
      subtotal: '100.00',
      taxRate: '20.00',
      taxAmount: '20.00',
      total: '125.00', // Wrong! Should be 120.00
    };
    expect(() => validateTaxCalculation(invalidResult)).toThrow('Tax calculation invalid');
  });

  it('supports all French VAT rates', () => {
    expect(FRENCH_VAT_RATES.NORMAL).toBe(20.00);
    expect(FRENCH_VAT_RATES.REDUCED).toBe(10.00);
    expect(FRENCH_VAT_RATES.FURTHER_REDUCED).toBe(5.5);
    expect(FRENCH_VAT_RATES.SUPER_REDUCED).toBe(2.1);
  });

  it('returns default tax rate', () => {
    const rate = getDefaultTaxRate();
    expect(rate).toBe(20.00); // Should default to NORMAL rate
  });
});
```

Run tests: `pnpm --filter server test tax-calculator`

Expected: All tests pass
  </verify>
  <done>
- Tax calculator utility created with robust decimal handling
- Supports all French VAT rates (20%, 10%, 5.5%, 2.1%)
- Validation ensures no floating point errors
- Comprehensive unit tests (11 test cases)
- Error handling for invalid inputs
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate tax calculator in invoice generation</name>
  <files>packages/server/src/utils/invoice-generator.ts</files>
  <action>
Update the `generateInvoiceFromTimeEntries` function to use tax calculator:

1. **Add import at top of file:**
```typescript
import { calculateTax, getDefaultTaxRate, validateTaxCalculation } from './tax-calculator';
```

2. **Replace manual tax calculation** (find the section where subtotal/tax/total are calculated):

BEFORE (manual calculation):
```typescript
const taxAmount = subtotal * (taxRate / 100);
const total = subtotal + taxAmount;
```

AFTER (using tax calculator):
```typescript
// Use tax calculator for robust calculation
const taxRateToUse = options.taxRate ?? getDefaultTaxRate();
const taxResult = calculateTax(subtotal, taxRateToUse);

// Validate calculation
validateTaxCalculation(taxResult);

// Use calculated values
const { taxAmount, total } = taxResult;
```

3. **Update variable declarations** to use string values from taxResult:
```typescript
subtotal: taxResult.subtotal,
taxRate: taxResult.taxRate,
taxAmount: taxResult.taxAmount,
total: taxResult.total,
```

4. **Ensure consistency:** All financial calculations now use tax-calculator utility

5. **Add validation before returning:**
```typescript
// Final validation before returning
validateTaxCalculation({
  subtotal: invoice.subtotal,
  taxRate: invoice.taxRate,
  taxAmount: invoice.taxAmount,
  total: invoice.total,
});
```
  </action>
  <verify>
1. TypeScript check: `pnpm check` passes

2. Update existing invoice-generator tests to verify tax calculation:

In `packages/server/src/utils/__tests__/invoice-generator.test.ts`:

```typescript
it('uses tax calculator for accurate calculations', () => {
  // Mock scenario: 160€ subtotal with 20% tax
  const result = generateInvoiceFromTimeEntries([...], { mode: 'session' });

  // Verify tax calculation
  expect(result.invoice.subtotal).toBe('160.00');
  expect(result.invoice.taxRate).toBe('20.00');
  expect(result.invoice.taxAmount).toBe('32.00');
  expect(result.invoice.total).toBe('192.00');

  // Verify no floating point errors
  const subtotal = parseFloat(result.invoice.subtotal);
  const taxAmount = parseFloat(result.invoice.taxAmount);
  const total = parseFloat(result.invoice.total);
  expect(subtotal + taxAmount).toBe(total); // Exact equality
});

it('supports custom tax rate', () => {
  const result = generateInvoiceFromTimeEntries([...], {
    mode: 'session',
    taxRate: 10, // Reduced rate
  });

  expect(result.invoice.taxRate).toBe('10.00');
  // Verify taxAmount calculated with 10% rate
});

it('defaults to 20% tax rate if not specified', () => {
  const result = generateInvoiceFromTimeEntries([...], { mode: 'session' });
  expect(result.invoice.taxRate).toBe('20.00');
});
```

Run: `pnpm --filter server test invoice-generator`

3. Manual integration test via tRPC:
```javascript
const invoice = await trpc.invoices.generateFromTimeEntries.mutate({
  timeEntryIds: [1, 2, 3],
  clientId: 5,
  mode: 'session',
  taxRate: 20, // Explicit rate
});

console.log('Invoice totals:', {
  subtotal: invoice.invoice.subtotal,
  taxAmount: invoice.invoice.taxAmount,
  total: invoice.invoice.total,
});

// Verify: subtotal + taxAmount = total (no rounding errors)
```

Expected: All calculations accurate, no floating point errors
  </verify>
  <done>
- Invoice generator uses tax-calculator utility
- Tax calculations centralized and validated
- Supports custom tax rates via options parameter
- Defaults to 20% if no rate specified
- Validation ensures accuracy before returning invoice
- Tests verify no floating point errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm check` passes with 0 TypeScript errors
- [ ] Tax calculator tests pass (11 test cases)
- [ ] Invoice generator tests pass with tax calculator integration
- [ ] Manual test: generateInvoiceFromTimeEntries produces accurate calculations
- [ ] Validation confirms: subtotal + taxAmount = total (exact equality)
- [ ] All French VAT rates supported (20%, 10%, 5.5%, 2.1%)
</verification>

<success_criteria>
- Tax calculator utility created and tested
- All French VAT rates supported
- Robust decimal handling prevents floating point errors
- Invoice generation uses centralized tax calculation
- Validation ensures financial accuracy
- No TypeScript errors, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-facturation-automatique-backend/16-03-SUMMARY.md`:

# Phase 16 Plan 3: Tax Calculation & Validation Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- Created robust tax calculator utility with French VAT support
- Integrated tax calculator into invoice generation
- Comprehensive unit tests for tax calculations

## Files Created/Modified

- `packages/server/src/utils/tax-calculator.ts` - Tax calculation utility (new)
- `packages/server/src/utils/__tests__/tax-calculator.test.ts` - Tests (new)
- `packages/server/src/utils/invoice-generator.ts` - Integrated tax calculator
- `packages/server/src/utils/__tests__/invoice-generator.test.ts` - Updated tests

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase

**Phase 16 complete** - Backend auto-invoicing system functional

Ready for Phase 17 (Facturation Automatique - Stripe & UI):
- Stripe Checkout integration for invoice payments
- Invoice UI with payment button
- Email notifications
</output>
