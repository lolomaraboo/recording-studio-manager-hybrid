---
phase: 35-harmonisation-invoices---routing-cohérent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/components/InvoiceEditForm.tsx (new file)
  - packages/client/src/pages/InvoiceCreate.tsx
autonomous: true

must_haves:
  truths:
    - "Invoice creation uses accordion pattern like ClientEditForm and TalentEditForm"
    - "Line items managed in dedicated accordion section"
    - "Accordions open by default for immediate field access"
    - "Form structure handles complex invoice fields (client, dates, amounts, deposit, line items)"
  artifacts:
    - path: "packages/client/src/components/InvoiceEditForm.tsx"
      provides: "Accordion-based edit form for invoices"
      min_lines: 500
      exports: ["InvoiceEditForm"]
    - path: "packages/client/src/pages/InvoiceCreate.tsx"
      provides: "Simplified creation page using InvoiceEditForm"
      min_lines: 150
      contains: "InvoiceEditForm"
  key_links:
    - from: "InvoiceCreate.tsx"
      to: "InvoiceEditForm"
      via: "reusable component for creation"
      pattern: "InvoiceEditForm"
    - from: "InvoiceEditForm"
      to: "invoices schema fields"
      via: "formData state management"
      pattern: "clientId.*invoiceNumber.*issueDate.*dueDate.*subtotal.*taxRate.*status.*depositAmount.*notes"
---

<objective>
Create InvoiceEditForm accordion component following Phase 28 TalentEditForm pattern for invoice harmonization.

Purpose: Eliminate inline form in InvoiceCreate, provide consistent edit UX with Client/Talent/Service patterns
Output: InvoiceEditForm component with 5 accordions (Informations générales, Client, Montants, Acompte, Lignes de facture)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference implementations
@.planning/phases/28-harmonisation-ui-talents/28-05-PLAN.md (accordion pattern reference)
@packages/client/src/components/TalentEditForm.tsx (accordion pattern implementation)
@packages/client/src/components/ClientEditForm.tsx (accordion with complex fields)

# Current invoice implementation
@packages/client/src/pages/InvoiceCreate.tsx (inline form - to be refactored)

# Schema reference
@packages/database/src/tenant/schema.ts (invoices table: lines 219-246, invoiceItems table: lines 254-262)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InvoiceEditForm component with accordions</name>
  <files>packages/client/src/components/InvoiceEditForm.tsx</files>
  <action>
**Pattern reference:** TalentEditForm.tsx (accordions, all open by default, localStorage persistence, Alt+Click toggle)

**Create accordion-based edit form for invoices:**

1. **Component structure:**
   ```typescript
   import { useState, useEffect } from "react";
   import { Button } from "@/components/ui/button";
   import { Card } from "@/components/ui/card";
   import { Input } from "@/components/ui/input";
   import { Label } from "@/components/ui/label";
   import { Textarea } from "@/components/ui/textarea";
   import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
   import {
     Accordion,
     AccordionContent,
     AccordionItem,
     AccordionTrigger,
   } from "@/components/ui/accordion";
   import {
     FileText,
     User,
     DollarSign,
     CreditCard,
     List,
     Plus,
     Trash2,
   } from "lucide-react";
   import { trpc } from "@/lib/trpc";

   interface LineItem {
     description: string;
     quantity: string;
     unitPrice: string;
     amount: string;
   }

   interface InvoiceEditFormProps {
     formData: any;
     setFormData: (data: any) => void;
   }

   export function InvoiceEditForm({
     formData,
     setFormData,
   }: InvoiceEditFormProps) {
     // Fetch clients for dropdown
     const { data: clients } = trpc.clients.list.useQuery({ limit: 100 });

     // State for line items (internal to component)
     const [lineItems, setLineItems] = useState<LineItem[]>([
       { description: "", quantity: "1.00", unitPrice: "", amount: "" }
     ]);

     // State for open accordions (all open by default)
     const [openItems, setOpenItems] = useState<string[]>(() => {
       try {
         const saved = localStorage.getItem('invoiceEditAccordions');
         return saved ? JSON.parse(saved) : ["infos", "client", "montants", "acompte", "lignes"];
       } catch {
         return ["infos", "client", "montants", "acompte", "lignes"];
       }
     });

     // Save accordion state to localStorage
     useEffect(() => {
       try {
         localStorage.setItem('invoiceEditAccordions', JSON.stringify(openItems));
       } catch (error) {
         console.error('Failed to save accordion state:', error);
       }
     }, [openItems]);

     // Alt key handler to toggle all accordions
     const handleAccordionTriggerClick = (event: React.MouseEvent) => {
       if (event.altKey) {
         event.preventDefault();
         event.stopPropagation();

         const allAccordions = ["infos", "client", "montants", "acompte", "lignes"];
         if (openItems.length < allAccordions.length) {
           setOpenItems(allAccordions);
         } else {
           setOpenItems([]);
         }
       }
     };

     // Line item handlers
     const addLineItem = () => {
       setLineItems([...lineItems, { description: "", quantity: "1.00", unitPrice: "", amount: "" }]);
     };

     const removeLineItem = (index: number) => {
       if (lineItems.length > 1) {
         setLineItems(lineItems.filter((_, i) => i !== index));
       }
     };

     const updateLineItem = (index: number, field: keyof LineItem, value: string) => {
       const updated = [...lineItems];
       updated[index][field] = value;

       // Auto-calculate amount if quantity or unitPrice changes
       if (field === "quantity" || field === "unitPrice") {
         const qty = parseFloat(updated[index].quantity || "0");
         const price = parseFloat(updated[index].unitPrice || "0");
         updated[index].amount = (qty * price).toFixed(2);
       }

       setLineItems(updated);
     };

     // Calculate subtotal from line items
     useEffect(() => {
       const subtotal = lineItems.reduce((sum, item) => {
         return sum + parseFloat(item.amount || "0");
       }, 0);
       setFormData({ ...formData, subtotal: subtotal.toFixed(2) });
     }, [lineItems]);

     return (
       <Accordion
         type="multiple"
         value={openItems}
         onValueChange={setOpenItems}
         className="space-y-2"
       >
         {/* Accordion 1: Informations générales */}
         {/* Accordion 2: Client */}
         {/* Accordion 3: Montants */}
         {/* Accordion 4: Acompte (Deposit) */}
         {/* Accordion 5: Lignes de facture */}
       </Accordion>
     );
   }
   ```

2. **Accordion 1: Informations générales** (invoiceNumber, issueDate, dueDate, status)
   ```typescript
   <AccordionItem value="infos">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <FileText className="h-5 w-5 text-primary" />
           Informations générales
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           <div className="grid md:grid-cols-2 gap-3">
             <div>
               <Label htmlFor="invoiceNumber">
                 Numéro de facture <span className="text-destructive">*</span>
               </Label>
               <Input
                 id="invoiceNumber"
                 className="mt-1"
                 value={formData.invoiceNumber || ""}
                 onChange={(e) => setFormData({ ...formData, invoiceNumber: e.target.value })}
                 placeholder="INV-2024-001"
               />
             </div>
             <div>
               <Label htmlFor="status">Statut</Label>
               <Select
                 value={formData.status || "draft"}
                 onValueChange={(value) => setFormData({ ...formData, status: value })}
               >
                 <SelectTrigger id="status" className="mt-1">
                   <SelectValue />
                 </SelectTrigger>
                 <SelectContent>
                   <SelectItem value="draft">Brouillon</SelectItem>
                   <SelectItem value="sent">Envoyée</SelectItem>
                   <SelectItem value="paid">Payée</SelectItem>
                   <SelectItem value="overdue">En retard</SelectItem>
                   <SelectItem value="cancelled">Annulée</SelectItem>
                 </SelectContent>
               </Select>
             </div>
           </div>

           <div className="grid md:grid-cols-2 gap-3">
             <div>
               <Label htmlFor="issueDate">
                 Date d'émission <span className="text-destructive">*</span>
               </Label>
               <Input
                 id="issueDate"
                 type="date"
                 className="mt-1"
                 value={formData.issueDate || ""}
                 onChange={(e) => setFormData({ ...formData, issueDate: e.target.value })}
               />
             </div>
             <div>
               <Label htmlFor="dueDate">Date d'échéance</Label>
               <Input
                 id="dueDate"
                 type="date"
                 className="mt-1"
                 value={formData.dueDate || ""}
                 onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })}
               />
             </div>
           </div>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

3. **Accordion 2: Client** (clientId selection)
   ```typescript
   <AccordionItem value="client">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <User className="h-5 w-5 text-primary" />
           Client
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           <div>
             <Label htmlFor="clientId">
               Client <span className="text-destructive">*</span>
             </Label>
             <Select
               value={formData.clientId?.toString() || ""}
               onValueChange={(value) => setFormData({ ...formData, clientId: parseInt(value) })}
             >
               <SelectTrigger id="clientId" className="mt-1">
                 <SelectValue placeholder="Sélectionner un client" />
               </SelectTrigger>
               <SelectContent>
                 {clients?.map((client) => (
                   <SelectItem key={client.id} value={client.id.toString()}>
                     {client.name}
                   </SelectItem>
                 ))}
               </SelectContent>
             </Select>
           </div>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

4. **Accordion 3: Montants** (subtotal, taxRate, taxAmount, total - calculated fields)
   ```typescript
   <AccordionItem value="montants">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <DollarSign className="h-5 w-5 text-primary" />
           Montants
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           <div className="grid md:grid-cols-2 gap-3">
             <div>
               <Label htmlFor="subtotal">Sous-total (€)</Label>
               <Input
                 id="subtotal"
                 type="text"
                 className="mt-1 bg-muted"
                 value={formData.subtotal || "0.00"}
                 readOnly
                 disabled
               />
               <p className="text-xs text-muted-foreground mt-1">Calculé depuis les lignes de facture</p>
             </div>
             <div>
               <Label htmlFor="taxRate">Taux de TVA (%)</Label>
               <Input
                 id="taxRate"
                 type="text"
                 className="mt-1"
                 value={formData.taxRate || "20"}
                 onChange={(e) => setFormData({ ...formData, taxRate: e.target.value })}
                 placeholder="20"
               />
             </div>
           </div>

           <div className="grid md:grid-cols-2 gap-3">
             <div>
               <Label htmlFor="taxAmount">Montant TVA (€)</Label>
               <Input
                 id="taxAmount"
                 type="text"
                 className="mt-1 bg-muted"
                 value={(parseFloat(formData.subtotal || "0") * parseFloat(formData.taxRate || "0") / 100).toFixed(2)}
                 readOnly
                 disabled
               />
               <p className="text-xs text-muted-foreground mt-1">Calculé automatiquement</p>
             </div>
             <div>
               <Label htmlFor="total">Total TTC (€)</Label>
               <Input
                 id="total"
                 type="text"
                 className="mt-1 bg-muted font-bold"
                 value={(parseFloat(formData.subtotal || "0") * (1 + parseFloat(formData.taxRate || "0") / 100)).toFixed(2)}
                 readOnly
                 disabled
               />
               <p className="text-xs text-muted-foreground mt-1">Sous-total + TVA</p>
             </div>
           </div>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

5. **Accordion 4: Acompte** (depositAmount, depositPaidAt, remainingBalance)
   ```typescript
   <AccordionItem value="acompte">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <CreditCard className="h-5 w-5 text-primary" />
           Acompte
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           <div>
             <Label htmlFor="depositAmount">Montant de l'acompte (€)</Label>
             <Input
               id="depositAmount"
               type="text"
               className="mt-1"
               value={formData.depositAmount || ""}
               onChange={(e) => setFormData({ ...formData, depositAmount: e.target.value })}
               placeholder="0.00"
             />
             <p className="text-xs text-muted-foreground mt-1">Optionnel - Acompte demandé au client</p>
           </div>

           <div>
             <Label htmlFor="depositPaidAt">Date de paiement de l'acompte</Label>
             <Input
               id="depositPaidAt"
               type="datetime-local"
               className="mt-1"
               value={formData.depositPaidAt || ""}
               onChange={(e) => setFormData({ ...formData, depositPaidAt: e.target.value })}
             />
             <p className="text-xs text-muted-foreground mt-1">Laisser vide si non payé</p>
           </div>

           {formData.depositAmount && (
             <div>
               <Label htmlFor="remainingBalance">Solde restant (€)</Label>
               <Input
                 id="remainingBalance"
                 type="text"
                 className="mt-1 bg-muted font-semibold"
                 value={(parseFloat(formData.total || "0") - parseFloat(formData.depositAmount || "0")).toFixed(2)}
                 readOnly
                 disabled
               />
               <p className="text-xs text-muted-foreground mt-1">Calculé: Total - Acompte</p>
             </div>
           )}
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

6. **Accordion 5: Lignes de facture** (line items array with add/remove)
   ```typescript
   <AccordionItem value="lignes">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <List className="h-5 w-5 text-primary" />
           Lignes de facture
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           {lineItems.map((item, index) => (
             <div key={index} className="border rounded-md p-3 space-y-3">
               <div className="flex items-center justify-between">
                 <h4 className="text-sm font-medium">Ligne {index + 1}</h4>
                 {lineItems.length > 1 && (
                   <Button
                     type="button"
                     variant="ghost"
                     size="sm"
                     onClick={() => removeLineItem(index)}
                   >
                     <Trash2 className="h-4 w-4 text-destructive" />
                   </Button>
                 )}
               </div>

               <div>
                 <Label htmlFor={`description-${index}`}>Description</Label>
                 <Input
                   id={`description-${index}`}
                   className="mt-1"
                   value={item.description}
                   onChange={(e) => updateLineItem(index, "description", e.target.value)}
                   placeholder="Studio session - 4 heures"
                 />
               </div>

               <div className="grid md:grid-cols-3 gap-3">
                 <div>
                   <Label htmlFor={`quantity-${index}`}>Quantité</Label>
                   <Input
                     id={`quantity-${index}`}
                     type="text"
                     className="mt-1"
                     value={item.quantity}
                     onChange={(e) => updateLineItem(index, "quantity", e.target.value)}
                     placeholder="1.00"
                   />
                 </div>
                 <div>
                   <Label htmlFor={`unitPrice-${index}`}>Prix unitaire (€)</Label>
                   <Input
                     id={`unitPrice-${index}`}
                     type="text"
                     className="mt-1"
                     value={item.unitPrice}
                     onChange={(e) => updateLineItem(index, "unitPrice", e.target.value)}
                     placeholder="100.00"
                   />
                 </div>
                 <div>
                   <Label htmlFor={`amount-${index}`}>Montant (€)</Label>
                   <Input
                     id={`amount-${index}`}
                     type="text"
                     className="mt-1 bg-muted"
                     value={item.amount}
                     readOnly
                     disabled
                   />
                 </div>
               </div>
             </div>
           ))}

           <Button
             type="button"
             variant="outline"
             onClick={addLineItem}
             className="w-full"
           >
             <Plus className="h-4 w-4 mr-2" />
             Ajouter une ligne
           </Button>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

7. **Notes section** (outside accordions, like TalentEditForm)
   ```typescript
   <Card className="mt-2">
     <div className="p-4 space-y-3">
       <Label htmlFor="notes">Notes internes</Label>
       <Textarea
         id="notes"
         className="mt-1 min-h-[80px]"
         value={formData.notes || ""}
         onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
         placeholder="Notes additionnelles..."
       />
     </div>
   </Card>
   ```

**Key features:**
- 5 accordions (Informations générales, Client, Montants, Acompte, Lignes de facture)
- Line items management with add/remove buttons
- Auto-calculation: line amount (qty × price), subtotal (sum of lines), taxAmount, total, remainingBalance
- Readonly calculated fields (subtotal, taxAmount, total, remainingBalance)
- localStorage persistence for accordion state
- Alt+Click toggle all accordions

**Why accordion pattern:** Complex form with many fields, logical grouping, matches Client/Talent harmonization from Phases 26-28
  </action>
  <verify>
1. Component exports InvoiceEditForm
2. TypeScript 0 errors on component definition
3. All 5 accordions render correctly
4. Line items add/remove functionality works
5. Auto-calculations update correctly (amount, subtotal, tax, total)
6. localStorage persistence works (invoiceEditAccordions key)
7. Alt+Click toggles all accordions
  </verify>
  <done>
- InvoiceEditForm.tsx created with 5 accordions
- Line items management integrated
- Auto-calculation for amounts, tax, total
- Deposit (acompte) fields with remaining balance
- All accordions open by default
- localStorage persistence for accordion state
- Alt+Click toggle all feature
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor InvoiceCreate.tsx to use InvoiceEditForm</name>
  <files>packages/client/src/pages/InvoiceCreate.tsx</files>
  <action>
**Pattern reference:** TalentCreate.tsx after Phase 28-05 refactor - reusable form component

**Simplify creation page:**

1. **Import InvoiceEditForm:**
   ```typescript
   import { InvoiceEditForm } from "@/components/InvoiceEditForm";
   ```

2. **Update formData state to include all invoice fields:**
   ```typescript
   const [formData, setFormData] = useState({
     clientId: 0,
     invoiceNumber: "",
     issueDate: "",
     dueDate: "",
     subtotal: "0.00",
     taxRate: "20",
     taxAmount: "0.00",
     total: "0.00",
     status: "draft" as const,
     depositAmount: "",
     depositPaidAt: "",
     remainingBalance: "",
     notes: "",
   });
   ```

3. **Replace entire Card with inline form (lines ~99-244) with InvoiceEditForm:**
   ```typescript
   return (
     <div className="container pt-2 pb-4 px-2">
       <div className="space-y-2">
         {/* Header */}
         <div className="flex items-center justify-between">
           <div className="flex items-center gap-4">
             <Link to="/invoices">
               <Button variant="ghost" size="icon">
                 <ArrowLeft className="h-5 w-5" />
               </Button>
             </Link>
             <div>
               <h1 className="text-3xl font-bold flex items-center gap-2">
                 <FileText className="h-8 w-8 text-primary" />
                 Nouvelle Facture
               </h1>
               <p className="text-muted-foreground">Créer une nouvelle facture client</p>
             </div>
           </div>
         </div>

         {/* Form */}
         <form onSubmit={handleSubmit}>
           <InvoiceEditForm
             formData={formData}
             setFormData={setFormData}
           />

           {/* Submit button */}
           <div className="mt-4 flex justify-end gap-2">
             <Button type="button" variant="outline" asChild>
               <Link to="/invoices">Annuler</Link>
             </Button>
             <Button type="submit" disabled={createMutation.isPending}>
               <Save className="h-4 w-4 mr-2" />
               {createMutation.isPending ? "Création..." : "Créer la facture"}
             </Button>
           </div>
         </form>
       </div>
     </div>
   );
   ```

4. **Update handleSubmit to use new formData fields:**
   ```typescript
   const handleSubmit = (e: React.FormEvent) => {
     e.preventDefault();

     // Validation
     if (!formData.clientId) {
       toast.error("Le client est requis");
       return;
     }
     if (!formData.invoiceNumber.trim()) {
       toast.error("Le numéro de facture est requis");
       return;
     }
     if (!formData.issueDate) {
       toast.error("La date d'émission est requise");
       return;
     }
     if (!formData.subtotal || parseFloat(formData.subtotal) <= 0) {
       toast.error("Le sous-total doit être supérieur à 0");
       return;
     }

     // Submit
     createMutation.mutate({
       clientId: formData.clientId,
       invoiceNumber: formData.invoiceNumber,
       issueDate: new Date(formData.issueDate).toISOString(),
       dueDate: formData.dueDate ? new Date(formData.dueDate).toISOString() : undefined,
       subtotal: formData.subtotal,
       taxRate: formData.taxRate || undefined,
       status: formData.status,
       depositAmount: formData.depositAmount || undefined,
       depositPaidAt: formData.depositPaidAt ? new Date(formData.depositPaidAt).toISOString() : undefined,
       notes: formData.notes || undefined,
     });
   };
   ```

**Result:** InvoiceCreate.tsx reduces from ~250 lines to ~120 lines, reuses InvoiceEditForm component

**Benefits:**
- DRY principle (single form component for create + edit)
- Consistency (same UI for creation and editing)
- Line items management built-in
- Auto-calculation handled by component
- Maintainability (form changes only in InvoiceEditForm.tsx)
  </action>
  <verify>
1. Navigate to /invoices/new
2. InvoiceEditForm renders with 5 accordions
3. Fill invoice fields (client, invoiceNumber, issueDate required)
4. Add line items using "Ajouter une ligne" button
5. Verify auto-calculations update (subtotal, tax, total)
6. Click "Créer la facture" - createMutation fires
7. Successful creation redirects to detail page
8. TypeScript 0 errors
  </verify>
  <done>
- InvoiceCreate.tsx refactored to use InvoiceEditForm
- Page simplified to ~120 lines (from ~250)
- Reusable form component for create + edit
- Line items management integrated
- Submit button with validation
- TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and verify harmonization complete</name>
  <files>packages/client/src/components/InvoiceEditForm.tsx, packages/client/src/pages/InvoiceCreate.tsx</files>
  <action>
**Final verification steps:**

1. **TypeScript check:**
   ```bash
   pnpm --filter client check
   ```

2. **Build test:**
   ```bash
   pnpm --filter client build
   ```

3. **Test complete workflow:**
   - Visit /invoices/new → create invoice with InvoiceEditForm
   - Add multiple line items → verify subtotal calculation
   - Set tax rate → verify tax amount and total calculation
   - Add deposit amount → verify remaining balance calculation
   - Submit form → verify invoice created successfully

4. **Document completion in commit:**
   ```bash
   git add packages/client/src/components/InvoiceEditForm.tsx packages/client/src/pages/InvoiceCreate.tsx
   git commit -m "feat(35-01): create InvoiceEditForm accordion component

Phase 35: Invoice Harmonization
- Created InvoiceEditForm component (5 accordions: Informations générales, Client, Montants, Acompte, Lignes de facture)
- Refactored InvoiceCreate.tsx to use InvoiceEditForm (~120 lines from ~250)
- Line items management with add/remove functionality
- Auto-calculation: line amount, subtotal, tax, total, remaining balance
- Readonly calculated fields (subtotal, taxAmount, total, remainingBalance)
- All accordions open by default (Alt+Click toggle all)
- localStorage persistence for accordion state

Pattern: Reusable accordion form (Phase 28 TalentEditForm pattern)
Benefits: DRY, consistency, maintainability, complex field handling

Phase 35 COMPLETE: Invoice UI harmonized with Client/Talent/Service patterns

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
   ```

**Success indicators:**
- ✓ Build successful (zero errors)
- ✓ TypeScript passes
- ✓ Create workflow functional
- ✓ Line items add/remove working
- ✓ Auto-calculations accurate
- ✓ Accordion pattern adopted
- ✓ Phase 35 complete
  </action>
  <verify>
1. TypeScript check passes (0 errors)
2. Build completes successfully
3. No console errors in create workflow
4. All 5 accordions functional
5. Line items management working
6. Auto-calculations correct (subtotal, tax, total, deposit balance)
7. Form state synchronization working
8. Git commit created with Phase 35 completion message
  </verify>
  <done>
- TypeScript 0 errors confirmed
- Production build successful
- InvoiceEditForm harmonized with Client/Talent/Service patterns
- Inline form eliminated (Phase 35 goal achieved)
- Line items management integrated
- Auto-calculation feature working
- Phase 35 complete
- Invoice UI harmonized with accordion pattern
  </done>
</task>

</tasks>

<verification>
**Phase 35 Complete Verification:**

1. **InvoiceEditForm component:**
   - [x] 5 accordions (Informations générales, Client, Montants, Acompte, Lignes de facture)
   - [x] All accordions open by default
   - [x] localStorage persistence for accordion state
   - [x] Alt+Click toggle all accordions
   - [x] Line items add/remove functionality
   - [x] Auto-calculation for amounts, tax, total, deposit balance

2. **InvoiceCreate.tsx refactor:**
   - [x] Uses InvoiceEditForm component
   - [x] Reduced from ~250 lines to ~120 lines
   - [x] Submit button with validation
   - [x] Successful creation workflow

3. **Harmonization achieved:**
   - [x] Consistent with ClientEditForm (Phase 26)
   - [x] Consistent with TalentEditForm (Phase 28)
   - [x] Accordion pattern throughout application
   - [x] DRY principle maintained
</verification>

<success_criteria>
- [ ] InvoiceEditForm component created with 5 accordions
- [ ] Line items management with add/remove buttons
- [ ] Auto-calculation for line amount, subtotal, tax, total, remaining balance
- [ ] Readonly calculated fields prevent manual editing
- [ ] All accordions open by default with localStorage persistence
- [ ] Alt+Click toggles all accordions
- [ ] InvoiceCreate.tsx refactored to use InvoiceEditForm (~120 lines)
- [ ] Inline form eliminated from creation flow
- [ ] TypeScript 0 errors
- [ ] Client builds successfully
- [ ] Create workflow functional with all features
- [ ] Phase 35 complete: Invoice UI harmonized with Client/Talent/Service patterns
</success_criteria>

<output>
After completion, create `.planning/phases/35-harmonisation-invoices---routing-cohérent/35-01-SUMMARY.md`
</output>
