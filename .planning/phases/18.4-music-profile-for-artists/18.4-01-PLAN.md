---
phase: 18.4-music-profile-for-artists
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/tenant/schema.ts
  - drizzle/migrations/tenant/XXXX_add_music_profile_fields.sql
autonomous: true

must_haves:
  truths:
    - "Artists have genre, instrument, and skill level fields in database"
    - "Streaming platform URLs can be stored (Spotify, Apple Music, etc.)"
    - "Industry information (label, manager) can be recorded"
    - "New tenant databases include music profile columns"
    - "Migration applies cleanly to fresh tenants"
  artifacts:
    - path: "packages/database/src/tenant/schema.ts"
      provides: "Extended clients table with 15 music profile columns"
      contains: "genres: jsonb"
      min_lines: 70
    - path: "drizzle/migrations/tenant/XXXX_add_music_profile_fields.sql"
      provides: "Migration SQL with GIN indexes"
      contains: "CREATE INDEX idx_clients_genres_gin"
  key_links:
    - from: "packages/database/src/tenant/schema.ts"
      to: "drizzle/migrations/tenant/"
      via: "pnpm db:generate"
      pattern: "ALTER TABLE clients ADD COLUMN"
---

<objective>
Extend the clients database schema with comprehensive music profile fields for recording studio artist management.

Purpose: Address BUG-006 (P1 severity) - critical missing music-related information for artist clients. Recording studio app needs genre, instruments, streaming links, and industry info.

Output: 15 new nullable columns in clients table (3 JSONB arrays, 12 varchar/text), migration generated, applied to new tenant database using increment pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18.4-music-profile-for-artists/18.4-RESEARCH.md
@.planning/DEVELOPMENT-WORKFLOW.md

# Current schema
@packages/database/src/tenant/schema.ts

# Reference: vCard enrichment pattern (similar JSONB usage)
# See lines 41-49 for phones/emails/websites JSONB arrays
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend clients schema with music profile fields</name>
  <files>packages/database/src/tenant/schema.ts</files>
  <action>
Add 15 new nullable columns to the `clients` table definition (around line 50, after `customFields`):

**JSONB Arrays (multi-value fields):**
```typescript
// Music Profile - JSONB Arrays
genres: jsonb("genres").$type<string[]>().default([]),
subGenres: jsonb("sub_genres").$type<string[]>().default([]),
instruments: jsonb("instruments").$type<Array<{
  name: string;
  proficiency: 'beginner' | 'intermediate' | 'pro';
}>>().default([]),
```

**Single Value Fields:**
```typescript
// Music Profile - Single Values
vocalRange: varchar("vocal_range", { length: 50 }), // soprano, alto, tenor, baritone, bass
skillLevel: varchar("skill_level", { length: 50 }), // beginner, intermediate, pro, expert

// Streaming Platforms (nullable URLs)
spotifyUrl: varchar("spotify_url", { length: 500 }),
appleMusicUrl: varchar("apple_music_url", { length: 500 }),
soundcloudUrl: varchar("soundcloud_url", { length: 500 }),
youtubeUrl: varchar("youtube_url", { length: 500 }),
bandcampUrl: varchar("bandcamp_url", { length: 500 }),
deezerUrl: varchar("deezer_url", { length: 500 }),

// Industry Information
recordLabel: varchar("record_label", { length: 255 }),
distributor: varchar("distributor", { length: 255 }),
managerName: varchar("manager_name", { length: 255 }),
managerContact: varchar("manager_contact", { length: 255 }), // Email or phone
publisher: varchar("publisher", { length: 255 }),
performanceRightsSociety: varchar("performance_rights_society", { length: 100 }), // SACEM, SOCAN, BMI, ASCAP
```

**CRITICAL:** All columns MUST be nullable (no `.notNull()`) for backward compatibility. Existing clients work without music profile.

**WHY nullable:** Prevents breaking existing client records. Users can add music profile later. Not all clients are artists (some are companies/labels).

**IMPORTANT:** Add these fields BEFORE the `createdAt` and `updatedAt` timestamp fields to maintain logical grouping.
  </action>
  <verify>
1. Run `pnpm check` in project root - TypeScript should compile with 0 errors
2. Check schema.ts lines 50-80 contain all 15 new columns
3. Verify JSONB types use `.$type<T[]>()` pattern (matches existing phones/emails pattern)
4. Confirm no `.notNull()` constraints on music profile fields
  </verify>
  <done>Schema extended with 15 music profile columns, TypeScript compiles successfully, backward compatible (all nullable)</done>
</task>

<task type="auto">
  <name>Task 2: Generate migration and apply to new tenant</name>
  <files>drizzle/migrations/tenant/XXXX_add_music_profile_fields.sql</files>
  <action>
**Step 1: Generate migration**
```bash
cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid
pnpm db:generate
```

This creates migration SQL in `drizzle/migrations/tenant/XXXX_add_music_profile_fields.sql`.

**Step 2: Review migration file**
Open the generated migration and verify it contains:
- 15 `ALTER TABLE clients ADD COLUMN` statements
- GIN indexes for JSONB arrays (if Drizzle generates them automatically)

**Step 3: Manually add GIN indexes** (if not auto-generated)
Add to migration file:
```sql
-- GIN indexes for JSONB array filtering performance
CREATE INDEX IF NOT EXISTS idx_clients_genres_gin ON clients USING GIN (genres jsonb_ops);
CREATE INDEX IF NOT EXISTS idx_clients_instruments_gin ON clients USING GIN (instruments jsonb_ops);
```

**WHY GIN indexes:** Enable fast filtering by genre/instrument using PostgreSQL `@>` containment operator. Without indexes, queries scan entire table.

**Step 4: Apply to NEW tenant (increment pattern)**
Following DEVELOPMENT-WORKFLOW.md critical pattern:
```bash
# DO NOT fix existing tenant migrations - increment tenant number
# This is 30 seconds vs 2-3 hours debugging

# 1. Create tenant_4 (or next available tenant number)
# New tenant automatically applies ALL migrations including new one
# 2. Seed test data to tenant_4
# 3. Update dev headers to use tenant_4

# Check existing tenants
psql -U postgres -d rsm_master -c "SELECT id, database_name FROM tenant_databases ORDER BY id;"

# Create tenant_4 (migrations auto-apply)
# Use existing seed script or create new organization via app
```

**IMPORTANT:** Do NOT try to apply migration to tenant_1, tenant_2, tenant_3. Use increment tenant pattern per project workflow.

**Alternative (if production tenants exist):** Create separate script to apply migration to production tenants, but NOT needed for Phase 18.4 (development only).
  </action>
  <verify>
1. Check migration file exists: `ls drizzle/migrations/tenant/ | grep "add_music_profile"`
2. Count lines in migration: Should have ~17-20 ALTER TABLE + CREATE INDEX statements
3. Verify GIN indexes present in migration (search for "idx_clients_genres_gin")
4. Create tenant_4 and verify columns exist:
   ```bash
   psql -U postgres -d tenant_4 -c "\d clients" | grep "genres"
   psql -U postgres -d tenant_4 -c "\d clients" | grep "spotify_url"
   psql -U postgres -d tenant_4 -c "\di" | grep "idx_clients_genres_gin"
   ```
5. Confirm 15 new columns present in tenant_4 clients table
  </verify>
  <done>Migration generated with 15 ALTER TABLE statements + 2 GIN indexes, applied to tenant_4, music profile columns visible in database schema</done>
</task>

</tasks>

<verification>
**Overall Phase 18.4-01 Checks:**

1. **Schema Validation:**
   - `pnpm check` passes (0 TypeScript errors)
   - All 15 columns defined in schema.ts
   - JSONB arrays use correct `.$type<T[]>()` syntax
   - All music profile fields are nullable

2. **Migration Validation:**
   - Migration file generated in drizzle/migrations/tenant/
   - GIN indexes created for genres and instruments
   - Migration SQL is valid PostgreSQL

3. **Database Validation (tenant_4):**
   - tenant_4 database exists with music profile columns
   - `\d clients` shows 15 new columns
   - `\di` shows 2 new GIN indexes (idx_clients_genres_gin, idx_clients_instruments_gin)

4. **Backward Compatibility:**
   - Existing client records still load (nullable columns)
   - No breaking changes to API/UI (columns optional)

**Success Criteria:**
✅ 15 music profile columns added to schema
✅ Migration generated and applied to new tenant
✅ GIN indexes created for JSONB array filtering
✅ Backward compatible (all nullable)
✅ TypeScript compiles with 0 errors
✅ Ready for Wave 2 UI integration
</verification>

<success_criteria>
**Measurable Completion:**

1. Schema extended: 15 new columns in packages/database/src/tenant/schema.ts
2. Migration exists: drizzle/migrations/tenant/XXXX_add_music_profile_fields.sql
3. Database ready: tenant_4 (or next available) has music profile columns
4. Indexes created: idx_clients_genres_gin and idx_clients_instruments_gin exist
5. Zero errors: `pnpm check` passes
6. Backward compatible: Existing clients unaffected

**Phase 18.4-01 is complete when:**
- Database schema supports music profile fields
- Migration applies cleanly to new tenants
- Ready for UI integration (Wave 2)
</success_criteria>

<output>
After completion, create `.planning/phases/18.4-music-profile-for-artists/18.4-01-SUMMARY.md` documenting:
- Schema changes (15 columns added)
- Migration file location and GIN indexes
- Tenant database incremented to (e.g., tenant_4)
- Backward compatibility notes
- Time taken
- Any issues encountered
</output>
