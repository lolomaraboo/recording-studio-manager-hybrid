---
phase: 39-gestion-tva-multi-taux
plan: 05
type: execute
wave: 4
depends_on: ["39-03"]
files_modified:
  - packages/client/src/pages/Invoices.tsx
  - packages/client/src/pages/Quotes.tsx
  - packages/server/src/routers/invoices.ts
  - packages/server/src/routers/quotes.ts
autonomous: false

must_haves:
  truths:
    - "Invoice form shows VAT rate dropdown per line item (not header-level)"
    - "Quote form shows VAT rate dropdown per line item (not header-level)"
    - "Dropdown defaults to organization's default VAT rate"
    - "Total calculation uses line-item VAT rates correctly"
    - "Invoice PDF displays correct VAT per line item"
    - "Historical invoices/quotes display correctly (preserved data)"
  artifacts:
    - path: "packages/client/src/pages/Invoices.tsx"
      provides: "Invoice form with per-line VAT rate selection"
      contains: "vatRateId"
    - path: "packages/server/src/routers/invoices.ts"
      provides: "Updated invoice creation/update with vatRateId validation"
      contains: "vatRateId.*z.number"
  key_links:
    - from: "packages/client/src/pages/Invoices.tsx"
      to: "trpc.vatRates.list"
      via: "fetch rates for dropdown"
      pattern: "trpc\\.vatRates\\.list"
    - from: "packages/server/src/routers/invoices.ts"
      to: "invoiceItems.vatRateId"
      via: "insert with FK validation"
      pattern: "vatRateId.*input"
---

<objective>
Update invoice and quote forms to use line-item VAT rates instead of header-level VAT.

Purpose: Enable mixed-rate invoicing (e.g., 20% for services, 10% for physical media) and provide users with granular VAT control per line item. This completes the VAT system migration from header-level to line-item level.

Output:
- Invoice form with VAT rate dropdown per line item
- Quote form with VAT rate dropdown per line item
- Backend validation requiring vatRateId on all line items
- Total calculation logic updated to sum per-line VAT amounts
- PDF generation updated to show VAT breakdown by rate
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/39-gestion-tva-multi-taux/39-RESEARCH.md
@.planning/phases/39-gestion-tva-multi-taux/39-03-PLAN.md
@packages/client/src/pages/Invoices.tsx
@packages/client/src/pages/Quotes.tsx
@packages/server/src/routers/invoices.ts
@packages/server/src/routers/quotes.ts
</context>

<tasks>

<task type="auto">
  <name>Update invoice backend to require vatRateId on line items</name>
  <files>
    packages/server/src/routers/invoices.ts
  </files>
  <action>
Update invoice creation/update procedures to:

1. **Add vatRateId to input schema:**
```typescript
// In create/update input schema for invoiceItems
items: z.array(z.object({
  description: z.string(),
  quantity: z.number(),
  unitPrice: z.number(),
  amount: z.number(),
  vatRateId: z.number(), // NEW - required
})),
```

2. **Update invoice calculation logic:**

Remove header-level taxRate/taxAmount calculation. Instead, calculate VAT per line item:

```typescript
// Calculate totals from line items (including their individual VAT rates)
let subtotal = 0;
let totalTax = 0;

for (const item of input.items) {
  subtotal += item.amount;

  // Fetch VAT rate for this item
  const vatRate = await tenantDb.query.vatRates.findFirst({
    where: eq(vatRates.id, item.vatRateId),
  });

  if (!vatRate) {
    throw new TRPCError({
      code: 'BAD_REQUEST',
      message: `Taux de TVA invalide (ID: ${item.vatRateId})`,
    });
  }

  const itemTax = item.amount * (parseFloat(vatRate.rate) / 100);
  totalTax += itemTax;
}

const total = subtotal + totalTax;
```

3. **Update invoice insert to include vatRateId:**
```typescript
// Insert invoice items with vatRateId
for (const item of input.items) {
  await tenantDb.insert(invoiceItems).values({
    invoiceId: newInvoice.id,
    description: item.description,
    quantity: item.quantity.toString(),
    unitPrice: item.unitPrice.toString(),
    amount: item.amount.toString(),
    vatRateId: item.vatRateId, // NEW
  });
}
```

4. **IMPORTANT - Header fields transition:**
- KEEP `invoices.taxRate` and `invoices.taxAmount` for now (for backward compatibility)
- Set them to weighted average rate and total tax for legacy display
- Future migration can remove these fields entirely

```typescript
// Weighted average tax rate for header (legacy compatibility)
const averageTaxRate = subtotal > 0 ? (totalTax / subtotal) * 100 : 0;

await tenantDb.insert(invoices).values({
  // ... other fields ...
  subtotal: subtotal.toFixed(2),
  taxRate: averageTaxRate.toFixed(2), // Weighted average
  taxAmount: totalTax.toFixed(2),
  total: total.toFixed(2),
});
```
  </action>
  <verify>
grep "vatRateId: z.number()" packages/server/src/routers/invoices.ts
pnpm --filter server check
  </verify>
  <done>
Invoice router updated to require vatRateId on each line item, calculate VAT per item, and validate rates exist. Header fields preserved for backward compatibility.
  </done>
</task>

<task type="auto">
  <name>Update quote backend to require vatRateId on line items</name>
  <files>
    packages/server/src/routers/quotes.ts
  </files>
  <action>
Apply same changes as invoices to quotes router:

1. **Add vatRateId to quoteItems input schema**
2. **Update quote calculation logic** (per-line VAT)
3. **Update quoteItems insert** (include vatRateId)
4. **Keep header fields** (quotes.taxRate, quotes.taxAmount) with weighted average

Follow exact same pattern as Task 1 but for quotes table/quoteItems table.

```typescript
// Example for quotes
items: z.array(z.object({
  description: z.string(),
  quantity: z.number(),
  unitPrice: z.number(),
  amount: z.number(),
  vatRateId: z.number(), // Required
  displayOrder: z.number().optional(),
})),
```
  </action>
  <verify>
grep "vatRateId: z.number()" packages/server/src/routers/quotes.ts
pnpm --filter server check
  </verify>
  <done>
Quote router updated to require vatRateId on each line item. Follows same pattern as invoices for consistency.
  </done>
</task>

<task type="auto">
  <name>Update invoice frontend form with per-line VAT rate dropdown</name>
  <files>
    packages/client/src/pages/Invoices.tsx
  </files>
  <action>
Update invoice form to show VAT rate dropdown on each line item:

1. **Fetch VAT rates at form level:**
```typescript
const { data: vatRates } = trpc.vatRates.list.useQuery();
const defaultVatRate = vatRates?.find(r => r.isDefault);
```

2. **Add vatRateId to line item state:**
```typescript
interface InvoiceItem {
  description: string;
  quantity: number;
  unitPrice: number;
  amount: number;
  vatRateId: number; // NEW
}
```

3. **Initialize with default VAT rate:**
```typescript
const addLineItem = () => {
  setItems([
    ...items,
    {
      description: '',
      quantity: 1,
      unitPrice: 0,
      amount: 0,
      vatRateId: defaultVatRate?.id || 1, // Use default
    },
  ]);
};
```

4. **Add VAT dropdown column to table:**
```typescript
<TableHead>TVA</TableHead>

// In body:
<TableCell>
  <Select
    value={item.vatRateId.toString()}
    onValueChange={(value) => {
      const updated = [...items];
      updated[index].vatRateId = parseInt(value);
      setItems(updated);
    }}
  >
    <SelectTrigger className="w-32">
      <SelectValue />
    </SelectTrigger>
    <SelectContent>
      {vatRates?.map((rate) => (
        <SelectItem key={rate.id} value={rate.id.toString()}>
          {rate.rate}%
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</TableCell>
```

5. **Update total calculation:**
```typescript
const calculateTotal = () => {
  let subtotal = 0;
  let totalTax = 0;

  items.forEach(item => {
    subtotal += item.amount;
    const rate = vatRates?.find(r => r.id === item.vatRateId);
    if (rate) {
      totalTax += item.amount * (parseFloat(rate.rate) / 100);
    }
  });

  return {
    subtotal,
    taxAmount: totalTax,
    total: subtotal + totalTax,
  };
};
```

6. **Update form submission:**
```typescript
const handleSubmit = () => {
  createInvoice.mutate({
    // ... other fields ...
    items: items.map(item => ({
      description: item.description,
      quantity: item.quantity,
      unitPrice: item.unitPrice,
      amount: item.amount,
      vatRateId: item.vatRateId, // Include in mutation
    })),
  });
};
```

**NOTE:** Remove header-level taxRate input field (no longer needed).
  </action>
  <verify>
grep "vatRateId" packages/client/src/pages/Invoices.tsx
pnpm --filter client check
  </verify>
  <done>
Invoice form updated with per-line VAT dropdown. Default rate pre-selected on new items. Total calculation sums per-item VAT. Header taxRate field removed.
  </done>
</task>

<task type="auto">
  <name>Update quote frontend form with per-line VAT rate dropdown</name>
  <files>
    packages/client/src/pages/Quotes.tsx
  </files>
  <action>
Apply same changes as Task 3 to the quotes form:

1. Fetch VAT rates with `trpc.vatRates.list.useQuery()`
2. Add `vatRateId` to QuoteItem interface
3. Add VAT dropdown column to line items table
4. Initialize with default VAT rate
5. Update total calculation (per-line VAT)
6. Update form submission (include vatRateId)
7. Remove header-level taxRate input

Follow exact same pattern as Invoices.tsx for consistency.
  </action>
  <verify>
grep "vatRateId" packages/client/src/pages/Quotes.tsx
pnpm --filter client check
  </verify>
  <done>
Quote form updated with per-line VAT dropdown. Mirrors invoice form pattern for consistency.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Updated invoice and quote forms to use line-item VAT rates instead of header-level VAT. Each line item now has a dropdown to select VAT rate (20%, 10%, 5.5%, 2.1%, or custom rates). Total calculation sums per-item VAT amounts.
  </what-built>
  <how-to-verify>
1. Start the application:
   ```bash
   pnpm dev
   ```

2. **Test Invoice Creation with Mixed VAT Rates:**
   - Navigate to Invoices page
   - Click "New Invoice" or "Create Invoice"
   - Select a client
   - Add line item 1:
     - Description: "Recording session"
     - Quantity: 2
     - Unit Price: 100
     - VAT dropdown: Select "20%"
   - Add line item 2:
     - Description: "Physical CD"
     - Quantity: 5
     - Unit Price: 10
     - VAT dropdown: Select "10%"
   - Verify totals:
     - Subtotal: €250.00
     - Item 1 VAT: €40.00 (200 * 0.20)
     - Item 2 VAT: €5.00 (50 * 0.10)
     - Total VAT: €45.00
     - Total: €295.00
   - Submit invoice
   - Verify success toast

3. **Test Quote Creation:**
   - Navigate to Quotes page
   - Create new quote with mixed VAT rates
   - Verify same dropdown behavior
   - Verify totals calculate correctly

4. **Test Default VAT Rate:**
   - Create new invoice
   - Add line item
   - Verify VAT dropdown defaults to 20% (default rate)
   - Change to 10%
   - Add another line item
   - Verify new item also defaults to 20%

5. **Test Historical Data Display:**
   - View an existing invoice (created before migration)
   - Verify it displays correctly
   - Items should show their migrated VAT rate
   - Totals should match original amounts (no recalculation)

6. **Test Validation:**
   - Try to create invoice without selecting VAT on line item
   - Should see validation error

7. **Visual verification:**
   - VAT dropdown column is visible and readable
   - Dropdown is properly sized (w-32 or similar)
   - Labels are in French ("TVA")
   - Total breakdown shows tax amount clearly
  </how-to-verify>
  <resume-signal>
Type "approved" if invoice/quote creation with mixed VAT rates works correctly, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After completing all tasks and checkpoint approval:

1. **Backend validation:**
   - Invoice create/update requires vatRateId on items
   - Quote create/update requires vatRateId on items
   - Server validates VAT rate exists before accepting
   - TypeScript compilation passes

2. **Frontend functionality:**
   - Invoice form shows VAT dropdown per line
   - Quote form shows VAT dropdown per line
   - Dropdowns populate from trpc.vatRates.list
   - Default rate pre-selected on new items
   - Total calculation sums per-item VAT correctly

3. **Data integrity:**
   - Historical invoices/quotes display correctly
   - No data loss during migration
   - Mixed-rate invoices can be created
</verification>

<success_criteria>
- [ ] Invoice backend requires vatRateId on line items
- [ ] Quote backend requires vatRateId on line items
- [ ] Invoice form has VAT dropdown per line
- [ ] Quote form has VAT dropdown per line
- [ ] Dropdowns default to organization's default rate
- [ ] Total calculation uses per-line VAT rates
- [ ] Historical data displays correctly (no recalculation)
- [ ] Mixed-rate invoices can be created (20% + 10% items)
- [ ] TypeScript compilation passes (client + server)
- [ ] Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/39-gestion-tva-multi-taux/39-05-SUMMARY.md`
</output>
