---
phase: 39-gestion-tva-multi-taux
plan: 04
type: execute
wave: 3
depends_on: ["39-03"]
files_modified:
  - packages/client/src/pages/Settings.tsx
  - packages/client/src/components/vat/VatRatesSection.tsx
  - packages/client/src/components/vat/CreateVatRateDialog.tsx
  - packages/client/src/components/vat/EditVatRateDialog.tsx
autonomous: false

must_haves:
  truths:
    - "User can view list of active VAT rates in Settings"
    - "User can create new VAT rate with name and percentage"
    - "User can set a rate as default"
    - "User can archive unused VAT rates"
    - "User sees validation error when trying to archive rate in use"
    - "Default rate is visually indicated with badge"
  artifacts:
    - path: "packages/client/src/components/vat/VatRatesSection.tsx"
      provides: "VAT rates table with actions"
      min_lines: 150
    - path: "packages/client/src/components/vat/CreateVatRateDialog.tsx"
      provides: "Dialog form for creating VAT rates"
      min_lines: 80
    - path: "packages/client/src/pages/Settings.tsx"
      provides: "Settings page with VAT tab"
      contains: "VatRatesSection"
  key_links:
    - from: "packages/client/src/components/vat/VatRatesSection.tsx"
      to: "trpc.vatRates.list"
      via: "useQuery hook"
      pattern: "trpc\\.vatRates\\.list\\.useQuery"
    - from: "packages/client/src/components/vat/CreateVatRateDialog.tsx"
      to: "trpc.vatRates.create"
      via: "useMutation hook"
      pattern: "trpc\\.vatRates\\.create\\.useMutation"
---

<objective>
Create frontend UI for VAT rate management in Settings page with Finance tab.

Purpose: Provide organization administrators with a user-friendly interface to configure VAT rates, set defaults, and manage active/archived rates. Follows existing Settings page patterns for consistency.

Output:
- New "Finance" tab in Settings page
- VAT rates table showing all active rates with default badge
- Create/Edit dialogs with form validation
- Archive action with confirmation and error handling
- Set default action with optimistic UI update
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/39-gestion-tva-multi-taux/39-RESEARCH.md
@.planning/phases/39-gestion-tva-multi-taux/39-03-PLAN.md
@packages/client/src/pages/Settings.tsx
@packages/server/src/routers/vatRates.ts
</context>

<tasks>

<task type="auto">
  <name>Create VatRatesSection component</name>
  <files>
    packages/client/src/components/vat/VatRatesSection.tsx
  </files>
  <action>
Create comprehensive VAT rates management component following the pattern from 39-RESEARCH.md:

```typescript
/**
 * VAT Rates Section Component
 *
 * Displays table of VAT rates with actions:
 * - Create new rate
 * - Set default rate
 * - Edit rate name
 * - Archive rate
 */

import { useState } from 'react';
import { trpc } from '@/lib/trpc';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { MoreHorizontal, Plus, Star, Archive, Edit } from 'lucide-react';
import { CreateVatRateDialog } from './CreateVatRateDialog';
import { EditVatRateDialog } from './EditVatRateDialog';
import { useToast } from '@/hooks/use-toast';

export function VatRatesSection() {
  const { toast } = useToast();
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [editDialogOpen, setEditDialogOpen] = useState(false);
  const [editingRate, setEditingRate] = useState<any>(null);

  // Queries
  const { data: vatRates, isLoading } = trpc.vatRates.list.useQuery();
  const utils = trpc.useContext();

  // Mutations
  const setDefaultMutation = trpc.vatRates.setDefault.useMutation({
    onSuccess: () => {
      utils.vatRates.list.invalidate();
      toast({
        title: 'Taux par défaut modifié',
        description: 'Le nouveau taux par défaut a été enregistré.',
      });
    },
    onError: (error) => {
      toast({
        title: 'Erreur',
        description: error.message,
        variant: 'destructive',
      });
    },
  });

  const archiveMutation = trpc.vatRates.archive.useMutation({
    onSuccess: () => {
      utils.vatRates.list.invalidate();
      toast({
        title: 'Taux archivé',
        description: 'Le taux de TVA a été archivé avec succès.',
      });
    },
    onError: (error) => {
      toast({
        title: 'Impossible d\'archiver',
        description: error.message,
        variant: 'destructive',
      });
    },
  });

  const handleSetDefault = (id: number) => {
    setDefaultMutation.mutate({ id });
  };

  const handleArchive = (id: number, name: string) => {
    if (window.confirm(`Êtes-vous sûr de vouloir archiver le taux "${name}" ?`)) {
      archiveMutation.mutate({ id });
    }
  };

  const handleEdit = (rate: any) => {
    setEditingRate(rate);
    setEditDialogOpen(true);
  };

  if (isLoading) {
    return (
      <Card>
        <CardContent className="pt-6 text-center text-muted-foreground">
          Chargement...
        </CardContent>
      </Card>
    );
  }

  return (
    <>
      <Card>
        <CardHeader className="pb-3">
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="text-base">Taux de TVA</CardTitle>
              <CardDescription className="text-sm">
                Configurez les taux de TVA applicables à vos factures et devis
              </CardDescription>
            </div>
            <Button
              onClick={() => setCreateDialogOpen(true)}
              size="sm"
              className="gap-2"
            >
              <Plus className="h-4 w-4 text-primary" />
              Ajouter un taux
            </Button>
          </div>
        </CardHeader>
        <CardContent className="pt-0">
          {vatRates && vatRates.length > 0 ? (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Nom</TableHead>
                  <TableHead>Taux</TableHead>
                  <TableHead>Statut</TableHead>
                  <TableHead className="text-right">Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {vatRates.map((rate) => (
                  <TableRow key={rate.id}>
                    <TableCell className="font-medium">{rate.name}</TableCell>
                    <TableCell>{rate.rate}%</TableCell>
                    <TableCell>
                      {rate.isDefault && (
                        <Badge variant="default" className="gap-1">
                          <Star className="h-3 w-3 text-primary" />
                          Par défaut
                        </Badge>
                      )}
                    </TableCell>
                    <TableCell className="text-right">
                      <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                          <Button variant="ghost" size="sm">
                            <MoreHorizontal className="h-4 w-4 text-primary" />
                          </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                          {!rate.isDefault && (
                            <DropdownMenuItem
                              onClick={() => handleSetDefault(rate.id)}
                            >
                              <Star className="mr-2 h-4 w-4 text-primary" />
                              Définir par défaut
                            </DropdownMenuItem>
                          )}
                          <DropdownMenuItem onClick={() => handleEdit(rate)}>
                            <Edit className="mr-2 h-4 w-4 text-primary" />
                            Modifier le nom
                          </DropdownMenuItem>
                          <DropdownMenuItem
                            onClick={() => handleArchive(rate.id, rate.name)}
                            disabled={rate.isDefault}
                          >
                            <Archive className="mr-2 h-4 w-4 text-primary" />
                            Archiver
                          </DropdownMenuItem>
                        </DropdownMenuContent>
                      </DropdownMenu>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          ) : (
            <div className="py-8 text-center text-muted-foreground">
              Aucun taux de TVA configuré
            </div>
          )}
        </CardContent>
      </Card>

      <CreateVatRateDialog
        open={createDialogOpen}
        onOpenChange={setCreateDialogOpen}
      />

      {editingRate && (
        <EditVatRateDialog
          open={editDialogOpen}
          onOpenChange={setEditDialogOpen}
          rate={editingRate}
        />
      )}
    </>
  );
}
```

**UI Pattern Notes:**
- Follows existing Settings page Card/Table pattern
- Uses `text-primary` for icons (UI harmonization standard)
- Uses `pb-3` for CardHeader (standard spacing)
- Default rate cannot be archived (disabled in dropdown)
  </action>
  <verify>
grep "export function VatRatesSection" packages/client/src/components/vat/VatRatesSection.tsx
pnpm --filter client check
  </verify>
  <done>
VatRatesSection component created with table, dropdowns, and mutations. Follows UI harmonization patterns (text-primary icons, pb-3 spacing).
  </done>
</task>

<task type="auto">
  <name>Create dialog components for VAT rate creation and editing</name>
  <files>
    packages/client/src/components/vat/CreateVatRateDialog.tsx
    packages/client/src/components/vat/EditVatRateDialog.tsx
  </files>
  <action>
Create two dialog components for CRUD operations.

**CreateVatRateDialog.tsx:**
```typescript
import { useState } from 'react';
import { trpc } from '@/lib/trpc';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Switch } from '@/components/ui/switch';
import { useToast } from '@/hooks/use-toast';

interface CreateVatRateDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function CreateVatRateDialog({
  open,
  onOpenChange,
}: CreateVatRateDialogProps) {
  const { toast } = useToast();
  const [name, setName] = useState('');
  const [rate, setRate] = useState('');
  const [isDefault, setIsDefault] = useState(false);

  const utils = trpc.useContext();

  const createMutation = trpc.vatRates.create.useMutation({
    onSuccess: () => {
      utils.vatRates.list.invalidate();
      toast({
        title: 'Taux créé',
        description: 'Le nouveau taux de TVA a été créé avec succès.',
      });
      onOpenChange(false);
      // Reset form
      setName('');
      setRate('');
      setIsDefault(false);
    },
    onError: (error) => {
      toast({
        title: 'Erreur',
        description: error.message,
        variant: 'destructive',
      });
    },
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const rateNumber = parseFloat(rate);
    if (isNaN(rateNumber) || rateNumber < 0 || rateNumber > 100) {
      toast({
        title: 'Taux invalide',
        description: 'Le taux doit être un nombre entre 0 et 100.',
        variant: 'destructive',
      });
      return;
    }
    createMutation.mutate({ name, rate: rateNumber, isDefault });
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <form onSubmit={handleSubmit}>
          <DialogHeader>
            <DialogTitle>Nouveau taux de TVA</DialogTitle>
            <DialogDescription>
              Créez un nouveau taux de TVA pour votre organisation
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="name">Nom</Label>
              <Input
                id="name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="Ex: TVA Standard 20%"
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="rate">Taux (%)</Label>
              <Input
                id="rate"
                type="number"
                step="0.01"
                min="0"
                max="100"
                value={rate}
                onChange={(e) => setRate(e.target.value)}
                placeholder="20.00"
                required
              />
            </div>
            <div className="flex items-center space-x-2">
              <Switch
                id="isDefault"
                checked={isDefault}
                onCheckedChange={setIsDefault}
              />
              <Label htmlFor="isDefault">Définir comme taux par défaut</Label>
            </div>
          </div>
          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
            >
              Annuler
            </Button>
            <Button type="submit" disabled={createMutation.isPending}>
              {createMutation.isPending ? 'Création...' : 'Créer'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

**EditVatRateDialog.tsx:**
```typescript
import { useState, useEffect } from 'react';
import { trpc } from '@/lib/trpc';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useToast } from '@/hooks/use-toast';

interface EditVatRateDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  rate: { id: number; name: string; rate: string };
}

export function EditVatRateDialog({
  open,
  onOpenChange,
  rate,
}: EditVatRateDialogProps) {
  const { toast } = useToast();
  const [name, setName] = useState(rate.name);

  useEffect(() => {
    setName(rate.name);
  }, [rate]);

  const utils = trpc.useContext();

  const updateMutation = trpc.vatRates.update.useMutation({
    onSuccess: () => {
      utils.vatRates.list.invalidate();
      toast({
        title: 'Taux modifié',
        description: 'Le taux de TVA a été modifié avec succès.',
      });
      onOpenChange(false);
    },
    onError: (error) => {
      toast({
        title: 'Erreur',
        description: error.message,
        variant: 'destructive',
      });
    },
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    updateMutation.mutate({ id: rate.id, name });
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <form onSubmit={handleSubmit}>
          <DialogHeader>
            <DialogTitle>Modifier le taux de TVA</DialogTitle>
            <DialogDescription>
              Modifiez le nom du taux. Le pourcentage ne peut pas être modifié
              pour préserver l'historique.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="name">Nom</Label>
              <Input
                id="name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                required
              />
            </div>
            <div className="space-y-2">
              <Label>Taux actuel</Label>
              <div className="text-sm text-muted-foreground">{rate.rate}%</div>
            </div>
          </div>
          <DialogFooter>
            <Button
              type="button"
              variant="outline"
              onClick={() => onOpenChange(false)}
            >
              Annuler
            </Button>
            <Button type="submit" disabled={updateMutation.isPending}>
              {updateMutation.isPending ? 'Modification...' : 'Modifier'}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```
  </action>
  <verify>
ls packages/client/src/components/vat/CreateVatRateDialog.tsx
ls packages/client/src/components/vat/EditVatRateDialog.tsx
pnpm --filter client check
  </verify>
  <done>
Create and Edit dialogs created with form validation, error handling, and loading states. Edit dialog only allows name changes (rate is immutable).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
VAT rate management UI in Settings page with Finance tab. Includes:
- Table listing all active VAT rates
- "Add Rate" button opening creation dialog
- Dropdown actions for each rate (Set Default, Edit, Archive)
- Validation preventing archival of rates in use
- Default rate badge indicator
  </what-built>
  <how-to-verify>
1. Start the application:
   ```bash
   pnpm dev
   ```

2. Navigate to Settings page (http://localhost:5174/settings)

3. Click on "Finance" tab (or add it if not present - see task above)

4. Verify VAT Rates Section displays:
   - Card with title "Taux de TVA"
   - Table showing 4 default French rates (20%, 10%, 5.5%, 2.1%)
   - "TVA Standard 20%" has "Par défaut" badge with star icon
   - Each row has actions dropdown (3 dots)

5. Test Create Rate:
   - Click "Ajouter un taux" button
   - Dialog opens with form
   - Fill: Name = "TVA Test 15%", Taux = "15.00"
   - Click "Créer"
   - New rate appears in table
   - Toast notification confirms creation

6. Test Set Default:
   - Click actions dropdown on "TVA Test 15%"
   - Click "Définir par défaut"
   - Badge moves from 20% to 15%
   - Toast confirms change

7. Test Edit:
   - Click actions dropdown on "TVA Test 15%"
   - Click "Modifier le nom"
   - Change name to "TVA Custom 15%"
   - Click "Modifier"
   - Name updates in table

8. Test Archive (success case):
   - Click actions dropdown on "TVA Custom 15%"
   - Click "Archiver"
   - Confirm in popup
   - Rate disappears from active list
   - Toast confirms archival

9. Test Archive (failure case):
   - Try to archive "TVA Standard 20%" (default rate)
   - Action should be disabled in dropdown
   - If you create an invoice using a rate, then try to archive that rate
   - Should see error toast: "Impossible d'archiver : il est utilisé dans des factures actives"

10. Visual verification:
    - Icons use `text-primary` class (consistent with UI harmonization)
    - CardHeader has `pb-3` spacing
    - Table is responsive and readable
    - Dialogs are centered and accessible
  </how-to-verify>
  <resume-signal>
Type "approved" if all features work correctly, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
After completing all tasks and checkpoint approval:

1. **Component structure:**
   - VatRatesSection.tsx exists with table and mutations
   - CreateVatRateDialog.tsx exists with form
   - EditVatRateDialog.tsx exists with name-only editing
   - Settings page imports and renders VatRatesSection in Finance tab

2. **Functionality:**
   - List query displays all active rates
   - Create mutation adds new rate
   - SetDefault mutation updates default atomically
   - Archive mutation validates usage and soft-deletes
   - Edit mutation updates name only

3. **UI harmonization:**
   - Icons use `text-primary`
   - CardHeader uses `pb-3`
   - Follows existing Settings page patterns
</verification>

<success_criteria>
- [ ] VatRatesSection component created
- [ ] CreateVatRateDialog component created
- [ ] EditVatRateDialog component created
- [ ] Settings page has Finance tab with VatRatesSection
- [ ] User can view, create, edit, set default, and archive VAT rates
- [ ] Default rate shows badge with star icon
- [ ] Archive prevents deletion of rates in use
- [ ] UI follows harmonization patterns (text-primary, pb-3)
- [ ] TypeScript compilation passes
- [ ] Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/39-gestion-tva-multi-taux/39-04-SUMMARY.md`
</output>
