---
phase: 39-gestion-tva-multi-taux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/tenant/schema.ts
  - packages/database/migrations/0046_add_vat_rates.sql
  - packages/database/src/scripts/seed-vat-rates.ts
autonomous: true

must_haves:
  truths:
    - "vat_rates table exists in tenant databases"
    - "Four French VAT rates are auto-seeded on new tenants (20%, 10%, 5.5%, 2.1%)"
    - "invoiceItems have vatRateId foreign key (nullable during migration)"
    - "quoteItems have vatRateId foreign key (nullable during migration)"
    - "rooms have optional vatRateId"
    - "serviceCatalog uses vatRateId instead of taxRate"
  artifacts:
    - path: "packages/database/src/tenant/schema.ts"
      provides: "vat_rates table schema, FK additions to invoice/quote items, rooms, serviceCatalog"
      min_lines: 50
    - path: "packages/database/migrations/0046_add_vat_rates.sql"
      provides: "Migration creating vat_rates table and adding FK columns"
      contains: "CREATE TABLE vat_rates"
    - path: "packages/database/src/scripts/seed-vat-rates.ts"
      provides: "Idempotent seeding script for 4 French VAT rates"
      exports: ["DEFAULT_VAT_RATES"]
  key_links:
    - from: "packages/database/src/tenant/schema.ts"
      to: "invoiceItems.vatRateId references vatRates.id"
      via: "foreign key definition"
      pattern: "vatRateId.*references.*vatRates"
    - from: "packages/database/src/scripts/seed-vat-rates.ts"
      to: "getTenantDb"
      via: "import and function call"
      pattern: "getTenantDb"
---

<objective>
Create database schema for multi-rate VAT system with configurable rates per organization.

Purpose: Replace fixed 20% VAT with flexible, organization-configurable VAT rates per line item. This enables studios to handle different tax rates for different services (e.g., 20% for recording, 10% for physical media).

Output:
- `vat_rates` table in tenant schema
- Foreign keys on invoice/quote items, rooms, serviceCatalog
- Seed script that creates 4 French default rates (20%/10%/5.5%/2.1%)
- Migration file ready to apply
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-gestion-tva-multi-taux/39-RESEARCH.md
@packages/database/src/tenant/schema.ts
@packages/database/src/scripts/seed-task-types.ts
@packages/database/src/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Create vat_rates table and update schema</name>
  <files>
    packages/database/src/tenant/schema.ts
  </files>
  <action>
Add `vat_rates` table to tenant schema following the pattern from 39-RESEARCH.md:

**vat_rates table:**
```typescript
export const vatRates = pgTable("vat_rates", {
  id: serial("id").primaryKey(),
  name: varchar("name", { length: 100 }).notNull(),
  rate: decimal("rate", { precision: 5, scale: 2 }).notNull(),
  isDefault: boolean("is_default").notNull().default(false),
  isActive: boolean("is_active").notNull().default(true),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});
```

**Add FK to invoiceItems (nullable during migration):**
```typescript
vatRateId: integer("vat_rate_id").references(() => vatRates.id),
```

**Add FK to quoteItems (nullable during migration):**
```typescript
vatRateId: integer("vat_rate_id").references(() => vatRates.id),
```

**Add FK to rooms (optional - some rooms may not have VAT):**
```typescript
vatRateId: integer("vat_rate_id").references(() => vatRates.id),
```

**Replace serviceCatalog.taxRate with vatRateId (nullable during migration):**
- REMOVE: `taxRate: decimal("tax_rate", ...)`
- ADD: `vatRateId: integer("vat_rate_id").references(() => vatRates.id),`

**Add relations:**
```typescript
export const vatRatesRelations = relations(vatRates, ({ many }) => ({
  invoiceItems: many(invoiceItems),
  quoteItems: many(quoteItems),
  rooms: many(rooms),
  serviceCatalogItems: many(serviceCatalog),
}));
```

Update existing relations to include vatRate reference.

**Export types:**
```typescript
export type VatRate = typeof vatRates.$inferSelect;
export type InsertVatRate = typeof vatRates.$inferInsert;
```

**Critical:** All FK fields are NULLABLE initially to allow migration. Plan 02 will populate them, then we make them NOT NULL in a follow-up migration.
  </action>
  <verify>
grep "export const vatRates" packages/database/src/tenant/schema.ts
grep "vatRateId" packages/database/src/tenant/schema.ts | wc -l  # Should be 4+ (invoiceItems, quoteItems, rooms, serviceCatalog)
  </verify>
  <done>
vat_rates table defined with id, name, rate, isDefault, isActive, timestamps. Four FK fields added to invoiceItems, quoteItems, rooms, serviceCatalog. Relations and type exports added.
  </done>
</task>

<task type="auto">
  <name>Generate migration for vat_rates and FK columns</name>
  <files>
    packages/database/migrations/0046_add_vat_rates.sql
  </files>
  <action>
Run Drizzle migration generator:

```bash
cd packages/database
pnpm db:generate
```

This will create a new migration file (likely 0046 or next available number) with:
- CREATE TABLE vat_rates
- ALTER TABLE invoice_items ADD COLUMN vat_rate_id
- ALTER TABLE quote_items ADD COLUMN vat_rate_id
- ALTER TABLE rooms ADD COLUMN vat_rate_id
- ALTER TABLE service_catalog DROP COLUMN tax_rate, ADD COLUMN vat_rate_id

**CRITICAL:** Review generated migration. Ensure FK constraints use `ON DELETE RESTRICT` (not CASCADE) to prevent orphaned historical invoices.

If generator doesn't handle serviceCatalog.taxRate removal correctly, manually edit migration:
```sql
ALTER TABLE service_catalog DROP COLUMN tax_rate;
ALTER TABLE service_catalog ADD COLUMN vat_rate_id INTEGER REFERENCES vat_rates(id) ON DELETE RESTRICT;
```
  </action>
  <verify>
ls packages/database/migrations/0046_add_vat_rates.sql
grep "CREATE TABLE vat_rates" packages/database/migrations/0046_add_vat_rates.sql
grep "ALTER TABLE invoice_items" packages/database/migrations/0046_add_vat_rates.sql
  </verify>
  <done>
Migration file exists with CREATE TABLE vat_rates and 4 ALTER TABLE statements adding vat_rate_id columns. FK constraints use ON DELETE RESTRICT.
  </done>
</task>

<task type="auto">
  <name>Create seed script for default French VAT rates</name>
  <files>
    packages/database/src/scripts/seed-vat-rates.ts
  </files>
  <action>
Create idempotent seed script following the pattern from `seed-task-types.ts`:

```typescript
/**
 * Seed Default VAT Rates (France)
 *
 * Creates 4 default French VAT rates:
 * 1. TVA Standard 20% (default)
 * 2. TVA R√©duit 10%
 * 3. TVA R√©duit Sp√©cial 5.5%
 * 4. TVA Super R√©duit 2.1%
 *
 * This script is idempotent - safe to run multiple times.
 *
 * Usage:
 * DATABASE_URL="postgresql://postgres:password@localhost:5432/rsm_master" TENANT_DB_NAME="tenant_1" pnpm tsx src/scripts/seed-vat-rates.ts
 */

import { eq } from 'drizzle-orm';
import { getTenantDb } from '../connection.js';
import { vatRates } from '../tenant/schema.js';

export const DEFAULT_VAT_RATES = [
  {
    name: 'TVA Standard 20%',
    rate: '20.00',
    isDefault: true,
    isActive: true,
  },
  {
    name: 'TVA R√©duit 10%',
    rate: '10.00',
    isDefault: false,
    isActive: true,
  },
  {
    name: 'TVA R√©duit Sp√©cial 5.5%',
    rate: '5.50',
    isDefault: false,
    isActive: true,
  },
  {
    name: 'TVA Super R√©duit 2.1%',
    rate: '2.10',
    isDefault: false,
    isActive: true,
  },
];

async function seedVatRates() {
  try {
    console.log('üå± Seeding VAT rates...\n');

    const organizationId = parseInt(process.env.TENANT_ORG_ID || '1');
    const tenantDb = await getTenantDb(organizationId);

    console.log(`‚úì Connected to tenant database for organization ${organizationId}\n`);

    let insertedCount = 0;
    let skippedCount = 0;

    for (const vatRate of DEFAULT_VAT_RATES) {
      // Check if VAT rate already exists by name
      const existing = await tenantDb.query.vatRates.findFirst({
        where: eq(vatRates.name, vatRate.name),
      });

      if (existing) {
        console.log(`‚è≠Ô∏è  Skipped: "${vatRate.name}" already exists (ID: ${existing.id})`);
        skippedCount++;
      } else {
        const [inserted] = await tenantDb
          .insert(vatRates)
          .values(vatRate)
          .returning();

        console.log(`‚úì Inserted: "${vatRate.name}" - ID: ${inserted.id}`);
        insertedCount++;
      }
    }

    console.log(`\nüìä Summary:`);
    console.log(`   Inserted: ${insertedCount}`);
    console.log(`   Skipped: ${skippedCount}`);
    console.log(`   Total: ${insertedCount + skippedCount}`);
    console.log(`\n‚úÖ VAT rates seed complete!`);

    process.exit(0);
  } catch (error) {
    console.error('‚ùå Error seeding VAT rates:', error);
    process.exit(1);
  }
}

seedVatRates();
```

**Export DEFAULT_VAT_RATES** for use in other scripts (e.g., tenant creation).
  </action>
  <verify>
pnpm tsx packages/database/src/scripts/seed-vat-rates.ts
# Should output 4 inserted rates (or 4 skipped if already exists)
  </verify>
  <done>
Script creates 4 VAT rates idempotently. Running twice skips existing rates. Exports DEFAULT_VAT_RATES constant.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Schema validation:
   - `grep "export const vatRates" packages/database/src/tenant/schema.ts` returns table definition
   - `pnpm --filter database check` passes TypeScript validation

2. Migration exists:
   - `ls packages/database/migrations/0046_add_vat_rates.sql` (or next number)
   - Migration contains CREATE TABLE and ALTER TABLE statements

3. Seed script works:
   - `pnpm tsx packages/database/src/scripts/seed-vat-rates.ts` succeeds
   - Running twice is idempotent (skips existing rates)
</verification>

<success_criteria>
- [ ] `vat_rates` table defined in tenant schema with 6 fields
- [ ] `invoiceItems`, `quoteItems`, `rooms`, `serviceCatalog` have `vatRateId` FK (nullable)
- [ ] Migration file generated and reviewed
- [ ] Seed script creates 4 French VAT rates (20%, 10%, 5.5%, 2.1%)
- [ ] 20% rate is marked as default
- [ ] TypeScript types exported for VatRate
- [ ] All FKs use ON DELETE RESTRICT
</success_criteria>

<output>
After completion, create `.planning/phases/39-gestion-tva-multi-taux/39-01-SUMMARY.md`
</output>
