---
phase: 3.3-fix-registration-session-persistence
plan: 01
type: execute
---

<objective>
Fix critical bug where user session is not persisted after registration, causing all protected endpoints to return 401 Unauthorized.

Purpose: Restore authentication flow so new users can access the application after registration.
Output: Working registration flow with session persistence, all protected endpoints accessible after signup.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Bug Evidence (MCP Chrome DevTools testing 2025-12-26):**
- Registration endpoint returns 200 OK with valid user/organization JSON
- Cookie `connect.sid` is set and sent with subsequent requests
- `auth.me` endpoint returns `{"result":{"data":null}}` instead of user data
- All protected tRPC endpoints return 401 Unauthorized
- 29 console errors in browser after successful registration

**Current Implementation:**
@packages/server/src/routers/auth.ts - Lines 83-96 already call `ctx.req.session.save()`
@packages/server/src/_core/context.ts - Lines 57-80 read session from `opts.req.session`
@packages/server/src/index.ts - Lines 93-106 configure express-session with RedisStore

**Root Cause Hypotheses:**
1. Cookie configuration (domain, path, sameSite) prevents cookie from being sent
2. Session middleware not processing cookie before tRPC context creation
3. Redis session store not retrieving saved session
4. Session regeneration timing issue (session saved but cookie not updated)

**Prior Decisions:**
- Phase 3.1: Cookie domain set to `.recording-studio-manager.com` (with dot for subdomain sharing)
- Phase 3.1: sameSite set to 'lax' for CSRF protection while allowing top-level navigation
- Phase 3.1: trust proxy configuration for Nginx (single proxy)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comprehensive session debugging logs</name>
  <files>packages/server/src/routers/auth.ts, packages/server/src/_core/context.ts</files>
  <action>
    Add detailed logging at critical points:
    1. In auth.ts register endpoint (after line 96):
       - Log session ID before and after save
       - Log cookie header being sent to client
       - Log session data written to Redis
    2. In context.ts (after line 63):
       - Already has logs, verify they're showing correct data
    3. Add logging to auth.me endpoint to see what session data it receives

    This will help us see WHERE the session is lost (during save, during retrieval, or during cookie transmission).
  </action>
  <verify>
    - Logs show session ID, session data, and cookie information
    - Run `ssh vps-n8n "docker logs rsm-server --tail=50"` shows new log entries
  </verify>
  <done>Comprehensive logging in place for registration flow debugging</done>
</task>

<task type="auto">
  <name>Task 2: Verify Redis session storage</name>
  <files>None (diagnostic)</files>
  <action>
    Connect to VPS and verify Redis is storing sessions correctly:
    1. SSH to VPS: `ssh vps-n8n`
    2. Connect to Redis container: `docker exec -it rsm-redis redis-cli`
    3. Check for session keys: `KEYS rsm:session:*`
    4. If sessions exist, inspect one: `GET rsm:session:{sid}`
    5. Verify session data includes userId and organizationId

    Document findings - are sessions being saved? What data do they contain?
  </action>
  <verify>
    - Redis contains session keys with prefix `rsm:session:`
    - Session data includes userId and organizationId fields
    - Session expiry is set correctly (7 days)
  </verify>
  <done>Redis session storage verified or issue identified</done>
</task>

<task type="auto">
  <name>Task 3: Test registration with curl to isolate frontend vs backend</name>
  <files>None (testing)</files>
  <action>
    Test registration directly with curl to see if issue is backend or frontend:
    1. Create test script on VPS: `/tmp/test-register.sh`
    2. POST to registration endpoint with curl, save cookies
    3. Use saved cookies to call auth.me endpoint
    4. Compare cookie handling between curl and browser

    ```bash
    # Save cookies from registration
    curl -c /tmp/cookies.txt -X POST https://recording-studio-manager.com/api/trpc/auth.register \
      -H "Content-Type: application/json" \
      -d '{"email":"curl-test@example.com","password":"testpass123","name":"Curl Test","organizationName":"Curl Studio"}'

    # Use cookies to call auth.me
    curl -b /tmp/cookies.txt https://recording-studio-manager.com/api/trpc/auth.me
    ```

    Document: Does curl get authenticated correctly? If yes, problem is frontend. If no, problem is backend.
  </action>
  <verify>
    - Curl test executed successfully
    - Results documented: auth.me returns user data or null
    - Cookie file shows connect.sid cookie
  </verify>
  <done>curl test completed, frontend vs backend isolation confirmed</done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>Determine root cause based on debugging evidence</decision>
  <context>
    Based on logs from Tasks 1-3, we need to identify the root cause before implementing a fix.

    Review:
    - Task 1 logs: Where does session data disappear?
    - Task 2 results: Is Redis storing sessions correctly?
    - Task 3 results: Does curl work? (backend OK) or fail? (backend broken)
  </context>
  <options>
    <option id="cookie-config">
      <name>Cookie Configuration Issue</name>
      <pros>curl works but browser doesn't = cookie domain/sameSite/path problem</pros>
      <cons>Would require changing cookie settings (domain, sameSite, path)</cons>
    </option>
    <option id="session-timing">
      <name>Session Save/Regenerate Timing</name>
      <pros>Logs show session saved but not retrieved = regeneration issue</pros>
      <cons>Requires understanding express-session internals</cons>
    </option>
    <option id="redis-connection">
      <name>Redis Connection/Storage Issue</name>
      <pros>Task 2 shows no sessions in Redis = storage problem</pros>
      <cons>Would need to debug RedisStore configuration</cons>
    </option>
    <option id="context-middleware-order">
      <name>Middleware Order Problem</name>
      <pros>Session middleware not running before tRPC = order issue</pros>
      <cons>Would require reordering Express middleware</cons>
    </option>
  </options>
  <resume-signal>Select root cause: cookie-config, session-timing, redis-connection, or context-middleware-order</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Implement fix based on root cause</name>
  <files>packages/server/src/index.ts, packages/server/src/routers/auth.ts (depending on root cause)</files>
  <action>
    Based on the selected root cause, implement the appropriate fix:

    **If cookie-config:**
    - Adjust cookie domain (try without leading dot, or explicit domain)
    - Test sameSite: 'none' with secure: true (if HTTPS)
    - Add explicit path: '/' to cookie config

    **If session-timing:**
    - Use session.regenerate() instead of session.save()
    - OR ensure cookie is sent before returning response (res.setHeader)
    - OR add explicit cookie generation after session save

    **If redis-connection:**
    - Verify RedisStore client connection
    - Add error logging to RedisStore
    - Test Redis connectivity from server container

    **If context-middleware-order:**
    - Move session middleware before tRPC middleware
    - Ensure session() is called before createExpressMiddleware()
    - Verify req.session is populated when createContext runs
  </action>
  <verify>
    - Code changes deployed to VPS
    - Server restarted: `ssh vps-n8n "docker restart rsm-server"`
    - Registration tested with MCP Chrome DevTools
    - auth.me returns user data after registration
  </verify>
  <done>Fix implemented and deployed, ready for verification</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Registration session persistence fix deployed to production</what-built>
  <how-to-verify>
    1. Open MCP Chrome DevTools (already connected)
    2. Navigate to https://recording-studio-manager.com/register
    3. Fill registration form with new test email
    4. Click "Create Account"
    5. After redirect to dashboard, open DevTools Console
    6. Check: No 401 errors should appear
    7. Check: Network tab shows auth.me returning user data (not null)
    8. Test: Click around dashboard - all data should load
    9. Verify: Sessions page, Clients page, Projects page all work
  </how-to-verify>
  <resume-signal>Type "approved" if all endpoints work, or describe remaining issues</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Clean up debug logs</name>
  <files>packages/server/src/routers/auth.ts, packages/server/src/_core/context.ts</files>
  <action>
    Remove temporary debug logging added in Task 1:
    - Keep essential logs (session saved confirmation)
    - Remove verbose session data dumps
    - Keep error logging for production debugging

    Commit changes with message explaining the fix.
  </action>
  <verify>
    - Debug logs removed
    - Production logs remain minimal and useful
    - Code committed to git
  </verify>
  <done>Debug logs cleaned up, fix committed</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] New user can register successfully
- [ ] After registration, auth.me returns user data (not null)
- [ ] Dashboard loads without 401 errors
- [ ] All protected endpoints accessible (notifications, organizations, clients, etc.)
- [ ] No console errors in browser after registration
- [ ] Session persists across page reloads
- [ ] Redis contains session with correct data
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Registration flow works end-to-end
- Session persists correctly in Redis
- No 401 errors after successful registration
- Fix committed to version control
</success_criteria>

<output>
After completion, create `.planning/phases/3.3-fix-registration-session-persistence/3.3-01-SUMMARY.md`:

# Phase 3.3-01: Fix Registration Session Persistence

**[One-liner describing the fix - e.g., "Fixed Express session cookie configuration to persist after registration"]**

## Accomplishments

- Identified root cause of session persistence failure
- Implemented fix for [specific issue]
- Verified registration flow works end-to-end
- All protected endpoints accessible after registration

## Files Created/Modified

- `packages/server/src/[files modified]`

## Decisions Made

- [Root cause selected and rationale]
- [Technical approach chosen]

## Issues Encountered

- [Any blockers or surprises during debugging]

## Next Phase Readiness

Phase 3.3 complete. Ready to proceed with Phase 4 (Marketing Foundation) - application now fully functional for new user signups.
</output>
