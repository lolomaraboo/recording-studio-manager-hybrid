---
phase: 18.2-fix-schema-migration-desync
plan: 01
type: execute
---

<objective>
Generate missing tenant database migrations for schema changes made in Phases 10-17 and apply them to local tenant databases (tenant_1, tenant_16).

Purpose: Fix systematic schema/migration desync (BUG-003) that blocks ~40% of Phase 18-02 testing. Sessions and invoices pages are completely broken due to missing database columns.

Output: Fresh tenant migrations generated, applied to local databases, all affected queries working, Phase 18-02 testing unblocked.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-audit-complet-toutes-pages-zero-bug/TEST-MATRIX.md
@packages/database/src/tenant/schema.ts
@packages/database/drizzle.config.ts

**Problem Context (BUG-003):**
During Phase 18-02 environment setup, discovered SYSTEMATIC schema/migration desync affecting multiple tenant tables. TypeScript schema definitions evolved during Phases 10-17 but migrations were NEVER generated.

**Affected Tables (Confirmed):**
1. **sessions** - Missing 6 columns added in Phases 14-16:
   - `project_id` (integer, FK to projects) - Phase 14
   - `deposit_amount` (numeric) - Phase 16
   - `deposit_paid` (boolean) - Phase 16
   - `payment_status` (varchar 50) - Phase 16
   - `stripe_checkout_session_id` (varchar 255) - Phase 16
   - `stripe_payment_intent_id` (varchar 255) - Phase 16

2. **invoices** - Missing 6 columns added in Phase 16-17:
   - `deposit_amount` (numeric)
   - `deposit_paid_at` (timestamp)
   - `stripe_deposit_payment_intent_id` (varchar 255)
   - `remaining_balance` (numeric)
   - `pdf_s3_key` (text)
   - `sent_at` (timestamp)

3. **musicians** - Missing 1 column (Phase unknown):
   - `talent_type` (varchar 50) - defaults to "musician", values: "musician" | "actor"

**Last Migration:** 0009_add_stripe_webhook_events.sql (Jan 9)
**Root Cause:** Phases 10-17 modified `packages/database/src/tenant/schema.ts` directly but `pnpm db:generate` was NEVER run

**Current Database State:**
- rsm_master: 7 tables (synchronized in Phase 18.1-01)
- tenant_1: 30 tenant tables (rebuilt clean in Phase 18.1-01, DOES NOT have missing columns)
- tenant_16: 30 tenant tables (from setup-org-16.sh, DOES NOT have missing columns)

**Impact:**
- 100% of sessions queries fail (TRPC error: column "project_id" does not exist)
- 100% of invoices queries fail (TRPC error: column "deposit_amount" does not exist)
- Blocks testing of: Sessions, Invoices, Time Tracking, Reports pages (~40% of Phase 18-02 scope)

**Constraining Decisions:**
- Phase 18.1-01: Local native PostgreSQL 17 fixed and synchronized
- Database-per-tenant architecture: Each org has physically separate database
- Multi-tenant migration strategy: New migrations apply to ALL existing tenant databases
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate missing tenant migrations with Drizzle</name>
  <files>packages/database/drizzle/migrations/tenant/0010_*.sql (new), packages/database/drizzle/migrations/tenant/meta/*</files>
  <action>
Run `pnpm --filter database db:generate` to generate missing tenant migrations for all schema.ts changes since Dec 15 (Phases 10-17).

This will create migration 0010_*.sql containing ALL missing columns:
- sessions: project_id, deposit_amount, deposit_paid, payment_status, stripe_checkout_session_id, stripe_payment_intent_id
- invoices: deposit_amount, deposit_paid_at, stripe_deposit_payment_intent_id, remaining_balance, pdf_s3_key, sent_at
- musicians: talent_type

Drizzle automatically detects schema drift by comparing schema.ts to last migration (0009) and generates SQL ALTER TABLE statements.

**Why this works:** Drizzle ORM's introspection compares current schema.ts against last applied migration's state, detecting all missing columns across all tables in one pass.

**IMPORTANT:** Verify generated SQL includes ALL 13 missing columns (6 sessions + 6 invoices + 1 musicians). If any missing, schema.ts may have inconsistencies that need manual resolution before proceeding.
  </action>
  <verify>
ls packages/database/drizzle/migrations/tenant/0010_*.sql exists
grep -i "project_id" packages/database/drizzle/migrations/tenant/0010_*.sql  # sessions.project_id
grep -i "deposit_amount" packages/database/drizzle/migrations/tenant/0010_*.sql  # sessions + invoices
grep -i "talent_type" packages/database/drizzle/migrations/tenant/0010_*.sql  # musicians.talent_type
wc -l packages/database/drizzle/migrations/tenant/0010_*.sql  # Should be ~30-40 lines for 13 ALTER TABLE statements
  </verify>
  <done>Migration 0010_*.sql created with 13 columns (6 sessions + 6 invoices + 1 musicians), no generation errors</done>
</task>

<task type="auto">
  <name>Task 2: Apply migrations to tenant_1 database</name>
  <files>tenant_1 database tables (sessions, invoices, musicians)</files>
  <action>
Apply generated migration 0010 to tenant_1 using psql:

```bash
/opt/homebrew/opt/postgresql@17/bin/psql -U postgres -d tenant_1 -f packages/database/drizzle/migrations/tenant/0010_*.sql
```

This adds all 13 missing columns to tenant_1 database (local testing database).

**Why psql not pnpm db:migrate:** `pnpm db:migrate` applies to ALL tenant databases via getTenantDb(), but we only have 2 local (tenant_1, tenant_16). Direct psql gives precise control and immediate feedback.

After applying, verify schema synchronized:
```bash
\d sessions  # Should show project_id, deposit_amount, deposit_paid, payment_status, stripe_checkout_session_id, stripe_payment_intent_id
\d invoices  # Should show deposit_amount, deposit_paid_at, stripe_deposit_payment_intent_id, remaining_balance, pdf_s3_key, sent_at
\d musicians # Should show talent_type
```
  </action>
  <verify>
/opt/homebrew/opt/postgresql@17/bin/psql -U postgres -d tenant_1 -c "\d sessions" | grep -E "(project_id|deposit_amount|deposit_paid|payment_status|stripe_checkout_session_id|stripe_payment_intent_id)"
/opt/homebrew/opt/postgresql@17/bin/psql -U postgres -d tenant_1 -c "\d invoices" | grep -E "(deposit_amount|deposit_paid_at|stripe_deposit_payment_intent_id|remaining_balance|pdf_s3_key|sent_at)"
/opt/homebrew/opt/postgresql@17/bin/psql -U postgres -d tenant_1 -c "\d musicians" | grep "talent_type"
# All 13 columns should appear in output
  </verify>
  <done>tenant_1 synchronized - all 13 columns present in sessions (6), invoices (6), musicians (1)</done>
</task>

<task type="auto">
  <name>Task 3: Apply migrations to tenant_16 database</name>
  <files>tenant_16 database tables (sessions, invoices, musicians)</files>
  <action>
Apply same migration 0010 to tenant_16 (Test Studio UI organization):

```bash
/opt/homebrew/opt/postgresql@17/bin/psql -U postgres -d tenant_16 -f packages/database/drizzle/migrations/tenant/0010_*.sql
```

tenant_16 is used for Phase 18-02 testing via dev mode headers (x-test-org-id: 16), so this unblocks all sessions/invoices testing.

Verify same 13 columns added successfully.
  </action>
  <verify>
/opt/homebrew/opt/postgresql@17/bin/psql -U postgres -d tenant_16 -c "\d sessions" | grep -E "(project_id|deposit_amount|deposit_paid|payment_status|stripe_checkout_session_id|stripe_payment_intent_id)"
/opt/homebrew/opt/postgresql@17/bin/psql -U postgres -d tenant_16 -c "\d invoices" | grep -E "(deposit_amount|deposit_paid_at|stripe_deposit_payment_intent_id|remaining_balance|pdf_s3_key|sent_at)"
/opt/homebrew/opt/postgresql@17/bin/psql -U postgres -d tenant_16 -c "\d musicians" | grep "talent_type"
# All 13 columns should appear
  </verify>
  <done>tenant_16 synchronized - all 13 columns present in sessions (6), invoices (6), musicians (1)</done>
</task>

<task type="auto">
  <name>Task 4: Verify sessions and invoices queries work</name>
  <files>Server logs, browser DevTools console</files>
  <action>
Start server (if not running) and test affected endpoints:

```bash
# Server should already be running from background task b58f656
# If not: DATABASE_URL="postgresql://postgres@localhost:5432/rsm_master" pnpm --filter server dev &
```

Test queries that were previously failing:

1. **Sessions list** - Load http://localhost:5174/sessions (requires login)
   - Should display sessions without "column project_id does not exist" error
   - Verify browser console has 0 errors for sessions.list tRPC call

2. **Invoices list** - Load http://localhost:5174/invoices
   - Should display invoices without "column deposit_amount does not exist" error
   - Verify browser console has 0 errors for invoices.list tRPC call

3. **Check server logs** - No PostgreSQL column errors in terminal

If ANY query still fails with column errors, migration 0010 is incomplete or not applied correctly. Investigate which columns are still missing.
  </action>
  <verify>
# Verify no TRPC errors in browser console when loading /sessions and /invoices
# Verify server logs show successful queries (no PostgreSQL "column does not exist" errors)
curl http://localhost:3001/health  # Server health check should return 200 OK
  </verify>
  <done>Sessions and invoices pages load successfully, 0 TRPC errors, 0 PostgreSQL column errors in logs, Phase 18-02 testing unblocked</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Migration 0010 generated with all 13 missing columns (6 sessions + 6 invoices + 1 musicians)
- [ ] tenant_1 database synchronized (\d sessions, \d invoices, \d musicians all show new columns)
- [ ] tenant_16 database synchronized (same verification)
- [ ] Sessions list page loads without errors (http://localhost:5174/sessions)
- [ ] Invoices list page loads without errors (http://localhost:5174/invoices)
- [ ] Server logs show 0 PostgreSQL "column does not exist" errors
- [ ] Phase 18-02 testing ready to resume
</verification>

<success_criteria>

- Migration 0010 generated and contains all 13 missing columns
- tenant_1 and tenant_16 synchronized (all columns present)
- Sessions queries work (no project_id errors)
- Invoices queries work (no deposit_amount errors)
- Musicians queries work (no talent_type errors)
- Phase 18-02 testing unblocked (~40% of testing scope restored)
- BUG-003 resolved (systematic schema desync fixed)
</success_criteria>

<output>
After completion, create `.planning/phases/18.2-fix-schema-migration-desync/18.2-01-SUMMARY.md`:

# Phase 18.2 Plan 01: Generate and Apply Missing Tenant Migrations Summary

**Schema desync fixed - 13 missing columns added, sessions/invoices queries restored, Phase 18-02 unblocked**

## Accomplishments

- Generated migration 0010 with 13 missing columns (6 sessions + 6 invoices + 1 musicians)
- Applied migration to tenant_1 database (local testing)
- Applied migration to tenant_16 database (Test Studio UI for Phase 18-02)
- Verified sessions queries work (no project_id errors)
- Verified invoices queries work (no deposit_amount errors)
- Restored ~40% of Phase 18-02 testing scope

## Files Created/Modified

- `packages/database/drizzle/migrations/tenant/0010_*.sql` - New migration with 13 ALTER TABLE statements
- `packages/database/drizzle/migrations/tenant/meta/*` - Updated migration metadata
- `tenant_1` database - 13 columns added across 3 tables
- `tenant_16` database - 13 columns added across 3 tables

## Root Cause Analysis

**Why this happened:**
Phases 10-17 (Dec 25 - Jan 15) modified `packages/database/src/tenant/schema.ts` directly to add features:
- Phase 14: Sessions-Projects flexible architecture (project_id)
- Phase 16: Facturation automatique backend (deposit fields, Stripe tracking)
- Phase 17: Facturation automatique Stripe UI (PDF storage, email tracking)

However, `pnpm db:generate` was NEVER run during these phases to create corresponding migration files. TypeScript code evolved but PostgreSQL databases remained frozen at Dec 15 state (migration 0009).

**Impact:** All sessions and invoices queries failed with "column does not exist" errors, blocking ~40% of Phase 18-02 testing.

**Prevention:** Establish strict migration discipline:
1. After ANY schema.ts modification, immediately run `pnpm db:generate`
2. Apply generated migrations to local databases before committing code
3. Verify queries work BEFORE marking phase complete
4. Add pre-commit hook to detect schema drift (future enhancement)

## Decisions Made

1. **Direct psql application** - Used psql instead of `pnpm db:migrate` for precise control over local databases (tenant_1, tenant_16 only)
2. **Single migration for all changes** - Drizzle consolidated all missing columns into migration 0010 (cleaner than 13 separate migrations)
3. **VPS migration deferred** - Phase 18.1-02/03 (VPS production migration) remains deferred, not blocking local testing

## Issues Encountered

[To be filled during execution - expected: none if schema.ts is consistent]

## Next Step

**Phase 18-02 UNBLOCKED** - Ready to resume comprehensive testing of all 58 pages. Sessions, Invoices, Time Tracking, and Reports pages now functional.

Resume with: `/gsd:progress` to return to Phase 18-02 testing.
</output>
