# Phase 26.2 Context: Restaurer Relations Professionnelles (EDIT MODE ONLY)

## Problem Statement

**Phase 25** a implémenté la gestion complète des relations many-to-many entre clients individuels et entreprises (CompanyMembersModal + CompanyMembersIndicator + 5 endpoints backend).

**Phase 26/26.1** a refactorisé l'UI du formulaire client (passage du wizard aux accordéons), mais cette refonte a **supprimé** l'accordion "Relations Professionnelles" du mode EDIT (commit `ebcc787`).

**Impact utilisateur :**
> "On a fait la phase 25, mais depuis on a retouché l'UI du coup, on ne peut plus modifier les entreprises quand on est sur la page d'édition d'un particulier"

## IMPORTANT: Scope Clarification

**✅ IN SCOPE (Mode EDIT uniquement) :**
- Modifier `ClientEditForm.tsx` (page `/clients/4?edit=true`)
- Ajouter 6ème accordion "Relations professionnelles"
- Position 3 (après Coordonnées, avant Profil Artistique)
- Fermé par défaut

**❌ OUT OF SCOPE (Mode VIEW) :**
- **NE PAS modifier** `ClientDetailTabs.tsx` (page `/clients/4`)
- **NE PAS ajouter** CompanyMembersIndicator en mode VIEW
- L'utilisateur accédera aux relations en passant en mode EDIT

## What Still Works

✅ **Backend complet et fonctionnel :**
- `CompanyMembersModal.tsx` (374 lignes) - Existe toujours
- `CompanyMembersIndicator.tsx` (93 lignes) - Existe toujours
- 5 endpoints tRPC : `addMember`, `updateMember`, `removeMember`, `getCompanies`, `getRoles`
- Database schema : table `company_members` avec relations many-to-many

✅ **Composants réutilisables :**
- Modal bidirectionnelle (gère company→members ET individual→companies)
- Inline role editing
- Role autocomplete
- Primary contact checkbox
- Smart preview truncation

## What Needs Restoration

### Mode EDIT ONLY (ClientEditForm.tsx)

**Ajouter 6ème accordion "Relations professionnelles" :**
- Position : 3ème (après "Coordonnées", avant "Profil Artistique")
- Default state : Fermé (cohérence avec les autres accordions)
- Contenu : CompanyMembersIndicator + bouton "Gérer les relations"
- Dynamique : Texte change selon `formData.type` (company/individual)
- Conditional rendering : Vérifier `formData.id !== undefined` (évite crash en création)

**État actuel :** 5 accordions (Identité, Coordonnées, Profil Artistique, Streaming, Notes Studio)

## User Requirements

1. **Phase number:** 26.2 (après 26.1)
2. **Default state:** Fermé (Option A)
3. **Position:** 3ème accordion, après Coordonnées, avant Profil Artistique (Option C)
4. **Nom:** "Relations professionnelles"
5. **Scope:** Mode EDIT uniquement (pas de modification du mode VIEW)

## Technical Approach

### Single File Modification

**ClientEditForm.tsx** (~1124 lignes)
- Import : `CompanyMembersModal`, `CompanyMembersIndicator`, `Users` icon
- State : `useState<boolean>` pour modal open/close
- Queries : `getMembers` (companies) ou `getCompanies` (individuals)
- UI : Nouveau AccordionItem à position 3
- Update defaultValue array : Reste vide (tous fermés par défaut)
- Update Alt key handler : Ajouter "relations-professionnelles" dans allAccordions

**NO changes to ClientDetailTabs.tsx**

## Success Criteria

✅ **Mode EDIT :**
- 6ème accordion "Relations professionnelles" présent
- Position 3 (après Coordonnées, avant Profil Artistique)
- Fermé par défaut
- Indicateur + bouton "Gérer les relations" visible
- Modal permet CRUD complet (add/update/remove members/companies)
- Conditional rendering : Placeholder si formData.id undefined
- Alt key toggle fonctionne avec 6 accordions

✅ **No Regressions :**
- Les 5 autres accordions inchangés
- TypeScript 0 errors
- Production build successful
- Fonctionnalité Phase 25 restaurée en mode EDIT

❌ **Explicitly OUT OF SCOPE :**
- Mode VIEW (ClientDetailTabs.tsx) reste inchangé
- Pas de CompanyMembersIndicator ajouté en mode VIEW
- User doit passer en mode EDIT pour gérer les relations

## Implementation Strategy

**Single Task (Sequential) :**
1. Add EDIT mode accordion (ClientEditForm) - 13 min
   - Import components
   - Add state for modal
   - Add tRPC queries
   - Add 6th accordion at position 3
   - Update Alt key handler
   - Manual testing

**Total estimé :** ~13 min (8 min code + 5 min testing)

## References

- **Phase 25 Summary:** `.planning/phases/25-gestion-relations-client-entreprise/25-01-SUMMARY.md`
- **Phase 26.1 Summary:** `.planning/phases/26.1-reorganisation-accordeons---logique-studio-d'enregistrement/26.1-01-SUMMARY.md`
- **Commit qui a supprimé Relations:** `ebcc787` - refactor(26.1): finalize 5-accordion structure
- **CompanyMembersModal:** `packages/client/src/components/CompanyMembersModal.tsx` (374 lignes)
- **CompanyMembersIndicator:** `packages/client/src/components/CompanyMembersIndicator.tsx` (93 lignes)

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Queries ajoutent latence | Performance | Conditional query enable (only when accordion open) |
| 6 accordions = trop dense | UX | Accordion fermé par défaut, Alt key toggle still works |
| formData.id undefined en création | Crash | Conditional rendering (only show if formData.id exists) |

## Decision Log

| Decision | Rationale |
|----------|-----------|
| Phase 26.2 (not 27) | Continuation logique de Phase 26.1 (même feature area) |
| Mode EDIT uniquement | User clarification : "ne touche pas à l'UI de la page /clients/4, on modifie juste /clients/4?edit=true" |
| Position 3 (après Coordonnées) | Logique métier : Relations = contexte business avant profil artistique |
| Fermé par défaut | Cohérence avec décision Phase 26.1 (seul Identité ouvert) |
| Nom "Relations professionnelles" | Nom d'origine Phase 25, explicite et professionnel |
| Réutiliser composants Phase 25 | Zero duplication, backend déjà testé et fonctionnel |

---

**Context Updated:** 2026-01-21
**Scope:** EDIT mode only (1 file: ClientEditForm.tsx)
**Ready for:** Planning (create PLAN.md with SINGLE task)
