# Phase 26.2: Restaurer Relations Professionnelles - Research

**Researched:** 2026-01-21
**Domain:** React form UI restoration, shadcn/ui accordion integration, tRPC query optimization
**Confidence:** HIGH

## Summary

This phase restores functionality from Phase 25 (company-member relationship management) that was inadvertently removed during Phase 26.1's accordion reorganization. The research confirms that all backend infrastructure remains intact and functional - only the UI integration points need restoration.

The standard approach involves re-integrating two existing React components (`CompanyMembersModal` and `CompanyMembersIndicator`) into two locations: VIEW mode (`ClientDetailTabs.tsx`) and EDIT mode (`ClientEditForm.tsx`). The accordion pattern follows shadcn/ui best practices with proper keyboard navigation, conditional tRPC query enabling for performance, and defensive null checking for edge cases.

**Primary recommendation:** Follow the incremental restoration pattern: VIEW mode first (simpler, validates components still work), then EDIT mode (adds 6th accordion with proper positioning). Use conditional query enabling (`enabled: open && formData.id !== undefined`) to prevent unnecessary API calls and crashes in creation mode.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| React | 19.1 | UI framework | Project standard, latest stable with improved form handling |
| shadcn/ui Accordion | Latest | Collapsible sections | Built-in accessibility (ARIA), keyboard nav, TypeScript native |
| tRPC | 11 | Type-safe API | End-to-end type safety, React Query integration |
| @tanstack/react-query | Latest | Data fetching | Bundled with tRPC v11, conditional `enabled` option for performance |
| Lucide React | Latest | Icons | Project standard for consistent iconography |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Sonner | Latest | Toast notifications | User feedback after mutations (already integrated) |
| Wouter | Latest | Client routing | Link generation for company/member navigation |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| shadcn/ui Accordion | Radix UI Accordion (direct) | shadcn is wrapper around Radix with Tailwind, already project standard |
| tRPC queries | Direct fetch calls | Lose type safety and auto-invalidation on mutations |
| Conditional enabling | Always fetch | Wastes bandwidth, crashes on undefined formData.id in creation mode |

**Installation:**
```bash
# No new packages needed - all dependencies already in project
# Verify existing components exist:
ls packages/client/src/components/CompanyMembers*.tsx
```

## Architecture Patterns

### Recommended Component Integration Structure

**VIEW Mode (ClientDetailTabs.tsx):**
```tsx
// After contact info section, before music section
<CompanyMembersIndicator
  clientId={client.id}
  clientType={client.type}
  clientName={client.name}
  isEditing={false}  // VIEW mode
/>
<Separator className="my-4" />
```

**EDIT Mode (ClientEditForm.tsx):**
```tsx
// 3rd accordion (position after Coordonnées, before Profil Artistique)
<AccordionItem value="relations-professionnelles">
  <Card>
    <AccordionTrigger className="px-4 py-3 hover:no-underline">
      <h3 className="text-lg font-semibold flex items-center gap-2">
        <Users className="h-5 w-5 text-primary" />
        Relations professionnelles
      </h3>
    </AccordionTrigger>
    <AccordionContent>
      <div className="px-4 pb-3 space-y-3">
        {formData.id ? (
          <CompanyMembersIndicator
            clientId={formData.id}
            clientType={formData.type}
            clientName={formData.name || formData.companyName || ''}
            isEditing={true}
          />
        ) : (
          <p className="text-sm text-muted-foreground">
            Enregistrez d'abord ce client pour gérer les relations professionnelles.
          </p>
        )}
      </div>
    </AccordionContent>
  </Card>
</AccordionItem>
```

### Pattern 1: Conditional Query Enabling (Performance Critical)

**What:** Only fetch data when accordion is open AND entity exists

**When to use:** Any accordion section that queries backend data

**Example:**
```typescript
// Source: tRPC documentation + Phase 25 implementation
const { data: members = [] } = trpc.clients.getMembers.useQuery(
  { companyId: clientId },
  {
    enabled: open && clientId !== undefined && clientType === "company"
  }
);
```

**Why this matters:**
- Prevents 400/500 errors when `clientId` is undefined (creation mode)
- Reduces unnecessary API calls when accordion closed
- Improves page load performance (queries execute only on demand)

### Pattern 2: Bidirectional Modal Component

**What:** Single modal component handles both company→members AND individual→companies views

**When to use:** Many-to-many relationships with symmetrical CRUD operations

**Example:**
```typescript
// Source: packages/client/src/components/CompanyMembersModal.tsx
interface CompanyMembersModalProps {
  clientType: "company" | "individual";  // Switches behavior
  clientId: number;
  clientName: string;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

// Single component, behavior switches based on clientType
const membersQuery = clientType === "company"
  ? trpc.clients.getMembers.useQuery({ companyId: clientId }, { enabled: open })
  : trpc.clients.getCompanies.useQuery({ memberId: clientId }, { enabled: open });
```

**Benefits:**
- DRY principle: No code duplication
- Consistent UX across both views
- Single source of truth for mutation logic

### Pattern 3: Accordion State Management with Alt Key Toggle

**What:** Track open accordion items in local state, allow bulk toggle with keyboard shortcut

**When to use:** Multi-section forms with 5+ accordions

**Example:**
```typescript
// Source: packages/client/src/components/ClientEditForm.tsx (Phase 26.1)
const [openItems, setOpenItems] = useState<string[]>(["identite"]);

useEffect(() => {
  const handleKeyDown = (event: KeyboardEvent) => {
    if (event.altKey && !event.ctrlKey && !event.metaKey && !event.shiftKey) {
      event.preventDefault();
      const allAccordions = ["identite", "coordonnees", "relations-professionnelles", "profil-artistique", "streaming", "notes-studio"];

      if (openItems.length < allAccordions.length) {
        setOpenItems(allAccordions); // Open all
      } else {
        setOpenItems([]); // Close all
      }
    }
  };

  window.addEventListener("keydown", handleKeyDown);
  return () => window.removeEventListener("keydown", handleKeyDown);
}, [openItems]);

// Accordion configuration
<Accordion type="multiple" value={openItems} onValueChange={setOpenItems}>
  {/* AccordionItems */}
</Accordion>
```

**IMPORTANT:** When adding 6th accordion, update `allAccordions` array to include `"relations-professionnelles"`.

### Anti-Patterns to Avoid

- **Undefined form values:** Always initialize with `""` or default value, never `undefined` ([React Forms Best Practices](https://www.fullstackfoundations.com/blog/react-forms-best-practices))
- **Missing conditional rendering:** Always check `formData.id` exists before rendering relationship components (prevents crashes in creation mode)
- **Eager query execution:** Don't enable queries when accordion closed or entity doesn't exist (wastes bandwidth)
- **Separate state variables for same modal:** Use single `showModal` state per context (VIEW vs EDIT), don't create conflicts

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Relationship management UI | Custom form with manual selects/dropdowns | `CompanyMembersModal` (existing, 374 lines) | Handles validation, type checking, duplicate prevention, toast notifications, query invalidation |
| Relationship preview | Custom list with truncation logic | `CompanyMembersIndicator` (existing, 93 lines) | Smart truncation (≤3 show all, >3 ellipsis), clickable links, primary contact badges |
| Accordion keyboard navigation | Custom key event handlers | shadcn/ui Accordion | Built-in ARIA compliance, Arrow/Space/Enter/Home/End keys, focus management |
| Query invalidation | Manual refetch calls | tRPC mutation callbacks with `utils.clients.*.invalidate()` | Auto-refreshes all related queries (getMembers, getCompanies, list, etc.) |
| Form state for new vs edit | Custom logic to track creation mode | Defensive `formData.id` check | Simple: if `formData.id` exists, entity persisted; otherwise, show placeholder |

**Key insight:** Phase 25 already implemented a complete, tested solution. Phase 26.1 removed only the UI integration points, not the components themselves. Re-integrating is 20 minutes of work vs 2+ hours to rebuild from scratch.

## Common Pitfalls

### Pitfall 1: Forgetting to Update Alt Key Accordion List

**What goes wrong:** User presses Alt key, 6th accordion doesn't toggle with others

**Why it happens:** Phase 26.1 hardcoded list of 5 accordions in `allAccordions` array

**How to avoid:**
1. Find `allAccordions` array in ClientEditForm.tsx (line ~62)
2. Add `"relations-professionnelles"` to array
3. Verify Alt key toggles all 6 accordions

**Warning signs:** Manual testing after implementation - Alt key should open/close all 6 accordions

**Code fix:**
```typescript
// Before (5 accordions)
const allAccordions = ["identite", "coordonnees", "profil-artistique", "streaming", "notes-studio"];

// After (6 accordions)
const allAccordions = ["identite", "coordonnees", "relations-professionnelles", "profil-artistique", "streaming", "notes-studio"];
```

### Pitfall 2: Query Crashes on Undefined clientId in Creation Mode

**What goes wrong:** tRPC query executes with `{ companyId: undefined }`, backend returns 400 error, page crashes or shows error toast

**Why it happens:** In creation mode, `formData.id` doesn't exist yet (client not saved), but query enabled by default

**How to avoid:**
1. ALWAYS add `enabled: formData.id !== undefined` to query options
2. Wrap `CompanyMembersIndicator` in conditional: `{formData.id ? <Indicator /> : <Placeholder />}`
3. Show helpful message: "Enregistrez d'abord ce client pour gérer les relations"

**Warning signs:** Check browser console for tRPC errors when opening accordion on "Nouveau client" page

**Code pattern:**
```typescript
// WRONG - crashes in creation mode
const membersQuery = trpc.clients.getMembers.useQuery({ companyId: formData.id });

// RIGHT - defensive
const membersQuery = trpc.clients.getMembers.useQuery(
  { companyId: formData.id! },
  { enabled: formData.id !== undefined }
);

// Also wrap in JSX
{formData.id ? (
  <CompanyMembersIndicator clientId={formData.id} ... />
) : (
  <p className="text-sm text-muted-foreground">Enregistrez d'abord...</p>
)}
```

### Pitfall 3: Accordion Position Breaks Visual Flow

**What goes wrong:** Relations professionnelles accordion placed at wrong position, breaks user workflow logic

**Why it happens:** Arbitrary insertion order without considering studio business workflow

**How to avoid:**
- Follow CONTEXT.md decision: Position 3 (after Coordonnées, before Profil Artistique)
- Rationale: Relations = business context, should come before artistic details
- Accordion order: Identité → Coordonnées → Relations Pro → Profil Artistique → Streaming → Notes Studio

**Warning signs:** User confusion during manual testing, "why is this here?" feedback

**Correct structure:**
```tsx
<Accordion ...>
  <AccordionItem value="identite">{/* 1 */}</AccordionItem>
  <AccordionItem value="coordonnees">{/* 2 */}</AccordionItem>
  <AccordionItem value="relations-professionnelles">{/* 3 - NEW */}</AccordionItem>
  <AccordionItem value="profil-artistique">{/* 4 */}</AccordionItem>
  <AccordionItem value="streaming">{/* 5 */}</AccordionItem>
  <AccordionItem value="notes-studio">{/* 6 */}</AccordionItem>
</Accordion>
```

### Pitfall 4: Icon Color Inconsistency

**What goes wrong:** Users icon uses different color than other section icons, visual inconsistency

**Why it happens:** Copy-paste from other files without checking Phase 26.1 color standards

**How to avoid:**
- All accordion icons use `text-primary` (Phase 26.1 established pattern)
- Check existing accordions for reference: `<Music className="h-5 w-5 text-primary" />`

**Code:**
```tsx
// Correct
<Users className="h-5 w-5 text-primary" />

// Wrong
<Users className="h-5 w-5" />  // No color class
<Users className="h-5 w-5 text-blue-500" />  // Custom color
```

### Pitfall 5: Missing Separator in VIEW Mode

**What goes wrong:** CompanyMembersIndicator runs into next section without visual separation

**Why it happens:** Phase 25 original implementation included Separator, easy to forget during restoration

**How to avoid:**
- Always add `<Separator className="my-4" />` after CompanyMembersIndicator in VIEW mode
- Check Phase 25 commit `3141bd3` for original placement

**Code:**
```tsx
// VIEW mode (ClientDetailTabs.tsx)
<CompanyMembersIndicator ... />
<Separator className="my-4" />  // Don't forget this!
{/* Next section */}
```

## Code Examples

Verified patterns from official sources and existing implementation:

### VIEW Mode Integration (ClientDetailTabs.tsx)

```tsx
// Source: Phase 25 original implementation (commit 3141bd3)
// Location: After contact info section, before music section

import { CompanyMembersIndicator } from "@/components/CompanyMembersIndicator";

// Inside ClientDetailTabs component, INFO tab content
<div className="space-y-6">
  {/* Existing contact info sections */}

  {/* Relations Professionnelles */}
  <CompanyMembersIndicator
    clientId={client.id}
    clientType={client.type}
    clientName={client.name}
    isEditing={false}
  />
  <Separator className="my-4" />

  {/* Existing music/genre sections */}
</div>
```

### EDIT Mode Integration (ClientEditForm.tsx)

```tsx
// Source: Phase 26.1 accordion structure + Phase 25 component integration
// Location: 3rd accordion, after Coordonnées, before Profil Artistique

import { Users } from "lucide-react";
import { CompanyMembersIndicator } from "@/components/CompanyMembersIndicator";

// Update Alt key accordion list
const allAccordions = [
  "identite",
  "coordonnees",
  "relations-professionnelles",  // Add this
  "profil-artistique",
  "streaming",
  "notes-studio"
];

// Inside Accordion component (position 3)
<AccordionItem value="relations-professionnelles">
  <Card>
    <AccordionTrigger className="px-4 py-3 hover:no-underline">
      <h3 className="text-lg font-semibold flex items-center gap-2">
        <Users className="h-5 w-5 text-primary" />
        Relations professionnelles
      </h3>
    </AccordionTrigger>
    <AccordionContent>
      <div className="px-4 pb-3 space-y-3">
        {formData.id ? (
          <CompanyMembersIndicator
            clientId={formData.id}
            clientType={formData.type}
            clientName={formData.name || formData.companyName || ''}
            isEditing={true}
          />
        ) : (
          <p className="text-sm text-muted-foreground">
            Enregistrez d'abord ce client pour gérer les relations professionnelles.
          </p>
        )}
      </div>
    </AccordionContent>
  </Card>
</AccordionItem>
```

### tRPC Query Conditional Enabling Pattern

```typescript
// Source: tRPC v11 documentation + CompanyMembersModal.tsx implementation
// https://trpc.io/docs/client/react/useQuery

// Inside CompanyMembersIndicator component
const membersQuery = clientType === "company"
  ? trpc.clients.getMembers.useQuery(
      { companyId: clientId },
      {
        enabled: clientId !== undefined,  // Only fetch when ID exists
        refetchOnWindowFocus: false       // Optional: reduce refetches
      }
    )
  : trpc.clients.getCompanies.useQuery(
      { memberId: clientId },
      {
        enabled: clientId !== undefined,
        refetchOnWindowFocus: false
      }
    );
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Separate modals for company→members and individual→companies | Single bidirectional modal with `clientType` prop | Phase 25 (Jan 2026) | 50% less code, consistent UX |
| Manual query invalidation after mutations | tRPC mutation callbacks with `utils.*.invalidate()` | tRPC v11 | Auto-refresh all related queries |
| Always-enabled queries | Conditional `enabled` option | TanStack Query v5 | Performance boost, prevents crashes |
| Separate edit buttons for role changes | Inline editing (onChange + onBlur) | Phase 25 (Jan 2026) | Reduced friction, fewer clicks |
| 7 scattered accordions in edit form | 5 workflow-aligned accordions | Phase 26.1 (Jan 2026) | Better UX, reduced overwhelm |

**Deprecated/outdated:**
- **tRPC v9/v10 "Classic" React Query integration:** Use new v11 Query-native factories ([tRPC React Query docs](https://trpc.io/docs/client/react))
- **Manual accordion state with refs:** Use shadcn/ui `value`/`onValueChange` controlled state
- **`undefined` in form state:** Always use `""` for empty strings ([React Forms Best Practices](https://www.fullstackfoundations.com/blog/react-forms-best-practices))

## Open Questions

Things that couldn't be fully resolved:

1. **Should Relations accordion be open by default?**
   - What we know: CONTEXT.md specifies "Fermé" (closed by default), aligning with Phase 26.1 decision (only Identité open)
   - What's unclear: User might want it open for quick access during client creation workflow
   - Recommendation: Follow CONTEXT.md (closed by default), can adjust in future if user requests

2. **Performance impact of 6 accordions with multiple queries**
   - What we know: Conditional enabling prevents unnecessary fetches
   - What's unclear: Total page load time with all queries, especially on slow networks
   - Recommendation: Implement as planned, monitor in production, add loading skeletons if needed

3. **Should creation mode show disabled indicator or hide it completely?**
   - What we know: CONTEXT.md doesn't specify, current plan hides it with placeholder text
   - What's unclear: User preference - might want to see indicator (disabled) as preview of what's coming
   - Recommendation: Use placeholder text approach (clearer communication), revisit if user feedback requests preview

## Sources

### Primary (HIGH confidence)
- **Codebase Analysis:**
  - `.planning/phases/25-gestion-relations-client-entreprise/25-01-SUMMARY.md` - Phase 25 implementation details
  - `.planning/phases/26.1-reorganisation-accordeons---logique-studio-d'enregistrement/26.1-01-SUMMARY.md` - Phase 26.1 changes
  - `.planning/phases/26.2-restaurer-relations-professionnelles/26.2-CONTEXT.md` - User decisions and requirements
  - `packages/client/src/components/CompanyMembersModal.tsx` (374 lines) - Existing modal implementation
  - `packages/client/src/components/CompanyMembersIndicator.tsx` (93 lines) - Existing indicator implementation
  - `packages/client/src/components/ClientEditForm.tsx` - Current 5-accordion structure
  - `packages/server/src/routers/clients.ts` - Backend endpoints (addMember, updateMember, removeMember, getMembers, getCompanies, getRoles)

- **Official Documentation:**
  - [shadcn/ui Accordion](https://ui.shadcn.com/docs/components/accordion) - Component API and best practices
  - [tRPC React Query Integration](https://trpc.io/docs/client/react) - useQuery options and conditional enabling
  - [React Conditional Rendering](https://react.dev/learn/conditional-rendering) - Official React docs

### Secondary (MEDIUM confidence)
- [Shadcn Accordion Components](https://shadcnstudio.com/docs/components/accordion) - Best practices and variants
- [tRPC 2026 Guide](https://dev.to/christadrian/mastering-trpc-with-react-server-components-the-definitive-2026-guide-1i2e) - tRPC v11 patterns
- [React State Management 2026](https://www.nucamp.co/blog/state-management-in-2026-redux-context-api-and-modern-patterns) - Modern state patterns
- [React Forms Best Practices](https://www.fullstackfoundations.com/blog/react-forms-best-practices) - Form initialization and undefined values

### Tertiary (LOW confidence)
- [React Design Patterns 2026](https://www.sayonetech.com/blog/react-design-patterns/) - General patterns (not specific to accordion)
- [React Accordion Component Guide](https://www.sitepoint.com/react-js-accordion-component/) - Generic implementation (not shadcn/ui specific)

## Metadata

**Confidence breakdown:**
- **Standard stack:** HIGH - All libraries already in project, versions verified
- **Architecture patterns:** HIGH - Based on existing Phase 25 implementation + Phase 26.1 accordion structure
- **Pitfalls:** HIGH - Derived from Phase 26.1 SUMMARY documented issues + React best practices
- **Code examples:** HIGH - Copied from actual working codebase (Phase 25 commits)

**Research date:** 2026-01-21
**Valid until:** 30 days (stable architecture, unlikely to change)

**Key risks mitigated:**
- ✅ Backend endpoints verified (all 6 exist and functional)
- ✅ Components verified (both exist in codebase, not deleted)
- ✅ Accordion pattern verified (Phase 26.1 established structure)
- ✅ User requirements verified (CONTEXT.md decisions documented)
- ✅ Common pitfalls identified (formData.id undefined, Alt key list, icon colors)

**Ready for planning:** All technical domains investigated, no blockers identified.
