---
phase: 26.2-restaurer-relations-professionnelles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/components/ClientEditForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can manage professional relationships in EDIT mode (/clients/4?edit=true)"
    - "6th accordion 'Relations professionnelles' appears after Coordonnées"
    - "Modal opens when clicking relationship management button"
    - "Alt key toggles all 6 accordions open/close"
    - "Creation mode shows helpful placeholder (no crash)"
  artifacts:
    - path: "packages/client/src/components/ClientEditForm.tsx"
      provides: "6th accordion with CompanyMembersIndicator integration"
      min_lines: 1150
      contains: "relations-professionnelles"
  key_links:
    - from: "ClientEditForm.tsx"
      to: "CompanyMembersIndicator"
      via: "import and conditional render"
      pattern: "import.*CompanyMembersIndicator"
    - from: "Alt key handler"
      to: "relations-professionnelles accordion"
      via: "allAccordions array includes new value"
      pattern: 'allAccordions.*"relations-professionnelles"'
    - from: "AccordionItem value"
      to: "Position 3 in DOM"
      via: "After coordonnees, before profil-artistique"
      pattern: "coordonnees.*relations-professionnelles.*profil-artistique"
---

<objective>
Restore Phase 25 company-member relationship management functionality that was removed during Phase 26.1 accordion reorganization.

Purpose: Enable users to manage professional relationships (individuals ↔ companies) directly in EDIT mode without leaving the client edit form.

Output: 6th accordion "Relations professionnelles" in ClientEditForm.tsx with full CRUD capabilities via CompanyMembersModal integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26.2-restaurer-relations-professionnelles/26.2-CONTEXT.md
@.planning/phases/26.2-restaurer-relations-professionnelles/26.2-RESEARCH.md
@.planning/phases/25-gestion-relations-client-entreprise/25-01-SUMMARY.md
@.planning/phases/26.1-reorganisation-accordeons---logique-studio-d'enregistrement/26.1-01-SUMMARY.md
@packages/client/src/components/ClientEditForm.tsx
@packages/client/src/components/CompanyMembersIndicator.tsx
@packages/client/src/components/CompanyMembersModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Add 6th accordion "Relations professionnelles" to ClientEditForm.tsx (EDIT mode only)</name>
  <files>packages/client/src/components/ClientEditForm.tsx</files>
  <action>
**CRITICAL:** Modify ONLY ClientEditForm.tsx. DO NOT modify ClientDetailTabs.tsx (VIEW mode).

**Step 1: Add imports (after existing Lucide imports, line ~23)**
```typescript
import { Users } from "lucide-react";
import { CompanyMembersIndicator } from "@/components/CompanyMembersIndicator";
```

**Step 2: Update Alt key accordion list (line ~62)**
Change:
```typescript
const allAccordions = ["identite", "coordonnees", "profil-artistique", "streaming", "notes-studio"];
```
To:
```typescript
const allAccordions = ["identite", "coordonnees", "relations-professionnelles", "profil-artistique", "streaming", "notes-studio"];
```

**Step 3: Add 6th AccordionItem at position 3 (after "coordonnees" AccordionItem, before "profil-artistique" AccordionItem)**

Search for the closing `</AccordionItem>` tag of "coordonnees" accordion (~line 550-600 range).

Insert immediately after that closing tag:

```tsx
      {/* 3. Relations professionnelles */}
      <AccordionItem value="relations-professionnelles">
        <Card>
          <AccordionTrigger className="px-4 py-3 hover:no-underline">
            <h3 className="text-lg font-semibold flex items-center gap-2">
              <Users className="h-5 w-5 text-primary" />
              Relations professionnelles
            </h3>
          </AccordionTrigger>
          <AccordionContent>
            <div className="px-4 pb-3 space-y-3">
              {formData.id ? (
                <CompanyMembersIndicator
                  clientId={formData.id}
                  clientType={formData.type}
                  clientName={formData.name || formData.companyName || ''}
                  isEditing={true}
                />
              ) : (
                <p className="text-sm text-muted-foreground">
                  Enregistrez d'abord ce client pour gérer les relations professionnelles.
                </p>
              )}
            </div>
          </AccordionContent>
        </Card>
      </AccordionItem>
```

**WHY these changes:**
- `Users` icon with `text-primary` = consistent with Phase 26.1 icon color standards
- Position 3 (after Coordonnées) = CONTEXT.md decision for business workflow logic
- Conditional `formData.id` check = prevents crash in creation mode (defensive pattern from RESEARCH.md Pitfall 2)
- Placeholder text in creation mode = clear user guidance (RESEARCH.md recommendation)
- `isEditing={true}` = enables "Gérer les relations" button in modal
- Closed by default (not in `defaultValue` array) = CONTEXT.md decision + Phase 26.1 pattern

**DO NOT:**
- ❌ Modify ClientDetailTabs.tsx (VIEW mode stays unchanged)
- ❌ Add new state variables (CompanyMembersIndicator manages its own modal state)
- ❌ Enable queries in this file (CompanyMembersIndicator handles query enabling internally)
- ❌ Change other accordions (only add new one)
  </action>
  <verify>
**Code verification:**
```bash
# 1. Check imports added
grep "import.*Users.*from.*lucide-react" packages/client/src/components/ClientEditForm.tsx
grep "import.*CompanyMembersIndicator" packages/client/src/components/ClientEditForm.tsx

# 2. Check Alt key array updated (should show 6 items)
grep -A 1 "const allAccordions" packages/client/src/components/ClientEditForm.tsx | grep "relations-professionnelles"

# 3. Check accordion exists at position 3
grep -n "relations-professionnelles" packages/client/src/components/ClientEditForm.tsx

# 4. TypeScript check
cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid
pnpm --filter client check

# 5. Production build check
pnpm --filter client build
```

**Manual browser testing (after code verification):**
1. Start dev server: `./start.sh`
2. Navigate to http://localhost:5174/clients/4
3. Click "Modifier" button (enter EDIT mode with ?edit=true)
4. Verify 5 accordions visible + new 6th "Relations professionnelles"
5. Verify accordion position: Identité, Coordonnées, **Relations professionnelles**, Profil Artistique, Streaming, Notes Studio
6. Verify default state: Only "Identité" open, others closed
7. Click "Relations professionnelles" to expand
8. Verify CompanyMembersIndicator appears with preview + "Gérer les relations" button
9. Click "Gérer les relations" → Modal opens with member/company list
10. Add/remove a relation → Verify modal mutations work
11. Press Alt key → Verify all 6 accordions toggle open/close
12. Navigate to /clients/new (creation mode)
13. Click "Relations professionnelles" → Verify placeholder text (no crash)
14. Verify ClientDetailTabs.tsx VIEW mode unchanged (no new sections added)

**Expected results:**
- TypeScript 0 errors
- Production build successful
- 6 accordions in EDIT mode (5→6 increase)
- Position 3 correct (after Coordonnées, before Profil Artistique)
- Alt key toggles all 6 accordions
- Modal CRUD operations functional
- Creation mode shows placeholder (no crash)
- VIEW mode unchanged
  </verify>
  <done>
✅ **Code complete:**
- Users icon imported from lucide-react
- CompanyMembersIndicator imported
- Alt key array includes "relations-professionnelles" (6 items total)
- 6th AccordionItem added at position 3 with correct structure
- Conditional rendering prevents crash in creation mode
- TypeScript check passes (0 errors)
- Production build successful

✅ **Manual testing complete:**
- EDIT mode shows 6 accordions (verified in browser)
- Position 3 confirmed (after Coordonnées, before Profil Artistique)
- Default state: only Identité open
- CompanyMembersIndicator renders correctly
- Modal opens and CRUD operations work
- Alt key toggles all 6 accordions
- Creation mode shows placeholder (no crash)
- VIEW mode unchanged (no new UI in ClientDetailTabs)

✅ **No regressions:**
- Other 5 accordions unchanged
- Phase 26.1 styling preserved (text-primary icons, px-4 py-3, space-y-3)
- Phase 25 functionality restored (relationship management via modal)
  </done>
</task>

</tasks>

<verification>
**Functional verification:**
1. EDIT mode (/clients/4?edit=true) displays 6 accordions
2. Accordion order matches workflow: Identité → Coordonnées → Relations professionnelles → Profil Artistique → Streaming → Notes Studio
3. CompanyMembersModal CRUD works (add/update/remove members)
4. Alt key toggles all 6 accordions simultaneously
5. Creation mode (/clients/new) shows placeholder, no crash

**Code quality verification:**
1. TypeScript compilation: 0 errors
2. Production build: successful
3. No ESLint warnings introduced
4. Imports organized (Lucide icons together, component imports together)

**Regression verification:**
1. Other 5 accordions unchanged
2. VIEW mode (ClientDetailTabs.tsx) unchanged
3. Phase 26.1 styling preserved
4. Phase 25 backend endpoints unchanged
</verification>

<success_criteria>
**Primary:**
1. 6th accordion "Relations professionnelles" visible in EDIT mode at position 3
2. CompanyMembersIndicator integrated with conditional rendering
3. Modal opens and performs CRUD operations successfully
4. Alt key handler updated to include 6th accordion
5. Creation mode handles missing formData.id gracefully (placeholder)

**Secondary:**
1. TypeScript 0 errors
2. Production build successful
3. No visual regressions in other accordions
4. VIEW mode explicitly unchanged (no modifications to ClientDetailTabs.tsx)
5. Phase 25 functionality fully restored

**User experience:**
1. User can manage professional relationships without leaving EDIT mode
2. Workflow logic preserved (Relations after Coordonnées = business context before artistic profile)
3. Consistent UX with Phase 26.1 accordion patterns
4. No crashes or errors in any client lifecycle state (view/edit/create)
</success_criteria>

<output>
After completion, create `.planning/phases/26.2-restaurer-relations-professionnelles/26.2-01-SUMMARY.md` documenting:
- Code changes (imports, Alt key array, accordion structure)
- Manual testing results (6 accordions verified, modal CRUD tested)
- Verification checklist completion
- Any deviations or issues encountered
- Screenshots or notes from browser testing
</output>
