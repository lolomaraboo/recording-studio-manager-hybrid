---
phase: 26.2-restaurer-relations-professionnelles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/components/ClientDetailTabs.tsx
  - packages/client/src/components/ClientEditForm.tsx
autonomous: true

must_haves:
  truths:
    - "Relations professionnelles visibles en mode VIEW (ClientDetailTabs)"
    - "Relations professionnelles modifiables en mode EDIT (6ème accordion)"
    - "Indicateur affiche le bon nombre de relations (members/companies)"
    - "Modal permet CRUD complet (add/update/remove membres/entreprises)"
    - "Alt key toggle fonctionne avec les 6 accordions"
  artifacts:
    - path: "packages/client/src/components/ClientDetailTabs.tsx"
      provides: "CompanyMembersIndicator integration in VIEW mode"
      contains: "CompanyMembersIndicator"
      min_lines: 620
    - path: "packages/client/src/components/ClientEditForm.tsx"
      provides: "Relations professionnelles accordion (6th)"
      contains: "relations-professionnelles"
      min_lines: 1150
  key_links:
    - from: "ClientDetailTabs.tsx"
      to: "CompanyMembersIndicator.tsx"
      via: "import and component render"
      pattern: "import.*CompanyMembersIndicator"
    - from: "ClientEditForm.tsx"
      to: "CompanyMembersIndicator.tsx"
      via: "accordion item with indicator"
      pattern: "AccordionItem.*relations-professionnelles"
    - from: "ClientEditForm.tsx (Alt key handler)"
      to: "allAccordions array"
      via: "includes relations-professionnelles"
      pattern: "relations-professionnelles.*allAccordions"
---

<objective>
Restaurer la fonctionnalité de gestion des relations professionnelles (Phase 25) qui a été supprimée lors de la refonte UI Phase 26.1.

Purpose: Permettre aux utilisateurs de voir et modifier les relations many-to-many entre clients individuels et entreprises, en réintégrant les composants existants CompanyMembersModal et CompanyMembersIndicator dans les modes VIEW et EDIT.

Output:
- MODE VIEW: CompanyMembersIndicator visible après section contact
- MODE EDIT: 6ème accordion "Relations professionnelles" (position 3, fermé par défaut)
- Fonctionnalité Phase 25 100% restaurée sans régression
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase Context and Research
@.planning/phases/26.2-restaurer-relations-professionnelles/26.2-CONTEXT.md
@.planning/phases/26.2-restaurer-relations-professionnelles/26.2-RESEARCH.md

# Prior Phase Summaries
@.planning/phases/25-gestion-relations-client-entreprise/25-01-SUMMARY.md
@.planning/phases/25-gestion-relations-client-entreprise/25-02-SUMMARY.md
@.planning/phases/26.1-reorganisation-accordeons---logique-studio-d'enregistrement/26.1-01-SUMMARY.md

# Files to modify
@packages/client/src/components/ClientDetailTabs.tsx
@packages/client/src/components/ClientEditForm.tsx

# Existing components to integrate (DO NOT MODIFY)
@packages/client/src/components/CompanyMembersModal.tsx
@packages/client/src/components/CompanyMembersIndicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restore CompanyMembersIndicator in VIEW mode (ClientDetailTabs.tsx)</name>
  <files>packages/client/src/components/ClientDetailTabs.tsx</files>
  <action>
    Integrate CompanyMembersIndicator component in VIEW mode of ClientDetailTabs.tsx.

    **Import statements (add after line 38):**
    ```typescript
    import { CompanyMembersIndicator } from "./CompanyMembersIndicator";
    ```

    **Component integration (INFO tab, after contact info sections, before music section):**
    - Find the section with phone/email/website display (~line 300-400)
    - After the contact info sections and before the music/genre sections
    - Add:
    ```tsx
    {/* Relations Professionnelles */}
    <CompanyMembersIndicator
      clientId={client.id}
      clientType={client.type}
      clientName={client.name}
      isEditing={false}
    />
    <Separator className="my-4" />
    ```

    **IMPORTANT:**
    - CompanyMembersIndicator already exists at packages/client/src/components/CompanyMembersIndicator.tsx (93 lines)
    - It already imports CompanyMembersModal internally
    - DO NOT modify CompanyMembersIndicator or CompanyMembersModal
    - Just import and render the indicator component
    - The indicator handles all the logic (queries, modal state, display)
    - Add Separator after indicator for visual separation

    **Defensive checks:**
    - Verify client.id exists before rendering
    - client.type should be "company" or "individual"
    - client.name should be string (fallback to empty string if undefined)
  </action>
  <verify>
    1. TypeScript compilation: `pnpm check` (0 errors expected)
    2. Build: `pnpm build` (successful)
    3. Code inspection:
       - Import statement added correctly
       - CompanyMembersIndicator rendered in INFO tab
       - Separator added after indicator
       - Positioned after contact info, before music section
  </verify>
  <done>
    - CompanyMembersIndicator import added to ClientDetailTabs.tsx
    - Component rendered in VIEW mode with correct props (clientId, clientType, clientName, isEditing=false)
    - Separator added for visual separation
    - TypeScript 0 errors
    - Production build successful
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 6th accordion "Relations professionnelles" in EDIT mode (ClientEditForm.tsx)</name>
  <files>packages/client/src/components/ClientEditForm.tsx</files>
  <action>
    Add 6th accordion "Relations professionnelles" to ClientEditForm.tsx.

    **Step 1: Import statements (add after lucide-react imports ~line 23):**
    ```typescript
    import { CompanyMembersIndicator } from "./CompanyMembersIndicator";
    ```

    **Step 2: Update Alt key accordion list (line ~62):**
    ```typescript
    const allAccordions = [
      "identite",
      "coordonnees",
      "relations-professionnelles",  // ADD THIS LINE
      "profil-artistique",
      "streaming",
      "notes-studio"
    ];
    ```

    **Step 3: Add 6th accordion (Position 3: after "coordonnees", before "profil-artistique"):**
    Find the AccordionItem with value="coordonnees" and insert AFTER it:

    ```tsx
    {/* 3. Relations Professionnelles */}
    <AccordionItem value="relations-professionnelles">
      <Card>
        <AccordionTrigger className="px-4 py-3 hover:no-underline">
          <h3 className="text-lg font-semibold flex items-center gap-2">
            <Users className="h-5 w-5 text-primary" />
            Relations professionnelles
          </h3>
        </AccordionTrigger>
        <AccordionContent>
          <div className="px-4 pb-3 space-y-3">
            {formData.id ? (
              <CompanyMembersIndicator
                clientId={formData.id}
                clientType={formData.type}
                clientName={formData.name || formData.companyName || ''}
                isEditing={true}
              />
            ) : (
              <p className="text-sm text-muted-foreground">
                Enregistrez d'abord ce client pour gérer les relations professionnelles.
              </p>
            )}
          </div>
        </AccordionContent>
      </Card>
    </AccordionItem>
    ```

    **IMPORTANT:**
    - Users icon must use `text-primary` (consistency with Phase 26.1 icon colors)
    - Default state: Closed (NOT in openItems useState initial value)
    - Position: 3rd accordion (after Coordonnées, before Profil Artistique)
    - Conditional rendering: Only show indicator if formData.id exists
    - If formData.id undefined (creation mode), show placeholder message
    - CompanyMembersIndicator handles all queries and modal logic internally

    **Structure checklist:**
    - AccordionItem value="relations-professionnelles"
    - Card wrapper
    - AccordionTrigger with px-4 py-3 hover:no-underline
    - h3 with Users icon text-primary
    - AccordionContent > div with px-4 pb-3 space-y-3
    - Conditional: formData.id ? indicator : placeholder

    **Why this works:**
    - CompanyMembersIndicator is bidirectional (handles both company→members and individual→companies)
    - formData.type switches component behavior
    - Conditional rendering prevents query crash when formData.id is undefined
    - Alt key toggle will now work with all 6 accordions
  </action>
  <verify>
    1. TypeScript compilation: `pnpm check` (0 errors expected)
    2. Build: `pnpm build` (successful)
    3. Code inspection:
       - CompanyMembersIndicator import added
       - allAccordions array includes "relations-professionnelles" (6 items total)
       - 6th accordion added at position 3 (after coordonnees, before profil-artistique)
       - Users icon has text-primary class
       - Conditional rendering: formData.id check present
       - Placeholder message for creation mode present
       - AccordionTrigger styling consistent with other accordions
  </verify>
  <done>
    - CompanyMembersIndicator import added to ClientEditForm.tsx
    - allAccordions array updated to 6 items (includes "relations-professionnelles")
    - 6th accordion "Relations professionnelles" added at position 3
    - Conditional rendering implemented (shows indicator if formData.id exists, placeholder otherwise)
    - Users icon with text-primary class
    - Consistent accordion structure (Card, AccordionTrigger px-4 py-3, AccordionContent px-4 pb-3 space-y-3)
    - Alt key toggle functional with 6 accordions
    - TypeScript 0 errors
    - Production build successful
  </done>
</task>

</tasks>

<verification>

**Manual Testing Steps (Browser validation):**

1. **VIEW Mode (ClientDetailTabs.tsx):**
   - Navigate to any client detail page (/clients/:id)
   - Click "Informations" tab
   - Scroll to Relations Professionnelles section (after contact info, before music section)
   - For company clients: Verify "X membres : Name (Role), ..." displays
   - For individual clients: Verify "X entreprises : Company (Role), ..." displays
   - Click indicator → Modal should open
   - Modal should allow adding/updating/removing relations

2. **EDIT Mode (ClientEditForm.tsx):**
   - Navigate to any client detail page (/clients/:id)
   - Click "Modifier" button
   - Verify 6 accordions visible:
     1. Identité (open by default)
     2. Coordonnées (closed)
     3. Relations professionnelles (closed) ← NEW
     4. Profil Artistique (closed)
     5. Streaming (closed)
     6. Notes Studio (closed)
   - Click "Relations professionnelles" accordion → should expand
   - Verify indicator visible with relations count
   - Click "Gérer les relations" → Modal should open
   - Modal should allow CRUD operations
   - Test Alt key: Press Alt → all accordions should toggle (open all if any closed, close all if all open)

3. **Creation Mode (ClientEditForm.tsx):**
   - Navigate to /clients/create
   - Click "Relations professionnelles" accordion → should expand
   - Verify placeholder message: "Enregistrez d'abord ce client pour gérer les relations professionnelles."
   - No indicator should be visible
   - No queries should execute (check Network tab in DevTools)

4. **Regression Tests:**
   - Verify other 5 accordions unchanged
   - Verify VIEW mode contact info sections unchanged
   - Verify TypeScript 0 errors: `pnpm check`
   - Verify production build successful: `pnpm build`

**Expected Backend Queries (when accordion open and formData.id exists):**
- For company clients: `clients.getMembers` query with `{ companyId: formData.id }`
- For individual clients: `clients.getCompanies` query with `{ memberId: formData.id }`

**No Regressions Checklist:**
- [ ] Other accordions in EDIT mode unchanged
- [ ] VIEW mode contact info sections unchanged
- [ ] Alt key toggle works with 6 accordions
- [ ] TypeScript 0 errors
- [ ] Production build successful
- [ ] CompanyMembersModal functionality intact (from Phase 25)

</verification>

<success_criteria>

**Functional Requirements:**
- ✅ CompanyMembersIndicator visible in VIEW mode (ClientDetailTabs INFO tab)
- ✅ 6th accordion "Relations professionnelles" present in EDIT mode (position 3)
- ✅ Accordion closed by default (only Identité open)
- ✅ Indicator displays correct count (members/companies)
- ✅ Modal opens on indicator click (both VIEW and EDIT modes)
- ✅ Modal allows full CRUD operations (add/update/remove)
- ✅ Creation mode shows placeholder message (no crash on undefined formData.id)
- ✅ Alt key toggles all 6 accordions correctly

**Code Quality:**
- ✅ TypeScript 0 errors (`pnpm check` passes)
- ✅ Production build successful (`pnpm build` passes)
- ✅ Consistent icon colors (Users icon with text-primary)
- ✅ Consistent accordion structure (Card, padding, spacing)
- ✅ Defensive conditional rendering (formData.id check)
- ✅ Separator added in VIEW mode for visual separation

**No Regressions:**
- ✅ Phase 25 functionality fully restored (CompanyMembersModal, CompanyMembersIndicator)
- ✅ Phase 26.1 accordion structure preserved (other 5 accordions unchanged)
- ✅ VIEW mode contact sections unchanged
- ✅ Alt key toggle still works (updated to include 6th accordion)

**User Experience:**
- ✅ Relations visible without requiring mode switch (VIEW mode indicator)
- ✅ Relations editable via accordion (EDIT mode indicator + modal)
- ✅ Clear placeholder message in creation mode (no confusion)
- ✅ Visual consistency with Phase 26.1 design patterns

</success_criteria>

<output>
After completion, create `.planning/phases/26.2-restaurer-relations-professionnelles/26.2-01-SUMMARY.md` documenting:

- Files modified (2 files)
- Components integrated (CompanyMembersIndicator in 2 locations)
- Accordion count (5→6 in EDIT mode)
- Alt key toggle update (array expanded to 6 items)
- Manual testing results (VIEW mode, EDIT mode, creation mode)
- Verification of Phase 25 functionality restoration
- Any issues encountered and resolutions
- Screenshots or observations from browser testing

Include git commit hash for traceability.
</output>
