---
phase: 38-harmonisation-expenses---routing-cohÃ©rent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/components/ExpenseEditForm.tsx
  - packages/client/src/pages/ExpenseCreate.tsx
autonomous: true

must_haves:
  truths:
    - "User can create expense via accordion-based form (consistent with 11 other resources)"
    - "ExpenseCreate page uses accordion component (not inline form)"
    - "Form state persists in localStorage across sessions"
    - "Alt+Click toggles all accordions (power-user feature)"
    - "Creating expense returns to /expenses list page with success toast"
    - "Route /expenses/new already works (no routing changes needed)"
  artifacts:
    - path: "packages/client/src/components/ExpenseEditForm.tsx"
      provides: "Accordion-based form component (2 sections: Identity + Financial)"
      min_lines: 200
      exports: ["ExpenseEditForm"]
    - path: "packages/client/src/pages/ExpenseCreate.tsx"
      provides: "Updated create page using ExpenseEditForm component"
      min_lines: 100
      contains: "import { ExpenseEditForm }"
  key_links:
    - from: "packages/client/src/pages/ExpenseCreate.tsx"
      to: "ExpenseEditForm"
      via: "Import and render component"
      pattern: 'import.*ExpenseEditForm.*from.*@/components/ExpenseEditForm'
    - from: "packages/client/src/components/ExpenseEditForm.tsx"
      to: "localStorage"
      via: "Accordion state persistence"
      pattern: "localStorage\\.(get|set)Item\\('expenseEditAccordions'"
---

<objective>
Complete the final resource harmonization (12/12) by converting Expenses from inline form to accordion pattern, matching the established pattern from Services (Phase 29) and Talents (Phase 28).

Purpose: Achieve 100% UI consistency across all resources. Expenses is the last resource using inline forms. After this phase, all 12 resources (clients, sessions, invoices, equipment, rooms, projects, quotes, contracts, expenses, talents, tracks, services) will use identical accordion-based forms with localStorage persistence and Alt+Click toggle.

Output: ExpenseEditForm component (210 lines), updated ExpenseCreate page (105 lines). Zero routing changes neededâ€”route already exists. This completes the harmonization initiative started in Phase 22.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern reference (simplest form - Services has only 2 accordions)
@packages/client/src/pages/ServiceCreate.tsx
@packages/client/src/components/ServiceEditForm.tsx

# Current implementation (inline form to convert)
@packages/client/src/pages/ExpenseCreate.tsx

# No routing changes needed - route already exists in App.tsx
# @packages/client/src/App.tsx - Line 171: <Route path="expenses/new" element={<ExpenseCreate />} />
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExpenseEditForm accordion component</name>
  <files>packages/client/src/components/ExpenseEditForm.tsx</files>
  <action>
Create accordion-based form component at packages/client/src/components/ExpenseEditForm.tsx.

**Copy ServiceEditForm.tsx structure with Expense-specific fields:**

1. **Imports:** Same as ServiceEditForm (useState, useEffect, Card, Accordion components, Input, Textarea, Label, Select, icons)

2. **Interface:**
```typescript
interface ExpenseEditFormProps {
  formData: any;
  setFormData: (data: any) => void;
}
```

3. **Accordion state with localStorage:**
   - Key: 'expenseEditAccordions' (unique to expenses)
   - Default open: ["identite", "financial"] (2 accordions)
   - useEffect to save state on change

4. **Alt+Click toggle handler:**
   - allAccordions = ["identite", "financial"]
   - Toggle all open/closed logic (copy from ServiceEditForm lines 54-69)

5. **Accordion structure (2 sections):**

**Accordion 1: IdentitÃ© de la DÃ©pense**
- Icon: FileText (or Receipt for expense theme)
- Fields (4):
  - category: Select (required asterisk)
    Options: Loyer, Services publics, Assurance, Maintenance, Salaire, Marketing, Logiciel, Fournitures, Ã‰quipement, Autre
    Values: rent, utilities, insurance, maintenance, salary, marketing, software, supplies, equipment, other
  - description: Input maxLength={500} (required asterisk)
    Placeholder: "Ex: Achat microphone Neumann U87"
  - vendor: Input (optional, no asterisk)
    Placeholder: "Ex: Thomann"
  - expenseDate: Input type="date" (required asterisk)

**Accordion 2: Informations FinanciÃ¨res**
- Icon: DollarSign
- Fields (3):
  - amount: Input type="number" step="0.01" min="0" (required asterisk)
    Placeholder: "2500.00"
  - currency: Input maxLength={3} (optional, default EUR)
    Placeholder: "EUR"
  - taxAmount: Input type="number" step="0.01" min="0" (optional)
    Placeholder: "500.00"

6. **Card wrapper:** Each AccordionItem wrapped in <Card> for visual consistency

7. **Trigger onClick:** Pass handleAccordionTriggerClick to enable Alt+Click

**Pattern source:** ServiceEditForm.tsx (Phase 29) - simplest 2-accordion pattern

**Expected output:** ~210 lines (similar to ServiceEditForm at 200 lines)

**Current field IDs from ExpenseCreate.tsx (lines 95-198):** Use exact same field names and validation patterns
  </action>
  <verify>
File exists at packages/client/src/components/ExpenseEditForm.tsx with:
- Export: export function ExpenseEditForm
- localStorage key: 'expenseEditAccordions'
- 2 accordion sections: "identite", "financial"
- Accordion 1 contains: category Select, description Input, vendor Input, expenseDate Input (type="date")
- Accordion 2 contains: amount Input, currency Input, taxAmount Input
- Alt+Click handler implemented (allAccordions array)
- Card wrapper on each AccordionItem

Run: grep -E "(expenseEditAccordions|AccordionItem value=\"identite\"|AccordionItem value=\"financial\")" packages/client/src/components/ExpenseEditForm.tsx
Expected: 3+ matches (localStorage key + 2 accordion values)
  </verify>
  <done>
ExpenseEditForm.tsx exists with 2-accordion structure (Identity + Financial). All 7 expense fields present (category, description, vendor, expenseDate, amount, currency, taxAmount). localStorage persistence configured. Alt+Click toggle handler implemented. Component exports ExpenseEditForm function. TypeScript compiles with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert ExpenseCreate to use ExpenseEditForm component</name>
  <files>packages/client/src/pages/ExpenseCreate.tsx</files>
  <action>
Refactor ExpenseCreate.tsx to use ExpenseEditForm accordion component instead of inline form.

**Step 1: Update imports (add ExpenseEditForm, remove unused form components):**
```typescript
// ADD after line 10:
import { ExpenseEditForm } from "@/components/ExpenseEditForm";

// REMOVE (no longer needed with accordion component):
// - Input, Label, Select, SelectContent, SelectItem, SelectTrigger, SelectValue imports (lines 6-7)
// - Card, CardContent, CardDescription, CardHeader, CardTitle imports (line 4)
// Keep: Button, Link, trpc, ArrowLeft, Save (still used)
```

**Step 2: Update header icon (line 78):**
```typescript
// BEFORE:
<h1 className="text-3xl font-bold">Nouvelle DÃ©pense</h1>

// AFTER (add icon like ServiceCreate does with Package):
<h1 className="text-3xl font-bold flex items-center gap-2">
  <FileText className="h-8 w-8 text-primary" />
  Nouvelle DÃ©pense
</h1>
```
Import FileText from lucide-react.

**Step 3: Replace inline form (lines 85-217) with component:**
```typescript
{/* Form */}
<form onSubmit={handleSubmit} className="space-y-2">
  <ExpenseEditForm formData={formData} setFormData={setFormData} />

  {/* Actions */}
  <div className="flex gap-3 pt-2">
    <Button type="submit" disabled={createMutation.isPending}>
      <Save className="mr-2 h-4 w-4" />
      {createMutation.isPending ? "CrÃ©ation..." : "CrÃ©er la dÃ©pense"}
    </Button>
    <Button
      type="button"
      variant="outline"
      asChild
    >
      <Link to="/expenses">Annuler</Link>
    </Button>
  </div>
</form>
```

**Key changes:**
- Replace entire Card + CardContent block (lines 86-216) with: `<ExpenseEditForm formData={formData} setFormData={setFormData} />`
- Move action buttons OUTSIDE Card (now rendered by ExpenseEditForm)
- Keep exact same handleSubmit validation logic (lines 37-64)
- Keep exact same formData state (lines 27-35)
- Keep exact same mutation logic (lines 16-24)

**Pattern reference:** ServiceCreate.tsx lines 1-108 (Phase 29) - shows how inline form was replaced with component

**Expected output:** ~105 lines (down from 221 lines, but logic preserved)

**DO NOT change:**
- Form validation (lines 41-52)
- Mutation logic (lines 55-63)
- formData state structure (lines 27-35)
- Navigation flow (lines 18-23)
  </action>
  <verify>
ExpenseCreate.tsx changes verified:
1. Import added: import { ExpenseEditForm } from "@/components/ExpenseEditForm"
2. FileText icon added to header
3. Inline form fields removed (lines 92-198 deleted)
4. ExpenseEditForm component rendered
5. Action buttons moved outside Card
6. handleSubmit validation preserved (lines 37-52)
7. File compiles with TypeScript 0 errors
8. File reduced from ~221 lines to ~105 lines

Run: grep "ExpenseEditForm" packages/client/src/pages/ExpenseCreate.tsx
Expected: 2 matches (import + component usage)

Run: grep -E "(Card|Input id=\"category\"|Input id=\"description\")" packages/client/src/pages/ExpenseCreate.tsx
Expected: 0 matches (inline form removed, component handles it)
  </verify>
  <done>
ExpenseCreate.tsx refactored: ExpenseEditForm component imported and used. Inline form code removed (92-198 lines deleted). Header updated with FileText icon. Action buttons preserved. Form validation logic unchanged. File compiles successfully. Clean separation: page handles logic, component handles presentation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build verification and type checking</name>
  <files>N/A</files>
  <action>
Verify all changes compile successfully and maintain type safety.

**Step 1: Type check all packages**
Run: `pnpm check`
Expected: 0 TypeScript errors across all packages

**Step 2: Build client package**
Run: `pnpm --filter client build`
Expected: Build succeeds with 0 errors, dist/ directory created

**Step 3: Verify imports resolve**
Check that ExpenseEditForm is imported correctly in ExpenseCreate:
Run: `grep "ExpenseEditForm" packages/client/src/pages/ExpenseCreate.tsx`
Expected: Import statement matches export from ExpenseEditForm.tsx

**Step 4: Verify form data structure matches**
Ensure formData fields in ExpenseCreate match fields used in ExpenseEditForm:
- category (Select in accordion 1)
- description (Input in accordion 1)
- vendor (Input in accordion 1)
- expenseDate (Input date in accordion 1)
- amount (Input in accordion 2)
- currency (Input in accordion 2)
- taxAmount (Input in accordion 2)

**If errors occur:**
- Import path issues: Verify @/components alias works
- Type errors: Check formData interface matches between ExpenseCreate and ExpenseEditForm
- Build errors: Run `pnpm install` if missing dependencies

**Pattern verification checklist:**
- [ ] ExpenseEditForm has 2 accordions (Identity, Financial)
- [ ] localStorage key is unique ('expenseEditAccordions')
- [ ] Alt+Click handler present in ExpenseEditForm
- [ ] ExpenseCreate uses component (not inline form)
- [ ] All 7 fields present (category, description, vendor, expenseDate, amount, currency, taxAmount)
- [ ] Form validation preserved from original
- [ ] Route already exists (no routing changes needed)
  </action>
  <verify>
Run: pnpm check
Expected: "âœ“ Checked N files in Xms" with 0 errors

Run: pnpm --filter client build
Expected: "dist/index.html" created, build size reported, 0 errors

Run: ls packages/client/dist/
Expected: index.html, assets/ directory exist
  </verify>
  <done>
All TypeScript checks pass (0 errors). Client builds successfully. ExpenseEditForm component and ExpenseCreate refactor compile without issues. Pattern verification complete: Expenses harmonization matches established pattern from Services (Phase 29) and Talents (Phase 28). 12/12 resources now use accordion forms. Ready for manual testing.
  </done>
</task>

</tasks>

<verification>
**Automated verification:**
1. `pnpm check` passes with 0 TypeScript errors
2. `pnpm --filter client build` succeeds
3. ExpenseEditForm.tsx exists with 200+ lines
4. ExpenseCreate.tsx reduced from 221 to ~105 lines
5. ExpenseEditForm component properly exports function
6. ExpenseCreate imports and uses ExpenseEditForm

**Manual verification (user testing):**
1. Navigate to /expenses page
2. Click "Nouvelle dÃ©pense" button
3. Verify navigation to /expenses/new (URL already works)
4. Verify ExpenseCreate page renders with:
   - Header: "Nouvelle DÃ©pense" with FileText icon
   - Back button to /expenses
   - 2 accordion sections (Identity, Financial)
   - All 7 fields present (category, description, vendor, expenseDate, amount, currency, taxAmount)
   - "CrÃ©er la dÃ©pense" submit button
   - "Annuler" button (returns to /expenses)
5. Test accordion interactions:
   - Click accordion headers to expand/collapse
   - Alt+Click on any header to toggle all accordions
6. Fill form with valid data and submit
7. Verify success toast appears
8. Verify navigation returns to /expenses list
9. Verify new expense appears in table
10. Refresh page and return to /expenses/new
11. Verify accordion state persisted (same accordions open as before)

**Goal-backward verification (must_haves):**
- âœ“ User can create expense via accordion form (ExpenseEditForm exists)
- âœ“ ExpenseCreate uses component not inline form (refactored)
- âœ“ localStorage persistence (expenseEditAccordions key used)
- âœ“ Alt+Click toggle (handleAccordionTriggerClick handler present)
- âœ“ Success flow returns to list (navigate("/expenses") in onSuccess)
- âœ“ Route works (no changes needed, already exists)
</verification>

<success_criteria>
**Code artifacts:**
- [x] ExpenseEditForm.tsx created (200-220 lines)
- [x] ExpenseCreate.tsx refactored (reduced from 221 to ~105 lines)
- [x] No routing changes needed (route already exists)

**Functional requirements:**
- [x] /expenses/new route accessible (already works)
- [x] ExpenseCreate page renders correctly
- [x] Form has 2 accordion sections (Identity + Financial)
- [x] All 7 expense fields present and functional
- [x] Validation works (required fields checked)
- [x] Submit creates expense via tRPC mutation
- [x] Success returns to /expenses list with toast
- [x] Error shows toast with message
- [x] Accordion state persists in localStorage
- [x] Alt+Click toggles all accordions

**Pattern consistency:**
- [x] Matches ServiceEditForm structure (Phase 29)
- [x] Consistent with 11 other harmonized resources (Phases 22-29)
- [x] Accordion-based form (not inline)
- [x] localStorage persistence with unique key
- [x] TypeScript strict mode passes (0 errors)

**Harmonization complete:**
- [x] 12/12 resources now use accordion forms
- [x] Complete resource list:
  1. âœ… Clients (Phase 22)
  2. âœ… Sessions (Phase 23)
  3. âœ… Invoices (Phase 24)
  4. âœ… Equipment (Phase 25)
  5. âœ… Rooms (Phase 26)
  6. âœ… Projects (Phase 27)
  7. âœ… Talents (Phase 28)
  8. âœ… Services (Phase 29)
  9. âœ… Quotes (previous phases)
  10. âœ… Contracts (previous phases)
  11. âœ… Tracks (previous phases)
  12. âœ… **Expenses (Phase 38 - FINAL)** ðŸŽ‰

**Documentation:**
- Phase 38 harmonization complete
- Expenses is last resource to use accordion pattern
- All 12 resources now have consistent UX
- No more inline forms anywhere in the application
- Pattern fully established and applied 100%
</success_criteria>

<output>
After completion, create `.planning/phases/38-harmonisation-expenses---routing-cohÃ©rent/38-01-SUMMARY.md` with:

**Frontmatter:**
- phase: 38-harmonisation-expenses---routing-cohÃ©rent
- plan: 01
- subsystem: ui-harmonization
- tags: [expenses, accordion-form, ui-consistency, final-harmonization]
- requires: Phase 29 (ServiceEditForm pattern)
- provides: ExpenseEditForm component, refactored ExpenseCreate page
- affects: None (this completes harmonization initiative)
- tech-stack.added: [] (zero new dependencies)
- tech-stack.patterns: [Accordion forms, localStorage persistence, component separation]
- key-files.created: [ExpenseEditForm.tsx]
- key-files.modified: [ExpenseCreate.tsx]
- decisions: [Use 2 accordions (Identity + Financial), Copy ServiceEditForm pattern, No routing changes needed]
- metrics: duration, completed date, tasks 3/3, commits 1

**Summary sections:**
1. **What Was Built:** ExpenseEditForm component with 2 accordions, ExpenseCreate refactor to use component
2. **Key Changes:** List 3 tasks with files modified and line counts
3. **Pattern Application:** How ServiceEditForm pattern was adapted to Expenses (2 accordions, 7 fields)
4. **Technical Decisions:** Why 2 accordions, why ServiceEditForm as template, why no routing changes
5. **Verification Results:** TypeScript 0 errors, build success, manual testing outcomes
6. **Harmonization Complete:** 12/12 resources now use identical accordion pattern

**Include in summary:**
- Total lines added: ~210 (ExpenseEditForm component)
- Total lines removed: ~116 (inline form from ExpenseCreate)
- Net change: +94 lines
- Code organization: Separation of concerns (page = logic, component = presentation)
- Pattern consistency: 100% - all 12 resources harmonized
- Zero technical debt: No inline forms remain
- **MILESTONE:** UI harmonization initiative complete! ðŸŽ‰
</output>
