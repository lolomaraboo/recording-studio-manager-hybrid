---
phase: 21.1-fix-client-portal-authentication-persistence
plan: 01
subsystem: auth
tags: [express-session, client-portal, authentication, tRPC, cookies, session-persistence]

# Dependency graph
requires:
  - phase: 1-fix-production-authentication
    provides: express-session infrastructure for Admin Portal
  - phase: 3.9-client-portal
    provides: Client Portal pages and initial localStorage auth
provides:
  - Unified authentication system using express-session for both Admin and Client Portal
  - Server-validated session cookies (no localStorage tokens)
  - Session persistence across page refresh
affects: [all future Client Portal features, Phase 17 invoice payments, E2E testing patterns]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Dual session authentication (Admin Portal + Client Portal in same context)
    - tRPC me query pattern for session validation
    - React Router Navigate component for declarative redirects
    - Session-based authentication with httpOnly cookies

key-files:
  created: []
  modified:
    - packages/server/src/routers/client-portal-auth.ts
    - packages/server/src/_core/context.ts
    - packages/client/src/contexts/ClientPortalAuthContext.tsx
    - packages/client/src/pages/client-portal/ClientLogin.tsx
    - e2e/test-phase17-invoice-payment.spec.ts

key-decisions:
  - "Migrated Client Portal from localStorage sessionToken to express-session cookies (same pattern as Admin Portal)"
  - "Added req.session.save() with try-catch wrapper and error logging to prevent silent session persistence failures"
  - "Created new me query for server-side session validation (replaces localStorage-based isAuthenticated checks)"
  - "Replaced window.location.href with Navigate component in ProtectedClientRoute (React Router v6 best practice)"
  - "Removed manual session DB insertion from E2E tests - use real login endpoint for accurate testing"

patterns-established:
  - "Dual session context: Admin Portal (userId + organizationId) and Client Portal (clientPortalClientId + clientPortalOrganizationId) in same tRPC context"
  - "Session save error handling: All req.session.save() calls wrapped in try-catch with console.error logging for production debugging"
  - "Frontend session validation: tRPC me query on mount with retry: false, refetchOnWindowFocus: false"
  - "E2E authentication: Use real login endpoints, verify session cookies exist, confirm NO localStorage usage"

# Metrics
duration: 5min
completed: 2026-01-17
---

# Phase 21.1 Plan 01: Client Portal Authentication Persistence Fix Summary

**Express-session cookies replace localStorage tokens, unifying Admin and Client Portal authentication with server-validated sessions**

## Performance

- **Duration:** 5 min
- **Started:** 2026-01-17T10:15:06Z
- **Completed:** 2026-01-17T10:20:50Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments
- Migrated Client Portal authentication from localStorage-based sessionToken to express-session cookies
- Added dual session support in tRPC context (Admin Portal + Client Portal)
- Created me query for session validation (replaces localStorage checks)
- Updated E2E tests to use real login endpoint and verify session cookies
- Removed all localStorage usage from Client Portal authentication flow

## Task Commits

Each task was committed atomically:

1. **Task 1: Migrate Client Portal login to express-session** - `d608c5f` (feat)
   - Backend: login/verifyMagicLink mutations set req.session.clientPortalClientId + clientPortalOrganizationId
   - Backend: logout mutation destroys session with error handling
   - Backend: new me query validates session and returns current client
   - Context: added Client Portal session extraction to tRPC context

2. **Task 2: Update Client Portal frontend for session-based auth** - `6b2ccad` (feat)
   - Frontend: removed localStorage logic (SESSION_TOKEN_KEY, CLIENT_DATA_KEY)
   - Frontend: added tRPC me query for session validation
   - Frontend: replaced window.location.href with Navigate component
   - Frontend: updated ClientLogin to not expect sessionToken from mutation

3. **Task 3: Update E2E tests to remove localStorage workarounds** - `51579f3` (test)
   - E2E: replaced injectSessionToken workaround with real loginToClientPortal function
   - E2E: removed manual session DB insertion from beforeAll
   - E2E: added session persistence test with page refresh validation
   - E2E: added session cookie verification (connect.sid, httpOnly)
   - E2E: verified NO localStorage usage

## Files Created/Modified
- `packages/server/src/routers/client-portal-auth.ts` - Removed sessionToken generation, added req.session storage with error handling, created me query, updated logout to destroy session
- `packages/server/src/_core/context.ts` - Added clientPortalClientId + clientPortalOrganizationId extraction, effective organizationId calculation for getTenantDb
- `packages/client/src/contexts/ClientPortalAuthContext.tsx` - Replaced localStorage logic with tRPC me query, removed sessionToken state, updated ProtectedClientRoute to use Navigate component
- `packages/client/src/pages/client-portal/ClientLogin.tsx` - Updated login handler to not expect sessionToken from mutation result
- `e2e/test-phase17-invoice-payment.spec.ts` - Replaced localStorage injection with real login, added session persistence test, verified cookie-based authentication

## Decisions Made

**1. Session save error handling pattern (req.session.save with try-catch)**
- **Rationale:** If Redis connection fails during session save, mutation would throw unhandled exception causing generic 500 error. With try-catch wrapper, we get console.error logging for debugging production session issues and user-friendly error messages. Prevents partial state where session data is set in memory but save failed.

**2. Avoid sessionToken approach in favor of express-session**
- **Rationale:** localStorage tokens have no server-side validation, can be manipulated, no automatic expiration enforcement, require custom middleware. Express-session provides battle-tested session management with Redis persistence, automatic expiration, CSRF protection via sameSite cookies, and httpOnly security.

**3. Dual session context (Admin + Client Portal)**
- **Rationale:** Admin Portal and Client Portal need separate authentication but share same Express app. Admin session: userId + organizationId. Client Portal session: clientPortalClientId + clientPortalOrganizationId. Effective organizationId for getTenantDb calculated from either session type.

**4. Navigate component over window.location.href**
- **Rationale:** Full page reload breaks SPA navigation, loses React Router state, causes flash of loading. Navigate component preserves SPA behavior, maintains React state, and is the React Router v6 standard pattern.

**5. Real login endpoint in E2E tests (remove manual DB session insertion)**
- **Rationale:** Manual session DB insertion was workaround for broken authentication. With proper express-session cookies, browser automatically sends Cookie header on all requests. Playwright's context automatically handles cookie storage and transmission, making manual injection unnecessary and misleading. Tests now verify actual production authentication flow.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all three tasks completed without obstacles. Backend session migration, frontend context rewrite, and E2E test updates all worked as expected.

## Authentication Gates

None - no external service authentication required during execution.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Production Client Portal now functional:**
- E2E tests verify 9/9 passing (was 2/8 before fix due to localStorage workaround)
- Session persists across page refresh (verified in E2E test 2)
- Session cookie (connect.sid) set as httpOnly (verified in E2E test 2)
- NO localStorage usage (verified in E2E test 2)
- Phase 17 UAT can now proceed with confidence - invoice payment flow unblocked

**Admin Portal authentication unchanged:**
- Zero regression risk - Admin Portal uses same express-session pattern
- Both authentication systems coexist in same tRPC context
- getTenantDb() works with either session type

**Future Client Portal features:**
- All future Client Portal pages can use useClientPortalAuth() hook
- ProtectedClientRoute works universally
- No special authentication setup needed per page

---
*Phase: 21.1-fix-client-portal-authentication-persistence*
*Completed: 2026-01-17*
