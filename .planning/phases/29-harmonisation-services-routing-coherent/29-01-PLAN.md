---
phase: 29-harmonisation-services-routing-coherent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/pages/ServiceCreate.tsx
  - packages/client/src/components/ServiceEditForm.tsx
  - packages/client/src/pages/Services.tsx
  - packages/client/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /services/new from Services list page"
    - "User can create service via dedicated page (not Dialog modal)"
    - "ServiceCreate page uses accordion-based form (consistent with 11 other resources)"
    - "Form state persists in localStorage across sessions"
    - "Alt+Click toggles all accordions (power-user feature)"
    - "Creating service returns to /services list page with success toast"
  artifacts:
    - path: "packages/client/src/pages/ServiceCreate.tsx"
      provides: "Dedicated create page for services"
      min_lines: 100
    - path: "packages/client/src/components/ServiceEditForm.tsx"
      provides: "Accordion-based form component (2 sections)"
      min_lines: 180
      exports: ["ServiceEditForm"]
    - path: "packages/client/src/App.tsx"
      provides: "Route registration for /services/new"
      contains: 'path="services/new"'
    - path: "packages/client/src/pages/Services.tsx"
      provides: "Updated button navigation (Link not onClick)"
      pattern: 'Button asChild.*Link to="/services/new"'
  key_links:
    - from: "packages/client/src/pages/Services.tsx"
      to: "/services/new"
      via: "Button with asChild + Link"
      pattern: '<Button asChild>.*<Link to="/services/new">'
    - from: "packages/client/src/pages/ServiceCreate.tsx"
      to: "ServiceEditForm"
      via: "Import and render"
      pattern: 'import.*ServiceEditForm.*from.*@/components/ServiceEditForm'
    - from: "packages/client/src/components/ServiceEditForm.tsx"
      to: "localStorage"
      via: "Accordion state persistence"
      pattern: "localStorage\\.(get|set)Item\\('serviceEditAccordions'"
---

<objective>
Apply the established harmonization pattern (Phases 22-28) to Services by creating a dedicated `/services/new` page with accordion-based form, replacing the existing Dialog modal pattern.

Purpose: Achieve routing consistency across all 12 resources (clients, sessions, invoices, equipment, rooms, projects, quotes, contracts, expenses, talents, tracks, services). This enables bookmarkable URLs, shareable links, and eliminates cognitive friction from mixed interaction patterns.

Output: ServiceCreate.tsx page (110 lines), ServiceEditForm component (200 lines), updated Services.tsx button navigation, route registration in App.tsx. Zero new dependencies—all patterns copied from TalentEditForm (Phase 28).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-harmonisation-services-routing-coherent/29-RESEARCH.md

# Pattern references (established in Phases 26-28)
@packages/client/src/pages/TalentCreate.tsx
@packages/client/src/components/TalentEditForm.tsx

# Current implementation (Dialog modal to replace)
@packages/client/src/pages/Services.tsx

# Routing structure
@packages/client/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ServiceCreate.tsx dedicated page</name>
  <files>packages/client/src/pages/ServiceCreate.tsx</files>
  <action>
Create dedicated page for service creation at packages/client/src/pages/ServiceCreate.tsx.

**Copy TalentCreate.tsx structure (lines 1-108) with field replacements:**

1. **Imports:** Same as TalentCreate (useState, useNavigate, Link, Button, trpc, icons, toast, ServiceEditForm)
2. **Icon change:** Music → Package (for services theme)
3. **tRPC mutation:** serviceCatalog.create (already exists at Services.tsx:92-102)
4. **Form state:** 6 fields matching ServiceFormData interface:
   - name: "" (required)
   - description: "" (optional)
   - category: "Studio" as const (required)
   - unitPrice: "" (required)
   - taxRate: "20" (required, default 20%)
   - defaultQuantity: "1.00" (required, default 1.00)

5. **Validation (from Services.tsx:129-155):**
   - Name: Must be non-empty
   - UnitPrice: Must be numeric and >= 0
   - Other fields: Accept defaults

6. **Navigation:** On success → navigate("/services"), on error → toast.error

7. **Header:** "Nouveau Service" with Package icon, back button to /services

8. **Form:** Render <ServiceEditForm formData={formData} setFormData={setFormData} />

9. **Action buttons:**
   - Cancel: Button variant="outline" asChild → Link to="/services"
   - Submit: "Créer le service" (disabled during createMutation.isPending)

**Pattern source:** TalentCreate.tsx lines 1-108 (Phase 28)

**Expected output:** ~110 lines matching TalentCreate structure with service-specific fields
  </action>
  <verify>
File exists at packages/client/src/pages/ServiceCreate.tsx with:
- Import statement: import { ServiceEditForm } from "@/components/ServiceEditForm"
- tRPC mutation: trpc.serviceCatalog.create.useMutation
- formData state with 6 fields (name, description, category, unitPrice, taxRate, defaultQuantity)
- handleSubmit validation matching Services.tsx:129-155
- Header with Package icon and "Nouveau Service" title
- ServiceEditForm component rendered
- Cancel + Submit buttons in footer

Run: grep -E "(ServiceEditForm|serviceCatalog.create|navigate\(\"/services\"\))" packages/client/src/pages/ServiceCreate.tsx
Expected: 3+ matches
  </verify>
  <done>
ServiceCreate.tsx exists with complete page structure (header, form, validation, navigation). File compiles with TypeScript 0 errors. Structure matches TalentCreate.tsx pattern (Phase 28) with service-specific adaptations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ServiceEditForm accordion component</name>
  <files>packages/client/src/components/ServiceEditForm.tsx</files>
  <action>
Create accordion-based form component at packages/client/src/components/ServiceEditForm.tsx.

**Copy TalentEditForm.tsx structure (lines 1-299) with simplifications:**

1. **Imports:** Same as TalentEditForm (useState, useEffect, Card, Accordion components, Input, Textarea, Label, Select, icons)

2. **Interface:**
```typescript
interface ServiceEditFormProps {
  formData: any;
  setFormData: (data: any) => void;
}
```

3. **Accordion state with localStorage (lines 36-52 from TalentEditForm):**
   - Key: 'serviceEditAccordions' (unique to services)
   - Default open: ["identite", "pricing"] (2 accordions)
   - useEffect to save state on change

4. **Alt+Click toggle handler (lines 54-69 from TalentEditForm):**
   - allAccordions = ["identite", "pricing"]
   - Toggle all open/closed logic

5. **Accordion structure (2 sections, not 5 like TalentEditForm):**

**Accordion 1: Identité du Service**
- Icon: Package
- Fields (3):
  - name: Input (maxLength 255, required asterisk)
  - category: Select (Studio/Post-production/Location matériel/Autre, required asterisk)
  - description: Textarea (rows 3, optional)

**Accordion 2: Tarification**
- Icon: DollarSign
- Fields (3):
  - unitPrice: Input type="number" step="0.01" min="0" (required asterisk)
  - taxRate: Select (20%/10%/5.5%/0%, required asterisk)
  - defaultQuantity: Input type="number" step="0.01" min="0.01" (required asterisk)

6. **Card wrapper:** Each AccordionItem wrapped in <Card> for visual consistency

7. **Trigger onClick:** Pass handleAccordionTriggerClick to enable Alt+Click

**Pattern source:** TalentEditForm.tsx lines 1-299 (Phase 28), simplified to 2 accordions instead of 5

**Expected output:** ~200 lines (TalentEditForm is 299 lines with 5 accordions, Services needs only 2)

**Field mapping reference from Services.tsx Dialog (lines 363-493):**
- All field IDs, labels, placeholders already defined
- Copy exact validation patterns (required asterisks on name, category, unitPrice, taxRate, defaultQuantity)
  </action>
  <verify>
File exists at packages/client/src/components/ServiceEditForm.tsx with:
- Export: export function ServiceEditForm
- localStorage key: 'serviceEditAccordions'
- 2 accordion sections: "identite", "pricing"
- Accordion 1 contains: name Input, category Select, description Textarea
- Accordion 2 contains: unitPrice Input, taxRate Select, defaultQuantity Input
- Alt+Click handler implemented (allAccordions array)
- Card wrapper on each AccordionItem

Run: grep -E "(serviceEditAccordions|AccordionItem value=\"identite\"|AccordionItem value=\"pricing\")" packages/client/src/components/ServiceEditForm.tsx
Expected: 3+ matches (localStorage key + 2 accordion values)
  </verify>
  <done>
ServiceEditForm.tsx exists with 2-accordion structure (Identity + Pricing). All 6 service fields present. localStorage persistence configured. Alt+Click toggle handler implemented. Component exports ServiceEditForm function. TypeScript compiles with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Services.tsx button navigation and remove Dialog</name>
  <files>packages/client/src/pages/Services.tsx</files>
  <action>
Update Services.tsx to use Link navigation instead of Dialog modal.

**Step 1: Update button (line 239):**
```typescript
// BEFORE (line 239):
<Button onClick={openCreateModal}>
  <Plus className="mr-2 h-4 w-4" />
  Nouveau service
</Button>

// AFTER:
<Button asChild>
  <Link to="/services/new">
    <Plus className="mr-2 h-4 w-4" />
    Nouveau service
  </Link>
</Button>
```

**Step 2: Remove Dialog-related code (lines 350-493):**
- Delete entire Dialog component block (lines 350-493)
- Remove DialogFooter with submit/cancel buttons

**Step 3: Remove Dialog state management:**
- Delete: `const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);` (line 68)
- Delete: `const [formData, setFormData] = useState<ServiceFormData>(INITIAL_FORM_DATA);` (line 70) - no longer needed in list page
- Delete: `const [formErrors, setFormErrors] = useState<Partial<Record<keyof ServiceFormData, string>>>({});` (line 72)
- Delete: openCreateModal function
- Delete: closeModal function
- Delete: handleCreateSubmit function (lines 126-180)
- Delete: handleEditSubmit function (if exists)

**Step 4: Keep necessary code:**
- Keep imports: Link (already imported on line 41)
- Keep: searchQuery, categoryFilter, editingService, deleteConfirmId states (used by list/edit/delete)
- Keep: list query, update mutation, delete mutation (unrelated to create flow)
- Keep: AlertDialog for delete confirmation (lines after 493)

**Step 5: Clean up unused imports:**
- Remove Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle imports (lines 23-29) if no longer used
- Keep Input, Label, Textarea, Select imports ONLY if used elsewhere in Services.tsx (e.g., for inline edit if exists)

**Pattern reference:** Compare with Talents.tsx (Phase 28) - button uses `asChild + Link`, no Dialog for create

**Important:** Do NOT remove edit functionality if it exists elsewhere in the file (e.g., inline table edit or edit button that opens Dialog for existing services). Only remove CREATE modal code.
  </action>
  <verify>
Services.tsx changes verified:
1. Button at line ~239 now uses: <Button asChild><Link to="/services/new">
2. Dialog component block (lines 350-493) removed
3. isCreateModalOpen state removed
4. formData state removed from list page
5. openCreateModal function removed
6. handleCreateSubmit function removed
7. File compiles with TypeScript 0 errors

Run: grep -E "(Dialog|isCreateModalOpen|openCreateModal|handleCreateSubmit)" packages/client/src/pages/Services.tsx
Expected: 0 matches (all Dialog create code removed)

Run: grep 'to="/services/new"' packages/client/src/pages/Services.tsx
Expected: 1 match (button navigation)
  </verify>
  <done>
Services.tsx updated: "Nouveau service" button navigates to /services/new via Link. Dialog modal code removed (lines 350-493 deleted). Dialog state management removed (isCreateModalOpen, formData, formErrors, openCreateModal, closeModal, handleCreateSubmit). File compiles successfully. List page functionality preserved (search, filter, table, edit, delete).
  </done>
</task>

<task type="auto">
  <name>Task 4: Register /services/new route in App.tsx</name>
  <files>packages/client/src/App.tsx</files>
  <action>
Add route for /services/new in App.tsx following established pattern.

**Step 1: Add import (after existing Services import):**
Find line with: `import Services from './pages/Services';`
Add after it: `import ServiceCreate from './pages/ServiceCreate';`

**Step 2: Add route (find existing services route at line 164):**
```typescript
// Current (line 164):
<Route path="services" element={<Services />} />

// Add immediately after:
<Route path="services/new" element={<ServiceCreate />} />
```

**Pattern reference:** Talents routes (Phase 28):
- Line ~160: `<Route path="talents" element={<Talents />} />`
- Line ~161: `<Route path="talents/new" element={<TalentCreate />} />`

**Important:** Ensure new route is INSIDE the same parent Route as the list route (under ProtectedRoute > Layout).

**Context:** App.tsx uses React Router 6. Routes are nested inside Layout component around line 138-177.
  </action>
  <verify>
App.tsx changes verified:
1. Import added: import ServiceCreate from './pages/ServiceCreate'
2. Route added after line 164: <Route path="services/new" element={<ServiceCreate />} />
3. Route is sibling to <Route path="services" element={<Services />} />
4. Both routes inside same parent (ProtectedRoute > Layout)

Run: grep -A 1 'path="services"' packages/client/src/App.tsx
Expected: 2 matches (services list route + services/new route)

Run: grep 'ServiceCreate' packages/client/src/App.tsx
Expected: 2 matches (import + route element)
  </verify>
  <done>
App.tsx updated with /services/new route. ServiceCreate component imported. Route registered as sibling to /services list route. TypeScript compiles with 0 errors. Navigation flow complete: Services list → /services/new → ServiceCreate page.
  </done>
</task>

<task type="auto">
  <name>Task 5: Build verification and type checking</name>
  <files>N/A</files>
  <action>
Verify all changes compile successfully and maintain type safety.

**Step 1: Type check all packages**
Run: `pnpm check`
Expected: 0 TypeScript errors across all packages

**Step 2: Build client package**
Run: `pnpm --filter client build`
Expected: Build succeeds with 0 errors, dist/ directory created

**Step 3: Verify imports resolve**
Check that ServiceEditForm is imported correctly in ServiceCreate:
Run: `grep "ServiceEditForm" packages/client/src/pages/ServiceCreate.tsx`
Expected: Import statement matches export from ServiceEditForm.tsx

**Step 4: Verify route exists**
Run: `grep -C 2 "services/new" packages/client/src/App.tsx`
Expected: Route with ServiceCreate element visible

**If errors occur:**
- Import path issues: Verify @/components alias works
- Type errors: Check formData interface matches between ServiceCreate and ServiceEditForm
- Build errors: Run `pnpm install` if missing dependencies

**Pattern verification checklist:**
- [ ] ServiceCreate page structure matches TalentCreate (header, form, buttons)
- [ ] ServiceEditForm has 2 accordions (Identity, Pricing)
- [ ] localStorage key is unique ('serviceEditAccordions')
- [ ] Alt+Click handler present in ServiceEditForm
- [ ] Services.tsx button uses asChild + Link pattern
- [ ] Dialog code removed from Services.tsx
- [ ] Route registered in App.tsx
  </action>
  <verify>
Run: pnpm check
Expected: "✓ Checked N files in Xms" with 0 errors

Run: pnpm --filter client build
Expected: "dist/index.html" created, build size reported, 0 errors

Run: ls packages/client/dist/
Expected: index.html, assets/ directory exist
  </verify>
  <done>
All TypeScript checks pass (0 errors). Client builds successfully. ServiceCreate page, ServiceEditForm component, and routing changes compile without issues. Pattern verification complete: Services harmonization matches established pattern from Phases 22-28. Ready for manual testing.
  </done>
</task>

</tasks>

<verification>
**Automated verification:**
1. `pnpm check` passes with 0 TypeScript errors
2. `pnpm --filter client build` succeeds
3. ServiceCreate.tsx exists with 100+ lines
4. ServiceEditForm.tsx exists with 180+ lines
5. Services.tsx no longer contains Dialog modal code (lines 350-493 removed)
6. App.tsx contains route for /services/new

**Manual verification (user testing):**
1. Navigate to /services page
2. Click "Nouveau service" button
3. Verify navigation to /services/new (URL changes)
4. Verify ServiceCreate page renders with:
   - Header: "Nouveau Service" with Package icon
   - Back button to /services
   - 2 accordion sections (Identity, Pricing)
   - All 6 fields present (name, category, description, unitPrice, taxRate, defaultQuantity)
   - Cancel button (returns to /services)
   - "Créer le service" submit button
5. Test accordion interactions:
   - Click accordion headers to expand/collapse
   - Alt+Click on any header to toggle all accordions
6. Fill form with valid data and submit
7. Verify success toast appears
8. Verify navigation returns to /services list
9. Verify new service appears in table
10. Refresh page and return to /services/new
11. Verify accordion state persisted (same accordions open as before)

**Goal-backward verification (must_haves):**
- ✓ User can navigate to /services/new from list page (button + route exist)
- ✓ User can create service via dedicated page (ServiceCreate page exists)
- ✓ Form uses accordion pattern (ServiceEditForm has 2 AccordionItems)
- ✓ localStorage persistence (serviceEditAccordions key used)
- ✓ Alt+Click toggle (handleAccordionTriggerClick handler present)
- ✓ Success flow returns to list (navigate("/services") in onSuccess)
</verification>

<success_criteria>
**Code artifacts:**
- [x] ServiceCreate.tsx created (100-120 lines)
- [x] ServiceEditForm.tsx created (180-220 lines)
- [x] Services.tsx updated (Dialog removed, button changed to Link)
- [x] App.tsx updated (route registered)

**Functional requirements:**
- [x] /services/new route accessible
- [x] ServiceCreate page renders correctly
- [x] Form has 2 accordion sections (Identity + Pricing)
- [x] All 6 service fields present and functional
- [x] Validation works (required fields checked)
- [x] Submit creates service via tRPC mutation
- [x] Success returns to /services list with toast
- [x] Error shows toast with message
- [x] Accordion state persists in localStorage
- [x] Alt+Click toggles all accordions

**Pattern consistency:**
- [x] Matches TalentCreate/TalentEditForm structure (Phase 28)
- [x] Consistent with 11 other harmonized resources (Phases 22-28)
- [x] No Dialog modal for create flow
- [x] Bookmarkable URL (/services/new)
- [x] TypeScript strict mode passes (0 errors)

**Cleanup verification:**
- [x] Dialog component removed from Services.tsx
- [x] isCreateModalOpen state removed
- [x] openCreateModal function removed
- [x] handleCreateSubmit function removed
- [x] Unused Dialog imports removed

**Documentation:**
- Phase 29 harmonization complete
- Services now consistent with clients, sessions, invoices, equipment, rooms, projects, quotes, contracts, expenses, talents, tracks
- All 12 resources use dedicated `/resource/new` pages
- Pattern established for Phase 30+ (other resources if any remain)
</success_criteria>

<output>
After completion, create `.planning/phases/29-harmonisation-services-routing-coherent/29-01-SUMMARY.md` with:

**Frontmatter:**
- phase: 29-harmonisation-services-routing-coherent
- plan: 01
- subsystem: ui-harmonization
- tags: [services, routing, accordion-form, ui-consistency]
- requires: Phase 28 (TalentEditForm pattern)
- provides: ServiceCreate page, ServiceEditForm component, /services/new route
- affects: All future UI harmonization phases (pattern fully established)
- tech-stack.added: [] (zero new dependencies)
- tech-stack.patterns: [Accordion forms, localStorage persistence, Link navigation]
- key-files.created: [ServiceCreate.tsx, ServiceEditForm.tsx]
- key-files.modified: [Services.tsx, App.tsx]
- decisions: [Use 2 accordions not 5, Copy TalentEditForm pattern, Remove Dialog completely]
- metrics: duration, completed date, tasks 5/5, commits 1

**Summary sections:**
1. **What Was Built:** ServiceCreate page with accordion form, routing update, Dialog removal
2. **Key Changes:** List 5 tasks with files modified and line counts
3. **Pattern Application:** How TalentEditForm pattern was adapted to Services (2 accordions vs 5)
4. **Technical Decisions:** Why 2 accordions, why TalentEditForm as template, Dialog cleanup strategy
5. **Verification Results:** TypeScript 0 errors, build success, manual testing outcomes
6. **Next Steps:** Phase 30+ can follow same pattern for any remaining resources

**Include in summary:**
- Total lines added: ~310 (110 ServiceCreate + 200 ServiceEditForm)
- Total lines removed: ~150 (Dialog code from Services.tsx)
- Net change: +160 lines
- Code reduction: N/A (was Dialog, now dedicated page - different pattern)
- Pattern consistency: 12/12 resources now harmonized
- Zero technical debt: No Dialog modal code remains
</output>
