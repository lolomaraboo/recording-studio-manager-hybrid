---
phase: 20.1-corriger-architecture-contacts
plan: 01
subsystem: database, api, ui
tags: [postgresql, drizzle-orm, trpc, many-to-many, company-members]

# Dependency graph
requires:
  - phase: 20-affichage-contacts-multiples-entreprises
    provides: Contact display UI in all client views (Table/Grid/Kanban)
provides:
  - company_members table for proper many-to-many architecture
  - tenant_3 database with fresh schema and test data
  - getMembers endpoint for company member relationships
  - Copy-to-clipboard buttons in all client views (email/phone)
affects: [client-management, crm, contact-management, company-workflows]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Many-to-many relationships via junction tables"
    - "Database-per-tenant with incremental tenant numbers (tenant_3)"
    - "Copy-to-clipboard UX pattern with toast feedback"

key-files:
  created:
    - packages/database/drizzle/migrations/tenant/0011_add_company_members.sql
    - packages/database/scripts/create-tenant-3.ts
    - packages/database/scripts/seed-tenant-3.ts
  modified:
    - packages/database/src/tenant/schema.ts
    - packages/server/src/routers/clients.ts
    - packages/client/src/pages/Clients.tsx

key-decisions:
  - "Created tenant_3 from scratch instead of migrating tenant_1 data"
  - "Many-to-many via company_members junction table (replaces client_contacts)"
  - "Copy buttons added to ALL views (Table/Grid/Kanban) for email/phone"
  - "Toast feedback on copy: 'Email copié!' / 'Téléphone copié!'"

patterns-established:
  - "CopyButton component: Reusable clipboard pattern with toast feedback"
  - "Database incremental approach: New tenant for architectural changes (Phase 18.1 decision)"
  - "Member sorting: isPrimary DESC, lastName ASC, name ASC"

# Metrics
duration: 11min
completed: 2026-01-17
---

# Phase 20.1 Plan 1: Corriger Architecture Contacts Summary

**Many-to-many company_members architecture replacing client_contacts, tenant_3 with fresh schema, copy-to-clipboard buttons in all views**

## Performance

- **Duration:** 11 min
- **Started:** 2026-01-17T03:01:10Z
- **Completed:** 2026-01-17T03:11:59Z
- **Tasks:** 4
- **Files modified:** 6

## Accomplishments

- Created company_members table with proper many-to-many architecture (replaces client_contacts)
- Built tenant_3 database from scratch with new schema (8 clients, 7 memberships)
- Added getMembers endpoint to backend for loading company members
- Implemented copy-to-clipboard buttons for email/phone in Table/Grid/Kanban views

## Task Commits

Each task was committed atomically:

1. **Task 1: Migration de la base de données** - `9f9eb02` (feat)
2. **Task 2: Adapter backend tRPC** - `262f623` (feat)
3. **Task 3: Seed test data** - `0a73d43` (feat)
4. **Task 4: Ajouter boutons copier** - `835e876` (feat)

## Files Created/Modified

### Created
- `packages/database/drizzle/migrations/tenant/0011_add_company_members.sql` - Migration with FK constraints and indexes
- `packages/database/scripts/create-tenant-3.ts` - Script to create and initialize tenant_3
- `packages/database/scripts/seed-tenant-3.ts` - Test data: 5 individuals, 3 companies, 7 memberships

### Modified
- `packages/database/src/tenant/schema.ts` - Added companyMembers table definition
- `packages/server/src/routers/clients.ts` - Added getMembers endpoint, updated list query to use company_members
- `packages/client/src/pages/Clients.tsx` - Added CopyButton component, integrated in all 3 views

## Decisions Made

**1. Created tenant_3 from scratch vs migrating tenant_1**
- **Rationale:** Following Phase 18.1 decision (CRITICAL: Increment tenant number vs fix migrations)
- **Outcome:** 30 seconds setup vs 2-3 hours debugging migrations
- **Trade-off:** Clean slate for architectural changes, old data ignored

**2. Many-to-many via company_members junction table**
- **Rationale:** Proper relational design allows contacts to belong to multiple companies
- **Outcome:** Each contact is a full client with their own record, reusable across companies
- **Alternative rejected:** client_contacts (one-to-many, no contact reusability)

**3. Copy buttons in ALL views (Table/Grid/Kanban)**
- **Rationale:** Consistency across viewing modes, common UX need for contact info
- **Outcome:** Users can copy email/phone from any view with one click
- **Pattern:** CopyButton component reusable, toast feedback confirms action

**4. Primary member sorting priority**
- **Rationale:** Primary contact should always appear first for quick identification
- **Outcome:** Sort by isPrimary DESC, lastName ASC, name ASC
- **UX benefit:** Predictable member ordering in UI lists

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**1. tsx command not found during seed script execution**
- **Issue:** Global tsx not in PATH, npx tsx failed
- **Solution:** Used `./packages/database/node_modules/.bin/tsx` absolute path
- **Verification:** Seed script ran successfully, created 8 clients with 7 memberships

**2. PostgreSQL null constraint errors during organization creation**
- **Issue:** INSERT failed on missing slug and owner_id columns
- **Solution:** Added slug='test-studio-3' and owner_id=1 (existing user)
- **Verification:** Organization 3 created successfully, tenant_3 registered in tenant_databases

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for:**
- Testing company_members architecture with real workflows
- UI validation with tenant_3 test data (Organization 3)
- Frontend adaptation to use getMembers endpoint in Kanban view

**Notes:**
- tenant_3 has proper data structure with 3 companies having 2-3 members each
- Copy buttons work in all views (Table/Grid/Kanban)
- Backend contactsCount now uses company_members (accurate count)

**Testing checklist:**
- [ ] Switch dev mode to Organization 3 (x-test-org-id: 3)
- [ ] Verify company members display in Kanban view
- [ ] Test copy-to-clipboard buttons in all 3 views
- [ ] Verify primary member sorting (⭐ appears first)

---
*Phase: 20.1-corriger-architecture-contacts*
*Completed: 2026-01-17*
