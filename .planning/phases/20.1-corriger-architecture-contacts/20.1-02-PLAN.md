# Phase 20.1-02 - Kanban: Affichage Liste Membres Entreprises

**Phase:** 20.1-corriger-architecture-contacts
**Plan:** 20.1-02
**Date:** 2026-01-17
**Status:** Ready for Execution

---

## Context

**Previous Plan (20.1-01):**
- ‚úÖ Backend architecture compl√®te (many-to-many `company_members`)
- ‚úÖ Endpoint `clients.getMembers` cr√©√© et test√©
- ‚úÖ Copy buttons impl√©ment√©s dans les 3 vues
- ‚úÖ `contactsCount` affich√© partout

**Gap Identified:**
- ‚ùå Kanban view affiche seulement "3 contacts" (badge avec nombre)
- ‚ùå Ne montre PAS la liste des membres avec noms/r√¥les/‚≠ê primaire

**This Plan (20.1-02):**
- Impl√©menter l'affichage d√©taill√© des membres dans Kanban view
- Pour chaque entreprise, montrer la liste compl√®te des contacts
- Avec indicateur ‚≠ê pour contact primaire, r√¥le, email/phone cliquables

---

## Objective

Transformer l'affichage Kanban des entreprises de:

```tsx
// ‚ùå Current (ligne 914-920 de Clients.tsx)
{client.type === 'company' && client.contactsCount > 0 && (
  <Badge variant="outline">
    {client.contactsCount} contacts  // Juste le nombre
  </Badge>
)}
```

Vers:

```tsx
// ‚úÖ Target
{client.type === 'company' && members && members.length > 0 && (
  <div className="border-t pt-2 space-y-1">
    <div className="text-xs font-medium text-muted-foreground">
      Contacts ({members.length})
    </div>
    {members.map(m => (
      <Link to={`/clients/${m.member.id}`} key={m.member.id}>
        <div className="flex items-center gap-1 text-xs hover:bg-accent p-1 rounded">
          {m.isPrimary && <Star className="h-3 w-3 text-yellow-500 fill-yellow-500" />}
          <span className="font-medium">{m.member.name}</span>
          {m.role && <span className="text-muted-foreground">- {m.role}</span>}
        </div>
      </Link>
    ))}
  </div>
)}
```

**Visual Example:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üè¢ M√©lodie Productions SAS      ‚îÇ
‚îÇ sarah.petit@example.com  üìã     ‚îÇ
‚îÇ +33 6 34 56 78 90       üìã     ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ Contacts (3)                    ‚îÇ
‚îÇ ‚≠ê Sarah Petit - Productrice    ‚îÇ ‚Üê Primary, clickable
‚îÇ    Alexandre Grand - Ing√©nieur  ‚îÇ ‚Üê Clickable
‚îÇ    Marie Leroy - Assistante     ‚îÇ ‚Üê Clickable
‚îÇ                                 ‚îÇ
‚îÇ Sessions: 0                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Success Criteria

**Functional:**
- [ ] Kanban view affiche la liste des membres pour chaque entreprise
- [ ] Contact primaire a l'ic√¥ne ‚≠ê (Star)
- [ ] Membres tri√©s: primaire en premier, puis alphab√©tique
- [ ] Chaque membre est cliquable ‚Üí lien vers `/clients/{id}`
- [ ] R√¥le affich√© si pr√©sent (ex: "Productrice")
- [ ] N'affiche rien si `contactsCount === 0`

**Performance:**
- [ ] Utilise `enabled` conditionnel pour √©viter requ√™tes inutiles
- [ ] Charge seulement en mode Kanban (`viewMode === 'kanban'`)
- [ ] Charge seulement pour les entreprises (`client.type === 'company'`)

**UX:**
- [ ] Section clairement s√©par√©e (border-top)
- [ ] Hover state sur chaque membre
- [ ] Ic√¥ne ‚≠ê visuellement distincte (jaune, filled)
- [ ] Compact mais lisible (text-xs)

---

## Implementation Plan

### Task 1: Add tRPC Hook for Members Loading

**File:** `packages/client/src/pages/Clients.tsx`

**Location:** After line 60 (after existing queries)

**Code to add:**

```typescript
// Load company members for Kanban view
// Only enabled when:
// - viewMode is 'kanban'
// - client is a company
// - client has contacts
const getCompanyMembers = (clientId: number, enabled: boolean) => {
  return trpc.clients.getMembers.useQuery(
    { companyId: clientId },
    { enabled }
  );
};
```

**Rationale:**
- Conditional loading prevents unnecessary API calls
- Reusable pattern for each company card
- Backend endpoint already tested and working

---

### Task 2: Update Kanban VIP Column Card

**File:** `packages/client/src/pages/Clients.tsx`

**Location:** Lines 680-800 (VIP column cards)

**Current code (lines 913-921):**

```tsx
{/* Contact count badge for companies (Kanban view) */}
{client.type === 'company' && client.contactsCount > 0 && (
  <div className="border-t pt-2">
    <Badge variant="outline" className="text-xs">
      {client.contactsCount} contact{client.contactsCount > 1 ? 's' : ''}
    </Badge>
  </div>
)}
```

**Replace with:**

```tsx
{/* Company members list (Kanban view) */}
{(() => {
  const { data: members } = getCompanyMembers(
    client.id,
    viewMode === 'kanban' && client.type === 'company' && (client.contactsCount ?? 0) > 0
  );

  if (!members || members.length === 0) return null;

  return (
    <div className="border-t pt-2 space-y-1">
      <div className="text-xs font-medium text-muted-foreground mb-1">
        Contacts ({members.length})
      </div>
      {members.map((m) => (
        <Link
          to={`/clients/${m.member.id}`}
          key={m.member.id}
          onClick={(e) => e.stopPropagation()}
        >
          <div className="flex items-center gap-1 text-xs hover:bg-accent p-1 rounded transition-colors">
            {m.isPrimary && (
              <Star className="h-3 w-3 text-yellow-500 fill-yellow-500 flex-shrink-0" />
            )}
            <span className="font-medium truncate">{m.member.name}</span>
            {m.role && (
              <span className="text-muted-foreground truncate">- {m.role}</span>
            )}
          </div>
        </Link>
      ))}
    </div>
  );
})()}
```

**Key Changes:**
- IIFE pattern to use hook conditionally
- `enabled` check prevents loading when not needed
- Click handler stops propagation (card vs member link)
- Hover state for better UX
- Truncate prevents overflow

---

### Task 3: Update Kanban Regular Column Card

**File:** `packages/client/src/pages/Clients.tsx`

**Location:** Lines 800-950 (Regular column cards)

**Apply SAME changes as Task 2**

Search for second occurrence of:
```tsx
{client.type === 'company' && client.contactsCount > 0 && (
```

Replace with same members list implementation.

**Why duplicate:**
- Kanban has 2 columns (VIP / Regular)
- Each renders cards independently
- Need consistent behavior in both

---

### Task 4: Import Star Icon

**File:** `packages/client/src/pages/Clients.tsx`

**Location:** Line 18 (with other icon imports)

**Current:**
```tsx
import { Users, Plus, Search, ArrowLeft, Mail, Phone, Star, FileDown, ...
```

**Verify:** Star is already imported ‚úÖ

If not, add to imports.

---

## Testing Checklist

### Automated Tests (Backend - Already Verified)

From 20.1-01-TEST-REPORT.md:
- ‚úÖ `clients.getMembers` endpoint returns correct data
- ‚úÖ Sorting: isPrimary DESC, lastName ASC
- ‚úÖ M√©lodie Productions: 3 members
- ‚úÖ Sound Production: 2 members
- ‚úÖ Midnight Groove: 2 members

### Manual UI Tests (New)

**URL:** http://localhost:5174/clients
**Org ID:** Already set to 3 (tenant_3)

**Test 1: M√©lodie Productions (3 members)**
1. Switch to Kanban view
2. Locate "M√©lodie Productions SAS" card
3. Verify section header: "Contacts (3)"
4. Verify members list:
   - [ ] ‚≠ê Sarah Petit - Productrice (first, has star)
   - [ ] Alexandre Grand - Ing√©nieur du son (second)
   - [ ] Marie Leroy - Assistante production (third)
5. Hover over each member ‚Üí background changes
6. Click "Sarah Petit" ‚Üí navigates to `/clients/3`

**Test 2: Sound Production (2 members)**
1. Locate "Sound Production SARL" card
2. Verify section header: "Contacts (2)"
3. Verify members list:
   - [ ] ‚≠ê Emma Dubois - Directrice G√©n√©rale (first, has star)
   - [ ] Lucas Martin - Artiste sous contrat (second)

**Test 3: Midnight Groove (2 members)**
1. Locate "Midnight Groove Collective" card
2. Verify section header: "Contacts (2)"
3. Verify members list:
   - [ ] ‚≠ê Lucas Martin - Lead Vocalist (first, has star)
   - [ ] Alexandre Grand - Guitariste (second)

**Test 4: Individual Clients (no members)**
1. Locate "Emma Dubois" card (type: individual)
2. Verify NO "Contacts" section appears
3. Same for all other individual clients

**Test 5: Table/Grid Views (unchanged)**
1. Switch to Table view ‚Üí members section NOT shown (only count badge)
2. Switch to Grid view ‚Üí members section NOT shown (only count badge)
3. Verify copy buttons still work in both views

---

## Edge Cases to Handle

### Case 1: Empty Members Array
```tsx
if (!members || members.length === 0) return null;
```
Don't show section if API returns empty array.

### Case 2: No Role
```tsx
{m.role && <span>- {m.role}</span>}
```
Role is optional, only show if present.

### Case 3: Long Names/Roles
```tsx
<span className="truncate">...</span>
```
Prevent overflow with ellipsis.

### Case 4: Click Propagation
```tsx
onClick={(e) => e.stopPropagation()}
```
Member link doesn't trigger card click.

---

## Files Modified

**Modified:**
- `packages/client/src/pages/Clients.tsx`
  - Add `getCompanyMembers` helper function
  - Update VIP column card (lines ~913-921)
  - Update Regular column card (lines ~913-921, second occurrence)

**No new files created.**

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Too many API calls | Performance | `enabled` condition prevents unnecessary loads |
| UI overflow | Layout breaks | `truncate` class on long text |
| Click conflicts | Wrong navigation | `stopPropagation` on member links |
| Missing Star icon | Visual bug | Already imported in line 18 ‚úÖ |

---

## Acceptance Criteria

**Code Quality:**
- [ ] No TypeScript errors
- [ ] Proper conditional rendering
- [ ] Event handlers prevent propagation
- [ ] Truncate prevents overflow

**Functionality:**
- [ ] Members load only in Kanban view
- [ ] Primary contact shows ‚≠ê icon first
- [ ] All members clickable to their profile
- [ ] Roles displayed when present
- [ ] No section for individual clients

**Performance:**
- [ ] No API calls in Table/Grid views
- [ ] No API calls for individual clients
- [ ] No API calls for companies with 0 contacts

**Build:**
- [ ] `pnpm build` succeeds (exit 0)
- [ ] No new TypeScript warnings introduced

---

## Estimated Time

- Task 1 (tRPC hook): 2 minutes
- Task 2 (VIP column): 10 minutes
- Task 3 (Regular column): 5 minutes (copy/paste from Task 2)
- Task 4 (Icon import): 0 minutes (already done)
- Testing: 10 minutes
- **Total:** ~27 minutes

---

## Notes

**Why This Matters:**

This completes the original Phase 20.1 vision of showing company contacts in a many-to-many relationship. The backend infrastructure was built in 20.1-01, this plan adds the UI layer.

**Why Separate Plan:**

Keeping plans atomic:
- 20.1-01: Backend architecture + Copy buttons (core infrastructure)
- 20.1-02: UI enhancement (Kanban member display)

Easier to:
- Review changes independently
- Rollback if needed
- Document decisions

**Production Readiness:**

After this plan:
- Complete many-to-many contact architecture
- All 3 views have copy buttons
- Kanban shows full member details
- Ready for user testing
