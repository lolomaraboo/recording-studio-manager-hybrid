# Phase 20.1-03 - Fix React Hooks Violation in Kanban View

**Phase:** 20.1-corriger-architecture-contacts
**Plan:** 20.1-03
**Date:** 2026-01-16
**Status:** Ready for Execution

---

## Context

**Previous Plan (20.1-02):**
- ✅ Implemented Kanban member list display
- ✅ Shows detailed contacts with ⭐ primary indicator
- ❌ **CRITICAL BUG:** React Hooks violation causing console errors

**Error in Console:**
```
Error: Rendered more hooks than during the previous render.
React has detected a change in the order of Hooks called by Clients
```

**Root Cause:**
```tsx
// ❌ WRONG - Hook called conditionally in IIFE for each client
const getCompanyMembers = (clientId: number, enabled: boolean) => {
  return trpc.clients.getMembers.useQuery({ companyId: clientId }, { enabled });
};

// Called in render for variable number of clients
{(() => {
  const { data: members } = getCompanyMembers(client.id, enabled);
  // ...
})()}
```

**Why it breaks:**
- React expects hooks to be called in the same order every render
- Number of companies varies (can change between renders)
- Each company calls `useQuery` → variable number of hook calls
- Violates React's Rules of Hooks

**This Plan (20.1-03):**
- Remove `getCompanyMembers` helper function
- Load ALL company members once at component level
- Filter members in render by companyId
- Fix hook ordering violation

---

## Objective

Transform from **multiple conditional hooks** to **single unconditional hook with filtering**:

```tsx
// ❌ Current (broken)
clientsWithStats.map(client => {
  const { data: members } = getCompanyMembers(client.id, enabled); // Hook per client!
})

// ✅ Target (fixed)
const allMembersQuery = trpc.clients.getAllMembers.useQuery(
  undefined,
  { enabled: viewMode === 'kanban' }
);

clientsWithStats.map(client => {
  const members = allMembersQuery.data?.filter(m => m.companyId === client.id);
})
```

---

## Success Criteria

**Functional:**
- [ ] Kanban view still displays company members correctly
- [ ] Primary contact ⭐ indicator still works
- [ ] Member links still navigate to `/clients/{id}`
- [ ] No console errors (React Hooks violation fixed)

**Performance:**
- [ ] Single API call instead of N calls (where N = number of companies)
- [ ] Only loads in Kanban view (`viewMode === 'kanban'`)
- [ ] Filtering in memory is fast (< 10ms for 100 companies)

**Code Quality:**
- [ ] No TypeScript errors
- [ ] Follows React Rules of Hooks
- [ ] Clean, maintainable code

---

## Implementation Plan

### Task 1: Create Backend Endpoint for All Members

**File:** `packages/server/src/routers/clients.ts`

**Location:** After existing `getMembers` endpoint (~line 150)

**Code to add:**

```typescript
// Get all company members for current organization
// Used by Kanban view to load all members in single query
getAllMembers: protectedProcedure.query(async ({ ctx }) => {
  const tenantDb = await ctx.getTenantDb();

  const memberships = await tenantDb
    .select({
      companyId: companyMembers.companyClientId,
      memberId: companyMembers.memberClientId,
      isPrimary: companyMembers.isPrimary,
      role: companyMembers.role,
      memberName: clients.name,
      memberEmail: clients.email,
      memberPhone: clients.phone,
    })
    .from(companyMembers)
    .innerJoin(clients, eq(companyMembers.memberClientId, clients.id))
    .orderBy(
      desc(companyMembers.isPrimary),
      asc(clients.lastName),
      asc(clients.name)
    );

  return memberships;
}),
```

**Rationale:**
- Returns ALL memberships in one query
- Includes companyId for filtering
- Same sorting as `getMembers` (primary first, alphabetical)
- Client-side filtering is fast for typical data volumes

---

### Task 2: Update Frontend to Use Single Hook

**File:** `packages/client/src/pages/Clients.tsx`

**Step 2a: Remove `getCompanyMembers` helper**

**Location:** Lines 65-75

**Delete:**
```typescript
// Load company members for Kanban view
// Only enabled when:
// - viewMode is 'kanban'
// - client is a company
// - client has contacts
const getCompanyMembers = (clientId: number, enabled: boolean) => {
  return trpc.clients.getMembers.useQuery(
    { companyId: clientId },
    { enabled }
  );
};
```

**Step 2b: Add single query at component level**

**Location:** After other useQuery hooks (~line 61)

**Add:**
```typescript
// Load all company members (Kanban view only)
// Single query, filtered client-side by companyId
const allMembersQuery = trpc.clients.getAllMembers.useQuery(
  undefined,
  { enabled: viewMode === 'kanban' }
);
```

**Step 2c: Update Kanban rendering (2 locations)**

**Location 1:** VIP column (~line 926)
**Location 2:** Regular column (~line 1100)

**Replace both occurrences of:**
```tsx
{(() => {
  const { data: members } = getCompanyMembers(
    client.id,
    viewMode === 'kanban' && client.type === 'company' && (client.contactsCount ?? 0) > 0
  );

  if (!members || members.length === 0) return null;
```

**With:**
```tsx
{(() => {
  // Filter members for this company
  const members = allMembersQuery.data?.filter(
    m => m.companyId === client.id
  ) || [];

  if (viewMode !== 'kanban' || client.type !== 'company' || members.length === 0) {
    return null;
  }
```

**Step 2d: Update member mapping**

**Current:**
```tsx
{members.map((m) => (
  <Link to={`/clients/${m.member.id}`} key={m.member.id}>
    <div className="flex items-center gap-1 text-xs hover:bg-accent p-1 rounded transition-colors">
      {m.isPrimary && <Star className="h-3 w-3 text-yellow-500 fill-yellow-500 flex-shrink-0" />}
      <span className="font-medium truncate">{m.member.name}</span>
      {m.role && <span className="text-muted-foreground truncate">- {m.role}</span>}
    </div>
  </Link>
))}
```

**Updated:**
```tsx
{members.map((m) => (
  <Link to={`/clients/${m.memberId}`} key={m.memberId}>
    <div className="flex items-center gap-1 text-xs hover:bg-accent p-1 rounded transition-colors">
      {m.isPrimary && <Star className="h-3 w-3 text-yellow-500 fill-yellow-500 flex-shrink-0" />}
      <span className="font-medium truncate">{m.memberName}</span>
      {m.role && <span className="text-muted-foreground truncate">- {m.role}</span>}
    </div>
  </Link>
))}
```

**Key changes:**
- `m.member.id` → `m.memberId`
- `m.member.name` → `m.memberName`
- Flattened structure (no nested `member` object)

---

## Testing Checklist

### Manual UI Tests

**URL:** http://localhost:5174/clients
**Org ID:** 3 (tenant_3)

**Test 1: Console Errors (Primary Fix)**
1. Open browser DevTools → Console
2. Navigate to /clients
3. Switch between Table / Grid / Kanban views
4. **Expected:** NO React Hooks errors
5. **Expected:** NO "Rendered more hooks than during the previous render"

**Test 2: Kanban View Functionality (Regression)**
1. Switch to Kanban view
2. Locate "Mélodie Productions SAS"
3. Verify members list:
   - [ ] Shows 3 members
   - [ ] ⭐ Sarah Petit (primary) first
   - [ ] Alexandre Grand second
   - [ ] Marie Leroy third
4. Click "Sarah Petit" → navigates to `/clients/3`
5. Back to Kanban
6. Locate "Sound Production SARL"
7. Verify members list:
   - [ ] Shows 2 members
   - [ ] ⭐ Emma Dubois (primary) first
   - [ ] Lucas Martin second

**Test 3: Performance (Single Query)**
1. Open DevTools → Network tab
2. Filter: "trpc"
3. Switch to Kanban view
4. **Expected:** Only ONE request to `clients.getAllMembers`
5. **Expected:** NO requests to `clients.getMembers`
6. Switch to Table view
7. **Expected:** NO new requests (query disabled)

**Test 4: Edge Cases**
1. Individual clients (Emma, Lucas) → NO members section
2. Companies with 0 contacts → NO members section
3. Table/Grid views → NO members section

---

## Files Modified

**Backend:**
- `packages/server/src/routers/clients.ts`
  - Add `getAllMembers` endpoint

**Frontend:**
- `packages/client/src/pages/Clients.tsx`
  - Remove `getCompanyMembers` helper
  - Add `allMembersQuery` hook
  - Update Kanban rendering (2 locations)
  - Update member object access

**No new files created.**

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Large data volumes | Slow filtering | Acceptable for < 1000 members (typical studio) |
| Memory usage | High for 10k+ members | Document limit, add pagination if needed |
| Regression bugs | Members not shown | Comprehensive manual testing |
| Type mismatches | TypeScript errors | Backend returns flat structure matching frontend needs |

---

## Performance Analysis

**Before (broken):**
- N API calls (N = number of companies)
- Example: 3 companies → 3 requests
- Hook ordering violation → React errors

**After (fixed):**
- 1 API call (all members)
- Example: 3 companies → 1 request
- Client-side filtering: O(M) where M = total members
- For 100 companies, 300 members: ~5ms filter time

**Trade-off:**
- ✅ Fewer API calls
- ✅ No React errors
- ✅ Simpler code
- ⚠️ Loads all members even if only viewing one company
- ⚠️ Not suitable for 10,000+ members (unlikely in studio context)

---

## Acceptance Criteria

**Code Quality:**
- [ ] No TypeScript errors
- [ ] No React Hooks violations
- [ ] Follows React best practices
- [ ] Clean, readable code

**Functionality:**
- [ ] Kanban members display works (regression-free)
- [ ] Primary contact ⭐ indicator correct
- [ ] Member links navigate correctly
- [ ] Filtering returns correct members per company

**Performance:**
- [ ] Single API call in Kanban view
- [ ] No API calls in Table/Grid views
- [ ] Fast client-side filtering (< 10ms)

**Build:**
- [ ] `pnpm check` succeeds (0 errors)
- [ ] `pnpm build` succeeds (exit 0)
- [ ] No new warnings introduced

---

## Estimated Time

- Task 1 (Backend endpoint): 5 minutes
- Task 2a (Remove helper): 1 minute
- Task 2b (Add query): 2 minutes
- Task 2c (Update rendering): 10 minutes (2 locations)
- Task 2d (Update mapping): 5 minutes
- Testing: 10 minutes
- **Total:** ~33 minutes

---

## Notes

**Why This Fix Works:**

1. **Single hook call:** `useQuery` called once at component level, not in loop
2. **Deterministic order:** Hook count never changes between renders
3. **React compliance:** Follows Rules of Hooks (no conditional hooks)
4. **Performance win:** Fewer API calls (1 vs N)

**Alternative Considered:**

Keep `getCompanyMembers` but use `useMemo` to create array of hooks.

**Rejected because:**
- Still violates Rules of Hooks
- Complex, hard to maintain
- No performance benefit

**Production Readiness:**

After this fix:
- No console errors
- Better performance
- Ready for production deployment

---

## Related Issues

**Discovered in:**
- User session 2026-01-16
- Console error: "Rendered more hooks than during the previous render"
- Source: `Clients.tsx:92` (getCompanyMembers)

**Root cause:**
- Phase 20.1-02 implemented IIFE pattern incorrectly
- Pattern works for single hook, breaks for multiple
- Need refactor to single hook + filtering

**Prevention:**
- Always call hooks at top level
- Never call hooks in loops or conditionals
- Use filtering instead of conditional hook calls
