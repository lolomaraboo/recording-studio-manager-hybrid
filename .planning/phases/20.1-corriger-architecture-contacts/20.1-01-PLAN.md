# Phase 20.1-01: Corriger Architecture Contacts + Boutons Copier

## Objectif

Corriger l'architecture des contacts d'entreprise et ajouter la fonctionnalit√© de copie email/t√©l√©phone dans toutes les vues.

**Deux probl√®mes √† r√©soudre:**

1. **Architecture incorrecte**: Les contacts sont actuellement dans `client_contacts` (table s√©par√©e) au lieu d'√™tre de vrais clients avec relation many-to-many
2. **Fonctionnalit√© manquante**: Boutons copier (üìã) pour email/t√©l√©phone absents dans Table/Grid/Kanban

## Probl√®me 1: Architecture Incorrecte

### √âtat actuel (INCORRECT)

```sql
-- Table clients
clients (id, type, name, email, phone, ...)

-- Table s√©par√©e pour contacts (PROBL√àME!)
client_contacts (
  id,
  client_id FK,  -- li√© √† l'entreprise
  first_name,
  last_name,
  email,
  phone,
  title,
  is_primary
)
```

**Probl√®mes:**
- Les contacts ne sont pas des clients √† part enti√®re
- Pas de fiche individuelle pour chaque contact
- Un contact ne peut appartenir qu'√† UNE seule entreprise
- Impossible de lier un contact existant √† plusieurs entreprises

### Architecture correcte (OBJECTIVE)

```sql
-- Table clients (existe d√©j√†)
clients (
  id,
  type ('individual' | 'company'),
  name,
  email,
  phone,
  ...tous les champs existants
)

-- NOUVELLE table de liaison (many-to-many)
company_members (
  id,
  company_client_id INT NOT NULL,  -- FK -> clients.id WHERE type='company'
  member_client_id INT NOT NULL,   -- FK -> clients.id WHERE type='individual'
  role VARCHAR(255),                -- ex: "Directeur G√©n√©ral", "Lead Vocalist"
  is_primary BOOLEAN DEFAULT false,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,

  UNIQUE(company_client_id, member_client_id)
)
```

**Avantages:**
- Chaque contact est un vrai client avec sa propre fiche
- Un contact peut appartenir √† PLUSIEURS entreprises/groupes
- Relations bidirectionnelles: entreprise ‚Üí contacts ET contact ‚Üí entreprises
- R√©utilisation des contacts existants

## Probl√®me 2: Boutons Copier Manquants

### √âtat actuel

- ‚ùå **Table view**: Pas de boutons copier pour email/phone
- ‚ùå **Grid view**: Pas de boutons copier pour email/phone
- ‚ùå **Kanban view**: Pas de boutons copier pour email/phone

### Objectif

- ‚úÖ **Table view**: Bouton üìã √† c√¥t√© de email et phone avec toast "Email copi√©!" / "T√©l√©phone copi√©!"
- ‚úÖ **Grid view**: Bouton üìã √† c√¥t√© de email et phone avec toast
- ‚úÖ **Kanban view**: Bouton üìã √† c√¥t√© de email et phone avec toast

## Plan d'Ex√©cution

### Task 1: Migration de la base de donn√©es

**Fichiers √† modifier:**
- `packages/database/src/tenant/schema.ts`
- Nouveau: `packages/database/migrations/NNNN_add_company_members.sql`

**√âtapes:**

1. Cr√©er table `company_members` avec foreign keys
2. Migrer donn√©es de `client_contacts` ‚Üí `clients` + `company_members`:
   ```sql
   -- Pour chaque ligne dans client_contacts:
   -- 1. Cr√©er un client type='individual' avec les infos du contact
   -- 2. Cr√©er une entr√©e dans company_members liant (company, nouveau_client)
   ```
3. Supprimer table `client_contacts` (apr√®s migration confirm√©e)

### Task 2: Adapter backend tRPC

**Fichiers √† modifier:**
- `packages/server/src/routers/clients.ts`

**Changements:**

```typescript
// Remplacer le LEFT JOIN avec client_contacts
// PAR un LEFT JOIN avec company_members ‚Üí clients

.leftJoin(companyMembers, eq(clients.id, companyMembers.companyClientId))
.leftJoin(memberClients, eq(companyMembers.memberClientId, memberClients.id))
.select({
  ...clients,
  contactsCount: sql<number>`CAST(COUNT(DISTINCT ${companyMembers.id}) AS INTEGER)`,
})
.groupBy(clients.id)
```

**Nouveau endpoint:**

```typescript
// clients.getMembers - Obtenir les membres d'une entreprise
getMembers: protectedProcedure
  .input(z.object({ companyId: z.number() }))
  .query(async ({ ctx, input }) => {
    const tenantDb = await ctx.getTenantDb();

    return tenantDb
      .select({
        member: memberClients,  // Le client membre
        role: companyMembers.role,
        isPrimary: companyMembers.isPrimary,
      })
      .from(companyMembers)
      .innerJoin(memberClients, eq(companyMembers.memberClientId, memberClients.id))
      .where(eq(companyMembers.companyClientId, input.companyId))
      .orderBy(
        desc(companyMembers.isPrimary),
        asc(memberClients.name)
      );
  })
```

### Task 3: Adapter frontend - Affichage contacts

**Fichiers √† modifier:**
- `packages/client/src/pages/Clients.tsx`

**Changements:**

1. **Kanban view**: Charger les membres avec le nouveau endpoint
   ```typescript
   // Pour chaque entreprise avec contactsCount > 0
   const { data: members } = trpc.clients.getMembers.useQuery(
     { companyId: client.id },
     { enabled: viewMode === 'kanban' && client.type === 'company' }
   );
   ```

2. **Afficher avec liens vers fiche client:**
   ```tsx
   {members?.map(m => (
     <Link to={`/clients/${m.member.id}`} key={m.member.id}>
       <div className="contact-card">
         {m.isPrimary && <Star />}
         {m.member.name}
         {m.role && <span>{m.role}</span>}
         <a href={`mailto:${m.member.email}`}>{m.member.email}</a>
         <a href={`tel:${m.member.phone}`}>{m.member.phone}</a>
       </div>
     </Link>
   ))}
   ```

### Task 4: Ajouter boutons copier dans TOUTES les vues

**Fichiers √† modifier:**
- `packages/client/src/pages/Clients.tsx`

**Composant r√©utilisable:**

```tsx
function CopyButton({ text, label }: { text: string; label: string }) {
  return (
    <Button
      variant="ghost"
      size="icon"
      className="h-4 w-4"
      onClick={(e) => {
        e.preventDefault();
        e.stopPropagation();
        navigator.clipboard.writeText(text);
        toast.success(`${label} copi√©!`);
      }}
    >
      <Copy className="h-3 w-3" />
    </Button>
  );
}
```

**Int√©gration dans les vues:**

1. **Table View** (lignes ~470-490):
   ```tsx
   <TableCell>
     {client.email && (
       <div className="flex items-center gap-1">
         <Mail className="h-4 w-4" />
         <a href={`mailto:${client.email}`}>{client.email}</a>
         <CopyButton text={client.email} label="Email" />
       </div>
     )}
     {client.phone && (
       <div className="flex items-center gap-1">
         <Phone className="h-4 w-4" />
         <a href={`tel:${client.phone}`}>{client.phone}</a>
         <CopyButton text={client.phone} label="T√©l√©phone" />
       </div>
     )}
   </TableCell>
   ```

2. **Grid View** (lignes ~570-590):
   ```tsx
   {client.email && (
     <div className="flex items-center gap-1">
       <Mail className="h-3 w-3" />
       <a href={`mailto:${client.email}`}>{client.email}</a>
       <CopyButton text={client.email} label="Email" />
     </div>
   )}
   {client.phone && (
     <div className="flex items-center gap-1">
       <Phone className="h-3 w-3" />
       <a href={`tel:${client.phone}`}>{client.phone}</a>
       <CopyButton text={client.phone} label="T√©l√©phone" />
     </div>
   )}
   ```

3. **Kanban View** (dans les cartes entreprise ET particuliers):
   ```tsx
   {/* Pour clients individuels */}
   {client.email && (
     <div className="flex items-center gap-1">
       <Mail className="h-3 w-3" />
       <a href={`mailto:${client.email}`}>{client.email}</a>
       <CopyButton text={client.email} label="Email" />
     </div>
   )}

   {/* Pour membres d'entreprises */}
   {members?.map(m => (
     <div key={m.member.id}>
       {m.member.email && (
         <div className="flex items-center gap-1">
           <Mail className="h-3 w-3" />
           <a href={`mailto:${m.member.email}`}>{m.member.email}</a>
           <CopyButton text={m.member.email} label="Email" />
         </div>
       )}
     </div>
   ))}
   ```

### Task 5: Tests de migration

**Fichiers √† cr√©er:**
- `packages/database/scripts/test-migration-company-members.ts`

**Tests √† effectuer:**

1. V√©rifier que tous les contacts de `client_contacts` sont migr√©s
2. V√©rifier relations company ‚Üî members fonctionnent
3. Tester ajout/suppression de membres
4. Tester qu'un contact peut appartenir √† plusieurs entreprises

## Must-Have Criteria

### Backend

- [ ] Table `company_members` cr√©√©e avec foreign keys
- [ ] Migration script convertit `client_contacts` ‚Üí `clients` + `company_members`
- [ ] Endpoint `clients.getMembers` retourne les membres d'une entreprise
- [ ] `contactsCount` utilise `company_members` au lieu de `client_contacts`
- [ ] Table `client_contacts` supprim√©e apr√®s migration

### Frontend - Architecture

- [ ] Kanban view charge les membres avec `getMembers` endpoint
- [ ] Membres affich√©s avec **liens cliquables** vers leur fiche client
- [ ] Affichage: nom, r√¥le, √©toile si primary, email, t√©l√©phone

### Frontend - Boutons Copier (TOUTES LES VUES)

- [ ] **Table view**: Bouton copier pour email ‚úÖ
- [ ] **Table view**: Bouton copier pour t√©l√©phone ‚úÖ
- [ ] **Grid view**: Bouton copier pour email ‚úÖ
- [ ] **Grid view**: Bouton copier pour t√©l√©phone ‚úÖ
- [ ] **Kanban view** (clients individuels): Bouton copier pour email ‚úÖ
- [ ] **Kanban view** (clients individuels): Bouton copier pour t√©l√©phone ‚úÖ
- [ ] **Kanban view** (membres entreprises): Bouton copier pour email ‚úÖ
- [ ] **Kanban view** (membres entreprises): Bouton copier pour t√©l√©phone ‚úÖ
- [ ] Toast "Email copi√©!" ou "T√©l√©phone copi√©!" s'affiche
- [ ] `Copy` icon import√© depuis lucide-react

## Nice-to-Have

- Interface pour ajouter/retirer des membres √† une entreprise
- Sur la fiche d'un client individuel, afficher les entreprises dont il est membre
- Validation: un contact ne peut √™tre membre que de type 'company'

## Impacts

**Base de donn√©es:**
- Migration one-time pour convertir donn√©es
- Sch√©ma plus propre et flexible

**Frontend:**
- Meilleure UX avec boutons copier partout
- Contacts cliquables vers leur fiche

**Fonctionnalit√©s futures:**
- Facilite gestion d'√©quipes/groupes
- Facilite CRM avec relations entreprise-personnes
