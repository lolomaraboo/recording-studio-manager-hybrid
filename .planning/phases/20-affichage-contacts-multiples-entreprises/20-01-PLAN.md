---
phase: 20-affichage-contacts-multiples-entreprises
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/pages/Clients.tsx
autonomous: true

must_haves:
  truths:
    - "Companies with multiple contacts show contact count badge in Table view"
    - "Companies with multiple contacts show contact count badge in Grid view"
    - "Companies in Kanban view display full list of all contacts with name, title, email, phone"
    - "Primary contact is visually identified with ⭐ icon in Kanban view"
    - "Email and phone links are clickable (mailto/tel) in Kanban view"
    - "Copy-to-clipboard icons appear next to all emails and phones in all views"
  artifacts:
    - path: "packages/client/src/pages/Clients.tsx"
      provides: "Enhanced client list views with contact visibility"
      min_lines: 950
      exports: ["Clients function component"]
  key_links:
    - from: "Clients.tsx"
      to: "trpc.clients.list"
      via: "tRPC query with contacts metadata"
      pattern: "trpc\\.clients\\.list\\.useQuery"
    - from: "Clients.tsx badges"
      to: "client.contacts array"
      via: "Contact count rendering"
      pattern: "contacts.*length"
    - from: "Kanban contact cards"
      to: "mailto: and tel: links"
      via: "Clickable contact methods"
      pattern: "(mailto:|tel:)"
---

<objective>
Display multiple contacts from `client_contacts` table in all three client views (Table/Grid/Kanban) with appropriate information density per view mode. Add copy-to-clipboard functionality for all email and phone fields throughout the application.

Purpose: Make contacts created via client_contacts table (companies with 4-6 contacts, musical groups with 6 musicians) visible in client lists. Currently contacts are only visible on detail page, making it impossible to see who to contact from the list view.

Output: Enhanced Clients.tsx with contact visibility across all view modes and universal copy-to-clipboard for emails/phones.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-affichage-contacts-multiples-entreprises/20-CONTEXT.md

# Prior phase context
@.planning/phases/19-differencier-vues-grid-kanban-clients/19-04-SUMMARY.md

# Key source files
@packages/client/src/pages/Clients.tsx
@packages/database/src/tenant/schema.ts
@packages/server/src/routers/clients.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add contact count badges to Table and Grid views</name>
  <files>packages/client/src/pages/Clients.tsx</files>
  <action>
Modify the clients list query to load contact counts for all clients:

1. **Update tRPC query** - Modify `trpc.clients.list.useQuery()` to use new backend procedure that includes contacts count
   - Backend already has `getWithContacts` but it's for single client
   - Need to either modify `clients.list` to include contacts count OR create new query
   - Suggested approach: Extend existing `clientsWithStats` useMemo to query contacts separately

2. **Table view contact badge** (lines 357-504)
   - Add new TableCell after "Type" column for companies
   - Display Badge with text "{count} contacts" if client.type === 'company' AND contacts count > 0
   - Use variant="outline" to match existing Type badge style
   - Keep cell empty for individual clients to maintain alignment

3. **Grid view contact badge** (lines 506-607)
   - Add Badge below type badge in CardHeader
   - Only display if client.type === 'company' AND contacts count > 0
   - Use same variant="outline" style
   - Position: Below existing type badge with gap-1

Implementation notes:
- Contacts count can be calculated client-side after loading all client_contacts for displayed clients
- Alternative: Extend backend `clients.list` to include LEFT JOIN count of client_contacts
- Choose simplest approach that doesn't break existing functionality
- Maintain existing responsive behavior from Phase 19
</action>
  <verify>
Visual inspection of /clients page:
- Table view shows new "Contacts" column with badges for companies
- Grid view shows contact badge below type badge for companies
- Badge format: "X contact(s)" where X is count
- Badge only appears for type="company" clients
- Individual clients show no contact badge
- TypeScript: `pnpm check` passes with 0 errors
</verify>
  <done>
Companies with multiple contacts (e.g., "Mélodie Productions SAS") display contact count badge in both Table and Grid views. Individual clients show no contact badge. Existing Table/Grid functionality unchanged.
</done>
</task>

<task type="auto">
  <name>Task 2: Display full contact list in Kanban view with copy-to-clipboard</name>
  <files>packages/client/src/pages/Clients.tsx</files>
  <action>
Enhance Kanban view to display complete contact information for companies with multiple contacts:

1. **Load contacts data** - Ensure contacts array is available for each client
   - Use existing `trpc.clients.getWithContacts` OR batch load contacts for all visible clients
   - Most efficient: Load all contacts for visible clients in one query
   - Store in clientsWithContacts state or useMemo

2. **Kanban contact section** (lines 609-886)
   - After existing CardContent sections (contact info, workflow indicators, notes preview)
   - Add new section with border-t separator: "Contacts de l'entreprise"
   - Only display if client.type === 'company' AND client.contacts.length > 0
   - Layout: Vertical stack of contact cards

3. **Contact card structure** (within Kanban)
   - For each contact in client.contacts:
     - Display full name: `{contact.firstName} {contact.lastName}`
     - If contact.isPrimary: Prefix with ⭐ icon (Star component from lucide-react)
     - Display title/role if exists: `<span className="text-xs text-muted-foreground">{contact.title}</span>`
     - Display email with Mail icon + mailto link + copy icon
     - Display phone with Phone icon + tel link + copy icon
     - Spacing: text-xs for compact display, gap-2 between elements

4. **Copy-to-clipboard implementation**
   - Import Copy icon from lucide-react
   - Add small copy button next to each email/phone
   - On click: `navigator.clipboard.writeText(value)` + `toast.success("Copié!")`
   - Button style: `<Button variant="ghost" size="icon" className="h-4 w-4">` for minimal footprint
   - This pattern applies to ALL emails/phones in the application (general enhancement)

5. **Contact ordering**
   - Primary contact first (isPrimary = true)
   - Remaining contacts sorted alphabetically by lastName

Example structure:
```tsx
{client.type === 'company' && client.contacts && client.contacts.length > 0 && (
  <div className="space-y-2 border-t pt-2">
    <h4 className="text-xs font-semibold">Contacts de l'entreprise</h4>
    {client.contacts.sort((a, b) => {...}).map((contact) => (
      <div key={contact.id} className="text-xs space-y-1">
        <div className="font-medium flex items-center gap-1">
          {contact.isPrimary && <Star className="h-3 w-3 text-yellow-500 fill-yellow-500" />}
          {contact.firstName} {contact.lastName}
        </div>
        {contact.title && <div className="text-muted-foreground">{contact.title}</div>}
        {contact.email && (
          <div className="flex items-center gap-2">
            <Mail className="h-3 w-3" />
            <a href={`mailto:${contact.email}`}>{contact.email}</a>
            <Button onClick={() => copyToClipboard(contact.email)}>
              <Copy className="h-3 w-3" />
            </Button>
          </div>
        )}
        {/* Similar for phone */}
      </div>
    ))}
  </div>
)}
```

Implementation notes:
- Avoid over-nesting to prevent horizontal crowding
- Use text-xs consistently for contact details to maintain card compactness
- Copy button should be subtle but discoverable (ghost variant, small size)
- Toast notification provides feedback without modal interruption
- Maintain shadow-lg on Kanban cards from Phase 19
</action>
  <verify>
Manual testing with test data (Mélodie Productions SAS, Midnight Groove Collective):

1. **Visual verification:**
   - Kanban view shows "Contacts de l'entreprise" section for companies
   - All contacts listed with full information (name, title, email, phone)
   - Primary contact has ⭐ icon before name
   - Copy icons visible next to all email/phone fields

2. **Interaction testing:**
   - Click email link → opens mailto: in default email client
   - Click phone link → initiates tel: call on mobile
   - Click copy icon next to email → copies to clipboard + shows toast "Copié!"
   - Click copy icon next to phone → copies to clipboard + shows toast "Copié!"

3. **Responsive testing:**
   - Kanban view remains readable on mobile (375px width)
   - Contact section doesn't break card layout
   - All copy icons remain clickable on touch devices

4. **TypeScript validation:**
   - `pnpm check` passes with 0 errors
   - No type warnings in Clients.tsx

5. **Production build:**
   - `pnpm --filter client build` succeeds
   - No build-time errors
</verify>
  <done>
Kanban view displays complete contact list for companies with name, title, email, phone. Primary contact marked with ⭐. Email and phone are clickable (mailto/tel). Copy-to-clipboard icons present and functional for all emails/phones. Toast feedback confirms copy action. Mobile-responsive.
</done>
</task>

</tasks>

<verification>
## Overall Phase Verification

After completing both tasks, validate complete feature:

1. **Table View:**
   - Companies show "X contact(s)" badge in dedicated column
   - Individual clients have empty contact column (or column hidden if no companies)
   - Existing sorting and search functionality unaffected

2. **Grid View:**
   - Companies show "X contact(s)" badge below type badge
   - Badge styling consistent with type badge
   - Card layout maintains Phase 19 responsive breakpoints

3. **Kanban View:**
   - Companies display full contact section at bottom of card
   - All contacts visible with complete information
   - Primary contact identified with ⭐ icon first
   - Copy icons functional for all emails/phones
   - mailto: and tel: links functional

4. **Cross-view Consistency:**
   - Same contact count displayed in Table and Grid badges
   - Contact data consistent across views (same source)
   - No regressions in existing view functionality

5. **Production Readiness:**
   - TypeScript 0 errors: `pnpm check`
   - Build succeeds: `pnpm build`
   - No console errors when navigating between views
   - Responsive at all breakpoints (1920px → 375px)
</verification>

<success_criteria>
- [x] Table view displays contact count badge for companies (e.g., "4 contacts")
- [x] Grid view displays contact count badge for companies
- [x] Kanban view displays full contact list for companies
- [x] Primary contact marked with ⭐ icon in Kanban view
- [x] Email links clickable (mailto:) in Kanban view
- [x] Phone links clickable (tel:) in Kanban view
- [x] Copy-to-clipboard icons present and functional for all emails/phones
- [x] Toast notification confirms copy action
- [x] TypeScript 0 errors
- [x] Responsive at all breakpoints
- [x] No regressions in existing Table/Grid/Kanban functionality
</success_criteria>

<output>
After completion, create `.planning/phases/20-affichage-contacts-multiples-entreprises/20-01-SUMMARY.md`
</output>
