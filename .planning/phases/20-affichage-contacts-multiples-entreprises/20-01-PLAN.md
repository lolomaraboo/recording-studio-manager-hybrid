---
phase: 20-affichage-contacts-multiples-entreprises
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/routers/clients.ts
  - packages/client/src/pages/Clients.tsx
autonomous: true

must_haves:
  truths:
    - "Companies with multiple contacts show accurate contact count badge in Table view"
    - "Companies with multiple contacts show accurate contact count badge in Grid view"
    - "Companies in Kanban view display full list of all contacts with name, title, email, phone"
    - "Primary contact is visually identified with ⭐ icon in Kanban view"
    - "Email and phone links are clickable (mailto/tel) in Kanban view"
    - "Copy-to-clipboard icons appear next to emails and phones in Clients.tsx only (Phase 20 scope)"
  artifacts:
    - path: "packages/server/src/routers/clients.ts"
      provides: "Extended clients.list with contactsCount via LEFT JOIN"
      exports: ["clients.list returns contactsCount field"]
    - path: "packages/client/src/pages/Clients.tsx"
      provides: "Enhanced client list views with contact visibility"
      min_lines: 1050
      exports: ["Clients function component"]
  key_links:
    - from: "clients.ts list procedure"
      to: "clientContacts table"
      via: "LEFT JOIN COUNT for contactsCount"
      pattern: "leftJoin.*clientContacts.*COUNT"
    - from: "Clients.tsx"
      to: "trpc.clients.list"
      via: "tRPC query with contactsCount in response"
      pattern: "trpc\\.clients\\.list\\.useQuery"
    - from: "Clients.tsx badges"
      to: "client.contactsCount"
      via: "Contact count rendering from backend"
      pattern: "contactsCount"
    - from: "Kanban contact loading"
      to: "trpc.clients.getWithContacts"
      via: "Batch loading contacts for visible clients"
      pattern: "trpc\\.clients\\.getWithContacts"
    - from: "Kanban contact cards"
      to: "mailto: and tel: links"
      via: "Clickable contact methods"
      pattern: "(mailto:|tel:)"
---

<objective>
Display multiple contacts from `client_contacts` table in all three client views (Table/Grid/Kanban) with appropriate information density per view mode. Add copy-to-clipboard functionality for emails and phones in Clients.tsx only (Phase 20 scope).

Purpose: Make contacts created via client_contacts table (companies with 4-6 contacts, musical groups with 6 musicians) visible in client lists. Currently contacts are only visible on detail page, making it impossible to see who to contact from the list view.

Output: Extended backend to provide contact counts + frontend Clients.tsx with contact visibility across all view modes and copy-to-clipboard for emails/phones.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-affichage-contacts-multiples-entreprises/20-CONTEXT.md

# Prior phase context
@.planning/phases/19-differencier-vues-grid-kanban-clients/19-04-SUMMARY.md

# Key source files
@packages/client/src/pages/Clients.tsx
@packages/database/src/tenant/schema.ts
@packages/server/src/routers/clients.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend backend clients.list to include contactsCount</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
Modify the `list` procedure (lines 26-70) to add contact count via LEFT JOIN:

**Current query structure (lines 40-67):**
- Already has LEFT JOIN with clientNotes for notesCount
- Returns notesCount via `sql<number>CAST(COUNT(${clientNotes.id}) AS INTEGER)`

**Required changes:**

1. **Add second LEFT JOIN for clientContacts** (after existing clientNotes join):
```typescript
.leftJoin(clientNotes, eq(clients.id, clientNotes.clientId))
.leftJoin(clientContacts, eq(clients.id, clientContacts.clientId))
```

2. **Add contactsCount to select statement** (after lastNoteDate, line 61):
```typescript
contactsCount: sql<number>`CAST(COUNT(DISTINCT ${clientContacts.id}) AS INTEGER)`,
```

**CRITICAL:** Use `COUNT(DISTINCT ${clientContacts.id})` not `COUNT(${clientContacts.id})` to avoid counting duplicates when client has both notes AND contacts.

**Import statement update (line 5):**
Ensure clientContacts is already imported (it is - line 5).

**Why this approach:**
- Single query loads all clients with contact counts (no N+1 queries)
- Same pattern as existing notesCount (proven working)
- Frontend gets contactsCount directly in clients.list response
- No need for separate procedure or batch loading

**Return type update:**
TypeScript will infer contactsCount automatically from sql<number> - no explicit type changes needed.
</action>
  <verify>
Backend verification:

1. **Type check:**
```bash
pnpm --filter server check
```

2. **Test query in development:**
```bash
DATABASE_URL="postgresql://postgres:password@localhost:5432/rsm_master" pnpm --filter server dev
```

3. **Query verification via tRPC:**
Open http://localhost:5174/clients in browser, check Network tab:
- Request to /api/trpc/clients.list
- Response includes `contactsCount: number` for each client
- For clients with 0 contacts: contactsCount = 0
- For clients with N contacts: contactsCount = N

4. **SQL verification for accuracy:**
```sql
-- Connect to tenant_16 database
docker exec -i rsm-postgres psql -U postgres -d tenant_16

-- Compare API response with actual counts
SELECT
  c.id,
  c.name,
  COUNT(cc.id) as actual_contacts
FROM clients c
LEFT JOIN client_contacts cc ON c.id = cc.client_id
WHERE c.type = 'company'
GROUP BY c.id, c.name
ORDER BY c.id;
```

Compare displayed badge counts in UI with actual_contacts from SQL query. They must match exactly.

5. **Edge case validation:**
- Client with 0 contacts: contactsCount = 0 (not null)
- Client with 1 contact: contactsCount = 1
- Client with multiple contacts: contactsCount = N (exact count)
- Individual clients: contactsCount = 0 (contacts not expected)
</verify>
  <done>
Backend clients.list procedure returns contactsCount field for all clients via LEFT JOIN COUNT DISTINCT. TypeScript passes. SQL verification confirms displayed counts match database. Edge cases validated (0, 1, N contacts).
</done>
</task>

<task type="auto">
  <name>Task 2: Add contact count badges to Table and Grid views</name>
  <files>packages/client/src/pages/Clients.tsx</files>
  <action>
Modify the clients list views to display contact count badges using the new `contactsCount` field from backend:

**Prerequisites:**
- Task 1 complete (backend returns contactsCount)
- TypeScript types automatically inferred from tRPC query

**Implementation:**

1. **Table view contact badge** (lines 357-504)
   - Add new TableCell after "Type" column for companies only
   - Display Badge with text "{count} contact(s)" if client.type === 'company' AND client.contactsCount > 0
   - Use variant="outline" to match existing Type badge style
   - Keep cell empty for individual clients to maintain alignment

Example code position (after Type cell, around line 480):
```tsx
<TableCell>
  {client.type === 'company' && client.contactsCount > 0 && (
    <Badge variant="outline">
      {client.contactsCount} contact{client.contactsCount > 1 ? 's' : ''}
    </Badge>
  )}
</TableCell>
```

2. **Grid view contact badge** (lines 506-607)
   - Add Badge below type badge in CardHeader
   - Only display if client.type === 'company' AND client.contactsCount > 0
   - Use same variant="outline" style
   - Position: Below existing type badge with gap-1

Example code position (in CardHeader, after type badge, around line 560):
```tsx
{client.type === 'company' && client.contactsCount > 0 && (
  <Badge variant="outline" className="text-xs">
    {client.contactsCount} contact{client.contactsCount > 1 ? 's' : ''}
  </Badge>
)}
```

**Data source:**
- Use `client.contactsCount` directly from backend response (no client-side calculation)
- Field is guaranteed to exist after Task 1 (0 for no contacts)

**Maintain existing:**
- Table/Grid responsive behavior from Phase 19
- Existing column structure and spacing
- Type badge styling
</action>
  <verify>
Visual inspection of /clients page:

1. **Table view:**
   - New "Contacts" column visible
   - Companies with contacts show "X contact(s)" badge
   - Badge format: "1 contact" (singular) or "4 contacts" (plural)
   - Badge only appears for type="company" clients with contactsCount > 0
   - Individual clients show no badge in that column

2. **Grid view:**
   - Contact badge appears below type badge for companies
   - Same format as Table view
   - Badge only for companies with contactsCount > 0

3. **Count accuracy verification:**
   - Compare badge counts with SQL query from Task 1
   - Example: "Mélodie Productions SAS" should show "4 contacts" (verify in database)

4. **TypeScript:**
```bash
pnpm check
```

5. **Build validation:**
```bash
pnpm --filter client build
```
</verify>
  <done>
Companies with multiple contacts display accurate contact count badge in both Table and Grid views. Badge format: "X contact(s)". Individual clients show no badge. TypeScript 0 errors. Build succeeds.
</done>
</task>

<task type="auto">
  <name>Task 3: Display full contact list in Kanban view with copy-to-clipboard</name>
  <files>packages/client/src/pages/Clients.tsx</files>
  <action>
Enhance Kanban view to display complete contact information for companies with batch contact loading:

**1. Contact data loading strategy:**

Since backend `clients.list` doesn't return full contact arrays (only counts), implement efficient batch loading:

**Option A (Recommended): Batch load contacts for visible clients**
```tsx
// After clients.list query, extract company client IDs
const companyClientIds = clientsWithStats
  .filter(c => c.type === 'company' && c.contactsCount > 0)
  .map(c => c.id);

// Batch load contacts for all companies (parallel queries)
const contactQueries = companyClientIds.map(clientId =>
  trpc.clients.getWithContacts.useQuery({ id: clientId })
);

// Build clientId -> contacts map
const contactsMap = new Map();
contactQueries.forEach((query, index) => {
  if (query.data?.contacts) {
    contactsMap.set(companyClientIds[index], query.data.contacts);
  }
});
```

**Why this approach:**
- Reuses existing `getWithContacts` procedure (no backend changes)
- Loads contacts only for company clients with contactsCount > 0
- Parallel tRPC queries (efficient with React Query)
- Contacts data cached by tRPC client

**Alternative Option B:** Create new backend procedure `listWithContacts` - NOT NEEDED for Phase 20, defer to future optimization.

**2. Kanban contact section** (lines 609-886)

Add after existing CardContent sections (contact info, workflow indicators, notes preview):

```tsx
{/* Contact list for companies */}
{client.type === 'company' && contactsMap.has(client.id) && (
  <div className="space-y-2 border-t pt-2">
    <h4 className="text-xs font-semibold">Contacts de l'entreprise</h4>
    {contactsMap.get(client.id)
      .sort((a, b) => {
        // Primary contact first
        if (a.isPrimary && !b.isPrimary) return -1;
        if (!a.isPrimary && b.isPrimary) return 1;
        // Then alphabetically by lastName
        return a.lastName.localeCompare(b.lastName);
      })
      .map((contact) => (
        <div key={contact.id} className="text-xs space-y-1 bg-muted/50 p-2 rounded">
          {/* Name with primary star */}
          <div className="font-medium flex items-center gap-1">
            {contact.isPrimary && <Star className="h-3 w-3 text-yellow-500 fill-yellow-500" />}
            {contact.firstName} {contact.lastName}
          </div>

          {/* Title/role */}
          {contact.title && (
            <div className="text-muted-foreground">{contact.title}</div>
          )}

          {/* Email with mailto link and copy button */}
          {contact.email && (
            <div className="flex items-center gap-2">
              <Mail className="h-3 w-3 flex-shrink-0" />
              <a href={`mailto:${contact.email}`} className="hover:underline truncate">
                {contact.email}
              </a>
              <Button
                variant="ghost"
                size="icon"
                className="h-4 w-4 flex-shrink-0"
                onClick={(e) => {
                  e.preventDefault();
                  navigator.clipboard.writeText(contact.email);
                  toast.success("Email copié!");
                }}
              >
                <Copy className="h-3 w-3" />
              </Button>
            </div>
          )}

          {/* Phone with tel link and copy button */}
          {contact.phone && (
            <div className="flex items-center gap-2">
              <Phone className="h-3 w-3 flex-shrink-0" />
              <a href={`tel:${contact.phone}`} className="hover:underline">
                {contact.phone}
              </a>
              <Button
                variant="ghost"
                size="icon"
                className="h-4 w-4 flex-shrink-0"
                onClick={(e) => {
                  e.preventDefault();
                  navigator.clipboard.writeText(contact.phone);
                  toast.success("Téléphone copié!");
                }}
              >
                <Copy className="h-3 w-3" />
              </Button>
            </div>
          )}
        </div>
      ))}
  </div>
)}
```

**3. Required imports:**
```tsx
import { Star, Copy, Mail, Phone } from 'lucide-react';
import { toast } from 'sonner'; // Already in project
```

**4. Copy-to-clipboard scope:**
ONLY implement in Clients.tsx for Phase 20. Universal copy-to-clipboard across all pages (ClientDetail, Sessions, etc.) is deferred to future phase.

**Implementation notes:**
- Use `bg-muted/50` for contact cards to differentiate from main card content
- `flex-shrink-0` on icons prevents crushing on narrow screens
- `truncate` on email prevents overflow
- Toast notification provides instant feedback
- Maintain shadow-lg on Kanban cards from Phase 19
</action>
  <verify>
Manual testing with test data (Mélodie Productions SAS with 4 contacts, Midnight Groove Collective with 6 musicians):

1. **Visual verification:**
   - Kanban view shows "Contacts de l'entreprise" section for companies with contacts
   - All contacts listed with full information (name, title, email, phone)
   - Primary contact has ⭐ icon before name and appears first
   - Copy icons visible next to all email/phone fields
   - Contact cards have subtle background (muted/50)

2. **Interaction testing:**
   - Click email link → opens mailto: in default email client
   - Click phone link → initiates tel: call (test on mobile or check href attribute)
   - Click copy icon next to email → copies to clipboard + shows toast "Email copié!"
   - Click copy icon next to phone → copies to clipboard + shows toast "Téléphone copié!"
   - Verify clipboard content matches displayed value

3. **Data accuracy:**
   - Run SQL query to verify contact display matches database:
```sql
SELECT
  cc.id,
  cc.client_id,
  cc.first_name,
  cc.last_name,
  cc.title,
  cc.email,
  cc.phone,
  cc.is_primary
FROM client_contacts cc
WHERE cc.client_id IN (SELECT id FROM clients WHERE type = 'company')
ORDER BY cc.client_id, cc.is_primary DESC, cc.last_name;
```

4. **Responsive testing:**
   - Kanban view readable on mobile (375px width)
   - Contact section doesn't break card layout
   - All copy icons remain clickable on touch devices
   - Email truncates properly on narrow cards

5. **TypeScript validation:**
```bash
pnpm check
```

6. **Production build:**
```bash
pnpm --filter client build
```
</verify>
  <done>
Kanban view displays complete contact list for companies with name, title, email, phone. Primary contact marked with ⭐ and appears first. Email and phone are clickable (mailto/tel). Copy-to-clipboard icons present and functional for all emails/phones in Clients.tsx. Toast feedback confirms copy action. Mobile-responsive. SQL verification confirms accuracy.
</done>
</task>

</tasks>

<verification>
## Overall Phase Verification

After completing all tasks, validate complete feature:

1. **Backend validation:**
   - clients.list returns contactsCount for all clients
   - SQL verification: displayed counts match actual database counts
   - No N+1 queries (single query for list, batch queries for Kanban contacts)

2. **Table View:**
   - Companies show "X contact(s)" badge in dedicated column
   - Individual clients have empty contact column
   - Badge counts match database (SQL verification)
   - Existing sorting and search functionality unaffected

3. **Grid View:**
   - Companies show "X contact(s)" badge below type badge
   - Badge styling consistent with type badge
   - Card layout maintains Phase 19 responsive breakpoints

4. **Kanban View:**
   - Companies display full contact section at bottom of card
   - All contacts visible with complete information
   - Primary contact identified with ⭐ icon and appears first
   - Copy icons functional for all emails/phones
   - mailto: and tel: links functional
   - Toast notifications working

5. **Cross-view Consistency:**
   - Same contact count displayed in Table and Grid badges
   - Contact data consistent across views (same source)
   - No regressions in existing view functionality

6. **Scope Validation:**
   - Copy-to-clipboard ONLY in Clients.tsx (not universal)
   - Future phases can extend to other pages (ClientDetail, Sessions, etc.)

7. **Production Readiness:**
   - TypeScript 0 errors: `pnpm check`
   - Build succeeds: `pnpm build`
   - No console errors when navigating between views
   - Responsive at all breakpoints (1920px → 375px)

8. **SQL Accuracy Verification:**
   - Run count query and compare with UI badges
   - All counts must match exactly
   - Document any discrepancies
</verification>

<success_criteria>
- [x] Backend clients.list returns contactsCount via LEFT JOIN COUNT DISTINCT
- [x] SQL verification confirms contactsCount accuracy (matches database)
- [x] Table view displays contact count badge for companies (e.g., "4 contacts")
- [x] Grid view displays contact count badge for companies
- [x] Kanban view displays full contact list for companies
- [x] Primary contact marked with ⭐ icon in Kanban view and appears first
- [x] Email links clickable (mailto:) in Kanban view
- [x] Phone links clickable (tel:) in Kanban view
- [x] Copy-to-clipboard icons present and functional for emails/phones in Clients.tsx only
- [x] Toast notification confirms copy action
- [x] TypeScript 0 errors
- [x] Responsive at all breakpoints
- [x] No regressions in existing Table/Grid/Kanban functionality
</success_criteria>

<output>
After completion, create `.planning/phases/20-affichage-contacts-multiples-entreprises/20-01-SUMMARY.md`
</output>
