---
phase: 3.9.3-fix-chatbot-input-focus-bug
plan: 01
type: execute
---

<objective>
Fix chatbot textarea focus bug - input should only stay focused while actively chatting, not when user clicks elsewhere on the page.

Purpose: Allow users to interact with page elements (add client notes, fill forms) while chatbot is open without the chatbot stealing focus.
Output: Modified AIAssistant.tsx with proper focus management that respects user intent.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/client/src/components/AIAssistant.tsx

**Problem identified:**
Lines 446-453 in AIAssistant.tsx contain an aggressive `onBlur` handler that re-focuses the input whenever it loses focus (unless clicking a button). This prevents users from typing in other inputs on the page while the chatbot is open.

**Current behavior:**
```typescript
onBlur={() => {
  // Re-focus immediately if lost (unless clicking button)
  setTimeout(() => {
    if (!isLoading && document.activeElement?.tagName !== 'BUTTON') {
      inputRef.current?.focus();
    }
  }, 0);
}}
```

**Expected behavior:**
- Input should have `autoFocus` when chatbot opens
- Input should blur when user clicks outside the chatbot component
- Input should NOT auto-refocus when user interacts with page elements
- User can manually click back into input to resume chatting
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove aggressive onBlur handler from chatbot input</name>
  <files>packages/client/src/components/AIAssistant.tsx</files>
  <action>
Remove the onBlur handler (lines 446-453) from the Input component in AIAssistant.tsx. The input should keep autoFocus on mount but NOT automatically re-focus when user clicks elsewhere. This allows natural focus management - user can click outside to interact with page, then click back into chatbot input when ready to chat again.

Keep the autoFocus prop (line 442) so input is focused when chatbot first opens, but remove the forced re-focusing behavior.
  </action>
  <verify>
1. Read AIAssistant.tsx and confirm onBlur handler is removed
2. Confirm autoFocus prop is still present
3. npm run build succeeds without errors
  </verify>
  <done>Input no longer has onBlur handler that steals focus, autoFocus remains for initial open</done>
</task>

<task type="auto">
  <name>Task 2: Deploy fix to production</name>
  <files>packages/client/</files>
  <action>
Deploy the client fix to production:
1. Commit the change with clear message explaining the fix
2. Push to origin
3. SSH to VPS and pull latest code
4. Rebuild client container with docker-compose build --no-cache client
5. Restart client container with docker-compose restart client
6. Verify container is healthy with docker-compose ps
  </action>
  <verify>
1. Git log shows commit with focus fix
2. docker-compose ps shows rsm-client as healthy
3. curl https://recording-studio-manager.com returns 200
  </verify>
  <done>Fix deployed to production, client container restarted successfully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed chatbot focus behavior - input no longer steals focus when clicking outside</what-built>
  <how-to-verify>
1. Visit https://recording-studio-manager.com/clients/1
2. Open the AI chatbot (should still auto-focus on open)
3. Click in the "Nouvelle note" textarea for client notes
4. Start typing - verify you can type in the notes field
5. Chatbot input should NOT steal focus back
6. Click back in chatbot input - verify you can resume chatting
7. Test: Type a note → click chatbot → type message → click note again
8. Confirm: No focus stealing, natural interaction between inputs
  </how-to-verify>
  <resume-signal>Type "approved" if focus works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] onBlur handler removed from chatbot input
- [ ] autoFocus prop still present for initial open
- [ ] Build succeeds without errors
- [ ] Deployed to production
- [ ] User can type in page inputs without chatbot stealing focus
- [ ] User can click back into chatbot to resume chatting
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Focus behavior works correctly in production
- User can interact with page elements while chatbot is open
- Chatbot input still auto-focuses on initial open
</success_criteria>

<output>
After completion, create `.planning/phases/3.9.3-fix-chatbot-input-focus-bug/3.9.3-01-SUMMARY.md`:

# Phase 3.9.3 Plan 1: Fix Chatbot Input Focus Bug Summary

**Chatbot input no longer steals focus from page elements**

## Accomplishments

- Removed aggressive onBlur handler that re-focused chatbot input
- Maintained autoFocus for better UX when chatbot opens
- Users can now interact with page forms/inputs while chatbot is open
- Deployed fix to production

## Files Created/Modified

- `packages/client/src/components/AIAssistant.tsx` - Removed onBlur handler (lines 446-453)

## Implementation Details

**Problem:**
The chatbot input had an onBlur handler that automatically re-focused the input whenever it lost focus (unless clicking a button). This prevented users from typing in other page inputs like client notes textarea.

**Solution:**
Removed the onBlur handler entirely. The input still has autoFocus when the chatbot opens for good UX, but now respects user intent when they click outside the chatbot to interact with page elements.

**Code removed:**
```typescript
onBlur={() => {
  setTimeout(() => {
    if (!isLoading && document.activeElement?.tagName !== 'BUTTON') {
      inputRef.current?.focus();
    }
  }, 0);
}}
```

## Decisions Made

- Keep autoFocus for initial chatbot open (better UX)
- Remove auto-refocus behavior (respects user intent)
- Natural focus management - user clicks where they want to type

## Next Phase Readiness

✅ **Phase 3.9.3 Complete** - Chatbot focus bug fixed

Ready for next phase or return to roadmap priorities
</output>
