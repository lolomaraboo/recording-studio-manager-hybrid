---
phase: 01-production-stability
plan: 1
type: execute
---

<objective>
Fix production HTTPS blocker and commit pending changes to establish stable foundation.

Purpose: Production app currently broken (CORS blocks HTTPS origins). Uncommitted auth.ts changes = risk of loss. Must have working HTTPS before any marketing/features.
Output: Production accessible via https://*.recording-studio-manager.com, auth.ts tenant provisioning committed, test cleanup files committed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current production issue:**
- Backend accepts http:// origins but blocks https:// origins
- CORS pattern in server needs update to accept HTTPS subdomains
- App deployed at 31.220.104.244 with wildcard SSL (*.recording-studio-manager.com)
- Containers running: rsm-server, rsm-client, rsm-postgres, rsm-redis

**Uncommitted work (from STATE.md):**
- auth.ts modifications (tenant auto-provisioning code)
- Test cleanup files (error-context.md deleted, playwright screenshots)

**Stack context:**
- Backend: Express + tRPC on port 3000 (Docker container rsm-server)
- Frontend: React Vite on port 5173 (Docker container rsm-client)
- Nginx reverse proxy handling SSL termination
- CORS configured in server code (needs pattern update)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Locate and fix CORS HTTPS configuration</name>
  <files>packages/server/src/index.ts (or similar CORS config file)</files>
  <action>
    1. Search for CORS configuration in server codebase (likely Express cors middleware)
    2. Current pattern probably: `http://*.recording-studio-manager.com` or regex excluding https://
    3. Update origin pattern to accept: `https://*.recording-studio-manager.com` AND `http://localhost:*` (for dev)
    4. Verify pattern allows: https://app.recording-studio-manager.com, https://studio-demo.recording-studio-manager.com, http://localhost:5173
    5. Do NOT use wildcard `*` origin (security risk) - keep subdomain pattern matching
    6. If using regex, ensure it handles both http:// and https:// protocols
  </action>
  <verify>
    - Build succeeds: `cd packages/server && pnpm build`
    - CORS config includes https:// pattern
    - No TypeScript errors
  </verify>
  <done>CORS configuration updated to accept HTTPS origins with subdomain pattern matching, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Commit auth.ts tenant provisioning changes</name>
  <files>packages/server/src/auth.ts (or similar auth file)</files>
  <action>
    1. Check git status to identify uncommitted auth changes
    2. Review auth.ts modifications (tenant auto-provisioning logic)
    3. Verify changes are intentional and complete (not WIP)
    4. Stage and commit with clear message describing tenant provisioning feature
    5. Commit message format: "feat(auth): add tenant auto-provisioning on signup"
  </action>
  <verify>
    - `git status` shows auth.ts committed
    - `git log -1` shows commit with clear message
    - No uncommitted changes to auth files
  </verify>
  <done>auth.ts tenant provisioning changes committed with descriptive message</done>
</task>

<task type="auto">
  <name>Task 3: Clean up and commit test files</name>
  <files>Test-related files (error-context.md deleted, playwright screenshots)</files>
  <action>
    1. Check git status for test cleanup changes (deleted files, untracked screenshots)
    2. Stage deletions: `git add -u` (stages deleted files like error-context.md)
    3. Review untracked files - keep legitimate test artifacts, delete temp files
    4. If playwright screenshots are test artifacts: add to .gitignore if not needed, or commit if documentation
    5. Commit cleanup: "chore(tests): clean up test artifacts and removed files"
  </action>
  <verify>
    - `git status` shows clean working directory OR only expected untracked files
    - .gitignore updated if needed for test artifacts
    - Test cleanup committed
  </verify>
  <done>Test cleanup files committed, working directory clean or has only expected untracked files</done>
</task>

<task type="auto">
  <name>Task 4: Deploy CORS fix to production</name>
  <files>Deployment via Docker on VPS</files>
  <action>
    1. SSH to VPS: `ssh root@31.220.104.244` (or configured user)
    2. Navigate to deployment directory (likely /opt/recording-studio-manager or ~/app)
    3. Pull latest code: `git pull origin main` (or configured branch)
    4. Rebuild server container: `docker-compose build rsm-server`
    5. Restart server: `docker-compose up -d rsm-server`
    6. Verify container running: `docker ps | grep rsm-server`
    7. Check logs for errors: `docker logs rsm-server --tail 50`
  </action>
  <verify>
    - `docker ps` shows rsm-server container running (UP status)
    - `docker logs rsm-server` shows no CORS errors
    - Server started successfully on port 3000
  </verify>
  <done>CORS fix deployed to production, server container running without errors</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>CORS fix deployed - production should now accept HTTPS origins</what-built>
  <how-to-verify>
    1. Open browser in Incognito mode (clear cache)
    2. Visit: https://app.recording-studio-manager.com (or main subdomain)
    3. Open DevTools > Network tab
    4. Try to login or make API request
    5. Check: No CORS errors in console (previously showed "blocked by CORS policy")
    6. Verify: API requests complete successfully (200 status)
    7. Test demo subdomain: https://studio-demo.recording-studio-manager.com
  </how-to-verify>
  <resume-signal>Type "approved" if HTTPS works without CORS errors, or describe the error you see</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CORS configuration accepts https://*.recording-studio-manager.com origins
- [ ] auth.ts changes committed with clear message
- [ ] Test cleanup committed, working directory clean
- [ ] Production deployment successful (server container running)
- [ ] HTTPS requests work without CORS errors (human verified)
</verification>

<success_criteria>

- CORS fix implemented and deployed to production
- All pending changes committed (auth.ts, test cleanup)
- Production accessible via HTTPS without CORS blocking
- No errors in browser console when accessing app via https://
- Ready to proceed with monitoring setup (Plan 01-02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-production-stability/01-01-SUMMARY.md`:

# Phase 1 Plan 1: CORS Fix & Commit Summary

**Production HTTPS unblocked - app now accessible via secure origins**

## Accomplishments

- Fixed CORS configuration to accept https://*.recording-studio-manager.com
- Committed auth.ts tenant auto-provisioning changes
- Cleaned up and committed test artifacts
- Deployed CORS fix to production VPS
- Verified HTTPS access works without CORS errors

## Files Created/Modified

- `packages/server/src/index.ts` (or CORS config file) - Updated origin pattern for HTTPS
- `packages/server/src/auth.ts` - Committed tenant provisioning logic
- Test cleanup files - Committed deletions and .gitignore updates

## Decisions Made

- Kept subdomain pattern matching (not wildcard *) for security
- Allowed both https:// for production and http://localhost:* for development
- Committed all pending changes to establish clean baseline

## Issues Encountered

[Document any issues during execution, or "None"]

## Next Step

Ready for 01-02-PLAN.md (Setup basic monitoring with health checks and Sentry)
</output>
