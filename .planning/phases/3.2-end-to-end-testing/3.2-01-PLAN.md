# Phase 3.2-01: Comprehensive E2E Test Suite

<objective>
Consolidate and organize existing E2E tests (13 files, 37 test cases) into a comprehensive test suite validating critical user journeys before marketing launch (Phase 4).

**Current state:**
- 13 ad-hoc test files scattered in root directory
- Tests cover: signup, auth, projects, chatbot, CORS, multi-tenant
- No organized test structure or execution strategy
- Some tests use localhost, others production URLs

**Target:**
- Clean test organization in `e2e/` directory
- Consolidated test suite covering all critical flows
- Documented test execution strategy
- All tests passing on production environment
</objective>

<execution_context>
@.planning/PROJECT.md - Success criteria: "Tests end-to-end validés (signup → dashboard → booking → payment → project)"
@.planning/STATE.md - Phase 3.2 inserted for E2E testing quality gate before marketing
@.planning/ROADMAP.md - Phase 3.2 goal: validate full user journey with Playwright

**Existing test files (root directory):**
- `test-projects-e2e.spec.ts` - Full projects workflow (signup → create project → add track)
- `test-auth-verification.spec.ts` - Authentication flow with cookie verification
- `test-cors-https.spec.ts` - CORS and HTTPS configuration
- `test-signup-validation.spec.ts` - Signup form validation
- `test-auth-login.spec.ts` - Login flow
- `test-multitenant-subdomain.spec.ts` - Multi-tenant subdomain routing
- `test-production-dashboard.spec.ts` - Dashboard access
- `test-homepage-check.spec.ts` - Homepage loading
- `test-auth-final.spec.ts` - Final auth verification
- `test-debug-register.spec.ts` - Debug registration
- `test-global-search.spec.ts` - Global search feature (13 test cases)
- `packages/client/e2e/chatbot-test.spec.ts` - AI chatbot functionality
- `packages/client/e2e/new-studio-chatbot-test.spec.ts` - New studio chatbot test

**Test execution discovered:**
- Playwright configured (playwright.config.ts exists based on test imports)
- Tests use both localhost:5174 (dev) and production URLs
- Some tests have manual fallback steps documented
</execution_context>

<context>
**From STATE.md:**
- Production operational (Phase 3.1 complete)
- All containers healthy, site accessible
- Authentication working (session cookies configured)
- Database initialized, migrations run

**From PROJECT.md Success Criteria:**
- "Tests end-to-end validés (signup → dashboard → booking → payment → project)"
- Phase 5 (Projects Management) 100% complete
- Stripe billing complete (subscriptions working)
- AI chatbot implemented (37 actions, SSE streaming)

**Critical flows to validate (from ROADMAP.md Phase 3.2 rationale):**
1. Signup → Dashboard
2. Booking flow
3. Payment processing (Stripe)
4. Project creation → Track upload
5. AI chatbot interaction

**Existing test coverage analysis:**
- ✅ Signup: `test-signup-validation.spec.ts`, `test-debug-register.spec.ts`
- ✅ Authentication: `test-auth-verification.spec.ts`, `test-auth-login.spec.ts`, `test-auth-final.spec.ts`
- ✅ Projects: `test-projects-e2e.spec.ts` (comprehensive)
- ✅ AI Chatbot: `chatbot-test.spec.ts`, `new-studio-chatbot-test.spec.ts`
- ✅ Infrastructure: `test-cors-https.spec.ts`, `test-multitenant-subdomain.spec.ts`
- ✅ UI Features: `test-global-search.spec.ts` (13 cases)
- ⚠️ **GAPS:** Booking flow, Payment processing (Stripe checkout), Client portal

**Risk assessment:**
- Tests scattered in root = hard to maintain
- Mix of dev/production URLs = confusion
- No documented test execution order
- Missing critical flows: booking, payments, client portal
</context>

<tasks>

## Task 1: Audit and categorize existing tests
**Objective:** Document current test coverage and identify gaps

**Actions:**
1. Create test inventory document:
   - List all 13 test files with descriptions
   - Categorize by flow: Auth, Projects, Infrastructure, Features
   - Identify duplicate coverage (e.g., 3 auth tests)
   - Document missing critical flows (booking, payment, client portal)

2. Analyze test quality:
   - Check for hardcoded credentials/URLs
   - Identify brittle selectors (e.g., `text=` vs data-testid)
   - Note tests with manual fallback steps
   - List tests using localhost vs production

3. Create test execution report:
   ```bash
   # Run all existing tests on production
   npx playwright test --config=playwright.config.ts
   ```
   - Capture pass/fail status
   - Document any failures with root causes
   - Screenshot evidence for failures

**Output:**
- `.planning/phases/3.2-end-to-end-testing/TEST-INVENTORY.md`
- `.planning/phases/3.2-end-to-end-testing/TEST-EXECUTION-REPORT.md`

**Verify:**
- [ ] All 13 test files catalogued
- [ ] Coverage gaps documented (booking, payments, client portal)
- [ ] Test execution completed with results
- [ ] Failures analyzed with root causes

---

## Task 2: Create missing E2E tests for critical flows
**Objective:** Fill coverage gaps for booking and payment flows

**Missing flows identified:**
1. **Booking flow:** Client portal → Browse available sessions → Book time slot → Confirmation
2. **Payment flow:** Stripe checkout → Subscription purchase → Payment success → Dashboard reflects subscription
3. **Client portal:** Client login → Dashboard → View projects → Listen to tracks

**Actions:**

### 2.1: Create booking E2E test
File: `e2e/booking-flow.spec.ts`

Test: "Complete booking flow - client books session with studio"
- Navigate to client portal
- Login as client (or use magic link)
- Browse available time slots
- Select date/time
- Fill booking form (name, notes)
- Submit booking
- Verify confirmation message
- Verify booking appears in client dashboard
- Verify booking appears in studio dashboard

### 2.2: Create payment E2E test
File: `e2e/payment-stripe.spec.ts`

Test: "Stripe subscription purchase - upgrade from Free to Pro"
- Login as studio owner
- Navigate to Settings → Subscription
- Click "Upgrade to Pro"
- Verify Stripe Checkout Session opens
- Fill test card: 4242 4242 4242 4242
- Submit payment
- Verify redirect to success page
- Verify subscription status updated to "Pro"
- Verify limits increased (sessions/month, storage)

### 2.3: Create client portal E2E test
File: `e2e/client-portal.spec.ts`

Test: "Client portal complete workflow"
- Client signup (email/password)
- Verify email sent (if configured) OR manual login
- Access dashboard
- View assigned projects
- Click project → View tracks
- Play audio (verify AudioPlayer loads)
- Download track
- View activity logs
- Update profile

**Output:**
- `e2e/booking-flow.spec.ts` (1 test)
- `e2e/payment-stripe.spec.ts` (1 test)
- `e2e/client-portal.spec.ts` (1 test)

**Verify:**
- [ ] All 3 new test files created
- [ ] Tests run successfully on production
- [ ] Screenshots captured for each flow
- [ ] No hardcoded credentials (use env vars)

---

## Task 3: Organize and consolidate test suite
**Objective:** Move all E2E tests to organized structure, remove duplicates

**Actions:**

1. **Create organized directory structure:**
   ```
   e2e/
   ├── auth/
   │   ├── signup.spec.ts          (consolidate test-signup-validation, test-debug-register)
   │   ├── login.spec.ts           (consolidate test-auth-login, test-auth-final)
   │   └── session-cookies.spec.ts (from test-auth-verification)
   ├── studio/
   │   ├── projects.spec.ts        (from test-projects-e2e)
   │   ├── dashboard.spec.ts       (from test-production-dashboard)
   │   └── global-search.spec.ts   (from test-global-search)
   ├── client-portal/
   │   ├── booking.spec.ts         (NEW from Task 2)
   │   └── client-dashboard.spec.ts (NEW from Task 2)
   ├── payments/
   │   └── stripe-checkout.spec.ts (NEW from Task 2)
   ├── features/
   │   └── ai-chatbot.spec.ts      (consolidate both chatbot tests)
   └── infrastructure/
       ├── cors-https.spec.ts      (from test-cors-https)
       ├── multitenant.spec.ts     (from test-multitenant-subdomain)
       └── homepage.spec.ts        (from test-homepage-check)
   ```

2. **Consolidation strategy:**
   - Merge duplicate auth tests → single `auth/signup.spec.ts` with multiple test cases
   - Merge 2 chatbot tests → single `features/ai-chatbot.spec.ts`
   - Move all tests from root to `e2e/` subdirectories
   - Update imports if needed

3. **Standardization:**
   - All tests use production URLs (https://recording-studio-manager.com)
   - Use environment variables for test credentials: `PLAYWRIGHT_TEST_EMAIL`, `PLAYWRIGHT_TEST_PASSWORD`
   - Consistent naming: `{feature}-{action}.spec.ts`
   - Add data-testid attributes where needed for stable selectors

4. **Delete old test files:**
   - Remove 13 test files from root directory after migration
   - Update `.gitignore` if needed

**Output:**
- Organized `e2e/` directory with 11 test files (consolidation reduces 13+3 new = 16 → 11 files)
- Updated test configuration pointing to new structure
- Deleted old scattered test files

**Verify:**
- [ ] All tests migrated to `e2e/` directory
- [ ] No duplicate test coverage
- [ ] All tests passing in new locations
- [ ] Old test files removed from root
- [ ] `npx playwright test` runs entire suite successfully

</tasks>

<verification>
After completing all tasks, verify:

1. **Coverage completeness:**
   ```bash
   # Run full test suite
   npx playwright test
   ```
   - All critical flows tested: signup, login, projects, booking, payment, chatbot, client portal
   - No 401 authentication errors
   - No failing tests

2. **Test organization:**
   - All tests in `e2e/` directory
   - No test files in root directory
   - Clear categorization (auth, studio, client-portal, payments, features, infrastructure)

3. **Documentation:**
   - TEST-INVENTORY.md lists all tests with descriptions
   - TEST-EXECUTION-REPORT.md shows latest run results
   - Test gaps identified and addressed

4. **Production validation:**
   - Run tests against https://recording-studio-manager.com
   - Verify no breaking changes
   - Screenshot evidence for all critical flows

**Success criteria:**
- ✅ 100% critical flow coverage (signup → dashboard → booking → payment → project)
- ✅ All tests passing on production
- ✅ Clean test organization in `e2e/` directory
- ✅ No duplicate or scattered test files
- ✅ Ready for Phase 4 (Marketing Foundation) - confident in production quality
</verification>

<success_criteria>
- [ ] TEST-INVENTORY.md created with 16 total tests catalogued (13 existing + 3 new)
- [ ] Coverage gaps filled: booking flow, payment flow, client portal
- [ ] All tests migrated to organized `e2e/` directory structure
- [ ] 13 old test files removed from root
- [ ] Full test suite passing: `npx playwright test` exits 0
- [ ] TEST-EXECUTION-REPORT.md shows 100% pass rate on production
- [ ] No authentication errors (401) in test runs
- [ ] Screenshots captured for all critical flows
- [ ] Ready to proceed to Phase 4 (Marketing Foundation)
</success_criteria>

<output>
**Modified files:**
- `e2e/auth/signup.spec.ts` (NEW - consolidated)
- `e2e/auth/login.spec.ts` (NEW - consolidated)
- `e2e/auth/session-cookies.spec.ts` (MOVED)
- `e2e/studio/projects.spec.ts` (MOVED)
- `e2e/studio/dashboard.spec.ts` (MOVED)
- `e2e/studio/global-search.spec.ts` (MOVED)
- `e2e/client-portal/booking.spec.ts` (NEW)
- `e2e/client-portal/client-dashboard.spec.ts` (NEW)
- `e2e/payments/stripe-checkout.spec.ts` (NEW)
- `e2e/features/ai-chatbot.spec.ts` (NEW - consolidated)
- `e2e/infrastructure/cors-https.spec.ts` (MOVED)
- `e2e/infrastructure/multitenant.spec.ts` (MOVED)
- `e2e/infrastructure/homepage.spec.ts` (MOVED)

**New documentation:**
- `.planning/phases/3.2-end-to-end-testing/TEST-INVENTORY.md`
- `.planning/phases/3.2-end-to-end-testing/TEST-EXECUTION-REPORT.md`

**Deleted files:**
- 13 test files from root directory (scattered tests)

**Commands to run:**
```bash
# Execute full test suite
npx playwright test

# Run specific category
npx playwright test e2e/auth/
npx playwright test e2e/studio/
npx playwright test e2e/client-portal/
npx playwright test e2e/payments/

# Production smoke test (critical flows only)
npx playwright test --grep "@smoke"
```
</output>

---

## Checkpoints

### verify: Task 1 complete
**Check:** TEST-INVENTORY.md and TEST-EXECUTION-REPORT.md exist, all tests catalogued
**Action:** Review inventory, confirm coverage gaps documented (booking, payment, client portal)
**If blocked:** Cannot proceed to Task 2 without understanding current state

### verify: Task 2 complete
**Check:** 3 new test files created (booking, payment, client-portal), all passing
**Action:** Run new tests individually, verify they cover critical flows
**If blocked:** Cannot organize tests without complete coverage

### verify: Task 3 complete
**Check:** All tests in `e2e/` directory, old files deleted, full suite passing
**Action:** Run `npx playwright test` and verify 100% pass rate
**If blocked:** Phase 3.2 incomplete - cannot proceed to Phase 4 without E2E validation

---

## Context for Next Plan

If Phase 3.2 requires multiple plans, this plan focuses on **test organization and critical flow coverage**.

Potential follow-up plans:
- 3.2-02: Performance testing (if needed - load time, API response times)
- 3.2-03: Visual regression testing (if needed - screenshot comparison)
- 3.2-04: Mobile responsive testing (if needed - viewport testing)

However, based on scope estimation:
- This plan covers ~60-70% context (3 tasks, significant test creation/migration)
- Should be executable in single session
- Delivers complete E2E validation for Phase 4 readiness

**Recommendation:** Execute this plan, then assess if additional E2E testing needed or proceed to Phase 4 (Marketing Foundation).
