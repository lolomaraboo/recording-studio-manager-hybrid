# Phase 3.2-02: Fix Backend Registration TRPC Error

<objective>
Debug and resolve the backend registration endpoint TRPC error preventing E2E test user creation and blocking authentication tests.

**Error**: `TRPCClientError: Unable to transform response from server` with 404 response
**Impact**: E2E test user cannot be created ‚Üí Login tests fail ‚Üí All auth-dependent tests fail (test pass rate stuck at 5%)
</objective>

<execution_context>
**Project**: Recording Studio Manager (Multi-tenant SaaS)
**Phase**: 3.2 - End-to-End Testing
**Plan**: 02 of 1 (split from 3.2-01 due to backend blocker discovered)

**Discovery findings from Phase 3.2-01 execution**:
- Frontend registration form validation works (0 errors before submit)
- Network request sent to `/api/trpc/auth.register`
- Server returns 404 (Not Found)
- TRPC client cannot transform the 404 response into expected format
- This is a backend/routing issue, NOT a test infrastructure issue

**Critical files identified**:
@packages/server/src/routers/auth.ts:17-99 (register mutation)
@packages/server/src/routers/index.ts:54-77 (appRouter exports)
@packages/server/src/index.ts:118-124 (tRPC middleware mount)
@packages/client/src/lib/trpc.ts:1-5 (client config)
@packages/client/src/main.tsx:42-55 (trpc client initialization)
@packages/client/src/contexts/AuthContext.tsx:67-84 (register function)
</execution_context>

<context>
## Backend Architecture

**TRPC Setup**:
- Server: `packages/server/src/index.ts` mounts tRPC at `/api/trpc`
- Router: `packages/server/src/routers/index.ts` exports `appRouter` with `auth: authRouter`
- Auth Router: `packages/server/src/routers/auth.ts` defines `register` mutation (lines 17-99)

**Register Mutation Implementation** (auth.ts:17-99):
```typescript
register: publicProcedure
  .input(z.object({
    email: z.string().email(),
    password: z.string().min(8),
    name: z.string().min(1),
    organizationName: z.string().min(1),
  }))
  .mutation(async ({ ctx, input }) => {
    // 1. Check if user exists
    // 2. Hash password with bcrypt
    // 3. Create user in master DB
    // 4. Create organization with slug/subdomain
    // 5. Create tenant database (createTenantDatabase)
    // 6. Set session userId + organizationId
    // 7. Return user + organization objects
  })
```

**Frontend TRPC Call** (AuthContext.tsx:73-78):
```typescript
const result = await registerMutation.mutateAsync({
  email,
  password,
  name,
  organizationName,
});
```

**Expected endpoint**: `POST /api/trpc/auth.register`
**Actual response**: `404 (Not Found)`

## Error Symptoms

**From E2E test console**:
```
Registration error: TRPCClientError: Unable to transform response from server
Failed to load resource: the server responded with a status of 404 (Not Found)
```

**From global setup execution**:
```
üîß Global Setup: Ensuring E2E test user exists...
‚ÑπÔ∏è  E2E test user not found, creating...
‚ö†Ô∏è  Registration may have failed, check screenshots
```

## Root Cause Hypotheses

### Hypothesis 1: TRPC Router Not Exported/Mounted (MOST LIKELY)
**Probability**: 80%

**Evidence**:
- Server starts successfully (no startup errors)
- 404 indicates route not found, not server error
- `appRouter` in `routers/index.ts` correctly includes `auth: authRouter`
- But server might not be serving the complete router

**Possible causes**:
- Build/compilation issue (server serving stale dist/)
- Import path mismatch (`auth.js` vs `auth.ts`)
- TypeScript compilation error not failing the build
- Router not properly re-exported from index

### Hypothesis 2: CORS/Credentials Issue
**Probability**: 15%

**Evidence**:
- CORS configured for production domain (index.ts:55-74)
- Credentials mode enabled (main.tsx:50)
- Session cookie configured with correct domain (index.ts:101-108)

**Why less likely**: Would typically return CORS error, not 404

### Hypothesis 3: TRPC Batch/Link Configuration Mismatch
**Probability**: 5%

**Evidence**:
- Client uses `httpLink` (main.tsx:44-53)
- No batching configured
- Standard tRPC setup

**Why less likely**: Login endpoint likely works (same router), only register fails

## Current Production State

**Docker Compose Services**:
- `rsm-server` running on port 3001
- `rsm-client` running on port 5173 (proxied via Nginx)
- PostgreSQL, Redis operational

**Server build**:
- TypeScript compiled to `packages/server/dist/`
- Entry point: `dist/index.js`
- Served by: `node dist/index.js`

**Nginx proxy**:
- Frontend: `https://recording-studio-manager.com` ‚Üí Client (5173)
- API: `https://recording-studio-manager.com/api/*` ‚Üí Server (3001)
</context>

<tasks>
## Task 1: Verify Server Build and Router Export

**Objective**: Confirm the auth router is properly compiled and exported

**Steps**:

1. **Check server build artifacts**:
   ```bash
   # Verify dist/ contains compiled router
   ls -la packages/server/dist/routers/
   cat packages/server/dist/routers/auth.js | grep "register"
   cat packages/server/dist/routers/index.js | grep "authRouter"
   ```

2. **Check for TypeScript compilation errors**:
   ```bash
   cd packages/server
   pnpm tsc --noEmit
   ```

3. **Verify package.json build script**:
   ```bash
   cat packages/server/package.json | grep "build"
   ```

4. **Check server logs for router registration**:
   ```bash
   docker-compose logs server | grep -i "router\|trpc\|register"
   ```

**Expected Findings**:
- If `dist/routers/auth.js` missing or stale ‚Üí Build issue
- If TypeScript errors ‚Üí Compilation silently failing
- If router not in logs ‚Üí Not being mounted

**Fix if broken**: Rebuild server and restart:
```bash
cd packages/server
pnpm build
docker-compose restart server
```

---

## Task 2: Test Auth Endpoints Directly

**Objective**: Isolate whether issue is TRPC routing or auth logic

**Steps**:

1. **Test register endpoint with curl**:
   ```bash
   curl -X POST https://recording-studio-manager.com/api/trpc/auth.register \
     -H "Content-Type: application/json" \
     -H "Cookie: connect.sid=test" \
     -d '{
       "email": "curl-test@example.com",
       "password": "TestPass123!",
       "name": "Curl Test",
       "organizationName": "Curl Test Studio"
     }' \
     -v
   ```

2. **Expected responses**:
   - If 404: TRPC routing broken
   - If 400: TRPC input validation issue
   - If 200: Registration works (frontend issue)
   - If 500: Backend mutation logic error

3. **Test TRPC batch endpoint** (alternative TRPC format):
   ```bash
   curl -X POST https://recording-studio-manager.com/api/trpc/auth.register?batch=1 \
     -H "Content-Type: application/json" \
     -d '{"0":{"json":{"email":"batch-test@example.com","password":"TestPass123!","name":"Batch Test","organizationName":"Batch Test Studio"}}}' \
     -v
   ```

4. **Compare with working endpoint** (login):
   ```bash
   curl -X POST https://recording-studio-manager.com/api/trpc/auth.login \
     -H "Content-Type: application/json" \
     -d '{
       "email": "test@example.com",
       "password": "password123"
     }' \
     -v
   ```

**Expected Findings**:
- If login returns 404 too ‚Üí Entire auth router not mounted
- If login works, register 404 ‚Üí Specific procedure issue
- If different status code ‚Üí Root cause identified

---

## Task 3: Debug TRPC Request Flow

**Objective**: Add logging to track request through TRPC middleware

**Steps**:

1. **Add debug logging to server index.ts** (before TRPC middleware):
   ```typescript
   // packages/server/src/index.ts (after line 117)

   // Debug logging for TRPC requests
   app.use('/api/trpc', (req, res, next) => {
     console.log('[TRPC Debug] Request:', {
       method: req.method,
       path: req.path,
       url: req.url,
       body: req.body,
     });
     next();
   });

   // Existing tRPC middleware
   app.use('/api/trpc', createExpressMiddleware({
     router: appRouter,
     createContext,
   }));
   ```

2. **Add logging to auth router**:
   ```typescript
   // packages/server/src/routers/auth.ts (line 26, inside mutation)

   .mutation(async ({ ctx, input }) => {
     console.log('[Auth Register] Called with:', {
       email: input.email,
       name: input.name,
       organizationName: input.organizationName,
     });

     // ... existing logic
   })
   ```

3. **Rebuild and restart server**:
   ```bash
   cd packages/server
   pnpm build
   docker-compose restart server
   ```

4. **Trigger registration from E2E test**:
   ```bash
   npx playwright test e2e/auth/login-and-signup.spec.ts:80 --headed
   ```

5. **Monitor server logs in real-time**:
   ```bash
   docker-compose logs -f server
   ```

**Expected Findings**:
- If no `[TRPC Debug]` log ‚Üí Request not reaching server
- If `[TRPC Debug]` but no `[Auth Register]` ‚Üí Routing issue in TRPC
- If both logs appear ‚Üí Issue in mutation logic (not routing)

**Cleanup**: Remove debug logs after root cause identified

---

## Task 4: Verify TRPC Context Creation

**Objective**: Ensure session/context is properly initialized for public procedures

**Steps**:

1. **Read context.ts implementation**:
   ```bash
   cat packages/server/src/_core/context.ts
   ```

2. **Check for session access issues**:
   - Verify `ctx.req.session` exists in publicProcedure
   - Check if Redis session store is operational
   - Confirm session secret is set

3. **Test session creation**:
   ```bash
   # Check Redis for active sessions
   docker-compose exec redis redis-cli KEYS "rsm:session:*"
   ```

4. **If session issue found**:
   - Verify `SESSION_SECRET` env var set
   - Check Redis connection in server logs
   - Test session cookie creation with login endpoint

**Expected Findings**:
- If Redis connection failed ‚Üí Session store broken
- If session not created ‚Üí Cookie/CORS issue
- If context creation throws ‚Üí Error should appear in logs

---

## Task 5: Fix Root Cause and Verify

**Objective**: Apply fix based on findings from Tasks 1-4

**Likely Fix Scenarios**:

### Scenario A: Stale Build
```bash
cd packages/server
rm -rf dist/
pnpm build
docker-compose restart server
```

### Scenario B: Import Path Issue
```typescript
// packages/server/src/routers/index.ts
// Change:
import { authRouter } from './auth.js';  // ‚Üê Add .js extension if missing
```

### Scenario C: Router Not Exported
```typescript
// packages/server/src/index.ts
// Verify:
import { appRouter } from './routers/index.js';  // ‚Üê Check path
```

### Scenario D: TRPC Adapter Configuration
```typescript
// packages/server/src/index.ts:118-124
app.use('/api/trpc', createExpressMiddleware({
  router: appRouter,
  createContext,
  // Add if missing:
  onError: ({ error, type, path }) => {
    console.error('[TRPC Error]', { type, path, error: error.message });
  },
}));
```

**Verification Steps After Fix**:

1. **Test registration with curl** (from Task 2):
   ```bash
   curl -X POST https://recording-studio-manager.com/api/trpc/auth.register \
     -H "Content-Type: application/json" \
     -d '{
       "email": "verify-fix@example.com",
       "password": "TestPass123!",
       "name": "Verify Fix",
       "organizationName": "Verify Fix Studio"
     }'
   ```
   Expected: 200 OK with user + organization JSON

2. **Run E2E global setup**:
   ```bash
   npx playwright test --config=playwright.config.ts
   ```
   Expected: "‚úÖ E2E test user created successfully"

3. **Run auth tests**:
   ```bash
   npx playwright test e2e/auth/login-and-signup.spec.ts
   ```
   Expected: 7/7 passing

4. **Check test user in database**:
   ```bash
   docker-compose exec postgres psql -U postgres -d rsm_master \
     -c "SELECT id, email, name FROM users WHERE email = 'e2e-test-user@example.com';"
   ```
   Expected: 1 row returned

---

## Task 6: Update ISSUES.md and Re-run Full Test Suite

**Objective**: Document resolution and verify all tests pass

**Steps**:

1. **Update .planning/ISSUES.md**:
   ```markdown
   ### ISSUE-010 (P1): E2E Tests Auth Failures
   **Status:** ‚úÖ RESOLVED (2025-12-26)

   **Root Cause:** [Discovered cause from Tasks 1-5]

   **Resolution:** [Applied fix from Task 5]

   **Verification:**
   - E2E test user created successfully
   - Auth tests: 7/7 passing
   - Global setup: ‚úÖ working
   ```

2. **Run full E2E test suite**:
   ```bash
   npx playwright test
   ```

3. **Analyze results**:
   - Expected: 65+/79 passing (80%+)
   - Auth tests: 7/7 passing (100%)
   - Feature tests (AI, Command Palette, Search): Should pass now

4. **Screenshot any remaining failures**:
   ```bash
   # Failures automatically saved to test-results/
   ls -la test-results/
   ```

5. **Update STATE.md**:
   ```markdown
   **Phase 3.2 - Plan 02:**
   - Status: ‚úÖ Complete
   - Backend registration error resolved
   - E2E test infrastructure operational
   - Test pass rate: [actual %]
   ```
</tasks>

<verification>
## Success Criteria

**Phase 3.2-02 is complete when ALL of these are true**:

1. ‚úÖ Backend registration endpoint responds 200 OK (not 404)
2. ‚úÖ E2E test user `e2e-test-user@example.com` can be created via global setup
3. ‚úÖ Auth tests: 7/7 passing (100%)
4. ‚úÖ Test pass rate improves from 5% to >80% (65+/79 tests)
5. ‚úÖ Root cause documented in ISSUES.md
6. ‚úÖ Fix verified with curl + Playwright tests
7. ‚úÖ No console errors during registration flow

## Verification Commands

**Quick verification**:
```bash
# 1. Test registration endpoint
curl -X POST https://recording-studio-manager.com/api/trpc/auth.register \
  -H "Content-Type: application/json" \
  -d '{"email":"verify@example.com","password":"Test123!","name":"Test","organizationName":"Test Studio"}' \
  | jq

# 2. Run auth tests
npx playwright test e2e/auth/login-and-signup.spec.ts --reporter=list

# 3. Check global setup
npx playwright test --grep "Can login with valid credentials"
```

**Expected output**:
1. Curl: JSON with `user` and `organization` objects
2. Playwright: "7 passed"
3. Global setup: "‚úÖ E2E test user already exists" or "‚úÖ E2E test user created successfully"
</verification>

<success_criteria>
- Backend registration TRPC endpoint functional (200 OK, not 404)
- E2E test user can be created automatically via global setup
- Auth tests: 7/7 passing
- Overall test pass rate: >80% (65+/79)
- Root cause identified and documented
- Fix verified and tested in production
</success_criteria>

<output>
## Deliverables

1. **Fixed Backend**: Registration endpoint returns proper TRPC response
2. **Test User Created**: `e2e-test-user@example.com` exists in production DB
3. **Passing Tests**: Auth tests 7/7, overall 65+/79
4. **Documentation**: ISSUES.md updated with root cause + resolution
5. **Clean Logs**: No TRPC transformation errors in console

## Files Modified

**Server** (expected):
- `packages/server/src/index.ts` - Debug logging or router fix
- `packages/server/src/routers/auth.ts` - Debug logging (cleanup after)
- `packages/server/src/routers/index.ts` - Import path fix (if needed)

**Documentation**:
- `.planning/ISSUES.md` - ISSUE-010 resolution
- `.planning/STATE.md` - Phase 3.2-02 completion

## Next Steps After This Plan

Once Phase 3.2-02 is complete:
1. Return to Phase 3.2-01 to execute full E2E test suite (400+ tests)
2. Or if test pass rate >80%, mark Phase 3.2 complete
3. Proceed to Phase 4.1 - Marketing Foundation (Landing Page)
</output>
