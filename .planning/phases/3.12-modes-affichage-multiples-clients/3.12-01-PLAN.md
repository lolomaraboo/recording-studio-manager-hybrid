# Phase 3.12-01: Multiple Display Modes for Clients Page

**Date:** 2025-12-31
**Phase:** 3.12 - Modes d'affichage multiples clients
**Plan:** 01 (Implementation)
**Estimated Context:** ~40-50%

---

## Objective

Add 3 viewing modes to /clients page: **Table** (current), **Grid** (cards), and **Kanban/Details** (expanded cards with maximum information). Users can toggle between modes, with selection persisted in localStorage.

**User Requirements:**
- 3 modes: Table (existing dense view), Grid (cards with avatar + key info), Kanban (detailed cards with max info)
- Persist mode selection in localStorage
- Grid mode displays: avatar with initials, name, artist name, VIP badge, email, phone, sessions count, revenue
- Kanban mode displays: everything from Grid + additional details (notes, projects, last activity, etc.)
- No drag & drop required
- Maintain existing search functionality across all modes

---

## Execution Context

@packages/client/src/pages/Clients.tsx
@packages/client/src/components/ui/card.tsx
@packages/client/src/components/ui/badge.tsx
@packages/client/src/components/ui/button.tsx
@packages/client/src/lib/trpc.ts

**Tech Stack:**
- React 19.1, TypeScript, Vite, TailwindCSS 4
- shadcn/ui components (Card, Badge, Button, Table)
- tRPC for data fetching
- lucide-react for icons
- date-fns with French locale

---

## Context

**Current Implementation:**
- Clients.tsx (249 lines) displays clients in Table view only
- Already calculates: sessionsCount, revenue, lastSessionAt
- VIP badge logic: revenue > 1,000,000 cents (10,000€)
- Search filters by: name, email, artistName
- Data fetched via tRPC: clients.list, sessions.list, invoices.list

**Key Data Available:**
- Client: id, name, artistName, email, phone, type (company/individual)
- Computed: sessionsCount, revenue, lastSessionAt
- Existing VIP indicator logic

**Design Decisions:**
- Table mode = dense, many clients visible
- Grid mode = medium density, cards with key info
- Kanban/Details mode = low density, maximum information per client
- Mode persisted in localStorage key: `clientsViewMode`

---

## Tasks

### Task 1: Add View Mode Toggle & State Management (AUTO)

**Objective:** Add mode selection UI and localStorage persistence.

**Actions:**
1. Add state at top of Clients component:
   ```typescript
   type ViewMode = "table" | "grid" | "kanban";
   const [viewMode, setViewMode] = useState<ViewMode>(() => {
     const saved = localStorage.getItem("clientsViewMode");
     return (saved as ViewMode) || "table";
   });
   ```

2. Add localStorage sync:
   ```typescript
   useEffect(() => {
     localStorage.setItem("clientsViewMode", viewMode);
   }, [viewMode]);
   ```

3. Add toggle buttons in header (after search input, before "Exporter" button):
   ```typescript
   <div className="flex gap-2 ml-4">
     <Button
       variant={viewMode === "table" ? "default" : "outline"}
       size="sm"
       onClick={() => setViewMode("table")}
     >
       <List className="mr-2 h-4 w-4" />
       Tableau
     </Button>
     <Button
       variant={viewMode === "grid" ? "default" : "outline"}
       size="sm"
       onClick={() => setViewMode("grid")}
     >
       <LayoutGrid className="mr-2 h-4 w-4" />
       Grille
     </Button>
     <Button
       variant={viewMode === "kanban" ? "default" : "outline"}
       size="sm"
       onClick={() => setViewMode("kanban")}
     >
       <Kanban className="mr-2 h-4 w-4" />
       Détails
     </Button>
   </div>
   ```

4. Import icons from lucide-react: `List, LayoutGrid, Kanban`

**Verification:**
- Toggle buttons appear in header
- Clicking changes active button style
- Mode persists on page reload
- localStorage shows correct value

---

### Task 2: Implement Grid View Component (AUTO)

**Objective:** Create Grid mode with cards showing avatar, name, contact, metrics.

**Actions:**
1. Create Grid view component inside Clients.tsx (after existing Table):
   ```typescript
   function GridView({ clients }: { clients: typeof filteredClients }) {
     return (
       <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
         {clients.map((client) => {
           const initials = client.name
             .split(" ")
             .map((n) => n[0])
             .join("")
             .toUpperCase()
             .slice(0, 2);
           const isVIP = client.revenue > 1_000_000; // 10,000€

           return (
             <Card key={client.id} className="hover:shadow-md transition-shadow">
               <CardHeader className="pb-3">
                 <div className="flex items-center gap-3">
                   {/* Avatar */}
                   <div className="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary font-semibold">
                     {initials}
                   </div>
                   <div className="flex-1 min-w-0">
                     {/* Name + VIP */}
                     <div className="flex items-center gap-2">
                       <CardTitle className="text-base truncate">
                         {client.name}
                       </CardTitle>
                       {isVIP && <Star className="h-4 w-4 text-amber-500 fill-amber-500" />}
                     </div>
                     {/* Artist Name */}
                     {client.artistName && (
                       <CardDescription className="text-sm truncate">
                         {client.artistName}
                       </CardDescription>
                     )}
                   </div>
                 </div>
               </CardHeader>
               <CardContent>
                 {/* Contact */}
                 <div className="space-y-2 text-sm mb-4">
                   {client.email && (
                     <div className="flex items-center gap-2 text-muted-foreground">
                       <Mail className="h-3.5 w-3.5 flex-shrink-0" />
                       <span className="truncate">{client.email}</span>
                     </div>
                   )}
                   {client.phone && (
                     <div className="flex items-center gap-2 text-muted-foreground">
                       <Phone className="h-3.5 w-3.5 flex-shrink-0" />
                       <span>{client.phone}</span>
                     </div>
                   )}
                 </div>

                 {/* Metrics */}
                 <div className="flex justify-between text-sm border-t pt-3">
                   <div>
                     <div className="text-muted-foreground">Sessions</div>
                     <div className="font-semibold">{client.sessionsCount}</div>
                   </div>
                   <div className="text-right">
                     <div className="text-muted-foreground">CA</div>
                     <div className="font-semibold">
                       {(client.revenue / 100).toFixed(2)}€
                     </div>
                   </div>
                 </div>

                 {/* View Details Button */}
                 <Link to={`/clients/${client.id}`} className="mt-3">
                   <Button variant="outline" size="sm" className="w-full">
                     <Eye className="mr-2 h-4 w-4" />
                     Voir détails
                   </Button>
                 </Link>
               </CardContent>
             </Card>
           );
         })}
       </div>
     );
   }
   ```

2. Conditionally render Grid view in return statement:
   ```typescript
   {viewMode === "grid" && <GridView clients={filteredClients} />}
   {viewMode === "table" && (
     <Table>
       {/* existing table code */}
     </Table>
   )}
   ```

**Verification:**
- Grid shows 4 columns on xl screens, 3 on lg, 2 on md, 1 on mobile
- Cards display: avatar with initials, name, artist name, VIP star, email, phone, sessions, revenue
- "Voir détails" button navigates to client detail page
- Search filters grid results
- Loading state works (show skeleton cards)

---

### Task 3: Implement Kanban/Details View Component (AUTO)

**Objective:** Create Kanban/Details mode with expanded cards showing maximum information.

**Actions:**
1. First, add client notes and projects to the data fetching (at top of Clients component):
   ```typescript
   const { data: clientNotes } = trpc.clients.getNotes?.useQuery() || { data: [] };
   const { data: projects } = trpc.projects.list?.useQuery({ limit: 100 }) || { data: [] };
   ```

2. Enhance `clientsWithStats` memo to include additional data:
   ```typescript
   const clientsWithStats = useMemo(() => {
     return (
       clients?.map((client) => {
         const clientSessions = sessions?.filter((s) => s.clientId === client.id) || [];
         const clientInvoices = invoices?.filter((inv) => inv.clientId === client.id) || [];
         const clientProjects = projects?.filter((p) => p.clientId === client.id) || [];
         const recentNotes = clientNotes
           ?.filter((n) => n.clientId === client.id)
           .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
           .slice(0, 3) || [];

         const revenue = clientInvoices.reduce((sum, inv) => sum + parseFloat(inv.total || "0"), 0);
         const sortedSessions = clientSessions.sort(
           (a, b) => new Date(b.startTime).getTime() - new Date(a.startTime).getTime()
         );
         const lastSession = sortedSessions[0];

         return {
           ...client,
           sessionsCount: clientSessions.length,
           revenue: revenue * 100,
           lastSessionAt: lastSession?.startTime || null,
           projectsCount: clientProjects.length,
           recentNotes,
         };
       }) || []
     );
   }, [clients, sessions, invoices, projects, clientNotes]);
   ```

3. Create KanbanView component inside Clients.tsx:
   ```typescript
   function KanbanView({ clients }: { clients: typeof filteredClients }) {
     return (
       <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
         {clients.map((client) => {
           const initials = client.name
             .split(" ")
             .map((n) => n[0])
             .join("")
             .toUpperCase()
             .slice(0, 2);
           const isVIP = client.revenue > 1_000_000;

           return (
             <Card key={client.id} className="hover:shadow-lg transition-shadow">
               <CardHeader>
                 <div className="flex items-start gap-4">
                   {/* Large Avatar */}
                   <div className="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xl flex-shrink-0">
                     {initials}
                   </div>
                   <div className="flex-1 min-w-0">
                     {/* Name + VIP + Type Badge */}
                     <div className="flex items-center gap-2 mb-1">
                       <CardTitle className="text-lg">{client.name}</CardTitle>
                       {isVIP && <Star className="h-5 w-5 text-amber-500 fill-amber-500" />}
                     </div>
                     {client.artistName && (
                       <CardDescription className="text-base mb-2">
                         {client.artistName}
                       </CardDescription>
                     )}
                     <Badge variant={client.type === "company" ? "default" : "secondary"}>
                       {client.type === "company" ? "Entreprise" : "Particulier"}
                     </Badge>
                   </div>
                 </div>
               </CardHeader>
               <CardContent>
                 {/* Contact Section */}
                 <div className="mb-4 space-y-2">
                   <h4 className="font-semibold text-sm text-muted-foreground">Contact</h4>
                   {client.email && (
                     <div className="flex items-center gap-2">
                       <Mail className="h-4 w-4 text-muted-foreground flex-shrink-0" />
                       <span className="text-sm">{client.email}</span>
                     </div>
                   )}
                   {client.phone && (
                     <div className="flex items-center gap-2">
                       <Phone className="h-4 w-4 text-muted-foreground flex-shrink-0" />
                       <span className="text-sm">{client.phone}</span>
                     </div>
                   )}
                 </div>

                 {/* Metrics Grid */}
                 <div className="grid grid-cols-3 gap-4 mb-4 p-3 bg-muted/50 rounded-lg">
                   <div>
                     <div className="text-xs text-muted-foreground mb-1">Sessions</div>
                     <div className="text-lg font-semibold">{client.sessionsCount}</div>
                   </div>
                   <div>
                     <div className="text-xs text-muted-foreground mb-1">Projets</div>
                     <div className="text-lg font-semibold">{client.projectsCount || 0}</div>
                   </div>
                   <div>
                     <div className="text-xs text-muted-foreground mb-1">CA Total</div>
                     <div className="text-lg font-semibold">
                       {(client.revenue / 100).toFixed(0)}€
                     </div>
                   </div>
                 </div>

                 {/* Last Session */}
                 {client.lastSessionAt && (
                   <div className="mb-4">
                     <h4 className="font-semibold text-sm text-muted-foreground mb-1">
                       Dernière session
                     </h4>
                     <div className="text-sm">
                       {format(new Date(client.lastSessionAt), "PPP", { locale: fr })}
                     </div>
                   </div>
                 )}

                 {/* Recent Notes */}
                 {client.recentNotes && client.recentNotes.length > 0 && (
                   <div className="mb-4">
                     <h4 className="font-semibold text-sm text-muted-foreground mb-2">
                       Notes récentes ({client.recentNotes.length})
                     </h4>
                     <div className="space-y-1.5">
                       {client.recentNotes.map((note, idx) => (
                         <div
                           key={idx}
                           className="text-xs text-muted-foreground bg-muted/30 p-2 rounded"
                         >
                           {note.note.slice(0, 80)}
                           {note.note.length > 80 && "..."}
                         </div>
                       ))}
                     </div>
                   </div>
                 )}

                 {/* View Details Button */}
                 <Link to={`/clients/${client.id}`}>
                   <Button variant="default" size="sm" className="w-full">
                     <Eye className="mr-2 h-4 w-4" />
                     Voir tous les détails
                   </Button>
                 </Link>
               </CardContent>
             </Card>
           );
         })}
       </div>
     );
   }
   ```

4. Conditionally render Kanban view in return statement:
   ```typescript
   {viewMode === "kanban" && <KanbanView clients={filteredClients} />}
   ```

**Verification:**
- Kanban shows 2 columns on lg+ screens, 1 on mobile
- Cards display: large avatar, name, artist name, VIP star, type badge, email, phone, 3 metrics (sessions/projects/revenue), last session date, recent notes preview
- Notes preview shows max 3 most recent notes, truncated to 80 chars
- "Voir tous les détails" button navigates to client detail page
- Search filters kanban results
- Loading state works (show skeleton cards)

---

### Task 4: Handle Edge Cases & Polish (AUTO)

**Objective:** Add loading states, empty states, and responsive design polish.

**Actions:**
1. Add loading skeletons for Grid mode:
   ```typescript
   {clientsLoading && viewMode === "grid" && (
     <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
       {[...Array(8)].map((_, i) => (
         <Card key={i}>
           <CardHeader>
             <Skeleton className="h-12 w-12 rounded-full" />
             <Skeleton className="h-4 w-32" />
           </CardHeader>
           <CardContent>
             <Skeleton className="h-20 w-full" />
           </CardContent>
         </Card>
       ))}
     </div>
   )}
   ```

2. Add loading skeletons for Kanban mode:
   ```typescript
   {clientsLoading && viewMode === "kanban" && (
     <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
       {[...Array(4)].map((_, i) => (
         <Card key={i}>
           <CardHeader>
             <Skeleton className="h-16 w-16 rounded-full" />
             <Skeleton className="h-6 w-48" />
           </CardHeader>
           <CardContent>
             <Skeleton className="h-40 w-full" />
           </CardContent>
         </Card>
       ))}
     </div>
   )}
   ```

3. Add empty state for all modes (after search, 0 results):
   ```typescript
   {!clientsLoading && filteredClients.length === 0 && (
     <div className="text-center py-12">
       <Users className="mx-auto h-12 w-12 text-muted-foreground mb-4" />
       <h3 className="text-lg font-semibold mb-2">
         {searchQuery ? "Aucun client trouvé" : "Aucun client"}
       </h3>
       <p className="text-muted-foreground mb-4">
         {searchQuery
           ? "Essayez de modifier votre recherche"
           : "Commencez par ajouter votre premier client"}
       </p>
       {!searchQuery && (
         <Link to="/clients/new">
           <Button>
             <Plus className="mr-2 h-4 w-4" />
             Nouveau client
           </Button>
         </Link>
       )}
     </div>
   )}
   ```

4. Ensure header buttons wrap properly on mobile:
   ```typescript
   <div className="flex flex-wrap gap-2 items-center">
     {/* Search input */}
     <div className="relative flex-1 min-w-[200px]">
       {/* ... existing search ... */}
     </div>

     {/* View mode toggles */}
     <div className="flex gap-1">
       {/* 3 toggle buttons */}
     </div>

     {/* Export & New buttons */}
     <Button variant="outline" size="sm">
       <FileDown className="mr-2 h-4 w-4" />
       Exporter
     </Button>
     <Link to="/clients/new">
       <Button size="sm">
         <Plus className="mr-2 h-4 w-4" />
         Nouveau
       </Button>
     </Link>
   </div>
   ```

**Verification:**
- Loading skeletons appear for Grid and Kanban modes
- Empty state shows when no clients match search
- "Nouveau client" button appears in empty state when not searching
- Header buttons wrap properly on mobile screens
- All modes work smoothly on mobile, tablet, desktop

---

## Verification

**Manual Testing:**

1. **Mode Toggle:**
   - ✅ Click "Tableau" → shows existing table view
   - ✅ Click "Grille" → shows grid of cards
   - ✅ Click "Détails" → shows kanban/details view
   - ✅ Reload page → mode persists

2. **Grid Mode:**
   - ✅ Cards show: avatar with initials, name, artist name (if exists), VIP star (if revenue > 10k€), email, phone, sessions count, revenue
   - ✅ "Voir détails" button navigates to client detail page
   - ✅ Search filters grid results
   - ✅ Responsive layout (4/3/2/1 columns)

3. **Kanban/Details Mode:**
   - ✅ Cards show: large avatar, name, artist name, type badge, contact info, 3 metrics, last session date, recent notes preview
   - ✅ Notes preview shows max 3 notes, truncated to 80 chars
   - ✅ "Voir tous les détails" button navigates
   - ✅ Search filters kanban results
   - ✅ Responsive layout (2/1 columns)

4. **Edge Cases:**
   - ✅ Loading state shows skeletons for all modes
   - ✅ Empty state appears when no clients
   - ✅ Empty state appears when search has no results
   - ✅ Header buttons wrap properly on mobile

**checkpoint:human-verify**

Ask user to verify:
- All 3 modes display correctly
- Mode selection persists on reload
- Search works across all modes
- Responsive design works on mobile
- Loading states appear correctly

---

## Success Criteria

- [ ] 3 view modes implemented: Table, Grid, Kanban/Details
- [ ] Mode selection persisted in localStorage
- [ ] Grid mode displays: avatar, name, contact, metrics
- [ ] Kanban mode displays: all Grid info + projects count, last session, recent notes
- [ ] Search functionality works across all modes
- [ ] Loading states with skeleton cards
- [ ] Empty states handled
- [ ] Responsive design (mobile, tablet, desktop)
- [ ] All modes navigate to client detail page via buttons
- [ ] User confirms all modes work correctly

---

## Output

**Files Modified:**
- `packages/client/src/pages/Clients.tsx` - Added GridView, KanbanView, mode toggle, localStorage persistence

**New Components:**
- GridView (inline component)
- KanbanView (inline component)

**User Experience:**
- Users can now switch between 3 viewing modes
- Grid mode shows clients as cards with key information
- Kanban/Details mode shows comprehensive client information
- Mode selection persists across page reloads
- Search works seamlessly across all modes
