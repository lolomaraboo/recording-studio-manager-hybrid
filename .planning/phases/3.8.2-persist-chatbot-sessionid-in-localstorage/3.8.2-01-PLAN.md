---
phase: 3.8.2-persist-chatbot-sessionid-in-localstorage
plan: 01
type: execute
---

<objective>
Add localStorage persistence for chatbot sessionId to maintain conversation history across page refreshes.

Purpose: Improve UX by preserving chatbot conversations when users accidentally refresh the page or navigate away and return.
Output: Working chatbot that maintains conversation context across browser sessions, validated in production.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3.8.1-fix-chatbot-sessionid-persistence-bug/3.8.1-01-SUMMARY.md

**User request context:**
User reported: "Quand je rafraîchis la page, je perds la conversation avec Le Chatbot"

**Current behavior (Phase 3.8.1 fixed):**
- SessionId persists **between messages** in same browser session (React state)
- SessionId is **lost on page refresh** (component unmount clears state)
- Users lose entire conversation context when refreshing page

**Desired behavior (Option 1 - localStorage):**
- SessionId persists across page refreshes using localStorage
- Users can continue conversations after refresh
- Optional: Add button to start new conversation (clears localStorage)

**Prior decisions affecting this phase:**
- Phase 3.8.1 established sessionId state management pattern in AIAssistant.tsx
- SessionId sent to backend in every request, stored from responses
- Current implementation uses `useState<string | null>(null)` for sessionId

**Files to modify:**
@packages/client/src/components/AIAssistant.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add localStorage persistence for sessionId</name>
  <files>packages/client/src/components/AIAssistant.tsx</files>
  <action>
    Add localStorage integration to AIAssistant component:

    1. **On component mount** - Load sessionId from localStorage (after existing state declarations, around line 35):
       ```typescript
       // Load sessionId from localStorage on component mount
       useEffect(() => {
         const savedSessionId = localStorage.getItem('chatbot_sessionId');
         if (savedSessionId) {
           setSessionId(savedSessionId);
         }
       }, []);
       ```

    2. **When storing sessionId** - Also save to localStorage (modify existing code around line 168-170):
       ```typescript
       // Store sessionId from response for subsequent messages
       if (response.sessionId) {
         setSessionId(response.sessionId);
         localStorage.setItem('chatbot_sessionId', response.sessionId); // ✅ Add this line
       }
       ```

    3. **Optional: Add clear function** - Add function to start new conversation (after existing functions, around line 220):
       ```typescript
       // Clear conversation and start fresh
       const startNewConversation = () => {
         setSessionId(null);
         localStorage.removeItem('chatbot_sessionId');
         setMessages([]);
       };
       ```

    **What NOT to do:**
    - Don't add "New Conversation" button to UI yet (keep UI changes minimal for now)
    - Don't modify messages persistence (only sessionId needs localStorage)
    - Don't change existing sessionId state management logic from Phase 3.8.1

    **Important notes:**
    - Use `localStorage.getItem` (returns null if not found - safe)
    - Use `localStorage.setItem` (overwrites existing value)
    - Use `localStorage.removeItem` (safe even if key doesn't exist)
    - The empty dependency array `[]` ensures useEffect runs only once on mount
  </action>
  <verify>
    - TypeScript compilation succeeds: `pnpm --filter @rsm/client build`
    - No ESLint errors introduced
    - Code diff shows exactly 3 changes: useEffect mount, localStorage.setItem, startNewConversation function
  </verify>
  <done>
    - useEffect added to load sessionId from localStorage on mount
    - localStorage.setItem added when storing sessionId from response
    - startNewConversation function added (ready for future UI integration)
    - Build succeeds without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy fix to production</name>
  <files>packages/client/src/components/AIAssistant.tsx</files>
  <action>
    Deploy the localStorage fix to production using Docker rebuild workflow (discovered in Phase 3.8.1):

    1. **Transfer source file to VPS**:
       ```bash
       rsync -avz \
         packages/client/src/components/AIAssistant.tsx \
         vps-n8n:/root/recording-studio-manager-hybrid/packages/client/src/components/
       ```

    2. **Rebuild client Docker image** (client builds from source, not pre-built dist/):
       ```bash
       ssh vps-n8n "cd /root/recording-studio-manager-hybrid && docker-compose build client --no-cache"
       ```

    3. **Restart client container**:
       ```bash
       ssh vps-n8n "cd /root/recording-studio-manager-hybrid && docker-compose up -d client"
       ```

    4. **Verify deployment**:
       ```bash
       curl -I https://recording-studio-manager.com
       ```
       Expected: HTTP 200, no errors

    **Deployment pattern from Phase 3.8.1:**
    Client container builds from source (not pre-built dist/), so must rsync source file, rebuild Docker image, and restart container.

    **What NOT to do:**
    - Don't try to rsync dist/ folder (won't work - files baked into Docker image)
    - Don't skip --no-cache flag (ensures fresh build with latest code)
    - Don't forget to restart container after rebuild
  </action>
  <verify>
    - Rsync transfer completes without errors
    - Docker build succeeds (shows "Successfully built" message)
    - Container restart succeeds (docker ps shows rsm-client running)
    - curl returns HTTP 200
    - No browser console errors on page load
  </verify>
  <done>
    - AIAssistant.tsx transferred to VPS
    - Client Docker image rebuilt with localStorage fix
    - Container restarted successfully
    - Production site accessible at https://recording-studio-manager.com
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Chatbot sessionId localStorage persistence deployed to production</what-built>
  <how-to-verify>
    Test the localStorage persistence with a conversation flow:

    1. **Navigate to production dashboard**:
       - Visit: https://recording-studio-manager.com/dashboard
       - Log in if needed (test-validation-1766731401390@recording-studio-manager.com)

    2. **Open AI chatbot** (floating window on right side)

    3. **Start conversation - Turn 1**:
       - Send message: "Create a client named Alice Smith with email alice@example.com"
       - Expected: Chatbot confirms client created successfully
       - Note: This creates a sessionId in localStorage

    4. **Continue conversation - Turn 2**:
       - Send message: "What was the name I just mentioned?"
       - Expected: ✅ Chatbot responds "Alice Smith" (memory works within session)

    5. **TEST PAGE REFRESH** (CRITICAL - this is the bug we're fixing):
       - Refresh the page (Cmd+R or F5)
       - Wait for page to reload
       - Open AI chatbot again

    6. **Verify conversation restored - Turn 3**:
       - Send message: "What was the first client name I mentioned?"
       - Expected: ✅ Chatbot responds "Alice Smith" or references the previous conversation
       - FAILURE if: ❌ Chatbot says "You didn't mention any name" or acts like new session

    7. **Verify in browser DevTools** (optional but recommended):
       - Open DevTools > Application > Local Storage > https://recording-studio-manager.com
       - Check for key: `chatbot_sessionId`
       - Confirm value matches the sessionId from network requests

    8. **Verify sessionId consistency**:
       - Open DevTools > Network tab
       - Send another message
       - Check POST request to `/api/trpc/ai.chat`
       - Confirm request payload contains same sessionId as localStorage

    **Success criteria:**
    - Turn 3 (after refresh) demonstrates memory of Turn 1 conversation
    - Chatbot correctly recalls "Alice Smith" even after page refresh
    - localStorage contains chatbot_sessionId key
    - SessionId matches between localStorage and network requests
    - No "You didn't mention..." amnesia response after refresh
  </how-to-verify>
  <resume-signal>Type "approved" if chatbot remembers conversation after refresh, or describe the persistence failure if it still loses context</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] AIAssistant.tsx modified with localStorage integration
- [ ] Client builds without TypeScript errors
- [ ] Deployed to production successfully
- [ ] Page refresh preserves chatbot conversation (3-turn test passes)
- [ ] localStorage contains chatbot_sessionId
- [ ] No browser console errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Chatbot conversation persists across page refreshes in production
- Phase 3.8.2 complete - ready to mark Phase 3.8 fully complete
- No errors or regressions introduced
</success_criteria>

<output>
After completion, create `.planning/phases/3.8.2-persist-chatbot-sessionid-in-localstorage/3.8.2-01-SUMMARY.md`:

# Phase 3.8.2 Plan 1: Persist Chatbot SessionId in LocalStorage Summary

**Chatbot conversations now survive page refreshes - localStorage persistence added**

## Accomplishments

- Added localStorage integration to AIAssistant.tsx
- SessionId loaded from localStorage on component mount
- SessionId saved to localStorage when received from backend
- Deployed fix to production
- Validated conversation persistence across page refreshes

## Files Modified

- `packages/client/src/components/AIAssistant.tsx` - Added localStorage persistence (3 additions)

## LocalStorage Implementation Details

**Changes made:**
```typescript
// 1. Load sessionId on mount
useEffect(() => {
  const savedSessionId = localStorage.getItem('chatbot_sessionId');
  if (savedSessionId) {
    setSessionId(savedSessionId);
  }
}, []);

// 2. Save sessionId when received
if (response.sessionId) {
  setSessionId(response.sessionId);
  localStorage.setItem('chatbot_sessionId', response.sessionId); // ✅ Added
}

// 3. Optional: Clear function for future use
const startNewConversation = () => {
  setSessionId(null);
  localStorage.removeItem('chatbot_sessionId');
  setMessages([]);
};
```

## Production Validation

- Turn 1: "Create client Alice Smith" → ✅ Client created (sessionId saved to localStorage)
- Turn 2: "What was the name I just mentioned?" → ✅ "Alice Smith" (memory works in session)
- **Page refresh performed**
- Turn 3: "What was the first client name?" → ✅ "Alice Smith" (localStorage persistence works!)
- DevTools verification: chatbot_sessionId present in localStorage
- Network analysis: sessionId consistent across requests
- No browser console errors

## Deployment Process

Followed Phase 3.8.1 Docker rebuild workflow:
1. Transfer source: `rsync AIAssistant.tsx vps-n8n:/root/.../packages/client/src/components/`
2. Rebuild image: `docker-compose build client --no-cache`
3. Restart container: `docker-compose up -d client`
4. Verify: `curl -I https://recording-studio-manager.com` → HTTP 200

## Issues Encountered

[None OR describe any deployment/testing issues]

## Next Step

Phase 3.8.2 complete - chatbot now persists across page refreshes.

**Phase 3.8 fully complete** - All chatbot memory validation passed:
- Phase 3.8: 10-turn conversation memory test ✅
- Phase 3.8.1: SessionId state management fix ✅
- Phase 3.8.2: LocalStorage persistence ✅

Ready to proceed to **Phase 4 (Marketing Foundation)** - chatbot is production-ready for marketing launch.
</output>
