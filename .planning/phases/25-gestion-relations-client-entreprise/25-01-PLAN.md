---
phase: 25-gestion-relations-client-entreprise
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/routers/clients.ts
  - packages/client/src/components/CompanyMembersModal.tsx
  - packages/client/src/components/CompanyMembersIndicator.tsx
  - packages/client/src/components/ClientDetailTabs.tsx
autonomous: true

must_haves:
  truths:
    - "User can add existing individual client to company with role"
    - "User can see all members of a company in modal"
    - "User can update member role inline"
    - "User can mark member as primary contact"
    - "User can remove member from company"
    - "User can add company to individual client with role"
    - "User can see all companies linked to individual"
  artifacts:
    - path: "packages/server/src/routers/clients.ts"
      provides: "addMember, updateMember, removeMember endpoints"
      exports: ["addMember", "updateMember", "removeMember"]
    - path: "packages/client/src/components/CompanyMembersModal.tsx"
      provides: "Modal for managing company members"
      min_lines: 200
    - path: "packages/client/src/components/CompanyMembersIndicator.tsx"
      provides: "Clickable indicator with member preview"
      min_lines: 50
  key_links:
    - from: "packages/client/src/components/CompanyMembersIndicator.tsx"
      to: "packages/client/src/components/CompanyMembersModal.tsx"
      via: "onClick opens modal"
      pattern: "setShowModal\\(true\\)"
    - from: "packages/client/src/components/CompanyMembersModal.tsx"
      to: "packages/server/src/routers/clients.ts"
      via: "tRPC mutations"
      pattern: "trpc\\.clients\\.(addMember|updateMember|removeMember)"
    - from: "packages/client/src/components/ClientDetailTabs.tsx"
      to: "packages/client/src/components/CompanyMembersIndicator.tsx"
      via: "renders in Informations section"
      pattern: "<CompanyMembersIndicator"
---

<objective>
Implement complete UI for managing many-to-many relationships between individual clients and company clients via company_members table.

Purpose: Enable studios to link individual contacts (e.g., "Alexandre Grand - Ingénieur du son") to company clients (e.g., "Sound Production SARL") with roles and primary contact designation.

Output: Full CRUD functionality for company-member relationships with bidirectional UI (company view → members, individual view → companies).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-gestion-relations-client-entreprise/25-CONTEXT.md
@.planning/phases/20.1-corriger-architecture-contacts/20.1-01-SUMMARY.md
@packages/database/src/tenant/schema.ts
@packages/server/src/routers/clients.ts
@packages/client/src/components/ClientDetailTabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Missing Backend Endpoints</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
Add 3 new tRPC endpoints to clients router for managing company_members relationships:

**1. addMember endpoint:**
- Input: `{ companyId: number, memberId: number, role: string | null, isPrimary: boolean }`
- Validation: Check both clients exist, check member type is 'individual', check company type is 'company'
- Insert into company_members table
- Return success message

**2. updateMember endpoint:**
- Input: `{ id: number, role: string | null, isPrimary: boolean }`
- Update company_members record by id
- Return updated record

**3. removeMember endpoint:**
- Input: `{ id: number }` (company_members id, NOT client id)
- Delete from company_members where id matches
- Return success message

**Existing endpoints to keep:**
- `getMembers` (already exists - returns members for a company)
- `getAllMembers` (already exists - batch query for Kanban)

**Error handling:**
- Return TRPCError with code 'BAD_REQUEST' for validation failures (e.g., member is not individual, company is not company type)
- Return TRPCError with code 'NOT_FOUND' if client IDs don't exist
- Return TRPCError with code 'CONFLICT' if member already linked to company (duplicate entry)

**Why these patterns:**
- Input validation prevents data integrity issues (linking company to company, individual to individual)
- Using company_members.id for update/remove ensures uniqueness (client could be in multiple companies)
- Follows existing codebase tRPC router patterns (protectedProcedure, z.object input validation)
  </action>
  <verify>
```bash
# TypeScript check passes
pnpm check

# Test endpoints exist
grep -A 10 "addMember:" packages/server/src/routers/clients.ts
grep -A 10 "updateMember:" packages/server/src/routers/clients.ts
grep -A 10 "removeMember:" packages/server/src/routers/clients.ts
```
  </verify>
  <done>
- 3 new endpoints added to clients router
- All inputs use zod validation schemas
- Error handling for validation, not found, conflict cases
- TypeScript compilation 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CompanyMembersModal Component</name>
  <files>packages/client/src/components/CompanyMembersModal.tsx</files>
  <action>
Create new modal component for managing company-member relationships (used by both company and individual client views).

**Props:**
```typescript
interface CompanyMembersModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  clientId: number; // Company ID when viewing from company, Individual ID when viewing from individual
  clientType: 'company' | 'individual';
  clientName: string; // For modal title
}
```

**For company view (clientType === 'company'):**
- Modal title: "Membres de {clientName}"
- Query: `trpc.clients.getMembers.useQuery({ companyId: clientId })`
- List all members with: name, role (inline editable), isPrimary badge, remove button
- Add member section:
  - Dropdown searchable: `trpc.clients.list.useQuery()` filtered by `type: 'individual'`
  - After selection: role text input + isPrimary checkbox
  - Submit button calls `addMemberMutation`

**For individual view (clientType === 'individual'):**
- Modal title: "Entreprises de {clientName}"
- Query: Create new `getCompanies` query that returns companies where member_client_id = clientId
- List all companies with: name, role (inline editable), isPrimary badge, remove button
- Add company section:
  - Dropdown searchable: `trpc.clients.list.useQuery()` filtered by `type: 'company'`
  - After selection: role text input + isPrimary checkbox
  - Submit button calls `addMemberMutation` (same endpoint, reversed IDs)

**UI Structure:**
```tsx
<Dialog open={open} onOpenChange={onOpenChange}>
  <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
    <DialogHeader>
      <DialogTitle>{title}</DialogTitle>
      <DialogDescription>
        {clientType === 'company' ?
          'Gérer les contacts individuels de cette entreprise' :
          'Gérer les entreprises auxquelles ce contact appartient'}
      </DialogDescription>
    </DialogHeader>

    {/* List existing members/companies */}
    <div className="space-y-2">
      {members.map(member => (
        <div key={member.id} className="flex items-center justify-between p-3 border rounded">
          <div className="flex-1">
            <div className="font-medium">{member.name}</div>
            {/* Inline editable role */}
            <input
              value={editingRole[member.id] ?? member.role}
              onChange={e => handleRoleChange(member.id, e.target.value)}
              onBlur={() => handleSaveRole(member.id)}
              className="text-sm text-muted-foreground border-b border-transparent hover:border-input focus:border-primary"
            />
          </div>
          {member.isPrimary && <Badge>Contact principal</Badge>}
          <Button
            variant="ghost"
            size="sm"
            onClick={() => handleRemove(member.id)}
          >
            <Trash2 className="h-4 w-4" />
          </Button>
        </div>
      ))}
    </div>

    {/* Add new member/company */}
    <Separator />
    <div className="space-y-3">
      <h3 className="font-medium">
        {clientType === 'company' ? 'Ajouter un membre' : 'Ajouter une entreprise'}
      </h3>
      {/* Dropdown searchable + role input + isPrimary checkbox */}
    </div>
  </DialogContent>
</Dialog>
```

**Mutations:**
- `addMemberMutation = trpc.clients.addMember.useMutation()`
- `updateMemberMutation = trpc.clients.updateMember.useMutation()`
- `removeMemberMutation = trpc.clients.removeMember.useMutation()`
- After success: invalidate `clients.getMembers`, `clients.list`, show toast

**Inline editing pattern:**
- State: `editingRole: Record<number, string>`
- onChange: update local state
- onBlur: call updateMemberMutation if changed
- No separate "Edit" button - click on role text to edit

**Why these patterns:**
- Single component handles both company and individual views (DRY principle)
- Inline editing for role reduces friction (no secondary modal)
- Searchable dropdown prevents typos in client names
- Toast feedback confirms actions (added/removed/updated)
- Invalidate queries ensures UI refreshes immediately
  </action>
  <verify>
```bash
# Component exists and exports
grep -l "export.*CompanyMembersModal" packages/client/src/components/CompanyMembersModal.tsx

# TypeScript check passes
pnpm check

# Contains required elements
grep -c "addMemberMutation" packages/client/src/components/CompanyMembersModal.tsx
grep -c "updateMemberMutation" packages/client/src/components/CompanyMembersModal.tsx
grep -c "removeMemberMutation" packages/client/src/components/CompanyMembersModal.tsx
```
  </verify>
  <done>
- CompanyMembersModal component created with 200+ lines
- Handles both company and individual views via clientType prop
- Add/update/remove mutations integrated with toast feedback
- Inline role editing implemented
- Searchable dropdown for selecting clients
- TypeScript compilation 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CompanyMembersIndicator Component & Integrate</name>
  <files>
packages/client/src/components/CompanyMembersIndicator.tsx
packages/client/src/components/ClientDetailTabs.tsx
  </files>
  <action>
**Part 1: Create CompanyMembersIndicator.tsx**

Clickable indicator component that shows member/company count and preview names.

**Props:**
```typescript
interface CompanyMembersIndicatorProps {
  clientId: number;
  clientType: 'company' | 'individual';
  clientName: string;
}
```

**Logic:**
- Query: `trpc.clients.getMembers.useQuery({ companyId: clientId })` if company, OR create query for individual's companies
- Count: `members.length`
- Preview text:
  - If 0: "Aucun membre" / "Aucune entreprise"
  - If ≤ 3: "3 membres : Alex (Ingénieur), Sophie (Prod), Marc (Manager)"
  - If > 3: "5 membres : Alex (Ingénieur), Sophie (Prod)..."
- State: `showModal` boolean
- onClick: `setShowModal(true)`

**UI Structure:**
```tsx
<div className="space-y-2">
  <h3 className="text-sm font-medium">
    {clientType === 'company' ? 'Membres' : 'Entreprises'}
  </h3>
  <div
    className="flex items-center gap-2 p-3 border rounded cursor-pointer hover:bg-accent transition-colors"
    onClick={() => setShowModal(true)}
  >
    <Users className="h-4 w-4 text-muted-foreground" />
    <span className="text-sm">{previewText}</span>
  </div>

  <CompanyMembersModal
    open={showModal}
    onOpenChange={setShowModal}
    clientId={clientId}
    clientType={clientType}
    clientName={clientName}
  />
</div>
```

**Part 2: Integrate into ClientDetailTabs.tsx**

Add CompanyMembersIndicator in "Informations" tab, after contact details (phone, address, etc.).

**Location:** After `{/* Contact info display */}` section in both view and edit modes.

**Pattern (symmetrical for both company and individual):**
```tsx
{/* After phone/address/city display */}
<Separator className="my-4" />

{/* Company Members / Individual Companies Section */}
<CompanyMembersIndicator
  clientId={clientId}
  clientType={client.type}
  clientName={client.name}
/>
```

**Import at top:**
```typescript
import { CompanyMembersIndicator } from "@/components/CompanyMembersIndicator";
```

**Why these patterns:**
- Indicator is minimal (just count + preview) - full details in modal
- Cursor pointer + hover state signals clickability
- Separator creates visual boundary between sections
- Symmetrical placement (same position for company and individual views) ensures consistent UX
- Component handles query loading/error states internally
  </action>
  <verify>
```bash
# Components exist
ls packages/client/src/components/CompanyMembersIndicator.tsx

# Integration exists
grep -c "CompanyMembersIndicator" packages/client/src/components/ClientDetailTabs.tsx

# TypeScript check passes
pnpm check

# Build succeeds
cd packages/client && pnpm build
```
  </verify>
  <done>
- CompanyMembersIndicator component created with preview logic
- Modal integration complete (opens on click)
- Integrated into ClientDetailTabs after contact details
- Symmetrical placement for both company and individual views
- TypeScript compilation 0 errors
- Production build succeeds
  </done>
</task>

</tasks>

<verification>
**Manual testing checklist:**

1. **Company view → Members:**
   - Open any company client detail page
   - See "Membres" indicator with count/preview
   - Click indicator → modal opens
   - Add existing individual client with role → appears in list
   - Edit role inline → saves on blur
   - Mark member as primary → badge appears
   - Remove member → confirmation + disappears from list

2. **Individual view → Companies:**
   - Open any individual client detail page
   - See "Entreprises" indicator with count/preview
   - Click indicator → modal opens
   - Add existing company with role → appears in list
   - Edit role inline → saves on blur
   - Remove from company → confirmation + disappears

3. **Edge cases:**
   - Try adding member already linked → error toast
   - Try adding company to company → validation error
   - Empty state (0 members/companies) → "Aucun" text
   - 3 members → shows all names
   - 4+ members → truncates with "..."

**Automated verification:**
```bash
# Backend endpoints exist
pnpm check
grep "addMember:" packages/server/src/routers/clients.ts
grep "updateMember:" packages/server/src/routers/clients.ts
grep "removeMember:" packages/server/src/routers/clients.ts

# Frontend components exist
ls packages/client/src/components/CompanyMembersModal.tsx
ls packages/client/src/components/CompanyMembersIndicator.tsx

# Integration complete
grep "CompanyMembersIndicator" packages/client/src/components/ClientDetailTabs.tsx

# Build succeeds
cd packages/client && pnpm build
```
</verification>

<success_criteria>
- ✅ 3 new backend endpoints (addMember, updateMember, removeMember) added to clients.ts
- ✅ CompanyMembersModal component created with full CRUD functionality
- ✅ CompanyMembersIndicator component created with preview + click to open modal
- ✅ Integration into ClientDetailTabs complete (symmetrical placement)
- ✅ Inline role editing works (onChange + onBlur save)
- ✅ Primary contact badge displays correctly
- ✅ Searchable dropdown filters individual/company clients correctly
- ✅ Toast notifications for all actions (add/update/remove)
- ✅ TypeScript compilation 0 errors
- ✅ Production build succeeds
- ✅ Manual testing confirms all user stories work
</success_criteria>

<output>
After completion, create `.planning/phases/25-gestion-relations-client-entreprise/25-01-SUMMARY.md` documenting:
- Backend endpoints added (input/output schemas)
- Frontend components created (props, key features)
- Integration points in ClientDetailTabs
- Any edge cases discovered during testing
- Screenshots or GIF of working feature (optional)
</output>
