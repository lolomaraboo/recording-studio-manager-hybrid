---
phase: 34-harmonisation-tracks---routing-cohérent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/pages/TrackCreate.tsx
  - packages/client/src/components/TrackEditForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can create track with accordion-based form (consistent with Client/Talent/Service)"
    - "TrackCreate page uses TrackEditForm component (not inline Card forms)"
    - "Form state persists in localStorage across sessions"
    - "Alt+Click toggles all accordions (power-user feature)"
    - "Creating track navigates back to track detail page with success toast"
  artifacts:
    - path: "packages/client/src/components/TrackEditForm.tsx"
      provides: "Accordion-based form component (3 sections: Basic Info, Musical Details, Notes)"
      min_lines: 250
      exports: ["TrackEditForm"]
    - path: "packages/client/src/pages/TrackCreate.tsx"
      provides: "Updated create page using TrackEditForm component"
      min_lines: 80
      pattern: 'import.*TrackEditForm.*from.*@/components/TrackEditForm'
  key_links:
    - from: "packages/client/src/pages/TrackCreate.tsx"
      to: "TrackEditForm"
      via: "Import and render"
      pattern: 'import.*TrackEditForm.*from.*@/components/TrackEditForm'
    - from: "packages/client/src/components/TrackEditForm.tsx"
      to: "localStorage"
      via: "Accordion state persistence"
      pattern: "localStorage\\.(get|set)Item\\('trackEditAccordions'"
---

<objective>
Apply the established harmonization pattern (Phases 28-29) to Tracks by extracting the inline Card form structure from TrackCreate.tsx into a dedicated TrackEditForm accordion component.

Purpose: Achieve UI consistency across all resources with form creation (clients, sessions, invoices, talents, services, tracks). This enables localStorage accordion persistence, Alt+Click power-user shortcuts, and reduces cognitive friction from mixed UI patterns.

Output: TrackEditForm component (250+ lines), updated TrackCreate page (80 lines), zero new dependencies—all patterns copied from TalentEditForm (Phase 28).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Pattern references (established in Phase 28-29)
@packages/client/src/components/TalentEditForm.tsx
@packages/client/src/components/ServiceEditForm.tsx

# Current implementation (inline Card forms to extract)
@packages/client/src/pages/TrackCreate.tsx

# Database schema for field reference
@packages/database/src/tenant/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TrackEditForm accordion component</name>
  <files>packages/client/src/components/TrackEditForm.tsx</files>
  <action>
Create accordion-based form component at packages/client/src/components/TrackEditForm.tsx.

**Copy TalentEditForm.tsx structure (lines 1-70) with field adaptations:**

1. **Imports:** Same as TalentEditForm (useState, useEffect, Card, Accordion components, icons)
   - Additional icons: Music2, FileAudio, StickyNote

2. **Interface:**
```typescript
interface TrackEditFormProps {
  formData: any;
  setFormData: (data: any) => void;
  projects?: any[]; // Pass projects list from parent
}
```

3. **Accordion state with localStorage (lines 36-52 from TalentEditForm):**
   - Key: 'trackEditAccordions' (unique to tracks)
   - Default open: ["basic-info", "musical-details", "notes"] (3 accordions)
   - useEffect to save state on change

4. **Alt+Click toggle handler (lines 54-69 from TalentEditForm):**
   - allAccordions = ["basic-info", "musical-details", "notes"]
   - Toggle all open/closed logic

5. **Accordion structure (3 sections):**

**Accordion 1: Informations de base**
- Icon: FileAudio
- Fields (6 from TrackCreate.tsx lines 102-205):
  - projectId: Select (required asterisk) - from props.projects
  - title: Input (maxLength 255, required asterisk)
  - trackNumber: Input type="number" min="1" (optional)
  - status: Select (recording/editing/mixing/mastering/completed, optional)
  - duration: Input type="number" min="0" placeholder="240" (seconds, optional)
  - isrc: Input maxLength 50 with helper text "(International Standard Recording Code)" (optional)

**Accordion 2: Détails musicaux**
- Icon: Music2
- Fields (3 from TrackCreate.tsx lines 216-253):
  - bpm: Input type="number" min="0" max="300" placeholder="120" (optional)
  - key: Input maxLength 20 placeholder="C Major, Am, etc." (Tonalité, optional)
  - lyrics: Textarea rows={6} placeholder="Paroles de la chanson..." (optional)

**Accordion 3: Notes**
- Icon: StickyNote
- Fields (1 from TrackCreate.tsx lines 264-274):
  - notes: Textarea rows={4} placeholder="Notes, idées, références..." (optional)

6. **Card wrapper:** Each AccordionItem wrapped in <Card> for visual consistency

7. **Trigger onClick:** Pass handleAccordionTriggerClick to enable Alt+Click

8. **Field mapping reference from TrackCreate.tsx:**
   - All field IDs, labels, placeholders already defined at lines 103-274
   - Copy exact validation patterns (required asterisks on projectId and title only)
   - Helper text for ISRC preserved

**Pattern source:** TalentEditForm.tsx lines 1-299 (Phase 28), adapted to 3 accordions

**Expected output:** ~250-280 lines (TalentEditForm is 299 with 5 accordions, Tracks needs only 3)

**IMPORTANT:** Use native HTML form elements (input, select, textarea) wrapped with appropriate Tailwind classes, matching TalentEditForm pattern. Do NOT use shadcn/ui Input/Select/Textarea components to maintain consistency with Phase 28 pattern.
  </action>
  <verify>
File exists at packages/client/src/components/TrackEditForm.tsx with:
- Export: export function TrackEditForm
- Interface includes projects prop
- localStorage key: 'trackEditAccordions'
- 3 accordion sections: "basic-info", "musical-details", "notes"
- Accordion 1 contains: projectId Select, title Input, trackNumber Input, status Select, duration Input, isrc Input
- Accordion 2 contains: bpm Input, key Input, lyrics Textarea
- Accordion 3 contains: notes Textarea
- Alt+Click handler implemented (allAccordions array)
- Card wrapper on each AccordionItem

Run: grep -E "(trackEditAccordions|AccordionItem value=\"basic-info\"|AccordionItem value=\"musical-details\"|AccordionItem value=\"notes\")" packages/client/src/components/TrackEditForm.tsx
Expected: 4+ matches (localStorage key + 3 accordion values)
  </verify>
  <done>
TrackEditForm.tsx exists with 3-accordion structure (Basic Info + Musical Details + Notes). All 10 track fields present. localStorage persistence configured. Alt+Click toggle handler implemented. Component exports TrackEditForm function. TypeScript compiles with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TrackCreate to use TrackEditForm component</name>
  <files>packages/client/src/pages/TrackCreate.tsx</files>
  <action>
Update TrackCreate.tsx to use the new TrackEditForm accordion component, replacing inline Card forms.

**Step 1: Add import (after existing imports at line 11):**
```typescript
import { TrackEditForm } from "@/components/TrackEditForm";
```

**Step 2: Remove unused imports:**
Remove these imports (no longer needed after extracting to TrackEditForm):
- Card, CardContent, CardDescription, CardHeader, CardTitle (line 4)
- Input, Label, Textarea (lines 6-7)
- Select, SelectContent, SelectItem, SelectTrigger, SelectValue (line 8)

Keep these imports:
- useState, useNavigate, Link, Button, trpc, icons (ArrowLeft, Save), toast

**Step 3: Simplify form render (lines 72-340):**

Replace entire form section (lines 90-339) with simplified structure:

```typescript
{/* Form */}
<form onSubmit={handleSubmit}>
  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {/* Main Form */}
    <div className="lg:col-span-2">
      <TrackEditForm
        formData={formData}
        setFormData={setFormData}
        projects={projects}
      />
    </div>

    {/* Sidebar - Actions */}
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle>Actions</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <Button
            type="submit"
            className="w-full"
            disabled={createMutation.isPending}
          >
            <Save className="mr-2 h-4 w-4" />
            {createMutation.isPending ? "Création..." : "Créer la piste"}
          </Button>

          <Link to="/tracks" className="block">
            <Button type="button" variant="outline" className="w-full">
              Annuler
            </Button>
          </Link>
        </CardContent>
      </Card>

      {/* Help Card */}
      <Card>
        <CardHeader>
          <CardTitle>Aide</CardTitle>
        </CardHeader>
        <CardContent className="space-y-2 text-sm text-muted-foreground">
          <p>
            <strong className="text-foreground">Projet :</strong> Sélectionnez le projet
            auquel appartient cette piste.
          </p>
          <p>
            <strong className="text-foreground">ISRC :</strong> Code international
            d'identification des enregistrements sonores.
          </p>
          <p>
            <strong className="text-foreground">Tonalité :</strong> Exemples : C Major, D
            Minor, F# Minor, etc.
          </p>
        </CardContent>
      </Card>

      {/* Info Card */}
      <Card>
        <CardHeader>
          <CardTitle>Information</CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-muted-foreground">
          <p>
            Les champs marqués d'un <span className="text-red-500">*</span> sont
            obligatoires.
          </p>
        </CardContent>
      </Card>
    </div>
  </div>
</form>
```

**Step 4: Keep Card import for sidebar:**
Since sidebar still uses Card components, re-add minimal Card import:
```typescript
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
```

**Step 5: No changes needed to:**
- Header (lines 74-87) - keep as is
- State management (lines 16-42) - keep as is
- Form validation (lines 44-70) - keep as is
- Mutation setup (lines 20-28) - keep as is

**Pattern reference:** TalentCreate.tsx (Phase 28) - uses TalentEditForm component, sidebar with Cards

**Expected file structure after update:**
- Lines 1-11: Imports (simplified, TrackEditForm added)
- Lines 13-70: Component logic (unchanged)
- Lines 72-87: Header (unchanged)
- Lines 89-155: Simplified form with TrackEditForm + sidebar
- Total: ~80-90 lines (reduced from 342 lines)
  </action>
  <verify>
TrackCreate.tsx changes verified:
1. Import added: import { TrackEditForm } from "@/components/TrackEditForm"
2. Unused imports removed: Input, Label, Textarea, Select components
3. Form structure simplified: TrackEditForm rendered in lg:col-span-2 section
4. Sidebar preserved: Actions, Help, Info cards still present
5. Header unchanged: "Nouvelle Piste" with ArrowLeft and Save icons
6. State management unchanged: formData, handleSubmit, createMutation
7. File compiles with TypeScript 0 errors

Run: grep -E "(TrackEditForm|import.*Card)" packages/client/src/pages/TrackCreate.tsx
Expected: 2 matches (TrackEditForm import + Card import for sidebar)

Run: wc -l packages/client/src/pages/TrackCreate.tsx
Expected: ~80-100 lines (down from 342)
  </verify>
  <done>
TrackCreate.tsx updated: Uses TrackEditForm component instead of inline Card forms. File reduced from 342 lines to ~90 lines. Sidebar preserved with Actions/Help/Info cards. Header and state management unchanged. TypeScript compiles successfully. Form functionality maintained with improved consistency.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build verification and type checking</name>
  <files>N/A</files>
  <action>
Verify all changes compile successfully and maintain type safety.

**Step 1: Type check all packages**
Run: `pnpm check`
Expected: 0 TypeScript errors across all packages

**Step 2: Build client package**
Run: `pnpm --filter client build`
Expected: Build succeeds with 0 errors, dist/ directory created

**Step 3: Verify imports resolve**
Check that TrackEditForm is imported correctly in TrackCreate:
Run: `grep "TrackEditForm" packages/client/src/pages/TrackCreate.tsx`
Expected: Import statement matches export from TrackEditForm.tsx

**Step 4: Verify accordion structure**
Run: `grep -c "AccordionItem" packages/client/src/components/TrackEditForm.tsx`
Expected: 3 (3 accordion sections)

**If errors occur:**
- Import path issues: Verify @/components alias works
- Type errors: Check formData interface matches between TrackCreate and TrackEditForm
- Build errors: Run `pnpm install` if missing dependencies

**Pattern verification checklist:**
- [ ] TrackEditForm has 3 accordions (Basic Info, Musical Details, Notes)
- [ ] localStorage key is unique ('trackEditAccordions')
- [ ] Alt+Click handler present in TrackEditForm
- [ ] TrackCreate page structure matches TalentCreate (header, form, sidebar)
- [ ] All 10 track fields present in accordions
- [ ] Sidebar cards preserved (Actions, Help, Info)
- [ ] File size reduced (TrackCreate.tsx < 100 lines)
  </action>
  <verify>
Run: pnpm check
Expected: "✓ Checked N files in Xms" with 0 errors

Run: pnpm --filter client build
Expected: "dist/index.html" created, build size reported, 0 errors

Run: ls packages/client/dist/
Expected: index.html, assets/ directory exist

Run: grep -c "AccordionItem" packages/client/src/components/TrackEditForm.tsx
Expected: 3
  </verify>
  <done>
All TypeScript checks pass (0 errors). Client builds successfully. TrackEditForm component and TrackCreate page compile without issues. Pattern verification complete: Tracks harmonization matches established pattern from Phases 28-29. Ready for manual testing.
  </done>
</task>

</tasks>

<verification>
**Automated verification:**
1. `pnpm check` passes with 0 TypeScript errors
2. `pnpm --filter client build` succeeds
3. TrackEditForm.tsx exists with 250+ lines
4. TrackCreate.tsx reduced to ~80-100 lines (from 342)
5. TrackCreate.tsx imports TrackEditForm component
6. localStorage key 'trackEditAccordions' present

**Manual verification (user testing):**
1. Navigate to /tracks/new page
2. Verify TrackCreate page renders with:
   - Header: "Nouvelle Piste" with ArrowLeft icon
   - Back button to /tracks
   - 3 accordion sections (Informations de base, Détails musicaux, Notes)
   - All 10 fields present across accordions
   - Sidebar with Actions, Help, Info cards
   - "Créer la piste" submit button
3. Test accordion interactions:
   - Click accordion headers to expand/collapse
   - Alt+Click on any header to toggle all accordions
4. Fill form with valid data:
   - Select project (required)
   - Enter title (required)
   - Optionally fill other fields
5. Submit form
6. Verify success toast appears
7. Verify navigation to track detail page (/tracks/{id})
8. Refresh page and return to /tracks/new
9. Verify accordion state persisted (same accordions open as before)

**Goal-backward verification (must_haves):**
- ✓ User can create track with accordion form (TrackEditForm component exists)
- ✓ TrackCreate uses TrackEditForm (import and render present)
- ✓ localStorage persistence (trackEditAccordions key used)
- ✓ Alt+Click toggle (handleAccordionTriggerClick handler present)
- ✓ Success flow navigates to detail page (navigate in onSuccess)
</verification>

<success_criteria>
**Code artifacts:**
- [x] TrackEditForm.tsx created (250-280 lines)
- [x] TrackCreate.tsx updated (reduced to 80-100 lines)

**Functional requirements:**
- [x] TrackCreate page renders correctly with TrackEditForm
- [x] Form has 3 accordion sections (Basic Info + Musical Details + Notes)
- [x] All 10 track fields present and functional
- [x] Validation works (projectId and title required)
- [x] Submit creates track via tRPC mutation
- [x] Success navigates to track detail page with toast
- [x] Error shows toast with message
- [x] Accordion state persists in localStorage
- [x] Alt+Click toggles all accordions
- [x] Sidebar preserved (Actions, Help, Info cards)

**Pattern consistency:**
- [x] Matches TalentEditForm/ServiceEditForm structure (Phases 28-29)
- [x] Consistent with other harmonized resources
- [x] Accordion-based form pattern established
- [x] localStorage persistence pattern maintained
- [x] Alt+Click power-user feature present
- [x] TypeScript strict mode passes (0 errors)

**Code quality:**
- [x] File size reduced (TrackCreate: 342 → ~90 lines)
- [x] Separation of concerns (form logic extracted to component)
- [x] Reusable component (TrackEditForm can be used for edit pages)
- [x] No new dependencies added
- [x] Consistent with project conventions

**Documentation:**
- Phase 34 harmonization complete
- Tracks now consistent with Client/Talent/Service accordion pattern
- Pattern established for Phases 35-36 (Invoices, Quotes)
- All major resources transitioning to accordion-based forms
</success_criteria>

<output>
After completion, create `.planning/phases/34-harmonisation-tracks---routing-cohérent/34-01-SUMMARY.md` with:

**Frontmatter:**
- phase: 34-harmonisation-tracks---routing-cohérent
- plan: 01
- subsystem: ui-harmonization
- tags: [tracks, accordion-form, ui-consistency, forms]
- requires: Phase 28 (TalentEditForm pattern), Phase 29 (ServiceEditForm pattern)
- provides: TrackEditForm component, updated TrackCreate page
- affects: Phase 35+ (Invoices, Quotes accordion forms)
- tech-stack.added: [] (zero new dependencies)
- tech-stack.patterns: [Accordion forms, localStorage persistence, component extraction]
- key-files.created: [TrackEditForm.tsx]
- key-files.modified: [TrackCreate.tsx]
- decisions: [Use 3 accordions, Extract form to component, Preserve sidebar cards]
- metrics: duration, completed date, tasks 3/3, commits 1

**Summary sections:**
1. **What Was Built:** TrackEditForm component with 3 accordions, TrackCreate page refactored to use component
2. **Key Changes:** List 3 tasks with files modified and line counts
3. **Pattern Application:** How TalentEditForm pattern was adapted to Tracks (3 accordions for 10 fields)
4. **Technical Decisions:** Why 3 accordions, why component extraction, sidebar preservation strategy
5. **Verification Results:** TypeScript 0 errors, build success, manual testing outcomes
6. **Next Steps:** Phase 35 (Invoices) can follow same pattern for complex forms

**Include in summary:**
- Total lines added: ~260 (250 TrackEditForm + 10 TrackCreate updates)
- Total lines removed: ~252 (inline Card forms from TrackCreate)
- Net change: +8 lines (component extraction, improved maintainability)
- Code reduction: TrackCreate 342 → 90 lines (73% reduction)
- Pattern consistency: Tracks now matches Client/Talent/Service accordion pattern
- Reusability: TrackEditForm can be reused for track edit pages
</output>
