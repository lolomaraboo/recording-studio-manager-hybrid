---
phase: 3.8-verifier-chatbot-memoire
plan: 01
type: execute
---

<objective>
Verify AI chatbot maintains conversation context throughout multi-turn discussions before marketing launch.

Purpose: Critical UX validation - chatbot must remember previous messages, entities created, and conversation flow to be helpful and trustworthy.
Output: Production validation confirming chatbot memory persists across multiple turns, no context loss.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current chatbot implementation:**
- Backend: packages/server/src/routers/ai.ts
- Database: aiConversations table stores full conversation history as JSON
- Session management: sessionId generated on first message, reused for subsequent messages
- Claude API: Messages array includes full conversation history
- Storage: conversationHistory loaded from DB, appended with new messages, saved back

**How memory currently works:**
1. Frontend (AIAssistant.tsx) sends `message + sessionId` to backend
2. Backend loads `aiConversations` WHERE sessionId = inputSessionId
3. Parses messages JSON array: `[{ role, content, timestamp }]`
4. Appends new user message to history
5. Sends FULL history to Claude API (llmMessages)
6. Claude responds with context
7. Backend appends assistant response to history
8. Saves updated history back to DB

**Key verification points:**
- Does sessionId persist between messages in frontend?
- Does DB correctly load/save conversation history?
- Does Claude API receive full context in each call?
- Does conversation remain coherent across 10+ turns?
- What happens near Claude's context limit (200k tokens)?

**Prior phases:**
- Phase 3.7: Added tRPC cache invalidation after chatbot actions
- Chat tested with simple queries, but NOT multi-turn conversations
- Playwright tests validate chatbot UI, not conversation memory

**Risks:**
- Frontend might regenerate sessionId on each message (memory loss)
- DB load might fail silently (returns empty history)
- Token limit might truncate early messages (gradual amnesia)
- SSE streaming might not pass sessionId correctly
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test multi-turn conversation memory in production</name>
  <files>None (production testing with MCP Chrome DevTools)</files>
  <action>
    Test chatbot memory persistence with realistic conversation flow using MCP Chrome DevTools:

    1. Navigate to https://recording-studio-manager.com/dashboard
    2. Open AI chatbot (floating window)
    3. Conduct 10-turn conversation testing memory:

       **Turn 1:** "Create a client named John Smith with email john@studio.com"
       - Verify: chatbot confirms client created

       **Turn 2:** "What was the name I just mentioned?"
       - Expected: "John Smith" (tests immediate memory)

       **Turn 3:** "Now create a session for John Smith tomorrow at 2pm in Studio A"
       - Verify: chatbot references "John Smith" from Turn 1

       **Turn 4:** "What client did I create earlier?"
       - Expected: "John Smith" (tests memory from 3 turns ago)

       **Turn 5:** "What session did we just schedule?"
       - Expected: References tomorrow 2pm Studio A

       **Turn 6:** "Change the session time to 3pm"
       - Verify: chatbot updates the session created in Turn 3

       **Turn 7:** "Create another client named Sarah Jones"
       - New entity introduced

       **Turn 8:** "How many clients have we created in this conversation?"
       - Expected: 2 (John Smith + Sarah Jones)

       **Turn 9:** "What was the first client's email?"
       - Expected: john@studio.com (tests long-term memory)

       **Turn 10:** "List all the things we've done together"
       - Expected: Summary of all actions (2 clients, 1 session, 1 update)

    For EACH turn, verify in Chrome DevTools Network tab:
    - POST /api/trpc/ai.chat request payload includes sessionId
    - sessionId value is SAME across all 10 turns (not regenerated)
    - Browser console shows no errors about missing sessionId

    Screenshot each chatbot response for documentation.
  </action>
  <verify>
    - All 10 chatbot responses are contextually correct
    - Chatbot remembers entities from Turn 1 by Turn 10
    - Network tab confirms same sessionId across all requests
    - No browser console errors about context/memory loss
  </verify>
  <done>
    - 10/10 responses demonstrate correct memory
    - sessionId persisted throughout conversation
    - No memory loss detected
    - Screenshots captured for all turns
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify database conversation storage</name>
  <files>None (database query via SSH)</files>
  <action>
    After completing Task 1's 10-turn conversation, verify database persistence:

    1. SSH to production VPS: ssh vps-n8n
    2. Connect to PostgreSQL: docker exec -it rsm-postgres psql -U postgres
    3. Switch to tenant database (user's tenant from Task 1)
    4. Query conversation:
       ```sql
       SELECT id, session_id, total_messages,
              LENGTH(messages) as messages_size_bytes,
              created_at, updated_at
       FROM ai_conversations
       ORDER BY updated_at DESC
       LIMIT 1;
       ```

    5. Verify the latest conversation record:
       - session_id matches the sessionId from Task 1 network requests
       - total_messages = 20 (10 user + 10 assistant messages)
       - messages_size_bytes > 0 (JSON array is not empty)
       - updated_at is recent (within last 5 minutes)

    6. Parse messages JSON to count turns:
       ```sql
       SELECT jsonb_array_length(messages::jsonb) as message_count
       FROM ai_conversations
       ORDER BY updated_at DESC
       LIMIT 1;
       ```
       Expected: message_count = 20

    7. Extract first and last message content:
       ```sql
       SELECT
         messages::jsonb->0->>'content' as first_message,
         messages::jsonb->-1->>'content' as last_message
       FROM ai_conversations
       ORDER BY updated_at DESC
       LIMIT 1;
       ```
       Expected:
       - first_message contains "Create a client named John Smith"
       - last_message contains summary of all actions

    Document all query results in Task 2 verification notes.
  </action>
  <verify>
    - Database record exists for the conversation
    - session_id matches frontend sessionId
    - total_messages = 20 (10 user + 10 assistant)
    - messages JSON contains full conversation history
    - First and last messages match expected content
  </verify>
  <done>
    - Database correctly stores full conversation
    - All 20 messages persisted in order
    - sessionId correctly links messages together
    - Query results documented
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Multi-turn conversation memory validation completed</what-built>
  <how-to-verify>
    Review verification results:

    **Task 1 Results:**
    - Chatbot screenshots showing 10 coherent responses
    - Network tab confirms consistent sessionId
    - Responses demonstrate memory of previous context

    **Task 2 Results:**
    - Database query shows 20 messages stored correctly
    - session_id matches frontend sessionId
    - First/last message content matches conversation

    **Expected Behavior:**
    ✅ Chatbot remembers John Smith from Turn 1 by Turn 10
    ✅ Chatbot references session scheduled in Turn 3 when asked in Turn 5
    ✅ Chatbot updates correct session when asked in Turn 6
    ✅ Chatbot counts 2 clients correctly in Turn 8
    ✅ Chatbot recalls john@studio.com email in Turn 9
    ✅ Database stores all 20 messages with correct sessionId

    If any memory failures detected, describe which turn failed and how.
  </how-to-verify>
  <resume-signal>Type "approved" if memory works correctly, or describe failures to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] 10-turn conversation tested in production
- [ ] All chatbot responses demonstrate context awareness
- [ ] Database stores full conversation history correctly
- [ ] sessionId persists across all turns
- [ ] No memory loss or context degradation detected
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Chatbot memory confirmed working across 10+ turns
- Database persistence validated
- Phase 3.8 ready for Phase 4 (Marketing Foundation)
</success_criteria>

<output>
After completion, create `.planning/phases/3.8-verifier-chatbot-memoire/3.8-01-SUMMARY.md`:

# Phase 3.8 Plan 1: Chatbot Memory Verification Summary

**Chatbot memory validated - conversation context persists across 10+ turns**

## Accomplishments

- Tested 10-turn conversation with progressive memory requirements
- Verified sessionId persistence in frontend (same across all API calls)
- Confirmed database stores full conversation history (20 messages)
- Validated Claude API receives complete context each turn
- Documented chatbot memory behavior with screenshots

## Memory Test Results

**Conversation Flow:**
1. Create client John Smith → ✅ Remembered in turns 2, 4, 8, 9
2. Schedule session tomorrow 2pm → ✅ Referenced in turn 5
3. Update session to 3pm → ✅ Correctly updated
4. Create client Sarah Jones → ✅ Counted in turn 8
5. Recall first client's email → ✅ Retrieved john@studio.com

**Technical Validation:**
- sessionId: [actual sessionId from test] (consistent across all turns)
- Database messages count: 20 (10 user + 10 assistant)
- Network requests: 10/10 included same sessionId
- Browser errors: 0

## Database Verification

```sql
-- Conversation record
session_id: [sessionId]
total_messages: 20
messages_size: [bytes]
created_at: [timestamp]
updated_at: [timestamp]

-- Message count
message_count: 20

-- First/last messages
first_message: "Create a client named John Smith..."
last_message: "We've created 2 clients (John Smith, Sarah Jones)..."
```

## Issues Encountered

[None OR describe any memory failures discovered]

## Next Step

Phase 3.8 complete (1/1 plans) - Chatbot memory validated for production launch.
Ready for Phase 4 (Marketing Foundation).
</output>
