---
phase: 21-audit-et-correction-scripts-base-de-donnees
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - packages/database/scripts/init/create-tenant.ts
  - packages/database/scripts/init/seed-base-data.ts
  - packages/database/scripts/init/seed-realistic-data.ts
autonomous: true

must_haves:
  truths:
    - "Fresh tenant creation works with current schema (31 tables)"
    - "Base seed data includes all current tables (clients with vCard, company_members, etc.)"
    - "Realistic seed data compatible with Phase 21 schema"
  artifacts:
    - path: "packages/database/scripts/init/create-tenant.ts"
      provides: "Universal tenant creation script"
      min_lines: 100
      exports: ["createTenant function"]
    - path: "packages/database/scripts/init/seed-base-data.ts"
      provides: "Minimal test data for current schema"
      min_lines: 200
    - path: "packages/database/scripts/init/seed-realistic-data.ts"
      provides: "Comprehensive test data with vCard/company_members"
      min_lines: 250
  key_links:
    - from: "create-tenant.ts"
      to: "packages/database/src/tenant/schema.ts"
      via: "applies current schema via drizzle-kit migrate"
      pattern: "drizzle-kit migrate --config=drizzle.tenant.config.ts"
    - from: "create-tenant.ts"
      to: "information_schema.tables"
      via: "validates exactly 31 tables created"
      pattern: "SELECT COUNT\\(\\*\\) FROM information_schema\\.tables WHERE table_schema = 'public'"
    - from: "seed-base-data.ts"
      to: "packages/database/src/tenant/schema.ts"
      via: "inserts data using current schema"
      pattern: "postgres.js INSERT INTO"
---

<objective>
Create updated init scripts compatible with current schema (Phase 21: 31 tenant tables including vCard fields, company_members, invoice deposits, time tracking).

Purpose: Replace obsolete init-tenant.ts and seed-tenant-3.ts with modern scripts using "increment tenant" pattern and current schema.

Output: 3 new scripts in `scripts/init/` directory for tenant creation and seeding.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-RESEARCH.md
@.planning/DEVELOPMENT-WORKFLOW.md
@.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-01-SUMMARY.md

# Existing patterns to improve
@packages/database/scripts/create-tenant-3.ts
@packages/database/scripts/seed-tenant-3.ts

# Current schema reference
@packages/database/src/tenant/schema.ts
@packages/database/src/master/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Create universal tenant creation script</name>
  <files>
    packages/database/scripts/init/create-tenant.ts
  </files>
  <action>
    Create `packages/database/scripts/init/create-tenant.ts` based on create-tenant-3.ts pattern but generalized:

    **Features:**
    - Accept tenant number as CLI argument (default: auto-increment)
    - Create organization in master DB with realistic defaults
    - Create PostgreSQL database (tenant_N)
    - Register in tenant_databases table
    - Apply current tenant migrations via drizzle-kit --config=drizzle.tenant.config.ts
    - **CRITICAL: Validate exactly 31 tables created after migration**
    - Return org ID and connection details
    - Error handling with rollback on failure

    **Usage:**
    ```bash
    # Auto-increment (finds next available tenant number)
    pnpm exec tsx scripts/init/create-tenant.ts

    # Explicit tenant number
    pnpm exec tsx scripts/init/create-tenant.ts 5
    ```

    **Schema validation (CRITICAL - prevents silent migration failures):**
    After running drizzle-kit migrate, the script MUST:
    1. Query information_schema.tables for table count
    2. Compare to expected 31 tables
    3. If mismatch: rollback (DROP DATABASE, DELETE from organizations/tenant_databases)
    4. Exit with error explaining migration produced wrong table count
    5. If match: proceed with success message

    **Why this validation is critical:**
    - Drizzle-kit migrate can succeed even if migrations are skipped/partial
    - Without validation, you get incomplete tenant databases (missing tables)
    - This prevents the exact debugging session we're avoiding (Phase 18.1-18.3)

    **Implementation pattern:**
    ```typescript
    // After drizzle-kit migrate completes
    const tableCountResult = await sql`
      SELECT COUNT(*) as count
      FROM information_schema.tables
      WHERE table_schema = 'public'
    `;
    const actualCount = parseInt(tableCountResult[0].count);
    const expectedCount = 31;

    if (actualCount !== expectedCount) {
      console.error(`Migration failed: expected ${expectedCount} tables, got ${actualCount}`);
      // Rollback logic here
      process.exit(1);
    }
    ```

    Include detailed console output showing progress, table count validation, and final credentials.
  </action>
  <verify>
    # Test script creates tenant successfully
    cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database
    pnpm exec tsx scripts/init/create-tenant.ts 99
    # Should create tenant_99 with 31 tables AND validate count

    # Verify table count (redundant with script validation, but confirms)
    psql -U postgres -d tenant_99 -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"
    # Should output: 31

    # Verify script output includes validation message
    pnpm exec tsx scripts/init/create-tenant.ts 99 2>&1 | grep "31 tables"
    # Should show validation message like "✅ Validated: 31 tables created"
  </verify>
  <done>
    create-tenant.ts script works, creates tenant with full 31-table schema, validates table count after migration (exits with error if mismatch), auto-increment finds next available number
  </done>
</task>

<task type="auto">
  <name>Create base seed data script</name>
  <files>
    packages/database/scripts/init/seed-base-data.ts
  </files>
  <action>
    Create `packages/database/scripts/init/seed-base-data.ts` with MINIMAL test data using CURRENT schema:

    **Seed data (bare minimum for testing):**
    - 3 individual clients with vCard fields (firstName, lastName, phones, emails, avatarUrl)
    - 2 company clients with vCard fields (companyName, logoUrl, websites)
    - 3 company_members relationships (linking individuals to companies with roles)
    - 2 rooms (basic fields)
    - 3 equipment items (basic fields)
    - 2 sessions (including project_id nullable, deposit fields)
    - 1 project (basic fields)
    - 2 tracks (including Phase 5 enrichment fields)
    - 1 time_entry (with task_type reference)
    - 1 invoice (with deposit fields, pdf_s3_key)

    **Total: ~20 records across 10 entity types (manageable context)**

    **Schema compliance:**
    - Use postgres.js for type-safe inserts
    - Include ALL required fields per current schema
    - Use realistic but simple test data
    - No @faker-js dependency (simple hardcoded values)

    **Usage:**
    ```bash
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_N" \
      pnpm exec tsx scripts/init/seed-base-data.ts
    ```

    Output summary showing what was created (counts per table).
  </action>
  <verify>
    # Seed tenant_99 with base data
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_99" \
      pnpm exec tsx /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database/scripts/init/seed-base-data.ts

    # Verify data inserted
    psql -U postgres -d tenant_99 -c "
      SELECT
        (SELECT COUNT(*) FROM clients) as clients,
        (SELECT COUNT(*) FROM company_members) as members,
        (SELECT COUNT(*) FROM sessions) as sessions,
        (SELECT COUNT(*) FROM invoices) as invoices;
    "
    # Should show: clients=5, members=3, sessions=2, invoices=1
  </verify>
  <done>
    seed-base-data.ts works, creates minimal but complete test data (~20 records), all current schema fields populated correctly
  </done>
</task>

<task type="auto">
  <name>Create realistic seed data script with faker.js (reduced scope)</name>
  <files>
    packages/database/scripts/init/seed-realistic-data.ts
  </files>
  <action>
    **FIRST: Check if @faker-js/faker is installed**
    ```bash
    grep '@faker-js/faker' packages/database/package.json || \
      pnpm --filter database add -D @faker-js/faker
    ```

    **THEN: Create realistic seed script (REDUCED SCOPE to prevent context budget issues)**

    Create `packages/database/scripts/init/seed-realistic-data.ts` with realistic test data using @faker-js/faker:

    **Seed data (realistic but not overwhelming - ~60 total records):**
    - 8 individual clients (varied vCard data: artists, session musicians, producers)
    - 4 company clients (record labels, management, production houses)
    - 8 company_members relationships (realistic org charts)
    - 3 client_notes entries
    - 3 rooms (studio, mix, rehearsal)
    - 6 equipment items (microphones, preamps, interfaces)
    - 8 sessions (mix of completed/scheduled)
    - 3 projects (different genres)
    - 12 tracks (with versioning, copyright metadata)
    - 2 musicians/talent entries
    - 5 time_entries (various task types)
    - 3 invoices (different statuses)
    - 6 invoice_items (linked to invoices)
    - 2 quotes (different states)

    **Total: ~60 records across 14 entity types (vs original 118+)**

    **Why reduced scope:**
    - Original plan had 118+ records (20 clients + 12 members + 12 sessions + 20 tracks + 10 invoice_items + ...)
    - Checker flagged this may exceed single task context budget (~50% target)
    - Reduced to ~60 records provides sufficient realism for UI testing
    - Matches seed-base-data pattern (~50 records like current setup-test-studio-ui.sql)

    **Realism requirements:**
    - Use @faker-js/faker for names, emails, phones, addresses
    - Realistic studio names, project titles, track names
    - Varied dates (past sessions, future bookings)
    - Complex relationships (projects with multiple tracks, companies with multiple contacts)
    - Edge cases (clients with no sessions, sessions with no invoices)

    **Usage:**
    ```bash
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_N" \
      pnpm exec tsx scripts/init/seed-realistic-data.ts
    ```

    This replaces setup-test-studio-ui.sql with TypeScript type safety.
  </action>
  <verify>
    # Seed tenant_99 with realistic data
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_99" \
      pnpm exec tsx /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database/scripts/init/seed-realistic-data.ts

    # Verify realistic data (reduced counts)
    psql -U postgres -d tenant_99 -c "
      SELECT
        (SELECT COUNT(*) FROM clients) as clients,
        (SELECT COUNT(*) FROM company_members) as members,
        (SELECT COUNT(*) FROM sessions) as sessions,
        (SELECT COUNT(*) FROM projects) as projects,
        (SELECT COUNT(*) FROM tracks) as tracks,
        (SELECT COUNT(*) FROM invoices) as invoices;
    "
    # Should show: clients=12, members=8, sessions=8, projects=3, tracks=12, invoices=3
  </verify>
  <done>
    seed-realistic-data.ts works, creates realistic test data (~60 records, not 118+), suitable for UI validation testing, context budget manageable
  </done>
</task>

</tasks>

<verification>
Complete workflow test:

```bash
cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database

# 1. Create fresh tenant
pnpm exec tsx scripts/init/create-tenant.ts 100
# Should create tenant_100 with 31 tables AND validate count

# 2. Seed base data
DATABASE_URL="postgresql://postgres@localhost:5432/tenant_100" \
  pnpm exec tsx scripts/init/seed-base-data.ts
# Should create minimal test data (~20 records)

# 3. Create another tenant with realistic data
pnpm exec tsx scripts/init/create-tenant.ts 101
DATABASE_URL="postgresql://postgres@localhost:5432/tenant_101" \
  pnpm exec tsx scripts/init/seed-realistic-data.ts
# Should create realistic test data (~60 records)

# 4. Verify both tenants work
psql -U postgres -d tenant_100 -c "SELECT COUNT(*) FROM clients;"
psql -U postgres -d tenant_101 -c "SELECT COUNT(*) FROM clients;"

# 5. Cleanup test tenants and master DB records
psql -U postgres -c "DROP DATABASE IF EXISTS tenant_99;"
psql -U postgres -c "DROP DATABASE IF EXISTS tenant_100;"
psql -U postgres -c "DROP DATABASE IF EXISTS tenant_101;"
psql -U postgres -d rsm_master -c "DELETE FROM organizations WHERE id IN (99, 100, 101);"
psql -U postgres -d rsm_master -c "DELETE FROM tenant_databases WHERE organization_id IN (99, 100, 101);"
```

All scripts should execute without PostgreSQL errors.
</verification>

<success_criteria>
- ✅ create-tenant.ts creates tenant with 31 tables via migrations
- ✅ create-tenant.ts validates exactly 31 tables created (exits with error if mismatch)
- ✅ seed-base-data.ts creates minimal test data (~20 records: 5 clients, 3 members, 2 sessions, 1 invoice)
- ✅ seed-realistic-data.ts creates realistic test data (~60 records: 12 clients, 8 members, 8 sessions, 3 invoices)
- ✅ All scripts use current schema (vCard fields, company_members, deposit fields)
- ✅ TypeScript type safety throughout (postgres.js, no raw SQL)
- ✅ Zero PostgreSQL errors when running scripts
- ✅ Scripts follow DEVELOPMENT-WORKFLOW.md "increment tenant" pattern
- ✅ Cleanup removes both tenant databases AND master DB organization records
</success_criteria>

<output>
After completion, create `.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-02-SUMMARY.md`
</output>
