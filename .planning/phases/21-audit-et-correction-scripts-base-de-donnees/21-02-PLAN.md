---
phase: 21-audit-et-correction-scripts-base-de-donnees
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - packages/database/scripts/init/create-tenant.ts
  - packages/database/scripts/init/seed-base-data.ts
  - packages/database/scripts/init/seed-realistic-data.ts
autonomous: true

must_haves:
  truths:
    - "Fresh tenant creation works with current schema (31 tables)"
    - "Base seed data includes all current tables (clients with vCard, company_members, etc.)"
    - "Realistic seed data compatible with Phase 21 schema"
  artifacts:
    - path: "packages/database/scripts/init/create-tenant.ts"
      provides: "Universal tenant creation script"
      min_lines: 100
      exports: ["createTenant function"]
    - path: "packages/database/scripts/init/seed-base-data.ts"
      provides: "Minimal test data for current schema"
      min_lines: 150
    - path: "packages/database/scripts/init/seed-realistic-data.ts"
      provides: "Comprehensive test data with vCard/company_members"
      min_lines: 300
  key_links:
    - from: "create-tenant.ts"
      to: "packages/database/src/tenant/schema.ts"
      via: "applies current schema"
      pattern: "drizzle-kit migrate"
    - from: "seed-base-data.ts"
      to: "packages/database/src/tenant/schema.ts"
      via: "inserts data using current schema"
      pattern: "postgres.js INSERT INTO"
</objective>

<objective>
Create updated init scripts compatible with current schema (Phase 21: 31 tenant tables including vCard fields, company_members, invoice deposits, time tracking).

Purpose: Replace obsolete init-tenant.ts and seed-tenant-3.ts with modern scripts using "increment tenant" pattern and current schema.

Output: 3 new scripts in `scripts/init/` directory for tenant creation and seeding.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-RESEARCH.md
@.planning/DEVELOPMENT-WORKFLOW.md
@.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-01-SUMMARY.md

# Existing patterns to improve
@packages/database/scripts/create-tenant-3.ts
@packages/database/scripts/seed-tenant-3.ts

# Current schema reference
@packages/database/src/tenant/schema.ts
@packages/database/src/master/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Create universal tenant creation script</name>
  <files>
    packages/database/scripts/init/create-tenant.ts
  </files>
  <action>
    Create `packages/database/scripts/init/create-tenant.ts` based on create-tenant-3.ts pattern but generalized:

    **Features:**
    - Accept tenant number as CLI argument (default: auto-increment)
    - Create organization in master DB with realistic defaults
    - Create PostgreSQL database (tenant_N)
    - Register in tenant_databases table
    - Apply current tenant migrations via drizzle-kit
    - Return org ID and connection details
    - Error handling with rollback on failure

    **Usage:**
    ```bash
    # Auto-increment (finds next available tenant number)
    pnpm exec tsx scripts/init/create-tenant.ts

    # Explicit tenant number
    pnpm exec tsx scripts/init/create-tenant.ts 5
    ```

    **Schema compatibility:**
    - Uses drizzle-kit migrate (not manual SQL) to apply all 12 migrations
    - Creates complete 31-table tenant schema
    - Validates schema after creation (table count check)

    Include detailed console output showing progress and final credentials.
  </action>
  <verify>
    # Test script creates tenant successfully
    cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database
    pnpm exec tsx scripts/init/create-tenant.ts 99
    # Should create tenant_99 with 31 tables

    # Verify table count
    psql -U postgres -d tenant_99 -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"
    # Should output: 31
  </verify>
  <done>
    create-tenant.ts script works, creates tenant with full 31-table schema, auto-increment finds next available number
  </done>
</task>

<task type="auto">
  <name>Create base seed data script</name>
  <files>
    packages/database/scripts/init/seed-base-data.ts
  </files>
  <action>
    Create `packages/database/scripts/init/seed-base-data.ts` with MINIMAL test data using CURRENT schema:

    **Seed data (bare minimum for testing):**
    - 3 individual clients with vCard fields (firstName, lastName, phones, emails, avatarUrl)
    - 2 company clients with vCard fields (companyName, logoUrl, websites)
    - 3 company_members relationships (linking individuals to companies with roles)
    - 2 rooms (basic fields)
    - 3 equipment items (basic fields)
    - 2 sessions (including project_id nullable, deposit fields)
    - 1 project (basic fields)
    - 2 tracks (including Phase 5 enrichment fields)
    - 1 time_entry (with task_type reference)
    - 1 invoice (with deposit fields, pdf_s3_key)

    **Schema compliance:**
    - Use postgres.js for type-safe inserts
    - Include ALL required fields per current schema
    - Use realistic but simple test data
    - No @faker-js dependency (simple hardcoded values)

    **Usage:**
    ```bash
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_N" \
      pnpm exec tsx scripts/init/seed-base-data.ts
    ```

    Output summary showing what was created (counts per table).
  </action>
  <verify>
    # Seed tenant_99 with base data
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_99" \
      pnpm exec tsx /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database/scripts/init/seed-base-data.ts

    # Verify data inserted
    psql -U postgres -d tenant_99 -c "
      SELECT
        (SELECT COUNT(*) FROM clients) as clients,
        (SELECT COUNT(*) FROM company_members) as members,
        (SELECT COUNT(*) FROM sessions) as sessions,
        (SELECT COUNT(*) FROM invoices) as invoices;
    "
    # Should show: clients=5, members=3, sessions=2, invoices=1
  </verify>
  <done>
    seed-base-data.ts works, creates minimal but complete test data, all current schema fields populated correctly
  </done>
</task>

<task type="auto">
  <name>Create realistic seed data script</name>
  <files>
    packages/database/scripts/init/seed-realistic-data.ts
  </files>
  <action>
    Create `packages/database/scripts/init/seed-realistic-data.ts` with COMPREHENSIVE test data using @faker-js/faker:

    **Seed data (UI validation quality):**
    - 15 individual clients (varied vCard data: artists, session musicians, producers)
    - 5 company clients (record labels, management, production houses)
    - 12 company_members relationships (realistic org charts)
    - 5 client_notes entries (dated history)
    - 4 rooms (different types: studio, mix, master, rehearsal)
    - 10 equipment items (microphones, preamps, interfaces)
    - 12 sessions (mix of completed/scheduled, some with projects, some standalone)
    - 5 projects (different genres, statuses)
    - 20 tracks (with versioning, copyright metadata, technical details)
    - 4 musicians/talent entries
    - 8 time_entries (various task types: recording, mixing, mastering)
    - 5 invoices (different statuses: draft, sent, paid, partial)
    - 10 invoice_items (linked to invoices)
    - 3 quotes (different states: draft, sent, accepted)

    **Realism requirements:**
    - Use @faker-js/faker for names, emails, phones, addresses
    - Realistic studio names, project titles, track names
    - Varied dates (past sessions, future bookings)
    - Complex relationships (projects with multiple tracks, companies with multiple contacts)
    - Edge cases (clients with no sessions, sessions with no invoices, etc.)

    **Usage:**
    ```bash
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_N" \
      pnpm exec tsx scripts/init/seed-realistic-data.ts
    ```

    This replaces setup-test-studio-ui.sql with TypeScript type safety.
  </action>
  <verify>
    # Seed tenant_99 with realistic data
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_99" \
      pnpm exec tsx /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database/scripts/init/seed-realistic-data.ts

    # Verify comprehensive data
    psql -U postgres -d tenant_99 -c "
      SELECT
        (SELECT COUNT(*) FROM clients) as clients,
        (SELECT COUNT(*) FROM company_members) as members,
        (SELECT COUNT(*) FROM sessions) as sessions,
        (SELECT COUNT(*) FROM projects) as projects,
        (SELECT COUNT(*) FROM tracks) as tracks,
        (SELECT COUNT(*) FROM invoices) as invoices;
    "
    # Should show: clients=20, members=12, sessions=12, projects=5, tracks=20, invoices=5
  </verify>
  <done>
    seed-realistic-data.ts works, creates comprehensive test data with faker.js, suitable for UI validation testing
  </done>
</task>

</tasks>

<verification>
Complete workflow test:

```bash
cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database

# 1. Create fresh tenant
pnpm exec tsx scripts/init/create-tenant.ts 100
# Should create tenant_100 with 31 tables

# 2. Seed base data
DATABASE_URL="postgresql://postgres@localhost:5432/tenant_100" \
  pnpm exec tsx scripts/init/seed-base-data.ts
# Should create minimal test data

# 3. Create another tenant with realistic data
pnpm exec tsx scripts/init/create-tenant.ts 101
DATABASE_URL="postgresql://postgres@localhost:5432/tenant_101" \
  pnpm exec tsx scripts/init/seed-realistic-data.ts
# Should create comprehensive test data

# 4. Verify both tenants work
psql -U postgres -d tenant_100 -c "SELECT COUNT(*) FROM clients;"
psql -U postgres -d tenant_101 -c "SELECT COUNT(*) FROM clients;"

# 5. Cleanup test tenants
psql -U postgres -c "DROP DATABASE IF EXISTS tenant_99;"
psql -U postgres -c "DROP DATABASE IF EXISTS tenant_100;"
psql -U postgres -c "DROP DATABASE IF EXISTS tenant_101;"
```

All scripts should execute without PostgreSQL errors.
</verification>

<success_criteria>
- ✅ create-tenant.ts creates tenant with 31 tables via migrations
- ✅ seed-base-data.ts creates minimal test data (5 clients, 3 members, 2 sessions, 1 invoice)
- ✅ seed-realistic-data.ts creates comprehensive test data (20 clients, 12 members, 12 sessions, 5 invoices)
- ✅ All scripts use current schema (vCard fields, company_members, deposit fields)
- ✅ TypeScript type safety throughout (postgres.js, no raw SQL)
- ✅ Zero PostgreSQL errors when running scripts
- ✅ Scripts follow DEVELOPMENT-WORKFLOW.md "increment tenant" pattern
</success_criteria>

<output>
After completion, create `.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-02-SUMMARY.md`
</output>
