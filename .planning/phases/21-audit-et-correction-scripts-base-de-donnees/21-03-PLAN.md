---
phase: 21-audit-et-correction-scripts-base-de-donnees
plan: 03
type: execute
wave: 3
depends_on: [21-02]
files_modified:
  - packages/database/scripts/archived/README.md
  - packages/database/scripts/README.md
autonomous: true

must_haves:
  truths:
    - "Obsolete scripts archived with clear explanation"
    - "Active scripts directory contains only current/working scripts"
    - "Documentation explains which scripts to use for what purpose"
  artifacts:
    - path: "packages/database/scripts/archived/README.md"
      provides: "Archival documentation explaining why scripts obsolete"
      min_lines: 50
    - path: "packages/database/scripts/README.md"
      provides: "Updated usage guide with Phase 21 recommendations"
      contains: "Use scripts/init/create-tenant.ts"
  key_links:
    - from: "archived/README.md"
      to: "../init/create-tenant.ts"
      via: "migration path documentation"
      pattern: "Use instead: scripts/init/create-tenant.ts"
---

<objective>
Archive obsolete database scripts and update documentation to guide developers toward current best practices.

Purpose: Clean up scripts directory so developers don't accidentally use outdated patterns, prevent future migration debugging sessions.

Output: Archived directory with obsolete scripts + documentation, updated README.md with clear usage guidance.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-RESEARCH.md
@.planning/DEVELOPMENT-WORKFLOW.md
@.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-01-SUMMARY.md
@.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-02-SUMMARY.md

# Audit results showing which scripts are obsolete
@packages/database/scripts/audit-report.md
</context>

<tasks>

<task type="auto">
  <name>Create archived directory and move obsolete scripts</name>
  <files>
    packages/database/scripts/archived/README.md
  </files>
  <action>
    Create `packages/database/scripts/archived/` directory and move obsolete scripts based on 21-01 audit:

    **Scripts to archive (based on RESEARCH.md compatibility matrix):**
    1. init-tenant.ts → archived/ (migration-based, fails when migrations skipped)
    2. add-new-tenant-tables.sql → archived/ (migration 0001-0002 only, now in base schema)
    3. fix-sessions-add-project-id.sql → archived/ (reactive patch for migration 0008)
    4. fix-tenant3-sessions-schema.sql → archived/ (reactive patch for migration 0003)
    5. seed-tenant-3.ts → archived/ (missing vCard fields, company_members)
    6. test-data/add-company-with-contacts.sql → archived/ (uses client_contacts, not company_members)
    7. test-data/setup-test-studio-ui.sql → archived/ (migration 0000-0002 era, missing 29+ columns)

    **Scripts to keep in root:**
    - create-tenant-3.ts (keep as example until 21-02 scripts tested)
    - deploy-master.sh (production deployment, still valid)
    - deploy-tenants.sh (production deployment, still valid)
    - migrate-status.sh (monitoring, still valid)
    - test-data/create-test-studio-user.sql (master schema, still valid)
    - test-data/validate-ui-complete.sh (UI validation, still valid)

    Create archived/README.md explaining:
    - Why each script was archived (specific schema incompatibility)
    - What replaced it (reference to scripts/init/)
    - When archived (Phase 21, 2026-01-17)
    - Historical context (Phases 10-17 schema evolution)
  </action>
  <verify>
    # Verify scripts moved
    ls packages/database/scripts/archived/
    # Should show: init-tenant.ts, add-new-tenant-tables.sql, fix-*.sql, seed-tenant-3.ts

    # Verify archive README exists
    cat packages/database/scripts/archived/README.md | head -20

    # Verify root scripts cleaned up
    ls packages/database/scripts/*.ts packages/database/scripts/*.sql 2>/dev/null | wc -l
    # Should be reduced (only deploy/migrate/create-tenant-3 remain)
  </verify>
  <done>
    7 obsolete scripts archived, archived/README.md explains why each was archived and what replaces it
  </done>
</task>

<task type="auto">
  <name>Update main README with Phase 21 guidance</name>
  <files>
    packages/database/scripts/README.md
  </files>
  <action>
    Rewrite `packages/database/scripts/README.md` to reflect Phase 21 state:

    **New structure:**

    # Database Scripts - Phase 21

    ## Quick Start (Development)

    ```bash
    # Create fresh tenant
    pnpm exec tsx scripts/init/create-tenant.ts

    # Seed minimal data
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_N" \
      pnpm exec tsx scripts/init/seed-base-data.ts

    # OR seed realistic data for UI testing
    DATABASE_URL="postgresql://postgres@localhost:5432/tenant_N" \
      pnpm exec tsx scripts/init/seed-realistic-data.ts
    ```

    ## Current Scripts (✅ Phase 21)

    | Script | Purpose | When to Use |
    |--------|---------|-------------|
    | `init/create-tenant.ts` | Create fresh tenant | Every time you need clean database |
    | `init/seed-base-data.ts` | Minimal test data | Quick testing, unit tests |
    | `init/seed-realistic-data.ts` | Comprehensive data | UI validation, manual testing |
    | `deploy-master.sh` | Deploy master migrations | Production deployments |
    | `deploy-tenants.sh` | Deploy tenant migrations | Production deployments |
    | `migrate-status.sh` | Check migration status | Debugging, monitoring |

    ## Development Workflow

    **IMPORTANT:** Read `.planning/DEVELOPMENT-WORKFLOW.md` first.

    **When schema changes or tenant breaks:**
    1. DO NOT try to fix migrations
    2. DO NOT debug schema desync
    3. DO increment tenant number: `create-tenant.ts` (auto-increments)
    4. DO apply fresh schema with current migrations

    **Why:** Saves 2-3 hours of debugging per incident (documented in Phases 18.1-18.3).

    ## Production Deployment

    [Keep existing production deployment docs]

    ## Archived Scripts

    See `archived/README.md` for obsolete scripts and migration history.

    **Phase 21 Audit Results:** 7/13 scripts archived, 3 new init scripts created, all compatible with current schema (31 tenant tables).

    Include warning about archived scripts (don't use them, use new init/ scripts instead).
  </action>
  <verify>
    # Check README has new structure
    grep "Phase 21" packages/database/scripts/README.md
    grep "init/create-tenant.ts" packages/database/scripts/README.md
    grep "DEVELOPMENT-WORKFLOW.md" packages/database/scripts/README.md

    # Verify table of current scripts
    grep "| Script | Purpose |" packages/database/scripts/README.md
  </verify>
  <done>
    README.md rewritten with Phase 21 guidance, clear quick start, references to DEVELOPMENT-WORKFLOW.md, archived scripts documented
  </done>
</task>

<task type="auto">
  <name>Commit script cleanup and documentation</name>
  <files>
    .git/
  </files>
  <action>
    Commit all Phase 21 changes with detailed commit message:

    ```bash
    cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid

    # Add new init scripts
    git add packages/database/scripts/init/

    # Add archived scripts
    git add packages/database/scripts/archived/

    # Add documentation
    git add packages/database/scripts/README.md
    git add packages/database/scripts/audit-report.md

    # Commit with structured message
    git commit -m "$(cat <<'EOF'
feat(21): audit and cleanup database scripts

Phase 21 Script Audit Complete:
- 13 scripts audited against current schema (7 master + 31 tenant tables)
- 7 obsolete scripts archived (migration-based init, reactive fixes)
- 3 new init scripts created (create-tenant, seed-base, seed-realistic)

New Scripts (scripts/init/):
- create-tenant.ts: Universal tenant creation with auto-increment
- seed-base-data.ts: Minimal test data (current schema)
- seed-realistic-data.ts: Comprehensive test data with faker.js

Archived Scripts (scripts/archived/):
- init-tenant.ts (migration-based, fails when migrations skipped)
- seed-tenant-3.ts (missing vCard fields, company_members)
- fix-*.sql (reactive patches now in base schema)
- add-new-tenant-tables.sql (migration 0001-0002 era)
- test-data/setup-test-studio-ui.sql (outdated columns)
- test-data/add-company-with-contacts.sql (client_contacts deprecated)

Documentation:
- README.md: Updated with Phase 21 guidance, quick start
- audit-report.md: Complete compatibility matrix (13 scripts)
- archived/README.md: Explains why scripts obsolete, what replaces them

Rationale:
- Prevents future "broken database" debugging (80+ min wasted in Phases 18.1-18.3)
- Follows DEVELOPMENT-WORKFLOW.md "increment tenant" pattern
- Scripts now compatible with current schema (Phases 10-20 additions)

See: .planning/phases/21-audit-et-correction-scripts-base-de-donnees/

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
EOF
)"
    ```
  </action>
  <verify>
    git log --oneline -1
    # Should show "feat(21): audit and cleanup database scripts"

    git diff --name-only HEAD~1 HEAD | sort
    # Should show:
    # packages/database/scripts/README.md
    # packages/database/scripts/archived/...
    # packages/database/scripts/audit-report.md
    # packages/database/scripts/init/...
  </verify>
  <done>
    All Phase 21 script changes committed, comprehensive commit message documents audit results and new patterns
  </done>
</task>

</tasks>

<verification>
Final verification:

```bash
cd /Users/marabook_m1/Documents/APP_HOME/CascadeProjects/windsurf-project/recording-studio-manager-hybrid/packages/database

# 1. Directory structure correct
tree scripts/ -L 2
# Should show:
# scripts/
# ├── README.md
# ├── audit-report.md
# ├── archived/
# │   ├── README.md
# │   └── [7 obsolete scripts]
# ├── init/
# │   ├── create-tenant.ts
# │   ├── seed-base-data.ts
# │   └── seed-realistic-data.ts
# ├── deploy-master.sh
# ├── deploy-tenants.sh
# └── migrate-status.sh

# 2. Documentation complete
grep "Phase 21" scripts/README.md
grep "archived" scripts/README.md

# 3. Commit successful
git log --oneline --grep="Phase 21" -1
```

All checks pass, Phase 21 complete.
</verification>

<success_criteria>
- ✅ 7 obsolete scripts moved to archived/ directory
- ✅ archived/README.md explains why each script obsolete
- ✅ Main README.md updated with Phase 21 guidance
- ✅ Quick start section references new init/ scripts
- ✅ Development workflow references DEVELOPMENT-WORKFLOW.md
- ✅ Git commit includes all Phase 21 changes with detailed message
- ✅ Directory structure clean (only current scripts in root)
</success_criteria>

<output>
After completion, create `.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-03-SUMMARY.md`
</output>
