---
phase: 21-audit-et-correction-scripts-base-de-donnees
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/scripts/README.md
  - packages/database/scripts/audit-report.md
autonomous: true

must_haves:
  truths:
    - "All database scripts audited against current schema (7 master + 31 tenant tables)"
    - "Script compatibility status documented (working/partial/obsolete)"
    - "Clear categorization of scripts by use case (init/seed/fix/deploy/monitor)"
  artifacts:
    - path: "packages/database/scripts/audit-report.md"
      provides: "Complete script compatibility matrix"
      min_lines: 100
    - path: "packages/database/scripts/README.md"
      provides: "Updated script usage documentation"
      contains: "Phase 21 audit results"
  key_links:
    - from: "audit-report.md"
      to: "21-RESEARCH.md"
      via: "references research findings"
      pattern: "See 21-RESEARCH.md"
---

<objective>
Audit all 13 existing database scripts against current schema (Phase 21 state: 7 master tables + 31 tenant tables) to identify obsolete scripts, document compatibility status, and establish baseline for cleanup.

Purpose: Prevent future "broken database" debugging sessions by understanding which scripts are safe to use with current schema vs which need updating/archiving.

Output: Complete audit report categorizing all scripts by compatibility status, use case, and action required.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-RESEARCH.md
@.planning/DEVELOPMENT-WORKFLOW.md

# Current schema state
@packages/database/src/master/schema.ts
@packages/database/src/tenant/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Test all scripts against current schema</name>
  <files>
    packages/database/scripts/audit-report.md
  </files>
  <action>
    Test each of the 13 database scripts:

    **Root scripts (9):**
    1. init-tenant.ts - Attempt to create tenant_test_audit
    2. create-tenant-3.ts - Review code, check schema references
    3. seed-tenant-3.ts - Check for missing vCard fields, company_members
    4. deploy-master.sh - Verify migration path
    5. deploy-tenants.sh - Verify migration path
    6. migrate-status.sh - Run against current databases
    7. add-new-tenant-tables.sql - Check SQL against current schema
    8. fix-sessions-add-project-id.sql - Check if already in schema
    9. fix-tenant3-sessions-schema.sql - Check if already in schema

    **Test data scripts (4):**
    10. setup-test-studio-ui.sql - Check column names (first_name vs firstName)
    11. create-test-studio-user.sql - Check master schema compatibility
    12. add-company-with-contacts.sql - Check client_contacts vs company_members
    13. validate-ui-complete.sh - Check file paths

    For EACH script document:
    - Status: WORKING ✅ / PARTIAL ⚠️ / OBSOLETE ❌
    - Schema version: Which migration era (0-5, 6-8, 9-11, current)
    - Issues found: Missing columns, deprecated tables, wrong patterns
    - Action required: UPDATE / ARCHIVE / KEEP AS-IS

    Create audit-report.md with compatibility matrix table.
  </action>
  <verify>
    cat packages/database/scripts/audit-report.md
    # Should contain 13 script entries with status/issues/actions
  </verify>
  <done>
    Audit report exists with all 13 scripts documented, compatibility matrix complete, clear action items identified
  </done>
</task>

<task type="auto">
  <name>Categorize scripts by use case</name>
  <files>
    packages/database/scripts/audit-report.md
  </files>
  <action>
    Add categorization section to audit report grouping scripts:

    **INIT (tenant creation):**
    - init-tenant.ts (migration-based)
    - create-tenant-3.ts (manual SQL)

    **SEED (test data):**
    - seed-tenant-3.ts
    - setup-test-studio-ui.sql
    - create-test-studio-user.sql
    - add-company-with-contacts.sql

    **FIX (reactive patches):**
    - fix-sessions-add-project-id.sql
    - fix-tenant3-sessions-schema.sql
    - add-new-tenant-tables.sql

    **DEPLOY (production):**
    - deploy-master.sh
    - deploy-tenants.sh

    **MONITOR (status checks):**
    - migrate-status.sh
    - validate-ui-complete.sh

    For each category:
    - Count working vs obsolete
    - Identify critical gaps (e.g., no working seed script for current schema)
    - Recommend actions (create new, update existing, archive obsolete)
  </action>
  <verify>
    grep -A 20 "Category Summary" packages/database/scripts/audit-report.md
    # Should show 5 categories with script counts and recommendations
  </verify>
  <done>
    Scripts categorized by use case, category summaries show working/obsolete counts, recommendations documented
  </done>
</task>

<task type="auto">
  <name>Update README.md with audit results</name>
  <files>
    packages/database/scripts/README.md
  </files>
  <action>
    Update README.md to include:

    **Phase 21 Audit Results section:**
    - Link to audit-report.md
    - Summary: X/13 scripts obsolete, Y need updates, Z working
    - Warning about migration-based scripts (init-tenant.ts)
    - Recommendation to use "increment tenant" pattern (DEVELOPMENT-WORKFLOW.md)

    **Current Best Practices section:**
    - Fresh tenant creation: Use create-tenant-N.ts pattern
    - Test data: Use TypeScript seeds with current schema
    - Avoid: Migration-based init, SQL fix scripts
    - Production: deploy-*.sh scripts still valid

    **Script Status Table:**
    - Quick reference showing each script's status
    - Link to audit-report.md for details

    Keep existing deployment documentation, add audit context.
  </action>
  <verify>
    grep -A 10 "Phase 21 Audit" packages/database/scripts/README.md
    # Should contain summary and link to audit-report.md
  </verify>
  <done>
    README.md updated with Phase 21 audit results, best practices documented, script status table added
  </done>
</task>

</tasks>

<verification>
Run verification checks:

```bash
# 1. Audit report exists and complete
test -f packages/database/scripts/audit-report.md && \
  grep -c "Status:" packages/database/scripts/audit-report.md
# Should output: 13 (one per script)

# 2. README updated
grep "Phase 21 Audit" packages/database/scripts/README.md

# 3. Category summaries present
grep "Category Summary" packages/database/scripts/audit-report.md

# 4. All files committed
git add packages/database/scripts/audit-report.md packages/database/scripts/README.md
git status --short
```

All checks should pass, showing audit complete and documentation updated.
</verification>

<success_criteria>
- ✅ audit-report.md created with 13 script entries
- ✅ Each script has status (WORKING/PARTIAL/OBSOLETE) documented
- ✅ Scripts categorized into 5 use cases (INIT/SEED/FIX/DEPLOY/MONITOR)
- ✅ Category summaries show working vs obsolete counts
- ✅ README.md updated with Phase 21 audit results
- ✅ Best practices section references DEVELOPMENT-WORKFLOW.md
- ✅ Clear action items identified (which scripts to update/archive in next plans)
</success_criteria>

<output>
After completion, create `.planning/phases/21-audit-et-correction-scripts-base-de-donnees/21-01-SUMMARY.md`
</output>
