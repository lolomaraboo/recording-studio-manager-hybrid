---
phase: 3.10-test-clients-enrichis-vcard
plan: 02
type: execute
---

<objective>
Valider les fonctionnalités d'import et export de clients dans les formats vCard (.vcf), Excel (.xlsx) et CSV (.csv).

Purpose: S'assurer que le système d'import/export fonctionne parfaitement avec les données enrichies vCard 4.0 avant le lancement marketing.
Output: Confirmation que tous les formats d'import/export fonctionnent et préservent l'intégrité des données.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3.10-test-clients-enrichis-vcard/3.10-01-SUMMARY.md

**Services d'import/export implémentés:**
- vcard-service.ts (280 lignes) - RFC 6350 compliant
- excel-service.ts (160 lignes) - ExcelJS library
- csv-service.ts (58 lignes) - CSV parsing/generation

**Procédures tRPC créées:**
- clients.exportVCard - Export individuel ou multiple en vCard 4.0
- clients.exportExcel - Export vers fichier Excel avec toutes colonnes
- clients.exportCSV - Export vers fichier CSV
- clients.importVCard - Import depuis fichier .vcf
- clients.importExcel - Import depuis fichier .xlsx
- clients.importCSV - Import depuis fichier .csv
- clients.downloadExcelTemplate - Téléchargement template Excel vierge

**Composant frontend:**
@packages/client/src/components/ImportClientsDialog.tsx (161 lignes)
@packages/client/src/pages/Clients.tsx (menus Export/Import)

**Mapping vCard standard:**
- FN (Formatted Name) → name
- N (Structured Name) → lastName;firstName;middleName;prefix;suffix
- TEL (Telephone) → phones[] array
- EMAIL → emails[] array
- ADR (Address) → street, city, postalCode, region, country
- ORG (Organization) → company name
- PHOTO/LOGO → avatarUrl/logoUrl (base64 or URL)
- BDAY (Birthday) → birthday
- GENDER → gender
- NOTE → notes
- X-* (Custom) → customFields[]
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Système d'import de clients depuis vCard, Excel et CSV</what-built>
  <how-to-verify>
    **Étape 1: Préparation - Créer des clients de test**
    1. Ouvrir https://recording-studio-manager.com/clients/new
    2. Créer 3 clients avec données enrichies complètes:
       - Client 1 (Individual): "Alice Martin" avec avatar, 2 phones, 2 emails, adresse complète
       - Client 2 (Individual): "Bob Durand" avec avatar, 1 phone, 1 email, custom field "Spotify"
       - Client 3 (Company): "Productions XYZ" avec logo, standard phone, contact email

    **Étape 2: Test import vCard (.vcf)**
    3. Préparer un fichier test `test-import.vcf` avec ce contenu:
       ```
       BEGIN:VCARD
       VERSION:4.0
       FN:Charlie Rousseau
       N:Rousseau;Charlie;Marie;;M.;
       TEL;TYPE=mobile:+33612345678
       TEL;TYPE=work:+33142424242
       EMAIL;TYPE=work:charlie@work.com
       EMAIL;TYPE=home:charlie@gmail.com
       ADR;TYPE=work:;;10 Rue de la Paix;Paris;Île-de-France;75002;France
       BDAY:19900315
       GENDER:M
       NOTE:Client import test vCard
       X-INSTAGRAM:@charlierocks
       END:VCARD
       ```
    4. Sur https://recording-studio-manager.com/clients
    5. Cliquer menu "Importer" → "vCard (.vcf)"
    6. Sélectionner le fichier `test-import.vcf`
    7. Cliquer "Importer"
    8. Vérifier toast de succès "X clients importés avec succès"
    9. Vérifier que "Charlie Rousseau" apparaît dans la liste des clients
    10. Cliquer sur "Charlie Rousseau" pour ouvrir ClientDetail
    11. Onglet "Informations enrichies":
        - Nom structuré: "M. Charlie Marie Rousseau"
        - 2 téléphones: Mobile +336..., Travail +331...
        - 2 emails: work + home
        - Adresse: 10 Rue de la Paix, 75002 Paris
        - Date de naissance: 15/03/1990
        - Genre: Homme
        - Notes: "Client import test vCard"
        - Custom field: Instagram = @charlierocks

    **Étape 3: Test téléchargement template Excel**
    12. Sur /clients, menu "Importer" → "Excel (.xlsx)"
    13. Cliquer "Télécharger le template"
    14. Vérifier qu'un fichier `clients-template.xlsx` se télécharge
    15. Ouvrir le fichier Excel
    16. Vérifier les colonnes présentes:
        - name (requis)
        - type (individual/company)
        - email, phone, address, city, postalCode, country
        - firstName, lastName, middleName, prefix, suffix
        - notes
        - (toutes les colonnes vCard standard)
    17. Vérifier la ligne d'exemple avec données de démonstration

    **Étape 4: Test import Excel (.xlsx)**
    18. Dans le template téléchargé, ajouter 2 lignes:
        - Ligne 2: name="David Leroy", type="individual", firstName="David", lastName="Leroy", phone="+33698765432", email="david@test.com", city="Lyon"
        - Ligne 3: name="Studio Beta", type="company", phone="+33499887766", email="contact@beta.com", city="Marseille"
    19. Sauvegarder le fichier Excel
    20. Sur /clients, menu "Importer" → "Excel (.xlsx)"
    21. Sélectionner le fichier modifié
    22. Cliquer "Importer"
    23. Vérifier toast de succès "2 clients importés"
    24. Vérifier que "David Leroy" et "Studio Beta" apparaissent dans la liste
    25. Ouvrir "David Leroy":
        - Type: individual
        - Nom structuré présent
        - Téléphone: +33698765432
        - Email: david@test.com
        - Ville: Lyon
    26. Ouvrir "Studio Beta":
        - Type: company
        - Téléphone standard
        - Email contact

    **Étape 5: Test import CSV (.csv)**
    27. Créer un fichier `test-import.csv` avec ce contenu:
        ```csv
        name,type,firstName,lastName,phone,email,city,postalCode,country
        "Emma Garcia",individual,Emma,Garcia,+33687654321,emma@mail.com,Toulouse,31000,France
        "Productions Omega",company,,,+33467891234,info@omega.com,Montpellier,34000,France
        ```
    28. Sur /clients, menu "Importer" → "CSV (.csv)"
    29. Sélectionner le fichier `test-import.csv`
    30. Cliquer "Importer"
    31. Vérifier toast de succès "2 clients importés"
    32. Vérifier que "Emma Garcia" et "Productions Omega" apparaissent
    33. Ouvrir "Emma Garcia" et vérifier les données importées

    **Étape 6: Test gestion erreurs import**
    34. Créer fichier invalide `invalid.vcf`:
        ```
        BEGIN:VCARD
        VERSION:4.0
        (ligne manquante FN)
        END:VCARD
        ```
    35. Tenter import → Vérifier message d'erreur clair
    36. Créer fichier Excel sans colonne "name"
    37. Tenter import → Vérifier message d'erreur "Colonne 'name' requise"
    38. Créer CSV avec format invalide (guillemets non fermés)
    39. Tenter import → Vérifier gestion erreur parsing

    **Étape 7: Validation base de données après imports**
    40. SSH sur VPS, connexion PostgreSQL
    41. Vérifier clients importés:
        ```sql
        SELECT name, type, "firstName", "lastName", phones, emails, "createdAt"
        FROM clients
        WHERE name IN ('Charlie Rousseau', 'David Leroy', 'Emma Garcia', 'Studio Beta', 'Productions Omega')
        ORDER BY "createdAt" DESC;
        ```
    42. Vérifier que:
        - Charlie Rousseau: type='individual', phones JSON array correct, emails JSON array correct
        - Tous les clients importés ont createdAt récent
        - Données correspondent exactement aux fichiers importés
  </how-to-verify>
  <resume-signal>Taper "approved" si tous les imports fonctionnent, ou décrire les problèmes</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Système d'export de clients vers vCard, Excel et CSV</what-built>
  <how-to-verify>
    **Étape 1: Test export vCard (.vcf)**
    1. Sur https://recording-studio-manager.com/clients
    2. Vérifier qu'au moins 5 clients existent (3 créés en 3.10-01 + imports)
    3. Menu "Exporter" → "vCard (.vcf)"
    4. Vérifier qu'un fichier `clients-export.vcf` se télécharge
    5. Ouvrir le fichier .vcf dans un éditeur texte
    6. Vérifier la structure vCard 4.0:
       ```
       BEGIN:VCARD
       VERSION:4.0
       FN:Alice Martin
       N:Martin;Alice;;;
       TEL;TYPE=mobile:+33612345678
       TEL;TYPE=work:+33142424242
       EMAIL;TYPE=work:alice@work.com
       EMAIL;TYPE=home:alice@home.com
       ADR;TYPE=work:;;123 Rue...;Paris;;75001;France
       PHOTO:data:image/jpeg;base64,... (ou URL)
       NOTE:...
       END:VCARD
       BEGIN:VCARD
       (client suivant)
       ...
       ```
    7. Vérifier que TOUS les clients de la liste sont dans le fichier
    8. Vérifier conformité RFC 6350:
       - VERSION:4.0 présent
       - FN (nom formatté) présent pour chaque client
       - N (nom structuré) pour les individuals
       - TEL avec TYPE correct
       - EMAIL avec TYPE correct
       - ADR avec structure correcte (;;rue;ville;région;CP;pays)
       - PHOTO/LOGO pour clients avec avatar/logo
       - Pas de caractères spéciaux cassés (UTF-8)

    **Étape 2: Test export Excel (.xlsx)**
    9. Menu "Exporter" → "Excel (.xlsx)"
    10. Vérifier qu'un fichier `clients-export.xlsx` se télécharge
    11. Ouvrir le fichier Excel
    12. Vérifier les colonnes:
        - name, type, email, phone, address, city, postalCode, country
        - firstName, lastName, middleName, prefix, suffix, artistName
        - notes, createdAt
        - (toutes colonnes vCard)
    13. Vérifier que toutes les lignes contiennent les données clients
    14. Vérifier formatage:
        - Dates au format DD/MM/YYYY
        - Téléphones formatés correctement
        - Arrays (phones, emails) convertis en texte lisible
    15. Vérifier que les clients individual et company sont différenciés (colonne type)

    **Étape 3: Test export CSV (.csv)**
    16. Menu "Exporter" → "CSV (.csv)"
    17. Vérifier qu'un fichier `clients-export.csv` se télécharge
    18. Ouvrir le fichier CSV (Excel ou éditeur texte)
    19. Vérifier:
        - Header présent avec tous les noms de colonnes
        - Délimiteur: virgule
        - Guillemets pour champs contenant virgules
        - Encodage UTF-8 (accents préservés)
        - Toutes lignes présentes (nombre = nombre clients)

    **Étape 4: Test round-trip (export → import)**
    20. Exporter tous les clients en vCard: `clients-roundtrip.vcf`
    21. Supprimer 1 client de test (ex: "Emma Garcia")
    22. Importer le fichier `clients-roundtrip.vcf`
    23. Vérifier que "Emma Garcia" réapparaît dans la liste
    24. Ouvrir "Emma Garcia" → Onglet "Informations enrichies"
    25. Vérifier que TOUTES les données sont identiques à avant suppression:
        - Nom structuré correct
        - Téléphones identiques
        - Emails identiques
        - Adresse complète
        - Custom fields préservés
        - Avatar/logo URL présent (si applicable)
    26. Répéter test round-trip avec Excel:
        - Export Excel → Supprimer client → Import Excel → Vérifier données identiques
    27. Répéter test round-trip avec CSV:
        - Export CSV → Supprimer client → Import CSV → Vérifier données identiques

    **Étape 5: Test export client individuel (depuis ClientDetail)**
    28. Ouvrir un client (ex: "Alice Martin")
    29. Chercher bouton "Exporter en vCard" (ou menu Actions → Exporter)
    30. Cliquer pour exporter ce client seul
    31. Vérifier fichier `alice-martin.vcf` téléchargé
    32. Ouvrir le fichier
    33. Vérifier qu'il contient SEULEMENT Alice Martin (pas les autres clients)
    34. Vérifier données complètes: FN, N, TEL, EMAIL, ADR, PHOTO, etc.

    **Étape 6: Test performance export large dataset**
    35. Si <10 clients existent, créer 10+ clients additionnels rapidement
    36. Exporter vCard avec 15-20 clients
    37. Vérifier que:
        - Export termine en <5 secondes
        - Fichier téléchargé contient tous les clients
        - Pas d'erreur de timeout
    38. Exporter Excel avec 15-20 clients
    39. Vérifier performance acceptable (<5s)
    40. Exporter CSV avec 15-20 clients
    41. Vérifier performance acceptable (<3s)

    **Étape 7: Validation données exportées**
    42. Prendre un client avec données enrichies complètes (ex: "Jean Paul Dupont Jr." créé en 3.10-01)
    43. Exporter en vCard
    44. Vérifier dans le .vcf:
        - FN:M. Jean Paul Dupont Jr.
        - N:Dupont;Jean;Paul;M.;Jr.
        - TEL avec types Mobile et Travail
        - EMAIL avec types Personnel et Travail
        - URL pour site web
        - ADR avec adresse structurée (;;rue;ville;région;CP;pays)
        - BDAY:1985-03-15
        - GENDER:M
        - NOTE contient les notes
        - X-INSTAGRAM:@jplerappeur (custom field)
        - X-BUDGET:5000 (custom field)
        - PHOTO ou URL vers avatar
    45. Exporter en Excel
    46. Vérifier que chaque colonne contient la valeur correcte
    47. Vérifier que phones/emails sont formatés lisiblement (pas juste "[object Object]")
  </how-to-verify>
  <resume-signal>Taper "approved" si tous les exports fonctionnent et préservent l'intégrité des données, ou décrire les problèmes</resume-signal>
</task>

</tasks>

<verification>
Avant de déclarer le plan complet:
- [ ] Import vCard (.vcf) fonctionne avec mapping correct des champs
- [ ] Import Excel (.xlsx) fonctionne avec template téléchargeable
- [ ] Import CSV (.csv) fonctionne avec parsing correct
- [ ] Gestion d'erreurs import (fichiers invalides, colonnes manquantes)
- [ ] Export vCard (.vcf) génère RFC 6350 compliant
- [ ] Export Excel (.xlsx) contient toutes colonnes et données
- [ ] Export CSV (.csv) formaté correctement (UTF-8, délimiteurs)
- [ ] Round-trip export → import préserve 100% des données
- [ ] Export client individuel fonctionne
- [ ] Performance acceptable pour 15-20 clients (export <5s)
- [ ] Données enrichies (phones[], emails[], customFields[]) préservées
- [ ] Avatar/logo URLs préservés dans exports
</verification>

<success_criteria>
- Tous les formats d'import (vCard, Excel, CSV) fonctionnent
- Tous les formats d'export (vCard, Excel, CSV) fonctionnent
- Round-trip (export → suppression → import) préserve 100% des données
- Template Excel téléchargeable et utilisable
- Gestion d'erreurs robuste pour fichiers invalides
- Performance acceptable (<5s) pour datasets normaux (15-20 clients)
- Conformité RFC 6350 pour vCard 4.0
- Encodage UTF-8 correct (accents, caractères spéciaux)
- Export client individuel fonctionnel
</success_criteria>

<output>
Après complétion, créer `.planning/phases/3.10-test-clients-enrichis-vcard/3.10-02-SUMMARY.md`:

# Phase 3.10-02: Test Import/Export vCard/Excel/CSV - Summary

**Validation système import/export clients avec intégrité données vCard 4.0**

## Accomplishments

- Testé imports: vCard (.vcf), Excel (.xlsx), CSV (.csv)
- Testé exports: vCard (.vcf), Excel (.xlsx), CSV (.csv)
- Validé round-trip export → import sans perte de données
- Confirmé template Excel téléchargeable
- Vérifié gestion d'erreurs pour fichiers invalides
- Testé performance pour 15-20 clients
- Validé conformité RFC 6350 pour vCard
- Confirmé encodage UTF-8 correct

## Tests Réalisés

### Imports
- [✓/✗] Import vCard avec mapping champs correct
- [✓/✗] Import Excel avec template
- [✓/✗] Import CSV avec parsing
- [✓/✗] Gestion erreurs (fichiers invalides)
- [✓/✗] Données importées visibles dans liste
- [✓/✗] Données importées complètes dans ClientDetail

### Exports
- [✓/✗] Export vCard RFC 6350 compliant
- [✓/✗] Export Excel avec toutes colonnes
- [✓/✗] Export CSV formaté correctement
- [✓/✗] Export client individuel fonctionne
- [✓/✗] Performance <5s pour 15-20 clients

### Round-trip
- [✓/✗] vCard: export → import préserve données
- [✓/✗] Excel: export → import préserve données
- [✓/✗] CSV: export → import préserve données
- [✓/✗] Arrays (phones, emails, websites) préservés
- [✓/✗] Custom fields préservés
- [✓/✗] Avatar/logo URLs préservés

## Issues Encountered

[Liste des problèmes, ou "Aucun"]

## Files Verified

- packages/server/src/utils/vcard-service.ts (génération vCard)
- packages/server/src/utils/excel-service.ts (génération Excel)
- packages/server/src/utils/csv-service.ts (génération CSV)
- packages/server/src/routers/clients.ts (procédures import/export)
- packages/client/src/components/ImportClientsDialog.tsx (UI import)

## Next Step

Ready for Phase 3.10-03: Test CRUD Complet & Modes Affichage
</output>
