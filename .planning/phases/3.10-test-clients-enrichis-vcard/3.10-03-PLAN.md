---
phase: 3.10-test-clients-enrichis-vcard
plan: 03
type: execute
---

<objective>
Valider les opérations UPDATE et DELETE pour clients enrichis, tester les contacts d'entreprise, et vérifier les modes d'affichage Table/Grid/Kanban.

Purpose: S'assurer que toutes les opérations CRUD fonctionnent avec les données enrichies et que l'UX des différents modes d'affichage est optimale.
Output: Confirmation que UPDATE/DELETE préservent l'intégrité des données, contacts entreprise fonctionnels, et modes d'affichage opérationnels.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3.10-test-clients-enrichis-vcard/3.10-01-SUMMARY.md
@.planning/phases/3.10-test-clients-enrichis-vcard/3.10-02-SUMMARY.md

**Fonctionnalités à tester:**
1. UPDATE client enrichi avec modification de tous les champs vCard
2. Gestion contacts d'entreprise (table clientContacts)
   - Add contact à un client company
   - Update contact existant
   - Delete contact
3. DELETE client avec vérification cascade (contacts, sessions, invoices)
4. Modes d'affichage liste clients (Clients.tsx)
   - Vue Table (défaut)
   - Vue Grid (si implémentée)
   - Vue Kanban (si implémentée)

**Composants frontend:**
@packages/client/src/pages/Clients.tsx (vues multiples + stats)
@packages/client/src/pages/ClientDetail.tsx (onglet enrichi + édition)
@packages/client/src/components/EnrichedClientInfo.tsx (UI enrichie éditable)

**Procédures backend:**
@packages/server/src/routers/clients.ts:
- clients.update - Mutation UPDATE avec tous champs vCard
- clients.delete - Mutation DELETE avec cascade
- clients.getWithContacts - Query client + contacts
- clients.addContact - Mutation ajout contact entreprise
- clients.updateContact - Mutation modification contact
- clients.deleteContact - Mutation suppression contact

**Base de données:**
- Table clients avec 16+ champs vCard
- Table clientContacts (relation 1:N avec clients)
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Opération UPDATE pour clients enrichis avec modification de tous les champs vCard</what-built>
  <how-to-verify>
    **Étape 1: Préparation - Identifier un client de test**
    1. Ouvrir https://recording-studio-manager.com/clients
    2. Sélectionner un client individual créé en 3.10-01 (ex: "Jean Paul Dupont Jr.")
    3. Noter les données actuelles

    **Étape 2: Test UPDATE champs vCard via onglet "Informations enrichies"**
    4. Ouvrir le client → Onglet "Informations enrichies"
    5. Cliquer bouton "Modifier" (activer mode édition)
    6. Modifier le nom structuré:
       - Civilité: "Dr." (au lieu de "M.")
       - Prénom: "Jean-Pierre" (au lieu de "Jean")
       - Suffixe: "III" (au lieu de "Jr.")
    7. Modifier nom d'artiste: "JP le Producteur" (au lieu de "JP le Rappeur")
    8. Section Téléphones:
       - Modifier le premier téléphone: changer type de "Mobile" à "Travail"
       - Modifier le numéro: "+33 6 99 88 77 66"
       - Cliquer "Supprimer" sur le deuxième téléphone
       - Cliquer "Ajouter un téléphone"
       - Type: "Domicile", Numéro: "+33 1 23 45 67 89"
    9. Section Emails:
       - Modifier le premier email: changer type à "Principal"
       - Modifier l'adresse: "jp.dupont@newmail.com"
       - Ajouter un email: Type "Autre", Email "contact@jpmusic.fr"
    10. Section Sites web:
        - Modifier l'URL existante: "https://jp-productions.com"
        - Ajouter un site: Type "Social", URL "https://instagram.com/jpproductions"
    11. Section Adresse:
        - Modifier rue: "456 Boulevard Haussmann"
        - Modifier code postal: "75009"
    12. Section Info:
        - Modifier date de naissance: Choisir nouvelle date (01/01/1990)
        - Modifier genre: "Non binaire"
    13. Section Champs personnalisés:
        - Modifier "Instagram": "@jp_prod_official"
        - Modifier "Budget mensuel": "10000"
        - Supprimer le champ "Instagram" (cliquer bouton supprimer)
        - Ajouter nouveau champ: Label "TikTok", Type "text", Valeur "@jpproductions"
    14. Section Notes:
        - Modifier: "Client VIP - producteur hip-hop international - Budget augmenté 2025"
    15. Cliquer "Enregistrer"
    16. Vérifier toast de succès "Client mis à jour"
    17. Vérifier sortie du mode édition

    **Étape 3: Validation modifications persistées**
    18. Recharger la page (F5)
    19. Onglet "Informations enrichies"
    20. Vérifier que TOUTES les modifications sont présentes:
        - Nom: "Dr. Jean-Pierre Paul Dupont III"
        - Nom d'artiste: "JP le Producteur"
        - 2 téléphones: Travail +33699..., Domicile +33123...
        - 3 emails: Principal, Travail, Autre
        - 2 sites web: productions.com, instagram.com
        - Adresse: 456 Boulevard Haussmann, 75009
        - Date naissance: 01/01/1990
        - Genre: Non binaire
        - Custom fields: Budget 10000, TikTok @jpproductions (Instagram supprimé)
        - Notes: texte modifié présent

    **Étape 4: Test UPDATE avatar/logo**
    21. Mode édition
    22. Section Avatar (ou Logo si company):
        - Cliquer "Choisir un avatar" (bouton upload)
        - Sélectionner une NOUVELLE image (différente de celle uploadée en création)
        - Vérifier que la preview se met à jour immédiatement
    23. Cliquer "Enregistrer"
    24. Recharger page
    25. Vérifier que le NOUVEL avatar est affiché (pas l'ancien)

    **Étape 5: Test UPDATE via formulaire principal (onglet Détails)**
    26. Onglet "Détails" (premier onglet)
    27. Cliquer "Modifier"
    28. Modifier champ "Email": "newemail@test.com"
    29. Modifier champ "Téléphone": "+33 7 11 22 33 44"
    30. Modifier "Notes": "Notes modifiées depuis onglet Détails"
    31. Cliquer "Enregistrer"
    32. Vérifier toast succès
    33. Basculer sur onglet "Informations enrichies"
    34. Vérifier que l'email et le téléphone principaux sont mis à jour
    35. Vérifier que les notes sont modifiées

    **Étape 6: Validation base de données après UPDATE**
    36. SSH sur VPS production
    37. Connexion PostgreSQL:
        ```bash
        docker exec -it rsm-postgres psql -U postgres -d tenant_org_1
        ```
    38. Query le client modifié:
        ```sql
        SELECT id, name, "firstName", "lastName", prefix, suffix, "artistName",
               phones, emails, websites, "customFields", notes, "avatarUrl", "updatedAt"
        FROM clients
        WHERE id = [ID_DU_CLIENT];
        ```
    39. Vérifier que:
        - firstName = 'Jean-Pierre' (modifié)
        - prefix = 'Dr.' (modifié)
        - suffix = 'III' (modifié)
        - artistName = 'JP le Producteur' (modifié)
        - phones JSON contient 2 entrées (Travail, Domicile)
        - emails JSON contient 3 entrées
        - websites JSON contient 2 entrées
        - customFields JSON contient TikTok, Budget (Instagram supprimé)
        - notes = texte modifié
        - avatarUrl pointe vers nouvelle image
        - updatedAt est récent (timestamp de la modification)
  </how-to-verify>
  <resume-signal>Taper "approved" si toutes les modifications UPDATE fonctionnent, ou décrire les problèmes</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Gestion des contacts d'entreprise (table clientContacts) avec CRUD complet</what-built>
  <how-to-verify>
    **Étape 1: Préparation - Client company**
    1. Ouvrir un client de type "company" (ex: "Studio Atlantique Records" créé en 3.10-01)
    2. Aller sur onglet "Informations enrichies"
    3. Vérifier que la section "Contacts entreprise" est présente

    **Étape 2: Test ADD contact**
    4. Mode édition
    5. Section "Contacts entreprise"
    6. Cliquer "Ajouter un contact"
    7. Remplir le formulaire contact:
       - Prénom: "Sophie"
       - Nom: "Durand"
       - Titre/Poste: "Directrice Artistique"
       - Email: "sophie.durand@studio-atlantique.fr"
       - Téléphone: "+33 6 12 34 56 78"
       - Case "Contact principal": cocher
    8. Cliquer "Enregistrer" (du contact)
    9. Vérifier que le contact apparaît dans la liste des contacts
    10. Ajouter un deuxième contact:
        - Prénom: "Marc", Nom: "Leroy"
        - Titre: "Ingénieur du son"
        - Email: "marc@studio-atlantique.fr"
        - Téléphone: "+33 6 98 76 54 32"
        - Contact principal: NON coché
    11. Cliquer "Enregistrer" (modifications client)
    12. Vérifier toast succès

    **Étape 3: Validation contacts créés**
    13. Recharger la page
    14. Onglet "Informations enrichies" → Section "Contacts entreprise"
    15. Vérifier que 2 contacts sont affichés:
        - Sophie Durand - Directrice Artistique (PRINCIPAL)
        - Marc Leroy - Ingénieur du son
    16. Vérifier badge "Principal" sur Sophie
    17. Vérifier email et téléphone affichés pour chaque contact

    **Étape 4: Test UPDATE contact**
    18. Mode édition
    19. Sélectionner contact "Marc Leroy"
    20. Modifier:
        - Titre: "Responsable Technique" (au lieu de "Ingénieur du son")
        - Email: "marc.leroy@studio-atlantique.fr"
        - Case "Contact principal": COCHER (faire de Marc le nouveau contact principal)
    21. Cliquer "Enregistrer"
    22. Recharger page
    23. Vérifier que:
        - Marc Leroy a badge "Principal"
        - Sophie Durand n'a PLUS badge "Principal" (un seul contact principal)
        - Titre de Marc est "Responsable Technique"
        - Email mis à jour

    **Étape 5: Test DELETE contact**
    24. Mode édition
    25. Sélectionner contact "Sophie Durand"
    26. Cliquer bouton "Supprimer" (icône poubelle)
    27. Vérifier dialog de confirmation: "Supprimer ce contact ?"
    28. Confirmer suppression
    29. Vérifier que Sophie Durand disparaît de la liste
    30. Cliquer "Enregistrer" (modifications client)
    31. Recharger page
    32. Vérifier qu'il ne reste que Marc Leroy dans les contacts

    **Étape 6: Test contrainte "au moins un contact principal"**
    33. Mode édition
    34. Essayer de décocher "Contact principal" sur Marc (seul contact restant)
    35. Vérifier message d'erreur: "Au moins un contact doit être principal"
    36. Ou vérifier que la case reste cochée automatiquement

    **Étape 7: Validation base de données contacts**
    37. SSH VPS, connexion PostgreSQL
    38. Query contacts:
        ```sql
        SELECT id, "clientId", "firstName", "lastName", title, email, phone, "isPrimary"
        FROM client_contacts
        WHERE "clientId" = [ID_CLIENT_COMPANY]
        ORDER BY "isPrimary" DESC, "createdAt";
        ```
    39. Vérifier que:
        - 1 contact présent (Marc Leroy)
        - title = 'Responsable Technique'
        - email = 'marc.leroy@studio-atlantique.fr'
        - isPrimary = true
        - Sophie Durand n'est PLUS présent (supprimé)
    40. Vérifier clé étrangère:
        ```sql
        SELECT c.name, cc."firstName", cc."lastName"
        FROM clients c
        LEFT JOIN client_contacts cc ON c.id = cc."clientId"
        WHERE c.id = [ID_CLIENT_COMPANY];
        ```
    41. Confirmer relation client ↔ contacts correcte
  </how-to-verify>
  <resume-signal>Taper "approved" si CRUD contacts fonctionne, ou décrire les problèmes</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Modes d'affichage Table/Grid/Kanban et opération DELETE avec données enrichies</what-built>
  <how-to-verify>
    **Étape 1: Test modes d'affichage (Clients.tsx)**
    1. Ouvrir https://recording-studio-manager.com/clients
    2. Vérifier qu'il y a 10+ clients dans la liste (créés + importés)
    3. Chercher les boutons de basculement de vue en haut de la page:
       - Icône Table (défaut)
       - Icône Grid (grille)
       - Icône Kanban
    4. **Si les boutons existent:**
       - Cliquer sur icône Grid
       - Vérifier que l'affichage bascule en mode grille (cards)
       - Vérifier que chaque card affiche:
         - Avatar/logo (si présent)
         - Nom client
         - Type (individual/company)
         - Email principal
         - Téléphone principal
         - Stats (sessions, revenue, last session)
       - Cliquer sur icône Kanban
       - Vérifier affichage kanban par statut (colonnes: Actif, Inactif, VIP, etc.)
       - Cliquer sur icône Table pour revenir à la vue par défaut
    5. **Si les boutons n'existent PAS:**
       - Noter: "Modes Grid/Kanban non implémentés"
       - Vérifier que la vue Table affiche:
         - Colonne Avatar/Logo (image thumbnail)
         - Colonne Nom
         - Colonne Type (badge individual/company)
         - Colonne Email
         - Colonne Téléphone
         - Colonne Dernière session
         - Colonne Revenue total
         - Colonne Actions (voir/modifier/supprimer)

    **Étape 2: Test recherche avec données enrichies**
    6. Dans la barre de recherche en haut de /clients
    7. Taper "Jean" → Vérifier que "Jean-Pierre Dupont" apparaît
    8. Taper "jp" → Vérifier que les clients avec "jp" dans nom ou artistName apparaissent
    9. Taper "+336" → Vérifier recherche par téléphone fonctionne
    10. Taper "@gmail" → Vérifier recherche par email fonctionne
    11. Taper "Paris" → Vérifier recherche par ville fonctionne
    12. Effacer recherche → Vérifier que tous les clients réapparaissent

    **Étape 3: Test tri colonnes (si implémenté)**
    13. Cliquer header colonne "Nom"
    14. Vérifier tri alphabétique A→Z
    15. Recliquer → Vérifier tri Z→A
    16. Cliquer header colonne "Revenue total"
    17. Vérifier tri croissant puis décroissant

    **Étape 4: Test DELETE client sans données liées**
    18. Créer un nouveau client simple: "Client À Supprimer Test"
    19. Dans la liste, cliquer bouton "Supprimer" (icône poubelle) sur ce client
    20. Vérifier dialog de confirmation:
        - "Êtes-vous sûr de vouloir supprimer ce client ?"
        - "Cette action est irréversible"
    21. Cliquer "Annuler" → Vérifier que le client n'est PAS supprimé
    22. Recliquer "Supprimer" → Cliquer "Confirmer"
    23. Vérifier toast de succès "Client supprimé"
    24. Vérifier que le client disparaît de la liste
    25. Recharger la page → Confirmer que le client n'est plus présent

    **Étape 5: Test DELETE client avec données enrichies**
    26. Sélectionner un client avec avatar, contacts, custom fields (ex: un des clients importés)
    27. Noter l'ID du client et le chemin de l'avatar (ex: /uploads/tenant_org_1/avatars/xyz.jpg)
    28. Supprimer le client (confirmation + toast succès)
    29. SSH VPS:
        ```bash
        # Vérifier fichier avatar supprimé
        ls /var/www/recording-studio-manager/uploads/tenant_org_1/avatars/xyz.jpg
        # Devrait retourner: No such file or directory

        # Vérifier client supprimé en DB
        docker exec -it rsm-postgres psql -U postgres -d tenant_org_1 -c "SELECT * FROM clients WHERE id = [ID];"
        # Devrait retourner: 0 rows
        ```
    30. Vérifier que l'avatar/logo a été supprimé du serveur (fichier orphelin)

    **Étape 6: Test DELETE cascade avec contacts entreprise**
    31. Créer un client company avec 2 contacts: "Test Delete Company"
    32. Noter l'ID du client
    33. Supprimer le client
    34. SSH VPS, vérifier cascade:
        ```sql
        SELECT * FROM client_contacts WHERE "clientId" = [ID];
        ```
    35. Vérifier que les contacts ont été supprimés (0 rows)
    36. Confirmer cascade delete configuré correctement

    **Étape 7: Test DELETE protection si client a sessions/invoices**
    37. Sélectionner un client avec sessions ou invoices existantes
    38. Tenter de supprimer
    39. **Si protection implémentée:**
        - Vérifier message: "Impossible de supprimer ce client, il a X sessions et Y factures"
        - Vérifier que le client n'est PAS supprimé
    40. **Si pas de protection:**
        - Vérifier que le client se supprime
        - Vérifier que sessions/invoices liées sont:
          - Soit supprimées (cascade)
          - Soit orphelines (clientId = NULL)
          - Soit bloquent la suppression (contrainte FK)

    **Étape 8: Validation affichage stats enrichies**
    41. Retour sur /clients en vue Table
    42. Pour un client avec données enrichies:
        - Vérifier que l'avatar/logo s'affiche (thumbnail 40x40px)
        - Vérifier badge "Individual" ou "Company"
        - Vérifier que l'email PRINCIPAL s'affiche (pas tous les emails)
        - Vérifier que le téléphone PRINCIPAL s'affiche (type Mobile prioritaire)
    43. Survoler une ligne → Vérifier tooltip ou popup avec infos additionnelles (si implémenté)

    **Étape 9: Test pagination (si >50 clients)**
    44. Si liste contient >50 clients:
        - Vérifier pagination en bas de page
        - Cliquer "Page 2"
        - Vérifier que les clients 51-100 s'affichent
        - Vérifier nombre total affiché: "Affichage 51-100 sur 150 clients"
  </how-to-verify>
  <resume-signal>Taper "approved" si modes affichage et DELETE fonctionnent, ou décrire les problèmes</resume-signal>
</task>

</tasks>

<verification>
Avant de déclarer le plan complet:
- [ ] UPDATE modifie tous les champs vCard correctement
- [ ] UPDATE préserve arrays (phones, emails, websites, customFields)
- [ ] UPDATE avatar/logo remplace l'ancienne image
- [ ] UPDATE persist en base de données avec timestamp updatedAt
- [ ] ADD contact entreprise fonctionne avec validation
- [ ] UPDATE contact modifie isPrimary correctement
- [ ] DELETE contact supprime de la base
- [ ] DELETE client sans données liées fonctionne
- [ ] DELETE client supprime fichiers avatar/logo associés
- [ ] DELETE cascade supprime contacts d'entreprise
- [ ] Vue Table affiche données enrichies (avatar, type, stats)
- [ ] Vues Grid/Kanban fonctionnent (si implémentées)
- [ ] Recherche fonctionne sur champs enrichis (nom, email, phone, ville)
- [ ] Tri colonnes fonctionne (si implémenté)
</verification>

<success_criteria>
- UPDATE client enrichi modifie tous les champs vCard
- UPDATE préserve l'intégrité des arrays et custom fields
- Contacts entreprise: CRUD complet fonctionnel
- DELETE client nettoie fichiers et cascade contacts
- Modes d'affichage (au minimum Table) fonctionnent
- Recherche globale inclut champs enrichis
- Aucune perte de données lors UPDATE/DELETE
- UI responsive et performante avec 15-20 clients
</success_criteria>

<output>
Après complétion, créer `.planning/phases/3.10-test-clients-enrichis-vcard/3.10-03-SUMMARY.md`:

# Phase 3.10-03: Test CRUD Complet & Modes Affichage - Summary

**Validation UPDATE/DELETE clients enrichis, contacts entreprise, et modes d'affichage**

## Accomplishments

- Testé UPDATE client enrichi avec modification de tous champs vCard
- Validé UPDATE avatar/logo avec remplacement fichier
- Testé CRUD contacts entreprise (Add/Update/Delete)
- Confirmé DELETE client avec cascade contacts
- Validé nettoyage fichiers avatar/logo lors DELETE
- Testé modes d'affichage Table/Grid/Kanban
- Validé recherche sur champs enrichis
- Confirmé tri et pagination (si implémentés)

## Tests Réalisés

### UPDATE Client Enrichi
- [✓/✗] Modification nom structuré (prefix, firstName, lastName, suffix)
- [✓/✗] Modification arrays (phones, emails, websites)
- [✓/✗] Modification custom fields (add/update/delete)
- [✓/✗] Remplacement avatar/logo
- [✓/✗] Persistence en base avec updatedAt
- [✓/✗] Modifications via onglet "Détails" reflétées dans "Informations enrichies"

### Contacts Entreprise
- [✓/✗] ADD contact avec isPrimary
- [✓/✗] UPDATE contact + changement isPrimary
- [✓/✗] DELETE contact
- [✓/✗] Contrainte "au moins un contact principal"
- [✓/✗] Relation client ↔ contacts en base correcte

### DELETE Client
- [✓/✗] DELETE client simple réussit
- [✓/✗] DELETE supprime fichiers avatar/logo
- [✓/✗] DELETE cascade supprime contacts
- [✓/✗] Protection si sessions/invoices existantes (si implémenté)

### Modes Affichage
- [✓/✗] Vue Table affiche données enrichies
- [✓/✗] Vue Grid affiche cards (si implémenté)
- [✓/✗] Vue Kanban par statut (si implémenté)
- [✓/✗] Recherche sur nom/email/phone/ville
- [✓/✗] Tri colonnes (si implémenté)
- [✓/✗] Pagination (si >50 clients)

## Issues Encountered

[Liste des problèmes, ou "Aucun"]

## Files Verified

- packages/client/src/pages/Clients.tsx (modes affichage + recherche)
- packages/client/src/pages/ClientDetail.tsx (UPDATE enrichi)
- packages/client/src/components/EnrichedClientInfo.tsx (édition champs)
- packages/server/src/routers/clients.ts (UPDATE/DELETE mutations)
- PostgreSQL clients + client_contacts tables

## Phase 3.10 Complete

✅ Création clients enrichis fonctionnelle (3.10-01)
✅ Import/Export vCard/Excel/CSV fonctionnel (3.10-02)
✅ UPDATE/DELETE + contacts + modes affichage fonctionnels (3.10-03)

**Système clients enrichis vCard 4.0 100% opérationnel et prêt pour lancement marketing (Phase 4)**

## Next Phase

Phase 4: Marketing Foundation - Landing page + pricing avec démo clients enrichis
</output>
