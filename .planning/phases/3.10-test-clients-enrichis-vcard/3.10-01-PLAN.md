---
phase: 3.10-test-clients-enrichis-vcard
plan: 01
type: execute
---

<objective>
Valider le formulaire de création de client enrichi avec tous les champs vCard 4.0 et l'upload d'avatar/logo.

Purpose: S'assurer que l'interface de création enrichie fonctionne parfaitement avant le lancement marketing (Phase 4).
Output: Confirmation que tous les champs vCard sont fonctionnels et que les données se sauvegardent correctement.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Phase précédentes complétées:**
- Phase 3.9.4-01: Implémentation schema vCard 4.0 + upload avatar/logo
- Phase 3.9.4-02: Formulaire création enrichi avec 4 onglets

**Fonctionnalités à tester:**
1. Interface création enrichie (ClientCreate.tsx - 725 lignes)
   - 4 onglets: Identité, Contact, Adresse, Info additionnelles
   - Type toggle: individual/company avec UI conditionnelle
   - Upload avatar (individuals) et logo (companies)
   - Arrays dynamiques: phones[], emails[], websites[], customFields[]
   - Preview images avec bouton remove

2. Backend enrichi (clients.ts)
   - Mutation create accepte 16+ champs vCard
   - Stockage dans PostgreSQL tenant database
   - Upload tenant-isolé dans /uploads/tenant_X/

**Fichiers clés:**
@packages/client/src/pages/ClientCreate.tsx (725 lignes - interface enrichie)
@packages/client/src/pages/ClientDetail.tsx (onglet "Informations enrichies")
@packages/server/src/routers/clients.ts (mutation create étendue)
@packages/server/src/utils/local-upload-service.ts (upload tenant-isolé)
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Formulaire création client enrichi avec 4 onglets et upload avatar/logo</what-built>
  <how-to-verify>
    **Étape 1: Navigation et interface**
    1. Ouvrir https://recording-studio-manager.com/clients/new (ou http://localhost:8080/clients/new)
    2. Vérifier que les 4 onglets sont visibles:
       - Identité
       - Contact
       - Adresse
       - Info additionnelles
    3. Vérifier le toggle Type (Individual/Company) en haut du formulaire

    **Étape 2: Test création INDIVIDUAL avec avatar**
    4. Sélectionner type: "Individual"
    5. Onglet "Identité":
       - Civilité: "M."
       - Prénom: "Jean"
       - Deuxième prénom: "Paul"
       - Nom: "Dupont"
       - Suffixe: "Jr."
       - Nom d'artiste: "JP le Rappeur"
       - Cliquer "Choisir un avatar" et uploader une photo (JPG/PNG/WebP, max 5MB)
       - Vérifier que la preview de l'avatar s'affiche
       - Vérifier le bouton "Supprimer" à côté de la preview
    6. Onglet "Contact":
       - Cliquer "Ajouter un téléphone"
       - Type: "Mobile", Numéro: "+33 6 12 34 56 78"
       - Cliquer "Ajouter un téléphone" à nouveau
       - Type: "Travail", Numéro: "+33 1 42 42 42 42"
       - Cliquer "Ajouter un email"
       - Type: "Personnel", Email: "jean.dupont@gmail.com"
       - Cliquer "Ajouter un email"
       - Type: "Travail", Email: "j.dupont@company.com"
       - Cliquer "Ajouter un site web"
       - Type: "Site web", URL: "https://jeanpaul-music.com"
    7. Onglet "Adresse":
       - Rue: "123 Avenue des Champs-Élysées"
       - Ville: "Paris"
       - Code postal: "75008"
       - Région/État: "Île-de-France"
       - Pays: "France"
    8. Onglet "Info additionnelles":
       - Date de naissance: Sélectionner une date (ex: 15/03/1985)
       - Genre: "Homme"
       - Cliquer "Ajouter un champ personnalisé"
       - Label: "Instagram", Type: "text", Valeur: "@jplerappeur"
       - Cliquer "Ajouter un champ personnalisé"
       - Label: "Budget mensuel", Type: "number", Valeur: "5000"
       - Notes: "Client VIP - producteur hip-hop reconnu"
    9. Cliquer "Créer le client"
    10. Vérifier la navigation automatique vers /clients/[id]

    **Étape 3: Validation données créées**
    11. Sur la page ClientDetail, cliquer sur l'onglet "Informations enrichies"
    12. Vérifier que TOUTES les données saisies sont présentes:
        - Avatar visible en haut
        - Nom complet structuré: "M. Jean Paul Dupont Jr."
        - Nom d'artiste: "JP le Rappeur"
        - Section Téléphones: 2 téléphones affichés (Mobile +33 6..., Travail +33 1...)
        - Section Emails: 2 emails affichés
        - Section Sites web: 1 URL affichée
        - Section Adresse: adresse complète affichée
        - Date de naissance: 15/03/1985
        - Genre: Homme
        - Champs personnalisés: Instagram + Budget mensuel
        - Notes affichées

    **Étape 4: Test création COMPANY avec logo**
    13. Retourner à /clients/new
    14. Sélectionner type: "Company"
    15. Onglet "Identité":
        - Nom (champ name requis): "Studio Atlantique Records"
        - Vérifier que les champs de nom structuré (prénom, nom, etc.) ne sont PAS affichés pour type company
        - Cliquer "Choisir un logo" et uploader une image logo
        - Vérifier preview du logo
    16. Onglet "Contact":
        - Ajouter téléphone: Type "Standard", Numéro "+33 2 40 40 40 40"
        - Ajouter email: Type "Contact", Email "contact@studio-atlantique.fr"
        - Ajouter site web: Type "Site web", URL "https://studio-atlantique.fr"
    17. Onglet "Adresse":
        - Rue: "45 Quai de la Fosse"
        - Ville: "Nantes"
        - Code postal: "44000"
        - Région: "Pays de la Loire"
        - Pays: "France"
    18. Cliquer "Créer le client"
    19. Vérifier navigation vers /clients/[id]
    20. Onglet "Informations enrichies":
        - Logo visible (PAS d'avatar)
        - Nom: "Studio Atlantique Records"
        - Contacts, adresse, etc. présents

    **Étape 5: Test création minimale (backward compatibility)**
    21. Retourner à /clients/new
    22. Ne remplir QUE le champ "Nom" (dans onglet Identité): "Client Minimal Test"
    23. Cliquer "Créer le client" SANS remplir les autres onglets
    24. Vérifier que la création fonctionne (backward compatibility)
    25. Vérifier que le client apparaît dans /clients avec juste le nom

    **Étape 6: Validation base de données**
    26. SSH sur VPS production (31.220.104.244)
    27. Connexion PostgreSQL:
        ```bash
        docker exec -it rsm-postgres psql -U postgres -d tenant_org_1
        ```
    28. Vérifier le client individual créé:
        ```sql
        SELECT id, name, type, "firstName", "lastName", "middleName", prefix, suffix,
               "artistName", phones, emails, websites, "avatarUrl", "customFields"
        FROM clients
        WHERE name LIKE '%Jean%Dupont%'
        ORDER BY "createdAt" DESC LIMIT 1;
        ```
    29. Vérifier que:
        - type = 'individual'
        - firstName = 'Jean', lastName = 'Dupont', middleName = 'Paul'
        - prefix = 'M.', suffix = 'Jr.'
        - artistName = 'JP le Rappeur'
        - phones est un JSON array avec 2 entrées
        - emails est un JSON array avec 2 entrées
        - websites est un JSON array avec 1 entrée
        - avatarUrl contient un chemin /uploads/tenant_X/avatars/...
        - customFields contient Instagram + Budget
    30. Vérifier le client company créé:
        ```sql
        SELECT id, name, type, "logoUrl", phones, emails, websites
        FROM clients
        WHERE name = 'Studio Atlantique Records';
        ```
    31. Vérifier que:
        - type = 'company'
        - logoUrl contient un chemin /uploads/tenant_X/logos/...
        - firstName, lastName, etc. sont NULL ou vides
  </how-to-verify>
  <resume-signal>Taper "approved" si tous les tests passent, ou décrire les problèmes rencontrés</resume-signal>
</task>

</tasks>

<verification>
Avant de déclarer le plan complet:
- [ ] Formulaire création affiche 4 onglets correctement
- [ ] Toggle Individual/Company change l'UI (champs structurés vs nom simple)
- [ ] Upload avatar (individual) fonctionne avec preview
- [ ] Upload logo (company) fonctionne avec preview
- [ ] Arrays dynamiques (phones, emails, websites, customFields) fonctionnent
- [ ] Boutons "Ajouter" et "Supprimer" fonctionnent pour les arrays
- [ ] Création client individual avec données complètes réussit
- [ ] Création client company avec logo réussit
- [ ] Création minimale (nom seul) fonctionne (backward compatibility)
- [ ] Navigation vers ClientDetail après création fonctionne
- [ ] Onglet "Informations enrichies" affiche toutes les données créées
- [ ] Données en base correspondent exactement aux données saisies
- [ ] Avatar/logo sont stockés dans /uploads/tenant_X/ avec isolation
</verification>

<success_criteria>
- Interface de création enrichie 100% fonctionnelle
- Upload avatar/logo opérationnel avec tenant isolation
- Arrays dynamiques (phones, emails, websites, customFields) fonctionnent
- Type toggle (individual/company) change correctement l'UI
- Backward compatibility: création minimale (nom seul) fonctionne toujours
- Toutes les données vCard sauvegardées correctement en base
- Onglet "Informations enrichies" affiche toutes les données
- Aucune régression sur fonctionnalités existantes
</success_criteria>

<output>
Après complétion, créer `.planning/phases/3.10-test-clients-enrichis-vcard/3.10-01-SUMMARY.md`:

# Phase 3.10-01: Test Formulaire Création Client Enrichi - Summary

**Validation formulaire création avec vCard 4.0 et upload avatar/logo**

## Accomplishments

- Testé interface 4 onglets (Identité/Contact/Adresse/Info)
- Validé upload avatar (individuals) et logo (companies)
- Confirmé arrays dynamiques phones/emails/websites/customFields
- Vérifié type toggle individual/company
- Testé backward compatibility (création minimale)
- Validé persistence données en base PostgreSQL
- Confirmé isolation tenant pour fichiers uploadés

## Tests Réalisés

### Test 1: Création Individual avec Avatar
- [✓/✗] Interface 4 onglets affichée
- [✓/✗] Champs nom structuré présents (prefix, firstName, middleName, lastName, suffix, artistName)
- [✓/✗] Upload avatar réussi avec preview
- [✓/✗] Ajout multiple phones/emails/websites fonctionne
- [✓/✗] Champs personnalisés ajoutés (Instagram, Budget)
- [✓/✗] Navigation vers ClientDetail après création
- [✓/✗] Données affichées dans onglet "Informations enrichies"

### Test 2: Création Company avec Logo
- [✓/✗] Champs structurés cachés pour type company
- [✓/✗] Upload logo réussi avec preview
- [✓/✗] Contacts company ajoutés
- [✓/✗] Logo affiché (pas avatar) dans "Informations enrichies"

### Test 3: Backward Compatibility
- [✓/✗] Création minimale (nom seul) fonctionne
- [✓/✗] Client créé visible dans liste /clients

### Test 4: Validation Base de Données
- [✓/✗] Type 'individual' stocké correctement
- [✓/✗] JSON arrays (phones, emails, websites) stockés
- [✓/✗] avatarUrl/logoUrl contiennent chemins corrects
- [✓/✗] customFields stockés en JSONB

## Issues Encountered

[Liste des problèmes rencontrés, ou "Aucun"]

## Files Verified

- packages/client/src/pages/ClientCreate.tsx (interface enrichie)
- packages/client/src/pages/ClientDetail.tsx (affichage données)
- packages/server/src/routers/clients.ts (mutation create)
- PostgreSQL tenant database (persistence données)
- /uploads/tenant_X/avatars/ et /logos/ (fichiers uploadés)

## Next Step

Ready for Phase 3.10-02: Test Import/Export vCard/Excel/CSV
</output>
