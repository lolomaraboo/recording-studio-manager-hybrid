---
phase: 37-harmonisation-contracts---routing-cohérent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/components/ContractEditForm.tsx (new file)
  - packages/client/src/pages/ContractCreate.tsx
autonomous: true

must_haves:
  truths:
    - "Contract creation uses accordion pattern like ClientEditForm"
    - "Inline form pattern eliminated from contract creation"
    - "Accordions open by default for immediate field access"
    - "Form structure matches contract context (contract-specific fields)"
  artifacts:
    - path: "packages/client/src/components/ContractEditForm.tsx"
      provides: "Accordion-based edit form for contracts"
      min_lines: 400
      exports: ["ContractEditForm"]
    - path: "packages/client/src/pages/ContractCreate.tsx"
      provides: "Simplified creation page using ContractEditForm"
      min_lines: 100
      contains: "ContractEditForm"
  key_links:
    - from: "ContractCreate.tsx"
      to: "ContractEditForm"
      via: "reusable component for creation"
      pattern: "ContractEditForm"
---

<objective>
Create accordion-based ContractEditForm component and refactor ContractCreate page to use it, following the Phase 28 pattern.

Purpose: Harmonize contracts UI with established accordion pattern from Client and Talent forms
Output: ContractEditForm component and refactored ContractCreate page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference implementation (TALENT pattern - similar complexity)
@.planning/phases/28-harmonisation-ui-talents/28-05-PLAN.md (accordion pattern reference)

# Current contract implementation
@packages/client/src/pages/ContractCreate.tsx (inline form - to be replaced)

# Database schema
@packages/database/src/tenant/schema.ts (lines 660-699 - contracts table)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContractEditForm component with accordions</name>
  <files>packages/client/src/components/ContractEditForm.tsx</files>
  <action>
**Pattern reference:** TalentEditForm.tsx (accordions, all open by default, organized sections)

**Create accordion-based edit form for contracts:**

1. **Component structure (adapt from TalentEditForm):**
   ```typescript
   import { useState, useEffect } from "react";
   import { Button } from "@/components/ui/button";
   import { Card } from "@/components/ui/card";
   import {
     Accordion,
     AccordionContent,
     AccordionItem,
     AccordionTrigger,
   } from "@/components/ui/accordion";
   import { Input } from "@/components/ui/input";
   import { Label } from "@/components/ui/label";
   import { Textarea } from "@/components/ui/textarea";
   import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
   import {
     FileText,
     FileSignature,
     DollarSign,
     Calendar,
     StickyNote,
   } from "lucide-react";
   import { trpc } from "@/lib/trpc";

   interface ContractEditFormProps {
     formData: any;
     setFormData: (data: any) => void;
   }

   export function ContractEditForm({
     formData,
     setFormData,
   }: ContractEditFormProps) {
     // Fetch related data
     const { data: clients } = trpc.clients.list.useQuery({ limit: 100 });
     const { data: projects } = trpc.projects.list.useQuery();

     // State for open accordions (all open by default)
     const [openItems, setOpenItems] = useState<string[]>(() => {
       try {
         const saved = localStorage.getItem('contractEditAccordions');
         return saved ? JSON.parse(saved) : ["informations", "details", "financier", "dates", "notes"];
       } catch {
         return ["informations", "details", "financier", "dates", "notes"];
       }
     });

     // Save accordion state to localStorage
     useEffect(() => {
       try {
         localStorage.setItem('contractEditAccordions', JSON.stringify(openItems));
       } catch (error) {
         console.error('Failed to save accordion state:', error);
       }
     }, [openItems]);

     // Alt key handler to toggle all accordions
     const handleAccordionTriggerClick = (event: React.MouseEvent) => {
       if (event.altKey) {
         event.preventDefault();
         event.stopPropagation();

         const allAccordions = ["informations", "details", "financier", "dates", "notes"];
         if (openItems.length < allAccordions.length) {
           setOpenItems(allAccordions);
         } else {
           setOpenItems([]);
         }
       }
     };

     return (
       <Accordion
         type="multiple"
         value={openItems}
         onValueChange={setOpenItems}
         className="space-y-2"
       >
         {/* Accordion 1: Informations de base */}
         {/* Accordion 2: Détails du contrat */}
         {/* Accordion 3: Informations financières */}
         {/* Accordion 4: Dates importantes */}
         {/* Accordion 5: Notes */}
       </Accordion>
     );
   }
   ```

2. **Accordion 1: Informations de base** (contractNumber, type, client, project)
   ```typescript
   <AccordionItem value="informations">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <FileText className="h-5 w-5 text-primary" />
           Informations de base
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           <div className="grid md:grid-cols-2 gap-3">
             {/* Numéro de contrat */}
             <div>
               <Label htmlFor="contractNumber">
                 Numéro de contrat <span className="text-destructive">*</span>
               </Label>
               <Input
                 id="contractNumber"
                 className="mt-1"
                 value={formData.contractNumber || ""}
                 onChange={(e) => setFormData({ ...formData, contractNumber: e.target.value })}
                 placeholder="Ex: CT-2024-001"
               />
             </div>

             {/* Type */}
             <div>
               <Label htmlFor="type">
                 Type <span className="text-destructive">*</span>
               </Label>
               <Select
                 value={formData.type || "recording"}
                 onValueChange={(value) => setFormData({ ...formData, type: value })}
               >
                 <SelectTrigger id="type" className="mt-1">
                   <SelectValue />
                 </SelectTrigger>
                 <SelectContent>
                   <SelectItem value="recording">Enregistrement</SelectItem>
                   <SelectItem value="mixing">Mixage</SelectItem>
                   <SelectItem value="mastering">Mastering</SelectItem>
                   <SelectItem value="production">Production</SelectItem>
                   <SelectItem value="exclusivity">Exclusivité</SelectItem>
                   <SelectItem value="distribution">Distribution</SelectItem>
                   <SelectItem value="studio_rental">Location studio</SelectItem>
                   <SelectItem value="services">Services</SelectItem>
                   <SelectItem value="partnership">Partenariat</SelectItem>
                   <SelectItem value="other">Autre</SelectItem>
                 </SelectContent>
               </Select>
             </div>
           </div>

           <div className="grid md:grid-cols-2 gap-3">
             {/* Client */}
             <div>
               <Label htmlFor="clientId">
                 Client <span className="text-destructive">*</span>
               </Label>
               <Select
                 value={formData.clientId?.toString() || "0"}
                 onValueChange={(value) => setFormData({ ...formData, clientId: parseInt(value) })}
               >
                 <SelectTrigger id="clientId" className="mt-1">
                   <SelectValue placeholder="Sélectionner un client" />
                 </SelectTrigger>
                 <SelectContent>
                   {clients?.map((client) => (
                     <SelectItem key={client.id} value={client.id.toString()}>
                       {client.name}
                     </SelectItem>
                   ))}
                 </SelectContent>
               </Select>
             </div>

             {/* Projet (optionnel) */}
             <div>
               <Label htmlFor="projectId">Projet (optionnel)</Label>
               <Select
                 value={formData.projectId?.toString() || "0"}
                 onValueChange={(value) => setFormData({ ...formData, projectId: parseInt(value) })}
               >
                 <SelectTrigger id="projectId" className="mt-1">
                   <SelectValue placeholder="Aucun" />
                 </SelectTrigger>
                 <SelectContent>
                   <SelectItem value="0">Aucun</SelectItem>
                   {projects?.map((project) => (
                     <SelectItem key={project.id} value={project.id.toString()}>
                       {project.name}
                     </SelectItem>
                   ))}
                 </SelectContent>
               </Select>
             </div>
           </div>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

3. **Accordion 2: Détails du contrat** (title, description, terms)
   ```typescript
   <AccordionItem value="details">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <FileSignature className="h-5 w-5 text-primary" />
           Détails du contrat
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           {/* Titre */}
           <div>
             <Label htmlFor="title">
               Titre <span className="text-destructive">*</span>
             </Label>
             <Input
               id="title"
               className="mt-1"
               value={formData.title || ""}
               onChange={(e) => setFormData({ ...formData, title: e.target.value })}
               placeholder="Ex: Contrat d'enregistrement album 2024"
             />
           </div>

           {/* Description */}
           <div>
             <Label htmlFor="description">Description</Label>
             <Textarea
               id="description"
               className="mt-1 min-h-[80px]"
               value={formData.description || ""}
               onChange={(e) => setFormData({ ...formData, description: e.target.value })}
               placeholder="Description du contrat..."
             />
           </div>

           {/* Conditions */}
           <div>
             <Label htmlFor="terms">
               Conditions <span className="text-destructive">*</span>
             </Label>
             <Textarea
               id="terms"
               className="mt-1 min-h-[120px]"
               value={formData.terms || ""}
               onChange={(e) => setFormData({ ...formData, terms: e.target.value })}
               placeholder="Conditions générales du contrat..."
             />
           </div>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

4. **Accordion 3: Informations financières** (value, status)
   ```typescript
   <AccordionItem value="financier">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <DollarSign className="h-5 w-5 text-primary" />
           Informations financières
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           <div className="grid md:grid-cols-2 gap-3">
             {/* Valeur */}
             <div>
               <Label htmlFor="value">Valeur du contrat (€)</Label>
               <Input
                 id="value"
                 type="number"
                 step="0.01"
                 className="mt-1"
                 value={formData.value || ""}
                 onChange={(e) => setFormData({ ...formData, value: e.target.value })}
                 placeholder="0.00"
               />
             </div>

             {/* Statut */}
             <div>
               <Label htmlFor="status">Statut</Label>
               <Select
                 value={formData.status || "draft"}
                 onValueChange={(value) => setFormData({ ...formData, status: value })}
               >
                 <SelectTrigger id="status" className="mt-1">
                   <SelectValue />
                 </SelectTrigger>
                 <SelectContent>
                   <SelectItem value="draft">Brouillon</SelectItem>
                   <SelectItem value="sent">Envoyé</SelectItem>
                   <SelectItem value="pending_signature">En attente de signature</SelectItem>
                   <SelectItem value="signed">Signé</SelectItem>
                   <SelectItem value="active">Actif</SelectItem>
                   <SelectItem value="expired">Expiré</SelectItem>
                   <SelectItem value="terminated">Résilié</SelectItem>
                   <SelectItem value="cancelled">Annulé</SelectItem>
                 </SelectContent>
               </Select>
             </div>
           </div>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

5. **Accordion 4: Dates importantes** (startDate, endDate, signedAt)
   ```typescript
   <AccordionItem value="dates">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <Calendar className="h-5 w-5 text-primary" />
           Dates importantes
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           <div className="grid md:grid-cols-3 gap-3">
             {/* Date de début */}
             <div>
               <Label htmlFor="startDate">Date de début</Label>
               <Input
                 id="startDate"
                 type="date"
                 className="mt-1"
                 value={formData.startDate || ""}
                 onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
               />
             </div>

             {/* Date de fin */}
             <div>
               <Label htmlFor="endDate">Date de fin</Label>
               <Input
                 id="endDate"
                 type="date"
                 className="mt-1"
                 value={formData.endDate || ""}
                 onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
               />
             </div>

             {/* Date de signature */}
             <div>
               <Label htmlFor="signedAt">Date de signature</Label>
               <Input
                 id="signedAt"
                 type="date"
                 className="mt-1"
                 value={formData.signedAt || ""}
                 onChange={(e) => setFormData({ ...formData, signedAt: e.target.value })}
               />
             </div>
           </div>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

6. **Accordion 5: Notes** (internal notes, documentUrl, signedDocumentUrl)
   ```typescript
   <AccordionItem value="notes">
     <Card>
       <AccordionTrigger className="px-4 py-3 hover:no-underline" onClick={handleAccordionTriggerClick}>
         <h3 className="text-lg font-semibold flex items-center gap-2">
           <StickyNote className="h-5 w-5 text-primary" />
           Notes et documents
         </h3>
       </AccordionTrigger>
       <AccordionContent>
         <div className="px-4 pb-3 space-y-3">
           {/* Notes internes */}
           <div>
             <Label htmlFor="notes">Notes internes</Label>
             <Textarea
               id="notes"
               className="mt-1 min-h-[100px]"
               value={formData.notes || ""}
               onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
               placeholder="Notes internes du studio..."
             />
           </div>

           <div className="grid md:grid-cols-2 gap-3">
             {/* Document URL */}
             <div>
               <Label htmlFor="documentUrl">URL du document</Label>
               <Input
                 id="documentUrl"
                 type="url"
                 className="mt-1"
                 value={formData.documentUrl || ""}
                 onChange={(e) => setFormData({ ...formData, documentUrl: e.target.value })}
                 placeholder="https://..."
               />
             </div>

             {/* Document signé URL */}
             <div>
               <Label htmlFor="signedDocumentUrl">URL du document signé</Label>
               <Input
                 id="signedDocumentUrl"
                 type="url"
                 className="mt-1"
                 value={formData.signedDocumentUrl || ""}
                 onChange={(e) => setFormData({ ...formData, signedDocumentUrl: e.target.value })}
                 placeholder="https://..."
               />
             </div>
           </div>
         </div>
       </AccordionContent>
     </Card>
   </AccordionItem>
   ```

**Key characteristics:**
- 5 accordions (Informations, Détails, Financier, Dates, Notes et documents)
- Contract-specific fields (contractNumber, type, terms, value, status, dates)
- All accordions open by default
- localStorage persistence for accordion state
- Alt+Click toggles all accordions

**Why accordion pattern:** Eliminates inline form friction, matches Phase 28 improvements, all fields accessible
  </action>
  <verify>
1. Component exports ContractEditForm
2. TypeScript 0 errors on component definition
3. All 5 accordions render correctly
4. localStorage persistence works (contractEditAccordions key)
5. Alt+Click toggles all accordions
6. Form fields update formData correctly
7. tRPC queries for clients and projects work
  </verify>
  <done>
- ContractEditForm.tsx created with 5 accordions
- Informations, Détails, Financier, Dates, Notes sections
- All accordions open by default
- localStorage persistence for accordion state
- Alt+Click toggle all feature
- Client and project selects integrated
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor ContractCreate.tsx to use ContractEditForm</name>
  <files>packages/client/src/pages/ContractCreate.tsx</files>
  <action>
**Pattern reference:** TalentCreate.tsx after Phase 28-05 refactor - reusable form component

**Simplify creation page:**

1. **Import ContractEditForm:**
   ```typescript
   import { ContractEditForm } from "@/components/ContractEditForm";
   ```

2. **Keep formData state and createMutation** (existing logic is good)

3. **Replace inline Card form with ContractEditForm:**
   ```typescript
   return (
     <div className="container pt-2 pb-4 px-2">
       <div className="space-y-2">
         {/* Header */}
         <div className="flex items-center justify-between">
           <div className="flex items-center gap-4">
             <Link to="/contracts">
               <Button variant="ghost" size="icon">
                 <ArrowLeft className="h-5 w-5" />
               </Button>
             </Link>
             <div>
               <h1 className="text-3xl font-bold">Nouveau Contrat</h1>
               <p className="text-muted-foreground">Créer un nouveau contrat client</p>
             </div>
           </div>
         </div>

         {/* Form */}
         <form onSubmit={handleSubmit}>
           <ContractEditForm
             formData={formData}
             setFormData={setFormData}
           />

           {/* Submit button */}
           <div className="mt-4 flex justify-end gap-2">
             <Button type="button" variant="outline" asChild>
               <Link to="/contracts">Annuler</Link>
             </Button>
             <Button type="submit" disabled={createMutation.isPending}>
               <Save className="h-4 w-4 mr-2" />
               {createMutation.isPending ? "Création..." : "Créer le contrat"}
             </Button>
           </div>
         </form>
       </div>
     </div>
   );
   ```

4. **Remove all inline form inputs** (lines ~93-246 in current file - replaced by ContractEditForm)

5. **Remove unused imports** (Card, CardContent, CardDescription, CardHeader, CardTitle, Input, Label, Textarea, Select components)

6. **Keep only necessary imports:**
   - useState, useNavigate, Link
   - Button
   - ContractEditForm
   - trpc, ArrowLeft, Save, toast

**Result:** ContractCreate.tsx reduces from ~250 lines to ~80 lines, reuses ContractEditForm component

**Benefits:**
- DRY principle (single form component for create + edit)
- Consistency (same UI for creation and editing)
- Maintainability (form changes only in ContractEditForm.tsx)
  </action>
  <verify>
1. Navigate to /contracts/new
2. ContractEditForm renders with 5 accordions
3. Fill form fields (contractNumber, clientId, title, terms required)
4. Click "Créer le contrat" - createMutation fires
5. Successful creation redirects to /contracts
6. TypeScript 0 errors
  </verify>
  <done>
- ContractCreate.tsx refactored to use ContractEditForm
- Page simplified to ~80 lines (from ~250)
- Reusable form component for create + edit
- Submit button with validation
- Inline Card form removed completely
- TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and verify harmonization complete</name>
  <files>packages/client/src/components/ContractEditForm.tsx, packages/client/src/pages/ContractCreate.tsx</files>
  <action>
**Final verification steps:**

1. **TypeScript check:**
   ```bash
   pnpm --filter client check
   ```

2. **Build test:**
   ```bash
   pnpm --filter client build
   ```

3. **Test complete workflow:**
   - Visit /contracts/new → create contract with ContractEditForm
   - Fill all required fields (contractNumber, clientId, title, terms)
   - Submit form → contract created successfully
   - Redirects to /contracts list

4. **Document completion in commit:**
   ```bash
   git add packages/client/src/components/ContractEditForm.tsx packages/client/src/pages/ContractCreate.tsx
   git commit -m "feat(37-01): create accordion-based ContractEditForm

Phase 37: Harmonisation Contracts - Routing Cohérent
- Created ContractEditForm component (5 accordions: Informations, Détails, Financier, Dates, Notes)
- Refactored ContractCreate.tsx to use ContractEditForm (~80 lines from ~250)
- Inline Card form pattern eliminated
- All accordions open by default (Alt+Click toggle all)
- localStorage persistence for accordion state
- Pattern matches Phase 28 (TalentEditForm)

Benefits:
- DRY principle (reusable for create + edit modes)
- Consistency across resource types
- Improved maintainability

Phase 37 COMPLETE

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
   ```

**Success indicators:**
- ✓ Build successful (zero errors)
- ✓ TypeScript passes
- ✓ Create workflow functional
- ✓ Inline form eliminated, accordion pattern adopted
- ✓ Phase 37 complete
  </action>
  <verify>
1. TypeScript check passes (0 errors)
2. Build completes successfully
3. No console errors in create workflow
4. All 5 accordions functional
5. Form state synchronization working
6. Git commit created with Phase 37 completion message
  </verify>
  <done>
- TypeScript 0 errors confirmed
- Production build successful
- ContractEditForm harmonized with TalentEditForm patterns
- Inline form pattern eliminated (Phase 28 goal achieved)
- Phase 37 complete
- Contracts UI harmonized with clients and talents patterns
  </done>
</task>

</tasks>

<verification>
**Phase 37 Complete Verification:**

1. **ContractEditForm component:**
   - [x] 5 accordions (Informations, Détails, Financier, Dates, Notes)
   - [x] All open by default
   - [x] localStorage persistence
   - [x] Alt+Click toggle all
   - [x] Contract-specific fields (contractNumber, type, terms, value, status, dates)
   - [x] Client and project selects integrated

2. **ContractCreate page:**
   - [x] Uses ContractEditForm component
   - [x] Simplified from ~250 to ~80 lines
   - [x] Inline Card form removed
   - [x] Submit button workflow

3. **Pattern consistency:**
   - [x] Matches Phase 28 TalentEditForm structure
   - [x] Accordion-based pattern adopted
   - [x] DRY principle applied
   - [x] Reusable for future edit mode integration
</verification>

<success_criteria>
- [ ] ContractEditForm component created with 5 accordions
- [ ] All accordions open by default with localStorage persistence
- [ ] Alt+Click toggles all accordions
- [ ] Client and project tRPC queries integrated
- [ ] ContractCreate.tsx refactored to use ContractEditForm (~80 lines)
- [ ] Inline Card form pattern eliminated from creation flow
- [ ] TypeScript 0 errors
- [ ] Client builds successfully
- [ ] Create workflow functional
- [ ] Phase 37 complete: Contracts UI harmonized with Phase 28 patterns
</success_criteria>

<output>
After completion, create `.planning/phases/37-harmonisation-contracts---routing-cohérent/37-01-SUMMARY.md`
</output>
