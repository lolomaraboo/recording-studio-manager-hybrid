# Phase 18.1: Fix Database Initialization - Context

**Gathered:** 2026-01-16
**Status:** Ready for planning

<vision>
## How This Should Work

Audit exhaustif du système de bases de données avant de fixer quoi que ce soit. Comprendre TOUTE l'architecture:

- **Database-per-Tenant**: Comment fonctionne rsm_master vs tenant_1/tenant_2/etc., leurs rôles respectifs, comment elles interagissent
- **Migrations**: Master migrations vs tenant migrations vs mixtes, où elles sont, lesquelles s'appliquent où, pourquoi
- **État actuel**: Inventaire complet de ce qui existe vs ce qui manque, d'où vient le drift schema/migrations
- **Processus d'init**: Tracer db:migrate → db:init pas à pas, identifier exactement où ça casse et pourquoi
- **Production state**: Comprendre l'état de la prod aussi pour éviter de casser quelque chose

Après audit complet et compréhension totale: fixer proprement. Pas de shortcuts, pas de hacks. On profite d'être en pré-prod pour tout nettoyer et avoir une base solide avant de scaler.

</vision>

<essential>
## What Must Be Nailed

- **Compréhension totale avant action** - Documenter TOUTE l'architecture DB/migrations avant de toucher au code. Zéro surprise.
- **Clean pour la prod** - Pas de demi-mesures. On nettoie tout maintenant pendant qu'on peut encore tout toucher sans risque.
- **Base solide** - Après ce fix, le système de migrations doit être rock-solid. Plus jamais de drift schema/migrations.

</essential>

<boundaries>
## What's Out of Scope

Aucune limite artificielle - on fait tout ce qu'il faut pour rendre le système clean avant la prod.

Si quelque chose doit être nettoyé pour avoir une base solide, on le fait dans cette phase.

</boundaries>

<specifics>
## Specific Ideas

Best practices standards Drizzle ORM - pas besoin de réinventer la roue.

Suivre les patterns recommandés par Drizzle pour:
- Structure des migrations
- Processus de génération
- Scripts d'init
- Gestion du schema drift

</specifics>

<notes>
## Additional Context

**Contexte de découverte:**
- BUG-001 (P0) découvert pendant Phase 18-02 setup
- Impossible d'initialiser base de données locale pour testing
- Schema TypeScript (packages/database/src/master/schema.ts) inclut colonnes Stripe (stripe_customer_id, stripe_subscription_id, subscription_status, current_period_end, logo_url)
- Migration SQL (drizzle/migrations/master/0000_massive_zodiak.sql) manque ces colonnes
- Script init échoue: "column does not exist"

**Approche voulue:**
1. Audit complet d'abord (comprendre tout)
2. Fixer proprement ensuite (base solide)
3. Pas de rush - c'est un investissement pour la stabilité future

</notes>

---

*Phase: 18.1-fix-database-initialization-resolve-schema-migrations-desync-blocking-all-testing*
*Context gathered: 2026-01-16*
