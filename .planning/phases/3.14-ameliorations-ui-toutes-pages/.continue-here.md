---
phase: 3.14-ameliorations-ui-toutes-pages
plan: 3.14-01
task: 1
total_tasks: 5
status: blocked
last_updated: 2026-01-04T20:22:00Z
---

<current_state>
Phase 3.14-01: Améliorations UI de toutes les pages - **BLOQUÉ** sur problème d'authentification

**Position actuelle:** Dashboard (page 1/58) - Retouches appliquées mais non validées visuellement

**Problème bloquant:** Login réussit mais toutes les requêtes API retournent **401 Unauthorized**
- Login: 200 OK ✅
- auth.me: 200 OK ✅
- Toutes autres requêtes: 401 ❌ (notifications, organizations, clients, rooms, etc.)

**Problème racine:** Session/cookies non persistés entre Vite dev (localhost:5174) et backend Docker (localhost:3002)

**Configuration actuelle:**
- Frontend Vite: localhost:5174 (mode dev pour hot-reload)
- Backend Docker: localhost:3002 (rsm-server container)
- Base de données: Docker PostgreSQL (rsm-postgres)
</current_state>

<completed_work>

**Task 1: Dashboard retouches - PARTIELLEMENT COMPLÉTÉ**

✅ **Modifications appliquées dans Dashboard.tsx:**
1. Ligne 85: Retiré `min-h-[400px]` des widgets → Hauteurs variables
2. Ligne 320: `gap-4` → `gap-6` → Plus d'espacement entre widgets (VISIBLE ✅)
3. Lignes 431-434, 469-472, 563-566, 588-591, 604-607: Empty states compactés (`py-8`→`py-6`, icônes `h-12`→`h-10`, texte `text-sm`)

❌ **Non validé visuellement:** Les données ne se chargent pas à cause du bug 401

**Corrections CORS appliquées:**
1. ✅ docker-compose.yml ligne 59: Ajouté `http://localhost:5174` à ALLOWED_ORIGINS
2. ✅ vite.config.ts ligne 32: Proxy pointe vers `localhost:3002` (était 3001)
3. ✅ packages/client/.env ligne 1: `VITE_API_URL=http://localhost:3002/api/trpc`
4. ✅ Container rsm-server redémarré avec nouveau CORS

**Documentation mise à jour (port 5173 → 5174):**
- CLAUDE.md
- README.md
- start.sh
- playwright.config.ts
- .env.example
- e2e/README.md

</completed_work>

<remaining_work>

**Task 1: Dashboard - VALIDATION EN ATTENTE**
- [ ] **URGENT:** Résoudre problème 401 Unauthorized (cookies/session)
- [ ] Valider visuellement les 3 retouches Dashboard
- [ ] Confirmer avec utilisateur que les retouches sont satisfaisantes

**Tasks 2-4: Autres pages (NON DÉMARRÉES)**
- [ ] Task 2: Sessions pages (3 pages: list, new, detail) + corriger bug statut ligne 222-223
- [ ] Task 3: Clients pages (3 pages: list, new, detail)
- [ ] Task 4: 38 pages restantes Admin Dashboard
- [ ] Client Portal (7 pages)
- [ ] Super Admin (3 pages)
- [ ] Public/Auth (4 pages)

**Task 5: Build et déploiement (NON DÉMARRÉ)**
- [ ] Build production: `pnpm --filter client build`
- [ ] Git commit avec tous les fichiers modifiés
- [ ] Déploiement VPS (rsync + docker rebuild)

**Total pages restantes:** 57/58 pages
</remaining_work>

<decisions_made>

1. **Vite dev local + Backend Docker (pas full Docker)**
   - Décision: Vite localhost:5174 pour hot-reload UI + Backend Docker localhost:3002
   - Rationale: Voir les changements UI instantanément sans rebuild Docker
   - Alternative rejetée: Full Docker (trop lent, rebuild à chaque modification)

2. **Configuration CORS ajoutée pour dev local**
   - Décision: Ajouté `http://localhost:5174` dans docker-compose.yml ALLOWED_ORIGINS
   - Rationale: Permettre Vite dev d'appeler le backend Docker
   - Impact: Production non affectée (utilise http://client)

3. **Port 5174 au lieu de 5173**
   - Décision: Documenté 5174 comme port Vite officiel
   - Rationale: L'utilisateur avait déjà Vite sur 5174
   - Mis à jour: 6 fichiers de documentation

4. **Approche itérative avec feedback utilisateur**
   - Décision: Montrer chaque page, demander retouches, appliquer, valider
   - Rationale: Contrôle total sur les améliorations visuelles
   - Workflow: Présenter page → Feedback → Edit → Vérifier navigateur → Suivante

5. **Modifications en local, déploiement à la fin**
   - Décision: Toutes retouches en local, un seul déploiement final
   - Rationale: Plus efficace que déployer après chaque page (58 pages!)
   - Utilisateur a dit: "on modifie et on corrige en local et après on déploie tout d'un coup"

</decisions_made>

<blockers>

**BLOCKER CRITIQUE: Authentification fonctionnelle mais requêtes API 401**

**Symptômes:**
- Login réussit (POST /api/trpc/auth.login → 200 OK)
- auth.me fonctionne (GET /api/trpc/auth.me → 200 OK)
- Toutes autres requêtes échouent:
  - notifications.list → 401
  - notifications.unread → 401
  - organizations.get → 401
  - clients.list → 401
  - rooms.list → 401

**Hypothèse racine:**
Les cookies de session ne sont pas envoyés avec les requêtes tRPC subséquentes. Problème de configuration cookies entre domaines différents (localhost:5174 ↔ localhost:3002).

**Pistes de résolution:**
1. Vérifier configuration cookies dans packages/server (sameSite, domain, secure, credentials)
2. Vérifier tRPC client envoie credentials: 'include' dans packages/client/src/main.tsx
3. Vérifier Redis session fonctionne correctement (rsm-redis container UP)
4. Alternative: Utiliser Docker client (localhost:8080) au lieu de Vite dev pour validation initiale

**Note importante:** L'utilisateur a insisté pour corriger le bug avant de continuer ("tu viens de créer un bug et tu veux qu'on laisse comme ça?? c'est pas trop une logique à long terme......")

</blockers>

<context>

**Approche de travail:**
Cette phase est très différente des autres - c'est du travail itératif collaboratif, pas de l'exécution autonome.

**Workflow prévu:**
1. Claude présente la page actuelle
2. Utilisateur indique les retouches visuelles à faire
3. Claude applique via Edit tool
4. Utilisateur vérifie dans navigateur localhost:5174
5. On passe à la suivante

**Mindset technique:**
- Modifications TailwindCSS principalement (classes utilitaires)
- Pas de refonte, juste du polish (spacing, padding, alignment, colors)
- Préserver: Dark mode, responsive, tests E2E, fonctionnalités
- Éviter: Breaking changes sur formulaires

**État mental au moment de la pause:**
- Dashboard modifié avec 3 retouches ciblées
- Setup Vite dev local fonctionnel (Vite démarre, login OK)
- Mais bloqué sur 401 pour toutes les requêtes API après login
- Frustration: Le bug CORS a été corrigé mais un nouveau bug session est apparu
- Besoin: Résoudre ce problème avant de continuer avec les 57 pages restantes

**Fichiers déjà analysés:**
- Dashboard.tsx: 658 lignes, retouches appliquées
- Sessions.tsx: 289 lignes lues, bug détecté ligne 222-223 (statut en minuscules au lieu de getStatusLabel())

**Processus Vite lancé en arrière-plan:**
- Task ID: b1b8bcb
- Commande: `pnpm --filter client dev`
- Status: Running

</context>

<next_action>

**Au redémarrage de la session:**

**ÉTAPE 1: Résoudre le blocker 401 (PRIORITÉ ABSOLUE)**

Vérifier configuration session/cookies:

1. Lire `packages/client/src/main.tsx`:
   - Vérifier tRPC client a `credentials: 'include'`
   - Vérifier httpBatchLink configuration

2. Lire `packages/server/src/index.ts` ou `packages/server/src/middleware/cors.ts`:
   - Vérifier CORS credentials: true
   - Vérifier configuration session cookies (sameSite, domain, secure)

3. Tester si Redis fonctionne:
   ```bash
   docker exec rsm-redis redis-cli ping
   ```

4. Alternative temporaire si blocage persiste:
   - Utiliser Docker client (localhost:8080) pour validation Dashboard
   - Retour à Vite dev une fois session résolue

**ÉTAPE 2: Une fois 401 résolu:**

1. Valider Dashboard retouches visuellement
2. Demander feedback utilisateur: "Les retouches Dashboard sont bonnes?"
3. Si oui → Marquer Task 1 complète, passer à Sessions.tsx
4. Si non → Ajuster selon feedback

**ÉTAPE 3: Continuer avec Sessions.tsx**
- Corriger bug ligne 222-223 (statut display)
- Demander retouches UI utilisateur
- Appliquer changements
- Valider

**Commande pour reprendre:**
```bash
/gsd:resume-work
```

**Fichiers à surveiller:**
- packages/client/src/main.tsx (tRPC client config)
- packages/server/src/index.ts (session/CORS config)
- packages/client/src/pages/Dashboard.tsx (retouches appliquées)
- packages/client/src/pages/Sessions.tsx (bug + retouches à faire)

</next_action>

<files_modified>

**Fichiers modifiés (non commités):**
```
M .planning/ROADMAP.md
M .planning/STATE.md
M packages/client/src/pages/Dashboard.tsx
M packages/client/vite.config.ts
M packages/client/.env
M docker-compose.yml
M CLAUDE.md
M README.md
M start.sh
M playwright.config.ts
M .env.example
M e2e/README.md
?? .planning/phases/3.14-ameliorations-ui-toutes-pages/3.14-01-PLAN.md
?? .planning/phases/3.14-ameliorations-ui-toutes-pages/.continue-here.md
```

**Changements critiques:**
1. Dashboard.tsx: 3 retouches UI (lignes 85, 320, 431-607)
2. vite.config.ts: Proxy 3001 → 3002
3. .env: VITE_API_URL vers 3002
4. docker-compose.yml: CORS + localhost:5174

**Processus en arrière-plan:**
- Vite dev server (task b1b8bcb) sur localhost:5174

</files_modified>
