---
phase: 12-tasks-chrono-timer-database
plan: 1
type: execute
---

<objective>
Create database schema for time tracking system with task types and time entries.

Purpose: Foundation for timer functionality - stores task types (Setup/Recording/Mixing/Mastering/Break) with hourly rates and time entries with start/stop timestamps.
Output: Two new tenant database tables (task_types, time_entries) with migrations and TypeScript types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Current Architecture:**
- Database-per-tenant: Each organization has separate PostgreSQL database
- Existing tenant tables: clients, sessions, invoices, projects, equipment, rooms
- Drizzle ORM used for schema definition and migrations
- Migration pattern: `packages/database/drizzle/tenant/` directory

**Relevant Files:**
@packages/database/src/tenant/schema.ts
@packages/database/drizzle.config.ts

**Phase Context:**
Phase 12 builds time tracking for studio sessions. This plan creates the database foundation. Future plans (12-02, 12-03) will add backend logic and real-time UI.

**Business Requirements:**
- Track time spent on different task types during sessions
- Support manual time entry and adjustments
- Calculate costs based on hourly rates per task type
- Link time entries to either sessions OR projects (flexible architecture from Phase 14)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task_types table schema</name>
  <files>packages/database/src/tenant/schema.ts</files>
  <action>
Add task_types table to tenant schema after existing tables. Schema:
- id: serial primary key
- name: varchar(100) not null (e.g., "Setup", "Recording", "Mixing", "Mastering", "Break")
- description: text nullable (detailed explanation of task type)
- hourlyRate: decimal(10, 2) not null (default rate in organization currency)
- isActive: boolean not null default true (soft delete - hide inactive types)
- category: varchar(50) not null default "billable" ("billable" | "non-billable" for breaks)
- color: varchar(7) nullable (hex color for UI display, e.g., "#FF5733")
- sortOrder: integer default 0 (for UI ordering)
- createdAt: timestamp not null defaultNow()
- updatedAt: timestamp not null defaultNow()

Export TypeScript types: TaskType, InsertTaskType
</action>
  <verify>
- TypeScript compilation succeeds: `pnpm --filter database check`
- Schema file has task_types table definition
- Types exported correctly
  </verify>
  <done>task_types table defined in schema with all fields and TypeScript types exported</done>
</task>

<task type="auto">
  <name>Task 2: Create time_entries table schema and generate migration</name>
  <files>packages/database/src/tenant/schema.ts, packages/database/drizzle/tenant/[timestamp]_*.sql</files>
  <action>
Add time_entries table to tenant schema after task_types. Schema:
- id: serial primary key
- taskTypeId: integer not null references task_types(id)
- sessionId: integer nullable references sessions(id) on delete set null (links to session if time tracked during session)
- projectId: integer nullable references projects(id) on delete set null (alternative: time tracked directly on project)
- startTime: timestamp not null (when timer started)
- endTime: timestamp nullable (when timer stopped - null means currently running)
- durationMinutes: integer nullable (calculated duration in minutes, stored for performance)
- hourlyRateSnapshot: decimal(10, 2) not null (snapshot of task_type hourly rate at time of entry - protects historical data if rates change)
- manuallyAdjusted: boolean not null default false (true if user edited start/end times after auto-tracking)
- notes: text nullable (optional notes about this time entry)
- createdBy: integer nullable (FK to master.users for future multi-user tracking)
- createdAt: timestamp not null defaultNow()
- updatedAt: timestamp not null defaultNow()

Add constraint: CHECK (sessionId IS NOT NULL OR projectId IS NOT NULL) to ensure time entry links to at least one entity.

Export TypeScript types: TimeEntry, InsertTimeEntry

After schema definition, generate migration:
```bash
DATABASE_URL="postgresql://postgres:password@localhost:5432/rsm_master" pnpm --filter database db:generate
```

This creates migration SQL in packages/database/drizzle/tenant/ directory.
  </action>
  <verify>
- TypeScript compilation succeeds: `pnpm --filter database check`
- time_entries table defined with all fields and constraint
- Migration file created in packages/database/drizzle/tenant/
- Migration SQL contains CREATE TABLE statements for both task_types and time_entries
- Foreign key references are correct
  </verify>
  <done>time_entries table schema complete, migration generated, TypeScript types exported, all checks pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter database check` passes with 0 TypeScript errors
- [ ] Migration file exists in packages/database/drizzle/tenant/
- [ ] Both tables (task_types, time_entries) defined in schema.ts
- [ ] All TypeScript types exported correctly
- [ ] CHECK constraint on time_entries validates sessionId OR projectId
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Database schema ready for backend implementation (Plan 12-02)
</success_criteria>

<output>
After completion, create `.planning/phases/12-tasks-chrono-timer-database/12-01-SUMMARY.md`:

# Phase 12 Plan 1: Database Schema Summary

**Database foundation for time tracking system created**

## Accomplishments

- Created task_types table (9 fields: name, hourlyRate, category, color, etc.)
- Created time_entries table (13 fields: timestamps, duration, rate snapshot, manual adjustments)
- Generated Drizzle migration for both tables
- Added CHECK constraint ensuring time entries link to session OR project

## Files Created/Modified

- `packages/database/src/tenant/schema.ts` - Added 2 tables with TypeScript types
- `packages/database/drizzle/tenant/[timestamp]_*.sql` - Migration SQL

## Decisions Made

- Snapshot hourlyRate in time_entries to preserve historical rates when task_type rates change
- Support flexible linking: time entries can attach to sessions OR projects (Phase 14 compatibility)
- Soft delete on task_types (isActive flag) to preserve historical data integrity
- Store durationMinutes for query performance (avoid timestamp calculations)

## Issues Encountered

None

## Next Step

Ready for 12-02-PLAN.md (Timer Backend Logic & tRPC Endpoints)
</output>
