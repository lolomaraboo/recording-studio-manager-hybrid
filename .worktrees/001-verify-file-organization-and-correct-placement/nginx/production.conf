# Nginx Production Configuration
# Recording Studio Manager - Hybrid TypeScript Version
# VPS: recording-studio-manager.com (31.220.104.244)

# ===================================
# Upstream Backend (Node.js + tRPC)
# ===================================
upstream node_app {
    server 127.0.0.1:3000 fail_timeout=10s max_fails=3;
    keepalive 32;  # Keep-alive connections for performance
}

# ===================================
# Upstream Frontend (React SPA)
# ===================================
upstream frontend_app {
    server 127.0.0.1:8080 fail_timeout=10s max_fails=3;
    keepalive 16;
}

# ===================================
# Rate Limiting Zones
# ===================================
# API rate limiting (general)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# Login rate limiting (stricter)
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

# Webhook rate limiting
limit_req_zone $binary_remote_addr zone=webhook_limit:10m rate=100r/s;

# ===================================
# Connection Limiting
# ===================================
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ===================================
# HTTP â†’ HTTPS Redirect
# ===================================
server {
    listen 80;
    listen [::]:80;
    server_name .recording-studio-manager.com;

    # Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect all HTTP to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# ===================================
# HTTPS Server (Main Application)
# ===================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name .recording-studio-manager.com;

    # ===================================
    # SSL Certificate Configuration
    # ===================================
    ssl_certificate /etc/letsencrypt/live/recording-studio-manager.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/recording-studio-manager.com/privkey.pem;

    # SSL protocols and ciphers (modern configuration)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL session cache
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/recording-studio-manager.com/chain.pem;

    # ===================================
    # Security Headers
    # ===================================
    # HSTS (HTTP Strict Transport Security)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # XSS Protection (legacy browsers)
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer Policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions Policy (formerly Feature Policy)
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Content Security Policy (adjust as needed)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.stripe.com; frame-src https://js.stripe.com; object-src 'none';" always;

    # ===================================
    # Connection Limits
    # ===================================
    limit_conn conn_limit 10;  # Max 10 connections per IP

    # ===================================
    # Logging
    # ===================================
    access_log /var/log/nginx/recording-studio-manager-access.log combined;
    error_log /var/log/nginx/recording-studio-manager-error.log warn;

    # ===================================
    # Client Settings
    # ===================================
    client_max_body_size 100M;  # Allow large file uploads (audio files)
    client_body_timeout 300s;
    client_header_timeout 60s;

    # ===================================
    # Gzip Compression
    # ===================================
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    # ===================================
    # Health Check Endpoint
    # ===================================
    location /health {
        proxy_pass http://node_app/health;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        access_log off;  # Don't log health checks
    }

    # ===================================
    # API Routes (tRPC)
    # ===================================
    location /api/trpc/ {
        # Rate limiting
        limit_req zone=api_limit burst=20 nodelay;

        # Proxy to Node.js backend
        proxy_pass http://node_app;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Connection "";

        # Timeouts (longer for SSE/streaming)
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # No buffering for tRPC subscriptions/SSE
        proxy_buffering off;
        proxy_cache off;
    }

    # ===================================
    # Upload Routes
    # ===================================
    location /api/upload/ {
        # Rate limiting
        limit_req zone=api_limit burst=10 nodelay;

        # Proxy to Node.js backend
        proxy_pass http://node_app;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts (longer for large file uploads)
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Request buffering
        proxy_request_buffering off;
    }

    # ===================================
    # Webhook Routes (Stripe, etc.)
    # ===================================
    location /api/webhooks/ {
        # Rate limiting (more permissive for webhooks)
        limit_req zone=webhook_limit burst=50 nodelay;

        # Proxy to Node.js backend
        proxy_pass http://node_app;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # No buffering (preserve raw body for signature verification)
        proxy_request_buffering off;
        proxy_buffering off;
    }

    # ===================================
    # AI Streaming Endpoint
    # ===================================
    location /api/ai/stream {
        # Rate limiting
        limit_req zone=api_limit burst=5 nodelay;

        # Proxy to Node.js backend
        proxy_pass http://node_app;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # SSE specific settings
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 3600s;  # 1 hour for long AI streams
        chunked_transfer_encoding on;
    }

    # ===================================
    # Frontend SPA (React App)
    # ===================================
    location / {
        # Proxy to frontend container
        proxy_pass http://frontend_app;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Caching for static assets
        proxy_cache_bypass $http_upgrade;
    }

    # ===================================
    # Static Assets Caching
    # ===================================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|otf)$ {
        proxy_pass http://frontend_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        # Cache static assets
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ===================================
    # Deny Access to Hidden Files
    # ===================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
