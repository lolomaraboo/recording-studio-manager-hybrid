---
phase: 02-complete-phase-5
plan: 2
type: execute
---

<objective>
Create comprehensive integration tests for Projects Management backend (tRPC routers).

Purpose: Validate all projects and tracks API endpoints work correctly with proper type safety, error handling, and database operations. Complements E2E UI tests from 02-01 with backend logic verification.

Output: Integration test suites for projects and tracks routers using Vitest, ensuring backend reliability before Phase 3 billing integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase summary:**
@.planning/phases/02-complete-phase-5/02-01-SUMMARY.md

**Codebase context:**
@packages/server/src/__tests__/routers.test.ts - Existing test pattern with mock context
@packages/server/src/routers/projects.ts - Projects router endpoints to test
@packages/server/src/_core/trpc.ts - tRPC setup with protectedProcedure

**Prior decisions affecting this phase:**
- Database-per-Tenant architecture requires mock tenant DB in tests (Phase Init)
- Vitest chosen for backend testing (existing pattern in routers.test.ts)
- Phase 5 Projects Management feature complete (02-01 validated UI works)

**What this completes:**
- Phase 2 Plan 2 (final plan in Phase 2)
- Backend validation of Phase 5 Projects Management
- Test coverage foundation for future features (Phase 3-8)

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration tests for projects router</name>
  <files>packages/server/src/__tests__/projects.test.ts</files>
  <action>
Create Vitest test suite for projects router following the pattern in routers.test.ts.

Tests to implement:
- **list()**: Verify returns array of projects for authenticated user with tenant DB
- **get()**: Verify returns project with tracks, throws error if not found
- **create()**: Verify creates project with valid input, returns created project with ID
- **update()**: Verify updates project fields, throws error if project doesn't exist
- **delete()**: Verify removes project and cascades to tracks

Mock setup:
- Use createMockContext() pattern from routers.test.ts
- Create mock tenant DB with in-memory data structure OR use test database
- Mock tenantDb.select(), .insert(), .update(), .delete() methods
- Include test for unauthenticated access (should throw UNAUTHORIZED)

Type safety:
- Verify input validation (z.object schemas work correctly)
- Test enum values (type: "album" | "ep" | etc.)
- Verify required vs optional fields

Error cases:
- Project not found (get with invalid ID)
- Missing required fields (create without name)
- No tenant DB available (should throw error)
  </action>
  <verify>npm test projects.test.ts passes all tests</verify>
  <done>All CRUD operations tested, error cases covered, type safety validated</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for tracks router</name>
  <files>packages/server/src/__tests__/tracks.test.ts</files>
  <action>
Create Vitest test suite for tracks router (if separate router exists, otherwise add to projects.test.ts).

Key endpoints to test:
- **list()**: Get all tracks for a project
- **get()**: Get single track with details
- **create()**: Create track with Phase 5 fields (17 new fields including versioning)
- **update()**: Update track metadata
- **updateVersionUrl()**: Update version URLs (demoUrl, roughMixUrl, finalMixUrl, masterUrl)
- **addComment()**: Add comment to track (if endpoint exists)

Focus on Phase 5 specific fields:
- Versioning URLs: demoUrl, roughMixUrl, finalMixUrl, masterUrl
- Copyright metadata: composer, lyricist, copyrightHolder, genreTags
- Technical details: patchPreset, instrumentsUsed, effectsChain

Mock setup:
- Same pattern as projects tests
- Mock track with all 34 fields populated
- Verify nullable vs required fields work correctly

Error cases:
- Track not found
- Invalid projectId (foreign key constraint)
- Invalid enum values (status field)
  </action>
  <verify>npm test tracks.test.ts passes all tests (or projects.test.ts if combined)</verify>
  <done>Track CRUD tested, versioning fields validated, Phase 5 specific functionality verified</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify coverage</name>
  <files>package.json (verify test script exists)</files>
  <action>
Run complete test suite to ensure new tests don't break existing tests.

Commands to run:
1. `npm test` - Run all tests (both new and existing)
2. Verify output shows:
   - routers.test.ts: All existing tests pass (auth, sessions, etc.)
   - projects.test.ts: All new projects tests pass
   - tracks.test.ts: All new tracks tests pass (or projects.test.ts if combined)
3. Check for any console errors or warnings
4. Verify test execution time is reasonable (<30s total)

If any tests fail:
- Check mock setup matches actual router implementation
- Verify Drizzle ORM mock methods are correctly structured
- Ensure test data matches schema requirements

Document coverage:
- Count total endpoints tested
- Note any endpoints NOT tested (intentionally skipped)
- Verify error handling paths are covered
  </action>
  <verify>npm test completes successfully with all tests passing</verify>
  <done>All tests pass, no console errors, integration test coverage complete for Phase 5 backend</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm test` passes with 0 failures
- [ ] All projects router endpoints have test coverage
- [ ] All tracks router endpoints have test coverage
- [ ] Error cases tested (unauthorized, not found, validation errors)
- [ ] No breaking changes to existing tests (routers.test.ts still passes)
</verification>

<success_criteria>
- All 3 tasks completed
- Integration tests created for projects and tracks routers
- All tests pass successfully
- Phase 5 backend functionality validated
- Test foundation established for future phases
</success_criteria>

<output>
After completion, create `.planning/phases/02-complete-phase-5/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Integration Testing Projects Management Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Performance

- **Duration:** [X] min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 3 (all auto)
- **Files created:** 1-2 test files

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Files Created/Modified

- `packages/server/src/__tests__/projects.test.ts` - Projects router integration tests
- `packages/server/src/__tests__/tracks.test.ts` - Tracks router integration tests (if separate)

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Deviations following Rule 5 format, or "None - plan executed as specified"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- ✅ Phase 2 complete (both plans finished)
- ✅ Backend integration tests provide regression coverage for Phase 3-8
- ✅ Ready to proceed to Phase 3: Billing Infrastructure

---
*Phase: 02-complete-phase-5*
*Completed: [date]*
</output>
