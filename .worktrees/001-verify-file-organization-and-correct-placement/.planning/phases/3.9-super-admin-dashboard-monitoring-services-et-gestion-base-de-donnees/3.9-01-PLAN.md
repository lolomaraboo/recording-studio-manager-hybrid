---
phase: 3.9-super-admin-dashboard-monitoring-services-et-gestion-base-de-donnees
plan: 01
type: execute
---

<objective>
Build backend infrastructure for super admin dashboard - Docker monitoring, database management, and system logs.

Purpose: Enable production system administration without SSH access, providing APIs for container management, tenant stats, and log viewing.
Output: Superadmin tRPC router with Docker API integration, database query endpoints, and system metrics collection.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Database-per-Tenant architecture (Phase Init) - Need to query across all tenant DBs for stats
- VPS deployment on Hostinger (Phase Init) - Docker containers running locally
- No existing superadmin concept - Building from scratch

**Production infrastructure:**
- Docker containers: rsm-client, rsm-server, rsm-postgres, rsm-redis, qdrant
- VPS: 4GB RAM, 2 vCPU, Ubuntu with Docker Compose
- Database: PostgreSQL master (rsm_master) + dynamic tenant DBs (tenant_N)
- Monitoring: Health endpoints exist (`/api/health`), Uptime Kuma configured

**Relevant source files:**
@packages/server/src/index.ts
@packages/server/src/context.ts
@packages/database/src/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dockerode and create superadmin middleware</name>
  <files>packages/server/package.json, packages/server/src/middleware/superadmin.ts, packages/server/src/routers/superadmin.ts</files>
  <action>
    1. Install dockerode library: `pnpm --filter @rsm/server add dockerode @types/dockerode`
    2. Create superadmin middleware that checks if user email matches `SUPERADMIN_EMAIL` environment variable
    3. Middleware logic: Load user from session, compare email to process.env.SUPERADMIN_EMAIL, throw 403 if no match
    4. Create empty superadmin router skeleton with middleware protection
    5. Register superadmin router in packages/server/src/index.ts

    **What to avoid:** Don't hardcode superadmin email - MUST use environment variable for security.
    **Why:** Hardcoded emails = security risk if code exposed. ENV var = configurable per environment.
  </action>
  <verify>
    - `pnpm ls dockerode` shows version installed
    - packages/server/src/middleware/superadmin.ts exists with env var check
    - packages/server/src/routers/superadmin.ts exports protected router
    - TypeScript compiles without errors
  </verify>
  <done>
    - dockerode installed in server package
    - Superadmin middleware created with SUPERADMIN_EMAIL check
    - Empty superadmin router registered with middleware protection
    - No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Docker monitoring endpoints</name>
  <files>packages/server/src/routers/superadmin.ts, packages/server/src/lib/docker.ts</files>
  <action>
    1. Create docker utility at packages/server/src/lib/docker.ts using dockerode
    2. Connect to local Docker socket (/var/run/docker.sock)
    3. Implement functions: listContainers(), getContainerLogs(containerId, tail=100), getSystemInfo()
    4. Add tRPC endpoints to superadmin router:
       - `listContainers`: Returns name, status, uptime, image for all containers
       - `getContainerLogs`: Returns last N lines of logs for specified container
       - `getSystemMetrics`: Returns CPU usage, memory usage, disk usage from Docker API
    5. Handle Docker socket errors gracefully (if not accessible, return empty arrays with warning)

    **What to avoid:** Don't expose raw Docker API - filter to safe read-only operations only.
    **Why:** Security - raw Docker API could allow container manipulation beyond monitoring.
  </action>
  <verify>
    - packages/server/src/lib/docker.ts exports Docker utility functions
    - superadmin router has 3 new endpoints (listContainers, getContainerLogs, getSystemMetrics)
    - `pnpm --filter @rsm/server build` succeeds
    - Test manually: Call endpoints with superadmin auth
  </verify>
  <done>
    - Docker utility created with read-only operations
    - 3 monitoring endpoints added to superadmin router
    - Graceful error handling for Docker socket access
    - Build succeeds without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Database management and health endpoints</name>
  <files>packages/server/src/routers/superadmin.ts</files>
  <action>
    1. Add tRPC endpoints to superadmin router:
       - `listOrganizations`: Query rsm_master.organizations with user count, tenant DB name, subscription tier, created date
       - `listUsers`: Query rsm_master.users with email, organization, last login, created date
       - `getTenantStats`: For each tenant DB, count tables, estimate size using pg_database_size()
       - `aggregateHealth`: Call existing `/api/health` endpoint + check all container health status
    2. Use existing database connection patterns from packages/database/src/connection.ts
    3. Return formatted data ready for frontend display (no raw SQL in responses)
    4. Add pagination support for listOrganizations and listUsers (limit 50 per page default)

    **What to avoid:** Don't expose password hashes or sensitive user data in API responses.
    **Why:** Security - superadmin can see org/user list but not credentials.
  </action>
  <verify>
    - superadmin router has 4 new endpoints (listOrganizations, listUsers, getTenantStats, aggregateHealth)
    - Test queries against master DB return correct data
    - Pagination works (limit/offset parameters)
    - `pnpm --filter @rsm/server build` succeeds
  </verify>
  <done>
    - 4 database/health endpoints added to superadmin router
    - Pagination implemented for list endpoints
    - No sensitive data exposed (passwords filtered out)
    - Build succeeds without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @rsm/server build` succeeds without errors
- [ ] Superadmin middleware blocks non-superadmin users (401/403 response)
- [ ] Docker endpoints return container data when called with superadmin auth
- [ ] Database endpoints return organization/user lists
- [ ] No TypeScript errors or warnings introduced
</verification>

<success_criteria>

- All 3 tasks completed
- dockerode library installed and integrated
- Superadmin middleware protects all routes with SUPERADMIN_EMAIL check
- 7 tRPC endpoints functional (3 Docker + 4 database/health)
- No sensitive data exposed in API responses
- Build succeeds without errors
- Ready for frontend integration (Plan 3.9-02)
</success_criteria>

<output>
After completion, create `.planning/phases/3.9-super-admin-dashboard-monitoring-services-et-gestion-base-de-donnees/3.9-01-SUMMARY.md`:

# Phase 3.9 Plan 1: Backend Infrastructure Summary

**Superadmin backend infrastructure built - Docker API, database queries, system monitoring**

## Accomplishments

- Installed dockerode for Docker container management
- Created superadmin middleware with SUPERADMIN_EMAIL environment variable protection
- Implemented 3 Docker monitoring endpoints (containers, logs, metrics)
- Implemented 4 database/health endpoints (organizations, users, tenant stats, health aggregation)
- Graceful error handling for Docker socket access
- Pagination support for list endpoints

## Files Created/Modified

- `packages/server/package.json` - Added dockerode dependency
- `packages/server/src/middleware/superadmin.ts` - Superadmin auth middleware (NEW)
- `packages/server/src/lib/docker.ts` - Docker utility functions (NEW)
- `packages/server/src/routers/superadmin.ts` - Superadmin tRPC router with 7 endpoints (NEW)
- `packages/server/src/index.ts` - Registered superadmin router

## Decisions Made

- Used environment variable SUPERADMIN_EMAIL for access control (not hardcoded email)
- Read-only Docker operations only (no container restart/stop for safety)
- Filtered sensitive data from API responses (password hashes excluded)
- Pagination default 50 items per page for scalability

## Issues Encountered

None

## Next Step

Ready for 3.9-02-PLAN.md (Frontend Dashboard UI)
</output>
