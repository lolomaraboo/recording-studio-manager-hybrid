---
phase: 3.9.1-notes-avec-historique-date-pour-clients
plan: 02
type: execute
---

<objective>
Create frontend UI for client notes history - React component with timeline display, add note form, and integration into ClientDetail page.

Purpose: Replace single textarea with professional dated notes system for better client relationship management UX.
Output: NotesHistory component, integrated ClientDetail page, user-friendly interface for viewing and adding timestamped notes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/3.9.1-notes-avec-historique-date-pour-clients/3.9.1-01-SUMMARY.md

**Backend Ready (Plan 1):**
- client_notes table operational
- tRPC router: clientNotes.list, clientNotes.create, clientNotes.delete
- clients.getById includes client_notes relation

**Current Frontend:**
- ClientDetail.tsx has single notes textarea (line ~472)
- Simple onBlur save to clients.notes field
- No history, no timestamps displayed

**Established UI Patterns:**
- shadcn/ui components (Card, Button, Textarea, Dialog)
- French date formatting (packages/client/src/lib/formatDate.ts)
- Delete confirmations (DeleteDialog component pattern)
- Loading states (Skeleton components)
- Toast notifications for success/error

**Component Patterns:**
- TrackDetail.tsx - Timeline/history display with cards
- SessionDetail.tsx - Form + list pattern
- ClientDetail.tsx - Existing component to modify

**From Phase 3.6:**
- Breadcrumb navigation pattern established
- Consistent UX across admin pages

**From Phase 3.7:**
- tRPC cache invalidation pattern (trpc.useUtils())
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotesHistory component</name>
  <files>packages/client/src/components/NotesHistory.tsx</files>
  <action>
    Create new component packages/client/src/components/NotesHistory.tsx:

    **Structure:**
    1. **Props interface:**
       - clientId: number
       - className?: string

    2. **tRPC hooks:**
       - const notes = trpc.clientNotes.list.useQuery({ clientId })
       - const createNote = trpc.clientNotes.create.useMutation()
       - const deleteNote = trpc.clientNotes.delete.useMutation()
       - const utils = trpc.useUtils()

    3. **Add Note Form (top of component):**
       - Textarea for new note input
       - "Ajouter une note" button (primary)
       - onSubmit: createNote.mutate() → invalidate queries → toast success
       - Clear textarea after successful creation

    4. **Notes Timeline (below form):**
       - If no notes: Empty state "Aucune note pour ce client"
       - Map over notes array in reverse chronological order
       - Each note card displays:
         - Note text (whitespace preserved)
         - Date: formatDate(note.createdAt, 'fr-FR') with time
         - Delete button (trash icon, small, right-aligned)
       - Delete confirmation: "Supprimer cette note ?" dialog

    5. **Loading/Error states:**
       - Show Skeleton while notes.isLoading
       - Error message if notes.error
       - Optimistic UI: Show new note immediately, revert on error

    **Styling:**
    - Use Card component for each note
    - Timeline connector between notes (vertical line)
    - Responsive: Stack on mobile
    - Max height with scroll if >5 notes

    Pattern reference: Similar timeline to TrackDetail.tsx Phase 5 cards
  </action>
  <verify>
    - Component compiles without TypeScript errors
    - All tRPC hooks type-check correctly
    - Props interface matches usage
  </verify>
  <done>
    - NotesHistory component created
    - Add note form functional
    - Timeline display implemented
    - Delete with confirmation working
    - Loading/error states handled
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate NotesHistory into ClientDetail page</name>
  <files>packages/client/src/pages/ClientDetail.tsx</files>
  <action>
    Update packages/client/src/pages/ClientDetail.tsx:

    1. **Import NotesHistory:**
       - Add: `import { NotesHistory } from '@/components/NotesHistory'`

    2. **Replace old notes textarea section (~line 472):**
       - Remove: Existing textarea + onBlur handler for notes field
       - Add: `<NotesHistory clientId={client.id} />`
       - Keep section heading: "Notes" or similar

    3. **Update layout:**
       - Place NotesHistory in existing Card/section structure
       - Maintain consistent spacing with other sections
       - Ensure responsive layout on mobile

    4. **Remove old notes update logic:**
       - Remove notes field from updateClient mutation if present
       - Keep all other client fields intact (name, email, phone, etc.)

    5. **Cache invalidation:**
       - Verify clientNotes mutations invalidate clients.getById
       - Should already work via utils.invalidate() in NotesHistory

    **DO NOT TOUCH:**
    - Breadcrumb navigation (Phase 3.6)
    - Other client fields and sections
    - Delete client functionality
    - Portal access toggle
    - VIP status toggle
  </action>
  <verify>
    - `pnpm build` succeeds in packages/client
    - No TypeScript errors
    - ClientDetail page compiles
  </verify>
  <done>
    - NotesHistory component integrated
    - Old notes textarea removed
    - Layout preserved and responsive
    - No regressions in other functionality
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Client notes history UI with dated timeline display and add note form</what-built>
  <how-to-verify>
    1. Run: `cd packages/client && pnpm build && cd ../.. && rsync -avz packages/client/ vps-n8n:/root/recording-studio-manager-hybrid/packages/client/`
    2. Rebuild client container: `ssh vps-n8n "cd /root/recording-studio-manager-hybrid && docker-compose build client && docker-compose restart client"`
    3. Visit: https://recording-studio-manager.com/clients
    4. Click on any existing client (e.g., "Alice Smith")
    5. Scroll to Notes section
    6. Test add note:
       - Type "Test note - first entry" in textarea
       - Click "Ajouter une note" button
       - Verify: Note appears in timeline with current date/time
       - Verify: Textarea clears after submit
       - Verify: Toast success message appears
    7. Test add multiple notes:
       - Add "Test note - second entry"
       - Add "Test note - third entry"
       - Verify: Notes display in reverse chronological order (newest first)
       - Verify: Each note shows timestamp
       - Verify: Timeline visual connector between notes
    8. Test delete note:
       - Click trash icon on middle note
       - Verify: Confirmation dialog appears "Supprimer cette note ?"
       - Click "Supprimer"
       - Verify: Note removed from timeline
       - Verify: Toast success message
    9. Test empty state:
       - Create new client without notes
       - Visit detail page
       - Verify: Shows "Aucune note pour ce client" message
    10. Test responsive:
        - Resize browser to mobile width (375px)
        - Verify: Timeline stacks properly
        - Verify: Add note form usable on mobile
        - Verify: Delete buttons accessible
    11. Test backward compatibility:
        - Check client that had old notes field populated
        - Verify: Old note text still accessible (or migration handled)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds in packages/client
- [ ] NotesHistory component renders without errors
- [ ] Add/delete notes works in production
- [ ] No visual regressions in ClientDetail page
- [ ] Responsive layout works on mobile
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Client notes history functional in production
- Professional timeline UI matching app design system
- No breaking changes to existing client management
- User can add, view, and delete dated notes
</success_criteria>

<output>
After completion, create `.planning/phases/3.9.1-notes-avec-historique-date-pour-clients/3.9.1-02-SUMMARY.md`:

# Phase 3.9.1 Plan 2: Frontend UI Summary

**Professional dated notes timeline for client relationship management**

## Accomplishments

- Created NotesHistory component with timeline display
- Integrated into ClientDetail page replacing single textarea
- Add note form with real-time updates
- Delete confirmation dialog for safety
- Responsive mobile layout
- French date formatting with timestamps

## Files Created/Modified

- `packages/client/src/components/NotesHistory.tsx` - New timeline component
- `packages/client/src/pages/ClientDetail.tsx` - Integrated NotesHistory

## Decisions Made

- Reverse chronological order (newest first) for quick access to latest notes
- Timeline visual connector for better UX (similar to TrackDetail pattern)
- Optimistic UI updates for instant feedback
- Delete confirmation to prevent accidental deletions
- Empty state message for clients without notes

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 3.9.1 complete - ready for Phase 4 (Marketing Foundation)
</output>
