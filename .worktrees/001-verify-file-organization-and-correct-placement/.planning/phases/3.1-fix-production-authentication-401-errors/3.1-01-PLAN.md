---
phase: 3.1-fix-production-authentication-401-errors
plan: 01
type: execute
---

<objective>
Fix critical production authentication failures preventing all API access.

Purpose: Resolve 401 Unauthorized errors on all tRPC endpoints and WebSocket "No authentication token found" errors by fixing cookie configuration for HTTPS subdomain authentication.
Output: Production authentication working end-to-end - users can login and access protected endpoints across subdomains.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Codebase constraints:**
- Multi-tenant architecture using subdomains (https://{studio}.recording-studio-manager.com)
- Session-based auth with express-session + Redis storage
- Production uses Nginx reverse proxy in front of Node.js server
- CORS already configured for HTTPS subdomains (Phase 1 fix)

**Prior decisions affecting this phase:**
- Database-per-Tenant architecture requires organizationId in session
- CORS pattern allows https://*.recording-studio-manager.com (Phase 1)
- Production uses wildcard SSL certificate (Let's Encrypt)

**Root cause analysis:**
Current cookie configuration in `packages/server/src/index.ts`:
```javascript
cookie: {
  secure: process.env.NODE_ENV === 'production',
  httpOnly: true,
  maxAge: 1000 * 60 * 60 * 24 * 7, // 7 days
}
```

**Missing critical settings:**
1. **domain**: Needs `.recording-studio-manager.com` (with leading dot) for subdomain sharing
2. **sameSite**: Needs explicit value ('lax' recommended) for cross-origin cookie transmission
3. **proxy trust**: Express needs `trust proxy` enabled when behind Nginx for `secure: true` to work

**Relevant source files:**
@packages/server/src/index.ts
@packages/server/src/_core/context.ts
@packages/server/src/routers/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix session cookie configuration for production subdomains</name>
  <files>packages/server/src/index.ts</files>
  <action>
Update cookie configuration in session middleware:

1. Add `app.set('trust proxy', 1)` before session middleware (required for secure cookies behind Nginx)
2. Update cookie config to:
```javascript
cookie: {
  secure: process.env.NODE_ENV === 'production',
  httpOnly: true,
  maxAge: 1000 * 60 * 60 * 24 * 7, // 7 days
  domain: process.env.NODE_ENV === 'production' ? '.recording-studio-manager.com' : undefined,
  sameSite: process.env.NODE_ENV === 'production' ? 'lax' : 'strict',
}
```

**Why these settings:**
- `domain: '.recording-studio-manager.com'` (with leading dot) - Shares cookies across all subdomains (studio-a.recording-studio-manager.com, studio-b.recording-studio-manager.com)
- `sameSite: 'lax'` - Allows cookies on top-level navigation (GET requests) but blocks on cross-site POST. Better than 'none' (requires HTTPS) or 'strict' (too restrictive).
- `trust proxy: 1` - Tells Express to trust first proxy (Nginx) so `secure: true` cookies work correctly behind reverse proxy

**What to avoid:**
- DON'T use `sameSite: 'none'` - Requires `secure: true` always, more complex
- DON'T hardcode domain in all environments - Only production needs subdomain sharing
- DON'T forget trust proxy - Without it, Express won't set secure cookies behind Nginx
  </action>
  <verify>
1. Code changes applied correctly
2. Server restarts without errors
3. Check server logs show: "✅ Express trust proxy enabled for production"
  </verify>
  <done>Cookie configuration updated with domain, sameSite, and proxy trust settings</done>
</task>

<task type="auto">
  <name>Task 2: Add session debugging and validate cookie transmission</name>
  <files>packages/server/src/_core/context.ts</files>
  <action>
Add debug logging in createContext to diagnose session issues:

```javascript
export async function createContext(
  opts: CreateExpressContextOptions
): Promise<TrpcContext> {
  let user: User | null = null;
  let organizationId: number | null = null;
  let tenantDb: TenantDb | null = null;

  try {
    // Get user from session
    const session = opts.req.session as any;

    // Debug: Log session state (REMOVE after fix verified)
    if (process.env.NODE_ENV === 'production') {
      console.log('[Auth Debug] Session ID:', opts.req.sessionID);
      console.log('[Auth Debug] Session data:', { userId: session.userId, organizationId: session.organizationId });
      console.log('[Auth Debug] Cookie header:', opts.req.headers.cookie);
    }

    if (session.userId && session.organizationId) {
      // ... rest of existing code
    }
  } catch (error) {
    console.error('[Auth Error]:', error);
    // ... rest
  }
  // ...
}
```

**Purpose:** Verify that:
1. Session cookie is being sent by browser (check cookie header)
2. Redis session is found by sessionID
3. Session contains userId + organizationId

**Remove these debug logs after verification in Task 3.**
  </action>
  <verify>
1. Debug logging added to context.ts
2. Server rebuilds successfully (tsx watches for changes)
3. No TypeScript errors
  </verify>
  <done>Session debugging added, ready for production testing</done>
</task>

<task type="auto">
  <name>Task 3: Rebuild and deploy server container with fixes</name>
  <files>N/A (Docker deployment)</files>
  <action>
SSH to production VPS and update the server container:

```bash
# SSH to production
ssh root@31.220.104.244

# Navigate to project
cd /root/recording-studio-manager-hybrid

# Pull latest changes (assumes git committed)
git pull origin main

# Rebuild server container
docker-compose build server

# Restart server with new configuration
docker-compose restart server

# Verify container started successfully
docker-compose ps | grep rsm-server

# Check server logs for startup
docker-compose logs -f server --tail 50
```

**Look for in logs:**
- "✅ Express trust proxy enabled for production"
- "✅ Redis connected for session storage"
- Server starts without errors
  </action>
  <verify>
1. Git changes committed and pushed
2. Container rebuilt and restarted
3. Server logs show successful startup with new config
4. No connection errors to Redis
  </verify>
  <done>Production server running with updated cookie configuration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed session cookie configuration and deployed to production</what-built>
  <how-to-verify>
Test complete authentication flow in production:

1. **Clear browser cookies** - Important to test fresh login
   - Chrome: DevTools → Application → Cookies → Delete all for recording-studio-manager.com

2. **Register new test account:**
   - Visit: https://recording-studio-manager.com (or any subdomain)
   - Click "Sign Up"
   - Email: `test-auth-fix-[timestamp]@recording-studio-manager.com`
   - Password: `TestAuth2024!`
   - Studio name: `Test Auth Fix`

3. **Verify session cookie set:**
   - DevTools → Application → Cookies
   - Check cookie `connect.sid` exists with:
     - Domain: `.recording-studio-manager.com` ✓
     - Secure: true ✓
     - HttpOnly: true ✓
     - SameSite: Lax ✓

4. **Test protected endpoints:**
   - Navigate to Dashboard
   - Check browser console - NO 401 errors
   - Try creating a booking
   - Check Network tab - All tRPC requests return 200

5. **Test cross-subdomain (if multi-tenant enabled):**
   - Note your subdomain from URL
   - All subsequent navigation should work without re-login

6. **Check server logs:**
   ```bash
   ssh root@31.220.104.244
   docker-compose logs server --tail 100 | grep "Auth Debug"
   ```
   - Should see session data populated after login
   - Should NOT see "No authentication token found" errors

7. **Cleanup debug logs:**
   After verifying auth works, remove debug logging from context.ts (Task 2 changes)
  </how-to-verify>
  <resume-signal>Type "approved" if auth works end-to-end, or describe specific errors</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Session cookies set with correct domain (.recording-studio-manager.com)
- [ ] Login successful and redirects to dashboard
- [ ] Protected tRPC endpoints return 200 (not 401)
- [ ] WebSocket connection authenticated successfully
- [ ] No console errors on dashboard load
- [ ] Server logs show session data populated
</verification>

<success_criteria>
- All tasks completed
- Production authentication working end-to-end
- Users can register, login, and access protected endpoints
- Session persists across page refreshes
- No 401 errors in browser console
- Debug logging removed after verification
</success_criteria>

<output>
After completion, create `.planning/phases/3.1-fix-production-authentication-401-errors/3.1-01-SUMMARY.md`:

# Phase 3.1 Plan 01: Fix Production Authentication Summary

**Fixed critical session cookie configuration blocking all production API access**

## Accomplishments

- Added cookie domain configuration for subdomain sharing (`.recording-studio-manager.com`)
- Configured sameSite attribute for secure cross-origin cookie transmission
- Enabled Express trust proxy for cookies behind Nginx reverse proxy
- Validated complete auth flow in production (register → login → protected endpoints)

## Files Created/Modified

- `packages/server/src/index.ts` - Updated session cookie config (domain, sameSite, trust proxy)
- `packages/server/src/_core/context.ts` - Temporarily added debug logging (removed after verification)

## Decisions Made

- **Cookie domain**: `.recording-studio-manager.com` with leading dot for all subdomains
- **SameSite**: `lax` (balance between security and usability vs `strict` or `none`)
- **Proxy trust**: Enabled with value `1` (trust first proxy - Nginx)

## Issues Encountered

[Document any production-specific issues discovered during testing]

## Next Step

Phase 3.1 complete - Production authentication restored. Ready to continue with Phase 4 (Marketing Foundation).
</output>
