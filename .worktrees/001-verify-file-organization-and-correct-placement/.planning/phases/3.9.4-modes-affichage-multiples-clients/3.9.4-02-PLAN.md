---
phase: 3.9.4-modes-affichage-multiples-clients
plan: 02
type: execute
---

<objective>
Enable enriched client data entry at creation time with vCard 4.0 compatible fields.

Purpose: Allow users to enter comprehensive client information (structured name, multiple phones/emails, websites, address details, birthday, custom fields) when creating a new client, not just after creation. All enriched data should display in the "Informations enrichies" tab on ClientDetail page.

Output: Enhanced ClientCreate.tsx form with all vCard 4.0 fields, backend support, validation, and integration with EnrichedClientInfo display component.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/client/src/pages/ClientCreate.tsx
@packages/client/src/components/EnrichedClientInfo.tsx
@packages/database/src/tenant/schema.ts
@packages/server/src/routers/clients.ts

**Current State:**
- ClientCreate.tsx: Basic form with only name, email, phone, company, address, notes (173 lines)
- Database schema: 16 vCard fields available (firstName, lastName, phones array, emails array, websites, avatarUrl, logoUrl, birthday, gender, customFields, etc.)
- EnrichedClientInfo component: Displays all enriched fields in ClientDetail page (515 lines)
- Backend clients.create mutation: Currently maps only basic fields (line 106-136)

**User Requirements:**
- Add all vCard-compatible fields to creation form
- Group fields logically (Identity, Contact, Address, Additional Info)
- Support multiple phones/emails (dynamic arrays)
- Support file upload for avatar/logo at creation
- Display created client data in "Informations enrichies" tab automatically

**Constraints:**
- Keep form UX simple - use collapsible sections/tabs to avoid overwhelming
- Reuse existing EnrichedClientInfo logic where possible
- Maintain backward compatibility with basic client creation flow
- All enriched fields optional except name

**Prior Decisions:**
- Phase 3.9.4-01: vCard 4.0 implementation complete (migration 0004, upload endpoints, EnrichedClientInfo component)
- Upload service: Tenant-isolated file storage at /uploads/tenant_X/{avatars,logos}/
- Security: tenantFileAccess middleware validates ownership
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend backend clients.create mutation to accept enriched fields</name>
  <files>packages/server/src/routers/clients.ts</files>
  <action>
Enhance clients.create mutation (line 106-136) to accept all vCard 4.0 fields from frontend form.

1. Update input validation schema (line 107-116):
```typescript
create: protectedProcedure
  .input(
    z.object({
      // Basic fields (existing)
      name: z.string().min(2).max(200),
      email: z.string().email().optional(),
      phone: z.string().optional(),
      address: z.string().optional(),
      notes: z.string().optional(),

      // NEW: vCard enriched fields
      type: z.enum(['individual', 'company']).default('individual'),
      firstName: z.string().optional(),
      lastName: z.string().optional(),
      middleName: z.string().optional(),
      prefix: z.string().optional(),
      suffix: z.string().optional(),
      artistName: z.string().optional(),

      // Contact arrays
      phones: z.array(z.object({ type: z.string(), number: z.string() })).optional(),
      emails: z.array(z.object({ type: z.string(), email: z.string() })).optional(),
      websites: z.array(z.object({ type: z.string(), url: z.string() })).optional(),

      // Address details
      street: z.string().optional(),
      city: z.string().optional(),
      postalCode: z.string().optional(),
      region: z.string().optional(),
      country: z.string().optional(),

      // Additional info
      birthday: z.string().optional(), // ISO date string
      gender: z.string().optional(),
      customFields: z.array(z.object({ label: z.string(), type: z.string(), value: z.any() })).optional(),

      // File URLs (from upload endpoints)
      avatarUrl: z.string().optional(),
      logoUrl: z.string().optional(),
    })
  )
```

2. Update mutation implementation to map all fields (line 117-136):
```typescript
.mutation(async ({ ctx, input }) => {
  const tenantDb = await ctx.getTenantDb();

  // Map ALL provided fields (no exclusions)
  const clientData: any = {
    name: input.name,
    type: input.type || 'individual',
  };

  // Add optional basic fields
  if (input.email) clientData.email = input.email;
  if (input.phone) clientData.phone = input.phone;
  if (input.address) clientData.address = input.address;
  if (input.notes) clientData.notes = input.notes;

  // Add enriched structured name fields
  if (input.firstName) clientData.firstName = input.firstName;
  if (input.lastName) clientData.lastName = input.lastName;
  if (input.middleName) clientData.middleName = input.middleName;
  if (input.prefix) clientData.prefix = input.prefix;
  if (input.suffix) clientData.suffix = input.suffix;
  if (input.artistName) clientData.artistName = input.artistName;

  // Add contact arrays (set to empty array if not provided to match schema defaults)
  if (input.phones && input.phones.length > 0) clientData.phones = input.phones;
  if (input.emails && input.emails.length > 0) clientData.emails = input.emails;
  if (input.websites && input.websites.length > 0) clientData.websites = input.websites;

  // Add address details
  if (input.street) clientData.street = input.street;
  if (input.city) clientData.city = input.city;
  if (input.postalCode) clientData.postalCode = input.postalCode;
  if (input.region) clientData.region = input.region;
  if (input.country) clientData.country = input.country;

  // Add additional info
  if (input.birthday) clientData.birthday = input.birthday;
  if (input.gender) clientData.gender = input.gender;
  if (input.customFields && input.customFields.length > 0) clientData.customFields = input.customFields;

  // Add file URLs
  if (input.avatarUrl) clientData.avatarUrl = input.avatarUrl;
  if (input.logoUrl) clientData.logoUrl = input.logoUrl;

  const [client] = await tenantDb
    .insert(clients)
    .values(clientData)
    .returning();

  return client;
})
```

Avoid: Don't filter out any vCard fields. Accept all enriched data from frontend.
  </action>
  <verify>
1. TypeScript compilation succeeds: `pnpm build` in packages/server
2. tRPC schema validation passes for enriched input
3. Backend accepts all vCard fields without errors
  </verify>
  <done>
- clients.create input schema includes all 16+ vCard fields
- Mutation maps all provided enriched fields to database
- No TypeScript errors
- Backend ready to accept enriched client creation
  </done>
</task>

<task type="auto">
  <name>Task 2: Transform ClientCreate.tsx into tabbed form with enriched fields</name>
  <files>packages/client/src/pages/ClientCreate.tsx</files>
  <action>
Replace basic form with comprehensive tabbed interface for enriched client creation.

**1. Add state for all enriched fields (after line 27):**
```typescript
const [formData, setFormData] = useState({
  // Basic
  name: "",
  type: "individual" as "individual" | "company",

  // Structured name
  firstName: "",
  lastName: "",
  middleName: "",
  prefix: "",
  suffix: "",
  artistName: "",

  // Simple contact (backward compat)
  email: "",
  phone: "",

  // Address
  address: "",
  street: "",
  city: "",
  postalCode: "",
  region: "",
  country: "",

  // Additional
  birthday: "",
  gender: "",
  notes: "",

  // Files
  avatarUrl: "",
  logoUrl: "",
});

// Arrays state
const [phones, setPhones] = useState<Array<{type: string; number: string}>>([]);
const [emails, setEmails] = useState<Array<{type: string; email: string}>>([]);
const [websites, setWebsites] = useState<Array<{type: string; url: string}>>([]);
const [customFields, setCustomFields] = useState<Array<{label: string; type: string; value: any}>>([]);

// Tab state
const [activeTab, setActiveTab] = useState("basic");
```

**2. Add upload handlers for avatar/logo:**
```typescript
const handleAvatarUpload = async (file: File) => {
  const formData = new FormData();
  formData.append("file", file);

  const response = await fetch("/api/upload/avatar", {
    method: "POST",
    body: formData,
    credentials: "include",
  });

  if (!response.ok) throw new Error("Upload failed");
  const result = await response.json();
  setFormData(prev => ({ ...prev, avatarUrl: result.data.url }));
  toast.success("Avatar uploadé");
};

const handleLogoUpload = async (file: File) => {
  const formData = new FormData();
  formData.append("file", file);

  const response = await fetch("/api/upload/logo", {
    method: "POST",
    body: formData,
    credentials: "include",
  });

  if (!response.ok) throw new Error("Upload failed");
  const result = await response.json();
  setFormData(prev => ({ ...prev, logoUrl: result.data.url }));
  toast.success("Logo uploadé");
};
```

**3. Update handleSubmit to send all enriched data:**
```typescript
const handleSubmit = (e: React.FormEvent) => {
  e.preventDefault();

  if (!formData.name.trim() || formData.name.length < 2) {
    toast.error("Le nom est requis (min. 2 caractères)");
    return;
  }

  createMutation.mutate({
    name: formData.name,
    type: formData.type,

    // Structured name
    ...(formData.firstName && { firstName: formData.firstName }),
    ...(formData.lastName && { lastName: formData.lastName }),
    ...(formData.middleName && { middleName: formData.middleName }),
    ...(formData.prefix && { prefix: formData.prefix }),
    ...(formData.suffix && { suffix: formData.suffix }),
    ...(formData.artistName && { artistName: formData.artistName }),

    // Simple contact
    ...(formData.email && { email: formData.email }),
    ...(formData.phone && { phone: formData.phone }),

    // Contact arrays
    ...(phones.length > 0 && { phones }),
    ...(emails.length > 0 && { emails }),
    ...(websites.length > 0 && { websites }),

    // Address
    ...(formData.address && { address: formData.address }),
    ...(formData.street && { street: formData.street }),
    ...(formData.city && { city: formData.city }),
    ...(formData.postalCode && { postalCode: formData.postalCode }),
    ...(formData.region && { region: formData.region }),
    ...(formData.country && { country: formData.country }),

    // Additional
    ...(formData.birthday && { birthday: formData.birthday }),
    ...(formData.gender && { gender: formData.gender }),
    ...(formData.notes && { notes: formData.notes }),

    // Files
    ...(formData.avatarUrl && { avatarUrl: formData.avatarUrl }),
    ...(formData.logoUrl && { logoUrl: formData.logoUrl }),

    // Custom fields
    ...(customFields.length > 0 && { customFields }),
  });
};
```

**4. Replace form JSX with tabbed interface:**

Use shadcn/ui Tabs component to organize fields:
- Tab 1 "Identité": type toggle (individual/company), structured name fields (prefix, firstName, middleName, lastName, suffix), artistName, avatar/logo upload
- Tab 2 "Contact": phones array (with add/remove), emails array (with add/remove), websites array (with add/remove)
- Tab 3 "Adresse": street, city, postalCode, region, country (separate from old address textarea)
- Tab 4 "Informations additionnelles": birthday (date input), gender (select), customFields array (with add/remove), notes

Each tab should have:
- Clear section headers
- Help text for complex fields
- Add/Remove buttons for arrays
- Type selectors for phone/email/website entries

Import needed: `import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";`

Avoid: Don't make form overwhelming. Use tabs to hide complexity. Keep "Identité" tab simple with most common fields visible by default.
  </action>
  <verify>
1. npm run build succeeds in packages/client
2. Form renders with 4 tabs: Identité, Contact, Adresse, Info additionnelles
3. Avatar/logo upload buttons work (test with small image)
4. Dynamic arrays (phones/emails/websites) can add/remove entries
5. All fields save correctly when form submitted
6. TypeScript types match backend mutation input
  </verify>
  <done>
- ClientCreate.tsx has tabbed interface with all vCard fields
- Avatar/logo upload integrated
- Dynamic arrays for phones/emails/websites working
- Form submits all enriched data to backend
- TypeScript compilation successful
- Navigation to created client detail page works
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced client creation form with vCard 4.0 enriched fields in tabbed interface, integrated with backend</what-built>
  <how-to-verify>
1. Navigate to https://recording-studio-manager.com/clients/new
2. Test creation flow with enriched data:
   - Tab "Identité": Enter structured name (M. Jean Paul Dupont Jr.), upload avatar
   - Tab "Contact": Add multiple phones (mobile +33612345678, work +33145678901), multiple emails (jean@personal.com, jean@work.fr), website https://jeandupont.fr
   - Tab "Adresse": Enter street "123 rue de la Paix", city "Paris", postalCode "75001", region "Île-de-France", country "France"
   - Tab "Info additionnelles": Set birthday 1990-05-15, gender "M", add custom field "Instagram: @jeandupont", notes "Client VIP"
3. Click "Créer le client"
4. Verify navigation to client detail page
5. Click on "Informations enrichies" tab
6. Confirm ALL enriched data displays correctly:
   - Avatar visible
   - Structured name shows "M. Jean Paul Dupont Jr."
   - Both phones visible in list
   - Both emails visible in list
   - Website clickable link
   - Full address structured
   - Birthday formatted correctly
   - Custom field "Instagram" displays
7. Test edge cases:
   - Create client with minimal data (only name) → should work
   - Create company-type client with logo upload → should work
   - Create client with 5+ phones/emails → should work
8. Check database directly:
   ```sql
   SELECT id, name, "firstName", "lastName", phones, emails, websites, birthday, "customFields", "avatarUrl"
   FROM clients
   ORDER BY id DESC LIMIT 1;
   ```
   Verify JSON arrays stored correctly
  </how-to-verify>
  <resume-signal>Type "approved" if enriched client creation works correctly and all data displays in ClientDetail "Informations enrichies" tab, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring complete:
- [ ] Backend accepts all vCard 4.0 fields in clients.create mutation
- [ ] ClientCreate.tsx form has tabbed interface with all enriched fields
- [ ] Avatar/logo upload works at creation time
- [ ] Dynamic phone/email/website arrays functional
- [ ] All enriched data saves to database correctly
- [ ] Created client displays enriched data in "Informations enrichies" tab
- [ ] Edge cases work (minimal data, company type, many contacts)
- [ ] TypeScript compilation succeeds (no errors)
- [ ] User confirms enriched creation flow working in production
</verification>

<success_criteria>
- All vCard 4.0 fields available in client creation form
- Form organized in 4 logical tabs (Identité, Contact, Adresse, Info)
- File upload for avatar/logo integrated at creation
- Dynamic arrays for phones/emails/websites/customFields
- All enriched data persists to database correctly
- Enriched data displays in ClientDetail "Informations enrichies" tab
- Backward compatibility maintained (simple creation still works)
- User approves enriched creation flow in production
</success_criteria>

<output>
After completion, create `.planning/phases/3.9.4-modes-affichage-multiples-clients/3.9.4-02-SUMMARY.md`:

# Phase 3.9.4-02: Enriched Client Data Entry at Creation

**Enriched client creation form with vCard 4.0 fields enabled at creation time**

## Accomplishments

- Enhanced clients.create backend mutation to accept 16+ vCard enriched fields
- Transformed ClientCreate.tsx into tabbed interface (Identité/Contact/Adresse/Info)
- Integrated avatar/logo file upload at creation time
- Implemented dynamic arrays for phones/emails/websites/customFields
- All enriched data now available at client creation, not just after creation
- Enriched data displays correctly in ClientDetail "Informations enrichies" tab

## Files Created/Modified

- `packages/server/src/routers/clients.ts` - Extended create mutation input schema and mapping for all vCard fields
- `packages/client/src/pages/ClientCreate.tsx` - Replaced basic form with tabbed enriched form (4 tabs, avatar/logo upload, dynamic arrays)

## Decisions Made

- Tabbed interface chosen over single long form to reduce cognitive load
- Avatar/logo upload integrated at creation (not just edit) for complete onboarding
- Maintained backward compatibility: minimal creation (just name) still works
- Reused upload endpoints from Phase 3.9.4-01 (tenant-isolated storage)

## Issues Encountered

None - Implementation smooth, existing upload infrastructure reused successfully

## Next Step

Phase 3.9.4 complete (both plans finished). Ready for next roadmap phase or user-requested features.
</output>
