# Database Migration Deployment Scripts

Automated scripts for deploying Drizzle migrations to Database-per-Tenant architecture.

## üìã Overview

This directory contains shell scripts for deploying and managing database migrations across:
- **Master Database** (rsm_master): Platform-level tables (users, organizations, tenants)
- **Tenant Databases** (tenant_1, tenant_2, tenant_3): Business logic tables per organization

## üöÄ Scripts

### 1. migrate-status.sh

Check migration status across all databases.

**Usage:**
```bash
./migrate-status.sh [base_url]
```

**Examples:**
```bash
# Default (localhost)
./migrate-status.sh

# Custom host
./migrate-status.sh postgresql://postgres:password@prod-db.example.com:5432
```

**Output:**
- Connection status for each database
- Table counts (master: 6, tenant: 15)
- Foreign key counts (master: 6, tenant: 21)
- Migration status (applied, partial, or empty)

---

### 2. deploy-master.sh

Deploy migrations to the master database.

**Usage:**
```bash
./deploy-master.sh [database_url]
```

**Examples:**
```bash
# Default (localhost rsm_master)
./deploy-master.sh

# Custom URL
./deploy-master.sh postgresql://postgres:password@localhost:5432/rsm_master

# Using environment variable
DATABASE_URL="postgresql://..." ./deploy-master.sh
```

**Features:**
- Pre-flight connection test
- Table count before/after
- Interactive confirmation prompt
- Detailed success/failure reporting
- Color-coded output

**Expected Result:**
- 6 tables created
- 6 foreign key constraints applied

---

### 3. deploy-tenants.sh

Deploy migrations to multiple tenant databases.

**Usage:**
```bash
./deploy-tenants.sh [base_url] [tenant_list]
```

**Examples:**
```bash
# Default (all 3 tenants)
./deploy-tenants.sh

# Custom base URL
./deploy-tenants.sh postgresql://postgres:password@localhost:5432

# Specific tenants only
./deploy-tenants.sh postgresql://postgres:password@localhost:5432 "tenant_1 tenant_2"

# Production deployment
./deploy-tenants.sh postgresql://user:pass@prod.db:5432 "tenant_prod_1 tenant_prod_2"
```

**Features:**
- Batch processing of multiple tenants
- Individual tenant progress tracking
- Failure isolation (one failure doesn't stop others)
- Overall summary statistics
- Failed tenant list

**Expected Result per Tenant:**
- 15 tables created
- 21 foreign key constraints applied

---

## üîß Prerequisites

### Local Development

1. **PostgreSQL 17** installed and running:
```bash
# Homebrew (macOS)
brew services start postgresql@17

# Or check status
pg_isready -h localhost -p 5432
```

2. **Database credentials** configured:
- Default: `postgresql://postgres:password@localhost:5432`
- Override via environment: `DATABASE_URL`

3. **Databases exist**:
```bash
# Create if needed
psql postgresql://postgres:password@localhost:5432/postgres -c "CREATE DATABASE rsm_master;"
psql postgresql://postgres:password@localhost:5432/postgres -c "CREATE DATABASE tenant_1;"
psql postgresql://postgres:password@localhost:5432/postgres -c "CREATE DATABASE tenant_2;"
psql postgresql://postgres:password@localhost:5432/postgres -c "CREATE DATABASE tenant_3;"
```

### Production

1. **psql** must be in PATH or update scripts with full path
2. **Network access** to database server
3. **Appropriate credentials** with CREATE TABLE, ALTER TABLE permissions
4. **Backup** existing databases before deployment

---

## üìÇ Migration Files

Scripts apply migrations from:
- **Master**: `../drizzle/migrations/master/0000_*.sql`
- **Tenant**: `../drizzle/migrations/tenant/0000_*.sql`

Generated by:
```bash
pnpm drizzle-kit generate --config=drizzle.config.master.ts
pnpm drizzle-kit generate --config=drizzle.config.tenant.ts
```

---

## üîÑ Deployment Workflow

### Initial Deployment (Fresh Databases)

```bash
# 1. Check current status
./migrate-status.sh

# 2. Deploy master database
./deploy-master.sh

# 3. Deploy to all tenants
./deploy-tenants.sh

# 4. Verify deployment
./migrate-status.sh
```

### Production Deployment

```bash
# 1. Backup databases
pg_dump rsm_master > backup_master_$(date +%Y%m%d).sql
pg_dump tenant_1 > backup_tenant_1_$(date +%Y%m%d).sql

# 2. Run on staging first
./deploy-master.sh postgresql://user:pass@staging:5432/rsm_master
./deploy-tenants.sh postgresql://user:pass@staging:5432 "tenant_staging"

# 3. Verify staging
./migrate-status.sh postgresql://user:pass@staging:5432

# 4. Deploy to production (with confirmation)
./deploy-master.sh postgresql://user:pass@prod:5432/rsm_master
./deploy-tenants.sh postgresql://user:pass@prod:5432 "tenant_prod_1 tenant_prod_2 tenant_prod_3"

# 5. Verify production
./migrate-status.sh postgresql://user:pass@prod:5432
```

### Adding New Tenant

```bash
# 1. Create tenant database
psql postgresql://postgres:password@localhost:5432/postgres -c "CREATE DATABASE tenant_4;"

# 2. Deploy migrations to new tenant only
./deploy-tenants.sh postgresql://postgres:password@localhost:5432 "tenant_4"

# 3. Verify
./migrate-status.sh | grep tenant_4
```

---

## üìä Expected Schema

### Master Database (6 tables)

```
users (8 columns)
organizations (17 columns)
tenant_databases (4 columns)
organization_members (5 columns)
invitations (9 columns)
subscription_plans (12 columns)

Foreign Keys: 6
- invitations ‚Üí organizations, users
- organization_members ‚Üí users, organizations
- organizations ‚Üí users
- tenant_databases ‚Üí organizations
```

### Tenant Database (15 tables)

```
Core Business:
- clients (16 columns)
- rooms (19 columns)
- sessions (12 columns)
- equipment (23 columns)
- projects (26 columns)
- tracks (16 columns)

Financial:
- invoices (14 columns)
- invoice_items (7 columns)
- quotes (19 columns)
- quote_items (9 columns)
- contracts (20 columns)
- expenses (19 columns)
- payments (17 columns)

Musicians:
- musicians (14 columns)
- track_credits (8 columns)

Foreign Keys: 21 (relationships between all entities)
```

---

## ‚ö†Ô∏è Troubleshooting

### Connection Failed

**Error:** `Connection failed`

**Solutions:**
1. Check PostgreSQL is running: `pg_isready`
2. Verify credentials in connection string
3. Ensure database exists: `psql -l | grep rsm_master`
4. Check network access (firewall, security groups)

### Migration Already Applied

**Error:** `relation "users" already exists`

**Solutions:**
1. Check status: `./migrate-status.sh`
2. If tables exist with correct schema, deployment is complete
3. If partial deployment, manually inspect and fix
4. For fresh start, drop and recreate database

### psql Not Found

**Error:** `command not found: psql`

**Solutions:**
1. Add PostgreSQL to PATH:
```bash
export PATH="/opt/homebrew/opt/postgresql@17/bin:$PATH"
```

2. Or update scripts to use full path:
```bash
# Replace 'psql' with
/opt/homebrew/opt/postgresql@17/bin/psql
```

### Permission Denied

**Error:** `permission denied to create table`

**Solutions:**
1. Ensure user has CREATE privilege:
```sql
GRANT CREATE ON DATABASE rsm_master TO postgres;
```

2. Or use superuser credentials

---

## üîí Security Notes

1. **Never commit credentials** to version control
2. **Use environment variables** for production credentials
3. **Rotate passwords** regularly
4. **Use SSL connections** in production
5. **Backup before deployment**
6. **Test on staging first**

---

## üìö Related Documentation

- [Database Architecture](../../docs/architecture/multi-tenant.md)
- [Drizzle Migrations Guide](../../docs/migrations.md)
- [Production Deployment Checklist](../../docs/deployment.md)

---

## ü§ù Contributing

When adding new migrations:

1. Generate migrations:
```bash
pnpm drizzle-kit generate --config=drizzle.config.master.ts
pnpm drizzle-kit generate --config=drizzle.config.tenant.ts
```

2. Test on local:
```bash
./deploy-master.sh
./deploy-tenants.sh
```

3. Verify:
```bash
./migrate-status.sh
```

4. Commit migration files:
```bash
git add packages/database/drizzle/migrations/
git commit -m "feat(database): add new migration"
```

---

**Last Updated:** 2025-12-15
**Version:** 1.0.0
**Migration Files:** 0000_massive_zodiak (master), 0000_early_charles_xavier (tenant)
